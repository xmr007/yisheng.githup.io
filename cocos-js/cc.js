System.register([],(function(e,t){"use strict";return{execute:function(){e({BitMask:at,CCClass:nn,CacheMode:void 0,DebugMode:void 0,Enum:ct,Eventify:ou,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,NodeEventType:void 0,NodeSpace:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,TransformBit:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:qb,WorldNode3DToWorldNodeUI:Yb,absMax:In,absMaxComponent:wn,approx:hn,assert:C,assertID:F,bezier:Df,bezierByTime:Qf,ccenum:ht,clamp:_n,clamp01:fn,color:Dn,computeRatioByType:T4,createDefaultPipeline:XD,debug:A,deserialize:zh,earcut:JW,enumerableProps:Pn,equals:un,error:T,errorID:M,find:HR,fragmentText:PF,getBaselineOffset:function(){return 0},getEnglishWordPartAtFirst:wF,getEnglishWordPartAtLast:IF,getError:z,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[Lc]},getWorldTransformUntilRoot:lJ,instantiate:t_,inverseLerp:bn,isDisplayStats:U,isEnglishWordPartAtFirst:function(e){return EF.test(e)},isEnglishWordPartAtLast:function(e){return xF.test(e)},isUnicodeCJK:TF,isUnicodeSpace:CF,isValid:xl,lerp:dn,log:x,logID:R,markAsWarning:void 0,mat4:Zn,murmurhash2_32_gc:bo,nextPow2:Tn,pingPong:An,pseudoRandom:Sn,pseudoRandomRange:xn,pseudoRandomRangeInt:En,quat:Xn,randomRange:gn,randomRangeInt:yn,rect:ci,removeProperty:void 0,repeat:Cn,replaceProperty:void 0,safeMeasureText:AF,sampleAnimationCurve:E4,setDefaultLogTimes:function(e){e>0&&(Y=e)},setDisplayStats:G,size:ai,toDegree:mn,toRadian:pn,tween:Qve,tweenUtil:Zve,v2:ti,v3:Bn,v4:ii,warn:E,warnID:D});var n=2147483647;function i(e){return(e>0)-(e<0)}function r(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function o(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}function a(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function s(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}var c=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(c);var l=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:n,INT_MIN:-2147483648,sign:i,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:r,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:o,countTrailingZeros:a,nextPow2:s,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return c[255&e]<<24|c[e>>>8&255]<<16|c[e>>>16&255]<<8|c[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>a(e)+1}});e("bits",l);var u="undefined"==typeof window?global:window,h=e("cclegacy",{_global:u});h.internal={},u.CC_BUILD=!0,u.CC_TEST=!1,u.CC_EDITOR=false,u.CC_PREVIEW=!1,u.CC_DEV=!1,u.CC_DEBUG=!1,u.CC_JSB=!1,u.CC_BYTEDANCE=!1,u.CC_WECHAT=!1,u.CC_ALIPAY=!1,u.CC_XIAOMI=!1,u.CC_BAIDU=!1,u.CC_COCOSPLAY=!1,u.CC_HUAWEI=!1,u.CC_OPPO=!1,u.CC_VIVO=!1,u.CC_MINIGAME=!1,u.CC_RUNTIME_BASED=!1,u.CC_SUPPORT_JIT=!0;var _=e("VERSION","3.5.2");u.CocosEngine=h.ENGINE_VERSION=_,u.cc=h;var f="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",d=null,p=console.log.bind(console),m=p,v=p,g=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+S.apply(void 0,[t].concat(i)))}},y=p;function S(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return h.js.formatStr.apply(null,[e].concat(n))}function x(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return p.apply(void 0,[e].concat(n))}function E(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return m.apply(void 0,[e].concat(n))}function T(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return v.apply(void 0,[e].concat(n))}function C(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return g.apply(void 0,[e,t].concat(i))}function A(){return y.apply(void 0,arguments)}function b(e){if(p=m=v=g=y=function(){},e!==L.NONE){if(e>L.ERROR){var t=function(e){if(h.game.canvas){if(!d){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",h.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(d=document.createElement("textarea")).setAttribute("rows","20"),d.setAttribute("cols","30"),d.setAttribute("disabled","true");var i=d.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(d),h.game.canvas.parentNode.appendChild(t)}d.value=d.value+e+"\r\n",d.scrollTop=d.scrollHeight}};v=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+S.apply(void 0,[e].concat(i)))},g=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t("ASSERT: "+S.apply(void 0,[n].concat(r)))}},e!==L.ERROR_FOR_WEB_PAGE&&(m=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+S.apply(void 0,[e].concat(i)))}),e===L.INFO_FOR_WEB_PAGE&&(p=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(S.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),v=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},g=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=S.apply(void 0,[t].concat(i));throw new Error(o)}});if(e!==L.ERROR&&(m=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=L.INFO&&(p=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=L.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);y=function(){return n.apply(void 0,arguments)}}}}function w(e){T(e.stack||e)}function I(e){return function(t){for(var n=e+" "+t+", please go to "+f+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var P=I("Log");function R(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];x(P.apply(void 0,[e].concat(n)))}var O=I("Warning");function D(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];E(O.apply(void 0,[e].concat(n)))}var N=I("Error");function M(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];T(N.apply(void 0,[e].concat(n)))}var L,B=I("Assert");function F(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];C(!1,B.apply(void 0,[t].concat(i)))}}function z(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return N.apply(void 0,[e].concat(n))}function U(){return!!h.profiler&&h.profiler.isShowingStats()}function G(e){h.profiler&&(e?h.profiler.showStats():h.profiler.hideStats(),h.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(L||(L=e("DebugMode",{})));var k,H,V,W,j,X,q=Object.freeze({__proto__:null,log:x,warn:E,error:T,assert:C,debug:A,_resetDebugSetting:b,_throw:w,logID:R,warnID:D,errorID:M,assertID:F,get DebugMode(){return L},getError:z,isDisplayStats:U,setDisplayStats:G}),Y=10,K=0,Q=new Map;function Z(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function J(e,t,n){return t&&Z(e.prototype,t),n&&Z(e,n),e}function $(){return($=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function ee(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ne(e,t)}function te(e){return(te=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ne(e,t){return(ne=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ie(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function re(e,t,n){return(re=ie()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&ne(r,n.prototype),r}).apply(null,arguments)}function oe(e){var t="function"==typeof Map?new Map:void 0;return(oe=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return re(e,arguments,te(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),ne(i,e)})(e)}function ae(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function se(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function ce(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return se(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?se(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function le(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function ue(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}W=function(e,t,n,i,r,o,a){var s=Q.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},k=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=K++;Q.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Y});var r=null!=n.target?n.target:e,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return W(t,n.name,a,o,E,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return W(t,n.name,a,o,E,i,c),n.customGetter.call(this)},set:function(e){W(t,n.name,a,o,E,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){W(t,n.name,a,o,E,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return W(t,n.name,a,o,E,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return W(t,n.name,a,o,E,i,c),s?this[o]:r[o]},set:function(e){W(t,n.name,a,o,E,i,c),s?this[o]=e:r[o]=e},enumerable:!1})}))})),X=function(e,t,n,i,r){var o=Q.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,e+"."+t),o.count++)},H=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=K++;Q.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Y});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return X(t,n.name,T,i,r)},set:function(){X(t,n.name,T,i,r)},enumerable:!1})}))})),j=function(e,t,n,i,r){var o=Q.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,e+"."+t),o.count++)},V=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var o=K++;Q.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Y});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return j(t,i,E,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return j(t,i,E,o,a),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){j(t,i,E,o,a),c=e}})}else!function(t,n,i,r,o,a){if(t.get){var s=t.get;t.get=function(){return j(n,i,r,o,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){j(n,i,r,o,a),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,E,o,a);Object.defineProperty(e,i,{enumerable:!1})}}))}));var he=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},J(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function _e(e,t){e.splice(t,1)}function fe(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function de(e,t){var n=e.indexOf(t);return n>=0&&(_e(e,n),!0)}function pe(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return _e(e,n),i}}function me(e,t){return e.indexOf(t)>=0}var ve=Object.freeze({__proto__:null,removeAt:_e,fastRemoveAt:fe,remove:de,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:pe,verifyType:function(e,t){if(e&&e.length>0)for(var n,i=ce(e);!(n=i()).done;)if(!(n.value instanceof t))return R(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)de(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:me,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:he}),ge=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();ge.global=new ge("global");var ye=new ge("TmpCId."),Se="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),xe="__cid__";function Ee(e){return"number"==typeof e||e instanceof Number}function Te(e){return"string"==typeof e||e instanceof String}function Ce(e){for(var t in e)return!1;return!0}var Ae,be=(Ae={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){Ae.value=n,Ae.writable=i,Ae.enumerable=r,Object.defineProperty(e,t,Ae),Ae.value=void 0}),we=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),e.get=i,e.set=r,e.enumerable=o,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),Ie=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.get=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0}}(),Pe=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.set=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.set=void 0}}();function Re(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function Oe(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?/\[\w+\s*(\w+)\]/.exec(r):/function\s*(\w+)/.exec(r))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?Oe(e.constructor):""}function De(e,t,n,i){var r=/([^.]+)$/,o=r.exec(t)[0],a=r.exec(n)[0];function s(){return this[a]}i?we(e,o,s,(function(e){this[a]=e})):Ie(e,o,s)}function Ne(e,t,n,i){for(var r in n)De(e,t+"."+r,n[r],i)}var Me=/(%d)|(%s)/,Le=/%s/;function Be(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&Me.test(e);if(r)for(var o,a=ce(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?Me:Le;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=ce(n);!(u=h()).done;){var _=u.value;e+=" "+_}return e}function Fe(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function ze(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Ue(e,t,n){var i=ze(t,e);i&&Object.defineProperty(n,e,i)}function Ge(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){M(5402,a);continue}for(var s in a)s in e||Ue(s,a,e)}}return e}function ke(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){M(5403,a);continue}for(var s in a)Ue(s,a,e)}}return e}function He(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ve(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function We(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ve(e)))return!1;if(e===t)return!0}}return!1}function je(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Xe=Re(!0),qe=Re(!0);function Ye(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],be(i.prototype,e,n),n){var r=t[n];r&&r!==i?T("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var Ke=Ye("__cid__",Xe),Qe=Ye("__classname__",qe);function Ze(e,t){if(Qe(e,t),!t.prototype.hasOwnProperty(xe)){var n=e||ye.getNewId();n&&Ke(n,t)}}function Je(e,t){var n=qe[t],i=Xe[t],r=!0;if(n&&n!==e&&(T('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(T('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var o=e[Se];o||(o=[],e[Se]=o),o.push(t),qe[t]=e,Xe[t]=e}}function $e(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Xe[s];var c=a.__classname__;c&&delete qe[c];var l=a[Se];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete qe[h],delete Xe[h]}}}function et(e){return Xe[e]}function tt(e){return qe[e]}function nt(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(xe))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(xe))return e.__cid__}return""}var it=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),rt=ve,ot={IDGenerator:ge,Pool:it,array:ve,isNumber:Ee,isString:Te,isEmptyObject:Ce,getPropertyDescriptor:ze,addon:Ge,mixin:ke,extend:He,getSuper:Ve,isChildClassOf:We,clear:je,value:be,getset:we,get:Ie,set:Pe,unregisterClass:$e,getClassName:Oe,setClassName:Ze,setClassAlias:Je,getClassByName:tt,get _registeredClassNames(){return $({},qe)},set _registeredClassNames(e){je(qe),Object.assign(qe,e)},get _registeredClassIds(){return $({},Xe)},set _registeredClassIds(e){je(Xe),Object.assign(Xe,e)},_getClassId:nt,_setClassId:Ke,_getClassById:et,obsolete:De,obsoletes:Ne,formatStr:Be,shiftArguments:Fe,createMap:Re};function at(e){if("__bitmask__"in e)return e;be(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&be(e,a,r)}return e}function st(e,t){t>=0&&e.length,e.length}function ct(e){return"__enums__"in e?e:(be(e,"__enums__",null,!0),ct.update(e))}function lt(e){e.hasOwnProperty("__enums__")}function ut(e){lt(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function ht(e){"__enums__"in e||be(e,"__enums__",null,!0)}h.js=ot,e("js",Object.freeze({__proto__:null,array:rt,js:ot,IDGenerator:ge,Pool:it,isNumber:Ee,isString:Te,isEmptyObject:Ce,value:be,getset:we,get:Ie,set:Pe,createMap:Re,getClassName:Oe,obsolete:De,obsoletes:Ne,formatStr:Be,shiftArguments:Fe,getPropertyDescriptor:ze,addon:Ge,mixin:ke,extend:He,getSuper:Ve,isChildClassOf:We,clear:je,_idToClass:Xe,_nameToClass:qe,_setClassId:Ke,setClassName:Ze,setClassAlias:Je,unregisterClass:$e,_getClassById:et,getClassByName:tt,_getClassId:nt})),at.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},at.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},h.BitMask=at,ct.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&be(e,a,r)}return Array.isArray(e.__enums__)&&ut(e),e},ct||(ct=e("Enum",{})),ct.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},ct.getList=function(e){return lt(e),e.__enums__?e.__enums__:ut(e)},h.Enum=ct;var _t=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return M(100,Oe(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){M(100,Oe(this)+".set")},t.toString=function(){return""},e}());Ze("cc.ValueType",_t),h.ValueType=_t;var ft=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});h.macro=ft;for(var dt=/^(?:cc|dragonBones|sp|ccsg)\..+/,pt=new Array(123),mt=0;mt<123;++mt)pt[mt]=64;for(var vt=0;vt<64;++vt)pt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(vt)]=vt;var gt=pt;function yt(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var o=e[n];we(e,t,o,e[i])}}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function St(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function xt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function Et(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function Tt(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function Ct(e){return!(!e||e.constructor!==Object)&&Ce(e)}function At(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function bt(e){return e*ft.RAD}function wt(e){return e*ft.DEG}h.misc={BUILTIN_CLASSID_RE:dt,BASE64_VALUES:gt,propertyDefine:yt,pushToMap:St,contains:xt,isDomNode:Et,callInNextTick:Tt,isPlainEmptyObj_DEV:Ct,clampf:At,degreesToRadians:bt,radiansToDegrees:wt},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:dt,BASE64_VALUES:gt,propertyDefine:yt,pushToMap:St,contains:xt,isDomNode:Et,callInNextTick:Tt,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:Ct,clampf:At,degreesToRadians:bt,radiansToDegrees:wt}));var It="$_$";function Pt(e,t){var n=t?Object.create(t):{};return be(e,"__attrs__",n),n}function Rt(e){if("function"!=typeof e)return Pt(e,Dt(e.constructor));for(var t,n=h.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||Pt(r,(t=n[i+1])&&t.__attrs__)}return Pt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function Ot(e,t){var n=Dt(e),i=t+It,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function Dt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||Rt(e)}function Nt(e,t,n,i){Dt(e)[t+It+n]=i}var Mt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),Lt=e("CCInteger",new Mt("Integer",0));h.Integer=Lt,h.CCInteger=Lt;var Bt=e("CCFloat",new Mt("Float",0));h.Float=Bt,h.CCFloat=Bt;var Ft=e("CCBoolean",new Mt("Boolean",!1));h.Boolean=Ft,h.CCBoolean=Ft;var zt=e("CCString",new Mt("String",""));function Ut(e,t){return function(n,i){var r='"'+Oe(n)+"."+i+'"',o=Ot(n,i),a=o.type;if(a===Lt||a===Bt?a="Number":a!==zt&&a!==Ft||(a=""+a),a===e){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!Ct(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;D(3605,r,Oe(o.ctor))}else"Number"!==e&&D(3606,t,r,e);else{if("function"===c)return;e===zt.default&&null==s?D(3607,r):D(3611,t,r,c)}delete o.type}}}else D(3604,r)}}h.String=zt,h.CCString=zt;var Gt=Object.freeze({__proto__:null,DELIMETER:It,createAttrsSingle:Pt,createAttrs:Rt,attr:Ot,getClassAttrs:Dt,setClassAttr:Nt,PrimitiveType:Mt,CCInteger:Lt,CCFloat:Bt,CCBoolean:Ft,CCString:zt,getTypeChecker_ET:Ut,getObjTypeChecker_ET:function(e){return function(t,n){Ut("Object","type")(t,n);var i=Dt(t)[n+It+"default"],r=h.Class.getDefault(i);if(!Array.isArray(r)&&We(e,h.ValueType)){var o=Oe(e),a=Be('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Oe(t),n,o);i?x(a):D(3612,a,o,Oe(t),n,o)}}}}),kt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Ht(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var o={};for(var a in i[r]=o,kt){var s=kt[a];e.hasOwnProperty(a)&&(o[a]=e[a],s.canUsedInGet||delete e[a])}}}function Vt(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return M(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=h.String:t===Boolean?e.type=h.Boolean:t===Number&&(e.type=h.Float))}function Wt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function jt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Wt(t,[],e);if("function"==typeof e){var n=e;return Wt(t,We(n,h.ValueType)?new n:null,n)}return Wt(t,e instanceof Mt?e.default:e)}return null}var Xt,qt=[];function Yt(){return qt[qt.length-1]}h._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),qt.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=qt.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Yt},function(e){e[e.STANDALONE=1]="STANDALONE",e[e.IMPLICIT_VISIBLE=2]="IMPLICIT_VISIBLE",e[e.IMPLICIT_SERIALIZABLE=4]="IMPLICIT_SERIALIZABLE"}(Xt||(Xt={}));var Kt=It,Qt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=Oe(i);r?tn(i,o,r,i.$super,n.mixins):M(3633,o)}this.datas=null}}};function Zt(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),an(e,i,t,n)}function Jt(e,t,n,i){var r=i.get;i.set,r&&(an(e,i,t,n),Nt(e,n,"serializable",!1))}function $t(e){return"function"==typeof e?e():e}function en(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,ze(t,i))}function tn(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=jt(i,!1);if(r&&(i=e[n]=r),i){var o=i.notify;o&&Ht(i,n,o,e),"type"in i&&Vt(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?Jt(e,t,s,c):Zt(e,t,s,c)}var l=Dt(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Kt+"serializable"]}))}function nn(e){var t=e.name,n=e.extends,i=e.mixins,r=function(e,t,n,i){var r=h.Component,o=Yt();if(o&&We(t,r)){if(We(o.cls,r))return M(3615),null;e=e||o.script}var a=function(e,t,n,i){var r=i.ctor,o=[r],a=r;be(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];en(s,l.prototype),nn._isCCClass(l)&&en(Dt(a),Dt(l))}s.constructor=a}return Ze(e,a),a}(e,t,n,i);if(o)if(We(t,r)){var s=o.uuid;s&&Ke(s,a),o.cls=a}else We(o.cls,r)||(o.cls=a);return a}(t,n,i,e);t||(t=h.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var o=e.properties;"function"==typeof o||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(Qt.push({cls:r,props:o,mixins:i}),r.__props__=r.__values__=null):tn(r,t,o,n,e.mixins);var a=e.editor;return a&&We(n,h.Component)&&h.Component._registerEditorProps(r,a),r}function rn(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__values__")}nn._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},nn.fastDefine=function(e,t,n){Ze(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=Dt(t),o=0;o<i.length;o++){var a=i[o];r[a+Kt+"visible"]=!1,r[a+Kt+"default"]=n[a]}},nn.Attr=Gt,nn.attr=Ot,nn.getInheritanceChain=function(e){for(var t=[];e=Ve(e);)e!==Object&&t.push(e);return t};var on={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function an(e,t,n,i){var r=null,o="";function a(){return o=i+Kt,r=Dt(e)}"type"in t&&void 0===t.type&&D(3660,i,n);var s=t.type;s&&(on[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?ct.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=ct.getList(s)):at.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=at.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in t&&((r||a())[o+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||a())[o+e]=i)}};t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.__internalFlags&Xt.STANDALONE?c=!0===t.serializable||0!=(t.__internalFlags&Xt.IMPLICIT_SERIALIZABLE):!1===t.serializable&&(c=!1),void 0!==c&&((r||a())[o+"serializable"]=c),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}nn.isArray=function(e){return e=$t(e),Array.isArray(e)},nn.getDefault=$t,nn.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},nn.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,nn.getNewValueTypeCode=function(e){for(var t=Oe(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},h.Class=nn;var sn=Math.PI/180,cn=180/Math.PI,ln=e("EPSILON",1e-6);function un(e,t){return Math.abs(e-t)<=ln*Math.max(1,Math.abs(e),Math.abs(t))}function hn(e,t,n){return n=n||ln,Math.abs(e-t)<=n}function _n(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function fn(e){return e<0?0:e>1?1:e}function dn(e,t,n){return e+(t-e)*n}function pn(e){return e*sn}function mn(e){return e*cn}var vn=e("random",Math.random);function gn(e,t){return Math.random()*(t-e)+e}function yn(e,t){return Math.floor(gn(e,t))}function Sn(e){return(e=(9301*e+49297)%233280)/233280}function xn(e,t,n){return Sn(e)*(n-t)+t}function En(e,t,n){return Math.floor(xn(e,t,n))}function Tn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Cn(e,t){return e-Math.floor(e/t)*t}function An(e,t){return e=Cn(e,2*t),t-Math.abs(e-t)}function bn(e,t,n){return(n-e)/(t-e)}function wn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function In(e,t){return Math.abs(e)>Math.abs(t)?e:t}function Pn(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var Rn=1/255,On=e("Color",function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this)._val=0,"string"==typeof t?o.fromHEX(t):void 0!==n?o.set(t,n,i,r):o.set(t),o}ee(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var n=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(n)?255:n,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,o=t.g,a=t.b,s=t.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=ln),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*Rn).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,o=0;if(0===t)i=r=o=n;else if(0===n)i=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*Rn,t=this.g*Rn,n=this.b*Rn,i={h:0,s:0,v:0},r=Math.max(e,t,n),o=Math.min(e,t,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=e===r?(t-n)/a:t===r?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},J(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~_n(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~_n(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~_n(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~_n(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*Rn},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*Rn},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*Rn},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*Rn},set:function(e){this.a=255*e}}]),t}(_t));function Dn(e,t,n,i){return new On(e,t,n,i)}On.WHITE=Object.freeze(new On(255,255,255,255)),On.GRAY=Object.freeze(new On(127,127,127,255)),On.BLACK=Object.freeze(new On(0,0,0,255)),On.TRANSPARENT=Object.freeze(new On(0,0,0,0)),On.RED=Object.freeze(new On(255,0,0,255)),On.GREEN=Object.freeze(new On(0,255,0,255)),On.BLUE=Object.freeze(new On(0,0,255,255)),On.CYAN=Object.freeze(new On(0,255,255,255)),On.MAGENTA=Object.freeze(new On(255,0,255,255)),On.YELLOW=Object.freeze(new On(255,255,0,255)),nn.fastDefine("cc.Color",On,{r:0,g:0,b:0,a:255}),h.Color=On,h.color=Dn;var Nn=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}ee(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<ln?e.x=0:e.x=1/n,Math.abs(i)<ln?e.y=0:e.y=1/i,Math.abs(r)<ln?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z;return e.x=r*c-o*s,e.y=o*a-i*c,e.z=i*s-r*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*vn()*Math.PI,i=2*vn()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,e.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,e.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o)*a,e.y=(n.m01*i+n.m05*r+n.m09*o)*a,e.z=(n.m02*i+n.m06*r+n.m10*o)*a,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=i*n.m00+r*n.m03+o*n.m06,e.y=i*n.m01+r*n.m04+o*n.m07,e.z=i*n.m02+r*n.m05+o*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,o=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,e.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,e.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var o=t.x*r.x,a=t.y*r.y,s=t.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var o=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=ln);var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},t.angle=function(e,n){t.normalize(Mn,e),t.normalize(Ln,n);var i=t.dot(Mn,Ln);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=ln),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=ln),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=_n(this.x,e.x,t.x),this.y=_n(this.y,e.y,t.y),this.z=_n(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(_t));Nn.UNIT_X=Object.freeze(new Nn(1,0,0)),Nn.UNIT_Y=Object.freeze(new Nn(0,1,0)),Nn.UNIT_Z=Object.freeze(new Nn(0,0,1)),Nn.RIGHT=Object.freeze(new Nn(1,0,0)),Nn.UP=Object.freeze(new Nn(0,1,0)),Nn.FORWARD=Object.freeze(new Nn(0,0,-1)),Nn.ZERO=Object.freeze(new Nn(0,0,0)),Nn.ONE=Object.freeze(new Nn(1,1,1)),Nn.NEG_ONE=Object.freeze(new Nn(-1,-1,-1));var Mn=new Nn,Ln=new Nn;function Bn(e,t,n){return new Nn(e,t,n)}nn.fastDefine("cc.Vec3",Nn,{x:0,y:0,z:0}),h.Vec3=Nn,h.v3=Bn;var Fn=e("Mat3",function(e){function t(t,n,i,r,o,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}ee(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,o,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,d=n*h+i*_+r*f;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=h*d,e.m01=(-u*i+r*l)*d,e.m02=(s*i-r*a)*d,e.m03=_*d,e.m04=(u*n-r*c)*d,e.m05=(-s*n+r*o)*d,e.m06=f*d,e.m07=(-l*n+i*c)*d,e.m08=(a*n-i*o)*d,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,S=n.m08;return e.m00=_*i+f*a+d*l,e.m01=_*r+f*s+d*u,e.m02=_*o+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*r+m*s+v*u,e.m05=p*o+m*c+v*h,e.m06=g*i+y*a+S*l,e.m07=g*r+y*s+S*u,e.m08=g*o+y*c+S*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,S=n.m10;return e.m00=_*i+f*a+d*l,e.m01=_*r+f*s+d*u,e.m02=_*o+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*r+m*s+v*u,e.m05=p*o+m*c+v*h,e.m06=g*i+y*a+S*l,e.m07=g*r+y*s+S*u,e.m08=g*o+y*c+S*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=_*i+f*a+l,e.m07=_*r+f*s+u,e.m08=_*o+f*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*a,e.m01=f*r+_*s,e.m02=f*o+_*c,e.m03=f*a-_*i,e.m04=f*s-_*r,e.m05=f*c-_*o,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return Nn.lengthSqr(n)<ln*ln?(t.identity(e),e):(i=i||Nn.UNIT_Y,Nn.normalize(zn,Nn.cross(zn,i,n)),Nn.lengthSqr(zn)<ln*ln?(t.identity(e),e):(Nn.cross(Un,n,zn),t.set(e,zn.x,zn.y,zn.z,Un.x,Un.y,Un.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return e.m00=1-h-d,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-d,e.m07=f-p,e.m02=_-m,e.m05=f+p,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,E=i*l-o*s,T=r*l-o*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+S*w+x*b-E*A+T*C;return R?(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(c*b-a*P-l*A)*R,e.m02=(a*I-s*b+l*C)*R,e.m03=(r*I-i*P-o*w)*R,e.m04=(n*P-r*b+o*A)*R,e.m05=(i*b-n*I-o*C)*R,e.m06=(p*T-m*E+v*x)*R,e.m07=(m*S-d*T-v*y)*R,e.m08=(d*E-p*S+v*g)*R,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=ln),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,o,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=ln),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(o*t-n*r)*_,this.m03=u*_,this.m04=(c*e-n*a)*_,this.m05=(-o*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*a)*_,this.m08=(r*e-t*i)*_,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*t+d*r+p*s,this.m04=f*n+d*o+p*c,this.m05=f*i+d*a+p*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*t,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+p,this.m01=l+m,this.m04=1-c-f,this.m07=_-d,this.m02=h-p,this.m05=_+d,this.m08=1-c-u,this},t}(_t));Fn.IDENTITY=Object.freeze(new Fn);var zn=new Nn,Un=new Nn;nn.fastDefine("cc.Mat3",Fn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),h.Mat3=Fn;var Gn=e("Quat",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}ee(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=Nn.dot(n,i);return r<-.999999?(Nn.cross(Vn,Nn.UNIT_X,n),Vn.length()<1e-6&&Nn.cross(Vn,Nn.UNIT_Y,n),Nn.normalize(Vn,Vn),t.fromAxisAngle(e,Vn,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Nn.cross(Vn,n,i),e.x=Vn.x,e.y=Vn.y,e.z=Vn.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,o=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=o,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+c*i,e.y=a*r+s*i,e.z=s*r-a*i,e.w=c*r-o*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r-s*i,e.y=a*r+c*i,e.z=s*r+o*i,e.w=c*r-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+a*i,e.y=a*r-o*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(kn,n),Nn.transformQuat(Vn,i,kn),t.fromAxisAngle(kn,Vn,r),t.multiply(e,n,kn),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(kn,i,r),t.multiply(e,n,kn),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return e.x=r*t.x+o*a,e.y=r*t.y+o*s,e.z=r*t.z+o*c,e.w=r*t.w+o*l,e},t.sqlerp=function(e,n,i,r,o,a){return t.slerp(kn,n,o,a),t.slerp(Hn,i,r,a),t.slerp(e,kn,Hn,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return Fn.set(Wn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,Wn))},t.fromViewUp=function(e,n,i){return Fn.fromViewUp(Wn,n,i),t.normalize(e,t.fromMat3(e,Wn))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(r-c)*_,e.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+o)/f,e.z=(r+c)/f}else if(a>u){var d=2*Math.sqrt(1+a-n-u);e.w=(r-c)/d,e.x=(i+o)/d,e.y=.25*d,e.z=(s+l)/d}else{var p=2*Math.sqrt(1+u-n-a);e.w=(o-i)/p,e.x=(r+c)/p,e.y=(s+l)/p,e.z=.25*p}return e},t.fromEuler=function(e,t,n,i){t*=jn,n*=jn,i*=jn;var r=Math.sin(t),o=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+o*a*c,e.y=o*a*l+r*s*c,e.z=o*s*c-r*a*l,e.w=o*s*l-r*a*c,e},t.fromAngleZ=function(e,t){return t*=jn,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=mn(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-mn(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=mn(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=mn(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=mn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=ln),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=ln),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(_t));Gn.IDENTITY=Object.freeze(new Gn);var kn=new Gn,Hn=new Gn,Vn=new Nn,Wn=new Fn,jn=.5*Math.PI/180;function Xn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new Gn(e,t,n,i)}nn.fastDefine("cc.Quat",Gn,{x:0,y:0,z:0,w:1}),h.Quat=Gn,h.quat=Xn;var qn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Yn=e("Mat4",function(e){function t(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=d,v.m14=p,v.m15=m),v}ee(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=d,e.m14=p,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,E=i*l-o*s,T=r*l-o*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+S*w+x*b-E*A+T*C;return 0===R?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(r*I-i*P-o*w)*R,e.m02=(p*T-m*E+v*x)*R,e.m03=(_*E-h*T-f*x)*R,e.m04=(c*b-a*P-l*A)*R,e.m05=(n*P-r*b+o*A)*R,e.m06=(m*S-d*T-v*y)*R,e.m07=(u*T-_*S+f*y)*R,e.m08=(a*I-s*b+l*C)*R,e.m09=(i*b-n*I-o*C)*R,e.m10=(d*E-p*S+v*g)*R,e.m11=(h*S-u*E-f*g)*R,e.m12=(s*A-a*w-c*C)*R,e.m13=(n*w-i*A+r*C)*R,e.m14=(p*y-d*x-m*g)*R,e.m15=(u*x-h*y+_*g)*R,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,d=e.m13,p=e.m14,m=e.m15;return(t*a-n*o)*(h*m-_*p)-(t*s-i*o)*(u*m-_*d)+(t*c-r*o)*(u*p-h*d)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*p-h*f)+(i*c-r*s)*(l*d-u*f)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,d=t.m11,p=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,S=n.m01,x=n.m02,E=n.m03;return e.m00=y*i+S*s+x*h+E*p,e.m01=y*r+S*c+x*_+E*m,e.m02=y*o+S*l+x*f+E*v,e.m03=y*a+S*u+x*d+E*g,y=n.m04,S=n.m05,x=n.m06,E=n.m07,e.m04=y*i+S*s+x*h+E*p,e.m05=y*r+S*c+x*_+E*m,e.m06=y*o+S*l+x*f+E*v,e.m07=y*a+S*u+x*d+E*g,y=n.m08,S=n.m09,x=n.m10,E=n.m11,e.m08=y*i+S*s+x*h+E*p,e.m09=y*r+S*c+x*_+E*m,e.m10=y*o+S*l+x*f+E*v,e.m11=y*a+S*u+x*d+E*g,y=n.m12,S=n.m13,x=n.m14,E=n.m15,e.m12=y*i+S*s+x*h+E*p,e.m13=y*r+S*c+x*_+E*m,e.m14=y*o+S*l+x*f+E*v,e.m15=y*a+S*u+x*d+E*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,o=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*o+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*o+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*o+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*o+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,d=t.m08,p=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=d,e.m09=p,e.m10=m,e.m11=v,e.m12=a*i+u*r+d*o+t.m12,e.m13=s*i+h*r+p*o+t.m13,e.m14=c*i+_*r+m*o+t.m14,e.m15=l*i+f*r+v*o+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,o=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<ln)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,d=t.m03,p=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,S=t.m09,x=t.m10,E=t.m11,T=r*r*u+l,C=o*r*u+a*c,A=a*r*u-o*c,b=r*o*u-a*c,w=o*o*u+l,I=a*o*u+r*c,P=r*a*u+o*c,R=o*a*u-r*c,O=a*a*u+l;return e.m00=h*T+p*C+y*A,e.m01=_*T+m*C+S*A,e.m02=f*T+v*C+x*A,e.m03=d*T+g*C+E*A,e.m04=h*b+p*w+y*I,e.m05=_*b+m*w+S*I,e.m06=f*b+v*w+x*I,e.m07=d*b+g*w+E*I,e.m08=h*P+p*R+y*O,e.m09=_*P+m*R+S*O,e.m10=f*P+v*R+x*O,e.m11=d*P+g*R+E*O,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*r+l*i,e.m05=a*r+u*i,e.m06=s*r+h*i,e.m07=c*r+_*i,e.m08=l*r-o*i,e.m09=u*r-a*i,e.m10=h*r-s*i,e.m11=_*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r-l*i,e.m01=a*r-u*i,e.m02=s*r-h*i,e.m03=c*r-_*i,e.m08=o*i+l*r,e.m09=a*i+u*r,e.m10=s*i+h*r,e.m11=c*i+_*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r+l*i,e.m01=a*r+u*i,e.m02=s*r+h*i,e.m03=c*r+_*i,e.m04=l*r-o*i,e.m05=u*r-a*i,e.m06=h*r-s*i,e.m07=_*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<ln)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+o*s,e.m02=o*i*l-r*s,e.m03=0,e.m04=i*r*l-o*s,e.m05=r*r*l+c,e.m06=o*r*l+i*s,e.m07=0,e.m08=i*o*l+r*s,e.m09=r*o*l-i*s,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(f+p),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+p),e.m06=d+m,e.m07=0,e.m08=_+v,e.m09=d-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Qn.m00=t.m00,i=Qn.m01=t.m01,r=Qn.m02=t.m02,o=Qn.m03=t.m04,a=Qn.m04=t.m05,s=Qn.m05=t.m06,c=Qn.m06=t.m08,l=Qn.m07=t.m09,u=Qn.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Fn.determinant(Qn)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=Nn.set(Kn,e.m00,e.m01,e.m02).length(),Qn.m00=e.m00/i.x,Qn.m01=e.m01/i.x,Qn.m02=e.m02/i.x,i.y=Nn.set(Kn,e.m04,e.m05,e.m06).length(),Qn.m03=e.m04/i.y,Qn.m04=e.m05/i.y,Qn.m05=e.m06/i.y,i.z=Nn.set(Kn,e.m08,e.m09,e.m10).length(),Qn.m06=e.m08/i.z,Qn.m07=e.m09/i.z,Qn.m08=e.m10/i.z,Fn.determinant(Qn)<0&&(i.x*=-1,Qn.m00*=-1,Qn.m01*=-1,Qn.m02*=-1),Gn.fromMat3(t,Qn),Nn.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=t.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,d=o*l,p=o*u,m=a*u,v=s*c,g=s*l,y=s*u,S=i.x,x=i.y,E=i.z;return e.m00=(1-(d+m))*S,e.m01=(_+y)*S,e.m02=(f-g)*S,e.m03=0,e.m04=(_-y)*x,e.m05=(1-(h+m))*x,e.m06=(p+v)*x,e.m07=0,e.m08=(f+g)*E,e.m09=(p-v)*E,e.m10=(1-(h+d))*E,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var o=t.x,a=t.y,s=t.z,c=t.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,d=o*h,p=a*u,m=a*h,v=s*h,g=c*l,y=c*u,S=c*h,x=i.x,E=i.y,T=i.z,C=r.x,A=r.y,b=r.z;return e.m00=(1-(p+v))*x,e.m01=(f+S)*x,e.m02=(d-y)*x,e.m03=0,e.m04=(f-S)*E,e.m05=(1-(_+v))*E,e.m06=(m+g)*E,e.m07=0,e.m08=(d+y)*T,e.m09=(m-g)*T,e.m10=(1-(_+p))*T,e.m11=0,e.m12=n.x+C-(e.m00*C+e.m04*A+e.m08*b),e.m13=n.y+A-(e.m01*C+e.m05*A+e.m09*b),e.m14=n.z+b-(e.m02*C+e.m06*A+e.m10*b),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return e.m00=1-h-d,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-d,e.m06=f+p,e.m07=0,e.m08=_+m,e.m09=f-p,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),c=1/(r-i),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=qn[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,d=-2*h,p=(t+n)*u,m=(r+i)*h,v=qn[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=d*v[2],e.m05=d*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=p*v[0]+m*v[2],e.m13=p*v[1]+m*v[3],e.m14=(o-s*a)*_,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),d=c*(_*=f)-l*(h*=f),p=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(d*d+p*p+m*m))-_*(p*=f),g=_*(d*=f)-u*m,y=u*p-h*d;return e.m00=d,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(d*r+p*o+m*a),e.m13=-(v*r+g*o+y*a),e.m14=-(u*r+h*o+_*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,E=i*l-o*s,T=r*l-o*c,C=u*p-h*d,A=u*m-_*d,b=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+S*w+x*b-E*A+T*C;return R?(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(c*b-a*P-l*A)*R,e.m02=(a*I-s*b+l*C)*R,e.m03=0,e.m04=(r*I-i*P-o*w)*R,e.m05=(n*P-r*b+o*A)*R,e.m06=(i*b-n*I-o*C)*R,e.m07=0,e.m08=(p*T-m*E+v*x)*R,e.m09=(m*S-d*T-v*y)*R,e.m10=(d*E-p*S+v*g)*R,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=ln),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=d,this.m15=p,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=ln),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15,m=e*o-t*r,v=e*a-n*r,g=e*s-i*r,y=t*a-n*o,S=t*s-i*o,x=n*s-i*a,E=c*f-l*_,T=c*d-u*_,C=c*p-h*_,A=l*d-u*f,b=l*p-h*f,w=u*p-h*d,I=m*w-v*b+g*A+y*C-S*T+x*E;return 0===I?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(I=1/I,this.m00=(o*w-a*b+s*A)*I,this.m01=(n*b-t*w-i*A)*I,this.m02=(f*x-d*S+p*y)*I,this.m03=(u*S-l*x-h*y)*I,this.m04=(a*C-r*w-s*T)*I,this.m05=(e*w-n*C+i*T)*I,this.m06=(d*g-_*x-p*v)*I,this.m07=(c*x-u*g+h*v)*I,this.m08=(r*b-o*C+s*E)*I,this.m09=(t*C-e*b-i*E)*I,this.m10=(_*S-f*g+p*m)*I,this.m11=(l*g-c*S-h*m)*I,this.m12=(o*T-r*A-a*E)*I,this.m13=(e*A-t*T+n*E)*I,this.m14=(f*v-_*y-d*m)*I,this.m15=(c*y-l*v+u*m)*I,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15;return(e*o-t*r)*(u*p-h*d)-(e*a-n*r)*(l*p-h*f)+(e*s-i*r)*(l*d-u*f)+(t*a-n*o)*(c*p-h*_)-(t*s-i*o)*(c*d-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,d=this.m13,p=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,S=e.m03;return this.m00=v*t+g*o+y*l+S*f,this.m01=v*n+g*a+y*u+S*d,this.m02=v*i+g*s+y*h+S*p,this.m03=v*r+g*c+y*_+S*m,v=e.m04,g=e.m05,y=e.m06,S=e.m07,this.m04=v*t+g*o+y*l+S*f,this.m05=v*n+g*a+y*u+S*d,this.m06=v*i+g*s+y*h+S*p,this.m07=v*r+g*c+y*_+S*m,v=e.m08,g=e.m09,y=e.m10,S=e.m11,this.m08=v*t+g*o+y*l+S*f,this.m09=v*n+g*a+y*u+S*d,this.m10=v*i+g*s+y*h+S*p,this.m11=v*r+g*c+y*_+S*m,v=e.m12,g=e.m13,y=e.m14,S=e.m15,this.m12=v*t+g*o+y*l+S*f,this.m13=v*n+g*a+y*u+S*d,this.m14=v*i+g*s+y*h+S*p,this.m15=v*r+g*c+y*_+S*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<ln)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,d=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,S=this.m11,x=n*n*c+s,E=i*n*c+r*a,T=r*n*c-i*a,C=n*i*c-r*a,A=i*i*c+s,b=r*i*c+n*a,w=n*r*c+i*a,I=i*r*c-n*a,P=r*r*c+s;return this.m00=l*x+f*E+v*T,this.m01=u*x+d*E+g*T,this.m02=h*x+p*E+y*T,this.m03=_*x+m*E+S*T,this.m04=l*C+f*A+v*b,this.m05=u*C+d*A+g*b,this.m06=h*C+p*A+y*b,this.m07=_*C+m*A+S*b,this.m08=l*w+f*I+v*P,this.m09=u*w+d*I+g*P,this.m10=h*w+p*I+y*P,this.m11=_*w+m*I+S*P,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Qn.m00=this.m00,n=Qn.m01=this.m01,i=Qn.m02=this.m02,r=Qn.m03=this.m04,o=Qn.m04=this.m05,a=Qn.m05=this.m06,s=Qn.m06=this.m08,c=Qn.m07=this.m09,l=Qn.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),Fn.determinant(Qn)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l,y=n.x,S=n.y,x=n.z;return this.m00=(1-(f+p))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*S,this.m05=(1-(u+p))*S,this.m06=(d+m)*S,this.m07=0,this.m08=(_+v)*x,this.m09=(d-m)*x,this.m10=(1-(u+f))*x,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-p,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+d,this.m07=0,this.m08=h+p,this.m09=_-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(_t));Yn.IDENTITY=Object.freeze(new Yn);var Kn=new Nn,Qn=new Fn;function Zn(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new Yn(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p)}nn.fastDefine("cc.Mat4",Yn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),h.Mat4=Yn,h.mat4=Zn;var Jn=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}ee(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<ln?e.x=0:e.x=1/n,Math.abs(i)<ln?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof Nn?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,o=t.y;return e.x=r+i*(n.x-r),e.y=o+i*(n.y-o),e},t.random=function(e,t){t=t||1;var n=2*vn()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=ln),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize($n,e),t.normalize(ei,n);var i=t.dot($n,ei);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=ln),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=ln),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=_n(this.x,e.x,t.x),this.y=_n(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=_n(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(_t));Jn.ZERO=Object.freeze(new Jn(0,0)),Jn.ONE=Object.freeze(new Jn(1,1)),Jn.NEG_ONE=Object.freeze(new Jn(-1,-1)),Jn.UNIT_X=Object.freeze(new Jn(1,0)),Jn.UNIT_Y=Object.freeze(new Jn(0,1));var $n=new Jn,ei=new Jn;function ti(e,t){return new Jn(e,t)}nn.fastDefine("cc.Vec2",Jn,{x:0,y:0}),h.Vec2=Jn,h.v2=ti;var ni=e("Vec4",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=r||0),o}ee(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return n*n+i*i+r*r+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w;return Math.abs(n)<ln?e.x=0:e.x=1/n,Math.abs(i)<ln?e.y=0:e.y=1/i,Math.abs(r)<ln?e.z=0:e.z=1/r,Math.abs(o)<ln?e.w=0:e.w=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a,e.w=o*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*vn()*Math.PI,i=2*vn()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return e.x=u*l+f*-a+h*-c-_*-s,e.y=h*l+f*-s+_*-a-u*-c,e.z=_*l+f*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=ln),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=ln),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=ln),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=_n(this.x,e.x,t.x),this.y=_n(this.y,e.y,t.y),this.z=_n(this.z,e.z,t.z),this.w=_n(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(_t));function ii(e,t,n,i){return new ni(e,t,n,i)}ni.ZERO=Object.freeze(new ni(0,0,0,0)),ni.ONE=Object.freeze(new ni(1,1,1,1)),ni.NEG_ONE=Object.freeze(new ni(-1,-1,-1,-1)),nn.fastDefine("cc.Vec4",ni,{x:0,y:0,z:0,w:0}),h.Vec4=ni,h.v4=ii,k(Jn,"Vec2",[{name:"sub",newName:"subtract",target:Jn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Jn,targetName:"Vec2"},{name:"div",newName:"divide",target:Jn,targetName:"Vec2"},{name:"dist",newName:"distance",target:Jn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Jn,targetName:"Vec2"},{name:"mag",newName:"len",target:Jn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Jn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Jn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Jn,targetName:"Vec2"}]),k(Jn.prototype,"Vec2",[{name:"mag",newName:"length",target:Jn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Jn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Jn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Jn.prototype,targetName:"Vec2"}]),k(Nn,"Vec3",[{name:"sub",newName:"subtract",target:Nn,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Nn,targetName:"Vec3"},{name:"div",newName:"divide",target:Nn,targetName:"Vec3"},{name:"dist",newName:"distance",target:Nn,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Nn,targetName:"Vec3"},{name:"mag",newName:"len",target:Nn,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Nn,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Nn,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Nn,targetName:"Vec3"}]),k(Nn.prototype,"Vec3",[{name:"mag",newName:"length",target:Nn.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Nn.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Nn.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Nn.prototype,targetName:"Vec3"}]),k(ni,"Vec4",[{name:"sub",newName:"subtract",target:ni,targetName:"Vec4"},{name:"mul",newName:"multiply",target:ni,targetName:"Vec4"},{name:"div",newName:"divide",target:ni,targetName:"Vec4"},{name:"dist",newName:"distance",target:ni,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:ni,targetName:"Vec4"},{name:"mag",newName:"len",target:ni,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:ni,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ni,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ni,targetName:"Vec4"}]),k(ni.prototype,"Vec4",[{name:"mag",newName:"length",target:ni.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:ni.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ni.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ni.prototype,targetName:"Vec4"}]),k(Gn,"Quat",[{name:"mag",newName:"len",target:Gn,targetName:"Quat"},{name:"mul",newName:"multiply",target:Gn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Gn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Gn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Gn,targetName:"Quat"}]),k(Gn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Gn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Gn.prototype,targetName:"Quat"}]),k(On,"Color",[{name:"sub",newName:"subtract",target:On,targetName:"Color"},{name:"mul",newName:"multiply",target:On,targetName:"Color"},{name:"div",newName:"divide",target:On,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:On,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[1].toString(16);return h.Color.fromHEX(t[0],i)}}]),k(Fn,"Mat3",[{name:"sub",newName:"subtract",target:Fn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Fn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Fn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Fn,targetName:"Mat3"}]),k(Fn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Fn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Fn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Fn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Fn.prototype,targetName:"Mat3"}]),k(Yn,"Mat4",[{name:"sub",newName:"subtract",target:Yn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Yn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Yn,targetName:"Mat4"}]),k(Yn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Yn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Yn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Yn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Yn.prototype,targetName:"Mat4"}]);var ri=e("AffineTransform",function(){function e(e,t,n,i,r,o){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=o}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=o*n.a+a*n.c,e.d=o*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,o;i?(r=t,o=n):(i=n,r=t.x,o=t.y),e.x=i.a*r+i.c*o+i.tx,e.y=i.b*r+i.d*o+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,o=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);e.x=f,e.y=p,e.width=d-f,e.height=m-p},e.transformObb=function(e,t,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());h.AffineTransform=ri;var oi=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}ee(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},J(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(_t));function ai(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new oi(e,t)}oi.ZERO=Object.freeze(new oi(0,0)),oi.ONE=Object.freeze(new oi(1,1)),nn.fastDefine("cc.Size",oi,{width:0,height:0}),h.size=ai,h.Size=oi;var si=e("Rect",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.y=t.y,o.width=t.width,o.height=t.height,o.x=t.x):(o.x=t||0,o.y=n||0,o.width=i||0,o.height=r||0),o}ee(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),o=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=o-i,e.height=a-r,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y,a=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=o+(n.y-o)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,o=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,o=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+o,s+l)-e.x,e.height=Math.max(r+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,o=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,_=e.m01*i+e.m05*r+e.m13,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=p,this.width=d-f,this.height=m-p,this},n.transformMat4ToPoints=function(e,t,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*o+e.m04*c+e.m12,n.y=e.m01*o+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},J(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Jn(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new Jn(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new oi(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(_t));function ci(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new si(e,t,n,i)}nn.fastDefine("cc.Rect",si,{x:0,y:0,width:0,height:0}),h.Rect=si,h.rect=ci;var li=e("MATH_FLOAT_ARRAY",Float64Array),ui=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t.createFloatArray=function(e){return new li(e)},J(t,[{key:"array",get:function(){return this._array}}]),t}(_t)),hi=Object.freeze({__proto__:null,bits:l,Vec2:Jn,v2:ti,Vec3:Nn,v3:Bn,Vec4:ni,v4:ii,Quat:Gn,quat:Xn,Mat3:Fn,Mat4:Yn,mat4:Zn,AffineTransform:ri,Size:oi,size:ai,Rect:si,rect:ci,Color:On,color:Dn,EPSILON:ln,equals:un,approx:hn,clamp:_n,clamp01:fn,lerp:dn,toRadian:pn,toDegree:mn,random:vn,randomRange:gn,randomRangeInt:yn,pseudoRandom:Sn,pseudoRandomRange:xn,pseudoRandomRangeInt:En,nextPow2:Tn,repeat:Cn,pingPong:An,inverseLerp:bn,absMaxComponent:wn,absMax:In,enumerableProps:Pn,MATH_FLOAT_ARRAY:li,MathBase:ui});e("math",hi);var _i,fi,di,pi,mi,vi,gi,yi,Si,xi,Ei,Ti,Ci,Ai,bi,wi,Ii,Pi,Ri,Oi,Di,Ni,Mi,Li,Bi,Fi,zi,Ui,Gi,ki,Hi,Vi,Wi,ji,Xi,qi,Yi,Ki,Qi,Zi,Ji,$i,er=new(function(){function e(){this._finalizationRegistry=null,this._gcObjects=new WeakMap}var t=e.prototype;return t.registerGCObject=function(e){return e},t.init=function(){},t.finalizationRegistryCallback=function(e){var t=this._gcObjects.get(e);t&&(this._gcObjects.delete(e),t.destroy()),this._finalizationRegistry.unregister(e)},t.destroy=function(){},e}()),tr=function(){function e(){return er.registerGCObject(this)}return e.prototype.destroy=function(){},e}(),nr=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(_i||(_i={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(fi||(fi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.NVN=5]="NVN",e[e.WEBGL=6]="WEBGL",e[e.WEBGL2=7]="WEBGL2",e[e.WEBGPU=8]="WEBGPU"}(di||(di={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(pi||(pi={})),function(e){e[e.ELEMENT_INDEX_UINT=0]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=1]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=2]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=3]="BLEND_MINMAX",e[e.COMPUTE_SHADER=4]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=5]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=6]="COUNT"}(mi||(mi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(vi||(vi={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(gi||(gi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(yi||(yi={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(Si||(Si={})),function(e){e[e.NONE=0]="NONE"}(xi||(xi={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(Ei||(Ei={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Ti||(Ti={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Ci||(Ci={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Ai||(Ai={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(bi||(bi={})),function(e){e[e.NONE=0]="NONE",e[e.RENDER_TARGET=1]="RENDER_TARGET",e[e.SAMPLED_TEXTURE=2]="SAMPLED_TEXTURE",e[e.LINEAR_FILTER=4]="LINEAR_FILTER",e[e.STORAGE_TEXTURE=8]="STORAGE_TEXTURE",e[e.VERTEX_ATTRIBUTE=16]="VERTEX_ATTRIBUTE"}(wi||(wi={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Ii||(Ii={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Pi||(Pi={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Ri||(Ri={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Oi||(Oi={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Di||(Di={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Ni||(Ni={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Mi||(Mi={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Li||(Li={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Bi||(Bi={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Fi||(Fi={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(zi||(zi={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Ui||(Ui={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=4]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=8]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=16]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=32]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=64]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=128]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=256]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=512]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=1024]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=2048]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=4096]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=8192]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=16384]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=32768]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=65536]="TRANSFER_READ",e[e.HOST_READ=131072]="HOST_READ",e[e.PRESENT=262144]="PRESENT",e[e.VERTEX_SHADER_WRITE=524288]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=1048576]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=2097152]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=4194304]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=8388608]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=16777216]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=33554432]="HOST_PREINITIALIZED",e[e.HOST_WRITE=67108864]="HOST_WRITE"}(Gi||(Gi={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(ki||(ki={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Hi||(Hi={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Vi||(Vi={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Wi||(Wi={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(ji||(ji={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Xi||(Xi={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(qi||(qi={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(Yi||(Yi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Ki||(Ki={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Qi||(Qi={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(Zi||(Zi={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(Ji||(Ji={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}($i||($i={}));var ir,rr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),or=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,S,x){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=new rr),void 0===v&&(v=new rr),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===S&&(S=1),void 0===x&&(x=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=d,this.maxComputeWorkGroupInvocations=p,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=S,this.clipSpaceSignY=x}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),ar=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),sr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),cr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),lr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),ur=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),hr=function(){function e(e,t,n,i,r){void 0===e&&(e=new lr),void 0===t&&(t=new ar),void 0===n&&(n=new lr),void 0===i&&(i=new ar),void 0===r&&(r=new cr),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),_r=function(){function e(e,t,n,i,r,o){void 0===e&&(e=new lr),void 0===t&&(t=new ar),void 0===n&&(n=new cr),void 0===i&&(i=new lr),void 0===r&&(r=new ar),void 0===o&&(o=new cr),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),fr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new ar),void 0===i&&(i=new cr),void 0===r&&(r=new lr),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),dr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),pr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),mr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[0]),void 0===t&&(t=[0]),void 0===n&&(n=[0]),void 0===i&&(i=[0]),void 0===r&&(r=[0]),void 0===o&&(o=[0]),void 0===a&&(a=[0]),void 0===s&&(s=[0]),this.maxBlockCounts=e,this.maxSamplerTextureCounts=t,this.maxSamplerCounts=n,this.maxTextureCounts=i,this.maxBufferCounts=r,this.maxImageCounts=o,this.maxSubpassInputCounts=a,this.setIndices=s}return e.prototype.copy=function(e){return this.maxBlockCounts=e.maxBlockCounts.slice(),this.maxSamplerTextureCounts=e.maxSamplerTextureCounts.slice(),this.maxSamplerCounts=e.maxSamplerCounts.slice(),this.maxTextureCounts=e.maxTextureCounts.slice(),this.maxBufferCounts=e.maxBufferCounts.slice(),this.maxImageCounts=e.maxImageCounts.slice(),this.maxSubpassInputCounts=e.maxSubpassInputCounts.slice(),this.setIndices=e.setIndices.slice(),this},e}(),vr=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=Pi.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),gr=function(){function e(e){void 0===e&&(e=new mr),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),yr=function(){function e(e,t,n,i,r){void 0===e&&(e=Si.NONE),void 0===t&&(t=Ti.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=xi.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),Sr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),xr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),Er=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),Tr=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return nr(this.drawInfos,e.drawInfos,xr),this},e}(),Cr=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=Ci.TEX2D),void 0===t&&(t=Ai.NONE),void 0===n&&(n=vi.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=bi.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Ii.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),Ar=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=null),void 0===t&&(t=Ci.TEX2D),void 0===n&&(n=vi.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),br=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=Ri.LINEAR),void 0===t&&(t=Ri.LINEAR),void 0===n&&(n=Ri.NONE),void 0===i&&(i=Oi.WRAP),void 0===r&&(r=Oi.WRAP),void 0===o&&(o=Oi.WRAP),void 0===a&&(a=0),void 0===s&&(s=Di.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),wr=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=yi.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Ir=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,nr(this.members,e.members,wr),this.count=e.count,this},e}(),Pr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=yi.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Rr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Or=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=yi.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Dr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=yi.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=Ei.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Nr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=Ei.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Mr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Lr=function(){function e(e,t){void 0===e&&(e=Fi.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),Br=function(){function e(e,t,n,i,r,o){void 0===e&&(e=""),void 0===t&&(t=vi.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),Fr=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,nr(this.stages,e.stages,Lr),nr(this.attributes,e.attributes,Br),nr(this.blocks,e.blocks,Ir),nr(this.buffers,e.buffers,Nr),nr(this.samplerTextures,e.samplerTextures,Pr),nr(this.samplers,e.samplers,Rr),nr(this.textures,e.textures,Or),nr(this.images,e.images,Dr),nr(this.subpassInputs,e.subpassInputs,Mr),this},e}(),zr=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return nr(this.attributes,e.attributes,Br),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),Ur=function(){function e(e,t,n,i,r,o){void 0===e&&(e=vi.UNKNOWN),void 0===t&&(t=Ii.ONE),void 0===n&&(n=zi.CLEAR),void 0===i&&(i=Ui.STORE),void 0===r&&(r=null),void 0===o&&(o=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.barrier=r,this.isGeneralLayout=o}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this},e}(),Gr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=vi.UNKNOWN),void 0===t&&(t=Ii.ONE),void 0===n&&(n=zi.CLEAR),void 0===i&&(i=Ui.STORE),void 0===r&&(r=zi.CLEAR),void 0===o&&(o=Ui.STORE),void 0===a&&(a=null),void 0===s&&(s=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.barrier=a,this.isGeneralLayout=s}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this},e}(),kr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=ki.NONE),void 0===s&&(s=ki.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),Hr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=null),this.srcSubpass=e,this.dstSubpass=t,this.barrier=n}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.barrier=e.barrier,this},e}(),Vr=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Gr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return nr(this.colorAttachments,e.colorAttachments,Ur),this.depthStencilAttachment.copy(e.depthStencilAttachment),nr(this.subpasses,e.subpasses,kr),nr(this.dependencies,e.dependencies,Hr),this},e}(),Wr=function(){function e(e,t){void 0===e&&(e=Gi.NONE),void 0===t&&(t=Gi.NONE),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this},e}(),jr=function(){function e(e,t,n,i,r){void 0===e&&(e=Gi.NONE),void 0===t&&(t=Gi.NONE),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),Xr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),qr=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=Ki.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Fi.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),Yr=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return nr(this.bindings,e.bindings,qr),this},e}(),Kr=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),Qr=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),Zr=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return nr(this.attributes,e.attributes,Br),this},e}(),Jr=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=Ji.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),$r=function(){function e(e){void 0===e&&(e=Qi.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),eo=function(){function e(e,t,n){void 0===e&&(e=Zi.OCCLUSION),void 0===t&&(t=32767),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),to=function(e,t,n,i,r,o,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=gi.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},no=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),io=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),ro=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=new dr),void 0===t&&(t=new sr),void 0===n&&(n=new pr),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new io),void 0===u&&(u=new io),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),oo=function(e){function t(n){var i;return(i=e.call(this)||this)._objectType=_i.UNKNOWN,i._objectID=0,i._typedID=0,i._objectType=n,i._objectID=t._idTable[_i.UNKNOWN]++,i._typedID=t._idTable[n]++,i}return ee(t,e),J(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}(tr);oo._idTable=Array(_i.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(ir||(ir={}));var ao=Object.freeze([new to("UNKNOWN",0,0,gi.NONE,!1,!1,!1,!1),new to("A8",1,1,gi.UNORM,!0,!1,!1,!1),new to("L8",1,1,gi.UNORM,!1,!1,!1,!1),new to("LA8",1,2,gi.UNORM,!0,!1,!1,!1),new to("R8",1,1,gi.UNORM,!1,!1,!1,!1),new to("R8SN",1,1,gi.SNORM,!1,!1,!1,!1),new to("R8UI",1,1,gi.UINT,!1,!1,!1,!1),new to("R8I",1,1,gi.INT,!1,!1,!1,!1),new to("R16F",2,1,gi.FLOAT,!1,!1,!1,!1),new to("R16UI",2,1,gi.UINT,!1,!1,!1,!1),new to("R16I",2,1,gi.INT,!1,!1,!1,!1),new to("R32F",4,1,gi.FLOAT,!1,!1,!1,!1),new to("R32UI",4,1,gi.UINT,!1,!1,!1,!1),new to("R32I",4,1,gi.INT,!1,!1,!1,!1),new to("RG8",2,2,gi.UNORM,!1,!1,!1,!1),new to("RG8SN",2,2,gi.SNORM,!1,!1,!1,!1),new to("RG8UI",2,2,gi.UINT,!1,!1,!1,!1),new to("RG8I",2,2,gi.INT,!1,!1,!1,!1),new to("RG16F",4,2,gi.FLOAT,!1,!1,!1,!1),new to("RG16UI",4,2,gi.UINT,!1,!1,!1,!1),new to("RG16I",4,2,gi.INT,!1,!1,!1,!1),new to("RG32F",8,2,gi.FLOAT,!1,!1,!1,!1),new to("RG32UI",8,2,gi.UINT,!1,!1,!1,!1),new to("RG32I",8,2,gi.INT,!1,!1,!1,!1),new to("RGB8",3,3,gi.UNORM,!1,!1,!1,!1),new to("SRGB8",3,3,gi.UNORM,!1,!1,!1,!1),new to("RGB8SN",3,3,gi.SNORM,!1,!1,!1,!1),new to("RGB8UI",3,3,gi.UINT,!1,!1,!1,!1),new to("RGB8I",3,3,gi.INT,!1,!1,!1,!1),new to("RGB16F",6,3,gi.FLOAT,!1,!1,!1,!1),new to("RGB16UI",6,3,gi.UINT,!1,!1,!1,!1),new to("RGB16I",6,3,gi.INT,!1,!1,!1,!1),new to("RGB32F",12,3,gi.FLOAT,!1,!1,!1,!1),new to("RGB32UI",12,3,gi.UINT,!1,!1,!1,!1),new to("RGB32I",12,3,gi.INT,!1,!1,!1,!1),new to("RGBA8",4,4,gi.UNORM,!0,!1,!1,!1),new to("BGRA8",4,4,gi.UNORM,!0,!1,!1,!1),new to("SRGB8_A8",4,4,gi.UNORM,!0,!1,!1,!1),new to("RGBA8SN",4,4,gi.SNORM,!0,!1,!1,!1),new to("RGBA8UI",4,4,gi.UINT,!0,!1,!1,!1),new to("RGBA8I",4,4,gi.INT,!0,!1,!1,!1),new to("RGBA16F",8,4,gi.FLOAT,!0,!1,!1,!1),new to("RGBA16UI",8,4,gi.UINT,!0,!1,!1,!1),new to("RGBA16I",8,4,gi.INT,!0,!1,!1,!1),new to("RGBA32F",16,4,gi.FLOAT,!0,!1,!1,!1),new to("RGBA32UI",16,4,gi.UINT,!0,!1,!1,!1),new to("RGBA32I",16,4,gi.INT,!0,!1,!1,!1),new to("R5G6B5",2,3,gi.UNORM,!1,!1,!1,!1),new to("R11G11B10F",4,3,gi.FLOAT,!1,!1,!1,!1),new to("RGB5A1",2,4,gi.UNORM,!0,!1,!1,!1),new to("RGBA4",2,4,gi.UNORM,!0,!1,!1,!1),new to("RGB10A2",2,4,gi.UNORM,!0,!1,!1,!1),new to("RGB10A2UI",2,4,gi.UINT,!0,!1,!1,!1),new to("RGB9E5",2,4,gi.FLOAT,!0,!1,!1,!1),new to("DEPTH",4,1,gi.FLOAT,!1,!0,!1,!1),new to("DEPTH_STENCIL",5,2,gi.FLOAT,!1,!0,!0,!1),new to("BC1",1,3,gi.UNORM,!1,!1,!1,!0),new to("BC1_ALPHA",1,4,gi.UNORM,!0,!1,!1,!0),new to("BC1_SRGB",1,3,gi.UNORM,!1,!1,!1,!0),new to("BC1_SRGB_ALPHA",1,4,gi.UNORM,!0,!1,!1,!0),new to("BC2",1,4,gi.UNORM,!0,!1,!1,!0),new to("BC2_SRGB",1,4,gi.UNORM,!0,!1,!1,!0),new to("BC3",1,4,gi.UNORM,!0,!1,!1,!0),new to("BC3_SRGB",1,4,gi.UNORM,!0,!1,!1,!0),new to("BC4",1,1,gi.UNORM,!1,!1,!1,!0),new to("BC4_SNORM",1,1,gi.SNORM,!1,!1,!1,!0),new to("BC5",1,2,gi.UNORM,!1,!1,!1,!0),new to("BC5_SNORM",1,2,gi.SNORM,!1,!1,!1,!0),new to("BC6H_UF16",1,3,gi.UFLOAT,!1,!1,!1,!0),new to("BC6H_SF16",1,3,gi.FLOAT,!1,!1,!1,!0),new to("BC7",1,4,gi.UNORM,!0,!1,!1,!0),new to("BC7_SRGB",1,4,gi.UNORM,!0,!1,!1,!0),new to("ETC_RGB8",1,3,gi.UNORM,!1,!1,!1,!0),new to("ETC2_RGB8",1,3,gi.UNORM,!1,!1,!1,!0),new to("ETC2_SRGB8",1,3,gi.UNORM,!1,!1,!1,!0),new to("ETC2_RGB8_A1",1,4,gi.UNORM,!0,!1,!1,!0),new to("ETC2_SRGB8_A1",1,4,gi.UNORM,!0,!1,!1,!0),new to("ETC2_RGBA8",2,4,gi.UNORM,!0,!1,!1,!0),new to("ETC2_SRGB8_A8",2,4,gi.UNORM,!0,!1,!1,!0),new to("EAC_R11",1,1,gi.UNORM,!1,!1,!1,!0),new to("EAC_R11SN",1,1,gi.SNORM,!1,!1,!1,!0),new to("EAC_RG11",2,2,gi.UNORM,!1,!1,!1,!0),new to("EAC_RG11SN",2,2,gi.SNORM,!1,!1,!1,!0),new to("PVRTC_RGB2",2,3,gi.UNORM,!1,!1,!1,!0),new to("PVRTC_RGBA2",2,4,gi.UNORM,!0,!1,!1,!0),new to("PVRTC_RGB4",2,3,gi.UNORM,!1,!1,!1,!0),new to("PVRTC_RGBA4",2,4,gi.UNORM,!0,!1,!1,!0),new to("PVRTC2_2BPP",2,4,gi.UNORM,!0,!1,!1,!0),new to("PVRTC2_4BPP",2,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_4x4",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_5x4",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_5x5",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_6x5",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_6x6",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_8x5",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_8x6",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_8x8",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_10x5",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_10x6",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_10x8",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_10x10",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_12x10",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_RGBA_12x12",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_4x4",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_5x4",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_5x5",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_6x5",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_6x6",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_8x5",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_8x6",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_8x8",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_10x5",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_10x6",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_10x8",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_10x10",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_12x10",1,4,gi.UNORM,!0,!1,!1,!0),new to("ASTC_SRGBA_12x12",1,4,gi.UNORM,!0,!1,!1,!0)]),so=Ki.UNIFORM_BUFFER|Ki.DYNAMIC_UNIFORM_BUFFER|Ki.STORAGE_BUFFER|Ki.DYNAMIC_STORAGE_BUFFER,co=Ki.SAMPLER_TEXTURE|Ki.SAMPLER|Ki.TEXTURE|Ki.STORAGE_IMAGE|Ki.INPUT_ATTACHMENT,lo=Ki.DYNAMIC_STORAGE_BUFFER|Ki.DYNAMIC_UNIFORM_BUFFER,uo=28;function ho(e){return e>0&&0==(e&e-1)}function _o(e,t,n,i){if(!ao[e].isCompressed)return t*n*i*ao[e].size;switch(e){case vi.BC1:case vi.BC1_ALPHA:case vi.BC1_SRGB:case vi.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case vi.BC2:case vi.BC2_SRGB:case vi.BC3:case vi.BC3_SRGB:case vi.BC4:case vi.BC4_SNORM:case vi.BC6H_SF16:case vi.BC6H_UF16:case vi.BC7:case vi.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case vi.BC5:case vi.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case vi.ETC_RGB8:case vi.ETC2_RGB8:case vi.ETC2_SRGB8:case vi.ETC2_RGB8_A1:case vi.EAC_R11:case vi.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case vi.ETC2_RGBA8:case vi.ETC2_SRGB8_A1:case vi.EAC_RG11:case vi.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case vi.PVRTC_RGB2:case vi.PVRTC_RGBA2:case vi.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case vi.PVRTC_RGB4:case vi.PVRTC_RGBA4:case vi.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case vi.ASTC_RGBA_4X4:case vi.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case vi.ASTC_RGBA_5X4:case vi.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case vi.ASTC_RGBA_5X5:case vi.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case vi.ASTC_RGBA_6X5:case vi.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case vi.ASTC_RGBA_6X6:case vi.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case vi.ASTC_RGBA_8X5:case vi.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case vi.ASTC_RGBA_8X6:case vi.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case vi.ASTC_RGBA_8X8:case vi.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case vi.ASTC_RGBA_10X5:case vi.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case vi.ASTC_RGBA_10X6:case vi.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case vi.ASTC_RGBA_10X8:case vi.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case vi.ASTC_RGBA_10X10:case vi.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case vi.ASTC_RGBA_12X10:case vi.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case vi.ASTC_RGBA_12X12:case vi.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function fo(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=_o(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var po=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function mo(e){return po[e]||0}function vo(e){var t=e.size/e.count;switch(e.type){case gi.UNORM:case gi.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case gi.SNORM:case gi.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case gi.FLOAT:return Float32Array}return Float32Array}var go=Object.freeze({__proto__:null,get ObjectType(){return _i},get Status(){return fi},get API(){return di},get SurfaceTransform(){return pi},get Feature(){return mi},get Format(){return vi},get FormatType(){return gi},get Type(){return yi},get BufferUsageBit(){return Si},get BufferFlagBit(){return xi},get MemoryAccessBit(){return Ei},get MemoryUsageBit(){return Ti},get TextureType(){return Ci},get TextureUsageBit(){return Ai},get TextureFlagBit(){return bi},get FormatFeatureBit(){return wi},get SampleCount(){return Ii},get VsyncMode(){return Pi},get Filter(){return Ri},get Address(){return Oi},get ComparisonFunc(){return Di},get StencilOp(){return Ni},get BlendFactor(){return Mi},get BlendOp(){return Li},get ColorMask(){return Bi},get ShaderStageFlagBit(){return Fi},get LoadOp(){return zi},get StoreOp(){return Ui},get AccessFlagBit(){return Gi},get ResolveMode(){return ki},get PipelineBindPoint(){return Hi},get PrimitiveMode(){return Vi},get PolygonMode(){return Wi},get ShadeModel(){return ji},get CullMode(){return Xi},get DynamicStateFlagBit(){return qi},get StencilFace(){return Yi},get DescriptorType(){return Ki},get QueueType(){return Qi},get QueryType(){return Zi},get CommandBufferType(){return Ji},get ClearFlagBit(){return $i},Size:rr,DeviceCaps:or,Offset:ar,Rect:sr,Extent:cr,TextureSubresLayers:lr,TextureSubresRange:ur,TextureCopy:hr,TextureBlit:_r,BufferTextureCopy:fr,Viewport:dr,Color:pr,BindingMappingInfo:mr,SwapchainInfo:vr,DeviceInfo:gr,BufferInfo:yr,BufferViewInfo:Sr,DrawInfo:xr,DispatchInfo:Er,IndirectBuffer:Tr,TextureInfo:Cr,TextureViewInfo:Ar,SamplerInfo:br,Uniform:wr,UniformBlock:Ir,UniformSamplerTexture:Pr,UniformSampler:Rr,UniformTexture:Or,UniformStorageImage:Dr,UniformStorageBuffer:Nr,UniformInputAttachment:Mr,ShaderStage:Lr,Attribute:Br,ShaderInfo:Fr,InputAssemblerInfo:zr,ColorAttachment:Ur,DepthStencilAttachment:Gr,SubpassInfo:kr,SubpassDependency:Hr,RenderPassInfo:Vr,GeneralBarrierInfo:Wr,TextureBarrierInfo:jr,FramebufferInfo:Xr,DescriptorSetLayoutBinding:qr,DescriptorSetLayoutInfo:Yr,DescriptorSetInfo:Kr,PipelineLayoutInfo:Qr,InputState:Zr,CommandBufferInfo:Jr,QueueInfo:$r,QueryPoolInfo:eo,FormatInfo:to,MemoryStatus:no,DynamicStencilStates:io,DynamicStates:ro,GFXObject:oo,get AttributeName(){return ir},FormatInfos:ao,DESCRIPTOR_BUFFER_TYPE:so,DESCRIPTOR_SAMPLER_TYPE:co,DESCRIPTOR_DYNAMIC_TYPE:lo,DRAW_INFO_SIZE:uo,IsPowerOf2:ho,FormatSize:_o,FormatSurfaceSize:fo,GetTypeSize:mo,getTypedArrayConstructor:vo}),yo=function(e){function t(){var t;return(t=e.call(this,_i.BUFFER)||this)._usage=Si.NONE,t._memUsage=Ti.NONE,t._size=0,t._stride=1,t._count=0,t._flags=xi.NONE,t._isBufferView=!1,t}return ee(t,e),J(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(oo),So=function(e){function t(){var t;return(t=e.call(this,_i.COMMAND_BUFFER)||this)._queue=null,t._type=Ji.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return ee(t,e),J(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(oo),xo=function(){function e(){this._gfxAPI=di.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(mi.COUNT),this._formatFeatures=new Array(vi.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new no,this._caps=new or,this._bindingMappingInfo=new mr,this._samplers=new Map,this._generalBarrierss=new Map,this._textureBarriers=new Map}var t=e.prototype;return t.hasFeature=function(e){return this._features[e]},t.getFormatFeatures=function(e){return this._formatFeatures[e]},J(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();xo.canvas=void 0;var Eo=function(e){function t(){var t;return(t=e.call(this,_i.SWAPCHAIN)||this)._transform=pi.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return ee(t,e),J(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}(oo),To=function(e){function t(){var t;return(t=e.call(this,_i.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return ee(t,e),J(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(oo),Co=String.prototype.charCodeAt;function Ao(e){return this[e]}function bo(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?Co:Ao;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var wo=function(e){function t(){var t;return(t=e.call(this,_i.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new xr,t}ee(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return bo(e,666)},J(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}(oo),Io=function(e){function t(){var t;return(t=e.call(this,_i.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}ee(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&so){var o=this._layout.descriptorIndices[e];this._buffers[o+n]!==t&&(this._buffers[o+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&co){var o=this._layout.descriptorIndices[e];this._samplers[o+n]!==t&&(this._samplers[o+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&co){var o=this._layout.descriptorIndices[e];this._textures[o+n]!==t&&(this._textures[o+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},J(t,[{key:"layout",get:function(){return this._layout}}]),t}(oo),Po=function(e){function t(){var t;return(t=e.call(this,_i.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return ee(t,e),J(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(oo),Ro=function(e){function t(){var t;return(t=e.call(this,_i.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return ee(t,e),J(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(oo),Oo=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Wi.FILL),void 0===n&&(n=ji.GOURAND),void 0===i&&(i=Xi.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Wi.FILL,this.shadeModel=ji.GOURAND,this.cullMode=Xi.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},J(e,[{key:"native",get:function(){return this}}]),e}(),Do=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=Di.LESS),void 0===i&&(i=!1),void 0===r&&(r=Di.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Ni.KEEP),void 0===c&&(c=Ni.KEEP),void 0===l&&(l=Ni.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=Di.ALWAYS),void 0===f&&(f=65535),void 0===d&&(d=65535),void 0===p&&(p=Ni.KEEP),void 0===m&&(m=Ni.KEEP),void 0===v&&(v=Ni.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=d,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Di.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Di.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Ni.KEEP,this.stencilZFailOpFront=Ni.KEEP,this.stencilPassOpFront=Ni.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Di.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Ni.KEEP,this.stencilZFailOpBack=Ni.KEEP,this.stencilPassOpBack=Ni.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},J(e,[{key:"native",get:function(){return this}}]),e}(),No=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=!1),void 0===t&&(t=Mi.ONE),void 0===n&&(n=Mi.ZERO),void 0===i&&(i=Li.ADD),void 0===r&&(r=Mi.ONE),void 0===o&&(o=Mi.ZERO),void 0===a&&(a=Li.ADD),void 0===s&&(s=Bi.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Mi.ONE,this.blendDst=Mi.ZERO,this.blendEq=Li.ADD,this.blendSrcAlpha=Mi.ONE,this.blendDstAlpha=Mi.ZERO,this.blendAlphaEq=Li.ADD,this.blendColorMask=Bi.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),Mo=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new pr),void 0===i&&(i=[new No]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new No),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},J(e,[{key:"native",get:function(){return this}}]),e}(),Lo=function(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new Zr),void 0===r&&(r=new Oo),void 0===o&&(o=new Do),void 0===a&&(a=new Mo),void 0===s&&(s=Vi.TRIANGLE_LIST),void 0===c&&(c=qi.NONE),void 0===l&&(l=Hi.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Bo=function(e){function t(){var t;return(t=e.call(this,_i.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=Vi.TRIANGLE_LIST,t._is=null,t._rs=new Oo,t._dss=new Do,t._bs=new Mo,t._dynamicStates=qi.NONE,t._renderPass=null,t}return ee(t,e),J(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(oo),Fo=function(e){function t(){var t;return(t=e.call(this,_i.QUEUE)||this)._type=Qi.GRAPHICS,t}return ee(t,e),J(t,[{key:"type",get:function(){return this._type}}]),t}(oo),zo=function(e){function t(){var t;return(t=e.call(this,_i.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return ee(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return bo(e,666)},J(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(oo),Uo=function(e){function t(t,n){var i;return(i=e.call(this,_i.SAMPLER)||this)._info=new br,i._hash=0,i._info.copy(t),i._hash=n,i}return ee(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new br;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},J(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(oo),Go=function(e){function t(){var t;return(t=e.call(this,_i.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return ee(t,e),J(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(oo),ko=function(e){function t(){var t;return(t=e.call(this,_i.TEXTURE)||this)._info=new Cr,t._viewInfo=new Ar,t._isPowerOf2=!1,t._isTextureView=!1,t._size=0,t}return ee(t,e),t.getLevelCount=function(e,t){return Math.floor(Math.log2(Math.max(e,t)))},J(t,[{key:"type",get:function(){return this._info.type}},{key:"usage",get:function(){return this._info.usage}},{key:"format",get:function(){return this._info.format}},{key:"width",get:function(){return this._info.width}},{key:"height",get:function(){return this._info.height}},{key:"depth",get:function(){return this._info.depth}},{key:"layerCount",get:function(){return this._info.layerCount}},{key:"levelCount",get:function(){return this._info.levelCount}},{key:"samples",get:function(){return this._info.samples}},{key:"flags",get:function(){return this._info.flags}},{key:"size",get:function(){return this._size}},{key:"info",get:function(){return this._info}},{key:"viewInfo",get:function(){return this._viewInfo}},{key:"isTextureView",get:function(){return this._isTextureView}}]),t}(oo),Ho=function(e){function t(t,n){var i;return(i=e.call(this,_i.GLOBAL_BARRIER)||this)._info=new Wr,i._hash=0,i._info.copy(t),i._hash=n,i}return ee(t,e),t.computeHash=function(e){return bo(e.prevAccesses+" "+e.nextAccesses,666)},J(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(oo),Vo=function(e){function t(t,n){var i;return(i=e.call(this,_i.TEXTURE_BARRIER)||this)._info=new jr,i._hash=0,i._info.copy(t),i._hash=n,i}return ee(t,e),t.computeHash=function(e){var t=e.prevAccesses+" "+e.nextAccesses;return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,bo(t+=e.dstQueue?e.dstQueue.type:0,666)},J(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(oo),Wo={Device:xo,Swapchain:Eo,Buffer:yo,Texture:ko,Sampler:Uo,Shader:Go,InputAssembler:wo,RenderPass:zo,Framebuffer:To,DescriptorSet:Io,DescriptorSetLayout:Po,PipelineLayout:Ro,PipelineState:Bo,CommandBuffer:So,Queue:Fo,GeneralBarrier:Ho,TextureBarrier:Vo,RasterizerState:Oo,BlendState:Mo,BlendTarget:No,DepthStencilState:Do,PipelineStateInfo:Lo};Object.assign(Wo,go),h.gfx=Wo;var jo={GFXDevice:!0,GFXBuffer:!0,GFXTexture:!0,GFXSampler:!0,GFXShader:!0,GFXInputAssembler:!0,GFXRenderPass:!0,GFXFramebuffer:!0,GFXPipelineState:!0,GFXCommandBuffer:!0,GFXQueue:!0,GFXObjectType:!0,GFXObject:!1,GFXAttributeName:!0,GFXType:!0,GFXFormat:!0,GFXBufferUsageBit:!0,GFXMemoryUsageBit:!0,GFXBufferFlagBit:!0,GFXBufferAccessBit:"MemoryAccessBit",GFXPrimitiveMode:!0,GFXPolygonMode:!0,GFXShadeModel:!0,GFXCullMode:!0,GFXComparisonFunc:!0,GFXStencilOp:!0,GFXBlendOp:!0,GFXBlendFactor:!0,GFXColorMask:!0,GFXFilter:!0,GFXAddress:!0,GFXTextureType:!0,GFXTextureUsageBit:!0,GFXSampleCount:!0,GFXTextureFlagBit:!0,GFXShaderStageFlagBit:!0,GFXDescriptorType:!0,GFXCommandBufferType:!0,GFXLoadOp:!0,GFXStoreOp:!0,GFXPipelineBindPoint:!0,GFXDynamicStateFlagBit:!0,GFXStencilFace:!0,GFXQueueType:!0,GFXRect:!0,GFXViewport:!0,GFXColor:!0,GFXClearFlag:!0,GFXOffset:!0,GFXExtent:!0,GFXTextureSubres:"TextureSubresLayers",GFXTextureCopy:!0,GFXBufferTextureCopy:!0,GFXFormatType:!0,GFXFormatInfo:!0,GFXMemoryStatus:!0,GFXFormatInfos:!0,GFXFormatSize:!0,GFXFormatSurfaceSize:!0,GFXGetTypeSize:!0,getTypedArrayConstructor:!1};for(var Xo in jo){var qo=jo[Xo];!0===qo?qo=Xo.slice(3):!1===qo&&(qo=Xo),k(h,"cc",[{name:Xo,newName:qo,target:h.gfx,targetName:"cc.gfx"}])}H(h,"cc",[{name:"GFX_MAX_VERTEX_ATTRIBUTES"},{name:"GFX_MAX_TEXTURE_UNITS"},{name:"GFX_MAX_ATTACHMENTS"},{name:"GFX_MAX_BUFFER_BINDINGS"},{name:"GFXTextureLayout"}]),H(mi,"Feature",[{name:"COLOR_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.RENDER_TARGET;"},{name:"COLOR_HALF_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.RENDER_TARGET;"},{name:"TEXTURE_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R32F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);"},{name:"TEXTURE_HALF_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R16F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);"},{name:"TEXTURE_FLOAT_LINEAR",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.LINEAR_FILTER;"},{name:"TEXTURE_HALF_FLOAT_LINEAR",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.LINEAR_FILTER;"},{name:"FORMAT_R11G11B10F",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R11G11B10F) !== FormatFeatureBit.NONE;"},{name:"FORMAT_SRGB",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.SRGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ETC1",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC_RGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ETC2",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC2_RGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_DXT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.BC1) !== FormatFeatureBit.NONE;"},{name:"FORMAT_PVRTC",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.PVRTC_RGB2) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ASTC",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ASTC_RGBA_4x4) !== FormatFeatureBit.NONE;"},{name:"FORMAT_RGB8",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.RGB8) !== FormatFeatureBit.NONE;"}]),H(Ur.prototype,"ColorAttachment",[{name:"beginAccesses",suggest:"Please assign to ColorAttachment.barrier instead"},{name:"endAccesses",suggest:"Please assign to ColorAttachment.barrier instead"}]),H(Gr.prototype,"DepthStencilAttachment",[{name:"beginAccesses",suggest:"Please assign to DepthStencilAttachment.barrier instead"},{name:"endAccesses",suggest:"Please assign to DepthStencilAttachment.barrier instead"}]),k(xo.prototype,"Device",[{name:"getGlobalBarrier",newName:"getGeneralBarrier"}]),e("gfx",Object.freeze({__proto__:null,DescriptorSet:Io,Buffer:yo,CommandBuffer:So,get ObjectType(){return _i},get Status(){return fi},get API(){return di},get SurfaceTransform(){return pi},get Feature(){return mi},get Format(){return vi},get FormatType(){return gi},get Type(){return yi},get BufferUsageBit(){return Si},get BufferFlagBit(){return xi},get MemoryAccessBit(){return Ei},get MemoryUsageBit(){return Ti},get TextureType(){return Ci},get TextureUsageBit(){return Ai},get TextureFlagBit(){return bi},get FormatFeatureBit(){return wi},get SampleCount(){return Ii},get VsyncMode(){return Pi},get Filter(){return Ri},get Address(){return Oi},get ComparisonFunc(){return Di},get StencilOp(){return Ni},get BlendFactor(){return Mi},get BlendOp(){return Li},get ColorMask(){return Bi},get ShaderStageFlagBit(){return Fi},get LoadOp(){return zi},get StoreOp(){return Ui},get AccessFlagBit(){return Gi},get ResolveMode(){return ki},get PipelineBindPoint(){return Hi},get PrimitiveMode(){return Vi},get PolygonMode(){return Wi},get ShadeModel(){return ji},get CullMode(){return Xi},get DynamicStateFlagBit(){return qi},get StencilFace(){return Yi},get DescriptorType(){return Ki},get QueueType(){return Qi},get QueryType(){return Zi},get CommandBufferType(){return Ji},get ClearFlagBit(){return $i},Size:rr,DeviceCaps:or,Offset:ar,Rect:sr,Extent:cr,TextureSubresLayers:lr,TextureSubresRange:ur,TextureCopy:hr,TextureBlit:_r,BufferTextureCopy:fr,Viewport:dr,Color:pr,BindingMappingInfo:mr,SwapchainInfo:vr,DeviceInfo:gr,BufferInfo:yr,BufferViewInfo:Sr,DrawInfo:xr,DispatchInfo:Er,IndirectBuffer:Tr,TextureInfo:Cr,TextureViewInfo:Ar,SamplerInfo:br,Uniform:wr,UniformBlock:Ir,UniformSamplerTexture:Pr,UniformSampler:Rr,UniformTexture:Or,UniformStorageImage:Dr,UniformStorageBuffer:Nr,UniformInputAttachment:Mr,ShaderStage:Lr,Attribute:Br,ShaderInfo:Fr,InputAssemblerInfo:zr,ColorAttachment:Ur,DepthStencilAttachment:Gr,SubpassInfo:kr,SubpassDependency:Hr,RenderPassInfo:Vr,GeneralBarrierInfo:Wr,TextureBarrierInfo:jr,FramebufferInfo:Xr,DescriptorSetLayoutBinding:qr,DescriptorSetLayoutInfo:Yr,DescriptorSetInfo:Kr,PipelineLayoutInfo:Qr,InputState:Zr,CommandBufferInfo:Jr,QueueInfo:$r,QueryPoolInfo:eo,FormatInfo:to,MemoryStatus:no,DynamicStencilStates:io,DynamicStates:ro,GFXObject:oo,get AttributeName(){return ir},FormatInfos:ao,DESCRIPTOR_BUFFER_TYPE:so,DESCRIPTOR_SAMPLER_TYPE:co,DESCRIPTOR_DYNAMIC_TYPE:lo,DRAW_INFO_SIZE:uo,IsPowerOf2:ho,FormatSize:_o,FormatSurfaceSize:fo,GetTypeSize:mo,getTypedArrayConstructor:vo,Device:xo,Swapchain:Eo,Framebuffer:To,InputAssembler:wo,DescriptorSetLayout:Po,PipelineLayout:Ro,RasterizerState:Oo,DepthStencilState:Do,BlendTarget:No,BlendState:Mo,PipelineStateInfo:Lo,PipelineState:Bo,Queue:Fo,RenderPass:zo,Sampler:Uo,Shader:Go,Texture:ko,GeneralBarrier:Ho,TextureBarrier:Vo}));var Yo=new Nn,Ko=new Nn,Qo=new Nn,Zo=new Nn,Jo=new Nn,$o=new Nn,ea=new Array(3),ta=new Array(3);function na(e,t){return Nn.dot(t.n,e)-t.d}function ia(e,t,n){return Nn.copy(e,t),Nn.subtract(Jo,n.center,n.halfExtents),Nn.add($o,n.center,n.halfExtents),e.x=e.x<Jo.x?Jo.x:e.x,e.y=e.y<Jo.y?Jo.y:e.y,e.z=e.z<Jo.z?Jo.z:e.z,e.x=e.x>$o.x?$o.x:e.x,e.y=e.y>$o.y?$o.y:e.y,e.z=e.z>$o.z?$o.z:e.z,e}function ra(e,t,n){Nn.set(Yo,n.orientation.m00,n.orientation.m01,n.orientation.m02),Nn.set(Ko,n.orientation.m03,n.orientation.m04,n.orientation.m05),Nn.set(Qo,n.orientation.m06,n.orientation.m07,n.orientation.m08),ea[0]=Yo,ea[1]=Ko,ea[2]=Qo,ta[0]=n.halfExtents.x,ta[1]=n.halfExtents.y,ta[2]=n.halfExtents.z,Nn.subtract(Zo,t,n.center),Nn.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=Nn.dot(Zo,ea[i]);r>ta[i]&&(r=ta[i]),r<-ta[i]&&(r=-ta[i]),e.x+=r*ea[i].x,e.y+=r*ea[i].y,e.z+=r*ea[i].z}return e}var oa=Object.freeze({__proto__:null,point_plane:na,pt_point_plane:function(e,t,n){var i=na(t,n);return Nn.subtract(e,t,Nn.multiplyScalar(e,n.n,i))},pt_point_aabb:ia,pt_point_obb:ra,pt_point_line:function(e,t,n,i){Nn.subtract(Yo,n,i);var r=Yo,o=Nn.lengthSqr(r);if(0==o)Nn.copy(e,n);else{Nn.subtract(Yo,t,n);var a=Nn.dot(Yo,r)/o;a<0?Nn.copy(e,n):a>1?Nn.copy(e,i):Nn.scaleAndAdd(e,n,r,a)}}}),aa={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},sa=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=aa.SHAPE_LINE,this.s=new Nn(e,t,n),this.e=new Nn(i,r,o)}return e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return Nn.copy(e.s,t.s),Nn.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return Nn.copy(e.s,t),Nn.copy(e.e,n),e},e.set=function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e},e.len=function(e){return Nn.distance(e.s,e.e)},e.prototype.length=function(){return Nn.distance(this.s,this.e)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),ca=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=aa.SHAPE_RAY,this.o=new Nn(e,t,n),this.d=new Nn(i,r,o)}return e.create=function(t,n,i,r,o,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return Nn.copy(e.o,t.o),Nn.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return Nn.copy(e.o,t),Nn.normalize(e.d,Nn.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e},e.prototype.computeHit=function(e,t){Nn.normalize(e,this.d),Nn.scaleAndAdd(e,this.o,e,t)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),la=new Nn,ua=new Nn,ha=new Nn,_a=new Nn;function fa(e){return Math.max(Math.max(e.x,e.y),e.z)}var da,pa=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new Nn(0,0,0),this._radius=0,this._type=void 0,this._type=aa.SHAPE_SPHERE,this._center=new Nn(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return Nn.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return Nn.multiplyScalar(e.center,Nn.add(la,t,n),.5),e.radius=.5*Nn.subtract(la,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){Nn.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Nn.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){Nn.transformMat4(r.center,this.center,e),r.radius=this.radius*fa(i)},t.translateAndRotate=function(e,t,n){Nn.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*fa(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),Nn.subtract(ua,e,this.center);var t=ua.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,Nn.multiplyScalar(ua,ua,n/t),Nn.add(this.center,this.center,ua)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(ha,_a),this.mergePoint(ha),this.mergePoint(_a)},J(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),ma=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=aa.SHAPE_TRIANGLE,this.a=new Nn(e,t,n),this.b=new Nn(i,r,o),this.c=new Nn(a,s,c)}return e.create=function(t,n,i,r,o,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,o,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return Nn.copy(e.a,t.a),Nn.copy(e.b,t.b),Nn.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return Nn.copy(e.a,t),Nn.copy(e.b,n),Nn.copy(e.c,i),e},e.set=function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},J(e,[{key:"type",get:function(){return this._type}}]),e}();!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(da||(da={}));var va,ga,ya,Sa,xa,Ea,Ta,Ca,Aa=(va=new Nn(0,0,0),function(e,t){var n=Nn.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;Nn.multiplyScalar(va,t.n,t.d);var i=Nn.dot(Nn.subtract(va,va,e.o),t.n)/n;return i<0?0:i}),ba=(ga=new Nn(0,0,0),ya=new Nn(0,0,0),Sa=new Nn(0,0,0),xa=new Nn(0,0,0),Ea=new Nn(0,0,0),function(e,t,n){Nn.subtract(ga,t.b,t.a),Nn.subtract(ya,t.c,t.a),Nn.cross(Sa,e.d,ya);var i=Nn.dot(ga,Sa);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;Nn.subtract(xa,e.o,t.a);var o=Nn.dot(xa,Sa)*r;if(o<0||o>1)return 0;Nn.cross(Ea,xa,ga);var a=Nn.dot(e.d,Ea)*r;if(a<0||o+a>1)return 0;var s=Nn.dot(ya,Ea)*r;return s<0?0:s}),wa=function(){var e=new Nn(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,s=i*i;Nn.subtract(e,r,o);var c=e.lengthSqr(),l=Nn.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),Ia=(Ta=new Nn,Ca=new Nn,function(e,t){return Nn.subtract(Ta,t.center,t.halfExtents),Nn.add(Ca,t.center,t.halfExtents),Pa(e,Ta,Ca)});function Pa(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,h=(n.y-i.y)*a,_=(t.z-i.z)*s,f=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),p=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return p<0||d>p?0:d>0?d:p}var Ra,Oa,Da,Na,Ma=function(){var e=new Nn,t=new Nn,n=new Nn,i=new Nn,r=new Nn,o=new Nn,a=new Nn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,Nn.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),Nn.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),Nn.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),Nn.subtract(a,e,t),c[0]=Nn.dot(i,n),c[1]=Nn.dot(r,n),c[2]=Nn.dot(o,n),l[0]=Nn.dot(i,a),l[1]=Nn.dot(r,a),l[2]=Nn.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||d>p?0:d>0?d:p}}(),La=function(){var e=new Nn,t=new Nn,n=new Nn,i=new Nn,r=new Nn,o=new Nn,a=new Nn,s=new pa;return function(c,l){var u=l.radius*l.radius,h=Nn.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,d=Nn.subtract(t,f,_);if(d.equals(Nn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),ys.raySphere(c,s);var p=c.o,m=Nn.subtract(n,p,_),v=Nn.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=Nn.subtract(r,f,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ys.raySphere(c,s)}var S=Nn.cross(r,m,d),x=d.lengthSqr(),E=2*Nn.dot(v,S),T=E*E-4*g*(S.lengthSqr()-u*x);if(T<0)return 0;var C=(-E-Math.sqrt(T))/(2*g);if(C<0){s.radius=l.radius;var A=Nn.subtract(o,f,p);return m.lengthSqr()<A.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ys.raySphere(c,s)}var b=Nn.scaleAndAdd(o,c.o,h,C),w=Nn.subtract(a,b,_),I=Nn.dot(w,d)/x;return I>=0&&I<=1?C:I<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),ys.raySphere(c,s)):I>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),ys.raySphere(c,s)):0}}(),Ba=(Ra=ma.create(),Oa={distance:1/0,doubleSided:!1,mode:da.ANY},Da=0,Na=function(e,t,n,i,r,o){e===da.CLOSEST?(Da>t||0===Da)&&(Da=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(Da=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(Da=0,0===t.geometricInfo.positions.length)return Da;var i=void 0===n?Oa:n;if(Pa(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,o=t.geometricInfo;!function(e,t,n,i,r){if(n===Vi.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];Nn.set(Ra.a,e[s],e[s+1],e[s+2]),Nn.set(Ra.b,e[c],e[c+1],e[c+2]),Nn.set(Ra.c,e[l],e[l+1],e[l+2]);var u=ys.rayTriangle(i,Ra,r.doubleSided);if(!(0===u||u>r.distance)&&(Na(r.mode,u,s,c,l,r.result),r.mode===da.ANY))return u}else if(n===Vi.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var d=3*t[f-_],p=3*t[f+_+1],m=3*t[f+2];Nn.set(Ra.a,e[d],e[d+1],e[d+2]),Nn.set(Ra.b,e[p],e[p+1],e[p+2]),Nn.set(Ra.c,e[m],e[m+1],e[m+2]),_=~_;var v=ys.rayTriangle(i,Ra,r.doubleSided);if(!(0===v||v>r.distance)&&(Na(r.mode,v,d,p,m,r.result),r.mode===da.ANY))return v}else if(n===Vi.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];Nn.set(Ra.a,e[y],e[y+1],e[y+2]);for(var S=1;S<g;S+=1){var x=3*t[S],E=3*t[S+1];Nn.set(Ra.b,e[x],e[x+1],e[x+2]),Nn.set(Ra.c,e[E],e[E+1],e[E+2]);var T=ys.rayTriangle(i,Ra,r.doubleSided);if(!(0===T||T>r.distance)&&(Na(r.mode,T,y,x,E,r.result),r.mode===da.ANY))return T}}}(o.positions,o.indices,r,e,i)}return Da}),Fa=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:da.ANY};return function(n,i,r){e=0;var o=void 0===r?t:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!Pa(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=Ba(n,u,o);if(h)if(o.mode===da.CLOSEST)(0===e||e>h)&&(e=h,o.subIndices&&(o.subIndices[0]=l));else if(e=h,o.subIndices&&o.subIndices.push(l),o.mode===da.ANY)return h}return e&&o.mode===da.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),za=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:da.ANY},n=new ca,i=new Yn;return function(r,o,a){e=0;var s=void 0===a?t:a,c=o.worldBounds;if(c&&!Ia(r,c))return e;ca.copy(n,r),o.node&&(Yn.invert(i,o.node.getWorldMatrix(i)),Nn.transformMat4(n.o,r.o,i),Nn.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=Ba(n,h,s);if(_)if(s.mode===da.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===da.ANY)return _}return e&&s.mode===da.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),Ua=function(){var e=new Nn(0,0,0);return function(t,n){Nn.subtract(e,t.e,t.s);var i=(n.d-Nn.dot(t.s,n.n))/Nn.dot(e,n.n);return i<0||i>1?0:i}}(),Ga=function(){var e=new Nn(0,0,0),t=new Nn(0,0,0),n=new Nn(0,0,0),i=new Nn(0,0,0),r=new Nn(0,0,0),o=new Nn(0,0,0);return function(a,s,c){Nn.subtract(e,s.b,s.a),Nn.subtract(t,s.c,s.a),Nn.subtract(n,a.s,a.e),Nn.cross(r,e,t);var l=Nn.dot(n,r);if(l<=0)return 0;Nn.subtract(i,a.s,s.a);var u=Nn.dot(i,r);if(u<0||u>l)return 0;Nn.cross(o,n,i);var h=Nn.dot(t,o);if(h<0||h>l)return 0;var _=-Nn.dot(e,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,d=1-(h*=f)-(_*=f);Nn.set(c,s.a.x*d+s.b.x*h+s.c.x*_,s.a.y*d+s.b.y*h+s.c.y*_,s.a.z*d+s.b.z*h+s.c.z*_)}return 1}}(),ka=new ca;function Ha(e,t){ka.o.set(e.s),Nn.subtract(ka.d,e.e,e.s),ka.d.normalize();var n=Ia(ka,t);return n<=e.length()?n:0}function Va(e,t){ka.o.set(e.s),Nn.subtract(ka.d,e.e,e.s),ka.d.normalize();var n=Ma(ka,t);return n<=e.length()?n:0}function Wa(e,t){ka.o.set(e.s),Nn.subtract(ka.d,e.e,e.s),ka.d.normalize();var n=wa(ka,t);return n<=e.length()?n:0}var ja,Xa,qa,Ya,Ka=(ja=new Nn,Xa=new Nn,qa=new Nn,Ya=new Nn,function(e,t){return Nn.subtract(ja,e.center,e.halfExtents),Nn.add(Xa,e.center,e.halfExtents),Nn.subtract(qa,t.center,t.halfExtents),Nn.add(Ya,t.center,t.halfExtents),ja.x<=Ya.x&&Xa.x>=qa.x&&ja.y<=Ya.y&&Xa.y>=qa.y&&ja.z<=Ya.z&&Xa.z>=qa.z});function Qa(e,t,n,i,r,o){Nn.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),Nn.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),Nn.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),Nn.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),Nn.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),Nn.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),Nn.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),Nn.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function Za(e,t){for(var n=Nn.dot(t,e[0]),i=n,r=1;r<8;++r){var o=Nn.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Ja,$a,es,ts=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Nn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Nn(0,0,0),i[r]=new Nn(0,0,0);var o=new Nn,a=new Nn;return function(t,r){Nn.set(e[0],1,0,0),Nn.set(e[1],0,1,0),Nn.set(e[2],0,0,1),Nn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Nn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Nn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)Nn.cross(e[6+3*s],e[s],e[3]),Nn.cross(e[7+3*s],e[s],e[4]),Nn.cross(e[7+3*s],e[s],e[5]);Nn.subtract(o,t.center,t.halfExtents),Nn.add(a,t.center,t.halfExtents),function(e,t,n){Nn.set(n[0],e.x,t.y,t.z),Nn.set(n[1],e.x,t.y,e.z),Nn.set(n[2],e.x,e.y,t.z),Nn.set(n[3],e.x,e.y,e.z),Nn.set(n[4],t.x,t.y,t.z),Nn.set(n[5],t.x,t.y,e.z),Nn.set(n[6],t.x,e.y,t.z),Nn.set(n[7],t.x,e.y,e.z)}(o,a,n),Qa(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Za(n,e[c]),u=Za(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),ns=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=Nn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},is=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===ns(e,t.planes[n]))return 0;return 1},rs=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new Nn(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=ns(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)Nn.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),os=(Ja=new Nn(0,0,0),$a=new Fn,function(e,t){return Nn.subtract(Ja,t,e.center),Nn.transformMat3(Ja,Ja,Fn.transpose($a,e.orientation)),n=Ja,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),as=(es=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*es(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*es(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*es(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=Nn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),ss=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===as(e,t.planes[n]))return 0;return 1},cs=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new Nn(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=as(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)Nn.subtract(e[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=o(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),ls=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Nn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Nn(0,0,0),i[r]=new Nn(0,0,0);return function(t,r){Nn.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),Nn.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),Nn.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),Nn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Nn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Nn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)Nn.cross(e[6+3*o],e[o],e[3]),Nn.cross(e[7+3*o],e[o],e[4]),Nn.cross(e[8+3*o],e[o],e[5]);Qa(t.center,t.halfExtents,e[0],e[1],e[2],n),Qa(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=Za(n,e[a]),c=Za(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),us=function(){for(var e=new pa,t=new Nn,n=new Nn,i=new Nn,r=new Array(8),o=0;o<8;o++)r[o]=new Nn;for(var a=new Array(8),s=0;s<8;s++)a[s]=new Nn;return function(o,s){if(0===Nn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),ys.sphereOBB(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Qa(o.center,o.halfExtents,t,n,i,r);var c=a,l=Nn.copy(c[0],t),u=Nn.copy(c[1],n),h=Nn.copy(c[2],i);Nn.subtract(c[3],s.center,o.center).normalize();var _=Nn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),Nn.cross(c[5],l,_),Nn.cross(c[6],u,_),Nn.cross(c[7],h,_);for(var f=0;f<8;++f){var d=Za(r,c[f]),p=Nn.dot(c[f],s.ellipseCenter0),m=Nn.dot(c[f],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),hs=function(e,t){var n=Nn.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},_s=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===hs(e,t.planes[n]))return 0;return 1},fs=function(){var e=new Nn(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=Nn.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){Nn.add(e,s,Nn.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=i.planes[h];if(Nn.dot(_.n,e)<_.d)return 0}}}return 1}}(),ds=function(e,t){var n=e.radius+t.radius;return Nn.squaredDistance(e.center,t.center)<n*n},ps=function(){var e=new Nn;return function(t,n){return ia(e,t.center,n),Nn.squaredDistance(t.center,e)<t.radius*t.radius}}(),ms=function(){var e=new Nn;return function(t,n){return ra(e,t.center,n),Nn.squaredDistance(t.center,e)<t.radius*t.radius}}(),vs=function(){var e=new Nn,t=new Nn;return function(n,i){var r=n.radius+i.radius,o=r*r,a=Nn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return Nn.squaredDistance(n.center,i.center)<o;Nn.subtract(e,n.center,i.ellipseCenter0),Nn.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=Nn.dot(e,t)/a;return s<0?Nn.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?Nn.squaredDistance(n.center,i.ellipseCenter1)<o:(Nn.scaleAndAdd(e,i.ellipseCenter0,t,s),Nn.squaredDistance(n.center,e)<o)}}(),gs=function(){var e=new Nn,t=new Nn,n=new Nn,i=new Nn,r=new Nn,o=new Nn;return function(a,s){var c,l,u=Nn.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=Nn.subtract(t,s.ellipseCenter1,s.ellipseCenter0),_=Nn.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=Nn.dot(u,u),d=Nn.dot(u,h),p=Nn.dot(h,h),m=Nn.dot(u,_),v=Nn.dot(h,_),g=f*p-d*d,y=g,S=g;g<ln?(c=0,y=1,l=v,S=p):(l=f*v-d*m,(c=d*v-p*m)<0?(c=0,l=v,S=p):c>y&&(c=y,l=v+d,S=p)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>S&&(l=S,-m+d<0?c=0:-m+d>f?c=y:(c=-m+d,y=f));var x=Math.abs(c)<ln?0:c/y,E=Math.abs(l)<ln?0:l/S,T=i;T.set(_),T.add(Nn.multiplyScalar(r,u,x)),T.subtract(Nn.multiplyScalar(o,h,E));var C=a.radius+s.radius;return T.lengthSqr()<C*C}}(),ys={raySphere:wa,rayAABB:Ia,rayOBB:Ma,rayPlane:Aa,rayTriangle:ba,rayCapsule:La,raySubMesh:Ba,rayMesh:Fa,rayModel:za,lineSphere:Wa,lineAABB:Ha,lineOBB:Va,linePlane:Ua,lineTriangle:Ga,sphereWithSphere:ds,sphereAABB:ps,sphereOBB:ms,spherePlane:hs,sphereFrustum:_s,sphereFrustumAccurate:fs,sphereCapsule:vs,aabbWithAABB:Ka,aabbWithOBB:ts,aabbPlane:ns,aabbFrustum:is,aabbFrustumAccurate:rs,obbWithOBB:ls,obbPlane:as,obbFrustum:ss,obbFrustumAccurate:cs,obbPoint:os,obbCapsule:us,capsuleWithCapsule:gs,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}};ys[aa.SHAPE_RAY|aa.SHAPE_SPHERE]=wa,ys[aa.SHAPE_RAY|aa.SHAPE_AABB]=Ia,ys[aa.SHAPE_RAY|aa.SHAPE_OBB]=Ma,ys[aa.SHAPE_RAY|aa.SHAPE_PLANE]=Aa,ys[aa.SHAPE_RAY|aa.SHAPE_TRIANGLE]=ba,ys[aa.SHAPE_RAY|aa.SHAPE_CAPSULE]=La,ys[aa.SHAPE_LINE|aa.SHAPE_SPHERE]=Wa,ys[aa.SHAPE_LINE|aa.SHAPE_AABB]=Ha,ys[aa.SHAPE_LINE|aa.SHAPE_OBB]=Va,ys[aa.SHAPE_LINE|aa.SHAPE_PLANE]=Ua,ys[aa.SHAPE_LINE|aa.SHAPE_TRIANGLE]=Ga,ys[aa.SHAPE_SPHERE]=ds,ys[aa.SHAPE_SPHERE|aa.SHAPE_AABB]=ps,ys[aa.SHAPE_SPHERE|aa.SHAPE_OBB]=ms,ys[aa.SHAPE_SPHERE|aa.SHAPE_PLANE]=hs,ys[aa.SHAPE_SPHERE|aa.SHAPE_FRUSTUM]=_s,ys[aa.SHAPE_SPHERE|aa.SHAPE_FRUSTUM_ACCURATE]=fs,ys[aa.SHAPE_SPHERE|aa.SHAPE_CAPSULE]=vs,ys[aa.SHAPE_AABB]=Ka,ys[aa.SHAPE_AABB|aa.SHAPE_OBB]=ts,ys[aa.SHAPE_AABB|aa.SHAPE_PLANE]=ns,ys[aa.SHAPE_AABB|aa.SHAPE_FRUSTUM]=is,ys[aa.SHAPE_AABB|aa.SHAPE_FRUSTUM_ACCURATE]=rs,ys[aa.SHAPE_OBB]=ls,ys[aa.SHAPE_OBB|aa.SHAPE_PLANE]=as,ys[aa.SHAPE_OBB|aa.SHAPE_FRUSTUM]=ss,ys[aa.SHAPE_OBB|aa.SHAPE_FRUSTUM_ACCURATE]=cs,ys[aa.SHAPE_OBB|aa.SHAPE_CAPSULE]=us,ys[aa.SHAPE_CAPSULE]=gs,k(sa.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),H(ys,"intersect",[{name:"line_quad"}]);var Ss,xs,Es,Ts,Cs,As,bs,ws=new Nn(0,0,0),Is=new Nn(0,0,0),Ps=h.mat4(),Rs=h.v4(),Os=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=aa.SHAPE_PLANE,this.n=new Nn(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return Nn.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return Nn.subtract(ws,n,t),Nn.subtract(Is,i,t),Nn.normalize(e.n,Nn.cross(e.n,ws,Is)),e.d=Nn.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return Nn.copy(e.n,t),e.d=Nn.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return Nn.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){Yn.invert(Ps,e),Yn.transpose(Ps,Ps),ni.set(Rs,this.n.x,this.n.y,this.n.z,this.d),ni.transformMat4(Rs,Rs,Ps),Nn.set(this.n,Rs.x,Rs.y,Rs.z),this.d=Rs.w},J(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),Ds=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(bs||(bs={}));var Ns,Ms,Ls=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Ds(e,r,this._stride);var o=bs.NEVER,a=!1,s=!1;for(var c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==bs.FLOAT32?s||o!==bs.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,o=(this._dataType[t]===bs.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[t];return o.subarray(r,r+a)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(Ns||(Ns={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(Ms||(Ms={}));var Bs,Fs=((Ss={})[Ms.DIRTY_FLAG]=bs.UINT32,Ss[Ms.LAYER]=bs.UINT32,Ss[Ms.WORLD_SCALE]=bs.FLOAT32,Ss[Ms.WORLD_POSITION]=bs.FLOAT32,Ss[Ms.WORLD_ROTATION]=bs.FLOAT32,Ss[Ms.WORLD_MATRIX]=bs.FLOAT32,Ss[Ms.LOCAL_SCALE]=bs.FLOAT32,Ss[Ms.LOCAL_POSITION]=bs.FLOAT32,Ss[Ms.LOCAL_ROTATION]=bs.FLOAT32,Ss[Ms.COUNT]=bs.NEVER,Ss),zs=((xs={})[Ms.DIRTY_FLAG]=Ms.LAYER-Ms.DIRTY_FLAG,xs[Ms.LAYER]=Ms.WORLD_SCALE-Ms.LAYER,xs[Ms.WORLD_SCALE]=Ms.WORLD_POSITION-Ms.WORLD_SCALE,xs[Ms.WORLD_POSITION]=Ms.WORLD_ROTATION-Ms.WORLD_POSITION,xs[Ms.WORLD_ROTATION]=Ms.WORLD_MATRIX-Ms.WORLD_ROTATION,xs[Ms.WORLD_MATRIX]=Ms.LOCAL_SCALE-Ms.WORLD_MATRIX,xs[Ms.LOCAL_SCALE]=Ms.LOCAL_POSITION-Ms.LOCAL_SCALE,xs[Ms.LOCAL_POSITION]=Ms.LOCAL_ROTATION-Ms.LOCAL_POSITION,xs[Ms.LOCAL_ROTATION]=Ms.COUNT-Ms.LOCAL_ROTATION,xs[Ms.COUNT]=1,xs),Us=new Ls(Ns.NODE,Fs,zs,Ms);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(Bs||(Bs={}));var Gs,ks=((Es={})[Bs.PRIORITY]=bs.UINT32,Es[Bs.STAGE]=bs.UINT32,Es[Bs.PHASE]=bs.UINT32,Es[Bs.PRIMITIVE]=bs.UINT32,Es[Bs.BATCHING_SCHEME]=bs.UINT32,Es[Bs.DYNAMIC_STATE]=bs.UINT32,Es[Bs.HASH]=bs.UINT32,Es[Bs.COUNT]=bs.NEVER,Es),Hs=((Ts={})[Bs.PRIORITY]=Bs.STAGE-Bs.PRIORITY,Ts[Bs.STAGE]=Bs.PHASE-Bs.STAGE,Ts[Bs.PHASE]=Bs.PRIMITIVE-Bs.PHASE,Ts[Bs.PRIMITIVE]=Bs.BATCHING_SCHEME-Bs.PRIMITIVE,Ts[Bs.BATCHING_SCHEME]=Bs.DYNAMIC_STATE-Bs.BATCHING_SCHEME,Ts[Bs.DYNAMIC_STATE]=Bs.HASH-Bs.DYNAMIC_STATE,Ts[Bs.HASH]=Bs.COUNT-Bs.HASH,Ts[Bs.COUNT]=1,Ts),Vs=new Ls(Ns.PASS,ks,Hs,Bs);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(Gs||(Gs={}));var Ws=((Cs={})[Gs.CENTER]=bs.FLOAT32,Cs[Gs.HALFEXTENTS]=bs.FLOAT32,Cs[Gs.COUNT]=bs.NEVER,Cs),js=((As={})[Gs.CENTER]=Gs.HALFEXTENTS-Gs.CENTER,As[Gs.HALFEXTENTS]=Gs.COUNT-Gs.HALFEXTENTS,As[Gs.COUNT]=1,As),Xs=new Ls(Ns.AABB,Ws,js,Gs),qs=new Nn,Ys=new Nn,Ks=new Nn,Qs=new Nn,Zs=new Fn,Js=function(e,t,n){Zs.m00=Math.abs(n.m00),Zs.m01=Math.abs(n.m01),Zs.m02=Math.abs(n.m02),Zs.m03=Math.abs(n.m04),Zs.m04=Math.abs(n.m05),Zs.m05=Math.abs(n.m06),Zs.m06=Math.abs(n.m08),Zs.m07=Math.abs(n.m09),Zs.m08=Math.abs(n.m10),Nn.transformMat3(e,t,Zs)},$s=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=aa.SHAPE_AABB,this.center=new Nn(e,t,n),this.halfExtents=new Nn(i,r,o)}e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return Nn.copy(e.center,t.center),Nn.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return Nn.add(qs,n,t),Nn.subtract(Ys,n,t),Nn.multiplyScalar(e.center,qs,.5),Nn.multiplyScalar(e.halfExtents,Ys,.5),e},e.set=function(e,t,n,i,r,o,a){return e.center.set(t,n,i),e.halfExtents.set(r,o,a),e},e.merge=function(t,n,i){return Nn.subtract(qs,n.center,n.halfExtents),Nn.subtract(Ys,i.center,i.halfExtents),Nn.add(Ks,n.center,n.halfExtents),Nn.add(Qs,i.center,i.halfExtents),Nn.max(Qs,Ks,Qs),Nn.min(Ks,qs,Ys),e.fromPoints(t,Ks,Qs)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return Nn.transformMat4(e.center,t.center,n),Js(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){Nn.subtract(e,this.center,this.halfExtents),Nn.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){Nn.transformMat4(r.center,this.center,e),Js(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(qs,Ys),e.x<qs.x&&(qs.x=e.x),e.y<qs.y&&(qs.y=e.y),e.z<qs.z&&(qs.z=e.z),e.x>Ys.x&&(Ys.x=e.x),e.y>Ys.y&&(Ys.y=e.y),e.z>Ys.z&&(Ys.z=e.z),Nn.add(Ks,qs,Ys),this.center.set(Nn.multiplyScalar(Ks,Ks,.5)),this.halfExtents.set(Ys.x-Ks.x,Ys.y-Ks.y,Ys.z-Ks.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},J(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),ec=new Nn,tc=new Nn,nc=new Fn,ic=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=aa.SHAPE_OBB,this.center=new Nn(e,t,n),this.halfExtents=new Nn(i,r,o),this.orientation=new Fn(a,s,c,l,u,h,_,f,d)}e.create=function(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new e(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return Nn.copy(e.center,t.center),Nn.copy(e.halfExtents,t.halfExtents),Fn.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return Nn.multiplyScalar(e.center,Nn.add(ec,t,n),.5),Nn.multiplyScalar(e.halfExtents,Nn.subtract(tc,n,t),.5),Fn.identity(e.orientation),e},e.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return Nn.set(e.center,t,n,i),Nn.set(e.halfExtents,r,o,a),Fn.set(e.orientation,s,c,l,u,h,_,f,d,p),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){nc.m00=Math.abs(n.m00),nc.m01=Math.abs(n.m01),nc.m02=Math.abs(n.m02),nc.m03=Math.abs(n.m03),nc.m04=Math.abs(n.m04),nc.m05=Math.abs(n.m05),nc.m06=Math.abs(n.m06),nc.m07=Math.abs(n.m07),nc.m08=Math.abs(n.m08),Nn.transformMat3(e,t,nc)}(ec,this.halfExtents,this.orientation),Nn.subtract(e,this.center,ec),Nn.add(t,this.center,ec)},t.transform=function(e,t,n,i,r){Nn.transformMat4(r.center,this.center,e),Fn.fromQuat(r.orientation,n),Nn.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){Nn.transformMat4(n.center,this.center,e),Fn.fromQuat(n.orientation,t)},t.setScale=function(e,t){Nn.multiply(t.halfExtents,this.halfExtents,e)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),rc=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=aa.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new Nn,this.rotation=new Gn,this.ellipseCenter0=new Nn(0,t,0),this.ellipseCenter1=new Nn(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var o=i,a=wn(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,Nn.transformMat4(r.center,this.center,e),Gn.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),Nn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Nn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},J(e,[{key:"type",get:function(){return this._type}}]),e}(),oc=new Array(8);oc[0]=new Nn(1,1,1),oc[1]=new Nn(-1,1,1),oc[2]=new Nn(-1,-1,1),oc[3]=new Nn(1,-1,1),oc[4]=new Nn(1,1,-1),oc[5]=new Nn(-1,1,-1),oc[6]=new Nn(-1,-1,-1),oc[7]=new Nn(1,-1,-1);var ac,sc,cc=new Nn,lc=new Nn,uc=new Nn,hc=function(){function e(){this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=aa.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=Os.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Nn}e.createFromAABB=function(e,t){var n=new Nn,i=new Nn;return Nn.subtract(n,t.center,t.halfExtents),Nn.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==aa.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var o=Math.tan(.5*t.fov),a=o*t.aspect;cc.set(i*a,i*o,i),lc.set(r*a,r*o,r);var s=e.vertices;return uc.set(cc.x,cc.y,cc.z),Nn.transformMat4(s[0],uc,n),uc.set(-cc.x,cc.y,cc.z),Nn.transformMat4(s[1],uc,n),uc.set(-cc.x,-cc.y,cc.z),Nn.transformMat4(s[2],uc,n),uc.set(cc.x,-cc.y,cc.z),Nn.transformMat4(s[3],uc,n),uc.set(lc.x,lc.y,lc.z),Nn.transformMat4(s[4],uc,n),uc.set(-lc.x,lc.y,lc.z),Nn.transformMat4(s[5],uc,n),uc.set(-lc.x,-lc.y,lc.z),Nn.transformMat4(s[6],uc,n),uc.set(lc.x,-lc.y,lc.z),Nn.transformMat4(s[7],uc,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)Os.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)Nn.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(Nn.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Nn.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Nn.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Nn.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Nn.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Nn.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===aa.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();Nn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)Nn.transformMat4(this.vertices[o],oc[o],t)}},t.transform=function(e){if(this._type===aa.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Nn.transformMat4(this.vertices[t],this.vertices[t],e);this.updatePlanes()}},t.updatePlanes=function(){Os.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Os.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Os.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Os.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Os.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Os.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},J(e,[{key:"accurate",set:function(e){this._type=e?aa.SHAPE_FRUSTUM_ACCURATE:aa.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();hc.createOrtho=function(e,t,n,i,r,o){var a=t/2,s=n/2;Nn.set(uc,a,s,-i),Nn.transformMat4(e.vertices[0],uc,o),Nn.set(uc,-a,s,-i),Nn.transformMat4(e.vertices[1],uc,o),Nn.set(uc,-a,-s,-i),Nn.transformMat4(e.vertices[2],uc,o),Nn.set(uc,a,-s,-i),Nn.transformMat4(e.vertices[3],uc,o),Nn.set(uc,a,s,-r),Nn.transformMat4(e.vertices[4],uc,o),Nn.set(uc,-a,s,-r),Nn.transformMat4(e.vertices[5],uc,o),Nn.set(uc,-a,-s,-r),Nn.transformMat4(e.vertices[6],uc,o),Nn.set(uc,a,-s,-r),Nn.transformMat4(e.vertices[7],uc,o),Os.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Os.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Os.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Os.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Os.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Os.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(ac||(ac={})),function(e){e[e.Default=ac.Default]="Default",e[e.Normal=ac.Normal]="Normal",e[e.Reverse=ac.Reverse]="Reverse",e[e.Loop=ac.Loop]="Loop",e[e.LoopReverse=ac.Loop|ac.Reverse]="LoopReverse",e[e.PingPong=ac.PingPong]="PingPong",e[e.PingPongReverse=ac.PingPong|ac.Reverse]="PingPongReverse"}(sc||(sc={})),ht(sc);var _c,fc=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function dc(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=e[o];if(a>t+n)r=o-1;else{if(!(a<t-n))return o;i=o+1}}return~i}_c=Symbol.iterator;var pc,mc,vc,gc=function(){function e(){this._times=[],this._values=[]}var t=e.prototype;return t[_c]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return dc(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return dc(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||hn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,o=dc(n,e);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(e),i.unshift(t)):a===r?(n.push(e),i.push(t)):(n.splice(a-1,0,e),i.splice(a-1,0,t)),a},J(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}();function yc(e){return e>-1e-9&&e<1e-9}nn.fastDefine("cc.KeyframeCurve",gc,{_times:[],_values:[]}),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(pc||(pc=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(mc||(mc=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(vc||(vc=e("TangentWeightMode",{})));var Sc=function(){},xc=function(){return Sc},Ec=Tc((function(){}));function Tc(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function Cc(e){return function(t){return function(n){!function(e,t,n){var i=bc(e);if(i){var r=wc(i,"proto");wc(r,"editor")[t]=n}}(n,e,t)}}}var Ac="__ccclassCache__";function bc(e){return wc(e,Ac)}function wc(e,t){return e[t]||(e[t]={})}var Ic=Tc((function(e,t){var n=ot.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[Ac];if(r){var o=r.proto;o&&ot.mixin(i,o),e[Ac]=void 0}return nn(i)})),Pc=Cc("requireComponent"),Rc=Cc("executionOrder"),Oc=Ec;function Dc(e,t,n){var i=null;function r(e,t,n){!function(e,t,n,i,r,o){var a,s=o&&(o.get||o.set);r&&(a=jt(r,s));var c=ot.mixin(t,a||r||{});s?(o.get&&(c.get=o.get),o.set&&(c.set=o.set)):Mc(e,c,n,i,o)}(function(e){return bc(e.constructor)}(e),function(e,t){var n,i,r=wc(bc(e.constructor),"proto"),o=wc(r,"properties");return null!==(i=o[n=t])&&void 0!==i?i:o[n]={}}(e,t),e.constructor,t,i,n)}return void 0===e?Dc({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}function Nc(e,t,n){var i,r,o=bc(e.constructor),a=wc(o,"proto"),s=wc(a,"properties"),c=null!==(r=s[i=t])&&void 0!==r?r:s[i]={};return c.__internalFlags|=Xt.STANDALONE,n&&(n.get||n.set)?(n.get&&(c.get=n.get),n.set&&(c.set=n.set)):Mc(o,c,e.constructor,t,n),c}function Mc(e,t,n,i,r){if(r)r.initializer&&(t.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var o=e.default||(e.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(n));o.hasOwnProperty(i)&&(t.default=o[i])}}var Lc=Symbol("cc:SerializationMetadata"),Bc=function(e,t,n){Uc(Nc(e,t,n))};function Fc(e){return function(t,n,i){var r=Nc(t,n,i);r.formerlySerializedAs=e,Uc(r)}}var zc=function(e,t,n){var i=Nc(e,t,n);i.editorOnly=!0,Uc(i)};function Uc(e){e.__internalFlags|=Xt.IMPLICIT_SERIALIZABLE}var Gc=Sc,kc=Ec,Hc=xc,Vc=Ec,Wc=xc,jc=xc,Xc=xc,qc=Sc,Yc=xc,Kc=Sc,Qc=xc,Zc=xc,Jc=xc,$c=xc,el=xc,tl=xc,nl=Sc,il=xc,rl=Sc,ol=Sc,al=Sc,sl=hl(Lt),cl=hl(Bt),ll=hl(Ft),ul=hl(zt);function hl(e){return Dc({type:e})}var _l,fl=function(e,t,n){Nc(e,t,n).override=!0},dl=e("editorExtrasTag","__editorExtras__"),pl=function(){},ml=Object.freeze({__proto__:null,uniquelyReferenced:Gc,ccclass:Ic,property:Dc,requireComponent:Pc,executionOrder:Rc,disallowMultiple:Oc,allowReplicated:function(e){nn.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:kc,menu:Hc,playOnFocus:Vc,inspector:Wc,icon:jc,help:Xc,type:hl,integer:sl,float:cl,boolean:ll,string:ul});e("_decorator",ml);var vl=1<<22,gl=[],yl=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=gl.length,t=0;t<e;++t){var n=gl[t];1&n._objFlags||n._destroyImmediate()}e===gl.length?gl.length=0:gl.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(D(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,gl.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof h._BaseNode||e instanceof h.Component,r=i?"_id":null,o={};for(n in e)if(e.hasOwnProperty(n)){if(n===r)continue;switch(typeof e[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(nn._isCCClass(t))for(var a=h.Class.Attr.getClassAttrs(t),s=t.__props__,c=0;c<s.length;c++){var l=(n=s[c])+h.Class.Attr.DELIMETER+"default";if(l in a){if(i&&"_id"===n)continue;switch(typeof a[l]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var u="";for(n in o){var _;_=nn.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+nn.escapeForJS(n)+"]=";var f=o[n];""===f&&(f='""'),u+=_+f+";\n"}return Function("o",u)}(this,e),be(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?M(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},J(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&vl)},set:function(e){e?this._objFlags|=vl:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),Sl=yl.prototype;function xl(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}Sl._deserialize=null,Sl._onPreDestroy=null,nn.fastDefine("cc.Object",yl,((_l={_name:"",_objFlags:0})[dl]={},_l)),nn.Attr.setClassAttr(yl,dl,"editorOnly",!0),nn.Attr.setClassAttr(yl,"replicated","visible",!1),be(yl,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),h.isValid=xl,h.Object=yl;var El=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=ot.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=ot.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},J(e,[{key:"count",get:function(){return this._count}}]),e}(),Tl=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(D(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();Tl._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=ot.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},J(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var Cl,Al=new El,bl=new El,wl=new El,Il=new El,Pl=new Tl("normal load",[]),Rl=new Tl("fetch",[]),Ol=new Tl("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(Cl||(Cl={}));var Dl,Nl={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(Dl||(Dl={}));var Ml=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();Ml.MAX_DEAD_NUM=500,Ml._taskId=0,Ml._deadPool=[];var Ll="0123456789abcdef".split(""),Bl=["","","",""],Fl=Bl.concat(Bl,"-",Bl,"-",Bl,"-",Bl,"-",Bl,Bl,Bl),zl=Fl.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Ul(e){var t=e.split("@")[0];if(22!==t.length)return e;Fl[0]=e[0],Fl[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=gt[e.charCodeAt(n)],o=gt[e.charCodeAt(n+1)];Fl[zl[i++]]=Ll[r>>2],Fl[zl[i++]]=Ll[(3&r)<<2|o>>4],Fl[zl[i++]]=Ll[15&o]}return e.replace(t,Fl.join(""))}var Gl=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function kl(e){var t=Gl.exec(e);return t?t[1]:""}function Hl(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.nativeExt&&(t.ext=t.nativeExt);var n=Il.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),jl(e,t)}function Vl(e){return!!e&&(e instanceof h.SceneAsset||e instanceof h.Scene)}function Wl(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function jl(e,t){var n=Ml.create({input:e,options:t}),i=[];try{for(var r,o=ce(Ol.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=ce(n.output);!(c=l()).done;)c.value.recycle();T(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var Xl=Object.freeze({__proto__:null,getUuidFromURL:kl,getUrlWithUuid:Hl,isScene:Vl,normalize:Wl,transform:jl,decodeUuid:Ul}),ql=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,fe(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),Yl=function(){function e(){this._poolHandle=-1,ql.addContainer(this)}return e.prototype.destroy=function(){ql.removeContainer(this)},e}(),Kl=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(t());return r}ee(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&D(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(Yl)),Ql=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=t();return r}ee(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},J(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(Yl)),Zl=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=n,i}ee(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(Yl));e("memop",Object.freeze({__proto__:null,Pool:Kl,RecyclePool:Ql,CachedArray:Zl}));var Jl=rt.fastRemoveAt;function $l(){}var eu=function(){function e(){this.callback=$l,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||$l,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=$l,this.once=!1},t.check=function(){return!(this.target instanceof yl&&!xl(this.target,!0))},e}(),tu=new Kl((function(){return new eu}),32),nu=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),tu.free(n),Jl(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),tu.free(n),Jl(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Jl(this.callbackInfos,e),tu.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),tu.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Jl(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),iu=new Kl((function(){return new nu}),16),ru=function(){function e(){this._callbackTable=Re(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=iu.alloc());var o=tu.alloc();o.set(t,n,i),r.callbackInfos.push(o)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),iu.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===e&&r.cancel(a)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var o=r.callbackInfos;if(t)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===t&&s.target===n){r.cancel(a);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,r,o):_(t,n,i,r,o):this.off(e,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),iu.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function ou(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=Re(!0),t}ee(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=ru.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(t.prototype,o,a)}}return t}var au,su,cu,lu,uu,hu,_u=e("EventTarget",ou((function(){})));h.EventTarget=_u,function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(au||(au={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(su||(su={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(cu||(cu={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(lu||(lu={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(uu||(uu={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(hu||(hu={}));var fu,du,pu,mu,vu=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(t=o.getBattery)||void 0===t||t.call(o).then((function(e){i._battery=e})),i.networkType=cu.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?uu.MOBILE_BROWSER:uu.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:su.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=lu.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=lu.WINDOWS:l?f=lu.IOS:-1!==o.appVersion.indexOf("Mac")?f=lu.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=lu.LINUX:c?f=lu.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=lu.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=au.UNKNOWN;var d=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),p=d?d[0].toLowerCase():lu.UNKNOWN;("safari"===p&&c||"qq"===p&&/android.*applewebkit/i.test(a))&&(p=au.ANDROID);var m={micromessenger:au.WECHAT,wechat:au.WECHAT,weixin:au.WECHAT,trident:au.IE,edge:au.EDGE,"360 aphone":au.BROWSER_360,mxbrowser:au.MAXTHON,"opr/":au.OPERA,ubrowser:au.UC,huaweibrowser:au.HUAWEI};i.browserType=m[p]||p,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var S=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){S=!0,null==e||e.close()})).catch((function(){})));var x=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,E=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[hu.WEBP]=g,n[hu.IMAGE_BITMAP]=S,n[hu.WEB_VIEW]=!0,n[hu.VIDEO_PLAYER]=!0,n[hu.SAFE_AREA]=!1,n[hu.INPUT_TOUCH]=x,n[hu.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[hu.EVENT_MOUSE]=E,n[hu.EVENT_TOUCH]=x||E,n[hu.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}ee(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,o,a){n&&(n=!1,t.emit("show",e,i,r,o,a))};if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(_u)),gu=/(\.[^\.\/\?\\]*)(\?.*)?$/,yu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Su=/[^\.\/]+\/\.\.\//;function xu(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function Eu(e){var t=gu.exec(e);return t?t[1]:""}function Tu(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function Cu(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function Au(e){var t=yu.exec(e);return t?t[2]:""}function bu(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function wu(e,t,n){if(0===t.indexOf("."))return bu(e,t);var i=e.indexOf("?"),r="",o=n?Eu(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function Iu(e){var t=e=String(e);do{t=e,e=e.replace(Su,"")}while(t.length!==e.length);return e}function Pu(e){return e.replace(/[\/\\]$/,"")}function Ru(){return vu.os===lu.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:xu,extname:Eu,mainFileName:Tu,basename:Cu,dirname:Au,changeExtname:bu,changeBasename:wu,_normalize:Iu,stripSep:Pu,getSeperator:Ru}));var Ou,Du,Nu,Mu=e("Asset",Ic("cc.Asset")((mu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,le(t,"_native",pu,ae(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(ae(t),"_uuid",{value:"",writable:!0}),t}ee(t,e),t.deserialize=function(e){return h.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&h.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return A(z(12101,this._uuid)),e.prototype.destroy.call(this)},J(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=Hl(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=Hl(this._uuid,{__nativeName__:e,nativeExt:Eu(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(ou(yl)),pu=ue((du=mu).prototype,"_native",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ue(du.prototype,"_nativeAsset",[Dc],Object.getOwnPropertyDescriptor(du.prototype,"_nativeAsset"),du.prototype),fu=du))||fu);Mu.prototype.createNode=null,h.Asset=Mu;var Lu=e("Script",Ic("cc.Script")(Ou=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(Mu))||Ou);h._Script=Lu;var Bu=e("JavaScript",Ic("cc.JavaScript")(Du=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(Lu))||Du);h._JavaScript=Bu;var Fu,zu,Uu,Gu,ku,Hu,Vu,Wu,ju,Xu,qu,Yu=e("TypeScript",Ic("cc.TypeScript")(Nu=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(Lu))||Nu);h._TypeScript=Yu;var Ku,Qu,Zu,Ju,$u=new ge("Comp"),eh=yl.Flags.IsOnLoadCalled,th=e("Component",(Fu=Ic("cc.Component"),zu=Qc(),Uu=hl(Lu),Gu=Zc(),Fu((qu=Xu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"node",Vu,ae(t)),le(t,"_enabled",Wu,ae(t)),le(t,"__prefab",ju,ae(t)),t._sceneGetter=null,t._id=$u.getNewId(),t}ee(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&h.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),h.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=h.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=h.macro.REPEAT_FOREVER),void 0===i&&(i=0),F(e,1619),F((t=t||0)>=0,1620),n=Number.isNaN(n)?h.macro.REPEAT_FOREVER:n,i=i||0;var r=h.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(e,this,t,n,i,o)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&h.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){h.director.getScheduler().unscheduleAllForTarget(this)},J(t,[{key:"name",get:function(){if(this._name)return this._name;var e=Oe(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=h.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&eh}}]),t}(yl),Xu.system=null,ue((Hu=qu).prototype,"__scriptAsset",[zu,Uu,Gu,al],Object.getOwnPropertyDescriptor(Hu.prototype,"__scriptAsset"),Hu.prototype),Vu=ue(Hu.prototype,"node",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wu=ue(Hu.prototype,"_enabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ju=ue(Hu.prototype,"__prefab",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ku=Hu))||ku)),nh=th.prototype;nh.update=null,nh.lateUpdate=null,nh.__preload=null,nh.onLoad=null,nh.start=null,nh.onEnable=null,nh.onDisable=null,nh.onDestroy=null,nh.onFocusInEditor=null,nh.onLostFocusInEditor=null,nh.resetInEditor=null,nh._getLocalBounds=null,nh.onRestore=null,th._requireComponent=null,th._executionOrder=0,be(th,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),h.Component=th;var ih,rh=e("MissingScript",Ic("cc.MissingScript")(Ku=Wc()((Ju=function(e){function t(){var t;return le(t=e.call(this)||this,"_$erialized",Zu,ae(t)),t}return ee(t,e),t.safeFindClass=function(e){var t=et(e);if(t)return t;h.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){D(4600,this.node.name)},t}(th),Zu=ue((Qu=Ju).prototype,"_$erialized",[Bc,zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ku=Qu))||Ku)||Ku);h._MissingScript=rh;try{var oh=rh.__values__;0!==oh.length&&"_$erialized"===oh[oh.length-1]||(T("The '_$erialized' prop in MissingScript is missing. Please contact jare."),T("    Error props: ['"+oh+"']"))}catch(ta){T("Error when checking MissingScript 5, "+ta)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(ih||(ih={}));var ah,sh={auto:ih.AUTO,landscape:ih.LANDSCAPE,portrait:ih.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(ah||(ah={}));var ch=new(function(e){function t(){var t,n,i,r,o,a;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new oi(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=ih.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)t._fn[s[0][l]]=a[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}ee(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=sh[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===ah.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===ah.Fullscreen?document[this._fn.fullscreenElement]:e===ah.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=vu.isMobile&&(t&&e===ih.PORTRAIT||!t&&e===ih.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void D(9201);var e,t,n=h.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,o=i.clientHeight,a=n.width,s=n.height,c=r/a,l=o/s,u=this._gameContainer.style;c<l?(e=r,t=s*c):(e=a*l,t=o),u.width=e+"px",u.height=t+"px"}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else D(9201)},J(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===ah.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):D(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new oi(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new oi(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(D(9201),new oi(0,0));var e,t,n;switch(this._windowType){case ah.SubFrame:return this._gameFrame?new oi(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(D(9201),new oi(0,0));case ah.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new oi(t,n);case ah.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new oi(t,n);case ah.Unknown:default:return new oi(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?ah.Fullscreen:this._gameFrame?this._exactFitScreen?ah.BrowserWindow:ah.SubFrame:(D(9201),ah.Unknown)}}]),t}(_u)),lh=function(){function e(){}var t=e.prototype;return t._init=function(e){ch.init(e,(function(){var e,t=h.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=ch.resolutionScale:D(1220)}))},t.fullScreen=function(){return ch.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&D(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),ch.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return ch.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},J(e,[{key:"devicePixelRatio",get:function(){return ch.devicePixelRatio}},{key:"windowSize",get:function(){return ch.windowSize},set:function(e){ch.windowSize=e}},{key:"resolution",get:function(){return ch.resolution}},{key:"supportsFullScreen",get:function(){return ch.supportFullScreen}}]),e}(),uh=e("screen",new lh);h.screen=uh;var hh=e("sys",{Feature:hu,hasFeature:function(e){return vu.hasFeature(e)},NetworkType:cu,Language:su,OS:lu,Platform:uu,BrowserType:au,isNative:vu.isNative,isBrowser:vu.isBrowser,isMobile:vu.isMobile,isLittleEndian:vu.isLittleEndian,platform:vu.platform,language:vu.language,languageCode:vu.nativeLanguage,os:vu.os,osVersion:vu.osVersion,osMainVersion:vu.osMainVersion,browserType:vu.browserType,browserVersion:vu.browserVersion,windowPixelResolution:uh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:vu.hasFeature(hu.WEBP),imageBitmap:vu.hasFeature(hu.IMAGE_BITMAP),touches:vu.hasFeature(hu.INPUT_TOUCH),mouse:vu.hasFeature(hu.EVENT_MOUSE),keyboard:vu.hasFeature(hu.EVENT_KEYBOARD),accelerometer:vu.hasFeature(hu.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return vu.networkType},getBatteryLevel:function(){return vu.getBatteryLevel()},garbageCollect:function(){vu.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",x(e+="Using "+(h.game.renderType===h.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){vu.openURL(e)},now:function(){return vu.now()},restartVM:function(){vu.restartJSVM()},getSafeAreaRect:function(){var e=h.view,t=ch.safeAreaEdge,n=ch.windowSize,i=new Jn(t.left,t.bottom),r=new Jn(n.width-t.right,n.height-t.top);e._convertToUISpace(i),e._convertToUISpace(r);var o=i.x,a=i.y,s=r.x-i.x,c=r.y-i.y;return new si(o,a,s,c)}});!function(){try{var e=hh.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){D(5200)};hh.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}hh.__isWebIOS14OrIPadOS14Env=(hh.os===lu.IOS||hh.os===lu.OSX)&&vu.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),h.sys=hh;var _h=e("serializeTag",Symbol("[[Serialize]]")),fh=e("deserializeTag",Symbol("[[Deserialize]]")),dh=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return J(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function ph(e){var t=e;return{chunks:t.chunks,document:t.document}}function mh(e){if(e.length<16)throw new vh(z(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new vh(z(13100));var n=t.getUint32(4,!0);if(1!==n)throw new vh(z(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new vh(z(13102));var i=12,r=t.getUint32(i,!0);i+=4;var o=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var a,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(z(13104))}(o);try{a=JSON.parse(s)}catch(e){throw new vh(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new vh(z(13102));return new dh(a,c)}var vh=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(oe(Error));function gh(e,t,n,i,r){if(t instanceof h.ValueType){r||e.push("if(prop){");var o=Oe(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),r||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},J(e,[{key:"byteLength",get:function(){return this._length}}])}(),h.internal.parseCCONJson=ph,h.internal.decodeCCONBinary=mh,h.internal.CCON=dh;var yh="$_$default",Sh="$_$formerlySerializedAs",xh=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return ee(t,e),t.prototype.get=function(e,t,n,i,r){var o=this._get();return o?(o.reset(e,t,n,i,r),o):new Eh(e,t,n,i,r)},t}(it),Eh=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof dh?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,o=e.__type__,a=this._classFinder(o,e,n,i);if(!a)return this._classFinder===et&&this._reportMissingClass(o),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(a);return this._deserializeInto(e,s,a),s},t._deserializeInto=function(e,t,n,i){void 0===i&&(i=!1),i||!t[fh]?t._deserialize?t._deserialize(e.content,this):h.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Ve(n);r&&i._deserializeInto(e,t,r)}};t[fh](r,this._context)},t._deserializeFireClass=function(e,t,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(e,t){for(var n=Dt(t),i=t.__values__,r=["var prop;"],o=dt.test(nt(t)),a=0;a<i.length;a++){var s=i[a],c=void 0,l=void 0;nn.IDENTIFIER_RE.test(s)?(l='"'+s+'"',c="."+s):c="["+(l=nn.escapeForJS(s))+"]";var u=c;if(n[s+Sh]){var _=n[s+Sh];u=nn.IDENTIFIER_RE.test(_)?"."+_:"["+nn.escapeForJS(_)+"]"}r.push("prop=d"+u+";"),r.push('if(typeof prop!=="undefined"){');var f=nn.getDefault(n[s+yh]);if(o){var d=void 0,p=n[s+"$_$type"];if(void 0===f&&p)d=p instanceof Mt;else{var m=typeof f;d="string"===m||"number"===m||"boolean"===m}d?r.push("o"+c+"=prop;"):gh(r,f,c,l,!0)}else r.push('if(typeof prop!=="object"){o'+c+"=prop;}else{"),gh(r,f,c,l,!1),r.push("}");r.push("}")}return(h.js.isChildClassOf(t,h._BaseNode)||h.js.isChildClassOf(t,h.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===rh){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(T("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),T("    Error props: ['"+r+"']. Please contact jare."));var o=i;i=function(e,t,n,i){o(e,t,n,i),t._$erialized||T("Unable to stash previously serialized data. "+JSON.stringify(n))}}}catch(e){T("Error when checking MissingScript 6, "+e)}be(n,"__deserialize__",i,!0)}i(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var o,a=this._serializedData[i];e[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===h.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===h.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==h.Color){if(n===h.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=Dt(n),r=n.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];void 0!==s||t.hasOwnProperty(a)||(s=nn.getDefault(i[a+yh])),"object"!=typeof s?e[a]=s:s?this._deserializeAndAssignField(e,s,a):e[a]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}},e}();Eh.pool=new xh;var Th=[Jn,Nn,ni,Gn,On,oi,si,Yn];function Ch(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var Ah=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},Ch,Ch,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){Yn.fromArray(e,t,1)}],bh=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function wh(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=t[c];for(;c<t.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,Nh[u])(e,r,l,t[c])}return r}function Ih(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):M(5303,Oe(t)),i}function Ph(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function Rh(e){return function(t,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)e(t,r,o,r[o])}}function Oh(e,t,n,i){t[n]=null,e[8][i]=t}function Dh(e,t,n,i){t[n]=wh(e,i)}bh.pool=new it((function(e){e.reset()}),5),bh.pool.get=function(){return this._get()||new bh};var Nh=new Array(13);function Mh(e,t,n){return e||n(t),Object}function Lh(e,t,n,i,r,o,a){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||Mh(o,i,a);return t[n]=r,new r}}(n,i,t));s=Mh(o,t,a)}n[i]=s}function Bh(e,t,n,i){for(var r=n||et,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Lh(r,s[0],s,0,t,n,i):Lh(r,s,o,a,t,n,i)}}function Fh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function zh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,r=!t;if(t=t||bh.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Uh}return!1}(e)){t.init(e),n=n||{};var o,a=e[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(z(5304,a));n._version=a,n.result=t,e[0]=n,s||(Bh(e,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:zh.reportMissingClass),Fh(e)),h.game._isCloning=!0;var c=e[5],l=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],o=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=wh(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=Ih(e,h,u)}else(0,Nh[l=~l])(e,t,a,u)}return r}(e);h.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,o=3*e[i];r<o;r+=3){var a=e[r],s=t[e[r+2]],c=e[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],c,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],o=e[9],a=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),i=c[l]}else i=function(e,t,n){var i,r=(n=n||{}).classFinder||et,o=n.createAssetRefs||hh.platform===uu.EDITOR_CORE,a=n.customEnv,s=n.ignoreEditorOnly,c=null!==(i=n.reportMissingClass)&&void 0!==i?i:h.deserialize.reportMissingClass;t.init();var l=Eh.pool.get(t,r,c,a,s);h.game._isCloning=!0;var u=l.deserialize(e);return h.game._isCloning=!1,Eh.pool.put(l),o&&t.assignAssetsBy(EditorExtends.serialize.asAsset),u}(e,t,n);return r&&bh.pool.put(t),i}Nh[0]=function(e,t,n,i){t[n]=i},Nh[1]=Ph,Nh[2]=Rh(Ph),Nh[3]=Rh(Oh),Nh[4]=Dh,Nh[5]=function(e,t,n,i){Ah[i[0]](t[n],i)},Nh[6]=Oh,Nh[7]=function(e,t,n,i){t[n].set(i)},Nh[8]=function(e,t,n,i){var r=new Th[i[0]];Ah[i[0]](r,i),t[n]=r},Nh[9]=Rh(Dh),Nh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=Ih(e,r,i[1])},Nh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,Nh[s])(e,r,a,c)}},Nh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,Nh[s])(e,r,o,a)}},zh.Details=bh,zh.reportMissingClass=function(e){M(5302,e)};var Uh=function(e){this.preprocessed=!0,this.version=e};function Gh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}h.deserialize=zh;var kh,Hh,Vh,Wh,jh,Xh,qh,Yh,Kh,Qh,Zh,Jh=yl.Flags.Destroyed,$h=yl.Flags.PersistentMask,e_=[];function t_(e){var t;if(e instanceof yl){if(e._instantiate)return h.game._isCloning=!0,t=e._instantiate(null,!0),h.game._isCloning=!1,t;if(e instanceof h.Asset)throw new TypeError(z(6903))}return h.game._isCloning=!0,t=n_(e),h.game._isCloning=!1,t}function n_(e,t){var n;i_(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=e_.length;i<r;++i)e_[i]._iN$t=null;return e_.length=0,n}function i_(e,t,n){ot.value(e,"_iN$t",t,!0),e_.push(e);var i=e.constructor;if(rn(i))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof _t&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||r_(s,i)}else n[a]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=e[r];if("object"==typeof o&&o){if(o===t)continue;t[r]=o._iN$t||r_(o,n)}else t[r]=o}e instanceof yl&&(t._objFlags&=$h)}function r_(e,t){if(e instanceof _t)return e.clone();if(e instanceof h.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,e_.push(e);for(var r=0;r<i;++r)n[r]=e[r];return n}if(Array.isArray(e)){var o=e.length;n=new Array(o),e._iN$t=n,e_.push(e);for(var a=0;a<o;++a){var s=e[a];n[a]="object"==typeof s&&s?s._iN$t||r_(s,t):s}return n}if(e._objFlags&Jh)return null;var c=e.constructor;if(rn(c)){if(t)if(t instanceof h.Component){if(e instanceof h._BaseNode||e instanceof h.Component)return e}else if(t instanceof h._BaseNode)if(e instanceof h._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof h.Component&&e.node&&!e.node.isChildOf(t))return e;n=new c}else if(c===Object)n={};else{if(c)return e;n=Object.create(null)}return i_(e,n,t),n}function o_(e,t){return(t<<3)+e}function a_(e){return c_[e]}function s_(e){switch(e){case Qh.Uint8:return Uint8Array;case Qh.Uint16:return Uint16Array;case Qh.Uint32:return Uint32Array;case Qh.Int8:return Int8Array;case Qh.Int16:return Int16Array;case Qh.Int32:return Int32Array;case Qh.Float32:return Float32Array;case Qh.Float64:return Float64Array}}t_._clone=n_,h.instantiate=t_,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Qh||(Qh={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Zh||(Zh={})),e("CompactValueTypeArray",Ic("cc.CompactValueTypeArray")((Yh=qh=function(){function e(){le(this,"_byteOffset",Vh,this),le(this,"_unitCount",Wh,this),le(this,"_unitElement",jh,this),le(this,"_length",Xh,this)}return e.lengthFor=function(e,t,n){return a_(t).requiredUnits*e.length*s_(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,o,a){for(var s=a_(n),c=s_(i),l=s.requiredUnits*t.length,u=new c(r,o,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=o_(i,n),_._byteOffset=a,_._unitCount=l,_._length=t.length,_},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=a_(n.elementType),o=new(s_(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},e}(),qh.StorageUnit=Qh,qh.ElementType=Zh,Vh=ue((Hh=Yh).prototype,"_byteOffset",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wh=ue(Hh.prototype,"_unitCount",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jh=ue(Hh.prototype,"_unitElement",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return o_(Qh.Uint8,Zh.Scalar)}}),Xh=ue(Hh.prototype,"_length",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kh=Hh))||kh);var c_=((Kh={})[Zh.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},Kh[Zh.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new Nn(e[2*t],e[2*t+1])}},Kh[Zh.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new Nn(e[3*t],e[3*t+1],e[3*t+2])}},Kh[Zh.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new ni(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Kh[Zh.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Gn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Kh[Zh.Mat4]={requiredUnits:16,compress:function(e,t,n){Yn.toArray(e,n,16*t)},decompress:function(e,t){return Yn.fromArray(new Yn,e,16*t)}},Kh);function l_(){return 0}function u_(e){return e}function h_(e){return e*e}function __(e){return e*(2-e)}function f_(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function d_(e){return e*e*e}function p_(e){return--e*e*e+1}function m_(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function v_(e){return e*e*e*e}function g_(e){return 1- --e*e*e*e}function y_(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function S_(e){return e*e*e*e*e}function x_(e){return--e*e*e*e*e+1}function E_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function T_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function C_(e){return Math.sin(e*Math.PI/2)}function A_(e){return.5*(1-Math.cos(Math.PI*e))}function b_(e){return 0===e?0:Math.pow(1024,e-1)}function w_(e){return 1===e?1:1-Math.pow(2,-10*e)}function I_(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function P_(e){return 1-Math.sqrt(1-e*e)}function R_(e){return Math.sqrt(1- --e*e)}function O_(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function D_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function N_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function M_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function L_(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function B_(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function F_(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function z_(e){return 1-U_(1-e)}function U_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function G_(e){return e<.5?.5*z_(2*e):.5*U_(2*e-1)+.5}function k_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function H_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}h._decorator=ml;var V_=$_(h_,__),W_=$_(d_,p_),j_=$_(v_,g_),X_=$_(S_,x_),q_=$_(T_,C_),Y_=$_(b_,w_),K_=$_(P_,R_),Q_=$_(D_,N_),Z_=$_(L_,B_),J_=$_(z_,U_);function $_(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var ef,tf,nf=Object.freeze({__proto__:null,constant:l_,linear:u_,quadIn:h_,quadOut:__,quadInOut:f_,cubicIn:d_,cubicOut:p_,cubicInOut:m_,quartIn:v_,quartOut:g_,quartInOut:y_,quintIn:S_,quintOut:x_,quintInOut:E_,sineIn:T_,sineOut:C_,sineInOut:A_,expoIn:b_,expoOut:w_,expoInOut:I_,circIn:P_,circOut:R_,circInOut:O_,elasticIn:D_,elasticOut:N_,elasticInOut:M_,backIn:L_,backOut:B_,backInOut:F_,bounceIn:z_,bounceOut:U_,bounceInOut:G_,smooth:k_,fade:H_,quadOutIn:V_,cubicOutIn:W_,quartOutIn:j_,quintOutIn:X_,sineOutIn:q_,expoOutIn:Y_,circOutIn:K_,elasticOutIn:Q_,backOutIn:Z_,bounceOutIn:J_});e("easing",nf),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(tf||(tf={}));var rf,of=((ef={})[tf.CONSTANT]=l_,ef[tf.LINEAR]=u_,ef[tf.QUAD_IN]=h_,ef[tf.QUAD_OUT]=__,ef[tf.QUAD_IN_OUT]=f_,ef[tf.QUAD_OUT_IN]=V_,ef[tf.CUBIC_IN]=d_,ef[tf.CUBIC_OUT]=p_,ef[tf.CUBIC_IN_OUT]=m_,ef[tf.CUBIC_OUT_IN]=W_,ef[tf.QUART_IN]=v_,ef[tf.QUART_OUT]=g_,ef[tf.QUART_IN_OUT]=y_,ef[tf.QUART_OUT_IN]=j_,ef[tf.QUINT_IN]=S_,ef[tf.QUINT_OUT]=x_,ef[tf.QUINT_IN_OUT]=E_,ef[tf.QUINT_OUT_IN]=X_,ef[tf.SINE_IN]=T_,ef[tf.SINE_OUT]=C_,ef[tf.SINE_IN_OUT]=A_,ef[tf.SINE_OUT_IN]=q_,ef[tf.EXPO_IN]=b_,ef[tf.EXPO_OUT]=w_,ef[tf.EXPO_IN_OUT]=I_,ef[tf.EXPO_OUT_IN]=Y_,ef[tf.CIRC_IN]=P_,ef[tf.CIRC_OUT]=R_,ef[tf.CIRC_IN_OUT]=O_,ef[tf.CIRC_OUT_IN]=K_,ef[tf.ELASTIC_IN]=D_,ef[tf.ELASTIC_OUT]=N_,ef[tf.ELASTIC_IN_OUT]=M_,ef[tf.ELASTIC_OUT_IN]=Q_,ef[tf.BACK_IN]=L_,ef[tf.BACK_OUT]=B_,ef[tf.BACK_IN_OUT]=F_,ef[tf.BACK_OUT_IN]=Z_,ef[tf.BOUNCE_IN]=z_,ef[tf.BOUNCE_OUT]=U_,ef[tf.BOUNCE_IN_OUT]=G_,ef[tf.BOUNCE_OUT_IN]=J_,ef[tf.SMOOTH]=k_,ef[tf.FADE]=H_,ef);function af(e){return of[e]}o(255),o(65280);var sf,cf,lf,uf=pc.LINEAR<<0|vc.NONE<<8|tf.LINEAR<<16,hf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t._flags=uf,t}return ee(t,e),J(t,[{key:"interpolationMode",get:function(){return(255&this._flags)>>0},set:function(e){this._flags&=-256,this._flags|=e<<0}},{key:"tangentWeightMode",get:function(){return(65280&this._flags)>>8},set:function(e){this._flags&=-65281,this._flags|=e<<8}},{key:"easingMethod",get:function(){return(16711680&this._flags)>>16},set:function(e){this._flags&=-16711681,this._flags|=e<<16}}]),t}(pl);function _f(e){var t=new hf;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,o=e.rightTangent,a=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[dl];t.value=null!=r?r:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[dl]=u)}return t}nn.fastDefine("cc.RealKeyframeValue",hf,((rf={interpolationMode:pc.LINEAR,tangentWeightMode:vc.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:tf.LINEAR})[dl]=void 0,rf)),nn.Attr.setClassAttr(hf,dl,"editorOnly",!0),(sf=hf,null!==(lf=(cf=sf)[Lc])&&void 0!==lf?lf:cf[Lc]={}).uniquelyReferenced=!0;var ff,df=e("RealCurve",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).preExtrapolation=mc.CLAMP,t.postExtrapolation=mc.CLAMP,t}ee(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],o=t[i-1];if(e<r){var a=this.preExtrapolation,s=n[0];if(a===mc.CLAMP||i<2)return s.value;switch(a){case mc.LINEAR:return Rf(r,n[0].value,t[1],n[1].value,e);case mc.LOOP:e=If(e,r,o);break;case mc.PING_PONG:e=Pf(e,r,o);break;default:return s.value}}else if(e>o){var c=this.postExtrapolation,l=n[i-1];if(c===mc.CLAMP||i<2)return l.value;switch(c){case mc.LINEAR:return Rf(o,l.value,t[i-2],n[i-2].value,e);case mc.LOOP:e=If(e,r,o);break;case mc.PING_PONG:e=Pf(e,r,o);break;default:return l.value}}var u=dc(t,e);if(u>=0)return n[u].value;var h=~u,_=h-1,f=t[_],d=n[_],p=t[h];return function(e,t,n,i,r){var o=n-e;switch(t.interpolationMode){default:case pc.CONSTANT:return t.value;case pc.LINEAR:var a=t.easingMethod===tf.LINEAR?r:af(t.easingMethod)(r);return dn(t.value,i.value,a);case pc.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&vc.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&vc.LEFT);if(u||f){var d=0;if(u)d=l;else{var p=o,m=o*c;d=Math.sqrt(p*p+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*d+e,y=Math.sin(v)*d+t.value,S=0;if(f)S=_;else{var x=o,E=o*h;S=Math.sqrt(x*x+E*E)*s}var T=Math.atan(h),C=(g-e)/o,A=(-Math.cos(T)*S+n-e)/o,b=y,w=-Math.sin(T)*S+i.value,I=[0,0,0],P=function(e,t,n,i,r){var o=n/i,a=t/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+e/i),u=c*c*c,h=l*l+u,_=0;if(yc(h)){if(yc(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var d=1/3*Math.acos(-l/Math.sqrt(-u)),p=2*Math.sqrt(-c);r[0]=p*Math.cos(d),r[1]=-p*Math.cos(d+Math.PI/3),r[2]=-p*Math.cos(d-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,S=0;S<_;++S)r[S]-=y;return _}(0-r,3*C,3*A-6*C,3*(C-A)+1,I),R=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var o=e[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(I,P,r);return Of(t.value,b,w,i.value,R)}var O=t.value+s*c*o,D=i.value-s*h*o;return Of(t.value,O,D,i.value,r)}}(f,d,p,n[h],(e-f)/(p-f))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,_f(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return _f(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return _f(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return hn(n.value,t,e)}))},n[_h]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+pf+pf+mf+vf*r+Af*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=pf,o.setUint8(a,this.postExtrapolation),a+=pf,o.setUint32(a,r,!0),a+=mf,n.forEach((function(e,t){return o.setFloat32(a+vf*t,e,!0)})),a+=vf*r;for(var s,c=ce(i);!(s=c()).done;){var l=s.value;a=bf(o,l,a)}var u=new Uint8Array(o.buffer,0,a);e.writeProperty("bytes",u);var h=i.map((function(e){return e[dl]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[fh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=pf,this.postExtrapolation=i.getUint8(r),r+=pf;var o=i.getUint32(r,!0);r+=mf;var a=Array.from({length:o},(function(e,t){return i.getFloat32(r+vf*t,!0)}));r+=vf*o;for(var s=new Array(o),c=0;c<o;++c){var l=_f({});r=wf(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][dl]=e}))),this._times=a,this._values=s}else e.readThis()},t}(gc));nn.fastDefine("cc.RealCurve",df,{_times:[],_values:[],preExtrapolation:mc.CLAMP,postExtrapolation:mc.CLAMP}),function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(ff||(ff={}));var pf=1,mf=4,vf=4,gf=_f({}),yf=gf.interpolationMode,Sf=gf.tangentWeightMode,xf=gf.leftTangent,Ef=gf.leftTangentWeight,Tf=gf.rightTangent,Cf=gf.rightTangentWeight,Af=26;function bf(e,t,n){var i=0,r=n,o=r;r+=4;var a=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,s!==yf&&(i|=ff.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==Sf&&(i|=ff.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==xf&&(i|=ff.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),_!==Ef&&(i|=ff.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),l!==Tf&&(i|=ff.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==Cf&&(i|=ff.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=f<<8,e.setUint32(o,i,!0),r}function wf(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&ff.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&ff.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&ff.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&ff.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&ff.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&ff.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return t.easingMethod=o,i}function If(e,t,n){return t+Cn(e-t,n-t)}function Pf(e,t,n){return t+An(e-t,n-t)}function Rf(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function Of(e,t,n,i,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*n+r*r*r*i}function Df(e,t,n,i,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}h.bezier=Df;var Nf,Mf,Lf,Bf,Ff,zf,Uf,Gf,kf,Hf,Vf,Wf=Math.cos,jf=Math.acos,Xf=Math.max,qf=2*Math.PI,Yf=Math.sqrt;function Kf(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Qf(e,t){var n=function(e,t){var n,i,r,o,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,d=f*_,p=(-c+l)*h,m=(3*p-f*f)*_,v=m*_,g=(2*f*f*f-9*f*p+a*h*27)/27,y=g/2,S=y*y+v*v*v;if(S<0){var x=-m*_,E=Yf(x*x*x),T=-g/(2*E),C=jf(T<-1?-1:T>1?1:T),A=2*Kf(E);return i=A*Wf(C*_)-d,r=A*Wf((C+qf)*_)-d,o=A*Wf((C+2*qf)*_)-d,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Xf(i,r,o):Xf(i,r):o>=0&&o<=1?Xf(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Xf(r,o):r:o}if(0===S)return r=-(n=y<0?Kf(-y):-Kf(y))-d,(i=2*n-d)>=0&&i<=1?r>=0&&r<=1?Xf(i,r):i:r;var b=Yf(S);return(n=Kf(-y+b))-Kf(y+b)-d}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}h.bezierByTime=Qf,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(Vf||(Vf=e("QuatInterpolationMode",{})));var Zf=Ic("cc.QuatKeyframeValue")(Nf=Gc((Lf=ue((Mf=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;le(this,"interpolationMode",Lf,this),le(this,"value",Bf,this),le(this,"easingMethod",Ff,this),this.value=n?Gn.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vf.SLERP}}),Bf=ue(Mf.prototype,"value",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gn.clone(Gn.IDENTITY)}}),Ff=ue(Mf.prototype,"easingMethod",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tf.LINEAR}}),Nf=Mf))||Nf)||Nf;function Jf(e){return new Zf(e)}var $f,ed=e("QuatCurve",Ic("cc.QuatCurve")((Hf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",Gf,ae(t)),le(t,"postExtrapolation",kf,ae(t)),t}ee(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new Gn);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(a){case mc.LOOP:e=c+Cn(e-c,l-c);break;case mc.PING_PONG:e=c+An(e-c,l-c);break;case mc.CLAMP:default:return Gn.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(o){case mc.LOOP:e=c+Cn(e-c,l-c);break;case mc.PING_PONG:e=c+An(e-c,l-c);break;case mc.CLAMP:default:return Gn.copy(t,h.value)}}var _=dc(i,e);if(_>=0)return Gn.copy(t,r[_].value);var f=~_,d=f-1,p=i[d],m=r[d],v=i[f],g=r[f],y=(e-p)/(v-p);switch(m.interpolationMode){default:case Vf.CONSTANT:return Gn.copy(t,m.value);case Vf.SLERP:var S=m.easingMethod,x=S===tf.LINEAR?y:Array.isArray(S)?Qf(S,y):af(S)(y);return Gn.slerp(t,m.value,g.value,x)}},n.addKeyFrame=function(t,n){var i=new Zf(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Jf(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return Jf(e[1])})))}},n[_h]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=ad*(r?1:o),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?sd+4*ld:sd)}),0),c=0,l=new DataView(new ArrayBuffer(c+=nd+id+rd*o+4*od*o+s+a+0)),u=0,h=0;r&&(h|=$f.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=nd,l.setUint32(u,o,!0),u+=id,n.forEach((function(e,t){return l.setFloat32(u+rd*t,e,!0)})),u+=rd*o,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*od*t;l.setFloat32(s+0*od,i,!0),l.setFloat32(s+1*od,r,!0),l.setFloat32(s+2*od,o,!0),l.setFloat32(s+3*od,a,!0)})),u+=4*od*o,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,cd),++u,l.setFloat32(u+0*ld,t[0],!0),l.setFloat32(u+1*ld,t[1],!0),l.setFloat32(u+2*ld,t[2],!0),l.setFloat32(u+3*ld,t[3],!0),u+=4*ld):(l.setUint8(u,t),++u)}));var _=u;u+=a;var f=_;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(f,t),r||(f+=ad)}));var d=new Uint8Array(l.buffer);e.writeProperty("bytes",d)}else e.writeThis()},n[fh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=nd;var a=o&$f.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=id;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+rd*t,!0)})),l=r+=rd*s;r+=4*od*s;var u=Array.from({length:s},(function(e,t){var n=l+4*od*t,o=i.getFloat32(n+0*od,!0),a=i.getFloat32(n+1*od,!0),s=i.getFloat32(n+2*od,!0),c=i.getFloat32(n+3*od,!0),u=i.getUint8(r);++r;var h=Jf({value:{x:o,y:a,z:s,w:c}});return u!==cd?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*ld,!0),i.getFloat32(r+1*ld,!0),i.getFloat32(r+2*ld,!0),i.getFloat32(r+3*ld,!0)],r+=4*ld),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var d=i.getUint8(r+f);u[f].interpolationMode=d}r+=s}this._times=c,this._values=u}else e.readThis()},t}(gc),Gf=ue((Uf=Hf).prototype,"preExtrapolation",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mc.CLAMP}}),kf=ue(Uf.prototype,"postExtrapolation",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mc.CLAMP}}),zf=Uf))||zf);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}($f||($f={}));var td,nd=1,id=4,rd=4,od=4,ad=1,sd=1,cd=255,ld=4,ud=e("ObjectCurve",Ic("cc.ObjectCurve")(td=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=_n(~t-1,0,this._values.length-1);return this._values[n]},t}(gc))||td),hd=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};nn.fastDefine("cc.Keyframe",hd,{time:0,value:0,inTangent:0,outTangent:0});var _d=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),fd=function(){function e(e){if(void 0===e&&(e=null),this.cachedKey=void 0,e instanceof df)this._curve=e;else{var t=new df;this._curve=t,t.preExtrapolation=mc.LOOP,t.postExtrapolation=mc.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:pc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:pc.CUBIC,value:1}],[1,{interpolationMode:pc.CUBIC,value:1}]])}this.cachedKey=new _d}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:pc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,o=e<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case mc.LOOP:r=Cn(e-a,s-a)+a;break;case mc.PING_PONG:r=An(e-a,s-a)+a;break;case mc.CLAMP:default:r=_n(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(t),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,_=l-a,f=1/(h*h),d=s*h,p=u*h;e.coefficient[0]=(d+p-_-_)*f/h,e.coefficient[1]=(_+_+_-d-d-p)*f,e.coefficient[2]=s,e.coefficient[3]=a},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},J(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new hd;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:pc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return pd(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=dd(e)}},{key:"postWrapMode",get:function(){return pd(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=dd(e)}}]),e}();function dd(e){switch(e){default:case ac.Default:case ac.Normal:case ac.Clamp:return mc.CLAMP;case ac.PingPong:return mc.PING_PONG;case ac.Loop:return mc.LOOP}}function pd(e){switch(e){default:case mc.LINEAR:case mc.CLAMP:return ac.Clamp;case mc.PING_PONG:return ac.PingPong;case mc.LOOP:return ac.Loop}}function md(){var e=new df;return e.assignSorted([[0,{interpolationMode:pc.CUBIC,value:1}],[1,{interpolationMode:pc.CUBIC,value:1}]]),e}function vd(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}fd.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],nn.fastDefine("cc.AnimationCurve",fd,{_curve:null}),k(ys,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var gd=function(e){function t(){var t;return t=e.call(this)||this,vd("line","Line"),t}return ee(t,e),t}(sa),yd=function(e){function t(){var t;return t=e.call(this)||this,vd("plane","Plane"),t}return ee(t,e),t}(Os),Sd=function(e){function t(){var t;return t=e.call(this)||this,vd("ray","Ray"),t}return ee(t,e),t}(ca),xd=function(e){function t(){var t;return t=e.call(this)||this,vd("triangle","Triangle"),t}return ee(t,e),t}(ma),Ed=function(e){function t(){var t;return t=e.call(this)||this,vd("sphere","Sphere"),t}return ee(t,e),t}(pa),Td=function(e){function t(){var t;return t=e.call(this)||this,vd("aabb","AABB"),t}return ee(t,e),t}($s),Cd=function(e){function t(){var t;return t=e.call(this)||this,vd("obb","OBB"),t}return ee(t,e),t}(ic),Ad=function(e){function t(){var t;return t=e.call(this)||this,vd("capsule","Capsule"),t}return ee(t,e),t}(rc),bd=function(e){function t(){var t;return t=e.call(this)||this,vd("frustum","Frustum"),t}return ee(t,e),t}(hc),wd=Object.freeze({__proto__:null,distance:oa,enums:aa,intersect:ys,Line:sa,Plane:Os,Ray:ca,Triangle:ma,Sphere:pa,AABB:$s,OBB:ic,Capsule:rc,Frustum:hc,Keyframe:hd,AnimationCurve:fd,get ERaycastMode(){return da},line:gd,plane:yd,ray:Sd,triangle:xd,sphere:Ed,aabb:Td,obb:Cd,capsule:Ad,frustum:bd});e("geometry",wd);var Id={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Pd=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=ce(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],z(2104,t),e.Enum[t]=i,ot.value(e.Enum,String(i),t),e.BitMask[t]=i,ot.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):r(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());Pd.Enum=ct(Id),Pd.BitMask=at($({},Id)),h.Layers=Pd;var Rd,Od,Dd="MainFlow",Nd="ForwardFlow",Md="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Rd||(Rd={})),h.RenderPassStage=Rd,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Od||(Od={}));var Ld,Bd={bindings:[],layouts:{}},Fd={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(Ld||(Ld={}));var zd,Ud=Ld.SAMPLER_SHADOWMAP,Gd=Ld.COUNT-Ud;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(zd||(zd={}));var kd,Hd=zd.SAMPLER_JOINTS,Vd=zd.STORAGE_REFLECTION-Hd,Wd=zd.COUNT-Hd-Vd;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(kd||(kd={}));var jd=new mr([Ud,0,Hd],[Gd,0,Vd],[0,0,0],[0,0,0],[0,0,0],[0,0,Wd],[0,0,0],[0,2,1]),Xd=function(){};Xd.SIZE=4*(Xd.COUNT=4+(Xd.SCREEN_SIZE_OFFSET=4+(Xd.NATIVE_SIZE_OFFSET=4+(Xd.TIME_OFFSET=0)))),Xd.NAME="CCGlobal",Xd.BINDING=Ld.UBO_GLOBAL,Xd.DESCRIPTOR=new qr(Xd.BINDING,Ki.UNIFORM_BUFFER,1,Fi.ALL),Xd.LAYOUT=new Ir(kd.GLOBAL,Xd.BINDING,Xd.NAME,[new wr("cc_time",yi.FLOAT4,1),new wr("cc_screenSize",yi.FLOAT4,1),new wr("cc_nativeSize",yi.FLOAT4,1)],1),Bd.layouts[Xd.NAME]=Xd.LAYOUT,Bd.bindings[Xd.BINDING]=Xd.DESCRIPTOR;var qd=function(){};qd.SIZE=4*(qd.COUNT=4+(qd.VIEW_PORT_OFFSET=4+(qd.NEAR_FAR_OFFSET=4+(qd.GLOBAL_FOG_ADD_OFFSET=4+(qd.GLOBAL_FOG_BASE_OFFSET=4+(qd.GLOBAL_FOG_COLOR_OFFSET=4+(qd.AMBIENT_GROUND_OFFSET=4+(qd.AMBIENT_SKY_OFFSET=4+(qd.MAIN_LIT_COLOR_OFFSET=4+(qd.MAIN_LIT_DIR_OFFSET=4+(qd.EXPOSURE_OFFSET=4+(qd.SCREEN_SCALE_OFFSET=4+(qd.CAMERA_POS_OFFSET=16+(qd.MAT_VIEW_PROJ_INV_OFFSET=16+(qd.MAT_VIEW_PROJ_OFFSET=16+(qd.MAT_PROJ_INV_OFFSET=16+(qd.MAT_PROJ_OFFSET=16+(qd.MAT_VIEW_INV_OFFSET=16+(qd.MAT_VIEW_OFFSET=0))))))))))))))))))),qd.NAME="CCCamera",qd.BINDING=Ld.UBO_CAMERA,qd.DESCRIPTOR=new qr(qd.BINDING,Ki.UNIFORM_BUFFER,1,Fi.ALL),qd.LAYOUT=new Ir(kd.GLOBAL,qd.BINDING,qd.NAME,[new wr("cc_matView",yi.MAT4,1),new wr("cc_matViewInv",yi.MAT4,1),new wr("cc_matProj",yi.MAT4,1),new wr("cc_matProjInv",yi.MAT4,1),new wr("cc_matViewProj",yi.MAT4,1),new wr("cc_matViewProjInv",yi.MAT4,1),new wr("cc_cameraPos",yi.FLOAT4,1),new wr("cc_screenScale",yi.FLOAT4,1),new wr("cc_exposure",yi.FLOAT4,1),new wr("cc_mainLitDir",yi.FLOAT4,1),new wr("cc_mainLitColor",yi.FLOAT4,1),new wr("cc_ambientSky",yi.FLOAT4,1),new wr("cc_ambientGround",yi.FLOAT4,1),new wr("cc_fogColor",yi.FLOAT4,1),new wr("cc_fogBase",yi.FLOAT4,1),new wr("cc_fogAdd",yi.FLOAT4,1),new wr("cc_nearFar",yi.FLOAT4,1),new wr("cc_viewPort",yi.FLOAT4,1)],1),Bd.layouts[qd.NAME]=qd.LAYOUT,Bd.bindings[qd.BINDING]=qd.DESCRIPTOR;var Yd=function(){};Yd.SIZE=4*(Yd.COUNT=4+(Yd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Yd.SHADOW_COLOR_OFFSET=4+(Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Yd.SHADOW_PROJ_INFO_OFFSET=4+(Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Yd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Yd.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Yd.MAT_LIGHT_VIEW_OFFSET=16+(Yd.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Yd.NAME="CCShadow",Yd.BINDING=Ld.UBO_SHADOW,Yd.DESCRIPTOR=new qr(Yd.BINDING,Ki.UNIFORM_BUFFER,1,Fi.ALL),Yd.LAYOUT=new Ir(kd.GLOBAL,Yd.BINDING,Yd.NAME,[new wr("cc_matLightPlaneProj",yi.MAT4,1),new wr("cc_matLightView",yi.MAT4,1),new wr("cc_matLightViewProj",yi.MAT4,1),new wr("cc_shadowInvProjDepthInfo",yi.FLOAT4,1),new wr("cc_shadowProjDepthInfo",yi.FLOAT4,1),new wr("cc_shadowProjInfo",yi.FLOAT4,1),new wr("cc_shadowNFLSInfo",yi.FLOAT4,1),new wr("cc_shadowWHPBInfo",yi.FLOAT4,1),new wr("cc_shadowLPNNInfo",yi.FLOAT4,1),new wr("cc_shadowColor",yi.FLOAT4,1),new wr("cc_planarNDInfo",yi.FLOAT4,1)],1),Bd.layouts[Yd.NAME]=Yd.LAYOUT,Bd.bindings[Yd.BINDING]=Yd.DESCRIPTOR;var Kd=Ld.SAMPLER_SHADOWMAP,Qd=new qr(Kd,Ki.SAMPLER_TEXTURE,1,Fi.FRAGMENT),Zd=new Pr(kd.GLOBAL,Kd,"cc_shadowMap",yi.SAMPLER2D,1);Bd.layouts.cc_shadowMap=Zd,Bd.bindings[Kd]=Qd;var Jd=Ld.SAMPLER_ENVIRONMENT,$d=new qr(Jd,Ki.SAMPLER_TEXTURE,1,Fi.FRAGMENT),ep=new Pr(kd.GLOBAL,Jd,"cc_environment",yi.SAMPLER_CUBE,1);Bd.layouts.cc_environment=ep,Bd.bindings[Jd]=$d;var tp=Ld.SAMPLER_DIFFUSEMAP,np=new qr(tp,Ki.SAMPLER_TEXTURE,1,Fi.FRAGMENT),ip=new Pr(kd.GLOBAL,tp,"cc_diffuseMap",yi.SAMPLER_CUBE,1);Bd.layouts.cc_diffuseMap=ip,Bd.bindings[tp]=np;var rp=Ld.SAMPLER_SPOT_LIGHTING_MAP,op=new qr(rp,Ki.SAMPLER_TEXTURE,1,Fi.FRAGMENT),ap=new Pr(kd.GLOBAL,rp,"cc_spotLightingMap",yi.SAMPLER2D,1);Bd.layouts.cc_spotLightingMap=ap,Bd.bindings[rp]=op;var sp=function(){};sp.SIZE=4*(sp.COUNT=4+(sp.LOCAL_SHADOW_BIAS=4+(sp.LIGHTINGMAP_UVPARAM=16+(sp.MAT_WORLD_IT_OFFSET=16+(sp.MAT_WORLD_OFFSET=0))))),sp.NAME="CCLocal",sp.BINDING=zd.UBO_LOCAL,sp.DESCRIPTOR=new qr(sp.BINDING,Ki.UNIFORM_BUFFER,1,Fi.VERTEX|Fi.COMPUTE),sp.LAYOUT=new Ir(kd.LOCAL,sp.BINDING,sp.NAME,[new wr("cc_matWorld",yi.MAT4,1),new wr("cc_matWorldIT",yi.MAT4,1),new wr("cc_lightingMapUVParam",yi.FLOAT4,1),new wr("cc_localShadowBias",yi.FLOAT4,1)],1),Fd.layouts[sp.NAME]=sp.LAYOUT,Fd.bindings[sp.BINDING]=sp.DESCRIPTOR;var cp=function(){};cp.SIZE=4*(cp.COUNT=4+(cp.WORLD_BOUND_HALF_EXTENTS=4+(cp.WORLD_BOUND_CENTER=0))),cp.NAME="CCWorldBound",cp.BINDING=zd.UBO_LOCAL,cp.DESCRIPTOR=new qr(cp.BINDING,Ki.UNIFORM_BUFFER,1,Fi.VERTEX|Fi.COMPUTE),cp.LAYOUT=new Ir(kd.LOCAL,cp.BINDING,cp.NAME,[new wr("cc_worldBoundCenter",yi.FLOAT4,1),new wr("cc_worldBoundHalfExtents",yi.FLOAT4,1)],1),Fd.layouts[cp.NAME]=cp.LAYOUT,Fd.bindings[cp.BINDING]=cp.DESCRIPTOR;var lp="a_matWorld0",up=function(){};up.BATCHING_COUNT=10,up.MAT_WORLDS_OFFSET=0,up.SIZE=4*(up.COUNT=16*up.BATCHING_COUNT),up.NAME="CCLocalBatched",up.BINDING=zd.UBO_LOCAL,up.DESCRIPTOR=new qr(up.BINDING,Ki.UNIFORM_BUFFER,1,Fi.VERTEX|Fi.COMPUTE),up.LAYOUT=new Ir(kd.LOCAL,up.BINDING,up.NAME,[new wr("cc_matWorlds",yi.MAT4,up.BATCHING_COUNT)],1),Fd.layouts[up.NAME]=up.LAYOUT,Fd.bindings[up.BINDING]=up.DESCRIPTOR;var hp=function(){};hp.LIGHTS_PER_PASS=1,hp.SIZE=4*(hp.COUNT=(hp.LIGHT_DIR_OFFSET=(hp.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(hp.LIGHT_COLOR_OFFSET=(hp.LIGHT_POS_OFFSET=0)+4*hp.LIGHTS_PER_PASS)+4*hp.LIGHTS_PER_PASS)+4*hp.LIGHTS_PER_PASS)+4*hp.LIGHTS_PER_PASS),hp.NAME="CCForwardLight",hp.BINDING=zd.UBO_FORWARD_LIGHTS,hp.DESCRIPTOR=new qr(hp.BINDING,Ki.DYNAMIC_UNIFORM_BUFFER,1,Fi.FRAGMENT),hp.LAYOUT=new Ir(kd.LOCAL,hp.BINDING,hp.NAME,[new wr("cc_lightPos",yi.FLOAT4,hp.LIGHTS_PER_PASS),new wr("cc_lightColor",yi.FLOAT4,hp.LIGHTS_PER_PASS),new wr("cc_lightSizeRangeAngle",yi.FLOAT4,hp.LIGHTS_PER_PASS),new wr("cc_lightDir",yi.FLOAT4,hp.LIGHTS_PER_PASS)],1),Fd.layouts[hp.NAME]=hp.LAYOUT,Fd.bindings[hp.BINDING]=hp.DESCRIPTOR;var _p=function(){};_p.LIGHTS_PER_PASS=10;var fp=function(){};fp.SIZE=4*(fp.COUNT=4+(fp.JOINTS_TEXTURE_INFO_OFFSET=0)),fp.NAME="CCSkinningTexture",fp.BINDING=zd.UBO_SKINNING_TEXTURE,fp.DESCRIPTOR=new qr(fp.BINDING,Ki.UNIFORM_BUFFER,1,Fi.VERTEX),fp.LAYOUT=new Ir(kd.LOCAL,fp.BINDING,fp.NAME,[new wr("cc_jointTextureInfo",yi.FLOAT4,1)],1),Fd.layouts[fp.NAME]=fp.LAYOUT,Fd.bindings[fp.BINDING]=fp.DESCRIPTOR;var dp=function(){};dp.SIZE=4*(dp.COUNT=4+(dp.JOINTS_ANIM_INFO_OFFSET=0)),dp.NAME="CCSkinningAnimation",dp.BINDING=zd.UBO_SKINNING_ANIMATION,dp.DESCRIPTOR=new qr(dp.BINDING,Ki.UNIFORM_BUFFER,1,Fi.VERTEX),dp.LAYOUT=new Ir(kd.LOCAL,dp.BINDING,dp.NAME,[new wr("cc_jointAnimInfo",yi.FLOAT4,1)],1),Fd.layouts[dp.NAME]=dp.LAYOUT,Fd.bindings[dp.BINDING]=dp.DESCRIPTOR;var pp="a_jointAnimInfo",mp=function(){};mp.SIZE=4*(mp.COUNT=360+(mp.JOINTS_OFFSET=0)),mp.NAME="CCSkinning",mp.BINDING=zd.UBO_SKINNING_TEXTURE,mp.DESCRIPTOR=new qr(mp.BINDING,Ki.UNIFORM_BUFFER,1,Fi.VERTEX),mp.LAYOUT=new Ir(kd.LOCAL,mp.BINDING,mp.NAME,[new wr("cc_joints",yi.FLOAT4,90)],1),Fd.layouts[mp.NAME]=mp.LAYOUT,Fd.bindings[mp.BINDING]=mp.DESCRIPTOR;var vp=function(){};vp.MAX_MORPH_TARGET_COUNT=60,vp.OFFSET_OF_WEIGHTS=0,vp.OFFSET_OF_VERTICES_COUNT=4+(vp.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(vp.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*vp.MAX_MORPH_TARGET_COUNT)),vp.COUNT_BASE_4_BYTES=4*Math.ceil(vp.MAX_MORPH_TARGET_COUNT/4)+4,vp.SIZE=4*vp.COUNT_BASE_4_BYTES,vp.NAME="CCMorph",vp.BINDING=zd.UBO_MORPH,vp.DESCRIPTOR=new qr(vp.BINDING,Ki.UNIFORM_BUFFER,1,Fi.VERTEX),vp.LAYOUT=new Ir(kd.LOCAL,vp.BINDING,vp.NAME,[new wr("cc_displacementWeights",yi.FLOAT4,vp.MAX_MORPH_TARGET_COUNT/4),new wr("cc_displacementTextureInfo",yi.FLOAT4,1)],1),Fd.layouts[vp.NAME]=vp.LAYOUT,Fd.bindings[vp.BINDING]=vp.DESCRIPTOR;var gp=function(){};gp.NAME="CCUILocal",gp.BINDING=zd.UBO_UI_LOCAL,gp.DESCRIPTOR=new qr(gp.BINDING,Ki.DYNAMIC_UNIFORM_BUFFER,1,Fi.VERTEX),gp.LAYOUT=new Ir(kd.LOCAL,gp.BINDING,gp.NAME,[new wr("cc_local_data",yi.FLOAT4,1)],1),Fd.layouts[gp.NAME]=gp.LAYOUT,Fd.bindings[gp.BINDING]=gp.DESCRIPTOR;var yp=zd.SAMPLER_JOINTS,Sp=new qr(yp,Ki.SAMPLER_TEXTURE,1,Fi.VERTEX),xp=new Pr(kd.LOCAL,yp,"cc_jointTexture",yi.SAMPLER2D,1);Fd.layouts.cc_jointTexture=xp,Fd.bindings[yp]=Sp;var Ep=zd.SAMPLER_MORPH_POSITION,Tp=new qr(Ep,Ki.SAMPLER_TEXTURE,1,Fi.VERTEX),Cp=new Pr(kd.LOCAL,Ep,"cc_PositionDisplacements",yi.SAMPLER2D,1);Fd.layouts.cc_PositionDisplacements=Cp,Fd.bindings[Ep]=Tp;var Ap=zd.SAMPLER_MORPH_NORMAL,bp=new qr(Ap,Ki.SAMPLER_TEXTURE,1,Fi.VERTEX),wp=new Pr(kd.LOCAL,Ap,"cc_NormalDisplacements",yi.SAMPLER2D,1);Fd.layouts.cc_NormalDisplacements=wp,Fd.bindings[Ap]=bp;var Ip=zd.SAMPLER_MORPH_TANGENT,Pp=new qr(Ip,Ki.SAMPLER_TEXTURE,1,Fi.VERTEX),Rp=new Pr(kd.LOCAL,Ip,"cc_TangentDisplacements",yi.SAMPLER2D,1);Fd.layouts.cc_TangentDisplacements=Rp,Fd.bindings[Ip]=Pp;var Op=zd.SAMPLER_LIGHTMAP,Dp=new qr(Op,Ki.SAMPLER_TEXTURE,1,Fi.FRAGMENT),Np=new Pr(kd.LOCAL,Op,"cc_lightingMap",yi.SAMPLER2D,1);Fd.layouts.cc_lightingMap=Np,Fd.bindings[Op]=Dp;var Mp=zd.SAMPLER_SPRITE,Lp=new qr(Mp,Ki.SAMPLER_TEXTURE,1,Fi.FRAGMENT),Bp=new Pr(kd.LOCAL,Mp,"cc_spriteTexture",yi.SAMPLER2D,1);Fd.layouts.cc_spriteTexture=Bp,Fd.bindings[Mp]=Lp;var Fp=zd.SAMPLER_REFLECTION,zp=new qr(Fp,Ki.SAMPLER_TEXTURE,1,Fi.FRAGMENT),Up=new Pr(kd.LOCAL,Fp,"cc_reflectionTexture",yi.SAMPLER2D,1);Fd.layouts.cc_reflectionTexture=Up,Fd.bindings[Fp]=zp;var Gp=zd.STORAGE_REFLECTION,kp=new qr(Gp,Ki.STORAGE_IMAGE,1,Fi.COMPUTE),Hp=new Dr(kd.LOCAL,Gp,"cc_reflectionStorage",yi.IMAGE2D,1);Fd.layouts.cc_reflectionStorage=Hp,Fd.bindings[Gp]=kp;var Vp,Wp,jp=Pd.makeMaskExclude([Pd.BitMask.UI_2D,Pd.BitMask.GIZMOS,Pd.BitMask.EDITOR,Pd.BitMask.SCENE_GIZMO,Pd.BitMask.PROFILER]),Xp=Pd.makeMaskExclude([Pd.BitMask.UI_2D,Pd.BitMask.PROFILER]),qp=Pd.Enum.ALL;function Yp(e){return(e.getFormatFeatures(vi.R32F)&(wi.RENDER_TARGET|wi.SAMPLED_TEXTURE))==(wi.RENDER_TARGET|wi.SAMPLED_TEXTURE)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Dd,PIPELINE_FLOW_FORWARD:Nd,PIPELINE_FLOW_SHADOW:Md,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Rd},get RenderPriority(){return Od},globalDescriptorSetLayout:Bd,localDescriptorSetLayout:Fd,get PipelineGlobalBindings(){return Ld},get ModelLocalBindings(){return zd},get SetIndex(){return kd},bindingMappingInfo:jd,UBOGlobal:Xd,UBOCamera:qd,UBOShadow:Yd,UNIFORM_SHADOWMAP_BINDING:Kd,UNIFORM_ENVIRONMENT_BINDING:Jd,UNIFORM_DIFFUSEMAP_BINDING:tp,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:rp,UBOLocal:sp,UBOWorldBound:cp,INST_MAT_WORLD:lp,UBOLocalBatched:up,UBOForwardLight:hp,UBODeferredLight:_p,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:fp,UBOSkinningAnimation:dp,INST_JOINT_ANIM_INFO:pp,UBOSkinning:mp,UBOMorph:vp,UBOUILocal:gp,UNIFORM_JOINT_TEXTURE_BINDING:yp,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Ep,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Ap,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Ip,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Op,UNIFORM_SPRITE_TEXTURE_BINDING:Mp,UNIFORM_REFLECTION_TEXTURE_BINDING:Fp,UNIFORM_REFLECTION_STORAGE_BINDING:Gp,CAMERA_DEFAULT_MASK:jp,CAMERA_EDITOR_MASK:Xp,MODEL_ALWAYS_MASK:qp,supportsR16HalfFloatTexture:function(e){return(e.getFormatFeatures(vi.R16F)&(wi.RENDER_TARGET|wi.SAMPLED_TEXTURE))==(wi.RENDER_TARGET|wi.SAMPLED_TEXTURE)},supportsR32FloatTexture:Yp}));var Kp=4227858432,Qp=66060288,Zp=1044480,Jp=function(e,t,n,i){return void 0===i&&(i=0),t<<26&Kp|e<<20&Qp|n<<12&Zp|4095&i},$p=function(e){return(e&Kp)>>>26},em=function(e){return(e&Qp)>>>20},tm=function(e){return(e&Zp)>>>12},nm=function(e){return 4095&e},im=function(e,t){return 67108863&e|t<<26&Kp},rm=((Vp={})[yi.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Vp[yi.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Vp[yi.INT2]=function(e,t,n){return void 0===n&&(n=0),Jn.fromArray(t,e,n)},Vp[yi.INT3]=function(e,t,n){return void 0===n&&(n=0),Nn.fromArray(t,e,n)},Vp[yi.INT4]=function(e,t,n){return void 0===n&&(n=0),ni.fromArray(t,e,n)},Vp[yi.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Vp[yi.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Jn.fromArray(t,e,n)},Vp[yi.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),Nn.fromArray(t,e,n)},Vp[yi.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),ni.fromArray(t,e,n)},Vp[yi.MAT3]=function(e,t,n){return void 0===n&&(n=0),Fn.fromArray(t,e,n)},Vp[yi.MAT4]=function(e,t,n){return void 0===n&&(n=0),Yn.fromArray(t,e,n)},Vp),om=((Wp={})[yi.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Wp[yi.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Wp[yi.INT2]=function(e,t,n){return void 0===n&&(n=0),Jn.toArray(e,t,n)},Wp[yi.INT3]=function(e,t,n){return void 0===n&&(n=0),Nn.toArray(e,t,n)},Wp[yi.INT4]=function(e,t,n){return void 0===n&&(n=0),ni.toArray(e,t,n)},Wp[yi.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Wp[yi.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Jn.toArray(e,t,n)},Wp[yi.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),Nn.toArray(e,t,n)},Wp[yi.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),ni.toArray(e,t,n)},Wp[yi.MAT3]=function(e,t,n){return void 0===n&&(n=0),Fn.toArray(e,t,n)},Wp[yi.MAT4]=function(e,t,n){return void 0===n&&(n=0),Yn.toArray(e,t,n)},Wp),am=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function sm(e){switch(e){case yi.BOOL:case yi.INT:case yi.UINT:case yi.FLOAT:return am[0];case yi.BOOL2:case yi.INT2:case yi.UINT2:case yi.FLOAT2:return am[1];case yi.BOOL4:case yi.INT4:case yi.UINT4:case yi.FLOAT4:return am[2];case yi.MAT4:return am[3];case yi.SAMPLER2D:return"default-texture";case yi.SAMPLER_CUBE:return"default-cube-texture"}return am[0]}function cm(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var lm=new Yr;function um(e){return Math.ceil(Math.log2(Math.max(e,2)))}function hm(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function _m(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=function(e){var t=o.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&so))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var l=[],u=function(e){var t=o.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&co))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function fm(e){return e.members.reduce((function(e,t){return e+mo(t.type)*t.count}),0)}function dm(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function pm(e){switch(e.gfxAPI){case di.GLES2:case di.WEBGL:return"glsl1";case di.GLES3:case di.WEBGL2:return"glsl3";default:return"glsl4"}}var mm,vm,gm,ym,Sm,xm,Em,Tm,Cm=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=$({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=um(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=um(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Fr,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(fm(l)),s.bindings.push(new qr(l.binding,Ki.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new Ir(kd.MATERIAL,l.binding,l.name,l.members.map((function(e){return new wr(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new qr(h.binding,Ki.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Pr(kd.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<n.samplers.length;_++){var f=n.samplers[_];s.bindings.push(new qr(f.binding,Ki.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new Rr(kd.MATERIAL,f.binding,f.name,f.count))}for(var d=0;d<n.textures.length;d++){var p=n.textures[d];s.bindings.push(new qr(p.binding,Ki.TEXTURE,p.count,p.stageFlags)),s.shaderInfo.textures.push(new Or(kd.MATERIAL,p.binding,p.name,p.type,p.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new qr(v.binding,Ki.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Nr(kd.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new qr(y.binding,Ki.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new Dr(kd.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var S=0;S<n.subpassInputs.length;S++){var x=n.subpassInputs[S];s.bindings.push(new qr(x.binding,Ki.INPUT_ATTACHMENT,x.count,x.stageFlags)),s.shaderInfo.subpassInputs.push(new Mr(kd.MATERIAL,x.binding,x.name,x.count))}s.gfxAttributes=[];for(var E=0;E<n.attributes.length;E++){var T=n.attributes[E];s.gfxAttributes.push(new Br(T.name,T.format,T.isNormalized,0,T.isInstanced,T.location))}_m(n,s,Fd,"locals"),s.shaderInfo.stages.push(new Lr(Fi.VERTEX,"")),s.shaderInfo.stages.push(new Lr(Fi.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=Jp(i.binding,s.type,s.count,o),o+=(mo(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=Jp(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(lm.bindings=r.bindings,r.setLayouts[kd.MATERIAL]=e.createDescriptorSetLayout(lm),lm.bindings=Fd.bindings,r.setLayouts[kd.LOCAL]=e.createDescriptorSetLayout(lm)),r.setLayouts[n?kd.LOCAL:kd.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=t[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];A("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),_m(a,s,Bd,"globals"),s.setLayouts[kd.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new Qr(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=hm(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=pm(e);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,o=t.gfxAttributes,a=0;a<r.length;a++)dm(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());h.programLib=Cm;var Am=e("EffectAsset",Ic("cc.EffectAsset")((Tm=Em=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"techniques",gm,ae(t)),le(t,"shaders",ym,ae(t)),le(t,"combinations",Sm,ae(t)),le(t,"hideInEditor",xm,ae(t)),t}ee(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name]===e&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){Cm.register(this),t.register(this),h.game.once(h.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=h.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],o=0;o<i.length;++o){var a=$({},n);a[t]=i[o],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return Cm.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(Mu),Em._effects={},gm=ue((vm=Tm).prototype,"techniques",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ym=ue(vm.prototype,"shaders",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sm=ue(vm.prototype,"combinations",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xm=ue(vm.prototype,"hideInEditor",[Bc,zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mm=vm))||mm);h.EffectAsset=Am;var bm,wm,Im,Pm,Rm,Om,Dm,Nm,Mm,Lm,Bm,Fm,zm,Um,Gm,km=1024;!function(e){e[e.RGB565=vi.R5G6B5]="RGB565",e[e.RGB5A1=vi.RGB5A1]="RGB5A1",e[e.RGBA4444=vi.RGBA4]="RGBA4444",e[e.RGB888=vi.RGB8]="RGB888",e[e.RGB32F=vi.RGB32F]="RGB32F",e[e.RGBA8888=vi.RGBA8]="RGBA8888",e[e.RGBA32F=vi.RGBA32F]="RGBA32F",e[e.A8=vi.A8]="A8",e[e.I8=vi.L8]="I8",e[e.AI8=vi.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=vi.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=vi.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=km++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=vi.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=vi.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=km++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=vi.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=km++]="RGBA_ETC1",e[e.RGB_ETC2=vi.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=vi.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=vi.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=vi.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=vi.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=vi.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=vi.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=vi.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=vi.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=vi.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=vi.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=vi.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=vi.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=vi.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=vi.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=vi.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(bm||(bm={})),function(e){e[e.REPEAT=Oi.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Oi.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Oi.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Oi.BORDER]="CLAMP_TO_BORDER"}(wm||(wm={})),function(e){e[e.NONE=Ri.NONE]="NONE",e[e.LINEAR=Ri.LINEAR]="LINEAR",e[e.NEAREST=Ri.POINT]="NEAREST"}(Im||(Im={})),ht(vi);var Hm,Vm,Wm,jm,Xm=new ge("Tex"),qm=Ic("cc.TextureBase")((Gm=Um=function(e){function t(){var t;return le(t=e.call(this)||this,"_format",Om,ae(t)),le(t,"_minFilter",Dm,ae(t)),le(t,"_magFilter",Nm,ae(t)),le(t,"_mipFilter",Mm,ae(t)),le(t,"_wrapS",Lm,ae(t)),le(t,"_wrapT",Bm,ae(t)),le(t,"_wrapR",Fm,ae(t)),le(t,"_anisotropy",zm,ae(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new br,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=Xm.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=bo(t._id,666),t}ee(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=h.director.root)||void 0===t?void 0:t.batcher2D)&&h.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):M(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return h.director.root?h.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?bm.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===bm.RGBA_ETC1?e=bm.RGB_ETC1:e===bm.RGB_A_PVRTC_4BPPV1?e=bm.RGB_PVRTC_4BPPV1:e===bm.RGB_A_PVRTC_2BPPV1&&(e=bm.RGB_PVRTC_2BPPV1),e},J(t,[{key:"isCompressed",get:function(){return this._format>=bm.RGB_ETC1&&this._format<=bm.RGBA_ASTC_12x12||this._format>=bm.RGB_A_PVRTC_2BPPV1&&this._format<=bm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(Mu),Um.PixelFormat=bm,Um.WrapMode=wm,Um.Filter=Im,Om=ue((Rm=Gm).prototype,"_format",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bm.RGBA8888}}),Dm=ue(Rm.prototype,"_minFilter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Im.LINEAR}}),Nm=ue(Rm.prototype,"_magFilter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Im.LINEAR}}),Mm=ue(Rm.prototype,"_mipFilter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Im.NONE}}),Lm=ue(Rm.prototype,"_wrapS",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wm.REPEAT}}),Bm=ue(Rm.prototype,"_wrapT",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wm.REPEAT}}),Fm=ue(Rm.prototype,"_wrapR",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wm.REPEAT}}),zm=ue(Rm.prototype,"_anisotropy",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pm=Rm))||Pm;function Ym(e){return!!(h.sys.hasFeature(h.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}h.TextureBase=qm;var Km=e("ImageAsset",Ic("cc.ImageAsset")((jm=Wm=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=bm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}ee(t,e);var n=t.prototype;return n.reset=function(e){Ym(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Ym(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var i,r=h.director.root?h.director.root.device:null,o=n.split("_"),a=Number.MAX_VALUE,s=this._format,c="",l=h.macro.SUPPORT_TEXTURE_FORMATS,u=ce(o);!(i=u()).done;){var _=i.value.split("@"),f=parseInt(_[0],void 0),d=t.extnames[f]||_[0],p=l.indexOf(d);if(-1!==p&&p<a){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==d||r&&r.getFormatFeatures(vi.ASTC_RGBA_4X4)&wi.SAMPLED_TEXTURE))continue;if(!(".pvr"!==d||r&&r.getFormatFeatures(vi.PVRTC_RGBA4)&wi.SAMPLED_TEXTURE))continue;if(!(m!==bm.RGB_ETC1&&m!==bm.RGBA_ETC1||r&&r.getFormatFeatures(vi.ETC_RGB8)&wi.SAMPLED_TEXTURE))continue;if(!(m!==bm.RGB_ETC2&&m!==bm.RGBA_ETC2||r&&r.getFormatFeatures(vi.ETC2_RGB8)&wi.SAMPLED_TEXTURE))continue;if(".webp"===d&&!h.sys.hasFeature(h.sys.Feature.WEBP))continue;a=p,c=d,s=m}}c?(this._setRawAsset(c),this._format=s):D(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},J(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||Ym(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Ym(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=bm.RGB_ETC1&&this._format<=bm.RGBA_ASTC_12x12||this._format>=bm.RGB_A_PVRTC_2BPPV1&&this._format<=bm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(Mu),Wm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Wm._sharedPlaceHolderCanvas=null,ue((Vm=jm).prototype,"_nativeAsset",[fl],Object.getOwnPropertyDescriptor(Vm.prototype,"_nativeAsset"),Vm.prototype),Hm=Vm))||Hm);h.ImageAsset=Km;var Qm=new WeakMap,Zm=new WeakSet,Jm=new WeakSet;function $m(e,t){var n;n=rh.safeFindClass;var i,r=bh.pool.get();try{i=zh(e,r,{classFinder:n,customEnv:t})}catch(e){throw T(e),bh.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:Ul(h),owner:a[u],prop:s[u],type:ot._getClassById(c[u])}}return Qm.set(i,l),i._native&&Zm.add(i),bh.pool.put(r),i}var ev,tv=new(function(){function e(){this._depends=new El}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?$({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof dh){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var o=$m(t,{__uuid__:e});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=e),wl.add(e+"@import",o)}catch(t){bl.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=Qm.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Zm.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=Ul(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,n.push(o),this._descend(o,t,n))}},e}()),nv=[new fr];function iv(e){return e&&0==(e&e-1)}var rv,ov,av,sv,cv,lv,uv=Ic("cc.SimpleTexture")(ev=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._gfxTextureView=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t._baseLevel=0,t._maxLevel=1e3,t}ee(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTextureView},n.destroy=function(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=nv[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,nv):i.copyTexImagesToTexture([e],this._gfxTexture,nv)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),ft.CLEANUP_IMAGE_CACHE)){var r=tv.getDeps(this._uuid),o=r.indexOf(e._uuid);-1!==o&&(fe(r,o),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._setMipRange=function(e,t){this._baseLevel=e<1?0:e,this._maxLevel=t<1?0:t},n.setMipRange=function(e,t){F(e<=t,3124),this._setMipRange(e,t);var n=this._getGFXDevice();if(n){var i=this._createTextureView(n);this._tryDestroyTextureView(),this._gfxTextureView=i}},n._getGfxTextureCreateInfo=function(){return null},n._getGfxTextureViewCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&(this._createTexture(e),this._gfxTextureView=this._createTextureView(e))}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=bi.NONE;this._mipFilter!==Im.NONE&&function(e,t,n){return!(e.gfxAPI===di.WEBGL)||iv(t)&&iv(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=bi.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Ai.SAMPLED|Ai.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._createTextureView=function(e){if(!this._gfxTexture)return null;var t=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,n=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:t-this._baseLevel+1});return n?e.createTexture(n):null},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},n._tryDestroyTextureView=function(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)},J(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(qm))||ev;h.SimpleTexture=uv;var hv,_v,fv,dv,pv,mv,vv,gv=e("Texture2D",(rv=Ic("cc.Texture2D"),ov=hl([Km]),rv((lv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",cv,ae(t)),t}ee(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var n=void 0===e.baseLevel?0:e.baseLevel,i=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(n,i),this._tryReset()},n.create=function(e,t,n,i,r,o){void 0===n&&(n=bm.RGBA8888),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=1e3),this.reset({width:e,height:t,format:n,mipmapLevel:i,baseLevel:r,maxLevel:o})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Km,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,ot._getClassId(Km))}},n._getGfxTextureCreateInfo=function(e){var t=new Cr(Ci.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e),t},n._getGfxTextureViewCreateInfo=function(e){var t=new Ar;return t.type=Ci.TEX2D,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Km;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},J(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(uv),cv=ue((sv=lv).prototype,"_mipmaps",[ov],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),av=sv))||av));h.Texture2D=gv,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(vv||(vv={}));var yv=e("TextureCube",Ic("cc.TextureCube")((mv=pv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",fv,ae(t)),le(t,"_mipmaps",dv,ae(t)),t}ee(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+vv.front].image,back:e[a+vv.back].image,left:e[a+vv.left].image,right:e[a+vv.right].image,top:e[a+vv.top].image,bottom:e[a+vv.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var n=void 0===e.baseLevel?0:e.baseLevel,i=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(n,i),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;Sv(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Km,back:new Km,left:new Km,right:new Km,top:new Km,bottom:new Km};var o=i.mipmaps[r],a=ot._getClassId(Km);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new Cr(Ci.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n._getGfxTextureViewCreateInfo=function(e){var t=new Ar;return t.type=Ci.CUBE,t.baseLayer=0,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Km;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},J(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,n){Sv(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(uv),pv.FaceIndex=vv,fv=ue((_v=mv).prototype,"isRGBE",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dv=ue(_v.prototype,"_mipmaps",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hv=_v))||hv);function Sv(e,t){t(e.front,vv.front),t(e.back,vv.back),t(e.left,vv.left),t(e.right,vv.right),t(e.top,vv.top),t(e.bottom,vv.bottom)}h.TextureCube=yv;var xv,Ev,Tv,Cv=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:3642336485,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:54,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"geometry-renderer",techniques:[{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]}],shaders:[{name:"geometry-renderer|line-vs:vert|line-fs:front",hash:3617431e3,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|line-vs:vert|line-fs:back",hash:4168905198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",hash:4034582016,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",hash:1762165009,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:front",hash:4143142643,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:back",hash:826026446,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:4284763886,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:851293782,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2502358098,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:585841727,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:2499219289,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:67215139,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},specularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrength:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4079105024,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:223,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14},{name:"a_texCoord1",defines:[],format:21,location:15}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3928335406,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:184,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3669699677,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:71,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:71},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:2218105608,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:69,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3152709001,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:198,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:837263906,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:682261797,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3663548873,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:670444562,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:2587574837,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:69},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2},{name:"depth_stencil",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3542426468,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:217,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:2960965003,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:2207113861,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),Av={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\nuniform highp vec4 cc_localShadowBias;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragData[2];\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout lowp vec4 v_color;\n#endif\nout vec3 v_position;\nout mediump vec3 v_normal;\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nout mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nout mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin vec3 v_position;\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin mediump vec2 v_uv1;\n#endif\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout vec2 v_uv1;\n#endif\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin vec2 v_uv1;\n#endif\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nout vec2 v_shadowBias;\n#endif\nout highp vec3 v_position;\nout mediump vec3 v_normal;\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin vec2 v_shadowBias;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\nfloat depth = texture(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\nfloat depth = texture(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},bv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=0,l=0;l<4;l++)i[c]=0,i[c+1]=0,i[c+2]=0,i[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,o[c]=119,o[c+1]=119,o[c+2]=119,o[c+3]=255,a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;var u=new Uint8Array(1024);c=0;for(var _=0;_<256;_++)u[c]=221,u[c+1]=221,u[c+2]=221,u[c+3]=255,c+=4;c=0;for(var f=0;f<8;f++){for(var d=0;d<8;d++)u[c]=85,u[c+1]=85,u[c+2]=85,u[c+3]=255,c+=4;c+=32}c+=32;for(var p=0;p<8;p++){for(var m=0;m<8;m++)u[c]=85,u[c+1]=85,u[c+2]=85,u[c+3]=255,c+=4;c+=32}var v={width:2,height:2,_data:i,_compressed:!1,format:gv.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:gv.PixelFormat.RGBA8888},y={width:2,height:2,_data:o,_compressed:!1,format:gv.PixelFormat.RGBA8888},S={width:2,height:2,_data:a,_compressed:!1,format:gv.PixelFormat.RGBA8888},x={width:2,height:2,_data:s,_compressed:!1,format:gv.PixelFormat.RGBA8888},E={width:16,height:16,_data:u,_compressed:!1,format:gv.PixelFormat.RGBA8888},T=new Km(v),C=new gv;C._uuid="black-texture",C.image=T,n[C._uuid]=C;var A=new Km(g),b=new gv;b._uuid="empty-texture",b.image=A,n[b._uuid]=b;var w=new yv;w._uuid="black-cube-texture",w.setMipFilter(yv.Filter.NEAREST),w.image={front:new Km(v),back:new Km(v),left:new Km(v),right:new Km(v),top:new Km(v),bottom:new Km(v)},n[w._uuid]=w;var I=new Km(y),P=new gv;P._uuid="grey-texture",P.image=I,n[P._uuid]=P;var R=new Km(S),O=new gv;O._uuid="white-texture",O.image=R,n[O._uuid]=O;var D=new yv;D._uuid="white-cube-texture",D.setMipFilter(yv.Filter.NEAREST),D.image={front:new Km(S),back:new Km(S),left:new Km(S),right:new Km(S),top:new Km(S),bottom:new Km(S)},n[D._uuid]=D;var N=new Km(x),M=new gv;M._uuid="normal-texture",M.image=N,n[M._uuid]=M;var L=new Km(E),B=new gv;B._uuid="default-texture",B.image=L,n[B._uuid]=B;var F=new yv;if(F.setMipFilter(yv.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new Km(E),back:new Km(E),left:new Km(E),right:new Km(E),top:new Km(E),bottom:new Km(E)},n[F._uuid]=F,h.SpriteFrame){var z=new h.SpriteFrame,U=T,G=new gv;G.image=U,z.texture=G,z._uuid="default-spriteframe",n[z._uuid]=z}var k=pm(e);if(!k)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=Av[k];return H?Promise.resolve().then((function(){Cv.forEach((function(e,t){var n=Object.assign(new h.EffectAsset,e);n.shaders.forEach((function(e,n){var i=H[t][n];i&&(e[k]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+k+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new h.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new h.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",h.color("#ffff00")),e[i._uuid]=i,t.push(i);var r=new h.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",h.color("#ff00ff")),e[r._uuid]=r,t.push(r);var o=new h.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[o._uuid]=o,t.push(o);var a=new h.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[a._uuid]=a,t.push(a);var s=new h.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new h.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new h.Material;l._uuid="ui-sprite-gray-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new h.Material;u._uuid="ui-sprite-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var _=new h.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_,t.push(_);var f=new h.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),e[f._uuid]=f,t.push(f);var d=new h.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),e[d._uuid]=d,t.push(d);var p=new h.Material;p._uuid="default-particle-gpu-material",p.initialize({effectName:"particle-gpu"}),e[p._uuid]=p,t.push(p);var m=new h.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new h.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new h.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),h.game.on(h.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),wv=e("builtinResMgr",h.builtinResMgr=new bv),Iv=e("getPhaseID",(xv=new Map,Ev=0,function(e){return"number"==typeof e?e:(xv.has(e)||(xv.set(e,1<<Ev),Ev++),xv.get(e))})),Pv=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var o=e.inputAssembler,a=e.descriptorSet.getTexture(Op),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,32*r,r)),d=new Uint8Array(32*r),p=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],S=new Br(y.name,y.format,y.isNormalized,p.length,!0);m.push(S)}d.set(t.buffer),p.push(f);var x=new zr(m,p,v),E=this._device.createInputAssembler(x);this.instances.push({count:1,capacity:32,vb:f,data:d,ia:E,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),Rv=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<up.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var d=0;d<_.vbs.length;++d){var p=i[d],m=_.vbs[d],v=_.vbDatas[d];(r=(a+_.vbCount)*p.stride)>m.size&&(m.resize(r),_.vbDatas[d]=new Uint8Array(r),_.vbDatas[d].set(v)),_.vbDatas[d].set(p.buffer,_.vbCount*p.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,S=y+a,x=_.mergeCount;if(g[y]!==x||g[S-1]!==x)for(var E=y;E<S;E++)g[E]=x+.1;return Yn.toArray(_.uboData,n.transform.worldMatrix,up.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(up.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var T=[],C=[],A=[],b=0;b<i.length;++b){var w=i[b],I=this._device.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,w.count*w.stride,w.stride));I.update(w.buffer.buffer),T.push(I),C.push(new Uint8Array(I.size)),A.push(I)}var P=this._device.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),P.update(R),A.push(P);for(var O=e.inputAssembler.attributes,D=new Array(O.length+1),N=0;N<O.length;++N)D[N]=O[N];D[O.length]=new Br("a_dyn_batch_id",vi.R32F,!1,i.length);var M=new zr(D,A),L=this._device.createInputAssembler(M),B=this._device.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,up.SIZE,up.SIZE));l.bindBuffer(up.BINDING,B),l.update();var F=new Float32Array(up.COUNT);Yn.toArray(F,n.transform.worldMatrix,up.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:T,vbDatas:C,vbIdx:P,vbIdxData:R,vbCount:a,ia:L,ubo:B,uboData:F,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),Ov=new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.DEVICE),Dv=new Sr(null),Nv=new Kr(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(Tv||(Tv={}));var Mv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Mo,this._dss=new Do,this._rs=new Oo,this._priority=Od.DEFAULT,this._stage=Rd.DEFAULT,this._phase=Iv("default"),this._primitive=Vi.TRIANGLE_LIST,this._batchingScheme=Tv.NONE,this._dynamicStates=qi.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(Iv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=Cm.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=ce(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),bo(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=yi.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=im(i,n):t&&(i=im(i,$p(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);om[r](a,n,o),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);return rm[r](a,n,o)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=mo(r)>>2,a=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&om[r](a,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):M(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new Pv(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new Rv(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||sm(i),u=(mo(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":sm(r),l=wv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Uo.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],o=this._getBlockView(r.type,t.binding),a=this._properties[r.name],s=a&&a.value||sm(r.type),c=(mo(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=Cm.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(Cm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=Cm.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Od.DEFAULT),this._setStage(Rd.DEFAULT),this._setPhase(Iv("default")),this._setPrimitive(Vi.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?$({},t.defines):t.defines,this._shaderInfo=Cm.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),Nv.layout=Cm.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(Nv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Cm.getTemplateInfo(t.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=a[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var d=l[l.length-1]+u;d&&(Ov.size=16*Math.ceil(d/16),this._rootBuffer=i.createBuffer(Ov),this._rootBlock=new ArrayBuffer(d));for(var p=0,m=0;p<r.length;p++){var v=r[p].binding,g=a[p];Dv.buffer=this._rootBuffer,Dv.offset=l[m++],Dv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Dv);this._blocks[v]=new Float32Array(this._rootBlock,Dv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var S=this._propertyHandleMap=s,x={};for(var E in this._properties){var T=this._properties[E];T.handleInfo&&(x[E]=this.getHandle.apply(this,T.handleInfo))}Object.assign(S,x)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(mi.INSTANCED_ARRAYS)?this._setBatchingScheme(Tv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Tv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Tv.VB_MERGING):this._setBatchingScheme(Tv.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<yi.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(Cm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},J(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Cm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();Mv.getTypeFromHandle=$p,Mv.getBindingFromHandle=em,Mv.getCountFromHandle=tm,Mv.getOffsetFromHandle=nm;var Lv=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var o=t.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=t.pipelineLayout,c=new Zr(r.attributes),l=new Lo(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},e}());Lv._PSOHashMap=new Map;var Bv=new dr,Fv=new sr;function zv(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var Uv,Gv,kv,Hv,Vv,Wv,jv,Xv,qv,Yv,Kv=null;function Qv(e,t,n,i,r){if(i&&i.enabled&&r===Kv){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;Bv.width=Fv.width=r.window.width,Bv.height=Fv.height=r.window.height;var u=Lv.getOrCreatePipelineState(e,s[0],c[0],t,a);n.setViewport(Bv),n.setScissor(Fv),n.bindPipelineState(u),n.bindDescriptorSet(kd.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(kd.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Zv,Jv,$v,eg,tg,ng=new ni,ig=e("Material",(Uv=Ic("cc.Material"),Gv=hl(Am),Uv((Yv=function(e){function t(){var t;return le(t=e.call(this)||this,"_effectAsset",Vv,ae(t)),le(t,"_techIdx",Wv,ae(t)),le(t,"_defines",jv,ae(t)),le(t,"_states",Xv,ae(t)),le(t,"_props",qv,ae(t)),t._passes=[],t._hash=0,t}ee(t,e),t.getHash=function(e){for(var t,n=0,i=ce(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?D(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=ce(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var n=0;n<e._props.length;n++)this._props[n]=$({},e._props[n]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=$({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=$({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},n._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=Am.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],o=r.passIndex=i,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new Mv(h.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(Mv.getTypeFromHandle(i)<yi.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var o=n;zv(ng,o),ng.w=o.w,n=ng}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(e,i,n[a],a);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=Mv.getBindingFromHandle(t);if(n instanceof ko)e.bindTexture(r,n,i);else if(n instanceof qm){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=ce(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new On("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},J(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(Mu),Vv=ue((Hv=Yv).prototype,"_effectAsset",[Gv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wv=ue(Hv.prototype,"_techIdx",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jv=ue(Hv.prototype,"_defines",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xv=ue(Hv.prototype,"_states",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qv=ue(Hv.prototype,"_props",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kv=Hv))||kv));h.Material=ig,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Zv||(Zv={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(Jv||(Jv={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}($v||($v={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(eg||(eg={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(tg||(tg={}));var rg=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],og=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],ag=[100,200,400,800],sg=new Nn,cg=new Nn,lg=new Yn,ug=$i.STENCIL<<1,hg=[],_g=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Zv.VERTICAL,this._fov=pn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new pr(.2,.2,.2,1),this._viewport=new si(0,0,1,1),this._orientedViewport=new si(0,0,1,1),this._curTransform=pi.IDENTITY,this._isProjDirty=!0,this._matView=new Yn,this._matProj=new Yn,this._matProjInv=new Yn,this._matViewProj=new Yn,this._matViewProjInv=new Yn,this._frustum=new hc,this._forward=new Nn,this._position=new Nn,this._priority=0,this._aperture=$v.F16_0,this._apertureValue=void 0,this._shutter=tg.D125,this._shutterValue=0,this._iso=eg.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=$i.NONE,this._clearDepth=1,this._visibility=jp,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=rg[this._aperture],this._shutterValue=og[this._shutter],this._isoValue=ag[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!hg.length){var t=e.capabilities.clipSpaceSignY;hg[pi.IDENTITY]=new Yn(1,0,0,0,0,t),hg[pi.ROTATE_90]=new Yn(0,1,0,0,-t,0),hg[pi.ROTATE_180]=new Yn(-1,0,0,0,0,-t),hg[pi.ROTATE_270]=new Yn(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||pi.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t._destroy=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=$i.NONE,this.clearDepth=1,this.visibility=jp,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t.destroy=function(){this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(Yn.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||pi.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===Jv.PERSPECTIVE)Yn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Zv.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Yn.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Yn.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Yn.multiply(this._matViewProj,this._matProj,this._matView),Yn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,o=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||pi.IDENTITY){case pi.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case pi.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case pi.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case pi.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||h.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||pi.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===Jv.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=qn[this._curTransform];Nn.set(sg,(t-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=sg.x,f=sg.y;return sg.x=_*h[0]+f*h[2]*u,sg.y=_*h[1]+f*h[3]*u,Nn.transformMat4(l?sg:e.o,sg,this._matViewProjInv),l?(this._node.getWorldPosition(cg),ca.fromPoints(e,cg,sg)):Nn.transformQuat(e.d,Nn.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=qn[this._curTransform];if(this._proj===Jv.PERSPECTIVE){Nn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,Nn.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(sg),Nn.lerp(e,sg,e,dn(this._nearClip/this._farClip,1,t.z))}else{Nn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*l[0]+f*l[2]*c,e.y=_*l[1]+f*l[3]*c,Nn.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=qn[this._curTransform];Nn.transformMat4(e,t,this._matViewProj);var r=e.x,o=e.y;e.x=r*i[0]+o*i[2]*n,e.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){Yn.multiply(e,this._matViewProj,t),Yn.multiply(e,hg[this._curTransform],e);var r=n/2,o=i/2;return Yn.identity(lg),Yn.transform(lg,lg,Nn.set(sg,r,o,0)),Yn.scale(lg,lg,Nn.set(sg,r,o,1)),Yn.multiply(e,lg,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},J(e,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=rg[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=og[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=ag[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(e){D(8302),this.setViewportInOrientedSpace(e)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),fg=ct({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),dg=ct({Planar:0,ShadowMap:1}),pg=ct({HARD:0,SOFT:1,SOFT_2X:2}),mg=dg.ShadowMap+1,vg=function(){function e(){this.fixedSphere=new pa(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Yn,this.matShadowProj=new Yn,this.matShadowViewProj=new Yn,this._enabled=!1,this._type=mg,this._distance=0,this._normal=new Nn(0,1,0),this._shadowColor=new On(0,0,0,76),this._size=new Jn(512,512),this._shadowMapDirty=!1,this._matLight=new Yn,this._material=null,this._instancingMaterial=null}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new ig,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new ig,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:mg},t.initialize=function(e){this._setEnable(e.enabled),this._setType(e.type),this.normal=e.planeDirection,this.distance=e.planeHeight,this.shadowColor=e.shadowColor,this.maxReceived=e.maxReceived,this.size=e.size},t.activate=function(){this.enabled&&this.type===dg.Planar&&this._updatePlanarInfo()},t._updatePlanarInfo=function(){this._material||(this._material=new ig,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new ig,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){Nn.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();vg.MAX_FAR=2e3,vg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),h.Shadows=vg;var gg=new Nn,yg=(new Nn,new Nn,new Nn),Sg=new Yn,xg=new $s,Eg=new $s,Tg=!1,Cg=pa.create(0,0,0,1),Ag=new pa,bg=new hc;bg.accurate=!0;var wg=new hc;wg.accurate=!0;var Ig=new hc,Pg=new Yn,Rg=new Yn,Og=new Yn,Dg=new Yn,Ng=new Yn,Mg=new Yn,Lg=new Yn,Bg=new Nn,Fg=new Jn,zg=new Nn,Ug=new Nn,Gg=new Nn(0,0,0),kg=(new $s,new Kl((function(){return{model:null,depth:0}}),128)),Hg=new Kl((function(){return{model:null,depth:0}}),128),Vg=new Kl((function(){return{model:null,depth:0}}),128);function Wg(e,t){var n=0;e.node&&(Nn.subtract(gg,e.node.worldPosition,t.position),n=Nn.dot(gg,t.forward));var i=kg.alloc();return i.model=e,i.depth=n,i}function jg(e,t){var n=0;e.node&&(Nn.subtract(gg,e.node.worldPosition,t.position),n=Nn.dot(gg,t.forward));var i=Hg.alloc();return i.model=e,i.depth=n,i}function Xg(e,t){var n=0;e.node&&(Nn.subtract(gg,e.node.worldPosition,t.position),n=Nn.dot(gg,t.forward));var i=Vg.alloc();return i.model=e,i.depth=n,i}function qg(e,t,n){var i=t.direction,r=e.normal,o=e.distance+.001,a=1/Nn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,Yn.toArray(n,f,Yd.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Yg(e,t){Nn.normalize(gg,e.normal),t[Yd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=gg.x,t[Yd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=gg.y,t[Yd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=gg.z,t[Yd.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function Kg(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(pa.set(Cg,o.position.x,o.position.y,o.position.z,o.range),ys.sphereFrustum(Cg,t.frustum)&&n.push(o))}for(var a=t.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(pa.set(Cg,c.position.x,c.position.y,c.position.z,c.range),ys.sphereFrustum(Cg,t.frustum)&&n.push(c))}}function Qg(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;kg.freeArray(s),s.length=0;var c=r.castShadowObjects;Vg.freeArray(c),c.length=0,Tg=!1;var l=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(Yd.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===dg.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,Hg.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var o=t.device;if(n.shadowFixedArea){var a=n.shadowOrthoSize,s=n.shadowOrthoSize,c=n.shadowNear,l=n.shadowFar;Yn.fromRT(Pg,n.node.getWorldRotation(),n.node.getWorldPosition()),Yn.invert(Rg,Pg),Yn.ortho(Dg,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),Yn.multiply(Ng,Dg,Rg),Yn.invert(Og,Rg),r.matShadowView=Rg,r.matShadowProj=Dg,r.matShadowViewProj=Ng,hc.createOrtho(e,2*a,2*s,c,l,Og)}else{var u=n.shadowInvisibleOcclusionRange,h=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();Yn.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(Sg,i),hc.split(bg,i,Sg,.1,n.shadowDistance),wg=hc.clone(bg),Yn.fromRT(Pg,n.node.rotation,Gg),Yn.invert(Rg,Pg),Yn.invert(Og,Rg);var _=Rg.clone();wg.transform(Rg),$s.fromPoints(xg,new Nn(1e7,1e7,1e7),new Nn(-1e7,-1e7,-1e7)),xg.mergeFrustum(wg);var f=2*xg.halfExtents.z;yg.set(xg.center.x,xg.center.y,xg.center.z+xg.halfExtents.z+u),Nn.transformMat4(yg,yg,Og),Yn.fromRT(Pg,n.node.rotation,yg),Yn.invert(Rg,Pg),Yn.invert(Og,Rg);var d=Nn.distance(bg.vertices[0],bg.vertices[6]);Ag.center.set(0,0,0),Ag.radius=-1,Ag.mergePoints(bg.vertices);var p=.8*d+.4*Ag.radius;r.shadowCameraFar=f+u;var m=.5*p;if(Yn.ortho(Dg,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){Yn.multiply(Mg,Dg,_),Nn.transformMat4(Bg,yg,Mg);var v=2/h;Fg.set(v,v);var g=Bg.x%Fg.x,y=Bg.y%Fg.y;zg.set(Bg.x-g,Bg.y-y,Bg.z),Yn.invert(Lg,Mg),Nn.transformMat4(Ug,zg,Lg),Yn.fromRT(Pg,n.node.rotation,Ug),Yn.invert(Rg,Pg),Yn.invert(Og,Rg),hc.createOrtho(e,p,p,.1,r.shadowCameraFar,Og)}else{for(var S=0;S<8;S++)e.vertices[S].set(0,0,0);e.updatePlanes()}Yn.multiply(Ng,Dg,Rg),r.matShadowView=Rg,r.matShadowProj=Dg,r.matShadowViewProj=Ng}}(Ig,e,i,t,o);else{for(var u=0;u<8;u++)Ig.vertices[u].set(0,0,0);Ig.updatePlanes()}i&&o.type===dg.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,o=n.distance+.001,a=1/Nn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,e.pipelineUBO.updateShadowUBORange(Yd.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&ug&&s.push(Wg(a.model,t));for(var h=n.models,_=t.visibility,f=0;f<h.length;f++){var d=h[f];if(d.enabled&&(d.castShadow&&c.push(Xg(d,t)),o.firstSetCSM&&d.worldBounds&&(Tg||(Eg.copy(d.worldBounds),Tg=!0),$s.merge(Eg,Eg,d.worldBounds)),d.node&&(_&d.node.layer)===d.node.layer||_&d.visFlags)){if(null!=l&&d.castShadow&&d.worldBounds&&ys.aabbFrustum(d.worldBounds,Ig)&&l.push(jg(d,t)),d.worldBounds&&!ys.aabbFrustum(d.worldBounds,t.frustum))continue;s.push(Wg(d,t))}}}var Zg,Jg=new br(Ri.LINEAR,Ri.LINEAR,Ri.NONE,Oi.CLAMP,Oi.CLAMP,Oi.CLAMP),$g=new br(Ri.POINT,Ri.POINT,Ri.NONE,Oi.CLAMP,Oi.CLAMP,Oi.CLAMP),ey=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(Jg),this._pointSampler=this._device.getSampler($g);var t=new Yr(Bd.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new Kr(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new Kr(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=Ld.UBO_GLOBAL;r<Ld.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=t.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,Yd.SIZE,Yd.SIZE));i.bindBuffer(Yd.BINDING,o),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},J(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),ty=0,ny={},iy=new Kr(null),ry=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Od.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var i=h.director.root;this._device=i.device,iy.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(iy);var r=h.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Kr(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===Tv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Od.DEFAULT,t[0].phase===Iv("reflection")){var a=i.mainWindow.width,s=i.mainWindow.height,c=512;s<a?(a=c*a/s,s=c):s=c*s/(a=c),this._reflectionTex=this._device.createTexture(new Cr(Ci.TEX2D,Ai.STORAGE|Ai.TRANSFER_SRC|Ai.SAMPLED,vi.RGBA8,a,s)),this.descriptorSet.bindTexture(Fp,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new br(Ri.LINEAR,Ri.LINEAR,Ri.NONE,Oi.CLAMP,Oi.CLAMP,Oi.CLAMP)),this.descriptorSet.bindSampler(Fp,this._reflectionSampler),this.descriptorSet.bindTexture(Gp,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=h.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=h.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Od.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},J(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?M(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===Tv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),iy.layout=e[0].localSetLayout,this._createDescriptorSet(iy)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===Tv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),oy=new Yn,ay=[{name:"CC_RECEIVE_SHADOW",value:!0}],sy=[{name:"CC_USE_LIGHTMAP",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Zg||(Zg={}));var cy=new br(Ri.LINEAR,Ri.LINEAR,Ri.NONE,Oi.CLAMP,Oi.CLAMP,Oi.CLAMP),ly=new br(Ri.LINEAR,Ri.LINEAR,Ri.LINEAR,Oi.CLAMP,Oi.CLAMP,Oi.CLAMP),uy=function(){function e(){this.type=Zg.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(sp.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new ni,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._shadowBias=0,this._shadowNormalBias=0,this._enabled=!0,this._visFlags=Pd.Enum.NONE,this._device=h.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Pd.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Yn.toArray(this._localData,i,sp.MAT_WORLD_OFFSET),Yn.inverseTranspose(oy,i);var a=Math.abs(Yn.determinant(oy)),s=1/Math.sqrt(a);Yn.multiplyScalar(oy,oy,s),Yn.toArray(this._localData,oy,sp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=$s.fromPoints($s.create(),e,t),this._worldBounds=$s.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new ry},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){ni.toArray(this._localData,t,sp.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,this.onMacroPatchesStateChanged(),null===e&&(e=wv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?ly:cy),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Op,n),a.bindSampler(Op,i),a.update()}},t.updateLocalShadowBias=function(){var e=this._localData;e[sp.LOCAL_SHADOW_BIAS+0]=this._shadowBias,e[sp.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,e[sp.LOCAL_SHADOW_BIAS+2]=0,e[sp.LOCAL_SHADOW_BIAS+3]=0,this._localDataUpdated=!0},t.getMacroPatches=function(){var e=this.receiveShadow?ay:null;return null!=this._lightmap&&(e=e?e.concat(sy):sy),e},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(mi.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=ao[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new Br;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=ao[c.format],h=new(vo(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}t.batchingScheme===Tv.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(lp)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.DEVICE,sp.SIZE,sp.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.DEVICE,cp.SIZE,cp.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(sp.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(cp.BINDING,this._worldBoundBuffer)},J(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),hy=function(){function e(){this._groundAlbedoHDR=new ni(.2,.2,.2,1),this._skyColorHDR=new ni(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new ni(.2,.2,.2,1),this._skyColorLDR=new ni(.2,.5,.8,1),this._skyIllumLDR=0,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();hy.SUN_ILLUM=65e3,hy.SKY_ILLUM=2e4,h.Ambient=hy;var _y=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return e.prototype.tryCompile.call(ae(i)),i}ee(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Mv.fillPipelineInfo(this,e),Mv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!cm(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Tv.NONE)},n._onStateChange=function(){this._setHash(Mv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},J(t,[{key:"parent",get:function(){return this._parent}}]),t}(Mv),fy=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}ee(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=ce(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=ig.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new _y(t[n],this));return e},J(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(ig),dy=null,py=null,my=ct({HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2}),vy=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=h.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=wv.get("default-cube-texture"),this._model||(this._model=h.director.root.createModel(h.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!py){var n=new ig;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),py=new fy({parent:n})}this.enabled&&(dy||(dy=h.utils.createMesh(h.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,dy.renderingSubMeshes[0],py)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=h.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===i&&t.macros.CC_USE_HDR===r||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=i,t.macros.CC_USE_HDR=r,e.onGlobalPipelineStateChanged()),this.enabled&&py&&py.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,py)},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=h.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),i=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(Jd,i),this._globalDSManager.bindTexture(Jd,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=e.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(tp,a),this._globalDSManager.bindTexture(tp,o)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},J(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();h.Skybox=vy;var gy=new ni,yy=ct({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),Sy=yy.LAYERED+1,xy=function(){function e(){this._fogColor=new On("#C8C8C8"),this._colorArray=new ni(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:Sy},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=h.director.root,t=this.enabled?this.type:Sy,n=this.accurate?1:0,i=e.pipeline;i.macros.CC_USE_FOG===t&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=t,i.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=Sy,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),gy.set(e.x,e.y,e.z,e.w),zv(this._colorArray,gy)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();h.Fog=xy;var Ey,Ty,Cy,Ay=function(){function e(){this._enabled=!1,this._minPos=new Nn(0,0,0),this._maxPos=new Nn(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();function by(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Ey||(Ey=e("NodeSpace",{}))),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(Ty||(Ty=e("TransformBit",{}))),h.internal.TransformBit=Ty,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Cy||(Cy={}));var wy,Iy,Py=function(e){return 4*Math.PI*Math.PI*e*e},Ry=function(){function e(){this._baked=!1,this._color=new Nn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new Nn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Cy.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new Nn(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},J(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,by(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=Ty.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Oy=new Nn(0,0,-1),Dy=new Nn,Ny=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new Nn(1,-1,-1),t._illuminanceHDR=hy.SUN_ILLUM,t._illuminanceLDR=1,t._shadowEnabled=!1,t._shadowPcf=pg.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._shadowSaturation=1,t._shadowDistance=100,t._shadowInvisibleOcclusionRange=200,t._shadowFixedArea=!1,t._shadowNear=.1,t._shadowFar=10,t._shadowOrthoSize=5,t._type=Cy.DIRECTIONAL,t}ee(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=hy.SUN_ILLUM,this.direction=new Nn(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=Nn.transformQuat(Dy,Oy,this._node.worldRotation))},J(t,[{key:"direction",get:function(){return this._dir},set:function(e){Nn.normalize(this._dir,e)}},{key:"illuminance",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,vg.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,vg.MAX_FAR)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,vg.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e}}]),t}(Ry),My=function(e){ee(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=$s.create(),t._pos=new Nn,t._type=Cy.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/Py(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;$s.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},J(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(Ry),Ly=new Nn(0,0,-1),By=new Gn,Fy=new Yn,zy=new Yn,Uy=new Yn,Gy=new Yn,ky=function(e){ee(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new Nn(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._shadowEnabled=!1,t._shadowPcf=pg.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._aabb=$s.create(),t._frustum=hc.create(),t._pos=new Nn,t._type=Cy.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.luminanceHDR=1700/Py(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new Nn(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Nn.transformQuat(this._dir,Ly,this._node.getWorldRotation(By)),Nn.normalize(this._dir,this._dir),$s.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Fy),Yn.invert(Fy,Fy),Yn.perspective(zy,this._angle,1,.001,this._range),Yn.multiply(Uy,zy,Fy),this._frustum.update(Uy,Gy),this._needUpdate=!1)},J(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}}]),n}(Ry),Hy=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=ce(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Ty.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=ce(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=ce(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._destroy=function(){},t._createNativeObject=function(){},J(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Vy=Object.freeze({__proto__:null,get CameraFOVAxis(){return Zv},get CameraProjection(){return Jv},get CameraAperture(){return $v},get CameraISO(){return eg},get CameraShutter(){return tg},SKYBOX_FLAG:ug,Camera:_g,get ModelType(){return Zg},Model:uy,SubModel:ry,Ambient:hy,EnvironmentLightingType:my,Skybox:vy,ShadowSize:fg,ShadowType:dg,PCFType:pg,Shadows:vg,FogType:yy,Fog:xy,Octree:Ay,ColorTemperatureToRGB:by,get LightType(){return Cy},nt2lm:Py,Light:Ry,DirectionalLight:Ny,SphereLight:My,SpotLight:ky,RenderScene:Hy});function Wy(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function jy(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(wy||(wy={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(Iy||(Iy={}));var Xy=function(){function e(e){this._device=void 0,this._format=vi.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new fr,this._region1=new fr,this._region2=new fr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=ao[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=vo(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=jy(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,Wy(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;A("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new Cr(Ci.TEX2D,Ai.SAMPLED|Ai.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=jy(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,Wy(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}();H(Hy.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),H(Hy.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var qy={};H(qy,"CameraVisFlags",[{name:"GENERAL"}]),k(qy,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Pd.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Pd.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Pd.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Pd.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Pd.BitMask,targetName:"UI_2D"}]),h.CameraVisFlags=qy;var Yy={};H(Yy,"VisibilityFlags",[{name:"GENERAL"}]),k(Yy,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Pd.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Pd.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Pd.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Pd.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Pd.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Pd.Enum,targetName:"UI_2D"}]),h.VisibilityFlags=Yy,k(Mv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),H(_g.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),H(vg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),H(ky.prototype,"SpotLight.prototype",[{name:"aspect"}]);var Ky=function(e){if(void 0===ny[e]){var t=1<<ty;ny[e]=t,ty+=1}},Qy=Object.freeze({__proto__:null,addStage:Ky,scene:Vy,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[];o.push(new Br(ir.ATTR_POSITION,vi.RGB32F)),t.normals&&o.push(new Br(ir.ATTR_NORMAL,vi.RGB32F)),t.uvs&&o.push(new Br(ir.ATTR_TEX_COORD,vi.RG32F)),t.colors&&o.push(new Br(ir.ATTR_COLOR,vi.RGB32F));var a=e.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new zr(o,[a],s))},get RenderQueue(){return wy},get PassStage(){return Iy},genHandle:Jp,getTypeFromHandle:$p,getBindingFromHandle:em,getCountFromHandle:tm,getOffsetFromHandle:nm,customizeType:im,type2reader:rm,type2writer:om,getDefaultFromType:sm,overrideMacros:cm,get BatchingSchemes(){return Tv},Pass:Mv,getDeviceShaderVersion:pm,programLib:Cm,nearestPOT:Wy,TextureBufferPool:Xy,MaterialInstance:fy,PassInstance:_y,get PoolType(){return Ns},NULL_HANDLE:0,get NodeView(){return Ms},NodePool:Us,get PassView(){return Bs},PassPool:Vs,get AABBView(){return Gs},AABBPool:Xs,RenderScene:Hy,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null,NativeGeometryRenderer:null,CameraVisFlags:qy,VisibilityFlags:Yy});e("renderer",Qy);var Zy,Jy=new Nn,$y=new Nn,eS=new Nn,tS=new Nn,nS=new Nn,iS=new Nn,rS=new Nn,oS=new Nn,aS=new Nn,sS=new Nn;!function(e){e[e.LINE=0]="LINE",e[e.DASHED_LINE=1]="DASHED_LINE",e[e.TRIANGLE=2]="TRIANGLE"}(Zy||(Zy={}));var cS,lS,uS,hS,_S,fS,dS,pS,mS,vS,gS=function(){function e(){this._maxVertices=0,this._vertexCount=0,this._stride=0}var t=e.prototype;return t.init=function(e,t,n,i){this._maxVertices=t,this._vertexCount=0,this._stride=n,this._vertices=new Float32Array(t*n/Float32Array.BYTES_PER_ELEMENT),this._buffer=e.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,t*n,n)),this._inputAssembler=e.createInputAssembler(new zr(i,[this._buffer],null))},t.empty=function(){return 0===this._vertexCount},t.reset=function(){this._vertexCount=0},t.update=function(){if(!this.empty()){var e=Math.min(this._vertexCount,this._maxVertices)*this._stride;this._buffer.update(this._vertices,e)}},t.destroy=function(){this._inputAssembler&&this._inputAssembler.destroy(),this._buffer&&this._buffer.destroy()},e}(),yS=function(){this.lines=[],this.dashedLines=[],this.triangles=[];for(var e=0;e<2;e++)this.lines[e]=new gS,this.dashedLines[e]=new gS,this.triangles[e]=new gS},SS=function(){function e(){this._device=null,this._pipeline=null,this._buffers=void 0,this._nativeObj=null,this._buffers=new yS}var t=e.prototype;return t.activate=function(e,t,n){this._device=e,this._pipeline=t;for(var i=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_COLOR,vi.RGBA32F)],r=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_NORMAL,vi.RGBA32F),new Br(ir.ATTR_COLOR,vi.RGBA32F)],o=n?n.maxLines:1e5,a=n?n.maxDashedLines:1e4,s=n?n.maxTriangles:1e4,c=Float32Array.BYTES_PER_ELEMENT*(Nn.length+On.length),l=Float32Array.BYTES_PER_ELEMENT*(Nn.length+ni.length+On.length),u=0;u<2;u++)this._buffers.lines[u].init(this._device,2*o,c,i),this._buffers.dashedLines[u].init(this._device,2*a,c,i),this._buffers.triangles[u].init(this._device,3*s,l,r)},t.flush=function(){},t.render=function(e,t){this.update();for(var n=this._pipeline.pipelineSceneData.geometryRendererPasses,i=this._pipeline.pipelineSceneData.geometryRendererShaders,r=0,o=[1,2],a=0;a<2;a++){var s=this._buffers.lines[a];if(!s.empty()){var c=new xr;c.vertexCount=s._vertexCount;for(var l=0;l<o[a];l++){var u=n[r+l],h=i[r+l],_=Lv.getOrCreatePipelineState(this._device,u,h,e,s._inputAssembler);t.bindPipelineState(_),t.bindDescriptorSet(kd.MATERIAL,u.descriptorSet),t.bindInputAssembler(s._inputAssembler),t.draw(c)}}r+=o[a]}for(var f=0;f<2;f++){var d=this._buffers.dashedLines[f];if(!d.empty()){var p=new xr;p.vertexCount=d._vertexCount;for(var m=0;m<o[f];m++){var v=n[r+m],g=i[r+m],y=Lv.getOrCreatePipelineState(this._device,v,g,e,d._inputAssembler);t.bindPipelineState(y),t.bindDescriptorSet(kd.MATERIAL,v.descriptorSet),t.bindInputAssembler(d._inputAssembler),t.draw(p)}}r+=o[f]}for(var S=0;S<2;S++){var x=this._buffers.triangles[S];if(!x.empty()){var E=new xr;E.vertexCount=x._vertexCount;for(var T=0;T<o[S];T++){var C=n[r+T],A=i[r+T],b=Lv.getOrCreatePipelineState(this._device,C,A,e,x._inputAssembler);t.bindPipelineState(b),t.bindDescriptorSet(kd.MATERIAL,C.descriptorSet),t.bindInputAssembler(x._inputAssembler),t.draw(E)}}r+=o[S]}this.reset()},t.destroy=function(){for(var e=0;e<2;e++)this._buffers.lines[e].destroy(),this._buffers.dashedLines[e].destroy(),this._buffers.triangles[e].destroy()},t.empty=function(){for(var e=0;e<2;e++)if(!this._buffers.lines[e].empty()||!this._buffers.dashedLines[e].empty()||!this._buffers.triangles[e].empty())return!1;return!0},t.update=function(){for(var e=0;e<2;e++)this._buffers.lines[e].update(),this._buffers.dashedLines[e].update(),this._buffers.triangles[e].update()},t.reset=function(){for(var e=0;e<2;e++)this._buffers.lines[e].reset(),this._buffers.dashedLines[e].reset(),this._buffers.triangles[e].reset()},t.addDashedLine=function(e,t,n,i){void 0===i&&(i=!0);var r=this._buffers.dashedLines[i?1:0];if(r._vertexCount+2>r._maxVertices)D(12008);else{var o=r._vertexCount*(Nn.length+On.length);Nn.toArray(r._vertices,e,o),o+=Nn.length,On.toArray(r._vertices,n,o),o+=On.length,Nn.toArray(r._vertices,t,o),o+=Nn.length,On.toArray(r._vertices,n,o),r._vertexCount+=2}},t.addLine=function(e,t,n,i){void 0===i&&(i=!0);var r=this._buffers.lines[i?1:0];if(r._vertexCount+2>r._maxVertices)D(12008);else{var o=r._vertexCount*(Nn.length+On.length);Nn.toArray(r._vertices,e,o),o+=Nn.length,On.toArray(r._vertices,n,o),o+=On.length,Nn.toArray(r._vertices,t,o),o+=Nn.length,On.toArray(r._vertices,n,o),r._vertexCount+=2}},t.addTriangle=function(e,t,n,i,r,o,a){if(void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),r)return this.addLine(e,t,i,o),this.addLine(t,n,i,o),void this.addLine(n,e,i,o);var s=this._buffers.triangles[o?1:0];if(s._vertexCount+3>s._maxVertices)D(12009);else{var c=new ni(ni.ZERO);if(!a){var l=new Nn(t.x-e.x,t.y-e.y,t.z-e.z),u=new Nn(n.x-e.x,n.y-e.y,n.z-e.z),h=new Nn;Nn.normalize(h,Nn.cross(h,l,u)),c.set(h.x,h.y,h.z,1)}var _=s._vertexCount*(Nn.length+ni.length+On.length);Nn.toArray(s._vertices,e,_),_+=Nn.length,ni.toArray(s._vertices,c,_),_+=ni.length,On.toArray(s._vertices,i,_),_+=On.length,Nn.toArray(s._vertices,t,_),_+=Nn.length,ni.toArray(s._vertices,c,_),_+=ni.length,On.toArray(s._vertices,i,_),_+=On.length,Nn.toArray(s._vertices,n,_),_+=Nn.length,ni.toArray(s._vertices,c,_),_+=ni.length,On.toArray(s._vertices,i,_),s._vertexCount+=3}},t.addQuad=function(e,t,n,i,r,o,a,s){void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),o?(this.addLine(e,t,r,a),this.addLine(t,n,r,a),this.addLine(n,i,r,a),this.addLine(i,e,r,a)):(this.addTriangle(e,t,n,r,o,a,s),this.addTriangle(e,n,i,r,o,a,s))},t.addBoundingBox=function(e,t,n,i,r,o,a){void 0===n&&(n=!0),void 0===i&&(i=!0),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=new Yn),Jy.set(e.center.x-e.halfExtents.x,e.center.y-e.halfExtents.y,e.center.z-e.halfExtents.z),$y.set(e.center.x+e.halfExtents.x,e.center.y+e.halfExtents.y,e.center.z+e.halfExtents.z),eS.set(Jy.x,Jy.y,Jy.z),tS.set($y.x,Jy.y,Jy.z),nS.set(Jy.x,$y.y,Jy.z),iS.set($y.x,$y.y,Jy.z),rS.set(Jy.x,Jy.y,$y.z),oS.set($y.x,Jy.y,$y.z),aS.set(Jy.x,$y.y,$y.z),sS.set($y.x,$y.y,$y.z),o&&(Nn.transformMat4(eS,eS,a),Nn.transformMat4(tS,tS,a),Nn.transformMat4(nS,nS,a),Nn.transformMat4(iS,iS,a),Nn.transformMat4(rS,rS,a),Nn.transformMat4(oS,oS,a),Nn.transformMat4(aS,aS,a),Nn.transformMat4(sS,sS,a)),n?(this.addLine(aS,sS,t,i),this.addLine(sS,iS,t,i),this.addLine(iS,nS,t,i),this.addLine(nS,aS,t,i),this.addLine(rS,oS,t,i),this.addLine(oS,tS,t,i),this.addLine(tS,eS,t,i),this.addLine(eS,rS,t,i),this.addLine(aS,rS,t,i),this.addLine(sS,oS,t,i),this.addLine(iS,tS,t,i),this.addLine(nS,eS,t,i)):(this.addQuad(rS,oS,sS,aS,t,n,i,r),this.addQuad(oS,tS,iS,sS,t,n,i,r),this.addQuad(tS,eS,nS,iS,t,n,i,r),this.addQuad(eS,rS,aS,nS,t,n,i,r),this.addQuad(aS,sS,iS,nS,t,n,i,r),this.addQuad(eS,tS,oS,rS,t,n,i,r))},t.addCross=function(e,t,n,i){void 0===i&&(i=!0);var r=.5*t,o=new Nn(e.x-r,e.y,e.z),a=new Nn(e.x+r,e.y,e.z);this.addLine(o,a,n,i),o.set(e.x,e.y-r,e.z),a.set(e.x,e.y+r,e.z),this.addLine(o,a,n,i),o.set(e.x,e.y,e.z-r),a.set(e.x,e.y,e.z+r),this.addLine(o,a,n,i)},t.addFrustum=function(e,t,n){void 0===n&&(n=!0);var i=e.vertices;this.addLine(i[0],i[1],t,n),this.addLine(i[1],i[2],t,n),this.addLine(i[2],i[3],t,n),this.addLine(i[3],i[0],t,n),this.addLine(i[4],i[5],t,n),this.addLine(i[5],i[6],t,n),this.addLine(i[6],i[7],t,n),this.addLine(i[7],i[4],t,n),this.addLine(i[0],i[4],t,n),this.addLine(i[1],i[5],t,n),this.addLine(i[2],i[6],t,n),this.addLine(i[3],i[7],t,n)},t.addCapsule=function(e,t,n,i,r,o,a,s,c,l,u){void 0===r&&(r=32),void 0===o&&(o=8),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new Yn);for(var h=2*Math.PI/r,_=Math.PI/2/o,f=new Nn(e.x,e.y-n/2,e.z),d=new Nn(e.x,e.y+n/2,e.z),p=new Array,m=new Array,v=0;v<o+1;v++){for(var g=new Array,y=new Array,S=v*_,x=Math.sin(S),E=Math.cos(S),T=0;T<r+1;T++){var C=T*h,A=Math.sin(C),b=Math.cos(C),w=new Nn(t*x*b,t*E,t*x*A),I=new Nn(f.x+w.x,f.y-w.y,f.z+w.z),P=new Nn(d.x+w.x,d.y+w.y,d.z+w.z);g.push(I),y.push(P)}p.push(g),m.push(y)}if(l)for(var R=0;R<o+1;R++)for(var O=0;O<r+1;O++)Nn.transformMat4(p[R][O],p[R][O],u),Nn.transformMat4(m[R][O],m[R][O],u);for(var D=0;D<o;D++)for(var N=0;N<r;N++)this.addTriangle(p[D+1][N],p[D][N+1],p[D][N],i,a,s,c),this.addTriangle(p[D+1][N],p[D+1][N+1],p[D][N+1],i,a,s,c),this.addTriangle(m[D][N],m[D+1][N+1],m[D+1][N],i,a,s,c),this.addTriangle(m[D][N],m[D][N+1],m[D+1][N+1],i,a,s,c);for(var M=p[o],L=m[o],B=0;B<r;B++)this.addTriangle(L[B],M[B+1],M[B],i,a,s,c),this.addTriangle(L[B],L[B+1],M[B+1],i,a,s,c)},t.addCylinder=function(e,t,n,i,r,o,a,s,c,l){void 0===r&&(r=32),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new Yn);for(var u=2*Math.PI/r,h=new Nn(e.x,e.y-n/2,e.z),_=new Nn(e.x,e.y+n/2,e.z),f=new Array,d=new Array,p=0;p<r+1;p++){var m=p*u,v=new Nn(t*Math.cos(m),0,t*Math.sin(m)),g=new Nn(v.x+h.x,v.y+h.y,v.z+h.z),y=new Nn(v.x+_.x,v.y+_.y,v.z+_.z);f.push(g),d.push(y)}if(c){Nn.transformMat4(h,h,l),Nn.transformMat4(_,_,l);for(var S=0;S<r+1;S++)Nn.transformMat4(f[S],f[S],l),Nn.transformMat4(d[S],d[S],l)}for(var x=0;x<r;x++)this.addTriangle(_,d[x+1],d[x],i,o,a,s),this.addTriangle(h,f[x],f[x+1],i,o,a,s),this.addTriangle(d[x],f[x+1],f[x],i,o,a,s),this.addTriangle(d[x],d[x+1],f[x+1],i,o,a,s)},t.addCone=function(e,t,n,i,r,o,a,s,c,l){void 0===r&&(r=32),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new Yn);for(var u=2*Math.PI/r,h=new Nn(e.x,e.y-n/2,e.z),_=new Nn(e.x,e.y+n/2,e.z),f=new Array,d=0;d<r+1;d++){var p=new Nn(t*Math.cos(d*u),0,t*Math.sin(d*u)),m=new Nn(p.x+h.x,p.y+h.y,p.z+h.z);f.push(m)}if(c){Nn.transformMat4(h,h,l),Nn.transformMat4(_,_,l);for(var v=0;v<r+1;v++)Nn.transformMat4(f[v],f[v],l)}for(var g=0;g<r;g++)this.addTriangle(_,f[g+1],f[g],i,o,a,s),this.addTriangle(h,f[g],f[g+1],i,o,a,s)},t.addCircle=function(e,t,n,i,r,o,a){void 0===i&&(i=32),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=new Yn);for(var s=2*Math.PI/i,c=new Array,l=0;l<i+1;l++){var u=new Nn(t*Math.cos(l*s),0,t*Math.sin(l*s)),h=new Nn(u.x+e.x,u.y+e.y,u.z+e.z);c.push(h)}if(o)for(var _=0;_<i+1;_++)Nn.transformMat4(c[_],c[_],a);for(var f=0;f<i;f++)this.addLine(c[f],c[f+1],n,r)},t.addArc=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=new Yn);for(var l=pn(i),u=(pn(r)-l)/o,h=new Array,_=0;_<o+1;_++){var f=new Nn(t*Math.cos(_*u+l),0,t*Math.sin(_*u+l)),d=new Nn(f.x+e.x,f.y+e.y,f.z+e.z);h.push(d)}if(s)for(var p=0;p<o+1;p++)Nn.transformMat4(h[p],h[p],c);for(var m=0;m<o;m++)this.addLine(h[m],h[m+1],n,a)},t.addPolygon=function(e,t,n,i,r,o,a,s,c){void 0===i&&(i=6),void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=!1),void 0===c&&(c=new Yn),r?this.addCircle(e,t,n,i,o,s,c):this.addDisc(e,t,n,i,r,o,a,s,c)},t.addDisc=function(e,t,n,i,r,o,a,s,c){void 0===i&&(i=32),void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=!1),void 0===c&&(c=new Yn);for(var l=2*Math.PI/i,u=new Array,h=new Nn(e),_=0;_<i+1;_++){var f=new Nn(t*Math.cos(_*l),0,t*Math.sin(_*l)),d=new Nn(f.x+h.x,f.y+h.y,f.z+h.z);u.push(d)}if(s){Nn.transformMat4(h,h,c);for(var p=0;p<i+1;p++)Nn.transformMat4(u[p],u[p],c)}for(var m=0;m<i;m++)this.addTriangle(h,u[m],u[m+1],n,r,o,a);if(!r)for(var v=0;v<i;v++)this.addTriangle(h,u[v+1],u[v],n,r,o,a)},t.addSector=function(e,t,n,i,r,o,a,s,c,l,u){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new Yn);for(var h=pn(i),_=(pn(r)-h)/o,f=new Array,d=new Nn(e),p=0;p<o+1;p++){var m=new Nn(t*Math.cos(p*_),0,t*Math.sin(p*_)),v=new Nn(m.x+d.x,m.y+d.y,m.z+d.z);f.push(v)}if(l){Nn.transformMat4(d,d,u);for(var g=0;g<o+1;g++)Nn.transformMat4(f[g],f[g],u)}for(var y=0;y<o;y++)this.addTriangle(d,f[y],f[y+1],n,a,s,c);if(!a)for(var S=0;S<o;S++)this.addTriangle(d,f[S+1],f[S],n,a,s,c)},t.addSphere=function(e,t,n,i,r,o,a,s,c,l){void 0===i&&(i=32),void 0===r&&(r=16),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new Yn);for(var u=2*Math.PI/i,h=Math.PI/r,_=new Array,f=0;f<r+1;f++){for(var d=new Array,p=f*h,m=Math.sin(p),v=Math.cos(p),g=0;g<i+1;g++){var y=g*u,S=Math.sin(y),x=Math.cos(y),E=new Nn(t*m*x,t*v,t*m*S),T=new Nn(e.x+E.x,e.y+E.y,e.z+E.z);d.push(T)}_.push(d)}if(c)for(var C=0;C<r+1;C++)for(var A=0;A<i+1;A++)Nn.transformMat4(_[C][A],_[C][A],l);for(var b=0;b<r;b++)for(var w=0;w<i;w++)this.addTriangle(_[b][w],_[b+1][w+1],_[b+1][w],n,o,a,s),this.addTriangle(_[b][w],_[b][w+1],_[b+1][w+1],n,o,a,s)},t.addTorus=function(e,t,n,i,r,o,a,s,c,l,u){void 0===r&&(r=32),void 0===o&&(o=16),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new Yn);for(var h=2*Math.PI/r,_=2*Math.PI/o,f=new Array,d=0;d<r+1;d++){for(var p=new Array,m=d*h,v=Math.sin(m),g=Math.cos(m),y=0;y<o+1;y++){var S=y*_,x=Math.sin(S),E=Math.cos(S),T=new Nn((t+n*E)*g,n*x,(t+n*E)*v),C=new Nn(e.x+T.x,e.y+T.y,e.z+T.z);p.push(C)}f.push(p)}if(l)for(var A=0;A<r+1;A++)for(var b=0;b<o+1;b++)Nn.transformMat4(f[A][b],f[A][b],u);for(var w=0;w<r;w++)for(var I=0;I<o;I++)this.addTriangle(f[w][I+1],f[w+1][I],f[w][I],i,a,s,c),this.addTriangle(f[w][I+1],f[w+1][I+1],f[w+1][I],i,a,s,c)},t.addOctahedron=function(e,t,n,i,r,o,a,s){void 0===i&&(i=!0),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=new Yn);var c=new Array;if(c.push(new Nn(t+e.x,e.y,e.z)),c.push(new Nn(e.x,e.y,e.z-t)),c.push(new Nn(-t+e.x,e.y,e.z)),c.push(new Nn(e.x,e.y,e.z+t)),c.push(new Nn(e.x,e.y+t,e.z)),c.push(new Nn(e.x,e.y-t,e.z)),a)for(var l=0;l<c.length;l++)Nn.transformMat4(c[l],c[l],s);i?(this.addLine(c[0],c[1],n,r),this.addLine(c[1],c[2],n,r),this.addLine(c[2],c[3],n,r),this.addLine(c[3],c[0],n,r),this.addLine(c[0],c[4],n,r),this.addLine(c[1],c[4],n,r),this.addLine(c[2],c[4],n,r),this.addLine(c[3],c[4],n,r),this.addLine(c[0],c[5],n,r),this.addLine(c[1],c[5],n,r),this.addLine(c[2],c[5],n,r),this.addLine(c[3],c[5],n,r)):(this.addTriangle(c[0],c[1],c[4],n,i,r,o),this.addTriangle(c[1],c[2],c[4],n,i,r,o),this.addTriangle(c[2],c[3],c[4],n,i,r,o),this.addTriangle(c[3],c[0],c[4],n,i,r,o),this.addTriangle(c[0],c[3],c[5],n,i,r,o),this.addTriangle(c[3],c[2],c[5],n,i,r,o),this.addTriangle(c[2],c[1],c[5],n,i,r,o),this.addTriangle(c[1],c[0],c[5],n,i,r,o))},t.addBezier=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=new Yn);var l=1/o,u=new Array,h=new Nn(e),_=new Nn(t),f=new Nn(n),d=new Nn(i);s&&(Nn.transformMat4(h,h,c),Nn.transformMat4(_,_,c),Nn.transformMat4(f,f,c),Nn.transformMat4(d,d,c));for(var p=0;p<o+1;p++){var m=p*l,v=(1-m)*(1-m)*(1-m),g=3*m*(1-m)*(1-m),y=3*m*m*(1-m),S=m*m*m,x=new Nn(v*h.x+g*_.x+y*f.x+S*d.x,v*h.y+g*_.y+y*f.y+S*d.y,v*h.z+g*_.z+y*f.z+S*d.z);u.push(x)}for(var E=0;E<o;E++)this.addLine(u[E],u[E+1],r,a)},t.addMesh=function(e,t,n,i,r,o){void 0===i&&(i=!0),void 0===r&&(r=!1),void 0===o&&(o=new Yn);for(var a=0;a<t.length;a+=3){var s=new Nn(e.x+t[a].x,e.y+t[a].y,e.z+t[a].z),c=new Nn(e.x+t[a+1].x,e.y+t[a+1].y,e.z+t[a+1].z),l=new Nn(e.x+t[a+2].x,e.y+t[a+2].y,e.z+t[a+2].z);r&&(Nn.transformMat4(s,s,o),Nn.transformMat4(c,c,o),Nn.transformMat4(l,l,o)),this.addLine(s,c,n,i),this.addLine(c,l,n,i),this.addLine(l,s,n,i)}},t.addIndexedMesh=function(e,t,n,i,r,o,a){void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=new Yn);for(var s=0;s<n.length;s+=3){var c=new Nn(e.x+t[n[s]].x,e.y+t[n[s]].y,e.z+t[n[s]].z),l=new Nn(e.x+t[n[s+1]].x,e.y+t[n[s+1]].y,e.z+t[n[s+1]].z),u=new Nn(e.x+t[n[s+2]].x,e.y+t[n[s+2]].y,e.z+t[n[s+2]].z);o&&(Nn.transformMat4(c,c,a),Nn.transformMat4(l,l,a),Nn.transformMat4(u,u,a)),this.addLine(c,l,i,r),this.addLine(l,u,i,r),this.addLine(u,c,i,r)}},J(e,[{key:"native",get:function(){return this._nativeObj}}]),e}(),xS=new Yn,ES=new Yn,TS=new Yn,CS=new ni,AS=new ni(0,0,1,0),bS=function(){function e(){this._globalUBO=new Float32Array(Xd.COUNT),this._cameraUBO=new Float32Array(qd.COUNT),this._shadowUBO=new Float32Array(Yd.COUNT)}e.updateGlobalUBOView=function(e,t){var n=h.director.root,i=t,r=Math.floor(e.width),o=Math.floor(e.height);i[Xd.TIME_OFFSET]=n.cumulativeTime,i[Xd.TIME_OFFSET+1]=n.frameTime,i[Xd.TIME_OFFSET+2]=h.director.getTotalFrames(),i[Xd.SCREEN_SIZE_OFFSET]=r,i[Xd.SCREEN_SIZE_OFFSET+1]=o,i[Xd.SCREEN_SIZE_OFFSET+2]=1/r,i[Xd.SCREEN_SIZE_OFFSET+3]=1/o,i[Xd.NATIVE_SIZE_OFFSET]=r,i[Xd.NATIVE_SIZE_OFFSET+1]=o,i[Xd.NATIVE_SIZE_OFFSET+2]=1/i[Xd.NATIVE_SIZE_OFFSET],i[Xd.NATIVE_SIZE_OFFSET+3]=1/i[Xd.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var i,r=(n.scene?n.scene:h.director.getScene().renderScene).mainLight,o=e.pipelineSceneData,a=o.ambient,s=o.skybox,c=o.fog,l=o.shadows,u=t,_=n.exposure,f=o.isHDR;if(u[qd.SCREEN_SCALE_OFFSET]=o.shadingScale,u[qd.SCREEN_SCALE_OFFSET+1]=o.shadingScale,u[qd.SCREEN_SCALE_OFFSET+2]=1/u[qd.SCREEN_SCALE_OFFSET],u[qd.SCREEN_SCALE_OFFSET+3]=1/u[qd.SCREEN_SCALE_OFFSET+1],u[qd.EXPOSURE_OFFSET]=_,u[qd.EXPOSURE_OFFSET+1]=1/_,u[qd.EXPOSURE_OFFSET+2]=f?1:0,u[qd.EXPOSURE_OFFSET+3]=1/_g.standardExposureValue,r){var d=r.shadowEnabled&&l.type===dg.ShadowMap?1:0,p=r.direction;if(AS.set(p.x,p.y,p.z,d),ni.toArray(u,AS,qd.MAIN_LIT_DIR_OFFSET),Nn.toArray(u,r.color,qd.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var m=r.colorTemperatureRGB;u[qd.MAIN_LIT_COLOR_OFFSET]*=m.x,u[qd.MAIN_LIT_COLOR_OFFSET+1]*=m.y,u[qd.MAIN_LIT_COLOR_OFFSET+2]*=m.z}u[qd.MAIN_LIT_COLOR_OFFSET+3]=f?r.illuminance*_:r.illuminance}else AS.set(0,0,1,0),ni.toArray(u,AS,qd.MAIN_LIT_DIR_OFFSET),ni.toArray(u,ni.ZERO,qd.MAIN_LIT_COLOR_OFFSET);var v=a.skyColor;v.w=f?a.skyIllum*_:a.skyIllum,u[qd.AMBIENT_SKY_OFFSET+0]=v.x,u[qd.AMBIENT_SKY_OFFSET+1]=v.y,u[qd.AMBIENT_SKY_OFFSET+2]=v.z,u[qd.AMBIENT_SKY_OFFSET+3]=v.w,u[qd.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,u[qd.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,u[qd.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,u[qd.AMBIENT_GROUND_OFFSET+3]=s.envmap?null===(i=s.envmap)||void 0===i?void 0:i.mipmapLevel:1,Yn.toArray(u,n.matView,qd.MAT_VIEW_OFFSET),Yn.toArray(u,n.node.worldMatrix,qd.MAT_VIEW_INV_OFFSET),Nn.toArray(u,n.position,qd.CAMERA_POS_OFFSET),Yn.toArray(u,n.matProj,qd.MAT_PROJ_OFFSET),Yn.toArray(u,n.matProjInv,qd.MAT_PROJ_INV_OFFSET),Yn.toArray(u,n.matViewProj,qd.MAT_VIEW_PROJ_OFFSET),Yn.toArray(u,n.matViewProjInv,qd.MAT_VIEW_PROJ_INV_OFFSET),u[qd.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var g=c.colorArray;u[qd.GLOBAL_FOG_COLOR_OFFSET]=g.x,u[qd.GLOBAL_FOG_COLOR_OFFSET+1]=g.y,u[qd.GLOBAL_FOG_COLOR_OFFSET+2]=g.z,u[qd.GLOBAL_FOG_COLOR_OFFSET+3]=g.z,u[qd.GLOBAL_FOG_BASE_OFFSET]=c.fogStart,u[qd.GLOBAL_FOG_BASE_OFFSET+1]=c.fogEnd,u[qd.GLOBAL_FOG_BASE_OFFSET+2]=c.fogDensity,u[qd.GLOBAL_FOG_ADD_OFFSET]=c.fogTop,u[qd.GLOBAL_FOG_ADD_OFFSET+1]=c.fogRange,u[qd.GLOBAL_FOG_ADD_OFFSET+2]=c.fogAtten,u[qd.NEAR_FAR_OFFSET]=n.nearClip,u[qd.NEAR_FAR_OFFSET+1]=n.farClip,u[qd.VIEW_PORT_OFFSET]=o.shadingScale*n.window.width*n.viewport.x,u[qd.VIEW_PORT_OFFSET+1]=o.shadingScale*n.window.height*n.viewport.y,u[qd.VIEW_PORT_OFFSET+2]=o.shadingScale*n.window.width*n.viewport.z,u[qd.VIEW_PORT_OFFSET+3]=o.shadingScale*n.window.height*n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,o=e.pipelineSceneData.shadows,a=t;if(o.enabled){if(r&&r.shadowEnabled&&o.type===dg.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;r.shadowFixedArea?(s=r.shadowNear,c=r.shadowFar):(s=.1,c=o.shadowCameraFar),Yn.toArray(t,l,Yd.MAT_LIGHT_VIEW_OFFSET),a[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Yd.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Yd.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Yd.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Yd.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Yn.toArray(t,h,Yd.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=Yp(i)?0:1;a[Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.shadowSaturation,a[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.shadowPcf,a[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.shadowBias,a[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,a[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.shadowNormalBias,a[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===dg.Planar&&(qg(o,r,a),Yg(o,a));On.toArray(a,o.shadowColor,Yd.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i=e.device,r=e.pipelineSceneData.shadows,o=t,a=Yp(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case Cy.DIRECTIONAL:var _=n;_.shadowFixedArea?(s=_.shadowNear,c=_.shadowFar):(s=.1,c=r.shadowCameraFar),Yn.toArray(t,l,Yd.MAT_LIGHT_VIEW_OFFSET),o[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Yd.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Yd.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Yd.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Yd.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Yn.toArray(t,h,Yd.MAT_LIGHT_VIEW_PROJ_OFFSET),CS.set(s,c,0,1-_.shadowSaturation),ni.toArray(o,CS,Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),CS.set(0,a,_.shadowNormalBias,0),ni.toArray(o,CS,Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),CS.set(r.size.x,r.size.y,_.shadowPcf,_.shadowBias),ni.toArray(o,CS,Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);break;case Cy.SPOT:var f=n;Yn.invert(xS,n.node.getWorldMatrix()),Yn.toArray(o,xS,Yd.MAT_LIGHT_VIEW_OFFSET),Yn.perspective(ES,n.angle,1,.001,n.range),Yn.multiply(TS,ES,xS),Yn.toArray(o,TS,Yd.MAT_LIGHT_VIEW_PROJ_OFFSET),CS.set(.01,n.range,0,0),ni.toArray(o,CS,Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),CS.set(1,a,f.shadowNormalBias,0),ni.toArray(o,CS,Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),CS.set(r.size.x,r.size.y,f.shadowPcf,f.shadowBias),ni.toArray(o,CS,Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}On.toArray(o,r.shadowColor,Yd.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,Xd.SIZE,Xd.SIZE));n.bindBuffer(Xd.BINDING,i);var r=e.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,qd.SIZE,qd.SIZE));n.bindBuffer(qd.BINDING,r);var o=e.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,Yd.SIZE,Yd.SIZE));n.bindBuffer(Yd.BINDING,o)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(Xd.BINDING),this._globalUBO),n.bindBuffer(Xd.BINDING,i.getBuffer(Xd.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(qd.BINDING),this._cameraUBO),n.bindBuffer(qd.BINDING,i.getBuffer(qd.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=t.scene.mainLight;a&&o.has(a)&&i.bindTexture(Kd,o.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(Yd.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(Kd,wv.get("default-texture").getGFXTexture()),t.bindTexture(rp,wv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(Yd.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof Yn?Yn.toArray(this._shadowUBO,t,e):t instanceof On&&On.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();bS._combineSignY=0;var wS,IS,PS,RS,OS,DS,NS,MS,LS,BS,FS,zS,US,GS=e("RenderStage",(cS=Ic("RenderStage"),lS=il(),uS=il(),hS=il(),cS((vS=function(){function e(){le(this,"_name",dS,this),le(this,"_priority",pS,this),this._enabled=!0,le(this,"_tag",mS,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},J(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),dS=ue((fS=vS).prototype,"_name",[lS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pS=ue(fS.prototype,"_priority",[uS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mS=ue(fS.prototype,"_tag",[hS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_S=fS))||_S));h.RenderStage=GS;var kS,HS=e("RenderFlow",(wS=Ic("RenderFlow"),IS=il(),PS=il(),RS=il(),OS=il(),DS=hl([GS]),wS((US=function(){function e(){le(this,"_name",LS,this),le(this,"_priority",BS,this),le(this,"_tag",FS,this),le(this,"_stages",zS,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},J(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),LS=ue((MS=US).prototype,"_name",[IS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),BS=ue(MS.prototype,"_priority",[PS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FS=ue(MS.prototype,"_tag",[RS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zS=ue(MS.prototype,"_stages",[OS,DS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NS=MS))||NS));h.RenderFlow=HS,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(kS||(kS=e("PipelineEventType",{})));var VS,WS,jS,XS,qS,YS,KS,QS,ZS,JS,$S,ex,tx,nx,ix,rx=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}ee(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(_u)),ox=new sr,ax=new dr,sx=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},cx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},lx=e("RenderPipeline",(VS=Ic("cc.RenderPipeline"),WS=il(),jS=il(),XS=hl([HS]),VS((ZS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_tag",KS,ae(t)),le(t,"_flows",QS,ae(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new rx,t._commandBuffers=[],t._pipelineUBO=new bS,t._macros={},t._constantMacros="",t._profiler=null,t._geometryRenderer=new SS,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new sr,t._clusterEnabled=!1,t._bloomEnabled=!1,t}ee(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new Ur,o=new Gr;r.format=t,o.format=n,o.stencilStoreOp=Ui.DISCARD,o.depthStoreOp=Ui.DISCARD,e&$i.COLOR||(e&ug?r.loadOp=zi.DISCARD:(r.loadOp=zi.LOAD,r.barrier=i.getGeneralBarrier(new Wr(Gi.COLOR_ATTACHMENT_WRITE,Gi.COLOR_ATTACHMENT_WRITE)))),(e&$i.DEPTH_STENCIL)!==$i.DEPTH_STENCIL&&(e&$i.DEPTH||(o.depthLoadOp=zi.LOAD),e&$i.STENCIL||(o.stencilLoadOp=zi.LOAD)),o.barrier=i.getGeneralBarrier(new Wr(Gi.DEPTH_STENCIL_ATTACHMENT_WRITE,Gi.DEPTH_STENCIL_ATTACHMENT_WRITE));var a=new Vr([r],o);return i.createRenderPass(a)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new Xr(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,ox),t||(t=ax);var n=this.pipelineSceneData.shadingScale;return t.left=ox.x*n,t.top=ox.y*n,t.width=ox.width*n,t.height=ox.height*n,t},n.generateScissor=function(e,t){t||(t=ox),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=h.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new ey(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this),this._geometryRenderer.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(kS.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(Kv=n)}Kv=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(kS.RENDER_CAMERA_BEGIN,n),Kg(this,n),Qg(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(kS.RENDER_CAMERA_END,n)}}this.emit(kS.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,o=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(e){case pi.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case pi.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case pi.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case pi.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var e=new cx,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE|Ti.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,o,r));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Br("a_position",vi.RG32F),c[1]=new Br("a_texCoord",vi.RG32F);var l=this._device.createInputAssembler(new zr(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(pi.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||pi.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),this._geometryRenderer.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(vi.RGBA32F)&(wi.RENDER_TARGET|wi.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(mi.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(vu.os===lu.ANDROID&&vu.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(ft.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new sx,t=this.device,n=new Ur;n.format=vi.RGBA8,n.loadOp=zi.CLEAR,n.storeOp=Ui.STORE,n.barrier=t.getGeneralBarrier(new Wr(Gi.NONE,Gi.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new Vr([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED,vi.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Xr(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)e.downsampleTexs.push(t.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED,vi.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[o]=t.createFramebuffer(new Xr(e.renderPass,[e.downsampleTexs[o]])),e.upsampleTexs.push(t.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED,vi.RGBA8,i,r))),e.upsampleFramebuffers[o]=t.createFramebuffer(new Xr(e.renderPass,[e.upsampleTexs[o]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED,vi.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Xr(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},J(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(Mu),KS=ue((YS=ZS).prototype,"_tag",[WS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QS=ue(YS.prototype,"_flows",[jS,XS,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qS=YS))||qS));h.RenderPipeline=lx,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(JS||(JS={})),function(e){e[e.FORWARD=10]="FORWARD"}($S||($S={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(ex||(ex={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(tx||(tx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(nx||(nx={}));var ux=new Ur;ux.format=vi.RGBA8;var hx=new Gr;hx.format=vi.DEPTH_STENCIL;var _x,fx,dx,px,mx,vx,gx,yx,Sx,xx,Ex,Tx,Cx,Ax,bx,wx,Ix,Px,Rx,Ox,Dx,Nx,Mx,Lx,Bx,Fx,zx,Ux,Gx,kx,Hx,Vx,Wx,jx,Xx,qx,Yx,Kx,Qx,Zx,Jx,$x,eE,tE,nE,iE,rE,oE,aE,sE,cE,lE,uE,hE,_E,fE,dE,pE,mE,vE,gE,yE,SE,xE,EE,TE,CE,AE,bE,wE,IE,PE,RE,OE,DE,NE,ME,LE,BE,FE=new Vr([ux],hx),zE={width:1,height:1,renderPassInfo:FE},UE=e("RenderTexture",Ic("cc.RenderTexture")(ix=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=h.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(_n(e,1,2048)),this._height=Math.floor(_n(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=h.director.root;zE.title=this._name,zE.width=this._width,zE.height=this._height,zE.renderPassInfo=e&&e.passInfo?e.passInfo:FE,ux.barrier=t.device.getGeneralBarrier(new Wr(Gi.FRAGMENT_SHADER_READ_TEXTURE,Gi.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(t.device,zE)):this._window=t.createWindow(zE)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return M(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return M(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new fr;return u.texOffset.x=e,u.texOffset.y=t,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},J(t,[{key:"window",get:function(){return this._window}}]),t}(qm))||ix);h.RenderTexture=UE,ht(Ci),ht(Ai),ht(Ui),ht(zi),ht(Gi),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(BE||(BE={})),ht(BE),_x=Ic("RenderTextureDesc"),fx=hl(Ci),dx=hl(Ai),px=hl(vi),_x((vx=ue((mx=function(){le(this,"name",vx,this),le(this,"type",gx,this),le(this,"usage",yx,this),le(this,"format",Sx,this),le(this,"width",xx,this),le(this,"height",Ex,this)}).prototype,"name",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gx=ue(mx.prototype,"type",[fx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ci.TEX2D}}),yx=ue(mx.prototype,"usage",[dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ai.COLOR_ATTACHMENT}}),Sx=ue(mx.prototype,"format",[px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.UNKNOWN}}),xx=ue(mx.prototype,"width",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ex=ue(mx.prototype,"height",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),mx));var GE,kE=(Tx=Ic("RenderTextureConfig"),Cx=hl(UE),Tx((wx=ue((bx=function(){le(this,"name",wx,this),le(this,"texture",Ix,this)}).prototype,"name",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ix=ue(bx.prototype,"texture",[Cx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ax=bx))||Ax),HE=(Px=Ic("MaterialConfig"),Rx=hl(ig),Px((Dx=ue((Ox=function(){le(this,"name",Dx,this),le(this,"material",Nx,this)}).prototype,"name",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Nx=ue(Ox.prototype,"material",[Rx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ox)),Mx=Ic("FrameBufferDesc"),Lx=hl([zt]),Bx=hl(UE),Mx((zx=ue((Fx=function(){le(this,"name",zx,this),le(this,"renderPass",Ux,this),le(this,"colorTextures",Gx,this),le(this,"depthStencilTexture",kx,this),le(this,"texture",Hx,this)}).prototype,"name",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ux=ue(Fx.prototype,"renderPass",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gx=ue(Fx.prototype,"colorTextures",[Lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kx=ue(Fx.prototype,"depthStencilTexture",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hx=ue(Fx.prototype,"texture",[Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fx)),Vx=Ic("ColorDesc"),Wx=hl(vi),jx=hl(zi),Xx=hl(Ui),qx=hl([Gi]),Yx=hl([Gi]),Vx((Zx=ue((Qx=function(){le(this,"format",Zx,this),le(this,"loadOp",Jx,this),le(this,"storeOp",$x,this),le(this,"sampleCount",eE,this),le(this,"beginAccesses",tE,this),le(this,"endAccesses",nE,this)}).prototype,"format",[Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.UNKNOWN}}),Jx=ue(Qx.prototype,"loadOp",[jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zi.CLEAR}}),$x=ue(Qx.prototype,"storeOp",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ui.STORE}}),eE=ue(Qx.prototype,"sampleCount",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tE=ue(Qx.prototype,"beginAccesses",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gi.NONE}}),nE=ue(Qx.prototype,"endAccesses",[Yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gi.COLOR_ATTACHMENT_WRITE}}),Kx=Qx))||Kx),VE=(iE=Ic("DepthStencilDesc"),rE=hl(vi),oE=hl(zi),aE=hl(Ui),sE=hl(zi),cE=hl(Ui),lE=hl(Gi),uE=hl(Gi),iE((fE=ue((_E=function(){le(this,"format",fE,this),le(this,"depthLoadOp",dE,this),le(this,"depthStoreOp",pE,this),le(this,"stencilLoadOp",mE,this),le(this,"stencilStoreOp",vE,this),le(this,"sampleCount",gE,this),le(this,"beginAccesses",yE,this),le(this,"endAccesses",SE,this)}).prototype,"format",[rE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.UNKNOWN}}),dE=ue(_E.prototype,"depthLoadOp",[oE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zi.CLEAR}}),pE=ue(_E.prototype,"depthStoreOp",[aE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ui.STORE}}),mE=ue(_E.prototype,"stencilLoadOp",[sE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zi.CLEAR}}),vE=ue(_E.prototype,"stencilStoreOp",[cE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ui.STORE}}),gE=ue(_E.prototype,"sampleCount",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yE=ue(_E.prototype,"beginAccesses",[lE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gi.NONE}}),SE=ue(_E.prototype,"endAccesses",[uE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gi.DEPTH_STENCIL_ATTACHMENT_WRITE}}),hE=_E))||hE);xE=Ic("RenderPassDesc"),EE=hl([HE]),TE=hl(VE),xE((AE=ue((CE=function(){le(this,"index",AE,this),le(this,"colorAttachments",bE,this),le(this,"depthStencilAttachment",wE,this)}).prototype,"index",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),bE=ue(CE.prototype,"colorAttachments",[EE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wE=ue(CE.prototype,"depthStencilAttachment",[TE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VE}}),CE)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(GE||(GE={})),ht(GE);var WE=(IE=Ic("RenderQueueDesc"),PE=hl(GE),RE=hl([zt]),IE((NE=ue((DE=function(){le(this,"isTransparent",NE,this),le(this,"sortMode",ME,this),le(this,"stages",LE,this)}).prototype,"isTransparent",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ME=ue(DE.prototype,"sortMode",[PE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GE.FRONT_TO_BACK}}),LE=ue(DE.prototype,"stages",[RE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OE=DE))||OE);function jE(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function XE(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var qE=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Ql((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Zl(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=e.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=Lv.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(kd.MATERIAL,c.descriptorSet),n.bindDescriptorSet(kd.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function YE(e){for(var t=0,n=0;n<e.stages.length;n++)t|=Iv(e.stages[n]);var i=jE;switch(e.sortMode){case GE.BACK_TO_FRONT:i=XE;break;case GE.FRONT_TO_BACK:i=jE}return new qE({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function KE(e){e.clear()}function QE(e){e.sort()}var ZE=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n,i){void 0===i&&(i=null);for(var r=this.queue.values(),o=r.next();!o.done;){for(var a=!1,s=0;s<o.value.batches.length;++s){var c=o.value.batches[s];if(c.mergeCount){if(!a){var l=c.shader,u=Lv.getOrCreatePipelineState(e,c.pass,l,t,c.ia);n.bindPipelineState(u),n.bindDescriptorSet(kd.MATERIAL,c.pass.descriptorSet),a=!0}i&&n.bindDescriptorSet(kd.GLOBAL,i),n.bindDescriptorSet(kd.LOCAL,c.descriptorSet,o.value.dynamicOffsets),n.bindInputAssembler(c.ia),n.draw(c.ia)}}o=r.next()}},e}(),JE=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n,i){void 0===i&&(i=null);for(var r=this.queue.values(),o=r.next();!o.done;){var a=o.value,s=a.instances,c=a.pass;if(a.hasPendingModels){n.bindDescriptorSet(kd.MATERIAL,c.descriptorSet);for(var l=null,u=0;u<s.length;++u){var h=s[u];if(h.count){var _=h.shader,f=Lv.getOrCreatePipelineState(e,c,_,t,h.ia);l!==f&&(n.bindPipelineState(f),l=f),i&&n.bindDescriptorSet(kd.GLOBAL,i),n.bindDescriptorSet(kd.LOCAL,h.descriptorSet,o.value.dynamicOffsets),n.bindInputAssembler(h.ia),n.draw(h.ia)}}}o=r.next()}},e}(),$E=new Kl((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),eT=new Float32Array(4),tT=[],nT=[],iT=new Yn,rT=new Yn;function oT(e,t){return!(!t.worldBounds||ys.aabbWithAABB(t.worldBounds,e.aabb))}function aT(e,t){return!(!t.worldBounds||ys.aabbWithAABB(t.worldBounds,e.aabb)&&ys.aabbFrustum(t.worldBounds,e.frustum))}var sT=Iv("forward-add"),cT=[];function lT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===sT){o=a,n=!0;break}t.push(o)}return n}var uT,hT,_T,fT,dT,pT,mT,vT,gT,yT,ST,xT=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Yd.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new JE,this._batchedQueue=new ZE;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(hp.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Sr(this._lightBuffer,0,hp.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}$E.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(Yd.BINDING).destroy(),r.getTexture(Kd).destroy(),r.getTexture(rp).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(lT(a,cT)&&(nT.length=0,this._lightCulling(o,n),nT.length))for(var s=0;s<a.length;s++){var c=cT[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(hp.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){for(var i=this._pipeline.globalDSManager,r=0;r<nT.length;r++){var o=nT[r],a=i.getOrCreateDescriptorSet(o);this._instancedQueue.recordCommandBuffer(e,t,n,a),this._batchedQueue.recordCommandBuffer(e,t,n,a)}for(var s=0;s<this._lightPasses.length;s++){var c=this._lightPasses[s],l=c.subModel,u=c.passIdx,h=c.dynamicOffsets,_=c.lights,f=l.passes[u],d=l.shaders[u],p=l.inputAssembler,m=Lv.getOrCreatePipelineState(e,f,d,t,p),v=f.descriptorSet,g=l.descriptorSet;n.bindPipelineState(m),n.bindDescriptorSet(kd.MATERIAL,v),n.bindInputAssembler(p);for(var y=0;y<h.length;++y){var S=_[y],x=i.getOrCreateDescriptorSet(S);tT[0]=h[y],n.bindDescriptorSet(kd.GLOBAL,x),n.bindDescriptorSet(kd.LOCAL,g,tT),n.draw(p)}}},t._lightCulling=function(e,t){for(var n=!1,i=!function(e){for(var t=e.subModels,n=0;n<t.length;++n)for(var i=t[n].passes,r=0;r<i.length;++r){var o=i[r].batchingScheme;if(o===Tv.INSTANCING)return!0;if(o===Tv.VB_MERGING)return!0}return!1}(e),r=0;r<t.length;r++){var o=t[r];switch(o.type){case Cy.SPHERE:i&&(n=oT(o,e));break;case Cy.SPOT:i&&(n=aT(o,e))}n||nT.push(r)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===Tv.INSTANCING)for(var o=0;o<nT.length;o++){var a=nT[o],s=e.getInstancedBuffer(a);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===Tv.VB_MERGING)for(var c=0;c<nT.length;c++){var l=nT[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=$E.alloc();h.subModel=t,h.passIdx=i;for(var _=0;_<nT.length;_++){var f=nT[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=e.scene.mainLight,s=Yp(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,d=void 0;switch(h.type){case Cy.SPHERE:a&&(qg(r,a,this._shadowUBO),Yg(r,this._shadowUBO)),this._shadowUBO[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,On.toArray(this._shadowUBO,r.shadowColor,Yd.SHADOW_COLOR_OFFSET);break;case Cy.SPOT:var p=h;if(a&&(qg(r,a,this._shadowUBO),Yg(r,this._shadowUBO)),Yn.invert(iT,h.node.getWorldMatrix()),Yn.perspective(rT,h.angle,1,.001,h.range),f=rT.clone(),d=rT.clone().invert(),Yn.multiply(rT,rT,iT),Yn.toArray(this._shadowUBO,iT,Yd.MAT_LIGHT_VIEW_OFFSET),Yn.toArray(this._shadowUBO,rT,Yd.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Yd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=p.shadowPcf,this._shadowUBO[Yd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=p.shadowBias,this._shadowUBO[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=p.shadowNormalBias,this._shadowUBO[Yd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Yd.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Yd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[Yd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[Yd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[Yd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[Yd.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Yd.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Yd.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Yd.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,On.toArray(this._shadowUBO,r.shadowColor,Yd.SHADOW_COLOR_OFFSET),o.has(h)){var m,v=null===(m=o.get(h))||void 0===m?void 0:m.colorTextures[0];v&&_.bindTexture(rp,v)}}_.update(),t.updateBuffer(_.getBuffer(Yd.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Tn(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Sr(this._lightBuffer,0,hp.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case Cy.SPHERE:if(Nn.toArray(eT,l.position),eT[3]=0,this._lightBufferData.set(eT,c+hp.LIGHT_POS_OFFSET),eT[0]=l.size,eT[1]=l.range,eT[2]=0,eT[3]=0,this._lightBufferData.set(eT,c+hp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Nn.toArray(eT,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;eT[0]*=u.x,eT[1]*=u.y,eT[2]*=u.z}eT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(eT,c+hp.LIGHT_COLOR_OFFSET);break;case Cy.SPOT:if(Nn.toArray(eT,l.position),eT[3]=1,this._lightBufferData.set(eT,c+hp.LIGHT_POS_OFFSET),eT[0]=l.size,eT[1]=l.range,eT[2]=l.spotAngle,eT[3]=o.enabled&&l.shadowEnabled&&o.type===dg.ShadowMap?1:0,this._lightBufferData.set(eT,c+hp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Nn.toArray(eT,l.direction),this._lightBufferData.set(eT,c+hp.LIGHT_DIR_OFFSET),Nn.toArray(eT,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;eT[0]*=h.x,eT[1]*=h.y,eT[2]*=h.z}eT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(eT,c+hp.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),ET=new $s,TT=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new JE,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===dg.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,o=e.frustum,a=0!=(e.visibility&Pd.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||($s.transform(ET,_.worldBounds,i.matLight),ys.aabbFrustum(ET,o)))if(_.isInstancingEnabled)for(var f=_.subModels,d=0;d<f.length;d++){var p=f[d];u.merge(p,_.instancedAttributes,0,p.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===dg.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(kd.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=Lv.getOrCreatePipelineState(e,r,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(kd.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},e}(),CT=function(){function e(){this._phaseID=Iv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,d=Lv.getOrCreatePipelineState(i,h,_,t,f);r.bindPipelineState(d),r.bindDescriptorSet(kd.MATERIAL,h.descriptorSet);var p=s.descriptorSet;r.bindDescriptorSet(kd.LOCAL,p),r.bindInputAssembler(f),r.draw(f)}}}},e}(),AT=[new pr(0,0,0,1)],bT=e("ForwardStage",(uT=Ic("ForwardStage"),hT=hl([WE]),_T=il(),uT((vT=mT=function(e){function t(){var t;return le(t=e.call(this)||this,"renderQueues",pT,ae(t)),t._renderQueues=[],t._renderArea=new sr,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Iv("default"),t._clearFlag=4294967295,t._batchedQueue=new ZE,t._instancedQueue=new JE,t._uiPhase=new CT,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=YE(this.renderQueues[i]);this._additiveLightQueue=new xT(this._pipeline),this._planarQueue=new TT(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(KE);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Tv.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===Tv.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(QE);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&$i.COLOR&&(AT[0].x=e.clearColor.x,AT[0].y=e.clearColor.y,AT[0].z=e.clearColor.z,AT[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,g=t.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,AT,e.clearDepth,e.clearStencil),m.bindDescriptorSet(kd.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(kd.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._pipeline.geometryRenderer.render(g,m),this._uiPhase.render(e,g),Qv(n,g,m,t.profiler,e),m.endRenderPass()},t}(GS),mT.initInfo={name:"ForwardStage",priority:$S.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:GE.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:GE.BACK_TO_FRONT,stages:["default","planarShadow"]}]},pT=ue((dT=vT).prototype,"renderQueues",[hT,Bc,_T],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fT=dT))||fT)),wT=e("ForwardFlow",Ic("ForwardFlow")((ST=yT=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new bT;n.initialize(bT.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(HS),yT.initInfo={name:Nd,priority:ex.FORWARD,stages:[]},gT=ST))||gT),IT=new Yn,PT=new Yn,RT=new Yn,OT=new $s,DT=Iv("shadow-caster"),NT=[];function MT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===DT){o=a,n=!0;break}t.push(o)}return n}var LT,BT,FT,zT,UT,GT,kT=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new JE,this._batchedQueue=new ZE}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===dg.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case Cy.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;MT(l.subModels,NT)&&this.add(l,NT)}break;case Cy.SPOT:Yn.invert(IT,n.node.getWorldMatrix()),Yn.perspective(PT,n.angle,1,.001,n.range),Yn.multiply(RT,PT,IT);for(var u=0;u<s.length;u++){var h=s[u].model;MT(h.subModels,NT)&&(h.worldBounds&&($s.transform(OT,h.worldBounds,RT),!ys.aabbFrustum(OT,t.frustum))||this.add(h,NT))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t){for(var n=e.subModels,i=0;i<n.length;i++){var r=n[i],o=t[i],a=r.passes[o];if(a.batchingScheme===Tv.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,e.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===Tv.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,e),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=Lv.getOrCreatePipelineState(e,a,o,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(kd.MATERIAL,l),n.bindDescriptorSet(kd.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),HT=[new pr(1,1,1,1)],VT=e("ShadowStage",Ic("ShadowStage")((FT=BT=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new sr,t._light=null,t._globalDS=null,t}ee(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){HT[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,HT,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,e,this._light,a);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,HT,e.clearDepth,e.clearStencil),a.bindDescriptorSet(kd.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new kT(t)},t}(GS),BT.initInfo={name:"ShadowStage",priority:$S.FORWARD,tag:0},LT=FT))||LT),WT=[],jT=e("ShadowFlow",Ic("ShadowFlow")((GT=UT=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new VT;n.initialize(VT.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===dg.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===Cy.SPOT&&(WT.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(e)}}for(var d=0;d<WT.length;d++){var p=WT[d],m=t.globalDSManager.getOrCreateDescriptorSet(d);i.has(p)||this._initShadowFrameBuffer(t,p,e.window.swapchain);for(var v=i.get(p),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,p,v),y.render(e)}}WT.length=0}else this.clearShadowMap(WT,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,o=Yp(n)?vi.R32F:vi.RGBA8;if(!this._shadowRenderPass){var a=new Ur;a.format=o,a.loadOp=zi.CLEAR,a.storeOp=Ui.STORE,a.sampleCount=1;var s=new Gr;s.format=vi.DEPTH_STENCIL,s.depthLoadOp=zi.CLEAR,s.depthStoreOp=Ui.DISCARD,s.stencilLoadOp=zi.CLEAR,s.stencilStoreOp=Ui.DISCARD,s.sampleCount=1;var c=new Vr([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new Cr(Ci.TEX2D,Ai.DEPTH_STENCIL_ATTACHMENT,vi.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new Xr(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var d=this._stages[f];d.setUsage(_,u,h),d.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=Yp(i)?vi.R32F:vi.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED,o,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new Xr(h,l,u)),s=a.next()}else s=a.next()}e.shadowMapDirty=!1},t}(HS),UT.initInfo={name:Md,priority:ex.SHADOW,tag:BE.SCENE,stages:[]},zT=GT))||zT);function XT(e,t){for(var n,i=ce(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?XT(e,r):e.push(r)}}function qT(e){var t=[];return XT(t,e),t.join("")}var YT=yl.Flags.Destroyed,KT=yl.Flags.PersistentMask,QT=nn.IDENTIFIER_RE,ZT="var ",JT="o",$T={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},eC=nn.escapeForJS,tC=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return ZT+this.varName+"="+this.expression+";"},e}();function nC(e,t){return t instanceof tC?new tC(t.varName,e+t.expression):e+t}function iC(e,t,n){Array.isArray(n)?(n[0]=nC(t,n[0]),e.push(n)):e.push(nC(t,n)+";")}var rC=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];iC(e,t+oC(i[0])+"=",i[1])}},e}();function oC(e){return QT.test(e)?"."+e:"["+eC(e)+"]"}rC.pool=void 0,rC.pool=new it((function(e){e._exps.length=0,e._targetExp=null}),1),rC.pool.get=function(e){var t=this._get()||new rC;return t._targetExp=e,t};var aC=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Re(),ke(this.funcModuleCache,$T),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=ZT+this.globalVariables.join(",")+";");var i=qT(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=Oe(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=rC.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),rC.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var i=n.__values__,r=Dt(n),o=0;o<i.length;o++){var a=i[o],s=t[a],c=r[a+"$_$default"];if(!sC(c,s))if("object"==typeof s&&s instanceof h.ValueType&&(c=nn.getDefault(c))&&c.constructor===s.constructor){var l=JT+oC(a);this.setValueType(e,c,s,l)}else this.setObjProp(e,t,a,s)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new tC(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)iC(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new tC(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&iC(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=nC(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?eC(n):("_objFlags"===t&&e instanceof yl&&(n&=KT),n)},t.setObjProp=function(e,t,n,i){iC(e,JT+oC(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(rn(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"==typeof r&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}},t.instantiateObj=function(e){if(e instanceof h.ValueType)return nn.getNewValueTypeCode(e);if(e instanceof h.Asset)return this.getObjRef(e);if(e._objFlags&YT)return null;var t,n=e.constructor;if(rn(n)){if(this.parent)if(this.parent instanceof h.Component){if(e instanceof h._BaseNode||e instanceof h.Component)return this.getObjRef(e)}else if(this.parent instanceof h._BaseNode)if(e instanceof h._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof h.Component){var i;if(!(null===(i=e.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(e)}t=new tC(JT,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new tC(JT,"{}");else{if(n)return this.getObjRef(e);t=new tC(JT,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]},e}();function sC(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof h.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return Ce(e)&&Ce(t)}return!1}var cC,lC,uC,hC,_C,fC,dC,pC,mC,vC,gC=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(){},J(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?D(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]),e}();yl.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(cC||(cC=e("NodeEventType",{})));var yC=yl.Flags.Destroying,SC=yl.Flags.DontDestroy,xC=yl.Flags.Deactivating,EC=new ge("Node");function TC(e){return e?"string"==typeof e?tt(e):e:(M(3804),null)}var CC,AC,bC,wC,IC,PC,RC,OC,DC,NC,MC,LC=e("BaseNode",Ic("cc.BaseNode")((vC=mC=function(e){ee(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],o=n._findComponent(r,t);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,t)))return o}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var o=e[r];n._findComponents(o,t,i),o._children.length>0&&n._findChildComponents(o._children,t,i)}};var t=n.prototype;function n(t){var n;return le(n=e.call(this,t)||this,"_parent",hC,ae(n)),le(n,"_children",_C,ae(n)),le(n,"_active",fC,ae(n)),le(n,"_components",dC,ae(n)),le(n,"_prefab",pC,ae(n)),n._scene=null,n._activeInHierarchy=!1,n._id=EC.getNewId(),n._name=void 0,n._eventProcessor=new h.NodeEventProcessor(ae(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?T("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){ke(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(cC.PARENT_CHANGED,n),n&&!(n._objFlags&yC)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(cC.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(cC.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return x("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return x("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&xC)M(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&t&&t(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=TC(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=TC(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=TC(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=TC(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=tt(e)))throw h._RF.peek()&&M(3808,e),TypeError(z(3807,e))}else{if(!e)throw TypeError(z(3804));t=e}if("function"!=typeof t)throw TypeError(z(3809));if(!We(t,h.Component))throw TypeError(z(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var a=new t;return a.node=this,this._components.push(a),this._activeInHierarchy&&h.director._nodeActivator.activateComp(a),a},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof th?e:this.getComponent(e))&&t.destroy()}else M(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case cC.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case cC.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(cC.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&yC)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&M(3815)}}else M(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(cC.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=h.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof h.Scene||h.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&h.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=yC;var e=this._parent,t=!!e&&0!=(e._objFlags&yC);if(this._persistNode&&h.game.removePersistRootNode(this),!t&&e){this.emit(cC.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(cC.CHILD_REMOVED,this)}this.emit(cC.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return t},J(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&SC)>0},set:function(e){e?this._objFlags|=SC:this._objFlags&=~SC}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(e=!!e,this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&h.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(yl),mC.idGenerator=EC,mC._stacks=[[]],mC._stackId=0,ue((uC=vC).prototype,"_persistNode",[Dc],Object.getOwnPropertyDescriptor(uC.prototype,"_persistNode"),uC.prototype),ue(uC.prototype,"name",[qc],Object.getOwnPropertyDescriptor(uC.prototype,"name"),uC.prototype),ue(uC.prototype,"children",[qc],Object.getOwnPropertyDescriptor(uC.prototype,"children"),uC.prototype),ue(uC.prototype,"active",[qc],Object.getOwnPropertyDescriptor(uC.prototype,"active"),uC.prototype),ue(uC.prototype,"activeInHierarchy",[qc],Object.getOwnPropertyDescriptor(uC.prototype,"activeInHierarchy"),uC.prototype),ue(uC.prototype,"parent",[qc],Object.getOwnPropertyDescriptor(uC.prototype,"parent"),uC.prototype),hC=ue(uC.prototype,"_parent",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_C=ue(uC.prototype,"_children",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fC=ue(uC.prototype,"_active",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dC=ue(uC.prototype,"_components",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pC=ue(uC.prototype,"_prefab",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lC=uC))||lC);h._BaseNode=LC;var BC=new Nn,FC=new Gn,zC=new Gn,UC=new Gn,GC=new Fn,kC=new Fn,HC=new Yn,VC=[],WC=[],jC=[],XC=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return jC[0]=this._chunks[e],jC[1]=this._freelists[e].pop(),jC},e}();XC.CAPACITY_PER_CHUNK=256;var qC,YC,KC,QC,ZC,JC,$C,eA,tA,nA,iA,rA,oA,aA,sA,cA,lA,uA,hA,_A,fA,dA,pA,mA,vA,gA,yA,SA,xA,EA,TA,CA,AA,bA,wA,IA,PA,RA,OA,DA,NA,MA,LA,BA,FA,zA,UA,GA,kA,HA,VA,WA,jA,XA,qA,YA,KA,QA,ZA,JA,$A,eb,tb,nb,ib,rb,ob,ab,sb,cb=new XC,lb=Symbol("ReserveContentsForAllSyncablePrefab"),ub=e("Node",(CC=Ic("cc.Node"),AC=hl(Nn),CC((MC=NC=function(e){ee(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new gC(ae(n)),n._static=!1,le(n,"_lpos",IC,ae(n)),le(n,"_lrot",PC,ae(n)),le(n,"_lscale",RC,ae(n)),le(n,"_layer",OC,ae(n)),le(n,"_euler",DC,ae(n)),n._dirtyFlagsPri=Ty.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=cb.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new Nn,this._rot=new Gn,this._scale=new Nn(1,1,1),this._mat=new Yn},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof h.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return cb.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[_h]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),hn(Yn.determinant(i._mat),0,ln)?(D(14200),this._dirtyFlags|=Ty.TRS,this.updateWorldTransform()):(Yn.multiply(HC,Yn.invert(HC,i._mat),this._mat),Yn.toRTS(HC,this._lrot,this._lpos,this._lscale))):(Nn.copy(this._lpos,this._pos),Gn.copy(this._lrot,this._rot),Nn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Ty.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=Ty.TRS,this._dirtyFlags|=Ty.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(Ty.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||Ey.LOCAL;if(n===Ey.LOCAL)Nn.transformQuat(BC,e,this._lrot),this._lpos.x+=BC.x,this._lpos.y+=BC.y,this._lpos.z+=BC.z;else if(n===Ey.WORLD)if(this._parent){Gn.invert(FC,this._parent.worldRotation),Nn.transformQuat(BC,e,FC);var i=this.worldScale;this._lpos.x+=BC.x/i.x,this._lpos.y+=BC.y/i.y,this._lpos.z+=BC.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Ty.POSITION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.POSITION)},t.rotate=function(e,t){var n=t||Ey.LOCAL;if(Gn.normalize(FC,e),n===Ey.LOCAL)Gn.multiply(this._lrot,this._lrot,FC);else if(n===Ey.WORLD){var i=this.worldRotation;Gn.multiply(zC,FC,i),Gn.invert(FC,i),Gn.multiply(zC,FC,zC),Gn.multiply(this._lrot,this._lrot,zC)}this._eulerDirty=!0,this.invalidateChildren(Ty.ROTATION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(BC),Nn.subtract(BC,BC,e),Nn.normalize(BC,BC),Gn.fromViewUp(FC,BC,t),this.setWorldRotation(FC)},t._setDirtyNode=function(e,t){VC[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,o=0,a=0,s=0,c=0,l=e|Ty.POSITION;for(VC[0]=this;r>=0;){if(c=(t=VC[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,a=(i=t._children).length,o=0;o<a;o++)n=i[o],VC[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=VC[--n])._dirtyFlags,t?(i&Ty.POSITION&&(Nn.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&Ty.RS&&(Yn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Yn.multiply(e._mat,t._mat,e._mat),i&Ty.ROTATION&&Gn.multiply(e._rot,t._rot,e._lrot),Fn.fromQuat(GC,Gn.conjugate(UC,e._rot)),Fn.multiplyMat4(GC,GC,e._mat),e._scale.x=GC.m00,e._scale.y=GC.m04,e._scale.z=GC.m08)):(i&Ty.POSITION&&(Nn.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&Ty.RS&&(i&Ty.ROTATION&&Gn.copy(e._rot,e._lrot),i&Ty.SCALE&&(Nn.copy(e._scale,e._lscale),Yn.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=Ty.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?Nn.copy(this._lpos,e):void 0===n?Nn.set(this._lpos,e,t,this._lpos.z):Nn.set(this._lpos,e,t,n),this.invalidateChildren(Ty.POSITION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.POSITION)},t.getPosition=function(e){return e?Nn.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Nn.copy(new Nn,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Gn.copy(this._lrot,e):Gn.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(Ty.ROTATION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(Nn.copy(this._euler,e),Gn.fromEuler(this._lrot,e.x,e.y,e.z)):(Nn.set(this._euler,e,t,i),Gn.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(Ty.ROTATION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.ROTATION)},t.getRotation=function(e){return e?Gn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Gn.copy(new Gn,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?Nn.copy(this._lscale,e):void 0===n?Nn.set(this._lscale,e,t,this._lscale.z):Nn.set(this._lscale,e,t,n),this.invalidateChildren(Ty.SCALE),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.SCALE)},t.getScale=function(e){return e?Nn.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Nn.copy(new Nn,this._lscale)},t.inverseTransformPoint=function(e,t){Nn.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)Nn.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=VC[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?Nn.copy(this._pos,e):Nn.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),Nn.transformMat4(r,this._pos,Yn.invert(HC,i._mat))):Nn.copy(r,this._pos),this.invalidateChildren(Ty.POSITION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?Nn.copy(e,this._pos):Nn.copy(new Nn,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Gn.copy(this._rot,e):Gn.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),Gn.multiply(this._lrot,Gn.conjugate(this._lrot,this._parent._rot),this._rot)):Gn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Ty.ROTATION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){Gn.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),Gn.multiply(this._lrot,Gn.conjugate(this._lrot,this._parent._rot),this._rot)):Gn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Ty.ROTATION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?Gn.copy(e,this._rot):Gn.copy(new Gn,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?Nn.copy(this._scale,e):Nn.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Fn.fromQuat(GC,Gn.conjugate(UC,i._rot)),Fn.multiplyMat4(GC,GC,i._mat),kC.m00=this._scale.x,kC.m04=this._scale.y,kC.m08=this._scale.z,Fn.multiply(GC,kC,Fn.invert(GC,GC)),this._lscale.x=Nn.set(BC,GC.m00,GC.m01,GC.m02).length(),this._lscale.y=Nn.set(BC,GC.m03,GC.m04,GC.m05).length(),this._lscale.z=Nn.set(BC,GC.m06,GC.m07,GC.m08).length()):Nn.copy(this._lscale,this._scale),this.invalidateChildren(Ty.SCALE),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?Nn.copy(e,this._scale):Nn.copy(new Nn,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new Yn;return Yn.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new Yn;return Yn.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new Yn;return Yn.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=Ty.ROTATION,void 0!==e.w?(Gn.copy(this._lrot,e),this._eulerDirty=!0):(Nn.copy(this._euler,e),Gn.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(Nn.copy(this._lpos,t),i|=Ty.POSITION),n&&(Nn.copy(this._lscale,n),i|=Ty.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){cb.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,VC.length=0,WC.length=0)},t.getPathInHierarchy=function(){for(var e=this.name,t=this.parent;t&&t instanceof n;)e=t.name+"/"+e,t=t.parent;return e},J(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Gn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){Nn.set(this._euler,0,0,e),Gn.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(Ty.ROTATION),1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Yn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Ty.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(cC.TRANSFORM_CHANGED,Ty.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Nn.transformQuat(new Nn,Nn.FORWARD,this.worldRotation)},set:function(e){var t=e.length();Nn.multiplyScalar(BC,e,-1/t),Gn.fromViewUp(FC,BC),this.setWorldRotation(FC)}},{key:"up",get:function(){return Nn.transformQuat(new Nn,Nn.UP,this.worldRotation)}},{key:"right",get:function(){return Nn.transformQuat(new Nn,Nn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(cC.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(LC),NC.EventType=cC,NC.NodeSpace=Ey,NC.TransformDirtyBit=Ty,NC.TransformBit=Ty,NC.reserveContentsForAllSyncablePrefabTag=lb,NC.ClearFrame=0,NC.ClearRound=1e3,IC=ue((wC=MC).prototype,"_lpos",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn}}),PC=ue(wC.prototype,"_lrot",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gn}}),RC=ue(wC.prototype,"_lscale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(1,1,1)}}),OC=ue(wC.prototype,"_layer",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pd.Enum.DEFAULT}}),DC=ue(wC.prototype,"_euler",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn}}),ue(wC.prototype,"eulerAngles",[AC],Object.getOwnPropertyDescriptor(wC.prototype,"eulerAngles"),wC.prototype),ue(wC.prototype,"angle",[qc],Object.getOwnPropertyDescriptor(wC.prototype,"angle"),wC.prototype),ue(wC.prototype,"layer",[qc],Object.getOwnPropertyDescriptor(wC.prototype,"layer"),wC.prototype),bC=wC))||bC));h.Node=ub;var hb=Ic("cc.TargetInfo")((KC=ue((YC=function(){le(this,"localID",KC,this)}).prototype,"localID",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qC=YC))||qC,_b=(QC=Ic("cc.TargetOverrideInfo"),ZC=hl(yl),JC=hl(hb),$C=hl(ub),eA=hl(hb),QC((iA=ue((nA=function(){le(this,"source",iA,this),le(this,"sourceInfo",rA,this),le(this,"propertyPath",oA,this),le(this,"target",aA,this),le(this,"targetInfo",sA,this)}).prototype,"source",[Bc,ZC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rA=ue(nA.prototype,"sourceInfo",[Bc,JC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oA=ue(nA.prototype,"propertyPath",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aA=ue(nA.prototype,"target",[Bc,$C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sA=ue(nA.prototype,"targetInfo",[Bc,eA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tA=nA))||tA),fb=Ic("cc.CompPrefabInfo")((uA=ue((lA=function(){le(this,"fileId",uA,this)}).prototype,"fileId",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cA=lA))||cA,db=(hA=Ic("CCPropertyOverrideInfo"),_A=hl(hb),hA((gA=function(){function e(){le(this,"targetInfo",pA,this),le(this,"propertyPath",mA,this),le(this,"value",vA,this)}return e.prototype.isTarget=function(){},e}(),pA=ue((dA=gA).prototype,"targetInfo",[Bc,_A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mA=ue(dA.prototype,"propertyPath",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vA=ue(dA.prototype,"value",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fA=dA))||fA),pb=(yA=Ic("cc.MountedChildrenInfo"),SA=hl(hb),xA=hl([ub]),yA((bA=function(){function e(){le(this,"targetInfo",CA,this),le(this,"nodes",AA,this)}return e.prototype.isTarget=function(){},e}(),CA=ue((TA=bA).prototype,"targetInfo",[Bc,SA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AA=ue(TA.prototype,"nodes",[Bc,xA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EA=TA))||EA),mb=(wA=Ic("cc.MountedComponentsInfo"),IA=hl(hb),PA=hl([th]),wA((MA=function(){function e(){le(this,"targetInfo",DA,this),le(this,"components",NA,this)}return e.prototype.isTarget=function(){},e}(),DA=ue((OA=MA).prototype,"targetInfo",[Bc,IA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NA=ue(OA.prototype,"components",[Bc,PA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RA=OA))||RA),vb=(LA=Ic("cc.PrefabInstance"),BA=hl(ub),FA=hl([pb]),zA=hl([mb]),UA=hl([db]),GA=hl([hb]),LA((KA=function(){function e(){le(this,"fileId",VA,this),le(this,"prefabRootNode",WA,this),le(this,"mountedChildren",jA,this),le(this,"mountedComponents",XA,this),le(this,"propertyOverrides",qA,this),le(this,"removedComponents",YA,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),VA=ue((HA=KA).prototype,"fileId",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),WA=ue(HA.prototype,"prefabRootNode",[Bc,BA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),jA=ue(HA.prototype,"mountedChildren",[Bc,FA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),XA=ue(HA.prototype,"mountedComponents",[Bc,zA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qA=ue(HA.prototype,"propertyOverrides",[Bc,UA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),YA=ue(HA.prototype,"removedComponents",[Bc,GA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kA=HA))||kA),gb=(QA=Ic("cc.PrefabInfo"),ZA=hl(ub),JA=hl(vb),$A=hl([_b]),QA((nb=ue((tb=function(){le(this,"root",nb,this),le(this,"asset",ib,this),le(this,"fileId",rb,this),le(this,"instance",ob,this),le(this,"targetOverrides",ab,this),le(this,"nestedPrefabInstanceRoots",sb,this)}).prototype,"root",[Bc,ZA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ib=ue(tb.prototype,"asset",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rb=ue(tb.prototype,"fileId",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ob=ue(tb.prototype,"instance",[Bc,JA],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ab=ue(tb.prototype,"targetOverrides",[Bc,$A],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),sb=ue(tb.prototype,"nestedPrefabInstanceRoots",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),eb=tb))||eb);function yb(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return M(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,r=e._id,o=e._prefab;e[dl],h.game._isCloning=!0,t.asset._doInstantiate(e),h.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=r,e._prefab&&(e._prefab.instance=null==o?void 0:o.instance)}}function Sb(e,t,n){var i;if(t&&e){var r=t,o=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&o&&(t[o.fileId]={},r=t[o.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)Sb(e.children[u],r,!1)}}function xb(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function Eb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=xb(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&!o._children.includes(u)&&(o._children.push(u),u._parent=o,Sb(u,a,!1),u._siblingIndex=o._children.length-1,wb(u,!0))}}}}function Tb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=xb(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function Cb(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=xb(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function Ab(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var o=t[r];if(o&&o.targetInfo){if(!(i=xb(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof _t?a[c].set(o.value):a[c]=o.value}}}}function bb(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=xb(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var d=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(d&&d.targetMap&&(_=xb(f.localID,d.targetMap))){var p=a.propertyPath.slice(),m=s;if(p.length>0){var v=p.pop();if(!v)return;for(var g=0;g<p.length&&(m=m[p[g]]);g++);if(!m)continue;m[v]=_}}}}}}function wb(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){yb(e);var r={};i.targetMap=r,Sb(e,r,!0),Eb(0,i.mountedChildren,r),Cb(0,i.removedComponents,r),Tb(0,i.mountedComponents,r),Ab(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){wb(e,!0)}))}function Ib(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){wb(e)}))}h._PrefabInfo=gb;var Pb,Rb,Ob,Db,Nb,Mb,Lb,Bb,Fb,zb,Ub,Gb,kb,Hb,Vb=Object.freeze({__proto__:null,TargetInfo:hb,TargetOverrideInfo:_b,CompPrefabInfo:fb,PropertyOverrideInfo:db,MountedChildrenInfo:pb,MountedComponentsInfo:mb,PrefabInstance:vb,PrefabInfo:gb,createNodeWithPrefab:yb,generateTargetMap:Sb,getTarget:xb,applyMountedChildren:Eb,applyMountedComponents:Tb,applyRemovedComponents:Cb,applyPropertyOverrides:Ab,applyTargetOverrides:bb,expandPrefabInstanceNode:wb,expandNestedPrefabInstanceNode:Ib}),Wb=ct({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),jb=e("Prefab",Ic("cc.Prefab")((Lb=Mb=function(e){function t(){var t;return le(t=e.call(this)||this,"data",Ob,ae(t)),le(t,"optimizationPolicy",Db,ae(t)),le(t,"persistent",Nb,ae(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}ee(t,e);var n=t.prototype;return n.createNode=function(e){var t=h.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof h._BaseNode&&e,new aC(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||D(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==Wb.SINGLE_INSTANCE&&(this.optimizationPolicy===Wb.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new ub,this.data.name="(Missing Node)";var n=new h._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;Ib(e),bb(e)},t}(Mu),Mb.OptimizationPolicy=Wb,Mb.OptimizationPolicyThreshold=3,Ob=ue((Rb=Lb).prototype,"data",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Db=ue(Rb.prototype,"optimizationPolicy",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wb.AUTO}}),Nb=ue(Rb.prototype,"persistent",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pb=Rb))||Pb);ot.value(jb,"_utils",Vb),h.Prefab=jb,De(h,"cc._Prefab","Prefab"),e("PrefabLink",(Bb=Ic("cc.PrefabLink"),Fb=hl(jb),zb=Yc(),Bb((Hb=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"prefab",kb,ae(t)),t}return ee(t,e),t}(th),kb=ue((Gb=Hb).prototype,"prefab",[Fb,Bc,zb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ub=Gb))||Ub));var Xb=new Nn;function qb(e,t,n,i){i||(i=new Nn),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function Yb(e,t,n){return n||(n=new Nn),e.worldToScreen(t,n),n.x/=h.view.getScaleX(),n.y/=h.view.getScaleY(),n}var Kb,Qb,Zb=e("convertUtils",{WorldNode3DToLocalNodeUI:qb,WorldNode3DToWorldNodeUI:Yb});h.pipelineUtils=Zb,k(h.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||Xb;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),H(qm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),k(UE.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var Jb,$b=e("BufferAsset",Ic("cc.BufferAsset")((ue((Qb=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}ee(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},J(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(Mu)).prototype,"_nativeAsset",[fl],Object.getOwnPropertyDescriptor(Qb.prototype,"_nativeAsset"),Qb.prototype),Kb=Qb))||Kb);h.BufferAsset=$b;var ew=((Jb={})[gi.UNORM]="Uint",Jb[gi.SNORM]="Int",Jb[gi.UINT]="Uint",Jb[gi.INT]="Int",Jb[gi.UFLOAT]="Float",Jb[gi.FLOAT]="Float",Jb.default="Uint",Jb);function tw(e){return""+(ew[e.type]||ew.default)+e.size/e.count*8}function nw(e,t,n,i,r){void 0===n&&(n=vi.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=ao[n];r||(r=o.size);for(var a="set"+tw(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=hh.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<o.count;++_){var f=h+s*_;e[a](f,t[o.count*u+_],l)}}function iw(e,t,n,i,r,o){void 0===t&&(t=vi.R32F),void 0===n&&(n=0),void 0===i&&(i=e.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=ao[t];r||(r=a.size);for(var s="get"+tw(a),c=a.size/a.count,l=Math.floor(i/r),u=hh.isLittleEndian,h=0;h<l;++h)for(var _=n+r*h,f=0;f<a.count;++f){var d=_+c*f;o[a.count*h+f]=e[s](d,u)}return o}function rw(e,t,n,i,r,o,a){void 0===n&&(n=vi.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=ao[n];o||(o=s.size);for(var c="set"+tw(s),l="get"+tw(s),u=s.size/s.count,h=Math.floor(r/o),_=hh.isLittleEndian,f=0;f<h;++f)for(var d=i+o*f,p=0;p<s.count;++p){var m=d+u*p,v=e[l](m,_);a[c](m,t(v,p,e),_)}return a}var ow,aw,sw=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r,o){void 0===i&&(i=null),void 0===r&&(r=null),void 0===o&&(o=!0),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._isOwnerOfIndexBuffer=!0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new zr(t,e,i,r),this._isOwnerOfIndexBuffer=o,this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=e.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*s,d=h[_]*s,p=0;p<s;++p)u[f+p]=l[d+p];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new Br("a_vertexId",vi.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},J(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Nn.ZERO,max:Nn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Nn.ZERO,max:Nn.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,ir.ATTR_POSITION),i=e.readIndices(t),r=new Nn,o=new Nn,a=this.attributes.find((function(e){return e.name===ir.ATTR_POSITION}));if(a){var s=ao[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=h.director.root.device,c=0;c<a.vertexBundelIndices.length;c++){var l=o.vertexBundles[a.vertexBundelIndices[c]];r=0,i=vi.UNKNOWN;for(var u=0;u<l.attributes.length;u++){var _=l.attributes[u];if(_.name===ir.ATTR_JOINTS){i=_.format;break}r+=ao[_.format].size}i?function(){var u=new Uint8Array(e.mesh.data.buffer,l.view.offset,l.view.length),h=new DataView(u.slice().buffer),_=o.jointMaps[a.jointMapIndex];rw(h,(function(e){return _.indexOf(e)}),i,r,l.view.length,l.view.stride,h);var f=s.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,l.view.length,l.view.stride));f.update(h.buffer),t.push(f),n.push(c)}():t.push(this.vertexBuffers[a.vertexBundelIndices[c]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(ow||(ow=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(aw||(aw={})),h.SystemEventType=ow;var cw,lw=new Array(16),uw=null,hw=new Jn,_w=[cC.TOUCH_START,cC.TOUCH_MOVE,cC.TOUCH_END,cC.TOUCH_CANCEL],fw=[cC.MOUSE_DOWN,cC.MOUSE_ENTER,cC.MOUSE_MOVE,cC.MOUSE_LEAVE,cC.MOUSE_UP,cC.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(cw||(cw={}));var dw,pw,mw,vw,gw,yw,Sw,xw,Ew,Tw,Cw,Aw,bw,ww,Iw,Pw,Rw,Ow,Dw,Nw,Mw,Lw,Bw,Fw,zw,Uw,Gw,kw,Hw,Vw,Ww,jw,Xw,qw,Yw,Kw,Qw,Zw,Jw,$w,eI,tI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,_I,fI,dI,pI,mI,vI,gI,yI,SI,xI,EI,TI,CI,AI,bI,wI,II,PI,RI,OI,DI,NI,MI,LI,BI,FI,zI,UI,GI,kI,HI,VI,WI,jI,XI,qI,YI,KI,QI,ZI,JI,$I,eP,tP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,dP,pP,mP,vP,gP,yP,SP,xP,EP,TP,CP,AP,bP,wP,IP,PP,RP,OP,DP,NP,MP,LP,BP,FP,zP,UP,GP,kP,HP,VP,WP,jP,XP=function(){function e(e){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._isEnabled=!1,this._node=void 0,this._node=e}var t=e.prototype;return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(cw.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){uw===this._node&&(uw=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(cw.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.on=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},t.once=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},t.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(cw.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(e,t,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,lw.length=0,this.getCapturingTargets(e.type,lw),e.eventPhase=1,i=lw.length-1;i>=0;--i)if((t=lw[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,lw),e.propagationStopped))return void(lw.length=0);if(lw.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,lw),e.eventPhase=3,i=0;i<lw.length;++i)if((t=lw[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(lw.length=0);lw.length=0},t.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},t.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},t.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},t._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&ub.isNode(r);r=r.parent,++n){var o=r.getComponent(e);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t._isTouchEvent=function(e){return-1!==_w.indexOf(e)},t._isMouseEvent=function(e){return-1!==fw.indexOf(e)},t._hasTouchListeners=function(){for(var e=0;e<_w.length;++e){var t=_w[e];if(this.hasEventListener(t))return!0}return!1},t._hasMouseListeners=function(){for(var e=0;e<fw.length;++e){var t=fw[e];if(this.hasEventListener(t))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(cw.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new ru;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(cw.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t._handleEventMouse=function(e){switch(e.type){case aw.MOUSE_DOWN:return this._handleMouseDown(e);case aw.MOUSE_MOVE:return this._handleMouseMove(e);case aw.MOUSE_UP:return this._handleMouseUp(e);case aw.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},t._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(hw),!t._uiProps.uiTransformComp.hitTest(hw)||(e.type=cC.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(hw),t._uiProps.uiTransformComp.hitTest(hw)?(this.previousMouseIn||(uw&&uw!==t&&(e.type=cC.MOUSE_LEAVE,uw.dispatchEvent(e),uw.eventProcessor.previousMouseIn=!1),uw=t,e.type=cC.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=cC.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=cC.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,uw=null),1)))},t._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(hw),!t._uiProps.uiTransformComp.hitTest(hw)||(e.type=cC.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(hw),!t._uiProps.uiTransformComp.hitTest(hw)||(e.type=cC.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleEventTouch=function(e){switch(e.type){case aw.TOUCH_START:return this._handleTouchStart(e);case aw.TOUCH_MOVE:return this._handleTouchMove(e);case aw.TOUCH_END:return this._handleTouchEnd(e);case aw.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},t._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(hw),!t._uiProps.uiTransformComp.hitTest(hw)||(e.type=cC.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},t._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=cC.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},t._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getLocation(hw),t._uiProps.uiTransformComp.hitTest(hw)?e.type=cC.TOUCH_END:e.type=cC.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},t._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=cC.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},J(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();XP._maskComp=null,XP.callbacksInvoker=new ru,h.NodeEventProcessor=XP;var qP=new Nn(0,1,0),YP=new Nn,KP=new ni,QP=new On,ZP=new Gn,JP=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},$P=e("AmbientInfo",(dw=Ic("cc.AmbientInfo"),pw=Yc(),mw=Zc(),vw=hl(Bt),gw=Zc(),yw=Yc(),Sw=Zc(),xw=Fc("_skyColor"),Ew=Fc("_skyIllum"),Tw=Fc("_groundAlbedo"),dw((ue((Aw=function(){function e(){le(this,"_skyColorHDR",bw,this),le(this,"_skyIllumHDR",ww,this),le(this,"_groundAlbedoHDR",Iw,this),le(this,"_skyColorLDR",Pw,this),le(this,"_skyIllumLDR",Rw,this),le(this,"_groundAlbedoLDR",Ow,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},J(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=h.director.root.pipeline.pipelineSceneData.isHDR;return KP.set(e?this._skyColorHDR:this._skyColorLDR),JP(KP),QP.set(255*KP.x,255*KP.y,255*KP.z,255)},set:function(e){KP.set(e.x,e.y,e.z,e.w),h.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(KP):this._skyColorLDR.set(KP),this._resource&&this._resource.skyColor.set(KP)}},{key:"skyColor",set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=h.director.root.pipeline.pipelineSceneData.isHDR;return KP.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),JP(KP),QP.set(255*KP.x,255*KP.y,255*KP.z,255)},set:function(e){KP.set(e.x,e.y,e.z,e.w),h.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(KP):this._groundAlbedoLDR.set(KP),this._resource&&this._resource.groundAlbedo.set(KP)}},{key:"groundAlbedo",set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}()).prototype,"skyLightingColor",[pw,qc,mw],Object.getOwnPropertyDescriptor(Aw.prototype,"skyLightingColor"),Aw.prototype),ue(Aw.prototype,"skyIllum",[qc,vw,gw],Object.getOwnPropertyDescriptor(Aw.prototype,"skyIllum"),Aw.prototype),ue(Aw.prototype,"groundLightingColor",[yw,qc,Sw],Object.getOwnPropertyDescriptor(Aw.prototype,"groundLightingColor"),Aw.prototype),bw=ue(Aw.prototype,"_skyColorHDR",[Bc,xw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(.2,.5,.8,1)}}),ww=ue(Aw.prototype,"_skyIllumHDR",[Bc,Ew],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hy.SKY_ILLUM}}),Iw=ue(Aw.prototype,"_groundAlbedoHDR",[Bc,Tw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(.2,.2,.2,1)}}),Pw=ue(Aw.prototype,"_skyColorLDR",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(.2,.5,.8,1)}}),Rw=ue(Aw.prototype,"_skyIllumLDR",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hy.SKY_ILLUM}}),Ow=ue(Aw.prototype,"_groundAlbedoLDR",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(.2,.2,.2,1)}}),Cw=Aw))||Cw));h.AmbientInfo=$P;var eR=e("SkyboxInfo",(Dw=Ic("cc.SkyboxInfo"),Nw=Zc(),Mw=hl(my),Lw=Zc(),Bw=Zc(),Fw=hl(yv),zw=Zc(),Uw=Yc(),Gw=hl(yv),kw=il(),Hw=hl(yv),Vw=Fc("_envmap"),Ww=hl(yv),jw=hl(yv),Xw=hl(yv),Dw((ue((Yw=function(){function e(){le(this,"_envLightingType",Kw,this),le(this,"_envmapHDR",Qw,this),le(this,"_envmapLDR",Zw,this),le(this,"_diffuseMapHDR",Jw,this),le(this,"_diffuseMapLDR",$w,this),le(this,"_enabled",eI,this),le(this,"_useHDR",tI,this),this._resource=null}return e.prototype.activate=function(e){this.envLightingType=this._envLightingType,this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},J(e,[{key:"applyDiffuseMap",get:function(){return my.DIFFUSEMAP_WITH_REFLECTION===this._envLightingType},set:function(e){this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"envLightingType",get:function(){return this._envLightingType},set:function(e){this.envmap||my.HEMISPHERE_DIFFUSE===e?(my.HEMISPHERE_DIFFUSE===e?(this.useIBL=!1,this.applyDiffuseMap=!1):my.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION===e?(this.useIBL=!0,this.applyDiffuseMap=!1):my.DIFFUSEMAP_WITH_REFLECTION===e&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=e):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=my.HEMISPHERE_DIFFUSE,D(15001))}},{key:"useIBL",get:function(){return my.HEMISPHERE_DIFFUSE!==this._envLightingType},set:function(e){this._resource&&(this._resource.useIBL=e)}},{key:"useHDR",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,this.envLightingType===my.DIFFUSEMAP_WITH_REFLECTION&&(null===this.diffuseMap?(this.envLightingType=my.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION,D(15e3)):this.diffuseMap.isDefault&&D(15002))),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){var t=h.director.root.pipeline.pipelineSceneData.isHDR;t?this._envmapHDR=e:this._envmapLDR=e,e||(t?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=my.HEMISPHERE_DIFFUSE,D(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}()).prototype,"enabled",[qc,Nw],Object.getOwnPropertyDescriptor(Yw.prototype,"enabled"),Yw.prototype),ue(Yw.prototype,"envLightingType",[qc,Mw,Lw],Object.getOwnPropertyDescriptor(Yw.prototype,"envLightingType"),Yw.prototype),ue(Yw.prototype,"useHDR",[qc,Bw],Object.getOwnPropertyDescriptor(Yw.prototype,"useHDR"),Yw.prototype),ue(Yw.prototype,"envmap",[qc,Fw,zw],Object.getOwnPropertyDescriptor(Yw.prototype,"envmap"),Yw.prototype),ue(Yw.prototype,"diffuseMap",[Uw,qc,Kc,Gw,kw],Object.getOwnPropertyDescriptor(Yw.prototype,"diffuseMap"),Yw.prototype),Kw=ue(Yw.prototype,"_envLightingType",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return my.HEMISPHERE_DIFFUSE}}),Qw=ue(Yw.prototype,"_envmapHDR",[Bc,Hw,Vw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zw=ue(Yw.prototype,"_envmapLDR",[Bc,Ww],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jw=ue(Yw.prototype,"_diffuseMapHDR",[Bc,jw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$w=ue(Yw.prototype,"_diffuseMapLDR",[Bc,Xw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eI=ue(Yw.prototype,"_enabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tI=ue(Yw.prototype,"_useHDR",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qw=Yw))||qw));h.SkyboxInfo=eR;var tR=e("FogInfo",(nI=Ic("cc.FogInfo"),iI=Zc(),rI=il(),oI=Zc(),aI=il(),sI=Zc(),cI=hl(yy),lI=il(),uI=Zc(),hI=Yc(),_I=hl(Bt),fI=Jc(),dI=tl(),pI=Zc(),mI=Yc(),vI=hl(Bt),gI=tl(),yI=Zc(),SI=Yc(),xI=hl(Bt),EI=tl(),TI=Zc(),CI=Yc(),AI=hl(Bt),bI=$c(),wI=tl(),II=Zc(),PI=Yc(),RI=hl(Bt),OI=tl(),DI=Zc(),NI=Yc(),MI=hl(Bt),LI=tl(),BI=Zc(),nI((QI=KI=function(){function e(){le(this,"_type",UI,this),le(this,"_fogColor",GI,this),le(this,"_enabled",kI,this),le(this,"_fogDensity",HI,this),le(this,"_fogStart",VI,this),le(this,"_fogEnd",WI,this),le(this,"_fogAtten",jI,this),le(this,"_fogTop",XI,this),le(this,"_fogRange",qI,this),le(this,"_accurate",YI,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),KI.FogType=yy,ue((zI=QI).prototype,"enabled",[qc,iI,rI],Object.getOwnPropertyDescriptor(zI.prototype,"enabled"),zI.prototype),ue(zI.prototype,"accurate",[qc,oI,aI],Object.getOwnPropertyDescriptor(zI.prototype,"accurate"),zI.prototype),ue(zI.prototype,"fogColor",[qc,sI],Object.getOwnPropertyDescriptor(zI.prototype,"fogColor"),zI.prototype),ue(zI.prototype,"type",[qc,cI,lI,uI],Object.getOwnPropertyDescriptor(zI.prototype,"type"),zI.prototype),ue(zI.prototype,"fogDensity",[hI,_I,fI,dI,nl,pI],Object.getOwnPropertyDescriptor(zI.prototype,"fogDensity"),zI.prototype),ue(zI.prototype,"fogStart",[mI,vI,gI,yI],Object.getOwnPropertyDescriptor(zI.prototype,"fogStart"),zI.prototype),ue(zI.prototype,"fogEnd",[SI,xI,EI,TI],Object.getOwnPropertyDescriptor(zI.prototype,"fogEnd"),zI.prototype),ue(zI.prototype,"fogAtten",[CI,AI,bI,wI,II],Object.getOwnPropertyDescriptor(zI.prototype,"fogAtten"),zI.prototype),ue(zI.prototype,"fogTop",[PI,RI,OI,DI],Object.getOwnPropertyDescriptor(zI.prototype,"fogTop"),zI.prototype),ue(zI.prototype,"fogRange",[NI,MI,LI,BI],Object.getOwnPropertyDescriptor(zI.prototype,"fogRange"),zI.prototype),UI=ue(zI.prototype,"_type",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yy.LINEAR}}),GI=ue(zI.prototype,"_fogColor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On("#C8C8C8")}}),kI=ue(zI.prototype,"_enabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HI=ue(zI.prototype,"_fogDensity",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),VI=ue(zI.prototype,"_fogStart",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),WI=ue(zI.prototype,"_fogEnd",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),jI=ue(zI.prototype,"_fogAtten",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),XI=ue(zI.prototype,"_fogTop",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),qI=ue(zI.prototype,"_fogRange",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),YI=ue(zI.prototype,"_accurate",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FI=zI))||FI)),nR=e("ShadowsInfo",(ZI=Ic("cc.ShadowsInfo"),JI=Zc(),$I=hl(dg),eP=Yc(),tP=Yc(),nP=Zc(),iP=hl(Bt),rP=Yc(),oP=Zc(),aP=hl(Lt),sP=Zc(),cP=Yc(),lP=hl(fg),uP=Zc(),hP=Yc(),ZI((ue((fP=function(){function e(){le(this,"_enabled",dP,this),le(this,"_type",pP,this),le(this,"_normal",mP,this),le(this,"_distance",vP,this),le(this,"_shadowColor",gP,this),le(this,"_maxReceived",yP,this),le(this,"_size",SP,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(ZP),this.planeDirection=Nn.transformQuat(YP,qP,ZP),e.getWorldPosition(YP),this.planeHeight=Nn.dot(this._normal,YP)},t.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"planeDirection",get:function(){return this._normal},set:function(e){Nn.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"planeHeight",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=-e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"enabled",[qc,JI],Object.getOwnPropertyDescriptor(fP.prototype,"enabled"),fP.prototype),ue(fP.prototype,"type",[qc,$I],Object.getOwnPropertyDescriptor(fP.prototype,"type"),fP.prototype),ue(fP.prototype,"shadowColor",[eP],Object.getOwnPropertyDescriptor(fP.prototype,"shadowColor"),fP.prototype),ue(fP.prototype,"planeDirection",[tP,nP],Object.getOwnPropertyDescriptor(fP.prototype,"planeDirection"),fP.prototype),ue(fP.prototype,"planeHeight",[qc,iP,rP,oP],Object.getOwnPropertyDescriptor(fP.prototype,"planeHeight"),fP.prototype),ue(fP.prototype,"maxReceived",[aP,sP,cP],Object.getOwnPropertyDescriptor(fP.prototype,"maxReceived"),fP.prototype),ue(fP.prototype,"shadowMapSize",[lP,uP,hP],Object.getOwnPropertyDescriptor(fP.prototype,"shadowMapSize"),fP.prototype),dP=ue(fP.prototype,"_enabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pP=ue(fP.prototype,"_type",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dg.Planar}}),mP=ue(fP.prototype,"_normal",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(0,1,0)}}),vP=ue(fP.prototype,"_distance",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gP=ue(fP.prototype,"_shadowColor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(0,0,0,76)}}),yP=ue(fP.prototype,"_maxReceived",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),SP=ue(fP.prototype,"_size",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(512,512)}}),_P=fP))||_P));h.ShadowsInfo=nR;var iR=e("DEFAULT_WORLD_MIN_POS",new Nn(-1024,-1024,-1024)),rR=e("DEFAULT_WORLD_MAX_POS",new Nn(1024,1024,1024)),oR=e("DEFAULT_OCTREE_DEPTH",8),aR=e("OctreeInfo",(xP=Ic("cc.OctreeInfo"),EP=Zc(),TP=Zc(),CP=Qc(),AP=Zc(),bP=Qc(),wP=Jc(),IP=hl(Lt),PP=Zc(),xP((ue((OP=function(){function e(){le(this,"_enabled",DP,this),le(this,"_minPos",NP,this),le(this,"_maxPos",MP,this),le(this,"_depth",LP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}()).prototype,"enabled",[qc,EP],Object.getOwnPropertyDescriptor(OP.prototype,"enabled"),OP.prototype),ue(OP.prototype,"minPos",[qc,TP,CP],Object.getOwnPropertyDescriptor(OP.prototype,"minPos"),OP.prototype),ue(OP.prototype,"maxPos",[qc,AP,bP],Object.getOwnPropertyDescriptor(OP.prototype,"maxPos"),OP.prototype),ue(OP.prototype,"depth",[qc,wP,nl,IP,PP],Object.getOwnPropertyDescriptor(OP.prototype,"depth"),OP.prototype),DP=ue(OP.prototype,"_enabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NP=ue(OP.prototype,"_minPos",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(iR)}}),MP=ue(OP.prototype,"_maxPos",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(rR)}}),LP=ue(OP.prototype,"_depth",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oR}}),RP=OP))||RP)),sR=e("SceneGlobals",(BP=Ic("cc.SceneGlobals"),FP=hl(eR),BP((jP=function(){function e(){le(this,"ambient",GP,this),le(this,"shadows",kP,this),le(this,"_skybox",HP,this),le(this,"fog",VP,this),le(this,"octree",WP,this)}return e.prototype.activate=function(){var e=h.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},J(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),GP=ue((UP=jP).prototype,"ambient",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $P}}),kP=ue(UP.prototype,"shadows",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nR}}),HP=ue(UP.prototype,"_skybox",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new eR}}),VP=ue(UP.prototype,"fog",[qc,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tR}}),ue(UP.prototype,"skybox",[qc,FP],Object.getOwnPropertyDescriptor(UP.prototype,"skybox"),UP.prototype),WP=ue(UP.prototype,"octree",[qc,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new aR}}),zP=UP))||zP));h.SceneGlobals=sR;var cR=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());cR.NO_TYPE="no_type",cR.TOUCH="touch",cR.MOUSE="mouse",cR.KEYBOARD="keyboard",cR.ACCELERATION="acceleration",cR.NONE=0,cR.CAPTURING_PHASE=1,cR.AT_TARGET=2,cR.BUBBLING_PHASE=3,h.Event=cR;var lR=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,ow.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return ee(t,e),t}(cR));cR.EventAcceleration=lR;var uR=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?ow.KEY_DOWN:ow.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==ow.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return ee(t,e),J(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(cR));cR.EventKeyboard=uR;var hR=e("EventMouse",function(e){function t(n,i,r){var o;return(o=e.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=t.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}ee(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new Jn),Jn.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new Jn),Jn.set(e,this._x,h.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new Jn),Jn.set(e,this._x,this._y),h.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new Jn),Jn.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new Jn),Jn.set(e,this._prevX,this._prevY),h.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new Jn),Jn.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new Jn),Jn.set(e,(this._x-this._prevX)/h.view.getScaleX(),(this._y-this._prevY)/h.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/h.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/h.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=h.view.getViewportRect();return(this._x-e.x)/h.view.getScaleX()},n.getUILocationY=function(){var e=h.view.getViewportRect();return(this._y-e.y)/h.view.getScaleY()},J(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(cR));hR.BUTTON_MISSING=-1,hR.BUTTON_LEFT=0,hR.BUTTON_RIGHT=2,hR.BUTTON_MIDDLE=1,hR.BUTTON_4=3,hR.BUTTON_5=4,hR.BUTTON_6=5,hR.BUTTON_7=6,hR.BUTTON_8=7,cR.EventMouse=hR;var _R=new Jn,fR=e("EventTouch",function(e){function t(t,n,i,r){var o;return void 0===r&&(r=[]),(o=e.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=t||[],o._allTouches=r,o}ee(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new Jn},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new Jn},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new Jn},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new Jn},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new Jn},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new Jn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new Jn},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new Jn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(_R).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(_R).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(cR));fR.MAX_TOUCHES=5,cR.EventTouch=fR;var dR,pR=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(dR||(dR=e("KeyCode",{})));var mR=new Jn,vR=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new Jn,this._prevPoint=new Jn,this._lastModified=0,this._id=0,this._startPoint=new Jn,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new Jn),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new Jn),e.set(this._point.x,this._point.y),h.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=h.view.getViewportRect();return(this._point.x-e.x)/h.view.getScaleX()},t.getUILocationY=function(){var e=h.view.getViewportRect();return(this._point.y-e.y)/h.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new Jn),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new Jn),e.set(this._prevPoint.x,this._prevPoint.y),h.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new Jn),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new Jn),e.set(this._startPoint.x,this._startPoint.y),h.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new Jn),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new Jn),mR.set(this._point),mR.subtract(this._prevPoint),e.set(h.view.getScaleX(),h.view.getScaleY()),Jn.divide(e,mR,e),e},t.getLocationInView=function(e){return e||(e=new Jn),e.set(this._point.x,h.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new Jn),e.set(this._prevPoint.x,h.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new Jn),e.set(this._startPoint.x,h.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new Jn(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new Jn(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=h.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new Jn(e.x,e.y):new Jn(e||0,t||0),this._lastModified=h.game.frameStartTime},J(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());h.Touch=vR;var gR,yR,SR=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new _u,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,vu.browserType===au.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=e;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(ch.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),vu.os===lu.ANDROID&&vu.browserType!==au.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new pR(n,i,r,l),h=new lR(u);this._eventTarget.emit(aw.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),xR={Backspace:dR.BACKSPACE,Tab:dR.TAB,Enter:dR.ENTER,ShiftLeft:dR.SHIFT_LEFT,ControlLeft:dR.CTRL_LEFT,AltLeft:dR.ALT_LEFT,ShiftRight:dR.SHIFT_RIGHT,ControlRight:dR.CTRL_RIGHT,AltRight:dR.ALT_RIGHT,Pause:dR.PAUSE,CapsLock:dR.CAPS_LOCK,Escape:dR.ESCAPE,Space:dR.SPACE,PageUp:dR.PAGE_UP,PageDown:dR.PAGE_DOWN,End:dR.END,Home:dR.HOME,ArrowLeft:dR.ARROW_LEFT,ArrowUp:dR.ARROW_UP,ArrowRight:dR.ARROW_RIGHT,ArrowDown:dR.ARROW_DOWN,Insert:dR.INSERT,Delete:dR.DELETE,Digit0:dR.DIGIT_0,Digit1:dR.DIGIT_1,Digit2:dR.DIGIT_2,Digit3:dR.DIGIT_3,Digit4:dR.DIGIT_4,Digit5:dR.DIGIT_5,Digit6:dR.DIGIT_6,Digit7:dR.DIGIT_7,Digit8:dR.DIGIT_8,Digit9:dR.DIGIT_9,KeyA:dR.KEY_A,KeyB:dR.KEY_B,KeyC:dR.KEY_C,KeyD:dR.KEY_D,KeyE:dR.KEY_E,KeyF:dR.KEY_F,KeyG:dR.KEY_G,KeyH:dR.KEY_H,KeyI:dR.KEY_I,KeyJ:dR.KEY_J,KeyK:dR.KEY_K,KeyL:dR.KEY_L,KeyM:dR.KEY_M,KeyN:dR.KEY_N,KeyO:dR.KEY_O,KeyP:dR.KEY_P,KeyQ:dR.KEY_Q,KeyR:dR.KEY_R,KeyS:dR.KEY_S,KeyT:dR.KEY_T,KeyU:dR.KEY_U,KeyV:dR.KEY_V,KeyW:dR.KEY_W,KeyX:dR.KEY_X,KeyY:dR.KEY_Y,KeyZ:dR.KEY_Z,Numpad0:dR.NUM_0,Numpad1:dR.NUM_1,Numpad2:dR.NUM_2,Numpad3:dR.NUM_3,Numpad4:dR.NUM_4,Numpad5:dR.NUM_5,Numpad6:dR.NUM_6,Numpad7:dR.NUM_7,Numpad8:dR.NUM_8,Numpad9:dR.NUM_9,NumpadMultiply:dR.NUM_MULTIPLY,NumpadAdd:dR.NUM_PLUS,NumpadSubtract:dR.NUM_SUBTRACT,NumpadDecimal:dR.NUM_DECIMAL,NumpadDivide:dR.NUM_DIVIDE,NumpadEnter:dR.NUM_ENTER,F1:dR.F1,F2:dR.F2,F3:dR.F3,F4:dR.F4,F5:dR.F5,F6:dR.F6,F7:dR.F7,F8:dR.F8,F9:dR.F9,F10:dR.F10,F11:dR.F11,F12:dR.F12,NumLock:dR.NUM_LOCK,ScrollLock:dR.SCROLL_LOCK,Semicolon:dR.SEMICOLON,Equal:dR.EQUAL,Comma:dR.COMMA,Minus:dR.DASH,Period:dR.PERIOD,Slash:dR.SLASH,Backquote:dR.BACK_QUOTE,BracketLeft:dR.BRACKET_LEFT,Backslash:dR.BACKSLASH,BracketRight:dR.BRACKET_RIGHT,Quote:dR.QUOTE},ER=function(){function e(){this._eventTarget=new _u,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,aw.KEY_PRESSING);e._eventTarget.emit(aw.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,aw.KEY_DOWN);e._eventTarget.emit(aw.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,aw.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(aw.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,xR[n]||dR.NONE);return new uR(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),TR=function(){function e(){this._canvas=void 0,this._eventTarget=new _u,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Jn,vu.hasFeature(hu.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new si(t.x,t.y,t.width,t.height):new si(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=ch.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new Jn(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(aw.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(aw.MOUSE_MOVE));var o=this._createCallback(aw.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),o=n.button;switch(e){case aw.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case aw.MOUSE_UP:t._isPressed=!1;break;case aw.MOUSE_MOVE:t._isPressed||(o=hR.BUTTON_MISSING)}var a=new hR(e,!1,t._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,a)}},t._handleMouseWheel=function(e){var t=aw.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new hR(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),CR=new Jn,AR=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(CR);var n=new vR(CR.x,CR.y,t);return e.getLocation(CR),n.setPoint(CR.x,CR.y),e.getPreviousLocation(CR),n.setPrevPoint(CR),n},t._createTouch=function(e,t,n){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var i=new vR(t,n,e);return this._touchMap.set(e,i),this._updateTouch(i,t,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e,t,n){var i=this._touchMap.get(e);return i?this._updateTouch(i,t,n):i=this._createTouch(e,t,n),i?this._cloneTouch(i):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touchMap.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(CR),e.setPrevPoint(CR),e.setPoint(t,n)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var n=ft.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(e){i-e.lastModified>ft.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),n>=this._touchMap.size},e}()),bR=function(){function e(){this._canvas=void 0,this._eventTarget=new _u,vu.hasFeature(hu.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(aw.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(aw.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(aw.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(aw.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=AR.getTouch(l,u.x,u.y);h&&(e!==aw.TOUCH_END&&e!==aw.TOUCH_CANCEL||AR.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===aw.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),o.length>0){var _=new fR(o,!1,e,ft.ENABLE_MULTI_TOUCH?AR.getAllTouches():o);t._eventTarget.emit(e,_)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new si(t.x,t.y,t.width,t.height):new si(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(ch.isFrameRotated){var r=n;n=t.height-i,i=r}var o=ch.devicePixelRatio;return new Jn(n*=o,i*=o)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(yR||(yR={}));var wR=function(){function e(e){this.priority=yR.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),IR=((gR={})[aw.MOUSE_DOWN]=aw.TOUCH_START,gR[aw.MOUSE_MOVE]=aw.TOUCH_MOVE,gR[aw.MOUSE_UP]=aw.TOUCH_END,gR),PR=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new _u,this._touchInput=new bR,this._mouseInput=new TR,this._keyboardInput=new ER,this._accelerometerInput=new SR,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new wR(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var t=e.prototype;return t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=IR[e.type],n=AR.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new fR(i,!1,t,i);t===aw.TOUCH_END&&AR.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,n=0;n<t&&this._eventDispatcherList[n].dispatchEvent(e);++n);},t._registerEvent=function(){var e=this;if(hh.hasFeature(hh.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(aw.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(aw.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(aw.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(aw.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(hh.hasFeature(hh.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(aw.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(aw.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(aw.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(aw.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(hh.hasFeature(hh.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(aw.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(aw.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(aw.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(hh.hasFeature(hh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(aw.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var d=h[_];this._emitEvent(d)}for(var p=this._eventAccelerationList,m=0,v=p.length;m<v;++m){var g=p[m];this._emitEvent(g)}this._clearEvents()},e}());PR.EventType=aw;var RR=e("input",new PR),OR=e("SystemEvent",function(e){function t(){var t;return t=e.call(this)||this,RR.on(aw.MOUSE_DOWN,(function(e){t.emit(ow.MOUSE_DOWN,e)})),RR.on(aw.MOUSE_MOVE,(function(e){t.emit(ow.MOUSE_MOVE,e)})),RR.on(aw.MOUSE_UP,(function(e){t.emit(ow.MOUSE_UP,e)})),RR.on(aw.MOUSE_WHEEL,(function(e){t.emit(ow.MOUSE_WHEEL,e)})),RR.on(aw.TOUCH_START,(function(e){t.emit(ow.TOUCH_START,e.touch,e)})),RR.on(aw.TOUCH_MOVE,(function(e){t.emit(ow.TOUCH_MOVE,e.touch,e)})),RR.on(aw.TOUCH_END,(function(e){t.emit(ow.TOUCH_END,e.touch,e)})),RR.on(aw.TOUCH_CANCEL,(function(e){t.emit(ow.TOUCH_CANCEL,e.touch,e)})),RR.on(aw.KEY_DOWN,(function(e){t.emit(ow.KEY_DOWN,e)})),RR.on(aw.KEY_PRESSING,(function(e){t.emit(ow.KEY_DOWN,e)})),RR.on(aw.KEY_UP,(function(e){t.emit(ow.KEY_UP,e)})),RR.on(aw.DEVICEMOTION,(function(e){t.emit(ow.DEVICEMOTION,e)})),t}ee(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){RR.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){RR.setAccelerometerInterval(e)},n.on=function(t,n,i,r){return e.prototype.on.call(this,t,n,i,r),n},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i)},t}(_u));OR.EventType=ow,h.SystemEvent=OR;var DR,NR=e("systemEvent",new OR);h.systemEvent=NR,k(ow,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),k(cR,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:OR.EventType,targetName:"SystemEvent.EventType"}]),V(cR,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),k(hR,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:OR.EventType,targetName:"SystemEvent.EventType"}}))),k(hR,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:OR.EventType,targetName:"SystemEvent.EventType"}]),V(hR.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),k(fR,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:OR.EventType,targetName:"SystemEvent.EventType"}]),k(fR,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:OR.EventType,targetName:"SystemEvent.EventType"}]),k(fR,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:OR.EventType,targetName:"SystemEvent.EventType"}]),k(fR,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:OR.EventType,targetName:"SystemEvent.EventType"}]),V(fR.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),k(fR.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:fR,targetName:"EventTouch"}]),V(ft.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),V(ft.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),V(ft.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),V(ft.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),V(ft,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),k(LC.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),k(ub.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Jn),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new oi),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),H(sR.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),k(sR.prototype,"SceneGlobals.prototype",[{name:"distance",newName:"planeHeight"},{name:"normal",newName:"planeDirection"}]),H(ub.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),k(gC.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),H(Pd,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),k(Pd,"Layers",[{name:"Default",newName:"DEFAULT",target:Pd.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Pd.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Pd.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Pd.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Pd.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Pd.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Pd.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Pd.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Pd,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Pd,targetName:"Layers"}]),H(Pd.Enum,"Layers.Enum",[{name:"ALWAYS"}]),H(Pd.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var MR,LR,BR,FR,zR=yl.Flags.HideInHierarchy,UR=yl.Flags.DontSave,GR=e("PrivateNode",Ic("cc.PrivateNode")(DR=function(e){function t(t){var n;return D(12003,(n=e.call(this,t)||this).name),n.hideFlags|=UR|zR,n}return ee(t,e),t}(ub))||DR);k(ow,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:ub.EventType,targetName:"Node.EventType"}}))),k(ub.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:OR.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:OR.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:OR.EventType,targetName:"SystemEvent.EventType"}]),h.PrivateNode=GR;var kR=e("Scene",Ic("cc.Scene")((ue((LR=function(e){ee(n,e);var t=n.prototype;function n(t){var n;return le(n=e.call(this,t)||this,"autoReleaseAssets",BR,ae(n)),le(n,"_globals",FR,ae(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=Nn.ZERO,n._rot=Gn.IDENTITY,n._scale=Nn.ONE,n._mat=Yn.IDENTITY,n._dirtyFlags=0,n._lpos=Nn.ZERO,n._lrot=Gn.IDENTITY,n._lscale=Nn.ONE,n._activeInHierarchy=!1,h.director&&h.director.root&&(n._renderScene=h.director.root.createScene({})),n._inited=!h.game||!h.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=yl.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&h.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(z(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return Nn.copy(e||new Nn,Nn.ZERO)},t.getRotation=function(e){return Gn.copy(e||new Gn,Gn.IDENTITY)},t.getScale=function(e){return Nn.copy(e||new Nn,Nn.ONE)},t.getWorldPosition=function(e){return Nn.copy(e||new Nn,Nn.ZERO)},t.getWorldRotation=function(e){return Gn.copy(e||new Gn,Gn.IDENTITY)},t.getWorldScale=function(e){return Nn.copy(e||new Nn,Nn.ONE)},t.getWorldMatrix=function(e){return Yn.copy(e||new Yn,Yn.IDENTITY)},t.getWorldRS=function(e){return Yn.copy(e||new Yn,Yn.IDENTITY)},t.getWorldRT=function(e){return Yn.copy(e||new Yn,Yn.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(Ib(this),bb(this),this._onBatchCreated(false),this._inited=!0),this.walk(LC._setScene)},t._activate=function(e){e=!1!==e,h.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},J(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return Nn.ZERO}},{key:"worldPosition",get:function(){return Nn.ZERO}},{key:"rotation",get:function(){return Gn.IDENTITY}},{key:"worldRotation",get:function(){return Gn.IDENTITY}},{key:"scale",get:function(){return Nn.ONE}},{key:"worldScale",get:function(){return Nn.ONE}},{key:"eulerAngles",get:function(){return Nn.ZERO}},{key:"worldMatrix",get:function(){return Yn.IDENTITY}}]),n}(LC)).prototype,"globals",[qc],Object.getOwnPropertyDescriptor(LR.prototype,"globals"),LR.prototype),BR=ue(LR.prototype,"autoReleaseAssets",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FR=ue(LR.prototype,"_globals",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new sR}}),MR=LR))||MR);function HR(e,t){if(!t){var n=h.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}h.Scene=kR,h.find=HR;var VR=rt.fastRemoveAt,WR=yl.Flags.IsStartCalled,jR=yl.Flags.IsOnEnableCalled;function XR(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function qR(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}yl.Flags.IsEditorOnEnableCalled;var YR=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=he;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function KR(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}YR.stableRemoveInactive=qR;var QR=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){qR(this._zero,e),qR(this._neg,e),qR(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(KR),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(KR),this._invoke(t),t.array.length=0)},t}(YR),ZR=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=XR(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=XR(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(YR);function JR(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",r=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,r){try{t(i,r)}catch(t){h._throw(t);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{e(o[i.i],r)}catch(e){h._throw(e),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}var $R=JR("c.start();c._objFlags|="+WR,!1,WR),eO=JR("c.update(dt)",!0),tO=JR("c.lateUpdate(dt)",!0),nO=function(e){var t=h.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},iO=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new QR($R),this.updateInvoker=new ZR(eO),this.lateUpdateInvoker=new ZR(tO),this._updating=!1},t._onEnabled=function(e){h.director.getScheduler().resumeTarget(e),e._objFlags|=jR,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){h.director.getScheduler().pauseTarget(e),e._objFlags&=~jR;var t=this._deferredComps.indexOf(e);t>=0?VR(this._deferredComps,t):(!e.start||e._objFlags&WR||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&jR)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&jR&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&WR||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),rO=yl.Flags.IsPreloadStarted,oO=yl.Flags.IsOnLoadStarted,aO=yl.Flags.IsOnLoadCalled,sO=yl.Flags.Deactivating,cO=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){YR.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(YR),lO=JR("c.__preload();"),uO=JR("c.onLoad();c._objFlags|="+aO,!1,aO),hO=new it(4);function _O(e,t,n){M(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):rt.removeAt(e._components,n)}hO.get=function(){var e=this._get()||{preload:new cO(lO),onLoad:new QR(uO),onEnable:new QR(nO)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var fO,dO,pO,mO,vO,gO,yO,SO,xO=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=hO.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),hO.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=ce(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(rO),o.onLoad.cancelInactive(oO),o.onEnable.cancelInactive()}}e.emit(cC.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,i){if(xl(e,!0)&&(e._objFlags&rO||(e._objFlags|=rO,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&oO||(e._objFlags|=oO,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=aO):e._objFlags|=aO),e._enabled)){if(!e.node._activeInHierarchy)return;h.director._compScheduler.enableComp(e,i)}},t.destroyComp=function(e){h.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&aO&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,i){if(e._objFlags&sO)M(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,o=0;o<r;++o){var a=e._components[o];a instanceof h.Component?this.activateComp(a,t,n,i):(_O(e,a,o),--o,--r)}for(var s=0,c=e._children.length;s<c;++s){var l=e._children[s];l._active&&this._activateNodeRecursively(l,t,n,i)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=sO,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(h.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~sO)}for(var r=0,o=e._children.length;r<o;++r){var a=e._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~sO)}e._onPostActivated(!1),e._objFlags&=~sO},e}()),EO=e("SceneAsset",Ic("cc.SceneAsset")((mO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"scene",pO,ae(t)),t}ee(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new kR("New Scene")},n.validate=function(){return!!this.scene},t}(Mu),pO=ue((dO=mO).prototype,"scene",[qc,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fO=dO))||fO);h.SceneAsset=EO;var TO,CO,AO,bO,wO=e("TextAsset",Ic("cc.TextAsset")((SO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"text",yO,ae(t)),t}return ee(t,e),t.prototype.toString=function(){return this.text},t}(Mu),yO=ue((gO=SO).prototype,"text",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vO=gO))||vO);h.TextAsset=wO;var IO=e("JsonAsset",Ic("cc.JsonAsset")((bO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"json",AO,ae(t)),t}return ee(t,e),t}(Mu),AO=ue((CO=bO).prototype,"json",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TO=CO))||TO);h.JsonAsset=IO;var PO,RO,OO,DO,NO,MO,LO,BO,FO,zO,UO,GO,kO,HO,VO,WO,jO,XO,qO,YO,KO,QO,ZO,JO,$O,eD,tD,nD,iD,rD,oD,aD,sD,cD,lD,uD,hD,_D,fD=function(){var e=t.prototype;function t(){this.fog=new xy,this.ambient=new hy,this.skybox=new vy,this.shadows=new vg,this.octree=new Ay,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0},e.initGeometryRendererMaterials=function(){for(var e=0,t=0;t<6;t++){this._geometryRendererMaterials[t]=new ig,this._geometryRendererMaterials[t]._uuid="geometry-renderer-material-"+t,this._geometryRendererMaterials[t].initialize({effectName:"geometry-renderer",technique:t});for(var n=0;n<this._geometryRendererMaterials[t].passes.length;++n)this._geometryRendererPasses[e]=this._geometryRendererMaterials[t].passes[n],this._geometryRendererShaders[e]=this._geometryRendererMaterials[t].passes[n].getShaderVariant(),e++}},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new ig;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=e.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Br("a_position",vi.RGB32F)],c=new zr(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},J(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(kS.ATTACHMENT_SCALE_CAHNGED,e))}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}}]),t}(),dD=e("ForwardPipeline",(PO=Ic("ForwardPipeline"),RO=hl([kE]),OO=il(),PO((LO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",MO,ae(t)),t._postRenderPass=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new jT;n.initialize(jT.initInfo),this._flows.push(n);var i=new wT;i.initialize(wT.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new fD,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(M(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Kd,t),this._descriptorSet.bindTexture(Kd,wv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(rp,t),this._descriptorSet.bindTexture(rp,wv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Xd.BINDING).destroy(),this._descriptorSet.getBuffer(Yd.BINDING).destroy(),this._descriptorSet.getBuffer(qd.BINDING).destroy(),this._descriptorSet.getTexture(Kd).destroy(),this._descriptorSet.getTexture(rp).destroy())},J(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(lx),MO=ue((NO=LO).prototype,"renderTextures",[RO,Bc,OO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DO=NO))||DO)),pD=[new pr(0,0,0,0),new pr(0,0,0,0),new pr(0,0,0,0)],mD=e("GbufferStage",(BO=Ic("GbufferStage"),FO=hl([WE]),zO=il(),BO((VO=HO=function(e){function t(){var t;return le(t=e.call(this)||this,"renderQueues",kO,ae(t)),t._renderQueues=[],t._renderArea=new sr,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Iv("default"),t._batchedQueue=new ZE,t._instancedQueue=new JE,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=YE(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(KE),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Tv.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===Tv.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(QE);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&$i.COLOR&&(t.pipelineSceneData.isHDR?zv(pD[0],e.clearColor):(pD[0].x=e.clearColor.x,pD[0].y=e.clearColor.y,pD[0].z=e.clearColor.z)),pD[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,pD,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(kd.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(GS),HO.initInfo={name:"GbufferStage",priority:tx.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:GE.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:GE.BACK_TO_FRONT,stages:["default"]}]},kO=ue((GO=VO).prototype,"renderQueues",[FO,Bc,zO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),UO=GO))||UO)),vD=[new pr(0,0,0,1)],gD=e("LightingStage",(WO=Ic("LightingStage"),jO=hl(ig),XO=il(),qO=hl([WE]),YO=il(),WO((eD=$O=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=_p.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new sr,t._uiPhase=void 0,le(t,"_deferredMaterial",ZO,ae(t)),le(t,"renderQueues",JO,ae(t)),t._phaseID=Iv("default"),t._renderQueues=[],t._uiPhase=new CT,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,o=pa.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=ni.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(pa.set(o,_.position.x,_.position.y,_.position.z,_.range),ys.sphereFrustum(o,e.frustum)){if(Nn.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),Nn.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}t.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var d=0;d<r.length&&c<this._maxDeferredLights;d++,++c){var p=r[d];if(pa.set(o,p.position.x,p.position.y,p.position.z,p.range),ys.sphereFrustum(o,e.frustum)){if(Nn.toArray(a,p.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),Nn.toArray(a,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=p.luminance*s*this._lightMeterScale:a[3]=p.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=p.size,a[1]=p.range,a[2]=p.spotAngle,this._lightBufferData.set(a,c*l+2*u),Nn.toArray(a,p.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n._createStageDescriptor=function(e){var t=this._pipeline.device,n=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;n=Math.ceil(n/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,n,t.capabilities.uboOffsetAlignment));var i=t.createBuffer(new Sr(this._deferredLitsBufs,0,n));this._lightBufferData=new Float32Array(n/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new Kr(e.localSetLayout)),this._descriptorSet.bindBuffer(hp.BINDING,i);var r=t.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.DEVICE,sp.SIZE,sp.SIZE));this._descriptorSet.bindBuffer(sp.BINDING,r)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=YE(this.renderQueues[i]);this._planarQueue=new TT(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects;this._planarQueue.gatherShadowPasses(e,i),t.generateRenderArea(e,this._renderArea);for(var a=t.getPipelineRenderData(),s=r.deferredLightingMaterial.passes[0],c=s.getShaderVariant(),l=0;l<3;++l)s.descriptorSet.bindTexture(l,a.gbufferRenderTargets[l]),s.descriptorSet.bindSampler(l,a.sampler);s.descriptorSet.bindTexture(3,a.outputDepth),s.descriptorSet.bindSampler(3,a.sampler),s.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(s),this.gatherLights(e),e.clearFlag&$i.COLOR&&(vD[0].x=e.clearColor.x,vD[0].y=e.clearColor.y,vD[0].z=e.clearColor.z),vD[0].w=0;var u=a.outputFrameBuffer,h=u.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(h,u,this._renderArea,vD,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(kd.GLOBAL,t.descriptorSet);var _=t.quadIAOffscreen,f=null;null!=s&&null!=c&&null!=_&&(f=Lv.getOrCreatePipelineState(n,s,c,h,_)),null!=f&&(this._descriptorSet.update(),i.bindPipelineState(f),i.bindDescriptorSet(kd.MATERIAL,s.descriptorSet),i.bindDescriptorSet(kd.LOCAL,this._descriptorSet),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(KE);for(var d=0,p=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(d=0;d<y.length;++d){var S=y[d].passes;for(p=0;p<S.length;++p)if(S[p].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,d,p)}}if(o.length>0){this._renderQueues.forEach(QE);for(var x=0;x<this._renderQueues.length;x++)this._renderQueues[x].recordCommandBuffer(n,h,i);this._planarQueue.recordCommandBuffer(n,h,i)}this._pipeline.geometryRenderer.render(h,i),this._uiPhase.render(e,h),i.endRenderPass()},t}(GS),$O.initInfo={name:"LightingStage",priority:tx.LIGHTING,tag:0},ZO=ue((QO=eD).prototype,"_deferredMaterial",[jO,Bc,XO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JO=ue(QO.prototype,"renderQueues",[qO,Bc,YO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KO=QO))||KO)),yD=[new pr(0,0,0,1)],SD=e("PostProcessStage",(tD=Ic("PostProcessStage"),nD=hl(ig),iD=il(),rD=hl([WE]),oD=il(),tD((hD=uD=function(e){function t(){var t;return le(t=e.call(this)||this,"_postProcessMaterial",cD,ae(t)),le(t,"renderQueues",lD,ae(t)),t._renderArea=new sr,t._stageDesc=void 0,t._localUBO=void 0,t._uiPhase=new CT,t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.window.width,this._renderArea.y=o.y*e.window.height,this._renderArea.width=o.width*e.window.width,this._renderArea.height=o.height*e.window.height;var a=t.getPipelineRenderData(),s=e.window.framebuffer,c=t.getRenderPass(e.clearFlag,s);e.clearFlag&$i.COLOR&&(yD[0].x=e.clearColor.x,yD[0].y=e.clearColor.y,yD[0].z=e.clearColor.z),yD[0].w=e.clearColor.w,r.beginRenderPass(c,s,this._renderArea,yD,e.clearDepth,e.clearStencil),r.bindDescriptorSet(kd.GLOBAL,t.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();t.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update();var h=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=Lv.getOrCreatePipelineState(n,l,u,c,h));var f=t.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(this._stageDesc||(this._stageDesc=n.createDescriptorSet(new Kr(l.localSetLayout)),this._localUBO=n.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.DEVICE,sp.SIZE,sp.SIZE)),this._stageDesc.bindBuffer(sp.BINDING,this._localUBO)),this._stageDesc.update(),r.bindPipelineState(_),r.bindDescriptorSet(kd.MATERIAL,l.descriptorSet),r.bindDescriptorSet(kd.LOCAL,this._stageDesc),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(e,c),Qv(n,c,r,t.profiler,e),r.endRenderPass()},t}(GS),uD.initInfo={name:"PostProcessStage",priority:JS.POST_PROCESS,tag:0},cD=ue((sD=hD).prototype,"_postProcessMaterial",[nD,Bc,iD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lD=ue(sD.prototype,"renderQueues",[rD,Bc,oD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aD=sD))||aD));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(_D||(_D={}));var xD,ED,TD,CD,AD,bD,wD,ID,PD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=_D.NONE,t}ee(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),t.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new ig;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new ig;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new ig;r._uuid="builtin-post-process-material",ft.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=_D.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},J(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new ig;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(fD),RD=[new pr(0,0,0,1)],OD=function(){};OD.SIZE=4*(OD.COUNT=4+(OD.TEXTURE_SIZE_OFFSET=0));var DD,ND,MD,LD,BD,FD,zD,UD,GD,kD,HD=e("BloomStage",(xD=Ic("BloomStage"),ED=hl(ig),TD=il(),xD((ID=wD=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,le(t,"_bloomMaterial",bD,ae(t)),t._renderArea=new sr,t._bloomUBO=[],t}ee(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,OD.SIZE,OD.SIZE));e.clearFlag&$i.COLOR&&(RD[0].x=e.clearColor.x,RD[0].y=e.clearColor.y,RD[0].z=e.clearColor.z),RD[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(OD.COUNT);a[OD.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,RD,0,0),n.bindDescriptorSet(kd.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(kd.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=Lv.getOrCreatePipelineState(t.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,o=new Float32Array(OD.COUNT),a=0;a<this.iterations;++a){o[OD.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[OD.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,RD,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(kd.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=Lv.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,o=new Float32Array(OD.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[OD.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[OD.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,RD,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(kd.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=Lv.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(OD.COUNT);a[OD.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,RD,0,0),n.bindDescriptorSet(kd.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(kd.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=Lv.getOrCreatePipelineState(t.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(GS),wD.initInfo={name:"BloomStage",priority:JS.BLOOM,tag:0},bD=ue((AD=ID).prototype,"_bloomMaterial",[ED,Bc,TD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CD=AD))||CD)),VD=e("MainFlow",Ic("MainFlow")((MD=ND=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new mD;n.initialize(mD.initInfo),this._stages.push(n);var i=new gD;i.initialize(gD.initInfo),this._stages.push(i);var r=new HD;r.initialize(HD.initInfo),this._stages.push(r);var o=new SD;o.initialize(SD.initInfo),this._stages.push(o)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(HS),ND.initInfo={name:Dd,priority:nx.MAIN,stages:[]},DD=MD))||DD),WD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return ee(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),jD=e("DeferredPipeline",(LD=Ic("DeferredPipeline"),BD=hl([kE]),FD=il(),LD((kD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,le(t,"renderTextures",GD,ae(t)),t}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new jT;n.initialize(jT.initInfo),this._flows.push(n);var i=new VD;i.initialize(VD.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new PD,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(M(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Kd,n),this._descriptorSet.bindTexture(Kd,wv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(rp,n),this._descriptorSet.bindTexture(rp,wv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new cx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Ur;o.format=vi.RGBA16F,o.loadOp=zi.CLEAR,o.storeOp=Ui.STORE;var a=new Ur;a.format=vi.RGBA16F,a.loadOp=zi.CLEAR,a.storeOp=Ui.STORE;var s=new Ur;s.format=vi.RGBA16F,s.loadOp=zi.CLEAR,s.storeOp=Ui.STORE;var c=new Gr;c.format=vi.DEPTH_STENCIL,c.depthLoadOp=zi.CLEAR,c.depthStoreOp=Ui.STORE,c.stencilLoadOp=zi.CLEAR,c.stencilStoreOp=Ui.STORE;var l=new Vr([o,a,s],c);this._gbufferRenderPass=t.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Ur;u.format=vi.RGBA8,u.loadOp=zi.CLEAR,u.storeOp=Ui.STORE,u.barrier=t.getGeneralBarrier(new Wr(Gi.NONE,Gi.COLOR_ATTACHMENT_WRITE));var h=new Gr;h.format=vi.DEPTH_STENCIL,h.depthLoadOp=zi.LOAD,h.depthStoreOp=Ui.DISCARD,h.stencilLoadOp=zi.LOAD,h.stencilStoreOp=Ui.DISCARD,u.barrier=t.getGeneralBarrier(new Wr(Gi.DEPTH_STENCIL_ATTACHMENT_WRITE,Gi.DEPTH_STENCIL_ATTACHMENT_WRITE));var _=new Vr([u],h);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Xd.BINDING).destroy(),this._descriptorSet.getBuffer(Yd.BINDING).destroy(),this._descriptorSet.getBuffer(qd.BINDING).destroy(),this._descriptorSet.getTexture(Kd).destroy(),this._descriptorSet.getTexture(rp).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new WD,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(t.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED,vi.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new Cr(Ci.TEX2D,Ai.DEPTH_STENCIL_ATTACHMENT|Ai.SAMPLED,vi.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new Xr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED,vi.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new Xr(this._lightingRenderPass,n.outputRenderTargets,null)),n.sampler=this.globalDSManager.pointSampler,this.on(kS.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)}))},t}(lx),GD=ue((UD=kD).prototype,"renderTextures",[BD,Bc,FD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zD=UD))||zD));function XD(){var e=new dD;return e.initialize({flows:[]}),e}var qD=new Jn,YD=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new pr(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new pr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{h.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?h.view.setDesignResolutionSize(n.width,n.height,n.policy):h.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,h.game.once(h.Game.EVENT_GAME_INITED,(function(){h.director._lateUpdate=performance.now()}),h.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else T("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),h.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new pr(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new sr(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=t.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Br("a_position",vi.RG32F),new Br("a_texCoord",vi.RG32F)],u=new zr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new Yn,Yn.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),h.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,o=e.swapchain;Yn.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=p_(fn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,_=e.logoTexture.height,f=c*i.displayRatio,d=f*h/_,p=f;if(o.surfaceTransform!==pi.ROTATE_90&&o.surfaceTransform!==pi.ROTATE_270||(d=f*a/s,p=f*_/h*s/a),e.logoMat.setProperty("resolution",qD.set(a,s),0),e.logoMat.setProperty("scale",qD.set(d,p),0),e.logoMat.setProperty("translate",qD.set(.5*a,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;o.surfaceTransform!==pi.ROTATE_90&&o.surfaceTransform!==pi.ROTATE_270||(g=.5*m,y=m*a/s*.5),e.watermarkMat.setProperty("resolution",qD.set(a,s),0),e.watermarkMat.setProperty("scale",qD.set(g,y),0),e.watermarkMat.setProperty("translate",qD.set(.5*a,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new ig,this.logoMat.initialize({effectName:"splash-screen"});var t=new br;t.addressU=Oi.CLAMP,t.addressV=Oi.CLAMP,t.addressW=Oi.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new Cr(Ci.TEX2D,Ai.SAMPLED|Ai.TRANSFER_DST,vi.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new fr;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new fr;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Cr(Ci.TEX2D,Ai.SAMPLED|Ai.TRANSFER_DST,vi.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new ig,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=Lv.getOrCreatePipelineState(e,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(kd.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=Lv.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(kd.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},J(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();YD._ins=void 0,h.internal.SplashScreen=YD;var KD=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},J(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());KD.Priority=ct({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var QD=new ge("Scheduler"),ZD=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};ZD.get=function(e,t,n,i){var r=ZD._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new ZD(e,t,n,i),r},ZD.put=function(e){ZD._listEntries.length<20&&(e.target=null,ZD._listEntries.push(e))},ZD._listEntries=[];var JD=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};JD.get=function(e,t,n,i){var r=JD._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new JD(e,t,n,i),r},JD.put=function(e){JD._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,JD._hashUpdateEntries.push(e))},JD._hashUpdateEntries=[];var $D=function(e,t,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};$D.get=function(e,t,n,i,r,o){var a=$D._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new $D(e,t,n,i,r,o),a},$D.put=function(e){$D._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,$D._hashTimerEntries.push(e))},$D._hashTimerEntries=[];var eN=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,i,r,o){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===h.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();eN._timers=[],eN.get=function(){return eN._timers.pop()||new eN},eN.put=function(e){eN._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,eN._timers.push(e))};var tN,nN=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=Re(!0),t._hashForTimers=Re(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}ee(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?D(1513):e.id=QD.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(o=a[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,i,r,o){if("function"!=typeof e){var a=e;e=t,t=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!i,i=h.macro.REPEAT_FOREVER,r=0),F(t,1502);var s=t.uuid||t.id;if(s){var c,l,u=this._hashForTimers[s];if(u?u.paused!==o&&D(1511):(u=$D.get(null,t,0,null,null,o),this._arrayForTimers.push(u),this._hashForTimers[s]=u),null==u.timers)u.timers=[];else for(l=0;l<u.timers.length;++l)if((c=u.timers[l])&&e===c._callback)return R(1507,c.getInterval(),n),void(c._interval=n);(c=eN.get()).initWithCallback(this,e,t,n,i,r),u.timers.push(c),this._currentTarget===u&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else M(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return R(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var o,a=ZD.get(e,t,n,!1);0===t?(o=this._updates0List,this._appendIn(o,a)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,t)),this._hashForUpdates[i]=JD.get(o,a,e,null)}else M(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),eN.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else M(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else M(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)eN.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else M(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(KD.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){F(e,1508),F(t,1509);var n=t.uuid||t.id;if(!n)return M(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(e===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(KD.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,o.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){F(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else M(1510)},n.resumeTarget=function(e){F(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else M(1510)},n.isTargetPaused=function(e){F(e,1505);var t=e.uuid||e.id;if(!t)return M(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}$D.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[t],ZD.put(r),JD.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(KD));nN.ID="scheduler",h.Scheduler=nN;var iN=((tN={})[ih.PORTRAIT]=pi.IDENTITY,tN[ih.LANDSCAPE_RIGHT]=pi.ROTATE_90,tN[ih.PORTRAIT_UPSIDE_DOWN]=pi.ROTATE_180,tN[ih.LANDSCAPE_LEFT]=pi.ROTATE_270,tN),rN=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new Cr(Ci.TEX2D,Ai.COLOR_ATTACHMENT|Ai.SAMPLED|Ai.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==vi.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new Cr(Ci.TEX2D,Ai.DEPTH_STENCIL_ATTACHMENT|Ai.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new Xr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,iN[ch.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Xr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=ce(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},J(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),oN=e("Root",function(){function e(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=h.internal.DataPoolManager&&new h.internal.DataPoolManager(e),Hy.registerCreateFunc(this),rN.registerCreateFunc(this),this._cameraPool=new Kl((function(){return new _g(t._device)}),4,(function(e){return e.destroy()}))}var t=e.prototype;return t.initialize=function(){this._init();var e=h.game._swapchain,t=new Ur;t.format=e.colorTexture.format;var n=new Gr;n.format=e.depthStencilTexture.format,n.depthStoreOp=Ui.DISCARD,n.stencilStoreOp=Ui.DISCARD;var i=new Vr([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:i,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(wv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(e,t){for(var n,i=ce(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},t.setRenderPipeline=function(e){e instanceof jD&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=XD(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(mi.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=h.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&h.internal.Batcher2D&&(this._batcher=new h.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(e){this._curWindow=e},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([h.game._swapchain]);var o=this._scenes,a=h.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);h.director.emit(h.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},t.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},t.destroyWindows=function(){for(var e,t=ce(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},t.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},t.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},t.destroyScenes=function(){for(var e,t=ce(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},t.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new Kl((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):D(1300,e.constructor.name),e.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new Kl((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case Cy.SPHERE:e.scene.removeSphereLight(e);break;case Cy.SPOT:e.scene.removeSpotLight(e)}e.destroy()},t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(e){this._cumulativeTime+=e},t._setFrameTime=function(e){this._frameTime=e},J(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}());h.Root=oN;var aN=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t._onEngineInitedCallback=[],t}ee(t,e);var n=t.prototype;return n.setFrameRate=function(e){this.frameRate=e},n.getFrameRate=function(){return this.frameRate},n.step=function(){h.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(RR._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return h.director.once(h.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return h.director.getScene().destroy(),h.Object._deferredDestroy(),h.director.reset(),h.profiler.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){vu.close()},n.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},n.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},n.init=function(e){var t=this;if(this._initConfig(e),uh._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&h.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,i=0;i<n.length;i++){var o=n[i],a=r(o.value);Pd.addLayer(o.name,a)}return this._initEngine().then((function(){return t._initEvents(),h.director.root&&h.director.root.dataPoolManager&&h.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,er.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(e){if(h.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=h.director._scene;if(h.isValid(n))if(e.parent){if(!(e.parent instanceof h.Scene))return void D(3801);if(e.parent!==n)return void D(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,h.assetManager._releaseManager._addPersistNodeRef(e)}}else D(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",h.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n.onEngineInitedAsync=function(e){this._onEngineInitedCallback.push(e)},n._initEngine=function(){var e=this;this._initDevice();var n=h.director;return Promise.resolve(n._init()).then((function(){h.view.init(),x("Cocos Creator v"+_),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,h.internal.dynamicAtlasManager&&(h.internal.dynamicAtlasManager.enabled=!ft.CLEANUP_IMAGE_CACHE)})).then((function(){var t=e._onEngineInitedCallback.map((function(e){return e()})).filter(Boolean);return e._onEngineInitedCallback.length=0,Promise.all(t)}))},n._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},n._ctTime=function(e){window.clearTimeout(e)},n._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},n._updateCallback=function(){var e,t=this,n=h.director;if(30===this._frameRate){var i=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(i=!i)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},n._runMainLoop=function(){if(this._inited){var e=this.config,t=h.director;G(!!e.showFPS),t.startAnimation(),this.resume()}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=L.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,b(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},n._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(z(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new gr(jd),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||hh.browserType===au.UC)&&(i=!1);var o=[];i&&h.WebGL2Device&&o.push(h.WebGL2Device),h.WebGLDevice&&o.push(h.WebGLDevice),h.EmptyDevice&&o.push(h.EmptyDevice),xo.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(n));a++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&h.EmptyDevice&&(this._gfxDevice=new h.EmptyDevice,this._gfxDevice.initialize(new gr(jd)));if(!this._gfxDevice)return T("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var s=new vr(this.canvas),c=uh.windowSize;s.width=c.width,s.height=c.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){vu.on("show",this._onShow,this),vu.on("hide",this._onHide,this)},n._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){h.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof lx?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){E(n),E("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(h.internal.SplashScreen){var e=h.internal.SplashScreen.instance;return e.main(h.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){h.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},J(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(_u));aN.EVENT_HIDE="game_on_hide",aN.EVENT_SHOW="game_on_show",aN.EVENT_LOW_MEMORY="game_on_low_memory",aN.EVENT_GAME_INITED="game_inited",aN.EVENT_ENGINE_INITED="engine_inited",aN.EVENT_RENDERER_INITED="renderer_inited",aN.EVENT_RESTART="game_on_restart",aN.RENDER_TYPE_CANVAS=0,aN.RENDER_TYPE_WEBGL=1,aN.RENDER_TYPE_OPENGL=2,aN.RENDER_TYPE_HEADLESS=3,aN.DEBUG_DT_THRESHOLD=1,h.Game=aN;var sN=e("game",h.game=new aN),cN=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new nN,t._compScheduler=new iO,t._nodeActivator=new xO,t._systems=[],sN.once(aN.EVENT_RENDERER_INITED,t._initOnRendererInitialized,ae(t)),t}ee(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),h.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),h.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof EO&&(e=e.scene),F(e instanceof kR,1216),e._load();for(var i=Object.keys(sN._persistRootNodes).map((function(e){return sN._persistRootNodes[e]})),r=0;r<i.length;r++){var o=i[r];o.emit(h.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var a=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),e.insertChild(o,s)}else o.parent=e}var c=this._scene;h.isValid(c)&&c.destroy(),h.assetManager._releaseManager._autoRelease(c,e,sN._persistRootNodes),this._scene=null,yl._deferredDestroy(),t&&t(),this.emit(h.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(h.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var i=this;e instanceof EO&&(e=e.scene),F(e,1205),F(e instanceof kR,1216),e._load(),this.once(h.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var i=this;if(this._loadingScene)return D(1208,e,this._loadingScene),!1;var r=h.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return r?(this.emit(h.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),r.loadScene(e,(function(r,o){console.timeEnd("LoadScene "+e),i._loadingScene="",r?(T(r),t&&t(r)):i.runSceneImmediate(o,n,t)})),!0):(M(1209,e),!1)},n.preloadScene=function(e,t,n){var i=h.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var r='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(r)),T("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return sN.deltaTime},n.getTotalTime=function(){return sN.totalTime},n.getCurrentTime=function(){return sN.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(nN.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(KD.sortByPriority)},n.unregisterSystem=function(e){rt.fastRemove(this._systems,e),this._systems.sort(KD.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(h.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=sN._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),RR._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),yl._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),ub.resetHasChangedFlags(),ub.clearNodeArray(),ql.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(nN.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new oN(sN._gfxDevice),this._root.initialize({}).catch((function(e){return M(1217),Promise.reject(e)}))},J(t,[{key:"root",get:function(){return this._root}}]),t}(_u));cN.EVENT_INIT="director_init",cN.EVENT_RESET="director_reset",cN.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",cN.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",cN.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",cN.EVENT_BEFORE_UPDATE="director_before_update",cN.EVENT_AFTER_UPDATE="director_after_update",cN.EVENT_BEFORE_DRAW="director_before_draw",cN.EVENT_AFTER_DRAW="director_after_draw",cN.EVENT_BEFORE_COMMIT="director_before_commit",cN.EVENT_BEFORE_PHYSICS="director_before_physics",cN.EVENT_AFTER_PHYSICS="director_after_physics",cN.EVENT_BEGIN_FRAME="director_begin_frame",cN.EVENT_END_FRAME="director_end_frame",cN.instance=void 0,h.Director=cN;var lN=e("director",cN.instance=h.director=new cN),uN={};k(uN,"vmath",[{name:"vec2",newName:"Vec2",target:hi,targetName:"math"},{name:"vec3",newName:"Vec3",target:hi,targetName:"math"},{name:"vec4",newName:"Vec4",target:hi,targetName:"math"},{name:"quat",newName:"Quat",target:hi,targetName:"math"},{name:"mat3",newName:"Mat3",target:hi,targetName:"math"},{name:"mat4",newName:"Mat4",target:hi,targetName:"math"},{name:"color4",newName:"Color",target:hi,targetName:"math"},{name:"rect",newName:"Rect",target:hi,targetName:"math"},{name:"approx",newName:"approx",target:hi,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:hi,targetName:"math"},{name:"equals",newName:"equals",target:hi,targetName:"math"},{name:"clamp",newName:"clamp",target:hi,targetName:"math"},{name:"clamp01",newName:"clamp01",target:hi,targetName:"math"},{name:"lerp",newName:"lerp",target:hi,targetName:"math"},{name:"toRadian",newName:"toRadian",target:hi,targetName:"math"},{name:"toDegree",newName:"toDegree",target:hi,targetName:"math"},{name:"random",newName:"random",target:hi,targetName:"math"},{name:"randomRange",newName:"randomRange",target:hi,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:hi,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:hi,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:hi,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:hi,targetName:"math"},{name:"repeat",newName:"repeat",target:hi,targetName:"math"},{name:"pingPong",newName:"pingPong",target:hi,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:hi,targetName:"math"}]),h.vmath=uN,k(nN.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:nN,targetName:"Scheduler"}]),k(nN,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return KD.Priority.SCHEDULER}}]),H(nN,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),k(ry.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),H(ry.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),k(oN.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),V(sN,"game",[{name:"collisionMatrix"},{name:"groupList"}]),V(cN.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),H(cN.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var hN,_N={topLeft:h.v2(0,0),topRight:h.v2(0,0),top:h.v2(0,0),bottomLeft:h.v2(0,0),bottomRight:h.v2(0,0),bottom:h.v2(0,0),center:h.v2(0,0),left:h.v2(0,0),right:h.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,o=r+n,a=i+t;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+t/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};h.visibleRect=_N;var fN=new oi,dN=((hN={})[ft.ORIENTATION_AUTO]=ih.AUTO,hN[ft.ORIENTATION_LANDSCAPE]=ih.LANDSCAPE,hN[ft.ORIENTATION_PORTRAIT]=ih.PORTRAIT,hN),pN=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=mN,i=vN;return t._designResolutionSize=new oi(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new si(0,0,0,0),t._visibleRect=new si(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new gN(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new gN(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new gN(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new gN(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new gN(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}ee(t,e);var n=t.prototype;return n.init=function(){var e=uh.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,fN.width=this._visibleRect.width,fN.height=this._visibleRect.height,_N&&_N.init(this._visibleRect),ch.on("window-resize",this._updateAdaptResult,this),ch.on("orientation-change",this._updateAdaptResult,this),ch.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){ch.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){ch.orientation=dN[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&uh.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){ch.resolutionScale=1;var n=ch.devicePixelRatio,i=new oi(e*n,t*n);uh.windowSize=i},n.getCanvasSize=function(){return uh.windowSize},n.getFrameSize=function(){var e=ch.devicePixelRatio,t=uh.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=ch.devicePixelRatio;uh.windowSize=new oi(e*n,t*n)},n.getVisibleSize=function(){return new oi(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new oi(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Jn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Jn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof gN)this._resolutionPolicy=e;else{var t=gN;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=yN.getDesignResolutionSize();yN.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),fN.width=this._visibleRect.width,fN.height=this._visibleRect.height,_N&&_N.init(this._visibleRect),this.emit("design-resolution-changed")}else M(2200)},n.getDesignResolutionSize=function(){return new oi(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return ch.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new Jn);var r=ch.devicePixelRatio*(e-n.left),o=ch.devicePixelRatio*(n.top+n.height-t);return ch.isFrameRotated?(i.x=uh.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;h.director.root.resize(uh.windowSize.width,uh.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(_u));pN.instance=void 0;var mN=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=sN.canvas;if(e){var t=uh.windowSize;e.width=t.width,e.height=t.height}},e}();mN.EQUAL_TO_FRAME=void 0,mN.PROPORTION_TO_FRAME=void 0;var vN=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,o){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new si(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},e}();vN.EXACT_FIT=void 0,vN.SHOW_ALL=void 0,vN.NO_BORDER=void 0,vN.FIXED_HEIGHT=void 0,vN.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return ee(t,e),t.prototype.apply=function(){ch.isProportionalToFrame=!1,this._setupCanvas()},t}(mN),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return ee(t,e),t.prototype.apply=function(){ch.isProportionalToFrame=!0,this._setupCanvas()},t}(mN);mN.EQUAL_TO_FRAME=new e,mN.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return ee(t,e),t.prototype.apply=function(e,t){var n=uh.windowSize,i=n.width,r=n.height,o=i/t.width,a=r/t.height;return this._buildResult(i,r,i,r,o,a)},t}(vN),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return ee(t,e),t.prototype.apply=function(e,t){var n,i,r=uh.windowSize,o=r.width,a=r.height,s=t.width,c=t.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},t}(vN),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return ee(t,e),t.prototype.apply=function(e,t){var n,i,r,o=uh.windowSize,a=o.width,s=o.height,c=t.width,l=t.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},t}(vN),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return ee(t,e),t.prototype.apply=function(e,t){var n=uh.windowSize,i=n.width,r=n.height,o=r/t.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(vN),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return ee(t,e),t.prototype.apply=function(e,t){var n=uh.windowSize,i=n.width,r=n.height,o=i/t.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(vN);vN.EXACT_FIT=new n,vN.SHOW_ALL=new i,vN.NO_BORDER=new r,vN.FIXED_HEIGHT=new o,vN.FIXED_WIDTH=new a}();var gN=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof mN&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof vN&&(this._contentStrategy=e)},J(e,[{key:"canvasSize",get:function(){return uh.windowSize}}]),e}());gN.EXACT_FIT=0,gN.NO_BORDER=1,gN.SHOW_ALL=2,gN.FIXED_HEIGHT=3,gN.FIXED_WIDTH=4,gN.UNKNOWN=5,gN.ContainerStrategy=mN,gN.ContentStrategy=vN,h.ResolutionPolicy=gN;var yN=e("view",pN.instance=h.view=new pN);h.winSize=fN,H(pN.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),V(pN.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),V(h,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),V(hh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),k(hh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:hh.Language,targetName:"sys.Language"}}))),k(hh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:hh.OS,targetName:"sys.OS"}}))),k(hh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:hh.BrowserType,targetName:"sys.BrowserType"}}))),k(hh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:hh.BrowserType,targetName:"sys.BrowserType"}]),k(hh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:hh.Platform,targetName:"sys.Platform"}}))),k(hh,"sys",[{name:"IPHONE",newName:"IOS",target:hh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:hh.Platform,targetName:"sys.Platform"}]),H(hh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),k(hh,"sys",[{name:"windowPixelResolution",target:uh,targetName:"screen",newName:"windowSize"}]),V(uh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var SN=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new El,this.scenes=new El,this.paths=new El}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=Ul(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var d=t[_];t[_]=h[d]=Ul(d)}t=h}for(var p in n){var m=n[p];o[t[p]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var S=e.packs;for(var x in S)for(var E=S[x],T=0;T<E.length;++T)E[T]=t[E[T]];var C=e.versions;if(C)for(var A in C)for(var b=C[A],w=0;w<b.length;w+=2){var I=b[w];b[w]=t[I]||I}var P=e.redirect;if(P)for(var R=0;R<P.length;R+=2)P[R]=t[P[R]],P[R+1]=r[P[R+1]];if(e.extensionMap){var O=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var D in e.extensionMap)O(D)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=Wl(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(ot.isChildClassOf(o.ctor,t))return o}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=Wl(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var o=0,a=n.length;o<a;o++){var s=n[o];t&&!ot.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=ot._getClassById(o),t.has(r)?a?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],o=n.get(r);o.url=i,t.add(i,o)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=t.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];t.get(o).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function xN(e,t){e._uuid&&t.push(e._uuid)}function EN(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=e[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Mu&&xN(s,t)}else if(o.constructor&&o.constructor!==Object)o instanceof Mu&&xN(o,t);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Mu&&xN(u,t)}}}}function TN(e,t){for(var n=0;n<e._components.length;n++)EN(e._components[n],t);for(var i=0;i<e._children.length;i++)TN(e._children[i],t)}function CN(e,t,n,i){n.push(e._uuid);for(var r=tv.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s=Al.get(r[o]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||CN(s,t,n,i)}}}var AN=[],bN=new(function(){function e(){this._persistNodeDeps=new El,this._toDelete=new El,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];TN(e,t);for(var n=0,i=t.length;n<i;n++){var r=Al.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=Al.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=tv.getDeps(e.uuid),r=0,o=i.length;r<o;r++){var a=Al.get(i[r]);a&&a.decRef(e.autoReleaseAssets)}var s=tv._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=Al.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&tv.remove(e.uuid)}var _=tv._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var d,p,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=ce(v);!(p=g()).done;){var y=p.value,S=Al.get(y);S&&S.addRef()}_&&(d=_.persistDeps).push.apply(d,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof Mu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,Tt(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),xl(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,CN(e,t,AN,-1),AN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&CN(Al.get(n),t,AN,1);return AN.length=0,t[e._uuid]}(e)>0)){Al.remove(n);for(var i=tv.getDeps(n),r=0,o=i.length;r<o;r++){var a=Al.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),tv.remove(n)}},e}()),wN=null;function IN(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof Mu&&r.content.decRef(!1),r.recycle()}e.input=null}function PN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function RN(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(o,a){r++,!o||r>t?i&&i(o,a):setTimeout((function(){RN(e,t,n,i,r)}),n)}))}function ON(e,t,n,i,r){try{for(var o=tv.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push($({},o.nativeDep)))}catch(e){T(e.message,e.stack)}}function DN(e,t,n){t&&(n=void 0!==n?n:h.assetManager.cacheAsset,Vl(t)||!n||t.isDefault||Al.add(e,t))}function NN(e,t,n){var i=0,r=[],o=e.length;0===o&&n&&n(r);for(var a=function(e){e&&r.push(e),++i===o&&n&&n(r)},s=0;s<o;s++)t(e[s],a)}function MN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a="function"==typeof e;t?(o=t,a||(r=null)):void 0===t&&a&&(o=e,i=null,r=null),void 0!==t&&a&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function LN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a=ot.isChildClassOf(e,Mu);t?(o=t,a&&(r=null)):void 0!==t||a||(o=e,r=null,i=null),void 0===t||a||(r=e,i=null)}return{type:i,onProgress:r||wN,onComplete:o}}function BN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,o=tv.getDeps(t);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===e||BN(e,c,n,i)){r=!0;break}}return r}function FN(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof Mu&&i.push(e.addRef())})):n instanceof Mu&&i.push(n.addRef()),Tt((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var zN=function(){function e(){this._config=new SN}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),Il.add(e.name,this)},t.load=function(e,t,n,i){var r=LN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c={__requestType__:Cl.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(e)};h.assetManager.loadAny(e,c,a,s)},t.preload=function(e,t,n,i){var r=LN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;h.assetManager.preloadAny(e,{__requestType__:Cl.PATH,type:o,bundle:this.name},a,s)},t.loadDir=function(e,t,n,i){var r=LN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;h.assetManager.loadAny(e,{__requestType__:Cl.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},t.preloadDir=function(e,t,n,i){var r=LN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;h.assetManager.preloadAny(e,{__requestType__:Cl.DIR,type:o,bundle:this.name},a,s)},t.loadScene=function(e,t,n,i){var r=MN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,h.assetManager.loadAny({scene:e},o,a,(function(e,t){if(e)T(e.message,e.stack);else if(t instanceof EO&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");s&&s(e,t)}))},t.preloadScene=function(e,t,n,i){var r=MN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,h.assetManager.preloadAny({scene:e},o,a,(function(t){t&&M(1210,e,t.message),s&&s(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&Al.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&bN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;Al.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&bN.tryRelease(t)}))},t.releaseAll=function(){var e=this;Al.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&bN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},J(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),UN=e("resources",new zN);function GN(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(z(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=e,i}function kN(e,t,n,i){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}h.resources=UN;var HN={};function VN(e,t,n){if(HN[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),HN[e]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(z(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var WN=/^(?:\w+:\/\/|\.+\/).+/,jN=function(e,t,n){(hh.hasFeature(hh.Feature.IMAGE_BITMAP)&&h.assetManager.allowImageBitmap?XN:GN)(e,t,n)},XN=function(e,t,n){t.xhrResponseType="blob",kN(e,t,t.onFileProgress,n)},qN=function(e,t,n){t.xhrResponseType="json",kN(e,t,t.onFileProgress,n)},YN=function(e,t,n){t.xhrResponseType="arraybuffer",kN(e,t,t.onFileProgress,n)},KN=function(e,t,n){qN(e,t,(function(t,i){if(t)n(t);else{var r=ph(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){YN(""+Tu(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new dh(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},QN=function(e,t,n){YN(e,t,(function(e,t){if(e)n(e);else try{var i=mh(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},ZN=function(e,t,n){t.xhrResponseType="text",kN(e,t,t.onFileProgress,n)},JN=function(e,t,n){var i=Cu(e),r=e;WN.test(r)||(r=-1!==$N.remoteBundles.indexOf(i)?$N.remoteServerAddress+"remote/"+i:"assets/"+i);var o=t.version||$N.bundleVers[i],a=0,s=null,c=null;qN(r+"/config."+(o?o+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++a&&n(c,s)})),VN(r+"/index."+(o?o+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},$N=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=GN,this.downloadDomAudio=null,this.downloadFile=kN,this.downloadScript=VN,this._downloaders={".png":jN,".jpg":jN,".bmp":jN,".jpeg":jN,".gif":jN,".ico":jN,".tiff":jN,".webp":jN,".image":jN,".pvr":YN,".pkm":YN,".astc":YN,".txt":ZN,".xml":ZN,".vsh":ZN,".fsh":ZN,".atlas":ZN,".tmx":ZN,".tsx":ZN,".json":qN,".ExportJson":qN,".plist":ZN,".ccon":KN,".cconb":QN,".fnt":ZN,".binary":YN,".bin":YN,".dbbin":YN,".skel":YN,".js":VN,bundle:JN,default:ZN},this._downloading=new El,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?ke(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var o=this,a=bl.get(e);if(a)r(null,a);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;RN((function(n,a){if(0===n&&o._downloading.add(e,[r]),o.limited){o._updateTime();var s=function(e,t){o._totalNum--,o._handleQueueInNextFrame(h,_),a(e,t)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(PN(t,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(PN(t,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||bl.add(e,n);for(var i=o._downloading.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){h.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=h.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(PN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(Tt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},J(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function eM(e,t,n,i){var r=null,o=null;try{(r=new Km)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}i(o,r)}function tM(e,t,n,i){var r=new IO;r.json=t,i(null,r)}function nM(e,t,n,i){var r=new wO;r.text=t,i(null,r)}function iM(e,t,n,i){var r=new $b;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function rM(e,t,n,i){var r=new Mu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function oM(e,n,i,r){var o=Il.get(n.name);o||(o=n.name===Dl.RESOURCES?UN:new zN,n.base=n.base||e+"/",o.init(n)),t.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var aM=new(function(){function e(){this._creating=new El,this._producers={".png":eM,".jpg":eM,".bmp":eM,".jpeg":eM,".gif":eM,".ico":eM,".tiff":eM,".webp":eM,".image":eM,".pvr":eM,".pkm":eM,".txt":nM,".xml":nM,".vsh":nM,".fsh":nM,".atlas":nM,".tmx":nM,".tsx":nM,".fnt":nM,".json":tM,".ExportJson":tM,".binary":iM,".bin":iM,".dbbin":iM,".skel":iM,bundle:oM,default:rM}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?ot.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=Al.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),a(e,t,i,(function(t,n){!t&&n instanceof Mu&&(n._uuid=e,DN(e,n,i.cacheAsset));for(var r=o._creating.remove(e),a=0,s=r.length;a<s;a++)r[a](t,n)})))}else r(null,s)},e}()),sM=new(function(){function e(){this._loading=new El,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=ot.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(z(5304,e[0]));Bh(e,!0,void 0,zh.reportMissingClass),Fh(e);for(var t=new Uh(e[0]),n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,r,o);return a}(t)).length!==e.length&&M(4915);for(var a=0;a<e.length;a++)r[e[a]+"@import"]=t[a]}else{var s=ot._getClassId(gv),c=ot._getClassId(Km);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&M(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=Gh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&M(4915);for(var _=0;_<e.length;_++)r[e[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?ot.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(bl.has(e.id))n(null,bl.get(e.id));else{var r=e.info.packs,o=r.find((function(e){return i._loading.has(e.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:e.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:e.id}]);var a=jl(o.uuid,{ext:o.ext,bundle:e.config.name});$N.download(o.uuid,a,o.ext,e.options,(function(t,n){bl.remove(o.uuid),t&&T(t.message,t.stack),i.unpack(o.packedUuids,n,o.ext,e.options,(function(e,n){if(!e)for(var r in n)bl.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else $N.download(e.id,e.url,e.ext,e.options,n)},e}());function cM(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress,o=[],a=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],NN(e.input,(function(i,c){if(!i.isNative&&Al.has(i.uuid)){var l=Al.get(i.uuid);return i.content=l.addRef(),e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i),void c()}sM.load(i,e.options,(function(l,u){l?e.isFinish||(!h.assetManager.force||n?(T(l.message,l.stack),r.canInvoke=!1,t(l)):(e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i))):e.isFinish||(i.file=u,e.output.push(i),i.isNative||(s[i.uuid]=!0,ON(i.uuid,u,s,o,i.config),r.total=a+o.length),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i)),c()}))}),(function(){if(e.isFinish)return IN(e,!0),void e.dispatch("error");if(o.length>0){var a=Ml.create({input:o,progress:r,options:i,onProgress:e.onProgress,onError:Ml.prototype.recycle,onComplete:function(i){var r;i||((r=e.output).push.apply(r,a.output),a.recycle()),n&&lM(e),t(i)}});Rl.async(a)}else n&&lM(e),t()}))}function lM(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var uM=new(function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return D(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function hM(e,t){return e[t]<<8|e[t+1]}var _M=new(function(){function e(){this._parsing=new El,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=hM(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=hM(a,12),l=hM(a,14);hM(a,8),hM(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?bm.RGBA_ASTC_4x4:5===e?4===t?bm.RGBA_ASTC_5x4:bm.RGBA_ASTC_5x5:6===e?5===t?bm.RGBA_ASTC_6x5:bm.RGBA_ASTC_6x6:8===e?5===t?bm.RGBA_ASTC_8x5:6===t?bm.RGBA_ASTC_8x6:bm.RGBA_ASTC_8x8:10===e?5===t?bm.RGBA_ASTC_10x5:6===t?bm.RGBA_ASTC_10x6:8===t?bm.RGBA_ASTC_10x8:bm.RGBA_ASTC_10x10:10===t?bm.RGBA_ASTC_12x10:bm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=uM.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=$m(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?ke(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var o=this,a=wl.get(e);if(a)r(null,a);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?bl.remove(e):Vl(n)||wl.add(e,n);for(var i=o._parsing.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))):r(null,t)}}},e}());function fM(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],NN(e.input,(function(o,a){var s=Ml.create({input:o,onProgress:e.onProgress,options:i,progress:r,onComplete:function(i,c){i&&!e.isFinish&&(!h.assetManager.force||n?(T(i.message,i.stack),r.canInvoke=!1,t(i)):r.canInvoke&&e.dispatch("progress",++r.finish,r.total,o)),e.output.push(c),s.recycle(),a(null)}});dM.async(s)}),(function(){if(i.__exclude__=null,e.isFinish)return IN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),IN(e,!0),t()}))}var dM=new Tl("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&Al.has(o)?t():sM.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)_M.parse(o,a,n.ext,s,(function(r,a){r?t(r):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),bl.remove(o),wl.remove(o),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||BN(c,c,r)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&Al.has(c)){var d=Al.get(c);n.content=d.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,_M.parse(o,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),ON(a,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var _=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=Ml.create({input:h,options:e.options,onProgress:e.onProgress,onError:Ml.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=ce(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Mu?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=Qm.get(t);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(T("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Mu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}Qm.delete(t)}Zm.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Zm.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||Jm.has(t)||Zm.has(t)||(t.onLoaded(),Jm.add(t))}catch(e){T("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}bl.remove(s),wl.remove(s),DN(a,t,u),f.recycle()}for(var l=_.callbacks,h=0,d=l.length;h<d;h++){var p=l[h];t.addRef&&t.addRef(),p.item.content=t,p.done(e)}l.length=0}});Pl.async(f)}(e,i,t)}))}}]);function pM(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case Cl.PATH:case Cl.UUID:case Cl.DIR:case Cl.SCENE:case Cl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}e.options=r;var a=Ml.create({input:e.input,options:i}),s=null;try{e.output=e.source=Ol.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var mM=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},J(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();mM.MAX_DEAD_NUM=500,mM._deadPool=[];var vM=[];function gM(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,o=n[i],a=mM.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||Cl.UUID]=n[i]),"object"==typeof o)for(var l in Ge(o,t),o.preset&&Ge(o,Nl[o.preset]),o){switch(l){case Cl.UUID:if("break"===function(){var e,t=a.uuid=Ul(o.uuid);if(!o.bundle){var n=Il.find((function(e){return!!e.getAssetInfo(t)}));o.bundle=n&&n.name}if(Il.has(o.bundle)){if(s=Il.get(o.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!Il.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=Il.get(c.redirect).config,c=s.getAssetInfo(t)}a.config=s,a.info=c}return a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Cl.DIR:if(Il.has(o.bundle)){Il.get(o.bundle).config.getDirWithPath(o.dir,o.type,vM);for(var u,h=ce(vM);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}vM.length=0}a.recycle(),a=null;break;case Cl.PATH:if(Il.has(o.bundle)){if(s=Il.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!Il.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Il.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case Cl.SCENE:if(!o.bundle){var f=Il.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(Il.has(o.bundle)){if(s=Il.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!Il.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Il.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case Cl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||Eu(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function yM(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var r,o,a=i.config;o=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:h.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:h.assetManager.generalImportBase;var s=i.uuid,c="";i.info&&(c=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?o+"/"+s.slice(0,2)+"/"+s+c+"/"+i.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+c+i.ext,i.url=r}}return null}var SM=e("AssetManager",function(){function e(){this.pipeline=Pl.append(pM).append(fM),this.fetchPipeline=Rl.append(pM).append(cM),this.transformPipeline=Ol.append(gM).append(yM),this.bundles=Il,this.assets=Al,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=tv,this.force=!1,this.allowImageBitmap=!hh.isMobile,this.utils=Xl,this.downloader=$N,this.parser=_M,this.packManager=sM,this.cacheAsset=!0,this.cacheManager=null,this.presets=Nl,this.factory=aM,this.preprocessPipe=pM,this.fetchPipe=cM,this.loadPipe=fM,this.references=null,this._releaseManager=bN,this._files=bl,this._parsed=wl,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return Il.get(e)||null},t.removeBundle=function(e){e._destroy(),Il.remove(e.name)},t.loadAny=function(e,t,n,i){var r=MN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",e=Array.isArray(e)?e.slice():e;var c=Ml.create({input:e,onProgress:a,onComplete:FN(s),options:o});Pl.async(c)},t.preloadAny=function(e,t,n,i){var r=MN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=Ml.create({input:e,onProgress:a,onComplete:FN(s),options:o});Rl.async(c)},t.loadRemote=function(e,t,n){var i=MN(t,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(T(t.message,t.stack),o&&o(t,n)):aM.create(e,n,r.ext||Eu(e),r,(function(e,t){o&&o(e,t)}))}))):FN(o)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=MN(t,void 0,n),r=i.options,o=i.onComplete,a=Cu(e);this.bundles.has(a)?FN(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(T(t.message,t.stack),o&&o(t,n)):aM.create(e,n,"bundle",r,(function(e,t){o&&o(e,t)}))})))},t.releaseAsset=function(e){bN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){Al.forEach((function(e){bN.tryRelease(e)}))},t.releaseAll=function(){Al.forEach((function(e){bN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},J(e,[{key:"main",get:function(){return Il.get(Dl.MAIN)||null}},{key:"resources",get:function(){return Il.get(Dl.RESOURCES)||null}}]),e}());SM.Pipeline=Tl,SM.Task=Ml,SM.Cache=El,SM.RequestItem=mM,SM.Bundle=zN,SM.BuiltinBundleName=Dl;var xM=e("assetManager",h.assetManager=new SM);h.AssetManager=SM;var EM=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],TM=[".mp3",".ogg",".wav",".m4a"];function CM(){return!0}var AM={transformURL:function(e){var t=kl(e);if(!t)return e;var n=Il.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var o=!1;if(".ttf"===Eu(e)&&(o=!0),o){var a=Au(e),s=Cu(e);e=a+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+i}));return e}},bM=e("CCLoader",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=LN}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];xM.loadAny(i,null,(function(e,n,i){i.content&&(EM.includes(i.ext)?a.push(i.content):TM.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var o=function(e){var n=t[e];if(!(n instanceof Mu)){var r=n,o=i[e].url;a.includes(r)?aM.create(o,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&aM.create(o,n,".mp3",{},(function(n,i){r=t[e]=i})),Al.add(o,r)}},c=0;c<t.length;c++)o(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:CM,_map:l}}else r=t[0]}n&&n(e,r)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return xM.assets.has(e)?{content:xM.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=Eu(e);c&&!UN.getInfoWithPath(e,o)&&(e=e.slice(0,-c.length)),UN.load(e,o,a,s)},t.loadResArray=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=Eu(t);i&&!UN.getInfoWithPath(t,o)&&(e[n]=t.slice(0,-i.length))})),UN.load(e,o,a,s)},t.loadResDir=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;UN.loadDir(e,o,a,(function(t,n){var i=[];t||(i=UN.getDirWithPath(e,o).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return Al.has(e)?Al.get(e):UN.get(e,t)},t.getResCount=function(){return Al.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return tv.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);$N.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);_M.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=Al.get(n)),xM.releaseAsset(n)}else e&&("string"==typeof e&&(e=Al.get(e)),xM.releaseAsset(e))},t.releaseAsset=function(e){xM.releaseAsset(e)},t.releaseRes=function(e,t){UN.release(e,t)},t.releaseAll=function(){xM.releaseAll(),Al.clear()},t.removeItem=function(e){return!!Al.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=tv.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},J(e,[{key:"onProgress",set:function(e){wN=e}},{key:"_cache",get:function(){if(Al instanceof El)return Al._map;var e={};return Al.forEach((function(t,n){e[n]=t})),e}},{key:"md5Pipe",get:function(){return AM}},{key:"downloader",get:function(){return $N}},{key:"loader",get:function(){return xM.parser}}]),e}()),wM=e("loader",new bM),IM=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,xM.init(e),e.rawAssets&&UN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:Dl.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){xM.loadAny(e,t)}}),PM=e("url",{});k(PM,"url",[{name:"normalize",target:xM.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?jl({path:bu(e.substr(10)),bundle:Dl.RESOURCES,__isNative__:!0,ext:Eu(e)}):""}}]),H(IM,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),H(wM,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline"}]),k(h,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return wM}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return IM}},{name:"Pipeline",target:SM,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return PM}}]),H(h,"cc",[{name:"LoadingItems",suggest:z(1400,"LoadingItems","AssetManager.Task")}]),k(ft,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:$N,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),k(lN,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return xM.main?null===(t=xM.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),k(sN,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return xM.main&&xM.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var RM,OM,DM,NM,MM,LM,BM,FM,zM,UM,GM,kM,HM,VM,WM=bN._autoRelease;bN._autoRelease=function(e,t,n){WM.call(bN,e,t,n);for(var i=wM._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=Al.get(a);s&&bN.tryRelease(s)}}};var jM,XM,qM,YM,KM,QM,ZM,JM,$M,eL,tL,nL,iL,rL,oL,aL,sL,cL,lL,uL,hL,_L,fL,dL,pL,mL,vL,gL,yL,SL,xL,EL,TL,CL,AL,bL,wL,IL,PL,RL,OL,DL,NL,ML,LL,BL,FL,zL,UL,GL,kL,HL,VL,WL,jL,XL,qL,YL,KL,QL,ZL,JL,$L,eB,tB,nB,iB,rB,oB,aB,sB=e("EventHandler",(RM=Ic("cc.ClickEvent"),OM=hl(h.Node),DM=Zc(),NM=Zc(),MM=Zc(),LM=Zc(),RM((VM=function(){function e(){le(this,"target",zM,this),le(this,"component",UM,this),le(this,"_componentId",GM,this),le(this,"handler",kM,this),le(this,"customEventData",HM,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=t.length;o<a;o++){var s=t[o];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(h.isValid(t)){this._genCompIdIfNeeded();var n=h.js._getClassById(this._componentId),i=t.getComponent(n);if(h.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(i,e))}}},t._compName2Id=function(e){var t=h.js.getClassByName(e);return h.js._getClassId(t)},t._compId2Name=function(e){var t=h.js._getClassById(e);return h.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},J(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),zM=ue((FM=VM).prototype,"target",[Bc,OM,Bc,DM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UM=ue(FM.prototype,"component",[Bc,qc,NM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),GM=ue(FM.prototype,"_componentId",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kM=ue(FM.prototype,"handler",[Bc,qc,MM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),HM=ue(FM.prototype,"customEventData",[Bc,qc,LM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),BM=FM))||BM));h.Component.EventHandler=sB;var cB,lB,uB,hB,_B,fB,dB,pB,mB,vB,gB=new Nn,yB=ct(Jv),SB=ct(Zv),xB=ct($v),EB=ct(tg),TB=ct(eg),CB=ct({SKYBOX:ug|$i.DEPTH_STENCIL,SOLID_COLOR:$i.ALL,DEPTH_ONLY:$i.DEPTH_STENCIL,DONT_CLEAR:$i.NONE}),AB=(jM=Ic("cc.Camera"),XM=Xc(),qM=Hc(),YM=il(),KM=Zc(),QM=hl(Pd.BitMask),ZM=il(),JM=Zc(),$M=hl(CB),eL=il(),tL=Zc(),nL=il(),iL=Zc(),rL=il(),oL=Zc(),aL=il(),sL=Zc(),cL=hl(yB),lL=il(),uL=Zc(),hL=hl(SB),_L=il(),fL=Yc(),dL=Zc(),pL=il(),mL=Yc(),vL=Zc(),gL=il(),yL=Yc(),SL=Zc(),xL=il(),EL=Zc(),TL=il(),CL=Zc(),AL=hl(xB),bL=il(),wL=Zc(),IL=hl(EB),PL=il(),RL=Zc(),OL=hl(TB),DL=il(),NL=Zc(),ML=il(),LL=Zc(),BL=hl(UE),FL=il(),zL=Zc(),cB=jM(UL=XM(UL=qM(UL=kc((aB=oB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_projection",kL,ae(t)),le(t,"_priority",HL,ae(t)),le(t,"_fov",VL,ae(t)),le(t,"_fovAxis",WL,ae(t)),le(t,"_orthoHeight",jL,ae(t)),le(t,"_near",XL,ae(t)),le(t,"_far",qL,ae(t)),le(t,"_color",YL,ae(t)),le(t,"_depth",KL,ae(t)),le(t,"_stencil",QL,ae(t)),le(t,"_clearFlags",ZL,ae(t)),le(t,"_rect",JL,ae(t)),le(t,"_aperture",$L,ae(t)),le(t,"_shutter",eB,ae(t)),le(t,"_iso",tB,ae(t)),le(t,"_screenScale",nB,ae(t)),le(t,"_visibility",iB,ae(t)),le(t,"_targetTexture",rB,ae(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=Ty.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=ca.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new Nn),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new Nn),!this._camera)return n;this.worldToScreen(e,gB);var i=t.getComponent("cc.UITransform"),r=yN.getVisibleSize(),o=gB.x-.5*this._camera.width,a=gB.y-.5*this._camera.height;return gB.x=o/h.view.getScaleX()+.5*r.width,gB.y=a/h.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(gB,n),n},n._createCamera=function(){this._camera||(this._camera=h.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?h.director.root&&h.director.root.mainWindow:h.director.root&&h.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=pn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},J(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Zv.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=pn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?h.director.root&&h.director.root.mainWindow:h.director.root&&h.director.root.tempWindow)}}]),t}(th),oB.ProjectionType=yB,oB.FOVAxis=SB,oB.ClearFlag=CB,oB.Aperture=xB,oB.Shutter=EB,oB.ISO=TB,oB.TARGET_TEXTURE_CHANGE="tex-change",kL=ue((GL=aB).prototype,"_projection",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yB.PERSPECTIVE}}),HL=ue(GL.prototype,"_priority",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VL=ue(GL.prototype,"_fov",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),WL=ue(GL.prototype,"_fovAxis",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SB.VERTICAL}}),jL=ue(GL.prototype,"_orthoHeight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),XL=ue(GL.prototype,"_near",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qL=ue(GL.prototype,"_far",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),YL=ue(GL.prototype,"_color",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On("#333333")}}),KL=ue(GL.prototype,"_depth",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),QL=ue(GL.prototype,"_stencil",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZL=ue(GL.prototype,"_clearFlags",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CB.SOLID_COLOR}}),JL=ue(GL.prototype,"_rect",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(0,0,1,1)}}),$L=ue(GL.prototype,"_aperture",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xB.F16_0}}),eB=ue(GL.prototype,"_shutter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EB.D125}}),tB=ue(GL.prototype,"_iso",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TB.ISO100}}),nB=ue(GL.prototype,"_screenScale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),iB=ue(GL.prototype,"_visibility",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jp}}),rB=ue(GL.prototype,"_targetTexture",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(GL.prototype,"priority",[YM,KM],Object.getOwnPropertyDescriptor(GL.prototype,"priority"),GL.prototype),ue(GL.prototype,"visibility",[QM,ZM,JM],Object.getOwnPropertyDescriptor(GL.prototype,"visibility"),GL.prototype),ue(GL.prototype,"clearFlags",[$M,eL,tL],Object.getOwnPropertyDescriptor(GL.prototype,"clearFlags"),GL.prototype),ue(GL.prototype,"clearColor",[nL,iL],Object.getOwnPropertyDescriptor(GL.prototype,"clearColor"),GL.prototype),ue(GL.prototype,"clearDepth",[rL,oL],Object.getOwnPropertyDescriptor(GL.prototype,"clearDepth"),GL.prototype),ue(GL.prototype,"clearStencil",[aL,sL],Object.getOwnPropertyDescriptor(GL.prototype,"clearStencil"),GL.prototype),ue(GL.prototype,"projection",[cL,lL,uL],Object.getOwnPropertyDescriptor(GL.prototype,"projection"),GL.prototype),ue(GL.prototype,"fovAxis",[hL,_L,fL,dL],Object.getOwnPropertyDescriptor(GL.prototype,"fovAxis"),GL.prototype),ue(GL.prototype,"fov",[pL,mL,vL],Object.getOwnPropertyDescriptor(GL.prototype,"fov"),GL.prototype),ue(GL.prototype,"orthoHeight",[gL,yL,SL],Object.getOwnPropertyDescriptor(GL.prototype,"orthoHeight"),GL.prototype),ue(GL.prototype,"near",[xL,EL],Object.getOwnPropertyDescriptor(GL.prototype,"near"),GL.prototype),ue(GL.prototype,"far",[TL,CL],Object.getOwnPropertyDescriptor(GL.prototype,"far"),GL.prototype),ue(GL.prototype,"aperture",[AL,bL,wL],Object.getOwnPropertyDescriptor(GL.prototype,"aperture"),GL.prototype),ue(GL.prototype,"shutter",[IL,PL,RL],Object.getOwnPropertyDescriptor(GL.prototype,"shutter"),GL.prototype),ue(GL.prototype,"iso",[OL,DL,NL],Object.getOwnPropertyDescriptor(GL.prototype,"iso"),GL.prototype),ue(GL.prototype,"rect",[ML,LL],Object.getOwnPropertyDescriptor(GL.prototype,"rect"),GL.prototype),ue(GL.prototype,"targetTexture",[BL,FL,zL],Object.getOwnPropertyDescriptor(GL.prototype,"targetTexture"),GL.prototype),UL=GL))||UL)||UL)||UL)||UL,e({Camera:cB,CameraComponent:cB}),cB);h.Camera=AB;var bB={parent:null,owner:null,subModelIdx:0},wB=e("RenderableComponent",(lB=Ic("cc.RenderableComponent"),uB=hl(ig),hB=il(),_B=Qc(),fB=hl([ig]),lB((ue((pB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_visFlags",mB,ae(t)),le(t,"_materials",vB,ae(t)),t._materialInstances=[],t._models=[],t}ee(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof fy&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){bB.parent=this._materials[e],bB.owner=this,bB.subModelIdx=e;var t=new fy(bB);bB.parent=null,bB.owner=null,bB.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){D(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},J(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){for(var t=e.length,n=this._materials.length,i=t;i<n;i++)this.setMaterialInstance(null,i);this._materials.length=t,this._materialInstances.length=t;for(var r=0;r<t;r++)this._materialInstances[r]!=e[r]&&this.setMaterialInstance(e[r],r)}}]),t}(th)).prototype,"sharedMaterials",[uB,hB,_B],Object.getOwnPropertyDescriptor(pB.prototype,"sharedMaterials"),pB.prototype),mB=ue(pB.prototype,"_visFlags",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pd.Enum.NONE}}),vB=ue(pB.prototype,"_materials",[fB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dB=pB))||dB));h.RenderableComponent=wB,k(AB,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),k(AB.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),h.CameraComponent=AB,ot.setClassAlias(AB,"cc.CameraComponent"),h.math=hi,h.geometry=wd;var IB=new Nn,PB=new Yn;function RB(e,t,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;e.getWorldMatrix(PB);for(var c=0,l=0;l<s;l++){var u=o[l];Nn.set(IB,u.x,u.y,0),Nn.transformMat4(IB,IB,PB),a[c++]=IB.x,a[c++]=IB.y,a[c++]=IB.z,On.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),d=r.vertexAccessor.getIndexBuffer(h),p=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;d[p++]=g,d[p++]=g+1,d[p++]=g+2,d[p++]=g+1,d[p++]=g+3,d[p++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}var OB={},DB=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new NB;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,i=this._innerTextureInfos[n.getId()],r=t.x,o=t.y;if(i)r+=i.x,o+=i.y;else{var a=n.width,s=n.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;h.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var c={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(e),c},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),NB=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=bm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new fr;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(gv),MB=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new DB(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==Im.LINEAR||t.magFilter!==Im.LINEAR||t.mipFilter!==Im.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],ot.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),h.director.on(h.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),h.director.off(h.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();MB.instance=void 0;var LB,BB,FB,zB=e("dynamicAtlasManager",MB.instance=new MB);h.internal.dynamicAtlasManager=zB;var UB,GB,kB,HB,VB=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],WB=e("SpriteFrame",Ic("cc.SpriteFrame")((FB=BB=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.unbiasUV=[],t.uvSliced=[],t._rect=new si,t._offset=new Jn,t._originalSize=new oi,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}ee(t,e),t.createWithImage=function(e){var n=e instanceof Km?e:new Km(e),i=new gv;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(M(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(M(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&zB&&zB.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=e.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=e.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){VB[0].u=e.x/i,VB[1].u=(e.x+l)/i,VB[2].u=(e.x+l+u)/i,VB[3].u=(e.x+e.height)/i,VB[3].v=e.y/r,VB[2].v=(e.y+o)/r,VB[1].v=(e.y+o+s)/r,VB[0].v=(e.y+e.width)/r;for(var _=0;_<4;++_)for(var f=VB[_],d=0;d<4;++d){var p=VB[3-d];h.push({u:f.u,v:p.v})}}else{VB[0].u=e.x/i,VB[1].u=(e.x+o)/i,VB[2].u=(e.x+o+s)/i,VB[3].u=(e.x+e.width)/i,VB[3].v=e.y/r,VB[2].v=(e.y+c)/r,VB[1].v=(e.y+c+u)/r,VB[0].v=(e.y+e.height)/r;for(var m=0;m<4;++m)for(var v=VB[m],g=0;g<4;++g){var y=VB[g];h.push({u:y.u,v:v.v})}}this.emit(t.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===o?0:e.y/o,l=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=a,t[5]=l,t[6]=a,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=a,t[5]=c,t[6]=a,t[7]=l):this._isFlipUVY?(t[0]=a,t[1]=l,t[2]=a,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,_=0===o?0:e.y/o,f=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var d=0===r?0:e.x/r,p=0===r?1:(e.x+e.width)/r,m=0===o?1:(e.y+e.height)/o,v=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):this._isFlipUVX?(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v):this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,S=0===o?1:(e.y+e.height)/o,x=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVX?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVY?(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S):(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x)}var E=this.vertices;if(E){E.nu.length=0,E.nv.length=0;for(var T=0;T<E.u.length;T++)E.nu[T]=E.u[T]/r,E.nv[T]=E.v[T]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=zB;if(e){var t=this._texture;if(t instanceof gv&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new si(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new Jn(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new oi(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var o=t.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,o,a,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new si(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new oi(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new gv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},J(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?e!==this._texture&&this.reset({texture:e},!0):D(3122,this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(Mu),BB.EVENT_UV_UPDATED="uv_updated",LB=FB))||LB);h.SpriteFrame=WB;var jB,XB=e("SpriteAtlas",Ic("cc.SpriteAtlas")((HB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",kB,ae(t)),t}ee(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=Re();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],nt(WB))},t}(Mu),kB=ue((GB=HB).prototype,"spriteFrames",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Re()}}),UB=GB))||UB);h.SpriteAtlas=XB;var qB,YB,KB,QB,ZB=e("Font",Ic("cc.Font")(jB=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(Mu))||jB);h.Font=ZB;var JB,$B,eF,tF,nF,iF,rF,oF,aF,sF=e("TTFFont",Ic("cc.TTFFont")((QB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",KB,ae(t)),t}return ee(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},J(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:Eu(this._native),__isNative__:!0}}}]),t}(ZB),KB=ue((YB=QB).prototype,"_fontFamily",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(YB.prototype,"_nativeAsset",[fl,ul],Object.getOwnPropertyDescriptor(YB.prototype,"_nativeAsset"),YB.prototype),ue(YB.prototype,"_nativeDep",[fl],Object.getOwnPropertyDescriptor(YB.prototype,"_nativeDep"),YB.prototype),qB=YB))||qB);h.TTFFont=sF;var cF,lF=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},uF=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new lF;ke(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),hF=e("BitmapFont",(JB=Ic("cc.BitmapFont"),$B=hl(WB),JB((aF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",nF,ae(t)),le(t,"spriteFrame",iF,ae(t)),le(t,"fontSize",rF,ae(t)),le(t,"fntConfig",oF,ae(t)),t}return ee(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new uF(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new lF,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else E("The fnt config is not exists!")},t}(ZB),nF=ue((tF=aF).prototype,"fntDataStr",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iF=ue(tF.prototype,"spriteFrame",[$B],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rF=ue(tF.prototype,"fontSize",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),oF=ue(tF.prototype,"fntConfig",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eF=tF))||eF));h.BitmapFont=hF;var _F=e("LabelAtlas",Ic("cc.LabelAtlas")(cF=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(hF))||cF);h.LabelAtlas=_F;var fF=e("BASELINE_RATIO",.26),dF=e("MIDDLE_RATIO",(fF+1)/2-fF);var pF=new it(2);pF.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var mF,vF=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=pF.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,pF.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),gF=/([a-zA-Z0-9--]+|\S)/,yF=/^[!,.:;'}\]%\?>]/,SF=/([a-zA-Z0-9--iI]+|\S)$/,xF=/[a-zA-Z0-9--iI]+$/,EF=/^[a-zA-Z0-9--iI]/;function TF(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function CF(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function AF(e,t,n){var i=(n||e.font)+""+t,r=vF.get(i);if(null!==r)return r;var o=e.measureText(t),a=o&&o.width||0;return vF.put(i,a),a}function bF(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}function wF(e){return EF.exec(e)}function IF(e){return xF.exec(e)}function PF(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var o=e;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=bF(o,a),c=t-i(s),l=s,u=0,h=0;c>n&&h++<100;)a*=n/c,c=t-i(s=bF(o,a|=0));for(h=0;s&&c<=n&&h++<100;){var _=gF.exec(s);l=s,c=t-i(s=bF(o,a+=u=_?_[0].length:1))}0==(a-=u)?(a=1,l=bF(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=bF(o,2));var f=bF(o,0,a),d=void 0;yF.test(l||s)&&(0==(a-=(d=SF.exec(f))?d[0].length:0)&&(a=1),l=bF(o,a),f=bF(o,0,a)),EF.test(l)&&(d=xF.exec(f))&&f!==d[0]&&(l=bF(o,a-=d[0].length),f=bF(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var RF=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return mF||(mF=new e),mF};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=ft.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),OF=On.WHITE.clone(),DF=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},NF="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",MF=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=RF.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=AF(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+fF)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*fF/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Km),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=NF,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,o=n/2,a=i/2+r*dF+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||OF;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,o,a)}e.fillText(this.char,o,a)}},e}(),LF=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=bm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new fr;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(gv),BF=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new LF;n.initWithSize(e,t),this.fontDefDictionary=new uF(n),this._halfBleed=1,this._width=e,this._height=t,lN.on(cN.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=lN.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return D(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var o=new DF;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new LF;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new MF(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},J(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),FF={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:On.WHITE.clone(),isOutlined:!1,out:On.WHITE.clone(),margin:0},zF=[new Br(ir.ATTR_POSITION,vi.RGB32F)],UF=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_COLOR,vi.RGBA32F)],GF=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RG32F),new Br(ir.ATTR_COLOR,vi.RGBA32F)],kF=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RG32F),new Br(ir.ATTR_COLOR,vi.RGBA32F),new Br(ir.ATTR_COLOR2,vi.RGBA32F)];function HF(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=ao[i.format].count}return t}function VF(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=ao[i.format].size}return t}h.internal.vfmtPosUvColor=GF,h.internal.vfmtPosUvTwoColor=kF,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:zF,vfmtPosColor:UF,vfmtPosUvColor:GF,vfmtPosUvTwoColor:kF,getComponentPerVertex:HF,getAttributeStride:VF}));var WF,jF,XF,qF,YF,KF,QF,ZF,JF,$F,ez,tz,nz,iz,rz,oz=VF(GF)>>2,az=new Kl((function(){return{x:0,y:0,z:0,u:0,v:0,color:On.WHITE.clone()}}),128),sz=null,cz=e("BaseRenderData",function(){function e(e){void 0===e&&(e=GF),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=GF,this._floatStride=e===GF?oz:VF(e)>>2,this._vertexFormat=e}return e.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},J(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),e}()),lz=e("RenderData",function(e){function t(t,n){var i;return void 0===t&&(t=GF),(i=e.call(this,t)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=lN.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}ee(t,e),t.add=function(e,n){void 0===e&&(e=GF),sz||(sz=new Ql((function(){return new t}),32));var i=sz.add();return i._floatStride=e===GF?oz:VF(e)>>2,i._vertexFormat=e,n||(n=lN.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},t.remove=function(e){var t=sz.data.indexOf(e);-1!==t&&(e.clear(),e._accessor=null,sz.removeAt(t))};var n=t.prototype;return n.resize=function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())},n.resizeAndCopy=function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var n=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=bo(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},J(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)az.free(t[i]);for(i=n;i<e;i++)t[i]=az.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(cz)),uz=e("MeshRenderData",function(e){function t(t){var n;return void 0===t&&(t=GF),(n=e.call(this,t)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}ee(t,e),t.add=function(e){void 0===e&&(e=GF);var t=hz.add();return t._floatStride=e===GF?oz:VF(e)>>2,t._vertexFormat=e,t},t.remove=function(e){var t=hz.data.indexOf(e);-1!==t&&(hz.data[t].clear(),hz.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(e,t){var n=this._byteLength+e*this.stride,i=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(e,t){var n=e*this.stride;e>=0&&t>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=n,this.updateRange(0,e,0,t)},n.updateRange=function(e,t,n,i){t>=0&&i>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=n,this.vertexRange=t,this.indexRange=i},n.requestIA=function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,e),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(e){var t=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(e.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,r,r))),this._iaInfo=new zr(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Ql((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),i&&this.iData.set(i,0)},J(t,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),t}(cz)),hz=new Ql((function(){return new uz}),32),_z=new Jn,fz=new Jn,dz=new Nn,pz=new Yn,mz=new Yn,vz=new Yn,gz=new Yn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),yz=new si,Sz=function(t){return e({UITransform:t,UITransformComponent:t}),t}((WF=Ic("cc.UITransform"),jF=Xc(),XF=Rc(110),qF=Hc(),YF=il(),KF=Zc(),QF=il(),ZF=Zc(),WF(JF=jF(JF=XF(JF=qF(JF=Oc(JF=kc((iz=nz=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._priority=0,le(t,"_contentSize",ez,ae(t)),le(t,"_anchorPoint",tz,ae(t)),t}ee(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(cC.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(cC.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if(hn((e=e).width,n.width,ln)&&hn(e.height,n.height,ln))return;n.width=e.width,n.height=e.height}else{if(hn(e=e,n.width,ln)&&hn(t,n.height,ln))return;n.width=e,n.height=t}this.node.emit(cC.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(cC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t=this._contentSize.width,n=this._contentSize.height,i=_z,r=fz,o=this._getRenderScene().cameras,a=0;a<o.length;a++){var s=o[a];if(s.visibility&this.node.layer){s.node.getWorldRT(pz);var c=pz.m12,l=pz.m13,u=_N.center;if(pz.m12=u.x-(pz.m00*c+pz.m04*l),pz.m13=u.y-(pz.m01*c+pz.m05*l),Yn.invert(pz,pz),Jn.transformMat4(i,e,pz),this.node.getWorldMatrix(vz),Yn.invert(pz,vz),!Yn.strictEquals(pz,gz)){Jn.transformMat4(r,i,pz),r.x+=this._anchorPoint.x*t,r.y+=this._anchorPoint.y*n;var h=!1;if(r.x>=0&&r.y>=0&&r.x<=t&&r.y<=n&&(h=this._maskTest(i)),h)return!0}}}return!1},n.hitTest=function(e){for(var t=this._contentSize.width,n=this._contentSize.height,i=dz,r=_z,o=fz,a=this._getRenderScene().cameras,s=0;s<a.length;s++){var c=a[s];if(c.visibility&this.node.layer&&(Nn.set(i,e.x,e.y,0),c.screenToWorld(i,i),Jn.set(r,i.x,i.y),this.node.getWorldMatrix(vz),Yn.invert(pz,vz),!Yn.strictEquals(pz,gz))){Jn.transformMat4(o,r,pz),o.x+=this._anchorPoint.x*t,o.y+=this._anchorPoint.y*n;var l=!1;if(o.x>=0&&o.y>=0&&o.x<=t&&o.y<=n&&(l=this._maskTest(r)),l)return!0}}return!1},n._maskTest=function(e){var t,n,i=null===(t=this.node)||void 0===t||null===(n=t.eventProcessor)||void 0===n?void 0:n.maskList;if(i)for(var r=this.node,o=i.length,a=0,s=0;r&&s<o;++a,r=r.parent){var c=i[s];if(a===c.index){if(r!==c.comp.node){i.length=s;break}var l=c.comp;if(l&&l._enabled&&!l.isHit(e))return!1;s++}else if(a>c.index){i.length=s;break}}return!0},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(vz),Yn.invert(pz,vz),t||(t=new Nn),Nn.transformMat4(t,e,pz)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(vz),t||(t=new Nn),Nn.transformMat4(t,e,vz)},n.getBoundingBox=function(){Yn.fromRTS(mz,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new si(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(mz),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(vz),this.getBoundingBoxTo(vz)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){Yn.fromRTS(mz,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new si(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Yn.multiply(vz,e,mz),r.transformMat4(vz),!this.node.children)return r;for(var o,a=ce(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&si.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;yz.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),yz.transformMat4(this.node.worldMatrix);var i=yz.x+.5*yz.width,r=yz.y+.5*yz.height,o=this.node.worldPosition.z,a=yz.width/2,s=yz.height/2;return null!=e?($s.set(e,i,r,o,a,s,.001),e):new $s(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},J(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(cC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(cC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(cC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(cC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(cC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(cC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?D(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=lN.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=lN.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(th),nz.EventType=cC,nz.priorityChangeNodeMap=new Map,ue(($F=iz).prototype,"contentSize",[YF,KF],Object.getOwnPropertyDescriptor($F.prototype,"contentSize"),$F.prototype),ue($F.prototype,"anchorPoint",[QF,ZF],Object.getOwnPropertyDescriptor($F.prototype,"anchorPoint"),$F.prototype),ez=ue($F.prototype,"_contentSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(100,100)}}),tz=ue($F.prototype,"_anchorPoint",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(.5,.5)}}),JF=$F))||JF)||JF)||JF)||JF)||JF)||JF));lN.on(cN.EVENT_AFTER_UPDATE,Sz._sortSiblings),lN.on(cN.EVENT_BEFORE_SCENE_LAUNCH,Sz._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(rz||(rz={}));var xz,Ez,Tz,Cz,Az,bz,wz,Iz,Pz,Rz,Oz,Dz,Nz,Mz,Lz,Bz,Fz,zz,Uz,Gz,kz=e("StencilManager",function(){function e(){this.stage=rz.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Di.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Ni.KEEP,zFailOp:Ni.KEEP,passOp:Ni.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?rz.CLEAR_INVERTED:rz.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?rz.ENTER_LEVEL_INVERTED:rz.ENTER_LEVEL},t.enableMask=function(){this.stage=rz.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=rz.DISABLED:this.stage=rz.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=rz.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,o=Di.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(e);var u=new Do(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===rz.DISABLED?(t.stencilTest=!1,t.func=Di.ALWAYS,t.failOp=Ni.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===rz.ENABLED?(t.func=Di.EQUAL,t.failOp=Ni.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===rz.CLEAR?(t.func=Di.NEVER,t.failOp=Ni.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===rz.CLEAR_INVERTED||e===rz.ENTER_LEVEL?(t.func=Di.NEVER,t.failOp=Ni.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===rz.ENTER_LEVEL_INVERTED&&(t.func=Di.NEVER,t.failOp=Ni.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},J(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());kz.sharedManager=null,kz.sharedManager=new kz,ht(Mi),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(Gz||(Gz=e("InstanceMaterialType",{})));var Hz,Vz,Wz,jz,Xz,qz,Yz,Kz,Qz,Zz,Jz,$z,eU,tU,nU,iU,rU,oU,aU,sU,cU,lU,uU,hU,_U,fU,dU,pU,mU,vU,gU,yU,SU,xU,EU,TU,CU,AU,bU,wU,IU,PU,RU,OU,DU,NU,MU,LU,BU,FU,zU,UU,GU,kU,HU,VU,WU,jU,XU,qU,YU,KU,QU,ZU,JU,$U,eG,tG,nG,iG,rG=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((xz=Ic("cc.Renderable2D"),Ez=Pc(Sz),Tz=Yc(),Cz=hl(ig),Az=hl(ig),bz=il(),wz=Zc(),Iz=Qc(),Pz=il(),Rz=Zc(),xz(Oz=Ez(Oz=Oc(Oz=kc((Uz=zz=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_materials",Nz,ae(t)),le(t,"_customMaterial",Mz,ae(t)),t.stencilStage=rz.DISABLED,le(t,"_srcBlendFactor",Lz,ae(t)),le(t,"_dstBlendFactor",Bz,ae(t)),le(t,"_color",Fz,ae(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new Mo,t._blendHash=0,t._useVertexOpacity=!1,t._lastParent=null,t}ee(t,e);var n=t.prototype;return n.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(cC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(cC.SIZE_CHANGED,this._nodeStateChange,this),this.node.on(cC.PARENT_CHANGED,this._colorDirty,this),this.updateMaterial(),this._renderFlag=this._canRender(),this._colorDirty()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(cC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(cC.SIZE_CHANGED,this._nodeStateChange,this),this.node.off(cC.PARENT_CHANGED,this._colorDirty,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else this._renderDataFlag=e},n.requestRenderData=function(){var e=lz.add();return this._renderData=e,e},n.destroyRenderData=function(){this._renderData&&(lz.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this,e),this._renderDataFlag=!1),this._renderFlag&&this._render(e)},n.postUpdateAssembler=function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new No,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=Mi.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}},n._colorDirty=function(){this.node._uiProps.colorDirty=!0},n._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},n._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case Gz.ADD_COLOR:e=wv.get("ui-base-material");break;case Gz.GRAYSCALE:e=wv.get("ui-sprite-gray-material");break;case Gz.USE_ALPHA_SEPARATED:e=wv.get("ui-sprite-alpha-sep-material");break;case Gz.USE_ALPHA_SEPARATED_AND_GRAY:e=wv.get("ui-sprite-gray-alpha-sep-material");break;default:e=wv.get("ui-sprite-material")}return e},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},J(t,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}},{key:"useVertexOpacity",get:function(){return this._useVertexOpacity}}]),t}(wB),zz.BlendState=Mi,zz.Assembler=null,zz.PostAssembler=null,Nz=ue((Dz=Uz).prototype,"_materials",[fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ue(Dz.prototype,"sharedMaterials",[fl,Tz],Object.getOwnPropertyDescriptor(Dz.prototype,"sharedMaterials"),Dz.prototype),Mz=ue(Dz.prototype,"_customMaterial",[Cz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(Dz.prototype,"customMaterial",[Az,bz,wz,Iz,al],Object.getOwnPropertyDescriptor(Dz.prototype,"customMaterial"),Dz.prototype),ue(Dz.prototype,"color",[Pz,Rz],Object.getOwnPropertyDescriptor(Dz.prototype,"color"),Dz.prototype),Lz=ue(Dz.prototype,"_srcBlendFactor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.SRC_ALPHA}}),Bz=ue(Dz.prototype,"_dstBlendFactor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.ONE_MINUS_SRC_ALPHA}}),Fz=ue(Dz.prototype,"_color",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.WHITE.clone()}}),Oz=Dz))||Oz)||Oz)||Oz)||Oz));h.internal.Renderable2D=rG,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(eG||(eG=e("HorizontalTextAlignment",{}))),ht(eG),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(tG||(tG=e("VerticalTextAlignment",{}))),ht(tG),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(nG||(nG=e("Overflow",{}))),ht(nG),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(iG||(iG=e("CacheMode",{}))),ht(iG);var oG,aG,sG,cG=function(t){return e({Label:t,LabelComponent:t}),t}((Hz=Ic("cc.Label"),Vz=Xc(),Wz=Rc(110),jz=Hc(),Xz=il(),qz=Zc(),Yz=hl(eG),Kz=il(),Qz=Zc(),Zz=hl(tG),Jz=il(),$z=Zc(),eU=il(),tU=Zc(),nU=il(),iU=Yc(),rU=Zc(),oU=il(),aU=Zc(),sU=Yc(),cU=il(),lU=Zc(),uU=hl(nG),hU=il(),_U=Zc(),fU=il(),dU=Zc(),pU=hl(ZB),mU=il(),vU=Yc(),gU=Zc(),yU=il(),SU=Zc(),xU=hl(iG),EU=il(),TU=Zc(),CU=il(),AU=Zc(),bU=il(),wU=Zc(),IU=il(),PU=Zc(),RU=Yc(),OU=il(),DU=Zc(),Hz(NU=Vz(NU=Wz(NU=jz(($U=JU=function(e){function t(){var t;return le(t=e.call(this)||this,"_string",LU,ae(t)),le(t,"_horizontalAlign",BU,ae(t)),le(t,"_verticalAlign",FU,ae(t)),le(t,"_actualFontSize",zU,ae(t)),le(t,"_fontSize",UU,ae(t)),le(t,"_fontFamily",GU,ae(t)),le(t,"_lineHeight",kU,ae(t)),le(t,"_overflow",HU,ae(t)),le(t,"_enableWrapText",VU,ae(t)),le(t,"_font",WU,ae(t)),le(t,"_isSystemFontUsed",jU,ae(t)),le(t,"_spacingX",XU,ae(t)),le(t,"_isItalic",qU,ae(t)),le(t,"_isBold",YU,ae(t)),le(t,"_isUnderline",KU,ae(t)),le(t,"_underlineHeight",QU,ae(t)),le(t,"_cacheMode",ZU,ae(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}ee(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){e.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof hF){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof hF){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===iG.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new WB,this._assemblerData=this._assembler.getAssemblerData();var n=new Km(this._assemblerData.canvas),i=new gv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==iG.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==iG.CHAR){var t=this._texture.texture;if(t instanceof qm){var n=t.getPixelFormat();e=n===bm.RGBA_ETC1||n===bm.RGB_A_PVRTC_4BPPV1||n===bm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?Gz.USE_ALPHA_SEPARATED:Gz.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},n._updateBlendFunc=function(){e.prototype._updateBlendFunc.call(this)},J(t,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==iG.BITMAP||this._font instanceof hF||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===iG.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof hF?this._font.fontSize:-1}}]),t}(rG),JU.HorizontalAlign=eG,JU.VerticalAlign=tG,JU.Overflow=nG,JU.CacheMode=iG,JU._canvasPool=RF.getInstance(),ue((MU=$U).prototype,"string",[Xz,qz,ol],Object.getOwnPropertyDescriptor(MU.prototype,"string"),MU.prototype),ue(MU.prototype,"horizontalAlign",[Yz,Kz,Qz],Object.getOwnPropertyDescriptor(MU.prototype,"horizontalAlign"),MU.prototype),ue(MU.prototype,"verticalAlign",[Zz,Jz,$z],Object.getOwnPropertyDescriptor(MU.prototype,"verticalAlign"),MU.prototype),ue(MU.prototype,"fontSize",[eU,tU],Object.getOwnPropertyDescriptor(MU.prototype,"fontSize"),MU.prototype),ue(MU.prototype,"fontFamily",[nU,iU,rU],Object.getOwnPropertyDescriptor(MU.prototype,"fontFamily"),MU.prototype),ue(MU.prototype,"lineHeight",[oU,aU],Object.getOwnPropertyDescriptor(MU.prototype,"lineHeight"),MU.prototype),ue(MU.prototype,"spacingX",[sU,cU,lU],Object.getOwnPropertyDescriptor(MU.prototype,"spacingX"),MU.prototype),ue(MU.prototype,"overflow",[uU,hU,_U],Object.getOwnPropertyDescriptor(MU.prototype,"overflow"),MU.prototype),ue(MU.prototype,"enableWrapText",[fU,dU],Object.getOwnPropertyDescriptor(MU.prototype,"enableWrapText"),MU.prototype),ue(MU.prototype,"font",[pU,mU,vU,gU],Object.getOwnPropertyDescriptor(MU.prototype,"font"),MU.prototype),ue(MU.prototype,"useSystemFont",[yU,SU],Object.getOwnPropertyDescriptor(MU.prototype,"useSystemFont"),MU.prototype),ue(MU.prototype,"cacheMode",[xU,EU,TU],Object.getOwnPropertyDescriptor(MU.prototype,"cacheMode"),MU.prototype),ue(MU.prototype,"isBold",[CU,AU],Object.getOwnPropertyDescriptor(MU.prototype,"isBold"),MU.prototype),ue(MU.prototype,"isItalic",[bU,wU],Object.getOwnPropertyDescriptor(MU.prototype,"isItalic"),MU.prototype),ue(MU.prototype,"isUnderline",[IU,PU],Object.getOwnPropertyDescriptor(MU.prototype,"isUnderline"),MU.prototype),ue(MU.prototype,"underlineHeight",[RU,qc,OU,DU],Object.getOwnPropertyDescriptor(MU.prototype,"underlineHeight"),MU.prototype),LU=ue(MU.prototype,"_string",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),BU=ue(MU.prototype,"_horizontalAlign",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eG.CENTER}}),FU=ue(MU.prototype,"_verticalAlign",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tG.CENTER}}),zU=ue(MU.prototype,"_actualFontSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UU=ue(MU.prototype,"_fontSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),GU=ue(MU.prototype,"_fontFamily",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),kU=ue(MU.prototype,"_lineHeight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),HU=ue(MU.prototype,"_overflow",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nG.NONE}}),VU=ue(MU.prototype,"_enableWrapText",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WU=ue(MU.prototype,"_font",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jU=ue(MU.prototype,"_isSystemFontUsed",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XU=ue(MU.prototype,"_spacingX",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qU=ue(MU.prototype,"_isItalic",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YU=ue(MU.prototype,"_isBold",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),KU=ue(MU.prototype,"_isUnderline",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QU=ue(MU.prototype,"_underlineHeight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),ZU=ue(MU.prototype,"_cacheMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iG.NONE}}),NU=MU))||NU)||NU)||NU)||NU));h.Label=cG,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(oG||(oG={})),ht(oG),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(aG||(aG={})),ht(aG),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(sG||(sG={})),ht(sG);var lG=Math.PI,uG=Math.min,hG=Math.max,_G=Math.cos,fG=Math.sin,dG=Math.abs,pG=Math.sign,mG=.5522847493;function vG(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*mG,t-i*mG,n+r,t,n+r),e.bezierCurveTo(t+i*mG,n+r,t+i,n+r*mG,t+i,n),e.bezierCurveTo(t+i,n-r*mG,t+i*mG,n-r,t,n-r),e.bezierCurveTo(t-i*mG,n-r,t-i,n-r*mG,t-i,n),e.close()}function gG(e,t,n,i,r,o,a,s,c,l,u){var h,_,f,d,p,m,v,g,y,S,x,E,T,C,A,b;l>10||(p=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(t+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(d=.5*(r+a))),((A=dG((i-s)*(C=c-n)-(r-c)*(T=s-t)))+(b=dG((o-s)*C-(a-c)*T)))*(A+b)<e.tessTol*(T*T+C*C)?e.addPoint(s,c,0===u?u|sG.PT_BEVEL:u):(gG(e,t,n,h,_,v,g,x=.5*(v+(y=.5*(f+p))),E=.5*(g+(S=.5*(d+m))),l+1,0),gG(e,x,E,y,S,p,m,s,c,l+1,u)))}var yG,SG,xG,EG,TG,CG,AG,bG,wG,IG,PG,RG,OG,DG,NG,MG,LG,BG,FG,zG,UG,GG,kG,HG,VG,WG,jG,XG,qG,YG,KG,QG,ZG,JG,$G,ek,tk,nk,ik,rk,ok,ak,sk,ck,lk,uk,hk,_k=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return ee(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(Jn),fk=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),dk=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=On.WHITE.clone(),this.lineCap=oG.BUTT,this.strokeColor=On.BLACK.clone(),this.lineJoin=aG.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,sG.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,sG.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==o?(gG(this,s.x,s.y,e,t,n,i,r,o,0,sG.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,o){!function(e,t,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,g=0,y=0,S=0,x=0,E=0;if(u=o-r,a=a||!1)if(dG(u)>=2*lG)u=2*lG;else for(;u<0;)u+=2*lG;else if(dG(u)>=2*lG)u=2*-lG;else for(;u>0;)u-=2*lG;for(c=0|hG(1,uG(dG(u)/(.5*lG)+.5,5)),h=dG(4/3*(1-_G(s=u/c/2))/fG(s)),a||(h=-h),E=0;E<=c;E++)d=t+(_=_G(l=r+u*(E/c)))*i,p=n+(f=fG(l))*i,m=-f*i*h,v=_*i*h,0===E?e.moveTo(d,p):e.bezierCurveTo(g+S,y+x,d-m,p-v,d,p),g=d,y=p,S=m,x=v}(this,e,t,n,i,r,o)},t.ellipse=function(e,t,n,i){vG(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){vG(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,o){if(o<.1)e.rect(t,n,i,r);else{var a=uG(o,.5*dG(i))*pG(i),s=uG(o,.5*dG(r))*pG(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-mG),t+a*(1-mG),n+r,t+a,n+r),e.lineTo(t+i-a,n+r),e.bezierCurveTo(t+i-a*(1-mG),n+r,t+i,n+r-s*(1-mG),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-mG),t+i-a*(1-mG),n,t+i-a,n),e.lineTo(t+a,n),e.bezierCurveTo(t+a*(1-mG),n,t,n+s*(1-mG),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&uz.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=uz.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new _k(e,t),r.push(a)),a.flags=n,o.push(a)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new fk,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),pk=UF.concat([new Br("a_dist",vi.R32F)]),mk=HF(pk),vk=VF(pk),gk=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((yG=Ic("cc.Graphics"),SG=Xc(),xG=Rc(110),EG=Hc(),TG=Zc(),CG=hl(aG),AG=Zc(),bG=hl(oG),wG=Zc(),IG=Zc(),PG=Zc(),RG=Zc(),OG=Yc(),yG(DG=SG(DG=xG(DG=EG((kG=GG=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,le(t,"_lineWidth",MG,ae(t)),le(t,"_strokeColor",LG,ae(t)),le(t,"_lineJoin",BG,ae(t)),le(t,"_lineCap",FG,ae(t)),le(t,"_fillColor",zG,ae(t)),le(t,"_miterLimit",UG,ae(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=Gz.ADD_COLOR,t.impl=new dk,t}ee(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=lN.root.createModel(uy),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(lN.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),e.prototype.onDestroy.call(this)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,o){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,o)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,o){this.impl&&this.impl.arc(e,t,n,i,r,o)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=wv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=h.director.root.device,n=t.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,65535*vk,vk)),i=t.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new sw([n],pk,Vi.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(e,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else D(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*mk);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},J(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(rG),GG.LineJoin=aG,GG.LineCap=oG,ue((NG=kG).prototype,"lineWidth",[qc,TG],Object.getOwnPropertyDescriptor(NG.prototype,"lineWidth"),NG.prototype),ue(NG.prototype,"lineJoin",[CG,AG],Object.getOwnPropertyDescriptor(NG.prototype,"lineJoin"),NG.prototype),ue(NG.prototype,"lineCap",[bG,wG],Object.getOwnPropertyDescriptor(NG.prototype,"lineCap"),NG.prototype),ue(NG.prototype,"strokeColor",[IG],Object.getOwnPropertyDescriptor(NG.prototype,"strokeColor"),NG.prototype),ue(NG.prototype,"fillColor",[PG],Object.getOwnPropertyDescriptor(NG.prototype,"fillColor"),NG.prototype),ue(NG.prototype,"miterLimit",[RG],Object.getOwnPropertyDescriptor(NG.prototype,"miterLimit"),NG.prototype),ue(NG.prototype,"color",[fl,OG],Object.getOwnPropertyDescriptor(NG.prototype,"color"),NG.prototype),MG=ue(NG.prototype,"_lineWidth",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),LG=ue(NG.prototype,"_strokeColor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.BLACK.clone()}}),BG=ue(NG.prototype,"_lineJoin",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aG.MITER}}),FG=ue(NG.prototype,"_lineCap",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oG.BUTT}}),zG=ue(NG.prototype,"_fillColor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.WHITE.clone()}}),UG=ue(NG.prototype,"_miterLimit",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),DG=NG))||DG)||DG)||DG)||DG));h.Graphics=gk;var yk,Sk=new Yn,xk=new Jn,Ek=new Yn,Tk=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(yk||(yk={})),ht(yk);var Ck=function(t){return e({Mask:t,MaskComponent:t}),t}((HG=Ic("cc.Mask"),VG=Xc(),WG=Rc(110),jG=Hc(),XG=hl(yk),qG=Zc(),YG=il(),KG=Zc(),QG=Yc(),ZG=hl(WB),JG=Yc(),$G=Yc(),ek=Jc(),tk=Yc(),nk=Yc(),HG(ik=VG(ik=WG(ik=jG((hk=uk=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,le(t,"_type",ok,ae(t)),le(t,"_inverted",ak,ae(t)),le(t,"_segments",sk,ae(t)),le(t,"_spriteFrame",ck,ae(t)),le(t,"_alphaThreshold",lk,ae(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=Gz.ADD_COLOR,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(lN.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),e.prototype.onDestroy.call(this)},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,o=xk;this.node.getWorldMatrix(Sk),Yn.invert(Ek,Sk),Jn.transformMat4(o,e,Ek);var a=t.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===yk.RECT||this.type===yk.GRAPHICS_STENCIL||this.type===yk.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===yk.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==yk.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new gk;e._objFlags|=yl.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=On.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===yk.RECT||this._type===yk.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,o=e.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===yk.RECT)t.rect(a,s,i,r);else if(this._type===yk.ELLIPSE){for(var c=function(e,t,n){Tk.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)Tk.push(new Nn(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return Tk}(new Nn(a+i/2,s+r/2,0),new Nn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=wv.get("default-clear-stencil");this._clearStencilMtl=new fy({parent:e,owner:this,subModelIdx:0}),this._clearModel=lN.root.createModel(uy),this._clearModel.node=this._clearModel.transform=this.node;var t=VF(zF),n=h.director.root.device,i=n.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,4*t,t)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var o=n.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new sw([i],zF,Vi.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=rz.DISABLED,this._type===yk.IMAGE_STENCIL?(e=wv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=wv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==yk.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},J(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==yk.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=rz.DISABLED,this._graphics&&(this._graphics.stencilStage=rz.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=_n(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===yk.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===yk.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(rG),uk.Type=yk,ue((rk=hk).prototype,"type",[XG,qG],Object.getOwnPropertyDescriptor(rk.prototype,"type"),rk.prototype),ue(rk.prototype,"inverted",[YG,KG],Object.getOwnPropertyDescriptor(rk.prototype,"inverted"),rk.prototype),ue(rk.prototype,"segments",[QG],Object.getOwnPropertyDescriptor(rk.prototype,"segments"),rk.prototype),ue(rk.prototype,"spriteFrame",[ZG,JG],Object.getOwnPropertyDescriptor(rk.prototype,"spriteFrame"),rk.prototype),ue(rk.prototype,"alphaThreshold",[$G,ek,nl],Object.getOwnPropertyDescriptor(rk.prototype,"alphaThreshold"),rk.prototype),ue(rk.prototype,"color",[fl,tk],Object.getOwnPropertyDescriptor(rk.prototype,"color"),rk.prototype),ue(rk.prototype,"customMaterial",[fl,nk],Object.getOwnPropertyDescriptor(rk.prototype,"customMaterial"),rk.prototype),ok=ue(rk.prototype,"_type",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yk.RECT}}),ak=ue(rk.prototype,"_inverted",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sk=ue(rk.prototype,"_segments",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),ck=ue(rk.prototype,"_spriteFrame",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lk=ue(rk.prototype,"_alphaThreshold",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),ik=rk))||ik)||ik)||ik)||ik));XP._maskComp=Ck,h.Mask=Ck;var Ak,bk,wk,Ik,Pk,Rk,Ok,Dk,Nk,Mk,Lk,Bk,Fk,zk,Uk,Gk,kk,Hk,Vk,Wk,jk,Xk,qk,Yk,Kk,Qk,Zk,Jk,$k,eH,tH,nH,iH,rH,oH,aH,sH,cH,lH,uH,hH,_H,fH,dH,pH,mH,vH,gH,yH,SH,xH,EH,TH,CH,AH,bH,wH,IH,PH,RH,OH,DH,NH=/^(click)(\s)*=|(param)(\s)*=/,MH=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,LH=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var o=e.substring(t,r),a=e.substring(r+1,i);""===a&&(o=e.substring(t,i+1)),this._processResult(o),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,o="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(o=e.substring(r+1).trim(),t.event=this._processEventHandler(o)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="",s=-1;if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var c;n=MH.exec(e);for(var l=!1;n;){var u=(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length)).length;if(i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),a=e.substring(u).trim(),s="src"===i?this.getRightQuotationIndex(a):-1,c=(r=a.indexOf(" ",s+1>=a.length?-1:s+1))>-1?a.substr(0,r):a,e=a.substring(r).trim(),c.endsWith("/")&&(c=c.slice(0,-1)),"src"===i){switch(c.charCodeAt(0)){case 34:case 39:l=!0,c=c.slice(1,-1)}t.isImage=!0,t.src=c}else if("height"===i)t.imageHeight=parseInt(c);else if("width"===i)t.imageWidth=parseInt(c);else if("align"===i){switch(c.charCodeAt(0)){case 34:case 39:c=c.slice(1,-1)}t.imageAlign=c.toLowerCase()}else"offset"===i?t.imageOffset=c:"click"===i&&(t.event=this._processEventHandler(i+"="+c));t.event&&"param"===i&&(t.event[i]=c.replace(/^"|"$/g,"")),n=MH.exec(e)}return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var h={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var _,f=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=f.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),_=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+_):"color"===i?h.color=_:"width"===i&&(h.width=parseInt(_)),t.event&&"param"===i&&(t.event[i]=_.replace(/^"|"$/g,"")),n=f.exec(e)}t.outline=h}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t.getRightQuotationIndex=function(e){var t=-1,n=-1,i=e.indexOf("'"),r=e.indexOf('"'),o=r>-1&&(r<i||-1===i);return i>-1&&(i<r||-1===r)?(t=i,n=e.indexOf("'",t+1>=e.length?-1:t+1)):o&&(t=r,n=e.indexOf('"',t+1>=e.length?-1:t+1)),n},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=NH.exec(e);r;){var o=r[0],a="";if(i=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(a=s?s[0]:"").length}i&&(t[o=o.substring(0,o.length-1).trim()]=a),e=e.substring(n).trim(),r=NH.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=ce(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],o=i[1];e=e.replace(r,o)}return e},e}()),BH=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((Ak=Ic("cc.LabelOutline"),bk=Xc(),wk=Rc(110),Ik=Hc(),Pk=Pc(cG),Rk=Zc(),Ok=Zc(),Ak(Dk=bk(Dk=wk(Dk=Ik(Dk=Pk(Dk=kc((Bk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_color",Mk,ae(t)),le(t,"_width",Lk,ae(t)),t}ee(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(cG);e&&e.updateRenderData(!0)},J(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(th),Mk=ue((Nk=Bk).prototype,"_color",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(0,0,0,255)}}),Lk=ue(Nk.prototype,"_width",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),ue(Nk.prototype,"color",[Rk],Object.getOwnPropertyDescriptor(Nk.prototype,"color"),Nk.prototype),ue(Nk.prototype,"width",[Ok],Object.getOwnPropertyDescriptor(Nk.prototype,"width"),Nk.prototype),Dk=Nk))||Dk)||Dk)||Dk)||Dk)||Dk)||Dk));h.LabelOutline=BH,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(PH||(PH={})),ht(PH),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(RH||(RH={})),ht(RH),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(OH||(OH={})),ht(OH),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(DH||(DH={}));var FH,zH=function(t){return e({Sprite:t,SpriteComponent:t}),t}((Fk=Ic("cc.Sprite"),zk=Xc(),Uk=Rc(110),Gk=Hc(),kk=hl(XB),Hk=il(),Vk=Zc(),Wk=hl(WB),jk=il(),Xk=Zc(),qk=hl(PH),Yk=il(),Kk=Zc(),Qk=hl(RH),Zk=il(),Jk=Zc(),$k=il(),eH=Zc(),tH=Jc(),nH=il(),iH=Zc(),rH=Jc(),oH=il(),aH=Zc(),sH=Yc(),cH=il(),lH=Zc(),uH=il(),hH=Zc(),_H=hl(OH),fH=il(),dH=Zc(),Fk(pH=zk(pH=Uk(pH=Gk((IH=wH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_spriteFrame",vH,ae(t)),le(t,"_type",gH,ae(t)),le(t,"_fillType",yH,ae(t)),le(t,"_sizeMode",SH,ae(t)),le(t,"_fillCenter",xH,ae(t)),le(t,"_fillStart",EH,ae(t)),le(t,"_fillRange",TH,ae(t)),le(t,"_isTrimmedMode",CH,ae(t)),le(t,"_useGrayscale",AH,ae(t)),le(t,"_atlas",bH,ae(t)),t}ee(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial();var t=this._spriteFrame;t&&(this._updateUVs(),this._type===PH.SLICED&&t.on(WB.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===PH.SLICED&&this._spriteFrame.off(WB.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof qm){var i=e.getPixelFormat();n=i===bm.RGBA_ETC1||i===bm.RGB_A_PVRTC_4BPPV1||i===bm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=Gz.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=Gz.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=Gz.GRAYSCALE:this._instanceMaterialType=Gz.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof UE){var n=$({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new ig;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===PH.SLICED?this._spriteFrame.on(WB.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(WB.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(OH.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(OH.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(e){var t=this._spriteFrame;e&&this._type===PH.SLICED&&e.off(WB.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===PH.SLICED&&t.on(WB.EVENT_UV_UPDATED,this._updateUVs,this))},J(t,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===RH.RADIAL||this._fillType===RH.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===PH.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=_n(e,0,1),this._type===PH.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=_n(e,-1,1),this._type===PH.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===PH.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==OH.CUSTOM&&this._applySpriteSize())}}]),t}(rG),wH.FillType=RH,wH.Type=PH,wH.SizeMode=OH,wH.EventType=DH,ue((mH=IH).prototype,"spriteAtlas",[kk,Hk,Vk],Object.getOwnPropertyDescriptor(mH.prototype,"spriteAtlas"),mH.prototype),ue(mH.prototype,"spriteFrame",[Wk,jk,Xk],Object.getOwnPropertyDescriptor(mH.prototype,"spriteFrame"),mH.prototype),ue(mH.prototype,"type",[qk,Yk,Kk],Object.getOwnPropertyDescriptor(mH.prototype,"type"),mH.prototype),ue(mH.prototype,"fillType",[Qk,Zk,Jk],Object.getOwnPropertyDescriptor(mH.prototype,"fillType"),mH.prototype),ue(mH.prototype,"fillCenter",[$k,eH],Object.getOwnPropertyDescriptor(mH.prototype,"fillCenter"),mH.prototype),ue(mH.prototype,"fillStart",[tH,nH,iH],Object.getOwnPropertyDescriptor(mH.prototype,"fillStart"),mH.prototype),ue(mH.prototype,"fillRange",[rH,oH,aH],Object.getOwnPropertyDescriptor(mH.prototype,"fillRange"),mH.prototype),ue(mH.prototype,"trim",[sH,cH,lH],Object.getOwnPropertyDescriptor(mH.prototype,"trim"),mH.prototype),ue(mH.prototype,"grayscale",[qc,uH,hH],Object.getOwnPropertyDescriptor(mH.prototype,"grayscale"),mH.prototype),ue(mH.prototype,"sizeMode",[_H,fH,dH],Object.getOwnPropertyDescriptor(mH.prototype,"sizeMode"),mH.prototype),vH=ue(mH.prototype,"_spriteFrame",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gH=ue(mH.prototype,"_type",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PH.SIMPLE}}),yH=ue(mH.prototype,"_fillType",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RH.HORIZONTAL}}),SH=ue(mH.prototype,"_sizeMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OH.TRIMMED}}),xH=ue(mH.prototype,"_fillCenter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(0,0)}}),EH=ue(mH.prototype,"_fillStart",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TH=ue(mH.prototype,"_fillRange",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CH=ue(mH.prototype,"_isTrimmedMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),AH=ue(mH.prototype,"_useGrayscale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bH=ue(mH.prototype,"_atlas",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pH=mH))||pH)||pH)||pH)||pH));h.Sprite=zH;var UH,GH,kH,HH,VH,WH,jH,XH,qH,YH,KH,QH,ZH,JH,$H,eV,tV,nV,iV,rV,oV,aV,sV,cV,lV,uV,hV,_V,fV,dV,pV,mV,vV,gV,yV,SV,xV,EV,TV,CV,AV,bV,wV,IV,PV,RV,OV,DV,NV,MV,LV,BV,FV=e("RenderRoot2D",Ic("cc.RenderRoot2D")(FH=Rc(100)(FH=Hc()(FH=Pc(Sz)(FH=Oc(FH=kc(FH=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.onEnable=function(){h.director.root.batcher2D.addScreen(this)},n.onDisable=function(){h.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){h.director.root.batcher2D.removeScreen(this)},t}(th))||FH)||FH)||FH)||FH)||FH)||FH),zV=new Nn,UV=ct({OVERLAY:0,INTERSPERSE:1}),GV=function(t){return e({Canvas:t,CanvasComponent:t}),t}((UH=Ic("cc.Canvas"),GH=Xc(),kH=Rc(100),HH=Hc(),VH=hl(AB),WH=Zc(),jH=Zc(),XH=hl(AB),UH(qH=GH(qH=kH(qH=HH(qH=kc(qH=Oc((ue((YH=function(e){function t(){var t;return le(t=e.call(this)||this,"_cameraComponent",KH,ae(t)),le(t,"_alignCanvasWithScreen",QH,ae(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new Nn,t._renderMode=UV.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(ae(t)),t}ee(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(AB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(cC.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(AB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(AB.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(cC.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=_N.height/2;else{var e=uh.windowSize;this._cameraComponent.orthoHeight=e.height/yN.getScaleY()/2}this.node.getWorldPosition(zV),this._cameraComponent.node.setWorldPosition(zV.x,zV.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===UV.OVERLAY?t|1<<30:t&~(1<<30)}return 0},J(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(FV)).prototype,"cameraComponent",[VH,WH],Object.getOwnPropertyDescriptor(YH.prototype,"cameraComponent"),YH.prototype),ue(YH.prototype,"alignCanvasWithScreen",[jH],Object.getOwnPropertyDescriptor(YH.prototype,"alignCanvasWithScreen"),YH.prototype),KH=ue(YH.prototype,"_cameraComponent",[XH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QH=ue(YH.prototype,"_alignCanvasWithScreen",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qH=YH))||qH)||qH)||qH)||qH)||qH)||qH));h.Canvas=GV,H(e("UIComponent",Ic("cc.UIComponent")(ZH=Pc(Sz)(ZH=Rc(110)(ZH=Oc(ZH=kc(ZH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=rz.DISABLED,t}ee(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(th))||ZH)||ZH)||ZH)||ZH)||ZH).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),H(rG.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor"},{name:"dstBlendFactor"}]),k(GV.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:On.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),V(Sz.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),h.UITransformComponent=Sz,ot.setClassAlias(Sz,"cc.UITransformComponent"),ot.setClassAlias(rG,"cc.RenderComponent"),h.CanvasComponent=GV,ot.setClassAlias(GV,"cc.CanvasComponent");var kV=new LH,HV="RICHTEXT_CHILD",VV="RICHTEXT_Image_CHILD",WV=new it((function(e){if(!h.isValid(e.node))return!1;var t=e.node.getComponent(BH);return t&&(t.width=0),!0}),20),jV=new it((function(e){return h.isValid(e.node)}),10);function XV(e){return{node:new ub(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function qV(e,t){var n;e===HV?n=WV._get():e===VV&&(n=jV._get());var i=(n=n||XV(e)).node;return i||(i=new ub(e)),i.hideFlags|=yl.Flags.DontSave|yl.Flags.HideInHierarchy,e===VV?(n.comp=i.getComponent(zH)||i.addComponent(zH),n.comp.spriteFrame=t,n.comp.type=zH.Type.SLICED,n.comp.sizeMode=zH.SizeMode.CUSTOM):(n.comp=i.getComponent(cG)||i.addComponent(cG),n.comp.string=t,n.comp.horizontalAlign=eG.LEFT,n.comp.verticalAlign=tG.TOP,n.comp.underlineHeight=2),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var YV,KV=function(t){return e({RichText:t,RichTextComponent:t}),t}((JH=Ic("cc.RichText"),$H=Xc(),eV=Rc(110),tV=Hc(),nV=Zc(),iV=hl(eG),rV=Zc(),oV=hl(tG),aV=Zc(),sV=Zc(),cV=Zc(),lV=hl(ZB),uV=Zc(),hV=Zc(),_V=il(),fV=hl(iG),dV=Zc(),pV=Zc(),mV=Zc(),vV=hl(XB),gV=Zc(),yV=Zc(),JH(SV=$H(SV=eV(SV=tV(SV=kc((BV=LV=function(e){function t(){var t;return le(t=e.call(this)||this,"_lineHeight",EV,ae(t)),le(t,"_string",TV,ae(t)),le(t,"_horizontalAlign",CV,ae(t)),le(t,"_verticalAlign",AV,ae(t)),le(t,"_fontSize",bV,ae(t)),le(t,"_maxWidth",wV,ae(t)),le(t,"_fontFamily",IV,ae(t)),le(t,"_font",PV,ae(t)),le(t,"_isSystemFontUsed",RV,ae(t)),le(t,"_userDefinedFont",OV,ae(t)),le(t,"_cacheMode",DV,ae(t)),le(t,"_imageAtlas",NV,ae(t)),le(t,"_handleTouchEvent",MV,ae(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._labelChildrenNum=0,t._updateRichTextStatus=t._updateRichText,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(cC.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(cC.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=ce(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===HV?WV.put(n):n.type===VV&&jV.put(n)}this.node.off(cC.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(cC.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(cC.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(cC.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return qV(HV,e)},n._createImage=function(e){return qV(VV,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n.SplitLongStringApproximatelyIn2048=function(e,t){var n=[];if(this._calculateSize(t,e).x<2048)n.push(e);else for(var i=e.split("\n"),r=0;r<i.length;r++)if(this._calculateSize(t,i[r]).x<2048)n.push(i[r]);else{var o=this.splitLongStringOver2048(i[r],t);n.push.apply(n,o)}return n},n.splitLongStringOver2048=function(e,t){for(var n=[],i=e,r=0,o=i.length/2,a=i.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a),l=(this._calculateSize(t,s),1*this.maxWidth);c.x>l;){if((o/=2)<1){o*=2;break}a=a.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a)}for(var u=1e3,h=1;u&&r<e.length;){for(;u&&c.x<l;){var _=wF(s);_&&_.length>0&&(h=_[0].length),o+=h,a=i.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a),u--}for(;u&&a.length>=2&&c.x>l;)o-=h,a=i.substring(r,o),c=this._calculateSize(t,a),h=1,u--;if(a.length>=2){var f=IF(a);f&&f.length>0&&a!==f[0]&&(o-=f[0].length,a=i.substring(r,o))}if(n.push(a),r=o,o+=a.length,a=i.substring(r,o),s=i.substring(o),u--,this._calculateSize(t,s).x<2048){r=e.length,o=e.length,a=s,n.push(a);break}c=this._calculateSize(t,a)}return n},n._measureText=function(e,t){var n=this,i=function(t){return n._calculateSize(e,t).width};return t?i(t):i},n._calculateSize=function(e,t){var n;return 0===this._labelSegmentsCache.length?(n=this._createFontLabel(t),this._labelSegmentsCache.push(n)):(n=this._labelSegmentsCache[0]).node.getComponent(cG).string=t,n.styleIndex=e,this._applyTextAttribute(n),n.node._uiProps.uiTransformComp.contentSize},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(th),r=function(){var r=t.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[o];t.enabledInHierarchy&&n&&n.call(t,e,a)})),e.propagationStopped=!0)},o=ce(this._segments);!(t=o()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(Sz);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===HV||n.name===VV){n.parent===this.node?n.parent=null:e.splice(t,1);var i=XV(n.name);i.node=n,n.name===HV?(i.comp=n.getComponent(cG),WV.put(i)):(i.comp=n.getComponent(zH),jV.put(i)),this._labelChildrenNum--}}this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==HV&&n.name!==VV||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(cG);i&&(i.string=e)}var r=n.comp;return r.verticalAlign!==this._verticalAlign&&(r.verticalAlign=this._verticalAlign),n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.insertChild(n.node,this._labelChildrenNum++),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(e,r,e.length),a=e.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=PF(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.insertChild(r.node,this._labelChildrenNum++),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else D(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=kV.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=(o=this.SplitLongStringApproximatelyIn2048(o,i).join("\n")).split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+fF)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(TF(i)||CF(i))return 1;for(var r=1,o=t+1;o<n&&!CF(i=e.charAt(o))&&!TF(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case eG.LEFT:break;case eG.CENTER:l-=this._linesWidth[c-1]/2;break;case eG.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(zH)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+fF);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var d=s.imageOffset.split(",");if(1===d.length&&d[0]){var p=parseFloat(d[0]);Number.isInteger(p)&&(h.y+=p)}else if(2===d.length){var m=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(BH);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return On[t]?On[t]:(new On).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(cG);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(BH);r||(r=e.node.addComponent(BH)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var o=n.event;o&&(e.clickHandler=o.click||"",e.clickParam=o.param||"")}t.cacheMode=this._cacheMode,this._font instanceof ZB&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var a=t._assembler;a&&a.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=ce(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=On.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},J(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(th),LV.HorizontalAlign=eG,LV.VerticalAlign=tG,ue((xV=BV).prototype,"string",[ol,nV],Object.getOwnPropertyDescriptor(xV.prototype,"string"),xV.prototype),ue(xV.prototype,"horizontalAlign",[iV,rV],Object.getOwnPropertyDescriptor(xV.prototype,"horizontalAlign"),xV.prototype),ue(xV.prototype,"verticalAlign",[oV,aV],Object.getOwnPropertyDescriptor(xV.prototype,"verticalAlign"),xV.prototype),ue(xV.prototype,"fontSize",[sV],Object.getOwnPropertyDescriptor(xV.prototype,"fontSize"),xV.prototype),ue(xV.prototype,"fontFamily",[cV],Object.getOwnPropertyDescriptor(xV.prototype,"fontFamily"),xV.prototype),ue(xV.prototype,"font",[lV,uV],Object.getOwnPropertyDescriptor(xV.prototype,"font"),xV.prototype),ue(xV.prototype,"useSystemFont",[hV,_V],Object.getOwnPropertyDescriptor(xV.prototype,"useSystemFont"),xV.prototype),ue(xV.prototype,"cacheMode",[fV,dV],Object.getOwnPropertyDescriptor(xV.prototype,"cacheMode"),xV.prototype),ue(xV.prototype,"maxWidth",[pV],Object.getOwnPropertyDescriptor(xV.prototype,"maxWidth"),xV.prototype),ue(xV.prototype,"lineHeight",[mV],Object.getOwnPropertyDescriptor(xV.prototype,"lineHeight"),xV.prototype),ue(xV.prototype,"imageAtlas",[vV,gV],Object.getOwnPropertyDescriptor(xV.prototype,"imageAtlas"),xV.prototype),ue(xV.prototype,"handleTouchEvent",[yV],Object.getOwnPropertyDescriptor(xV.prototype,"handleTouchEvent"),xV.prototype),EV=ue(xV.prototype,"_lineHeight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),TV=ue(xV.prototype,"_string",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),CV=ue(xV.prototype,"_horizontalAlign",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eG.LEFT}}),AV=ue(xV.prototype,"_verticalAlign",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tG.TOP}}),bV=ue(xV.prototype,"_fontSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),wV=ue(xV.prototype,"_maxWidth",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IV=ue(xV.prototype,"_fontFamily",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),PV=ue(xV.prototype,"_font",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RV=ue(xV.prototype,"_isSystemFontUsed",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),OV=ue(xV.prototype,"_userDefinedFont",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DV=ue(xV.prototype,"_cacheMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iG.NONE}}),NV=ue(xV.prototype,"_imageAtlas",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MV=ue(xV.prototype,"_handleTouchEvent",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SV=xV))||SV)||SV)||SV)||SV)||SV));h.RichText=KV;var QV=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(Ic("cc.UIMeshRenderer")(YV=Xc()(YV=Rc(110)(YV=Hc()(YV=kc(YV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._modelComponent=null,t.stencilStage=rz.DISABLED,t}ee(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent||console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null)},n.updateAssembler=function(e){if(this._modelComponent){var t=this._modelComponent._collectModels();this._modelComponent._detachFromScene();for(var n=0;n<t.length;n++)t[n].enabled&&e.commitModel(this,t[n],this._modelComponent.material);return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=Od.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},J(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(th))||YV)||YV)||YV)||YV)||YV);h.UIMeshRenderer=QV;var ZV,JV,$V,eW,tW,nW,iW,rW,oW,aW,sW,cW,lW,uW,hW,_W,fW,dW,pW,mW,vW,gW,yW,SW,xW,EW,TW,CW,AW,bW=Pd.Enum.NONE|Pd.Enum.UI_3D,wW=e("UIDrawBatch",function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=bW,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=bW,this.renderScene=null},t.fillPasses=function(e,t,n,i,r,o){if(e){var a=e.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var c=0;c<a.length;c++){this._passes[c]||(this._passes[c]=new Mv(h.director.root));var l=a[c],u=this._passes[c];l.update(),t||(t=l.depthStencilState,n=0),i||(i=l.blendState,r=0),-1===r&&(r=0),s=n<<16|r,u._initPassFromTarget(l,t,i,s),this._shaders[c]=u.getShaderVariant(o)}}},J(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}()),IW=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((ZV=Ic("cc.UIStaticBatch"),JV=Xc(),$V=Hc(),eW=Rc(110),tW=Yc(),ZV(nW=JV(nW=$V(nW=eW((ue((iW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._bufferAccessor=null,t._dirty=!0,t._uiDrawBatchList=[],t}ee(t,e);var n=t.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var e=new wW;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return lN.root&&lN.root.batcher2D?lN.root.batcher2D:(D(9301),null)},J(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(rG)).prototype,"color",[fl,tW],Object.getOwnPropertyDescriptor(iW.prototype,"color"),iW.prototype),nW=iW))||nW)||nW)||nW)||nW)),PW=e("LabelShadow",(rW=Ic("cc.LabelShadow"),oW=Xc(),aW=Rc(110),sW=Hc(),cW=Pc(cG),lW=Zc(),uW=Zc(),hW=Zc(),rW(_W=oW(_W=aW(_W=sW(_W=cW(_W=kc((vW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_color",dW,ae(t)),le(t,"_offset",pW,ae(t)),le(t,"_blur",mW,ae(t)),t}ee(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(cG);e&&e.updateRenderData(!0)},J(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(th),dW=ue((fW=vW).prototype,"_color",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(0,0,0,255)}}),pW=ue(fW.prototype,"_offset",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(2,2)}}),mW=ue(fW.prototype,"_blur",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),ue(fW.prototype,"color",[lW],Object.getOwnPropertyDescriptor(fW.prototype,"color"),fW.prototype),ue(fW.prototype,"offset",[uW],Object.getOwnPropertyDescriptor(fW.prototype,"offset"),fW.prototype),ue(fW.prototype,"blur",[hW],Object.getOwnPropertyDescriptor(fW.prototype,"blur"),fW.prototype),_W=fW))||_W)||_W)||_W)||_W)||_W)||_W)),RW=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}((gW=Ic("cc.UIOpacity"),yW=Xc(),SW=Rc(110),xW=Hc(),EW=Zc(),gW(TW=yW(TW=SW(TW=xW(TW=kc(TW=Oc((ue((CW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_opacity",AW,ae(t)),t}ee(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},J(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=At(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(th)).prototype,"opacity",[qc,EW],Object.getOwnPropertyDescriptor(CW.prototype,"opacity"),CW.prototype),AW=ue(CW.prototype,"_opacity",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),TW=CW))||TW)||TW)||TW)||TW)||TW)||TW));h.MaskComponent=Ck,ot.setClassAlias(Ck,"cc.MaskComponent"),h.LabelComponent=cG,ot.setClassAlias(cG,"cc.LabelComponent"),h.LabelOutlineComponent=BH,ot.setClassAlias(BH,"cc.LabelOutlineComponent"),h.RichTextComponent=KV,ot.setClassAlias(KV,"cc.RichTextComponent"),h.SpriteComponent=zH,ot.setClassAlias(zH,"cc.SpriteComponent"),h.UIModelComponent=QV,ot.setClassAlias(QV,"cc.UIModelComponent"),h.GraphicsComponent=gk,ot.setClassAlias(gk,"cc.GraphicsComponent"),ot.setClassAlias(IW,"cc.UIStaticBatchComponent"),ot.setClassAlias(RW,"cc.UIOpacityComponent");var OW=function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n};function DW(e,t,n,i,r){var o=0,a=null;if(r===function(e,t,n,i){for(var r=0,o=t,a=n-i;o<n;o+=i)r+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return r}(e,t,n,i)>0)for(o=t;o<n;o+=i)a=QW(o,e[o],e[o+1],a);else for(o=n-i;o>=t;o-=i)a=QW(o,e[o],e[o+1],a);return a&&XW(a,a.next)&&(ZW(a),a=a.next),a}function NW(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!XW(n,n.next)&&0!==jW(n.prev,n,n.next))n=n.next;else{if(ZW(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function MW(e,t,n,i,r,o,a){if(void 0===a&&(a=0),e){!a&&o&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=kW(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(e,i,r,o);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,o?BW(e,i,r,o):LW(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),ZW(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?MW(e=FW(e,t,n),t,n,i,r,o,2):2===a&&zW(e,t,n,i,r,o):MW(NW(e),t,n,i,r,o,1);break}}}function LW(e){var t=e.prev,n=e,i=e.next;if(jW(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(VW(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&jW(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function BW(e,t,n,i){var r=e.prev,o=e,a=e.next;if(jW(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=kW(s,c,t,n,i),_=kW(l,u,t,n,i),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&VW(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&jW(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&VW(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&jW(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function FW(e,t,n){var i=e;do{var r=i.prev,o=i.next.next;!XW(r,o)&&qW(r,i,i.next,o)&&YW(r,o)&&YW(o,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(o.i/n),ZW(i),ZW(i.next),i=e=o),i=i.next}while(i!==e);return i}function zW(e,t,n,i,r,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&WW(a,s)){var c=KW(a,s);return a=NW(a,a.next),c=NW(c,c.next),MW(a,t,n,i,r,o),void MW(c,t,n,i,r,o)}s=s.next}a=a.next}while(a!==e)}function UW(e,t){return e.x-t.x}function GW(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&VW(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&YW(n,e)&&(a=n,_=c),n=n.next;return a}(e,t)){var n=KW(t,e);NW(n,n.next)}}function kW(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function HW(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function VW(e,t,n,i,r,o,a,s){return(r-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(i-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function WW(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&qW(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&YW(e,t)&&YW(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function jW(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function XW(e,t){return e.x===t.x&&e.y===t.y}function qW(e,t,n,i){return!!(XW(e,t)&&XW(n,i)||XW(e,i)&&XW(n,t))||jW(e,t,n)>0!=jW(e,t,i)>0&&jW(n,i,e)>0!=jW(n,i,t)>0}function YW(e,t){return jW(e.prev,e,e.next)<0?jW(e,t,e.next)>=0&&jW(e,e.prev,t)>=0:jW(e,t,e.prev)<0||jW(e,e.next,t)<0}function KW(e,t){var n=new OW(e.i,e.x,e.y),i=new OW(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function QW(e,t,n,i){var r=new OW(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function ZW(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function JW(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,o=DW(e,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(e,t,n,i){var r,o=[],a=0,s=null;for(a=0,r=t.length;a<r;a++)(s=DW(e,t[a]*i,a<r-1?t[a+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(HW(s)));if(o.sort(UW),!n)return n;for(a=0;a<o.length;a++)GW(o[a],n),n=NW(n,n.next);return n}(e,t,o,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var d=n;d<r;d+=n)(h=e[d])<s&&(s=h),(_=e[d+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return MW(o,a,n,s,c,f),a}for(var $W=Math.PI,ej=Math.min,tj=Math.max,nj=Math.ceil,ij=Math.acos,rj=Math.cos,oj=Math.sin,aj=Math.atan2,sj=null,cj=null,lj=new On,uj=[],hj=0;hj<4;hj++)uj.push(new Nn);function _j(e,t,n){return e<t?t:e>n?n:e}var fj={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!cj)return null;var n=cj.getRenderDataList(),i=n[cj.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+t:0;return(o>65535||3*o>131070)&&(++cj.dataOffset,cj.dataOffset<n.length?i=n[cj.dataOffset]:(i=cj.requestRenderData(),n[cj.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(t,3*t),i},stroke:function(e){On.copy(lj,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){On.copy(lj,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t=.5*e.lineWidth,n=e.lineCap,i=e.lineJoin,r=e.miterLimit;if(cj=e.impl){var o=function(e,t,n){var i=2*ij(e/(e+n));return tj(2,nj(t/i))}(t,$W,cj.tessTol);this._calculateJoins(cj,t,i,r);for(var a=cj.paths,s=0,c=cj.pathOffset,l=cj.pathLength;c<l;c++){var u=a[c],h=u.points.length;i===aG.ROUND?s+=2*(h+u.bevel*(o+2)+1):s+=2*(h+5*u.bevel+1),u.closed||(n===oG.ROUND?s+=2*(2*o+2):s+=12)}var _=sj=this.getRenderData(e,s);if(_){for(var f=_.vData,d=_.iData,p=cj.pathOffset,m=cj.pathLength;p<m;p++){var v=a[p],g=v.points,y=g.length,S=_.vertexStart,x=void 0,E=void 0,T=0,C=0,A=v.closed;if(A?(x=g[y-1],E=g[0],T=0,C=y):(x=g[0],E=g[1],T=1,C=y-1),E=E||x,!A){var b=new _k(E.x,E.y);b.subtract(x),b.normalize();var w=b.x,I=b.y;n===oG.BUTT?this._buttCapStart(x,w,I,t,0):n===oG.SQUARE?this._buttCapStart(x,w,I,t,t):n===oG.ROUND&&this._roundCapStart(x,w,I,t,o)}for(var P=T;P<C;++P)i===aG.ROUND?this._roundJoin(x,E,t,t,o):0!=(E.flags&(sG.PT_BEVEL|sG.PT_INNERBEVEL))?this._bevelJoin(x,E,t,t):(this._vSet(E.x+E.dmx*t,E.y+E.dmy*t,1),this._vSet(E.x-E.dmx*t,E.y-E.dmy*t,-1)),x=E,E=g[P+1];if(A){var R=8*S;this._vSet(f[R],f[R+1],1),this._vSet(f[R+8],f[R+8+1],-1)}else{var O=new _k(E.x,E.y);O.subtract(x),O.normalize();var D=O.x,N=O.y;n===oG.BUTT?this._buttCapEnd(E,D,N,t,0):n===oG.SQUARE?this._buttCapEnd(E,D,N,t,t):n===oG.ROUND&&this._roundCapEnd(E,D,N,t,o)}for(var M=_.indexStart,L=S+2,B=_.vertexStart;L<B;L++)d[M++]=L-2,d[M++]=L-1,d[M++]=L;_.indexStart=M}sj=null,cj=null}}},_expandFill:function(e){if(cj=e.impl){for(var t=cj.paths,n=0,i=cj.pathOffset,r=cj.pathLength;i<r;i++)n+=t[i].points.length;var o=sj=this.getRenderData(e,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=cj.pathOffset,u=cj.pathLength;l<u;l++){var h=t[l],_=h.points,f=_.length;if(0!==f){for(var d=o.vertexStart,p=0;p<f;++p)this._vSet(_[p].x,_[p].y);var m=o.indexStart;if(h.complex){for(var v=[],g=d,y=o.vertexStart;g<y;g++){var S=8*g;v.push(s[S++]),v.push(s[S++]),v.push(s[S++])}var x=JW(v,null,3);if(!x||0===x.length)continue;for(var E=0,T=x.length;E<T;E++)c[m++]=x[E]+d}else for(var C=d,A=d+2,b=a.vertexStart;A<b;A++)c[m++]=C,c[m++]=A-1,c[m++]=A;a.indexStart=m}}sj=null,cj=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var d,p,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(d=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var S=1/d;S>600&&(S=600),_.dmx*=S,_.dmy*=S}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=sG.PT_LEFT),d*(p=tj(11,ej(h.len,_.len)*r))*p<1&&(_.flags|=sG.PT_INNERBEVEL),_.flags&sG.PT_CORNER&&(d*i*i<1||n===aG.BEVEL||n===aG.ROUND)&&(_.flags|=sG.PT_BEVEL),0!=(_.flags&(sG.PT_BEVEL|sG.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new _k(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*i,s=o-t.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(e,t,n,i,r){var o=e.x-t*r,a=e.y-n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var o=e.x+t*r,a=e.y+n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var o=e.x,a=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*$W,h=rj(u)*i,_=oj(u)*i;this._vSet(o-s*h-t*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var o=e.x,a=e.y,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*$W,h=rj(u)*i,_=oj(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+t*_,a-c*h+n*_,1)}},_roundJoin:function(e,t,n,i,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&sG.PT_LEFT)){var h=this._chooseBevel(t.flags&sG.PT_INNERBEVEL,e,t,n),_=h[0],f=h[1],d=h[2],p=h[3],m=aj(-a,-o),v=aj(-c,-s);v>m&&(v-=2*$W),this._vSet(_,f,1),this._vSet(l-o*i,t.y-a*i,-1);for(var g=_j(nj((m-v)/$W)*r,2,r),y=0;y<g;y++){var S=m+y/(g-1)*(v-m),x=l+rj(S)*i,E=u+oj(S)*i;this._vSet(l,u,0),this._vSet(x,E,-1)}this._vSet(d,p,1),this._vSet(l-s*i,u-c*i,-1)}else{var T=this._chooseBevel(t.flags&sG.PT_INNERBEVEL,e,t,-i),C=T[0],A=T[1],b=T[2],w=T[3],I=aj(a,o),P=aj(c,s);P<I&&(P+=2*$W),this._vSet(l+o*i,u+a*i,1),this._vSet(C,A,-1);for(var R=_j(nj((P-I)/$W)*r,2,r),O=0;O<R;O++){var D=I+O/(R-1)*(P-I),N=l+rj(D)*n,M=u+oj(D)*n;this._vSet(N,M,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(b,w,-1)}},_bevelJoin:function(e,t,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=e.dy,f=-e.dx,d=t.dy,p=-t.dx;if(t.flags&sG.PT_LEFT){var m=this._chooseBevel(t.flags&sG.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-_*i,t.y-f*i,-1),this._vSet(u,h,1),this._vSet(t.x-d*i,t.y-p*i,-1)}else{var v=this._chooseBevel(t.flags&sG.PT_INNERBEVEL,e,t,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(t.x+_*n,t.y+f*n,1),this._vSet(r,o,-1),this._vSet(t.x+d*n,t.y+p*n,1),this._vSet(a,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),sj){var i=sj,r=8*i.vertexStart,o=i.vData;o[r++]=e,o[r++]=t,o[r++]=0,On.toArray(o,lj,r),r+=4,o[r++]=n,i.vertexStart++}}},dj=e("graphicsAssembler",{getAssembler:function(){return fj}});gk.Assembler=dj;var pj=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},mj=new si,vj=null,gj=null,yj=[],Sj=[],xj=[],Ej=[],Tj=new oi,Cj=new oi,Aj=new Jn,bj=null,wj=0,Ij=0,Pj=0,Rj=0,Oj=0,Dj=1,Nj=null,Mj="",Lj=0,Bj=0,Fj=0,zj=0,Uj=0,Gj=0,kj=0,Hj=!1,Vj=0,Wj=0,jj=0,Xj={updateRenderData:function(e){e.renderData&&vj!==e&&(e.renderData.vertDirty&&(gj=(vj=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),vj.actualFontSize=Lj,gj.setContentSize(Cj),this.updateUVs(e),vj.renderData.vertDirty=!1,vj.markForUpdateRenderData(!1),vj=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.vertexCount,r=t.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){Dj=Lj/Bj},_updateFontFamily:function(e){var t=e.font;Nj=t.spriteFrame,bj=t.fntConfig,FF.fontAtlas=t.fontDefDictionary,zB.packToDynamicAtlas(e,Nj)},_updateLabelInfo:function(){FF.hash="",FF.margin=0},_updateProperties:function(e){Mj=e.string.toString(),Lj=e.fontSize,Bj=bj?bj.fontSize:e.fontSize,Fj=e.horizontalAlign,zj=e.verticalAlign,Uj=e.spacingX,kj=e.overflow,Gj=e._lineHeight;var t=gj.contentSize;Cj.width=t.width,Cj.height=t.height,kj===nG.NONE?(Hj=!1,Cj.width+=2*FF.margin,Cj.height+=2*FF.margin):kj===nG.RESIZE_HEIGHT?(Hj=!0,Cj.height+=2*FF.margin):Hj=e.enableWrapText,FF.lineHeight=Gj,FF.fontSize=Lj,this._setupBMFontOverflowMetrics()},_resetProperties:function(){bj=null,Nj=null,FF.hash="",FF.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=Mj,t=e.length,n=bj.kerningDict,i=yj,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t=Mj.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<t;){var h=Mj.charAt(u);if("\n"!==h){for(var _=e(Mj,u,t),f=s,d=c,p=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=Mj.charAt(y)))if(l=FF.fontAtlas.getLetterDefinitionForChar(h,FF)){var S=m+l.offsetX*Dj-FF.margin;if(Hj&&jj>0&&i>0&&S+l.w*Dj>jj&&!CF(h)){xj.push(a),a=0,n++,i=0,r-=Gj*this._getFontScale()+0,v=!0;break}Aj.x=S,Aj.y=r-l.offsetY*Dj,this._recordLetterInfo(Aj,h,y,n),y+1<yj.length&&y<t-1&&(m+=yj[y+1]),m+=l.xAdvance*Dj+Uj,p=Aj.x+l.w*Dj,f<Aj.y&&(f=Aj.y),d>Aj.y-l.h*Dj&&(d=Aj.y-l.h*Dj)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+bj.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>d&&(c=d),o<(a=p)&&(o=a),u+=_)}else xj.push(a),a=0,n++,i=0,r-=Gj*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return xj.push(a),Ij=(wj=n+1)*Gj*this._getFontScale(),wj>1&&(Ij+=0*(wj-1)),Cj.width=Vj,Cj.height=Wj,Vj<=0&&(Cj.width=parseFloat(o.toFixed(2))+2*FF.margin),Wj<=0&&(Cj.height=parseFloat(Ij.toFixed(2))+2*FF.margin),Rj=Cj.height,Oj=0,s>0&&(Rj=Cj.height+s),c<-Ij&&(Oj=Ij+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return kj===nG.SHRINK?Dj:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(TF(i)||"\n"===i||CF(i))return 1;var r=1,o=FF.fontAtlas.getLetterDefinitionForChar(i,FF);if(!o)return r;for(var a=o.xAdvance*Dj+Uj,s=t+1;s<n&&(i=e.charAt(s),o=FF.fontAtlas.getLetterDefinitionForChar(i,FF));++s){if(a+o.offsetX*Dj+o.w*Dj>jj&&!CF(i)&&jj>0)return r;if(a+=o.xAdvance*Dj+Uj,"\n"===i||CF(i)||TF(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=Sj.length){var n=new pj;Sj.push(n)}Sj[e].char=t,Sj[e].hash=""+t.charCodeAt(0)+FF.hash,Sj[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=Sj.length){var r=new pj;Sj.push(r)}var o=""+t.charCodeAt(0)+FF.hash;Sj[n].line=i,Sj[n].char=t,Sj[n].hash=o,Sj[n].valid=FF.fontAtlas.getLetter(o).valid,Sj[n].x=e.x,Sj[n].y=e.y},_alignText:function(){Ij=0,xj.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),kj===nG.SHRINK&&Lj>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||kj===nG.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),Lj=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|Lj,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;Dj=r/Bj,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return Ij>Cj.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=Mj.length;t<n;++t){var i=Sj[t];if(i.valid){var r=FF.fontAtlas.getLetterDefinitionForChar(i.char,FF);if(!r)continue;var o=i.x+r.w*Dj,a=i.line;if(Vj>0)if(Hj){if(xj[a]>Cj.width&&(o>Cj.width||o<0)){e=!0;break}}else if(o>Cj.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=xj[t],i=e>Cj.width||e<0;return Hj?n>Cj.width&&i:i},_updateQuads:function(){if(!vj)return!1;var e=Nj?Nj.texture:FF.fontAtlas.getTexture(),t=vj.renderData;t.dataLength=0,t.resize(0,0);for(var n=gj.anchorPoint,i=Cj,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=Mj.length;s<c;++s){var l=Sj[s];if(l.valid){var u=FF.fontAtlas.getLetter(l.hash);if(u){mj.height=u.h,mj.width=u.w,mj.x=u.u,mj.y=u.v;var h=l.y+Pj;if(Wj>0){if(h>Rj){var _=h-Rj;mj.y+=_,mj.height-=_,h-=_}h-u.h*Dj<Oj&&kj===nG.CLAMP&&(mj.height=h<Oj?0:(h-Oj)/Dj)}var f=l.line,d=l.x+u.w/2*Dj+Ej[f];if(Vj>0&&this._isHorizontalClamped(d,f))if(kj===nG.CLAMP)mj.width=0;else if(kj===nG.SHRINK){if(Cj.width>u.w){a=!1;break}mj.width=0}if(mj.height>0&&mj.width>0){var p=this._determineRect(),m=l.x+Ej[l.line];this.appendQuad(vj,e,mj,p,m-r,h-o,Dj)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var e=Nj.isRotated(),t=Nj.getOriginalSize(),n=Nj.getRect(),i=Nj.getOffset(),r=i.x+(t.width-n.width)/2,o=i.y-(t.height-n.height)/2;if(e){var a=mj.x;mj.x=n.x+n.height-mj.y-mj.height-o,mj.y=a+n.y-r,mj.y<0&&(mj.height+=o)}else mj.x+=n.x-r,mj.y+=n.y+o;return e},_computeAlignmentOffset:function(){switch(Ej.length=0,Fj){case eG.LEFT:for(var e=0;e<wj;++e)Ej.push(0);break;case eG.CENTER:for(var t=0,n=xj.length;t<n;t++)Ej.push((Cj.width-xj[t])/2);break;case eG.RIGHT:for(var i=0,r=xj.length;i<r;i++)Ej.push(Cj.width-xj[i])}if(Pj=Cj.height,zj!==tG.TOP){var o=Cj.height-Ij+Gj*this._getFontScale()-Bj*Dj;zj===tG.BOTTOM?Pj-=o:Pj-=o/2}},_setupBMFontOverflowMetrics:function(){var e=Cj.width,t=Cj.height;kj===nG.RESIZE_HEIGHT&&(t=0),kj===nG.NONE&&(e=0,t=0),Vj=e,Wj=t,Tj.width=e,Tj.height=t,jj=e}},qj=new On(255,255,255,255),Yj={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;qj.set(e.color),qj.a=255*t._uiProps.opacity,RB(t,0,e.renderData,qj)},appendQuad:function(e,t,n,i,r,o,a){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=t.width,h=t.height,_=n.width,f=n.height,d=0,p=0,m=0,v=0;i?(d=n.x/u,v=(n.x+f)/u,p=(n.y+_)/h,m=n.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=p,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=p):(d=n.x/u,v=(n.x+_)/u,p=(n.y+f)/h,m=n.y/h,l[c].u=d,l[c].v=p,l[c+1].u=v,l[c+1].v=p,l[c+2].u=d,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}},updateColor:function(){}};Ge(Yj,Xj);var Kj=null,Qj=ke(Xj,{getAssemblerData:function(){return Kj||(Kj=new BF(1024,1024)),Kj.getTexture()},_updateFontFamily:function(e){FF.fontAtlas=Kj,FF.fontFamily=this._getFontFamily(e);var t=e.getComponent(BH);t&&t.enabled?(FF.isOutlined=!0,FF.margin=t.width,FF.out=t.color.clone(),FF.out.a=t.color.a*e.color.a/255):(FF.isOutlined=!1,FF.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){FF.fontDesc=this._getFontDesc(),FF.color=e.color,FF.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(FF)},_getFontDesc:function(){return FF.fontSize.toString()+"px "+FF.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),Zj=new On(255,255,255,255),Jj={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){if(e.renderData){var t=e.node;Zj.a=255*t._uiProps.opacity,RB(t,0,e.renderData,Zj)}},updateColor:function(){},appendQuad:Yj.appendQuad};Ge(Jj,Qj);var $j=cG.Overflow,eX=(1/255).toFixed(3),tX=null,nX=null,iX=null,rX="",oX="",aX=0,sX=0,cX=[],lX=new oi,uX=0,hX=0,_X=0,fX=new On,dX="",pX=$j.NONE,mX=!1,vX=null,gX=On.BLACK.clone(),yX=null,SX=On.BLACK.clone(),xX=new si,EX=oi.ZERO.clone(),TX=oi.ZERO.clone(),CX=Jn.ZERO.clone(),AX=Jn.ZERO.clone(),bX=0,wX=0,IX=!1,PX=!1,RX=!1,OX=["left","center","right"],DX={getAssemblerData:function(){return cG._canvasPool.get()},resetAssemblerData:function(e){e&&cG._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=aX,t.setContentSize(lX),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),tX=null,nX=null,iX=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){dX=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(tX=n.context,nX=n.canvas,iX=e.spriteFrame,oX=e.string.toString(),aX=e.fontSize,sX=aX,pX=e.overflow,TX.width=lX.width=t.width,TX.height=lX.height=t.height,wX=e.underlineHeight,uX=e.lineHeight,hX=e.horizontalAlign,_X=e.verticalAlign,fX=e.color,e.node._uiProps.opacity,IX=e.isBold,PX=e.isItalic,RX=e.isUnderline,mX=pX!==$j.NONE&&(pX===$j.RESIZE_HEIGHT||e.enableWrapText),(vX=(vX=BH&&e.getComponent(BH))&&vX.enabled&&vX.width>0?vX:null)&&gX.set(vX.color),(yX=(yX=PW&&e.getComponent(PW))&&yX.enabled?yX:null)&&SX.set(yX.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(EX.width=EX.height=0,vX&&(e=t=n=i=r=vX.width,EX.width=EX.height=2*r),yX){var o=yX.blur+r,a=yX.offset.x,s=yX.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),e=Math.max(e,s+o),t=Math.max(t,-s+o)}if(PX){var c=sX*Math.tan(.20943951);i+=c,EX.width+=c}xX.x=n,xX.y=e,xX.width=n+i,xX.height=e+t},_calculateFillTextStartPosition:function(){var e=0;hX===eG.RIGHT?e=lX.width-xX.width:hX===eG.CENTER&&(e=(lX.width-xX.width)/2);var t=this._getLineHeight()*(cX.length-1),n=aX*(1-fF/2);if(_X!==tG.TOP){var i=t+xX.height+aX-lX.height;_X===tG.BOTTOM?n-=i+=fF/2*aX:n-=i/2}n+=0*aX,CX.set(e+xX.x,n+xX.y)},_updateTexture:function(e){if(tX&&nX){tX.clearRect(0,0,nX.width,nX.height),tX.font=rX,this._calculateFillTextStartPosition();var t=this._getLineHeight();tX.lineJoin="round",vX?(tX.fillStyle="rgba("+gX.r+", "+gX.g+", "+gX.b+", "+eX+")",tX.fillRect(0,0,nX.width,nX.height)):e._srcBlendFactor===Mi.SRC_ALPHA&&(tX.fillStyle="rgba("+fX.r+", "+fX.g+", "+fX.b+", "+eX+")",tX.fillRect(0,0,nX.width,nX.height)),tX.fillStyle="rgb("+fX.r+", "+fX.g+", "+fX.b+")";var n=CX.x,i=0;this._drawTextEffect(CX,t);for(var r=0;r<cX.length;++r)i=CX.y+r*t,vX&&tX.strokeText(cX[r],n,i),tX.fillText(cX[r],n,i);yX&&(tX.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===cG.CacheMode.BITMAP){var t=e.ttfSpriteFrame;zB.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;iX&&nX&&(n=iX instanceof WB?iX.texture:iX,0!==nX.width&&0!==nX.height&&(n.reset({width:nX.width,height:nX.height,mipmapLevel:1}),n.uploadData(nX),n.setWrapMode(wm.CLAMP_TO_EDGE,wm.CLAMP_TO_EDGE),iX instanceof WB&&(iX.rect=new si(0,0,nX.width,nX.height),iX._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),h.director.root&&h.director.root.batcher2D&&h.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==cG.CacheMode.BITMAP||!nX||nX.width<=0||nX.height<=0)){var t=e.ttfSpriteFrame;zB.packToDynamicAtlas(e,t)}},_setupOutline:function(){tX.strokeStyle="rgba("+gX.r+", "+gX.g+", "+gX.b+", "+gX.a/255+")",tX.lineWidth=2*vX.width},_setupShadow:function(){tX.shadowColor="rgba("+SX.r+", "+SX.g+", "+SX.b+", "+SX.a/255+")",tX.shadowBlur=yX.blur,tX.shadowOffsetX=yX.offset.x,tX.shadowOffsetY=-yX.offset.y},_drawTextEffect:function(e,t){if(yX||vX||RX){var n=cX.length>1&&yX,i=this._measureText(tX,rX),r=0,o=0;yX&&this._setupShadow(),vX&&this._setupOutline();for(var a=0;a<cX.length;++a)r=e.x,o=e.y+a*t,n&&(vX&&tX.strokeText(cX[a],r,o),tX.fillText(cX[a],r,o)),RX&&(bX=i(cX[a]),hX===eG.RIGHT?AX.x=e.x-bX:hX===eG.CENTER?AX.x=e.x-bX/2:AX.x=e.x,AX.y=o+sX/8,tX.fillRect(AX.x,AX.y,bX,wX));n&&(tX.shadowColor="transparent")}},_updateLabelDimensions:function(){lX.width=Math.min(lX.width,2048),lX.height=Math.min(lX.height,2048);var e=!1;nX.width!==lX.width&&(nX.width=lX.width,e=!0),nX.height!==lX.height&&(nX.height=lX.height,e=!0),e&&(tX.font=rX),tX.textAlign=OX[hX],tX.textBaseline="alphabetic"},_getFontDesc:function(){var e=aX.toString()+"px ";return e+=dX,IX&&(e="bold "+e),PX&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===uX?aX:uX*aX/sX)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=ce(e);!(n=r()).done;){var o=AF(t,n.value,rX);i.push(o)}return i},_measureText:function(e,t){return function(n){return AF(e,n,t)}},_calculateShrinkFont:function(e){if(tX){var t=this._calculateParagraphLength(e,tX),n=0,i=0,r=0;if(mX){var o=TX.width,a=TX.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|aX+1,l=0;s<c;){if((l=s+c+1>>1)<=0){R(4003);break}aX=l,rX=this._getFontDesc(),tX.font=rX;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=AF(tX,e[n],rX);i+=PF(e[n],h,o,this._measureText(tX,rX)).length*u}i>a?c=l-1:s=l}0===s?R(4003):(aX=s,rX=this._getFontDesc(),tX.font=rX)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var _=(lX.width-xX.width)/r,f=lX.height/i;aX=sX*Math.min(1,_,f)|0,rX=this._getFontDesc(),tX.font=rX}}},_calculateWrapText:function(e){if(mX&&tX){cX=[];for(var t=TX.width,n=0;n<e.length;++n){var i=AF(tX,e[n],rX),r=PF(e[n],i,t,this._measureText(tX,rX));cX=cX.concat(r)}}},_calculateLabelFont:function(){if(tX){var e=oX.split("\n");switch(cX=e,rX=this._getFontDesc(),tX.font=rX,pX){case $j.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=AF(tX,e[i],rX);t=t>r?t:r}n=(cX.length+fF)*this._getLineHeight();var o=parseFloat(t.toFixed(2)),a=parseFloat(n.toFixed(2));lX.width=o+xX.width,lX.height=a+xX.height,TX.width=o+EX.width,TX.height=a+EX.height;break;case $j.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case $j.CLAMP:this._calculateWrapText(e);break;case $j.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(cX.length+fF)*this._getLineHeight();lX.height=s+xX.height,TX.height=s+EX.height}}}},NX=On.WHITE.clone(),MX={createData:function(e){var t=e.requestRenderData();t.dataLength=2,t.resize(4,6);var n=t.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)On.toArray(n,NX,i),i+=9;return t},fillBuffers:function(e){var t=e.renderData.chunk,n=e.renderData.data,i=e.node,r=t.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,_=o.y*l.y,f=a.y*l.y,d=c.x,p=c.y,m=c.z,v=c.w,g=d*p,y=m*v,S=d*d-p*p,x=v*v-m*m,E=x+S,T=2*(g-y),C=x-S,A=2*(g+y),b=s.x,w=s.y;r[0]=E*u+T*_+b,r[1]=C*_+A*u+w,r[9]=E*h+T*_+b,r[10]=C*_+A*h+w,r[18]=E*u+T*f+b,r[19]=C*f+A*u+w,r[27]=E*h+T*f+b,r[28]=C*f+A*h+w;var I=t.bufferId,P=t.vertexOffset,R=t.vertexAccessor.getMeshBuffer(t.bufferId),O=t.vertexAccessor.getIndexBuffer(I),D=R.indexOffset;O[D++]=P,O[D++]=P+1,O[D++]=P+2,O[D++]=P+2,O[D++]=P+1,O[D++]=P+3,R.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var n=t.chunk.vb,i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Ge(MX,DX);var LX=e("labelAssembler",{getAssembler:function(e){var t=MX;return e.font instanceof hF?t=Yj:e.cacheMode===cG.CacheMode.CHAR&&(t=Jj),t}});cG.Assembler=LX;var BX=zH.FillType,FX=new Yn,zX=new Nn,UX={updateRenderData:function(e){var t=e.spriteFrame;zB.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.updateRenderData(e,t),!n.vertDirty)return;var i=e.fillStart,r=e.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(e,i,o),this.updateVertexData(e,i,o)}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=_=c,d=m=(s.x+s.height)/o,f=v=l,h=p=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=d=c,_=m=(s.x+s.width)/o,h=f=l,p=v=s.y/a),e.fillType){case BX.HORIZONTAL:r[3]=u+(_-u)*t,r[4]=h+(f-h)*t,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=d+(m-d)*t,r[22]=p+(v-p)*t,r[30]=d+(m-d)*n,r[31]=p+(v-p)*n;break;case BX.VERTICAL:r[3]=u+(d-u)*t,r[4]=h+(p-h)*t,r[12]=_+(m-_)*t,r[13]=f+(v-f)*t,r[21]=u+(d-u)*n,r[22]=h+(p-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:M(2626)}},updateVertexData:function(e,t,n){var i=e.renderData.data,r=e.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,_=a-c,f=0;switch(e.fillType){case BX.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*t,h=f;break;case BX.VERTICAL:f=u+(_-u)*n,u+=(_-u)*t,_=f;break;default:M(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);for(var n,i=ce(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(FX);for(var n=e.renderData.floatStride,i=e.renderData.data,r=t.vb,o=0,a=0;a<4;a++){var s=i[a];Nn.transformMat4(zX,s,FX),r[o=a*n]=zX.x,r[o+1]=zX.y,r[o+2]=zX.z}},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},GX=2*Math.PI,kX=1e-6,HX=new Yn,VX=new Nn,WX=[new Jn,new Jn,new Jn,new Jn],jX=new Array(4),XX=new Array(8),qX=[new Jn,new Jn,new Jn,new Jn],YX=[new Jn,new Jn,new Jn,new Jn],KX=new Jn,QX=[new Jn,new Jn,new Jn,new Jn];function ZX(e,t,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>kX?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>kX?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);a[0].x=e,a[0].y=h}if((t-r.x)*c>0){var _=r.y+l*(t-r.x);a[2].x=t,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var d=r.x+u*(n-r.y);a[1].x=d,a[1].y=n}}}function JX(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function $X(e,t,n,i,r){var o=jX,a=o[0],s=o[1],c=o[2],l=o[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,eq((n.x-a)/(c-a),(n.y-s)/(l-s),e,t),eq((i.x-a)/(c-a),(i.y-s)/(l-s),e,t+1),eq((r.x-a)/(c-a),(r.y-s)/(l-s),e,t+2)}function eq(e,t,n,i){var r=XX,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=o+(a-o)*t,l.v=s+(c-s)*t}for(var tq={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;zB.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;if(n&&t){if(!n.vertDirty)return;var i=n.data,r=e.fillStart,o=e.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=GX)+(o*=GX);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,o=t.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=jX;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,_=KX.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=KX.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;WX[0].x=WX[3].x=a,WX[1].x=WX[2].x=c,WX[0].y=WX[1].y=s,WX[2].y=WX[3].y=l;for(var d,p=ce(QX);!(d=p()).done;){var m=d.value;Jn.set(m,0,0)}_!==u[0]&&Jn.set(QX[0],3,0),_!==u[2]&&Jn.set(QX[2],1,2),f!==u[1]&&Jn.set(QX[1],0,1),f!==u[3]&&Jn.set(QX[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,o=0,a=0,s=0,c=XX;e.isRotated()?(r=i.x/t,o=(i.x+i.height)/t,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/t,o=(i.x+i.width)/t,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(t),ZX(jX[0],jX[2],jX[1],jX[3],KX,r,qX),ZX(jX[0],jX[2],jX[1],jX[3],KX,r+o,YX);for(var s=0,c=0;c<4;++c){var l=QX[c];if(l)if(o>=GX)n.dataLength=s+3,$X(i,s,KX,WX[l.x],WX[l.y]),s+=3;else{var u=JX(KX,WX[l.x]),h=JX(KX,WX[l.y]);h<u&&(h+=GX),u-=GX,h-=GX;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,$X(i,s,KX,WX[l.x],h>=a?YX[c]:WX[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,$X(i,s,KX,qX[c],WX[l.y]),s+=3):(n.dataLength=s+3,$X(i,s,KX,qX[c],YX[c]),s+=3))),u+=GX,h+=GX}}n.resize(s,s),n.updateRenderData(e,t)}},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(HX);for(var n=e.renderData,i=n.floatStride,r=e.renderData.data,o=t.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];Nn.set(VX,l.x,l.y,0),Nn.transformMat4(VX,VX,HX),o[s+0]=VX.x,o[s+1]=VX.y,o[s+2]=VX.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},nq=[],iq=0;iq<4;iq++)nq.push(new Nn);for(var rq={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){var t=e.spriteFrame;zB.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData,i=t.vb,r=n.data,o=e.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,d=c.m12,p=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(f){var S=m+d,x=v+d,E=g+p,T=y+p;i[0]=S,i[1]=E,i[9]=x,i[10]=E,i[18]=S,i[19]=T,i[27]=x,i[28]=T}else{var C=l*m,A=l*v,b=u*m,w=u*v,I=h*g+d,P=h*y+d,R=_*g+p,O=_*y+p;i[0]=C+I,i[1]=b+R,i[9]=A+I,i[10]=w+R,i[18]=C+P,i[19]=b+O,i[27]=A+P,i[28]=w+O}},fillBuffers:function(e){if(null!==e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(i),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=e.spriteFrame,f=_.getOriginalSize(),d=_.getRect(),p=f.width,m=f.height,v=d.width,g=d.height,y=_.getOffset(),S=r/p,x=o/m,E=y.x+(p-v)/2,T=y.x-(p-v)/2;c=E*S-a,l=(y.y+(m-g)/2)*x-s,u=r+T*S-a,h=o+(y.y-(m-g)/2)*x-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,n=e.spriteFrame.uv;t[3]=n[0],t[4]=n[1],t[12]=n[2],t[13]=n[3],t[21]=n[4],t[22]=n[5],t[30]=n[6],t[31]=n[7]}},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=5,r=e.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=t.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},oq=new Nn,aq=new Yn,sq={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,54),t},updateRenderData:function(e){var t=e.spriteFrame;zB.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,d=i/(c+l),p=r/(u+h);d=Number.isNaN(d)||d>1?1:d,p=Number.isNaN(p)||p>1?1:p,_=_<0?0:_,f=f<0?0:f,t[0].x=-o,t[0].y=-a,t[1].x=c*d-o,t[1].y=h*p-a,t[2].x=t[1].x+_,t[2].y=t[1].y+f,t[3].x=i-o,t[3].y=r-a},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(aq);for(var n=e.renderData,i=n.floatStride,r=n.data,o=t.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];Nn.set(oq,u.x,c.y,0),Nn.transformMat4(oq,oq,aq),a=(4*s+l)*i,o[a++]=oq.x,o[a++]=oq.y,o[a++]=oq.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=e.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},cq=[],lq=0;lq<4;lq++)cq.push(new Nn);var uq=new Yn,hq={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,d=o-u-h;f=f>0?f:0,d=d>0?d:0;var p=0===l?f:f/l,m=0===_?d:d/_,v=Math.ceil(m+2),g=Math.ceil(p+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,f,d,v,g),t.resize(v*g*4,v*g*6)}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(e,t){var n=e.node;n.getWorldMatrix(uq);var i=e.renderData,r=i.floatStride,o=i.data,a=t.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=e.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,d=u.rect,p=u.insetLeft,m=u.insetRight,v=d.width-p-m,g=u.insetTop,y=u.insetBottom,S=d.height-g-y,x=c-p-m,E=l-g-y;x=x>0?x:0,E=E>0?E:0;for(var T=0===v?x:x/v,C=0===S?E:E/S,A=Math.ceil(C+2),b=Math.ceil(T+2),w=0,I=0,P=0,R=0,O=0,D=0,N=A;D<N;++D){R=o[D].y,O=o[D+1].y;for(var M=0,L=b;M<L;++M){I=o[M].x,P=o[M+1].x,Nn.set(cq[0],I,R,0),Nn.set(cq[1],P,R,0),Nn.set(cq[2],I,O,0),Nn.set(cq[3],P,O,0);for(var B=0;B<4;B++){var F=cq[B];Nn.transformMat4(F,F,uq);var z=B*r;a[w+z]=F.x,a[w+z+1]=F.y,a[w+z+2]=F.z}w+=4*r}}w=0;for(var U=r,G=2*r,k=3*r,H=4*r,V=0,W=0,j=[],X=[],q=0,Y=A;q<Y;++q){W=E>S?E>=q*S?1:C%1:C;for(var K=0,Q=b;K<Q;++K){V=x>v?x>=K*v?1:T%1:T;var Z=w+3,J=Z+1;h?(0===q?(j[0]=f[0].u,j[1]=f[0].u,j[2]=f[4].u+(f[8].u-f[4].u)*W):q<A-1?(j[0]=f[4].u,j[1]=f[4].u,j[2]=f[4].u+(f[8].u-f[4].u)*W):q===A-1&&(j[0]=f[8].u,j[1]=f[8].u,j[2]=f[12].u),0===K?(X[0]=f[0].v,X[1]=f[1].v+(f[2].v-f[1].v)*V,X[2]=f[0].v):K<b-1?(X[0]=f[1].v,X[1]=f[1].v+(f[2].v-f[1].v)*V,X[2]=f[1].v):K===b-1&&(X[0]=f[2].v,X[1]=f[3].v,X[2]=f[2].v),j[3]=j[2],X[3]=X[1]):(0===K?(j[0]=f[0].u,j[1]=f[1].u+(f[2].u-f[1].u)*V,j[2]=_[0]):K<b-1?(j[0]=f[1].u,j[1]=f[1].u+(f[2].u-f[1].u)*V,j[2]=f[1].u):K===b-1&&(j[0]=f[2].u,j[1]=f[3].u,j[2]=f[2].u),0===q?(X[0]=f[0].v,X[1]=f[0].v,X[2]=f[4].v+(f[8].v-f[4].v)*W):q<A-1?(X[0]=f[4].v,X[1]=f[4].v,X[2]=f[4].v+(f[8].v-f[4].v)*W):q===A-1&&(X[0]=f[8].v,X[1]=f[8].v,X[2]=f[12].v),j[3]=j[1],X[3]=X[2]),a[Z]=j[0],a[J]=X[0],a[Z+U]=j[1],a[J+U]=X[1],a[Z+G]=j[2],a[J+G]=X[2],a[Z+k]=j[3],a[J+k]=X[3],w+=H}}},updateVerts:function(e,t,n,i,r){var o,a,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,d=s.anchorY*_,p=l.insetLeft,m=l.insetRight,v=u.width-p-m,g=l.insetTop,y=l.insetBottom,S=u.height-g-y,x=s.width/(p+m)>1?1:s.width/(p+m),E=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=S>0?Math.floor(1e3*n)/1e3%S==0?S:n%S:n;for(var T=0;T<=r;T++)0===T?c[T].x=-f:T>0&&T<r?c[T].x=1===T?p*x+Math.min(v,t)-f:v>0?T===r-1?p+o+v*(T-2)-f:p+Math.min(v,t)+v*(T-2)-f:p+t-f:T===r&&(c[T].x=Math.min(p+t+m,h)-f);for(var C=0;C<=i;C++)0===C?c[C].y=-d:C>0&&C<i?c[C].y=1===C?y*E+Math.min(S,n)-d:S>0?C===i-1?y+a+(C-2)*S-d:y+Math.min(S,n)+(C-2)*S-d:y+n-d:C===i&&(c[C].y=Math.min(y+n+g,_)-d)},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},_q=zH.Type,fq=zH.FillType,dq=e("spriteAssembler",{getAssembler:function(e){var t=rq,n=e;switch(n.type){case _q.SLICED:t=sq;break;case _q.TILED:t=hq;break;case _q.FILLED:t=n.fillType===fq.RADIAL?tq:UX}return t}});zH.Assembler=dq;var pq=kz.sharedManager,mq={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){e.type===yk.IMAGE_STENCIL&&(rq.updateRenderData(e),rq.updateColor(e))},fillBuffers:function(e,t){(e.type!==yk.IMAGE_STENCIL||e.spriteFrame)&&(pq.pushMask(e),t.finishMergeBatches(),function(e,t){pq.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(pq.enterLevel(e),e.type===yk.IMAGE_STENCIL){rq.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),pq.enableMask())}},vq={fillBuffers:function(){pq.exitMask()}},gq={getAssembler:function(){return mq}},yq={getAssembler:function(){return vq}};Ck.Assembler=gq,Ck.PostAssembler=yq;var Sq=e("MeshBuffer",function(){function e(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var t=e.prototype;return t.initialize=function(e,t,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=t,this._floatsPerVertex=HF(t),this._initVDataCount,this._floatsPerVertex,z(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},t.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},t.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0},t.setDirty=function(){this._dirty=!0},t.request=function(){return D(9002),!1},t.requireFreeIA=function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia},t.recycleIA=function(e){for(var t=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===t[n].ia){var i=t[n];return t[n]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=i)}},t.checkCapacity=function(e,t){var n=(this.vertexOffset+e)*this._floatsPerVertex,i=this.indexOffset+t;return!(n>this._initVDataCount||i>this._initIDataCount)},t.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var e=hh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,n=this.indexOffset,i=0;i<e;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,t>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},t.createNewIA=function(e){var t,n,i;if(hh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=e.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,r,r));i=e.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,o,o)),n=[a],this._iaInfo=new zr(this._attributes,n,i),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:n,indexBuffer:i}},J(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),e}()),xq=[PR.EventType.MOUSE_DOWN,PR.EventType.MOUSE_MOVE,PR.EventType.MOUSE_UP,PR.EventType.MOUSE_WHEEL],Eq=[PR.EventType.TOUCH_START,PR.EventType.TOUCH_MOVE,PR.EventType.TOUCH_END,PR.EventType.TOUCH_CANCEL],Tq=(new(function(){function e(){this.priority=yR.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],RR._registerEventDispatcher(this),XP.callbacksInvoker.on(cw.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),XP.callbacksInvoker.on(cw.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),XP.callbacksInvoker.on(cw.MARK_LIST_DIRTY,this._markListDirty,this)}var t=e.prototype;return t.dispatchEvent=function(e){var t=e.type;return Eq.includes(t)?this.dispatchEventTouch(e):!xq.includes(t)||this.dispatchEventMouse(e)},t.addPointerEventProcessor=function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),ot.array.remove(this._processorListToRemove,e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(ot.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),ot.array.remove(this._processorListToAdd,e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var o=t[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(e)){if(i=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,o=0;o<n;++o){var a=t[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===aw.TOUCH_START){if(a._handleEventTouch(e)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(e),e.type!==aw.TOUCH_END&&e.type!==aw.TOUCH_CANCEL||ot.array.removeAt(a.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;i.cachedCameraPriority=o.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,d=o?o.getSiblingIndex():0;return a?f-d:d-f},t._markListDirty=function(){this._isListDirty=!0},e}()),function(){function e(e,t){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=e,this._attributes=t,this._floatsPerVertex=HF(t),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var t=e.prototype;return t.initialize=function(){},t.reset=function(){},t.request=function(){},t.appendBuffers=function(){},t.uploadBuffers=function(){},t.destroy=function(){this._attributes.length=0},J(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),e}()),Cq=new Kl((function(){return{offset:0,length:0}}),32),Aq=function(e,t,n,i){this.vertexAccessor=e,this.bufferId=t,this.vertexOffset=n,this.vb=i},bq=function(e){function t(n,i,r,o){var a;return(a=e.call(this,n,i)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*ft.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*t.IB_SCALE,a._allocateBuffer(),a}ee(t,e);var n=t.prototype;return n.destroy=function(){for(var t=0;t<this._buffers.length;++t){this._buffers[t].destroy();for(var n=this._freeLists[t],i=0;i<n.length;++i)Cq.free(n[i])}this._buffers.length=0,this._freeLists.length=0,e.prototype.destroy.call(this)},n.reset=function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}},n.getVertexBuffer=function(e){return this._buffers[e].vData},n.getIndexBuffer=function(e){return this._buffers[e].iData},n.getMeshBuffer=function(e){return this._buffers[e]},n.uploadBuffers=function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],n=this._buffers[e];(!t||t.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(e,t){var n=this._buffers[e];t.length&&(n.iData.set(t,n.indexOffset),n.indexOffset+=t.length)},n.allocateChunk=function(e,t){for(var n,i=e*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(e,t)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new Aq(this,o,u,h,t)}return M(9004,i),null},n.recycleChunk=function(e){var t=this._freeLists[e.bufferId],n=this._buffers[e.bufferId],i=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=t[a];c&&c.offset<i;)s=c,c=t[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,t.splice(a,1),Cq.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=Cq.alloc();l.offset=i,l.length=r,t.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=Cq.alloc();u.offset=i,u.length=r,t.push(u)}}},n._allocateChunkFromEntry=function(e,t,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[e];a.byteOffset<o&&(a.byteOffset=o),F(r>=0,9004,e,n.offset,n.length),0===r?(this._freeLists[e].splice(t,1),Cq.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){F(this._buffers.length===this._freeLists.length,9003);var e=new Sq,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var n=Cq.alloc();n.offset=0,n.length=e.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},t}(Tq);bq.IB_SCALE=4;var wq=new Kr(null),Iq=new Yn,Pq=e("UI",function(){function e(e){var t=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new ig,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new Oq,this._meshDataArray=[],this._root=e,this.device=e.device,this._batches=new Zl(64),this._drawBatchPool=new Kl((function(){return new wW}),128,(function(e){return e.destroy(t)}))}var t=e.prototype;return t.initialize=function(){return!0},t.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(e){e.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),kz.sharedManager.destroy()},t.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},t.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},t.sortScreens=function(){this._screens.sort(this._screenSort)},t.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},t.update=function(){for(var e=this._screens,t=0,n=0;n<e.length;++n){var i=e[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var a=this._batches.array[t];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},t.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(e){e.uploadBuffers()})),this._bufferAccessors.forEach((function(e){e.uploadBuffers(),e.reset()})),this._descriptorSetCache.update())},t.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach((function(e){e.reset()})),this._meshDataArray.forEach((function(e){e.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),kz.sharedManager.reset()},t.switchBufferAccessor=function(e){void 0===e&&(e=GF);var t=e===GF?36:VF(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var n=this._bufferAccessors.get(t);n||(n=new bq(this.device,e),this._bufferAccessors.set(t,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},t.registerBufferAccessor=function(e,t){this._bufferAccessors.set(e,t)},t.updateBuffer=function(e,t){var n=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=n.getMeshBuffer(t).indexOffset)},t.commitComp=function(e,t,n,i,r){var o,a=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;a=t.dataHash,o=t.material,s=t.chunk.bufferId}e.stencilStage=kz.sharedManager.stage;var c=e.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(e,this)},t.commitIA=function(e,t,n,i,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;e&&(o=-1===e.blendHash?null:e.getBlendState(),c=e.blendHash,e.stencilStage=kz.sharedManager.stage,a=null!==e.customMaterial?kz.sharedManager.getStencilStage(e.stencilStage,i):kz.sharedManager.getStencilStage(e.stencilStage),s=kz.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=e.node.layer,l.inputAssembler=t,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,a,s,o,c,null,this),this._batches.push(l)},t.commitModel=function(e,t,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(e.stencilStage!==rz.ENABLED&&e.stencilStage!==rz.DISABLED||(e.stencilStage=kz.sharedManager.stage),i=kz.sharedManager.getStencilStage(e.stencilStage,n),r=kz.sharedManager.getStencilHash(e.stencilStage));var o=h.director.getTotalFrames();t&&(t.updateTransform(o),t.updateUBOs(o));for(var a=0;a<t.subModels.length;a++){var s=this._drawBatchPool.alloc(),c=t.subModels[a];s.visFlags=e.node.layer,s.model=t,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}},t.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},t.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},t.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},t.autoMergeBatches=function(e){var t=this._currMaterial;if(t){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;e&&(c=-1===e.blendHash?null:e.getBlendState(),h=e.blendHash,l=null!==e.customMaterial?kz.sharedManager.getStencilStage(e.stencilStage,t):kz.sharedManager.getStencilStage(e.stencilStage),u=kz.sharedManager.getStencilHash(e.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(t,l,u,c,h,null,this),this._batches.push(_)}}},t.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},t.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},t.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},t.flushMaterial=function(e){this._currMaterial=e},t.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var n=e.children,i=e._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&!r.useVertexOpacity&&r.renderData&&r.renderData.vertexCount>0){!function(e,t){for(var n,i,r,o=e.vertexFormat,a=e.chunk.vb,s=0,c=0;c<o.length;++c){if(n=o[c],(i=ao[n.format]).hasAlpha)if(r=e.floatStride,i.size/i.count==1)for(var l=~~_n(Math.round(255*t),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=t;s+=i.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!e._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,t)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),t+=1}},t._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},t._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},J(e,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),e}()),Rq=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=h.director.root.device;this._localData=new Float32Array(sp.COUNT),this._localBuffer=e.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,sp.SIZE,sp.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=h.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,wq.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(wq),this._descriptorSet.bindBuffer(sp.BINDING,this._localBuffer);var n=zd.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.isValid=function(){return this._transform&&this._transform.isValid},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;Yn.toArray(this._localData,t,sp.MAT_WORLD_OFFSET),Yn.inverseTranspose(Iq,t);var n=Yn.determinant(Iq),i=1/Math.sqrt(n);Yn.multiplyScalar(Iq,Iq,i),Yn.toArray(this._localData,Iq,sp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},J(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),Oq=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Kl((function(){return new Rq}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=h.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,r=0,o=i.length;r<o;r++){var a=i[r];if(a.equals(e.useLocalData,e.textureHash,e.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(e),this._localDescriptorSetCache.push(s),s.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);wq.layout=e.passes[0].localSetLayout;var c=n.device.createDescriptorSet(wq),l=zd.SAMPLER_SPRITE;return c.bindTexture(l,e.texture),c.bindSampler(l,e.sampler),c.update(),this._descriptorSetCache.set(t,c),this._dsCacheHashByTexture.set(e.textureHash,t),c},t.update=function(){var e=this._localDescriptorSetCache,t=[];e.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=e.indexOf(n);t.push(i)}}));for(var n=t.length-1;n>=0;n--)e.splice(t[n],1)},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();h.internal.Batcher2D=Pq,V(Sq.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(e){return{name:e,suggest:"please use meshBuffer.accessor."+e+" instead"}}))),k(Sq.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),H(Sq.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),k(Pq.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),H(uz.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),k(uz.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),e("QuadRenderData",function(e){function t(t){var n;return n=e.call(this,t)||this,D(9006),n}return ee(t,e),t}(uz));var Dq,Nq,Mq=null,Lq=-1,Bq="BES bswy:->@123",Fq=Object.create(null),zq=[],Uq=3e3;function Gq(){for(var e=!0,t=Date.now(),n=zq.length-1;n>=0;n--){var i=zq[n],r=i.fontFamilyName;if(t-i.startTime>Uq)D(4933,r),i.onComplete(null,r),zq.splice(n,1);else{var o=i.refWidth,a="40px "+r;Mq.font=a,o!==AF(Mq,Bq,a)?(zq.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(Lq),Lq=-1)}function kq(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(Fq[i])n(null,i);else{if(!Mq){var r=document.createElement("canvas");r.width=100,r.height=100,Mq=r.getContext("2d")}var o=AF(Mq,Bq,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===Dq)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);Dq=e?parseInt(e[1],10)>42:!t}else Dq=!1;return Dq}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=Uq?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(e,t){r=setTimeout(t,Uq)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){D(4933,t),n(null,t)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};zq.push(u),-1===Lq&&(Lq=setInterval(Gq,100))}Fq[i]=a}}function Hq(e,t,n,i){var r=new sF;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}$N.register({".font":kq,".eot":kq,".ttf":kq,".woff":kq,".svg":kq,".ttc":kq}),aM.register({".font":Hq,".eot":Hq,".ttf":Hq,".woff":Hq,".svg":Hq,".ttc":Hq}),h.UI={MeshBuffer:Sq,spriteAssembler:dq,graphicsAssembler:dj,labelAssembler:LX,RenderData:lz,MeshRenderData:uz},function(e){e[e.positions=ir.ATTR_POSITION]="positions",e[e.normals=ir.ATTR_NORMAL]="normals",e[e.uvs=ir.ATTR_TEX_COORD]="uvs",e[e.colors=ir.ATTR_COLOR]="colors"}(Nq||(Nq={}));var Vq,Wq,jq,Xq,qq,Yq=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer},e}(),Kq=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>vp.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new Zq(this._mesh,i,this._mesh.struct.morph,t):this._subMeshRenderings[i]=new Qq(this._mesh,i,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(ir.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(ir.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(ir.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=ce(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}},e}(),Qq=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[t];this._subMeshMorph=r,tY(e,t,i);var o=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=eY(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(t,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(t,i){for(var r=t.displacements[n],s=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:t,morphTexture:i}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=ce(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new $q(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=ce(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case ir.ATTR_POSITION:a=Ep;break;case ir.ATTR_NORMAL:a=Ap;break;case ir.ATTR_TANGENT:a=Ip;break;default:E("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(vp.BINDING,t.buffer),n.update()},destroy:function(){}}},e}(),Zq=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[t];tY(e,t,i),this._attributes=r.attributes.map((function(t,n){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[n].offset,t.displacements[n].count)}}))}}))}return e.prototype.createInstance=function(){return new Jq(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},J(e,[{key:"data",get:function(){return this._attributes}}]),e}(),Jq=function(){function e(e,t,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new $q(n,0);var i=eY(n,t);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=i.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=e[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,n=ce(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case ir.ATTR_POSITION:r=Ep;break;case ir.ATTR_NORMAL:r=Ap;break;case ir.ATTR_TANGENT:r=Ip;break;default:E("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(vp.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}(),$q=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(vp.SIZE)),this._remoteBuffer=e.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,vp.SIZE,vp.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(vp.OFFSET_OF_WEIGHTS+4*t,e[t],h.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(vp.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,h.sys.isLittleEndian),this._localBuffer.setFloat32(vp.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,h.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(vp.OFFSET_OF_VERTICES_COUNT,e,h.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},J(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function eY(e,t){var n,i,o,a;e.getFormatFeatures(vi.RGBA32F)&wi.SAMPLED_TEXTURE?(n=t,o=16,i=gv.PixelFormat.RGBA32F,a=Float32Array):(n=4*t,o=4,i=gv.PixelFormat.RGBA8888,a=Uint8Array);var c=function(e){e<5&&(e=5);var t=r(s(e)),n=t>>1;return{width:1<<(1&t?n+1:n),height:1<<n}}(n),l=c.width,u=c.height;return{width:l,height:u,create:function(){var t=new ArrayBuffer(l*u*o),n=new Float32Array(t),r=a===Float32Array?n:new a(t),s=new Km({width:l,height:u,_data:r,_compressed:!1,format:i}),c=new gv;c.setFilters(gv.Filter.NEAREST,gv.Filter.NEAREST),c.setMipFilter(gv.Filter.NONE),c.setWrapMode(gv.WrapMode.CLAMP_TO_EDGE,gv.WrapMode.CLAMP_TO_EDGE,gv.WrapMode.CLAMP_TO_EDGE),c.image=s,c.getGFXTexture()||E("Unexpected: failed to create morph texture?");var h=e.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(r)}}}}}function tY(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function nY(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var iY=new Nn,rY=new Nn,oY=new Uint8Array,aY=e("Mesh",Ic("cc.Mesh")((qq=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,le(t,"_struct",jq,ae(t)),le(t,"_hash",Xq,ae(t)),t._data=oY,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t}ee(t,e);var n=t.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=h.director.root.device,n=this._createVertexBuffers(t,e),i=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var c=o.indexView,l=c.stride,u=c.length;if(4===l&&!t.hasFeature(mi.ELEMENT_INDEX_UINT)){var _=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(_>=65536){D(10001,_,65536);continue}l>>=1,u>>=1}a=t.createBuffer(new yr(Si.INDEX,Ti.DEVICE,u,l)),s=new(nY(c.stride))(e,c.offset,c.count),c.stride!==l&&(s=nY(l).from(s)),a.update(s)}var f=o.vertexBundelIndices.map((function(e){return n[e]})),d=[];if(o.vertexBundelIndices.length>0)for(var p=o.vertexBundelIndices[0],m=this._struct.vertexBundles[p].attributes,v=0;v<m.length;++v){var g=m[v];d[v]=new Br(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new sw(f,d,o.primitiveMode,a);y.mesh=this,y.subMeshIdx=r,i.push(y)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(e,t){return new Kq(e,t)}(this,t))}},n.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(e,t){this.reset({struct:e,data:t})},n.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},n.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new $s(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,ir.ATTR_JOINTS),c=this.readAttribute(a,ir.ATTR_WEIGHTS),l=this.readAttribute(a,ir.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){Nn.set(iY,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,d=s[f];if(!(0===c[f]||d>=i.length)){Nn.transformMat4(rY,iY,i[d]),n[d]=!0;var p=t[d];Nn.min(p.center,p.center,rY),Nn.max(p.halfExtents,p.halfExtents,rY)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?$s.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t},n.merge=function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new Nn,r=t&&new Gn,o=t&&new $s;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(Nn.add(o.center,a.maxPosition,a.minPosition),Nn.multiplyScalar(o.center,o.center,.5),Nn.subtract(o.halfExtents,a.maxPosition,a.minPosition),Nn.multiplyScalar(o.halfExtents,o.halfExtents,.5),$s.transform(o,o,t),Nn.add(a.maxPosition,o.center,o.halfExtents),Nn.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===ir.ATTR_POSITION||l.attributes[u].name===ir.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+sY(l.attributes,u)),f=uY(_,h),d=hY(_,h);if(!f||!d)continue;for(var p=l.view.count,m=l.view.stride,v=lY(h),g=0;g<p;g++){var y=g*m,S=y+v,x=S+v;switch(i.set(f(y),f(S),f(x)),l.attributes[u].name){case ir.ATTR_POSITION:i.transformMat4(t);break;case ir.ATTR_NORMAL:Nn.transformQuat(i,i,r)}d(y,i.x),d(S,i.y),d(x,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var E,T,C,A,b,w=new Yq,I=0,P=0,R=0,O=0,D=0,N=0,M=0,L=0,B=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var U=this._struct.vertexBundles[z],G=e._struct.vertexBundles[z];R=U.view.offset,O=G.view.offset,P=U.view.stride,I=U.view.count+G.view.count,E=new ArrayBuffer(I*P),T=new Uint8Array(E),R+=(C=this._data.subarray(R,R+U.view.length)).length,O+=(A=e._data.subarray(O,O+G.view.length)).length,T.set(C),D=0;for(var k,H=ce(U.attributes);!(k=H()).done;){var V=k.value;M=0,B=!1;for(var W,j=ce(G.attributes);!(W=j()).done;){var X=W.value;if(V.name===X.name&&V.format===X.format){B=!0;break}M+=ao[X.format].size}if(B){L=ao[V.format].size,N=U.view.length+D;for(var q=0;q<G.view.count;++q){if(b=A.subarray(M,M+L),T.set(b,N),(V.name===ir.ATTR_POSITION||V.name===ir.ATTR_NORMAL)&&t){var Y=new Float32Array(T.buffer,N,3);switch(i.set(Y[0],Y[1],Y[2]),V.name){case ir.ATTR_POSITION:i.transformMat4(t);break;case ir.ATTR_NORMAL:Nn.transformQuat(i,i,r)}Y[0]=i.x,Y[1]=i.y,Y[2]=i.z}N+=U.view.stride,M+=G.view.stride}}D+=ao[V.format].size}F[z]={attributes:U.attributes,view:{offset:w.getLength(),length:E.byteLength,count:I,stride:P}},w.addBuffer(E)}for(var K,Q,Z,J=0,$=2,ee=0,te=new Array(this._struct.primitives.length),ne=0;ne<this._struct.primitives.length;++ne){var ie=this._struct.primitives[ne],re=e._struct.primitives[ne];te[ne]={primitiveMode:ie.primitiveMode,vertexBundelIndices:ie.vertexBundelIndices};for(var oe,ae=ce(ie.vertexBundelIndices);!(oe=ae()).done;){var se=oe.value;ee=Math.max(ee,this._struct.vertexBundles[se].view.count)}if(ie.indexView&&re.indexView){J=ie.indexView.count,J+=re.indexView.count,R=ie.indexView.offset,O=re.indexView.offset,$=J<256?1:J<65536?2:4;var le=new ArrayBuffer(J*$);if(K=2===$?new Uint16Array(le):1===$?new Uint8Array(le):new Uint32Array(le),Q=2===ie.indexView.stride?new Uint16Array(this._data.buffer,R,ie.indexView.count):1===ie.indexView.stride?new Uint8Array(this._data.buffer,R,ie.indexView.count):new Uint32Array(this._data.buffer,R,ie.indexView.count),$===ie.indexView.stride)K.set(Q);else for(var ue=0;ue<ie.indexView.count;++ue)K[ue]=Q[ue];R+=ie.indexView.length,Z=2===re.indexView.stride?new Uint16Array(e._data.buffer,O,re.indexView.count):1===re.indexView.stride?new Uint8Array(e._data.buffer,O,re.indexView.count):new Uint32Array(e._data.buffer,O,re.indexView.count);for(var he=0;he<re.indexView.count;++he)K[ie.indexView.count+he]=ee+Z[he];O+=re.indexView.length,te[ne].indexView={offset:w.getLength(),length:le.byteLength,count:J,stride:$},w.setNextAlignment($),w.addBuffer(le)}}var _e={vertexBundles:F,primitives:te,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _e.minPosition&&e._struct.minPosition&&_e.maxPosition&&e._struct.maxPosition&&(t?(Nn.add(o.center,e._struct.maxPosition,e._struct.minPosition),Nn.multiplyScalar(o.center,o.center,.5),Nn.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),Nn.multiplyScalar(o.halfExtents,o.halfExtents,.5),$s.transform(o,o,t),Nn.add(i,o.center,o.halfExtents),Nn.max(_e.maxPosition,_e.maxPosition,i),Nn.subtract(i,o.center,o.halfExtents),Nn.min(_e.minPosition,_e.minPosition,i)):(Nn.min(_e.minPosition,_e.minPosition,e._struct.minPosition),Nn.max(_e.maxPosition,_e.maxPosition,e._struct.maxPosition))),this.reset({struct:_e,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=vo(ao[o]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+sY(e.attributes,t)),c=ao[o],l=uY(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=e.view.stride,f=0;f<r;++f)for(var d=0;d<u;++d)h[u*f+d]=l(_*f+h.BYTES_PER_ELEMENT*d);i=h}}})),i},n.copyAttribute=function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+sY(e.attributes,t)),u=new DataView(n,r),h=ao[c],_=uY(l,c),f=hY(u,c);if(_&&f){for(var d=h.count,p=e.view.stride,m=lY(c),v=i,g=m,y=0;y<s;++y)for(var S=0;S<d;++S)f(v*y+g*S,_(p*y+m*S));a=!0}}else a=!0})),a},n.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},n.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?vi.R8UI:2===n.indexView.stride?vi.R16UI:vi.R32UI,o=uY(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+ao[r].size*a);return!0},n._accessAttribute=function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=ce(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new yr(Si.VERTEX,Ti.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.reset({struct:{vertexBundles:[],primitives:[]},data:oY})},J(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=bo(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(Mu),jq=ue((Wq=qq).prototype,"_struct",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),Xq=ue(Wq.prototype,"_hash",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vq=Wq))||Vq);function sY(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=ao[r.format].size}return n}h.Mesh=aY;var cY=hh.isLittleEndian;function lY(e){var t=ao[e];return t.size/t.count}function uY(e,t){var n=ao[t],i=n.size/n.count;switch(n.type){case gi.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,cY)};case 4:return function(t){return e.getUint32(t,cY)}}break;case gi.SNORM:case gi.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,cY)};case 4:return function(t){return e.getInt32(t,cY)}}break;case gi.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,cY)};case 4:return function(t){return e.getUint32(t,cY)}}break;case gi.FLOAT:return function(t){return e.getFloat32(t,cY)}}return null}function hY(e,t){var n=ao[t],i=n.size/n.count;switch(n.type){case gi.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,cY)};case 4:return function(t,n){return e.setUint32(t,n,cY)}}break;case gi.SNORM:case gi.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,cY)};case 4:return function(t,n){return e.setInt32(t,n,cY)}}break;case gi.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,cY)};case 4:return function(t,n){return e.setUint32(t,n,cY)}}break;case gi.FLOAT:return function(t,n){return e.setFloat32(t,n,cY)}}return null}var _Y=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_NORMAL,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RG32F),new Br(ir.ATTR_TANGENT,vi.RGBA32F),new Br(ir.ATTR_COLOR,vi.RGBA32F)],fY=new Nn;function dY(e,t,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=ce(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===ir.ATTR_POSITION){i=h;break}}i||(i=_Y[0]),r.push(i);var _=ao[i.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:i}),o+=_.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var f,d=ce(e.attributes);!(f=d()).done;){var p=f.value;if(p.name===ir.ATTR_NORMAL){i=p;break}}i||(i=_Y[1]);var m=ao[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,g=ce(e.attributes);!(v=g()).done;){var y=v.value;if(y.name===ir.ATTR_TEX_COORD){i=y;break}}i||(i=_Y[2]);var S=ao[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/S.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=S.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var x,E=ce(e.attributes);!(x=E()).done;){var T=x.value;if(T.name===ir.ATTR_TANGENT){i=T;break}}i||(i=_Y[3]);var C=ao[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/C.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=C.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var A,b=ce(e.attributes);!(A=b()).done;){var w=A.value;if(w.name===ir.ATTR_COLOR){i=w;break}}i||(i=_Y[4]);var I=ao[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/I.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=I.size}if(e.customAttributes)for(var P,R=ce(e.customAttributes);!(P=R()).done;){var O=P.value,D=ao[O.attr.format];r.push(O.attr),s=Math.max(s,Math.floor(O.values.length/D.count)),a.push({offset:o,data:O.values,attribute:O.attr}),o+=D.size}for(var N=new Yq,M=new ArrayBuffer(s*o),L=new DataView(M),B=0,F=a;B<F.length;B++){var z=F[B];nw(L,z.data,z.attribute.format,z.offset,o)}N.setNextAlignment(0);var U={attributes:r,view:{offset:N.getLength(),length:M.byteLength,count:s,stride:o}};N.addBuffer(M);var G=null,k=0;if(e.indices){var H=e.indices;k=H.length,G=new ArrayBuffer(2*k),nw(new DataView(G),H,vi.R16UI)}var V={primitiveMode:e.primitiveMode||Vi.TRIANGLE_LIST,vertexBundelIndices:[0]};G&&(N.setNextAlignment(2),V.indexView={offset:N.getLength(),length:G.byteLength,count:k,stride:2},N.addBuffer(G));var W=e.minPos;if(!W&&n.calculateBounds){W=Nn.set(new Nn,1/0,1/0,1/0);for(var j=0;j<s;++j)Nn.set(fY,c[3*j+0],c[3*j+1],c[3*j+2]),Nn.min(W,W,fY)}var X=e.maxPos;if(!X&&n.calculateBounds){X=Nn.set(new Nn,-1/0,-1/0,-1/0);for(var q=0;q<s;++q)Nn.set(fY,c[3*q+0],c[3*q+1],c[3*q+2]),Nn.max(X,X,fY)}var Y={vertexBundles:[U],primitives:[V]};return W&&(Y.minPosition=new Nn(W.x,W.y,W.z)),X&&(Y.maxPosition=new Nn(X.x,X.y,X.z)),t||(t=new aY),t.reset({struct:Y,data:new Uint8Array(N.getCombined())}),t}var pY=Object.freeze({__proto__:null,find:HR,toPPM:function(e,t,n){return"P3 "+t+" "+n+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:function(e,t){void 0===t&&(t=0);for(var n,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),o=e.struct,a=o.primitives[t],s=ce(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,_=u.view,f=_.length,d=_.stride,p=ce(u.attributes);!(c=p()).done;){var m=c.value,v=Nq[m.name];v&&(i[v]=(i[v]||[]).concat(iw(r,m.format,h,f,d))),h+=ao[m.format].size}var g=a.indexView;return i.indices=iw(r,vi["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:dY,readBuffer:iw,writeBuffer:nw,mapBuffer:rw});e("utils",pY);var mY,vY,gY,yY,SY,xY,EY,TY,CY,AY,bY,wY,IY,PY,RY,OY,DY,NY,MY,LY,BY,FY,zY,UY,GY,kY,HY,VY,WY,jY,XY,qY,YY,KY,QY,ZY,JY,$Y,eK,tK,nK,iK,rK,oK,aK,sK,cK,lK,uK,hK,_K=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}ee(t,e);var n=t.prototype;return n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);if(this._morphRenderingInstance){var i=this._morphRenderingInstance.requiredPatches(t);if(i)return i.concat(null!=n?n:[])}return n},n.initSubModel=function(t,n,i){return e.prototype.initSubModel.call(this,t,n,this._launderMaterial(i))},n.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(t,n){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(n))},n.setMorphRendering=function(e){this._morphRenderingInstance=e},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,n)},n._launderMaterial=function(e){return e},t}(uy),fK=ct({OFF:0,ON:1}),dK=ct({OFF:0,ON:1}),pK=(mY=Ic("cc.ModelLightmapSettings"),vY=Fc("_recieveShadow"),mY((bY=function(){function e(){le(this,"texture",SY,this),le(this,"uvParam",xY,this),le(this,"_bakeable",EY,this),le(this,"_castShadow",TY,this),le(this,"_receiveShadow",CY,this),le(this,"_lightmapSize",AY,this)}return J(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),SY=ue((yY=bY).prototype,"texture",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xY=ue(yY.prototype,"uvParam",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni}}),EY=ue(yY.prototype,"_bakeable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TY=ue(yY.prototype,"_castShadow",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CY=ue(yY.prototype,"_receiveShadow",[vY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AY=ue(yY.prototype,"_lightmapSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),ue(yY.prototype,"bakeable",[qc],Object.getOwnPropertyDescriptor(yY.prototype,"bakeable"),yY.prototype),ue(yY.prototype,"castShadow",[qc],Object.getOwnPropertyDescriptor(yY.prototype,"castShadow"),yY.prototype),ue(yY.prototype,"receiveShadow",[qc],Object.getOwnPropertyDescriptor(yY.prototype,"receiveShadow"),yY.prototype),ue(yY.prototype,"lightmapSize",[qc],Object.getOwnPropertyDescriptor(yY.prototype,"lightmapSize"),yY.prototype),gY=yY))||gY),mK=function(t){return e({MeshRenderer:t,ModelComponent:t}),t}((wY=Ic("cc.MeshRenderer"),IY=Xc(),PY=Rc(100),RY=Hc(),OY=hl(Bt),DY=Zc(),NY=Dc({group:{name:"DynamicShadowSettings",displayOrder:0}}),MY=hl(Bt),LY=Zc(),BY=Dc({group:{name:"DynamicShadowSettings",displayOrder:1}}),FY=hl(fK),zY=Zc(),UY=Dc({group:{name:"DynamicShadowSettings",displayOrder:2}}),GY=hl(dK),kY=Zc(),HY=Dc({group:{name:"DynamicShadowSettings",displayOrder:3}}),VY=hl(aY),WY=Zc(),jY=Yc(),wY(XY=IY(XY=PY(XY=RY(XY=kc((nK=tK=function(e){function t(){var t;return le(t=e.call(this)||this,"lightmapSettings",YY,ae(t)),le(t,"_mesh",KY,ae(t)),le(t,"_shadowCastingMode",QY,ae(t)),le(t,"_shadowReceivingMode",ZY,ae(t)),le(t,"_shadowBias",JY,ae(t)),le(t,"_shadowNormalBias",$Y,ae(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,le(t,"_enableMorph",eK,ae(t)),t._modelType=uy,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},n.onRestore=function(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._onUpdateLocalShadowBias(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(h.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]},n.setWeights=function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},n.setWeight=function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}},n.setInstancedAttribute=function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===e){r[o].set(t);break}},n._updateLightmap=function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._mesh&&this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===uy?_K:this._modelType,t=this._model=h.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof _K&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=Ty.POSITION,this._model.transform.hasChangedFlags|=Ty.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onUpdateLocalShadowBias=function(){null!==this.model&&this.model.updateLocalShadowBias(),this.setInstancedAttribute("a_localShadowBias",[this._shadowBias,this._shadowNormalBias])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return wv.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateShadowBias=function(){this._model&&(this._model.shadowBias=this._shadowBias)},n._updateShadowNormalBias=function(){this._model&&(this._model.shadowNormalBias=this._shadowNormalBias)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===fK.OFF?this._model.castShadow=!1:(this._shadowCastingMode,fK.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===dK.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof _K&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,o=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},J(t,[{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._updateShadowBias(),this._onUpdateLocalShadowBias()}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._updateShadowNormalBias(),this._onUpdateLocalShadowBias()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),t}(wB),tK.ShadowCastingMode=fK,tK.ShadowReceivingMode=dK,YY=ue((qY=nK).prototype,"lightmapSettings",[Bc,qc,al],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new pK}}),KY=ue(qY.prototype,"_mesh",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QY=ue(qY.prototype,"_shadowCastingMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fK.OFF}}),ZY=ue(qY.prototype,"_shadowReceivingMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dK.ON}}),JY=ue(qY.prototype,"_shadowBias",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$Y=ue(qY.prototype,"_shadowNormalBias",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(qY.prototype,"shadowBias",[OY,DY,NY,al],Object.getOwnPropertyDescriptor(qY.prototype,"shadowBias"),qY.prototype),ue(qY.prototype,"shadowNormalBias",[MY,LY,BY,al],Object.getOwnPropertyDescriptor(qY.prototype,"shadowNormalBias"),qY.prototype),ue(qY.prototype,"shadowCastingMode",[FY,zY,UY,al],Object.getOwnPropertyDescriptor(qY.prototype,"shadowCastingMode"),qY.prototype),ue(qY.prototype,"receiveShadow",[GY,kY,HY,al],Object.getOwnPropertyDescriptor(qY.prototype,"receiveShadow"),qY.prototype),ue(qY.prototype,"mesh",[VY,WY],Object.getOwnPropertyDescriptor(qY.prototype,"mesh"),qY.prototype),ue(qY.prototype,"enableMorph",[jY,al],Object.getOwnPropertyDescriptor(qY.prototype,"enableMorph"),qY.prototype),eK=ue(qY.prototype,"_enableMorph",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XY=qY))||XY)||XY)||XY)||XY)||XY));function vK(e,t){var n=e.sharedMaterials.length;if(n!==t.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(e.getRenderMaterial(i)!==t.getRenderMaterial(i))return!1;return!0}e("BatchingUtility",function(){function e(){}return e.batchStaticModel=function(e,t){var n=e.getComponentsInChildren(mK);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!vK(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new aY,o=new Yn,a=new Yn;e.getWorldMatrix(a),Yn.invert(a,a);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(o),Yn.multiply(o,a,o),r.merge(n[s].mesh,o),c.enabled=!1}var l=t.addComponent(mK);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var n=e.getComponentsInChildren(mK),i=0;i<n.length;i++)n[i].enabled=!0;var r=t.getComponent(mK);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}()),k(aY.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),H(aY.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var gK,yK,SK,xK,EK,TK,CK,AK,bK,wK,IK,PK,RK,OK,DK,NK,MK,LK,BK,FK,zK,UK,GK=e("Skeleton",(iK=Ic("cc.Skeleton"),rK=hl([zt]),oK=hl([Yn]),iK((hK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_joints",cK,ae(t)),le(t,"_bindposes",lK,ae(t)),le(t,"_hash",uK,ae(t)),t._invBindposes=null,t}ee(t,e);var n=t.prototype;return n.destroy=function(){var t,n;return null===(t=null===(n=h.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===t||t.releaseSkeleton(this),e.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},J(t,[{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new Yn;Yn.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=bo(e,666)}return this._hash}}]),t}(Mu),cK=ue((sK=hK).prototype,"_joints",[rK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lK=ue(sK.prototype,"_bindposes",[oK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uK=ue(sK.prototype,"_hash",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aK=sK))||aK));h.Skeleton=GK,H(mK.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),h.ModelComponent=mK,ot.setClassAlias(mK,"cc.ModelComponent");var kK,HK,VK,WK,jK,XK,qK,YK,KK,QK,ZK,JK,$K,eQ,tQ,nQ,iQ,rQ,oQ,aQ,sQ,cQ,lQ,uQ,hQ,_Q,fQ,dQ,pQ,mQ,vQ,gQ,yQ,SQ,xQ,EQ,TQ,CQ,AQ,bQ,wQ,IQ,PQ,RQ,OQ,DQ,NQ,MQ,LQ,BQ,FQ,zQ,UQ,GQ,kQ,HQ,VQ,WQ,jQ,XQ,qQ,YQ,KQ,QQ,ZQ,JQ,$Q,eZ,tZ,nZ,iZ,rZ,oZ,aZ,sZ,cZ,lZ,uZ,hZ,_Z,fZ,dZ,pZ,mZ,vZ,gZ,yZ,SZ,xZ,EZ,TZ,CZ,AZ,bZ,wZ,IZ,PZ,RZ,OZ,DZ,NZ,MZ,LZ,BZ,FZ,zZ,UZ,GZ,kZ,HZ,VZ,WZ,jZ,XZ,qZ,YZ,KZ,QZ,ZZ,JZ,$Z=new Nn,eJ=ct({LUMINOUS_FLUX:0,LUMINANCE:1}),tJ=Ic("cc.StaticLightSettings")((CK=function(){function e(){le(this,"_baked",SK,this),le(this,"_editorOnly",xK,this),le(this,"_bakeable",EK,this),le(this,"_castShadow",TK,this)}return J(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),SK=ue((yK=CK).prototype,"_baked",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xK=ue(yK.prototype,"_editorOnly",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),EK=ue(yK.prototype,"_bakeable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TK=ue(yK.prototype,"_castShadow",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(yK.prototype,"editorOnly",[qc],Object.getOwnPropertyDescriptor(yK.prototype,"editorOnly"),yK.prototype),ue(yK.prototype,"bakeable",[qc],Object.getOwnPropertyDescriptor(yK.prototype,"bakeable"),yK.prototype),ue(yK.prototype,"castShadow",[qc],Object.getOwnPropertyDescriptor(yK.prototype,"castShadow"),yK.prototype),gK=yK))||gK,nJ=function(t){return e({Light:t,LightComponent:t}),t}((AK=Ic("cc.Light"),bK=Zc(),wK=Zc(),IK=Jc(),PK=Zc(),RK=hl(tJ),OK=il(),AK((UK=zK=function(e){function t(){var t;return le(t=e.call(this)||this,"_color",MK,ae(t)),le(t,"_useColorTemperature",LK,ae(t)),le(t,"_colorTemperature",BK,ae(t)),le(t,"_staticSettings",FK,ae(t)),t._type=Cy.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=Ry,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=h.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(h.director.root.destroyLight(this._light),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case Cy.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case Cy.SPHERE:e.addSphereLight(this._light);break;case Cy.SPOT:e.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case Cy.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case Cy.SPHERE:e.removeSphereLight(this._light);break;case Cy.SPOT:e.removeSpotLight(this._light)}}},J(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&($Z.x=e.r/255,$Z.y=e.g/255,$Z.z=e.b/255,this._light.color=$Z)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}}]),t}(th),zK.Type=Cy,zK.PhotometricTerm=eJ,MK=ue((NK=UK).prototype,"_color",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.WHITE.clone()}}),LK=ue(NK.prototype,"_useColorTemperature",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BK=ue(NK.prototype,"_colorTemperature",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),FK=ue(NK.prototype,"_staticSettings",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tJ}}),ue(NK.prototype,"color",[bK],Object.getOwnPropertyDescriptor(NK.prototype,"color"),NK.prototype),ue(NK.prototype,"useColorTemperature",[wK],Object.getOwnPropertyDescriptor(NK.prototype,"useColorTemperature"),NK.prototype),ue(NK.prototype,"colorTemperature",[nl,IK,PK],Object.getOwnPropertyDescriptor(NK.prototype,"colorTemperature"),NK.prototype),ue(NK.prototype,"staticSettings",[RK,OK],Object.getOwnPropertyDescriptor(NK.prototype,"staticSettings"),NK.prototype),DK=NK))||DK)),iJ=function(t){return e({DirectionalLight:t,DirectionalLightComponent:t}),t}((kK=Ic("cc.DirectionalLight"),HK=Xc(),VK=Hc(),WK=Fc("_illuminance"),jK=Zc(),XK=Yc(),qK=Dc({group:{name:"DynamicShadowSettings",displayOrder:1}}),YK=hl(Ft),KK=Yc(),QK=Dc({group:{name:"DynamicShadowSettings",displayOrder:5}}),ZK=hl(pg),JK=Yc(),$K=Dc({group:{name:"DynamicShadowSettings",displayOrder:6}}),eQ=hl(Bt),tQ=Yc(),nQ=Dc({group:{name:"DynamicShadowSettings",displayOrder:7}}),iQ=hl(Bt),rQ=Yc(),oQ=Dc({group:{name:"DynamicShadowSettings",displayOrder:8}}),aQ=Jc(),sQ=hl(Bt),cQ=Yc(),lQ=Dc({group:{name:"DynamicShadowSettings",displayOrder:9}}),uQ=Zc(),hQ=Jc(),_Q=hl(Bt),fQ=Yc(),dQ=Dc({group:{name:"DynamicShadowSettings",displayOrder:10}}),pQ=Zc(),mQ=Jc(),vQ=hl(Bt),gQ=Yc(),yQ=Dc({group:{name:"DynamicShadowSettings",displayOrder:11}}),SQ=hl(Ft),xQ=Yc(),EQ=Dc({group:{name:"DynamicShadowSettings",displayOrder:12}}),TQ=hl(Bt),CQ=Yc(),AQ=Dc({group:{name:"DynamicShadowSettings",displayOrder:13}}),bQ=hl(Bt),wQ=Yc(),IQ=Dc({group:{name:"DynamicShadowSettings",displayOrder:14}}),PQ=hl(Bt),kK(RQ=HK(RQ=VK(RQ=kc((jQ=function(e){function t(){var t;return le(t=e.call(this)||this,"_illuminanceHDR",DQ,ae(t)),le(t,"_illuminanceLDR",NQ,ae(t)),le(t,"_shadowEnabled",MQ,ae(t)),le(t,"_shadowPcf",LQ,ae(t)),le(t,"_shadowBias",BQ,ae(t)),le(t,"_shadowNormalBias",FQ,ae(t)),le(t,"_shadowSaturation",zQ,ae(t)),le(t,"_shadowDistance",UQ,ae(t)),le(t,"_shadowInvisibleOcclusionRange",GQ,ae(t)),le(t,"_shadowFixedArea",kQ,ae(t)),le(t,"_shadowNear",HQ,ae(t)),le(t,"_shadowFar",VQ,ae(t)),le(t,"_shadowOrthoSize",WQ,ae(t)),t._type=Cy.DIRECTIONAL,t._light=null,t._lightType=Ny,t}return ee(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR,this._light.shadowEnabled=this._shadowEnabled,this._light.shadowPcf=this._shadowPcf,this._light.shadowBias=this._shadowBias,this._light.shadowNormalBias=this._shadowNormalBias,this._light.shadowSaturation=this._shadowSaturation,this._light.shadowDistance=this._shadowDistance,this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange,this._light.shadowFixedArea=this._shadowFixedArea,this._light.shadowNear=this._shadowNear,this._light.shadowFar=this._shadowFar,this._light.shadowOrthoSize=this._shadowOrthoSize)},J(t,[{key:"illuminance",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=this._shadowEnabled)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=this._shadowPcf)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=this._shadowBias)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=this._shadowNormalBias)}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=_n(e,0,1),this._light&&(this._light.shadowSaturation=this._shadowSaturation)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,vg.MAX_FAR),this._light&&(this._light.shadowDistance=this._shadowDistance)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,vg.MAX_FAR),this._light&&(this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this._light&&(this._light.shadowFixedArea=this._shadowFixedArea)}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e,this._light&&(this._light.shadowNear=this._shadowNear)}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,vg.MAX_FAR),this._light&&(this._light.shadowFar=this._shadowFar)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e,this._light&&(this._light.shadowOrthoSize=this._shadowOrthoSize)}}]),t}(nJ),DQ=ue((OQ=jQ).prototype,"_illuminanceHDR",[Dc,WK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),NQ=ue(OQ.prototype,"_illuminanceLDR",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3*_g.standardExposureValue}}),MQ=ue(OQ.prototype,"_shadowEnabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LQ=ue(OQ.prototype,"_shadowPcf",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pg.HARD}}),BQ=ue(OQ.prototype,"_shadowBias",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),FQ=ue(OQ.prototype,"_shadowNormalBias",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zQ=ue(OQ.prototype,"_shadowSaturation",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),UQ=ue(OQ.prototype,"_shadowDistance",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),GQ=ue(OQ.prototype,"_shadowInvisibleOcclusionRange",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),kQ=ue(OQ.prototype,"_shadowFixedArea",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HQ=ue(OQ.prototype,"_shadowNear",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),VQ=ue(OQ.prototype,"_shadowFar",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),WQ=ue(OQ.prototype,"_shadowOrthoSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),ue(OQ.prototype,"illuminance",[jK],Object.getOwnPropertyDescriptor(OQ.prototype,"illuminance"),OQ.prototype),ue(OQ.prototype,"shadowEnabled",[XK,qK,qc,YK],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowEnabled"),OQ.prototype),ue(OQ.prototype,"shadowPcf",[KK,QK,qc,ZK],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowPcf"),OQ.prototype),ue(OQ.prototype,"shadowBias",[JK,$K,qc,eQ],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowBias"),OQ.prototype),ue(OQ.prototype,"shadowNormalBias",[tQ,nQ,qc,iQ],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowNormalBias"),OQ.prototype),ue(OQ.prototype,"shadowSaturation",[rQ,oQ,qc,aQ,nl,sQ],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowSaturation"),OQ.prototype),ue(OQ.prototype,"shadowDistance",[cQ,lQ,qc,uQ,hQ,nl,_Q],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowDistance"),OQ.prototype),ue(OQ.prototype,"shadowInvisibleOcclusionRange",[fQ,dQ,qc,pQ,mQ,nl,vQ],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowInvisibleOcclusionRange"),OQ.prototype),ue(OQ.prototype,"shadowFixedArea",[gQ,yQ,qc,SQ],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowFixedArea"),OQ.prototype),ue(OQ.prototype,"shadowNear",[xQ,EQ,qc,TQ],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowNear"),OQ.prototype),ue(OQ.prototype,"shadowFar",[CQ,AQ,qc,bQ],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowFar"),OQ.prototype),ue(OQ.prototype,"shadowOrthoSize",[wQ,IQ,PQ],Object.getOwnPropertyDescriptor(OQ.prototype,"shadowOrthoSize"),OQ.prototype),RQ=OQ))||RQ)||RQ)||RQ)||RQ)),rJ=function(t){return e({SphereLight:t,SphereLightComponent:t}),t}((XQ=Ic("cc.SphereLight"),qQ=Xc(),YQ=Hc(),KQ=Fc("_luminance"),QQ=il(),ZQ=Zc(),JQ=il(),$Q=Zc(),eZ=hl(eJ),tZ=il(),nZ=Zc(),iZ=Zc(),rZ=Zc(),XQ(oZ=qQ(oZ=YQ(oZ=kc((_Z=function(e){function t(){var t;return le(t=e.call(this)||this,"_size",sZ,ae(t)),le(t,"_luminanceHDR",cZ,ae(t)),le(t,"_luminanceLDR",lZ,ae(t)),le(t,"_term",uZ,ae(t)),le(t,"_range",hZ,ae(t)),t._type=Cy.SPHERE,t._light=null,t._lightType=My,t}return ee(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},J(t,[{key:"luminousFlux",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Py(this._size):this._luminanceLDR},set:function(e){var t=0;h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Py(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(nJ),sZ=ue((aZ=_Z).prototype,"_size",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),cZ=ue(aZ.prototype,"_luminanceHDR",[Bc,KQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Py(.15)}}),lZ=ue(aZ.prototype,"_luminanceLDR",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Py(.15)*_g.standardExposureValue*_g.standardLightMeterScale}}),uZ=ue(aZ.prototype,"_term",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eJ.LUMINOUS_FLUX}}),hZ=ue(aZ.prototype,"_range",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ue(aZ.prototype,"luminousFlux",[QQ,ZQ],Object.getOwnPropertyDescriptor(aZ.prototype,"luminousFlux"),aZ.prototype),ue(aZ.prototype,"luminance",[JQ,$Q],Object.getOwnPropertyDescriptor(aZ.prototype,"luminance"),aZ.prototype),ue(aZ.prototype,"term",[eZ,tZ,nZ],Object.getOwnPropertyDescriptor(aZ.prototype,"term"),aZ.prototype),ue(aZ.prototype,"size",[iZ],Object.getOwnPropertyDescriptor(aZ.prototype,"size"),aZ.prototype),ue(aZ.prototype,"range",[rZ],Object.getOwnPropertyDescriptor(aZ.prototype,"range"),aZ.prototype),oZ=aZ))||oZ)||oZ)||oZ)||oZ)),oJ=function(t){return e({SpotLight:t,SpotLightComponent:t}),t}((fZ=Ic("cc.SpotLight"),dZ=Xc(),pZ=Hc(),mZ=Fc("_luminance"),vZ=Zc(),gZ=il(),yZ=Zc(),SZ=il(),xZ=hl(eJ),EZ=il(),TZ=Zc(),CZ=Zc(),AZ=Zc(),bZ=Jc(),wZ=Zc(),IZ=Yc(),PZ=Dc({group:{name:"DynamicShadowSettings",displayOrder:1}}),RZ=hl(Ft),OZ=Yc(),DZ=Dc({group:{name:"DynamicShadowSettings",displayOrder:2}}),NZ=hl(pg),MZ=Yc(),LZ=Dc({group:{name:"DynamicShadowSettings",displayOrder:3}}),BZ=hl(Bt),FZ=Yc(),zZ=Dc({group:{name:"DynamicShadowSettings",displayOrder:4}}),UZ=hl(Bt),fZ(GZ=dZ(GZ=pZ(GZ=kc((JZ=function(e){function t(){var t;return le(t=e.call(this)||this,"_size",HZ,ae(t)),le(t,"_luminanceHDR",VZ,ae(t)),le(t,"_luminanceLDR",WZ,ae(t)),le(t,"_term",jZ,ae(t)),le(t,"_range",XZ,ae(t)),le(t,"_spotAngle",qZ,ae(t)),le(t,"_shadowEnabled",YZ,ae(t)),le(t,"_shadowPcf",KZ,ae(t)),le(t,"_shadowBias",QZ,ae(t)),le(t,"_shadowNormalBias",ZZ,ae(t)),t._type=Cy.SPOT,t._light=null,t._lightType=ky,t}return ee(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR,this._light.shadowEnabled=this._shadowEnabled,this._light.shadowPcf=this._shadowPcf,this._light.shadowBias=this._shadowBias,this._light.shadowNormalBias=this._shadowNormalBias)},J(t,[{key:"luminousFlux",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Py(this._size):this._luminanceLDR},set:function(e){var t=0;h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Py(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=pn(e))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=e)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=e)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=e)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=e)}}]),t}(nJ),HZ=ue((kZ=JZ).prototype,"_size",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),VZ=ue(kZ.prototype,"_luminanceHDR",[Bc,mZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Py(.15)}}),WZ=ue(kZ.prototype,"_luminanceLDR",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Py(.15)*_g.standardExposureValue*_g.standardLightMeterScale}}),jZ=ue(kZ.prototype,"_term",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eJ.LUMINOUS_FLUX}}),XZ=ue(kZ.prototype,"_range",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qZ=ue(kZ.prototype,"_spotAngle",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),YZ=ue(kZ.prototype,"_shadowEnabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),KZ=ue(kZ.prototype,"_shadowPcf",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pg.HARD}}),QZ=ue(kZ.prototype,"_shadowBias",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),ZZ=ue(kZ.prototype,"_shadowNormalBias",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(kZ.prototype,"luminousFlux",[vZ,gZ],Object.getOwnPropertyDescriptor(kZ.prototype,"luminousFlux"),kZ.prototype),ue(kZ.prototype,"luminance",[yZ,SZ],Object.getOwnPropertyDescriptor(kZ.prototype,"luminance"),kZ.prototype),ue(kZ.prototype,"term",[xZ,EZ,TZ],Object.getOwnPropertyDescriptor(kZ.prototype,"term"),kZ.prototype),ue(kZ.prototype,"size",[CZ],Object.getOwnPropertyDescriptor(kZ.prototype,"size"),kZ.prototype),ue(kZ.prototype,"range",[AZ],Object.getOwnPropertyDescriptor(kZ.prototype,"range"),kZ.prototype),ue(kZ.prototype,"spotAngle",[nl,bZ,wZ],Object.getOwnPropertyDescriptor(kZ.prototype,"spotAngle"),kZ.prototype),ue(kZ.prototype,"shadowEnabled",[IZ,PZ,qc,RZ],Object.getOwnPropertyDescriptor(kZ.prototype,"shadowEnabled"),kZ.prototype),ue(kZ.prototype,"shadowPcf",[OZ,DZ,qc,NZ],Object.getOwnPropertyDescriptor(kZ.prototype,"shadowPcf"),kZ.prototype),ue(kZ.prototype,"shadowBias",[MZ,LZ,qc,BZ],Object.getOwnPropertyDescriptor(kZ.prototype,"shadowBias"),kZ.prototype),ue(kZ.prototype,"shadowNormalBias",[FZ,zZ,qc,UZ],Object.getOwnPropertyDescriptor(kZ.prototype,"shadowNormalBias"),kZ.prototype),GZ=kZ))||GZ)||GZ)||GZ)||GZ));h.LightComponent=nJ,ot.setClassAlias(nJ,"cc.LightComponent"),h.DirectionalLightComponent=iJ,ot.setClassAlias(iJ,"cc.DirectionalLightComponent"),h.SphereLightComponent=rJ,ot.setClassAlias(rJ,"cc.SphereLightComponent"),h.SpotLightComponent=oJ,ot.setClassAlias(oJ,"cc.SpotLightComponent"),k(oJ.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),k(rJ.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),k(nJ.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var aJ=Symbol("BakeNodeCurves"),sJ=e("SkelAnimDataHub",function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&h.director.root.dataPoolManager.releaseAnimationClip(t);var i=Math.ceil(t.sample*t.duration)+1,r=t.sample;n=t[aJ](0,r,i),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}());sJ.pool=new Map;var cJ=new Yn;function lJ(e,t,n){for(Yn.identity(n);e!==t;)Yn.fromRTS(cJ,e.rotation,e.position,e.scale),Yn.multiply(n,cJ,n),e=e.parent;return n}var uJ=new br(Ri.POINT,Ri.POINT,Ri.NONE,Oi.CLAMP,Oi.CLAMP,Oi.CLAMP),hJ=function(e,t,n){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14};function _J(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*n,e)/12)}new Gn,new Gn,new Nn,new Gn,new Nn;var fJ=new Nn,dJ=new Nn,pJ=new Nn,mJ=new Nn,vJ=new Yn,gJ=new Yn,yJ=new $s,SJ=Number.MAX_SAFE_INTEGER,xJ=function(){function e(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=function(e){return e.getFormatFeatures(vi.RGBA32F)&wi.SAMPLED_TEXTURE?vi.RGBA32F:vi.RGBA8}(this._device);this._formatSize=ao[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Xy(e),this._pool.initialize({format:t,roundUpFn:_J}),this._customPool=new Xy(e),this._customPool.initialize({format:t,roundUpFn:_J})}var t=e.prototype;return t.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},t.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},t.getDefaultPoseTexture=function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),_=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!_)return r;r={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:_},s=new Float32Array(u),c=!0}Nn.set(pJ,SJ,SJ,SJ),Nn.set(mJ,-SJ,-SJ,-SJ);for(var f=t.getBoneSpaceBounds(e),d=0,p=0;d<l;d++,p+=12){var m=n.getChildByPath(o[d]),v=m?lJ(m,n,vJ):e.inverseBindposes[d],g=f[d];g&&($s.transform(yJ,g,v),yJ.getBoundary(fJ,dJ),Nn.min(pJ,pJ,fJ),Nn.max(mJ,mJ,dJ)),c&&(m&&Yn.multiply(v,v,a[d]),hJ(s,p,m?v:Yn.IDENTITY))}var y=[new $s];return r.bounds.set(t.hash,y),$s.fromPoints(y[0],pJ,mJ),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},t.getSequencePoseTexture=function(e,t,n,i){var r=e.hash^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=e.joints,s=e.bindposes,c=sJ.getOrExtract(t).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var _=12*h*c,f=this._chunkIdxMap.get(r),d=void 0!==f?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,f):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!d)return null;var p=this._createAnimInfos(e,t,i);o={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:d,animInfos:p},l=new Float32Array(_),u=!0}var m=n.getBoneSpaceBounds(e),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new $s(SJ,SJ,SJ,-SJ,-SJ,-SJ));for(var y=0,S=0;y<c;y++){for(var x=v[y],E=0;E<h;E++,S+=12){var T=o.animInfos[E],C=T.curveData,A=T.downstream,b=T.bindposeIdx,w=T.bindposeCorrection,I=void 0,P=!0;C&&A?I=Yn.multiply(vJ,C[y],A):C?I=C[y]:A?I=A:(I=e.inverseBindposes[b],P=!1);var R=m[E];if(R){var O=w?Yn.multiply(gJ,I,w):I;$s.transform(yJ,R,O),yJ.getBoundary(fJ,dJ),Nn.min(x.center,x.center,fJ),Nn.max(x.halfExtents,x.halfExtents,dJ)}u&&(P&&Yn.multiply(vJ,I,s[b]),hJ(l,S,P?vJ:Yn.IDENTITY))}$s.fromPoints(x,x.center,x.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},t.releaseHandle=function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}},t.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t._createAnimInfos=function(e,t,n){for(var i=[],r=e.joints,o=e.bindposes,a=r.length,s=sJ.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),_=void 0,f=void 0;!u;){var d=l.lastIndexOf("/");if(l=l.substring(0,d),u=s.joints[l],h?(_||(_=new Yn),Yn.fromRTS(vJ,h.rotation,h.position,h.scale),Yn.multiply(_,vJ,_),h=h.parent):f=l,d<0)break}var p=c,m=void 0;if(void 0!==f&&u){p=c-1;for(var v=0;v<a;v++)if(r[v]===f){p=v,m=new Yn,Yn.multiply(m,o[v],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:_,bindposeIdx:p,bindposeCorrection:m})}return i},J(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),e}(),EJ=function(){function e(e){this._pool=new Map,this._device=void 0,this._device=e}var t=e.prototype;return t.getData=function(e){void 0===e&&(e="-1");var t=this._pool.get(e);if(t)return t;var n=this._device.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,dp.SIZE,dp.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1,currentClip:null};return this._setAnimInfoDirty(r,!1),this._pool.set(e,r),r},t.destroy=function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))},t._setAnimInfoDirty=function(e,t){e.dirty=t},t.switchClip=function(e,t){return e.currentClip=t,e.data[0]=-1,e.buffer.update(e.data),this._setAnimInfoDirty(e,!1),e},t.clear=function(){for(var e,t=ce(this._pool.values());!(e=t()).done;)e.value.buffer.destroy();this._pool.clear()},e}(),TJ=[],CJ=new Map;function AJ(e,t){for(var n=0,i=Yn.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,TJ[n++]=e,e=e.parent}for(;n>0;){e=TJ[--n],TJ[n]=null;var r=e.node;Yn.fromRTS(e.local,r.rotation,r.position,r.scale),i=Yn.multiply(e.world,i,e.local)}return i}function bJ(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(CJ.has(o)){i=CJ.get(o);break}i={node:e,local:new Yn,world:new Yn,stamp:-1,parent:null},CJ.set(o,i),TJ[r++]=i,e=e.parent,i=null}for(;r>0;)n=TJ[--r],TJ[r]=null,n.parent=i,i=n;return i}function wJ(e){for(var t=CJ.get(e.uuid)||null;t;)CJ.delete(t.node.uuid),t=t.parent}var IJ=[{name:"CC_USE_SKINNING",value:!0}];function PJ(e,t,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(t.push(r),e.push(a))}}var RJ,OJ,DJ,NJ,MJ,LJ,BJ,FJ,zJ,UJ,GJ,kJ,HJ,VJ,WJ,jJ,XJ,qJ,YJ,KJ,QJ,ZJ,JJ,$J,e$,t$,n$,i$,r$,o$,a$,s$,c$,l$,u$,h$,_$,f$,d$,p$,m$,v$,g$,y$,S$,x$,E$,T$,C$,A$,b$,w$,I$,P$=new Nn,R$=new Nn,O$=new Nn,D$=new Nn,N$=new Yn,M$=new $s,L$=function(e){function t(){var t;return(t=e.call(this)||this)._buffers=[],t._dataArray=[],t._joints=[],t._bufferIndices=null,t.type=Zg.SKINNING,t}ee(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}e.prototype.destroy.call(this)},n.uploadAnimation=function(){},n.bindSkeleton=function(e,t,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)wJ(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=bJ(c,t),u=e.bindposes[a],h=[],_=[];o?PJ(h,_,o,a):(h.push(a),_.push(0)),this._joints.push({indices:h,buffers:_,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0),Nn.set(P$,1/0,1/0,1/0),Nn.set(R$,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=AJ(i.transform,e);$s.transform(M$,r,o),M$.getBoundary(O$,D$),Nn.min(P$,P$,O$),Nn.max(R$,R$,D$)}var a=this._worldBounds;this._modelBounds&&a&&($s.fromPoints(this._modelBounds,P$,R$),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;Yn.multiply(N$,a.world,s);for(var c=0;c<o.length;c++)hJ(this._dataArray[o[c]],12*r[c],N$)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(t,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,e.prototype.initSubModel.call(this,t,n,i),o.vertexBuffers=r},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?IJ.concat(n):IJ},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._buffers[this._bufferIndices[t]];i&&n.bindBuffer(mp.BINDING,i)},n._updateInstancedAttributes=function(t,n){n.batchingScheme!==Tv.NONE&&D(3936,this.node.getPathInHierarchy()),e.prototype._updateInstancedAttributes.call(this,t,n)},n._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,mp.SIZE,mp.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(mp.COUNT))},t}(_K),B$=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],F$=function(e){function t(){var t;(t=e.call(this)||this).uploadedAnim=void 0,t._jointsMedium=void 0,t._skeleton=null,t._mesh=null,t._dataPoolManager=void 0,t._instAnimInfoIdx=-1,t.type=Zg.BAKED_SKINNING,t._dataPoolManager=h.director.root.dataPoolManager;var n=new Float32Array(4),i=t._dataPoolManager.jointAnimationInfo.getData();return t._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:i,texture:null,boundsInfo:null},t}ee(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),this._skeleton=e,this._mesh=n,e&&t&&n){this.transform=t;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new yr(Si.UNIFORM|Si.TRANSFER_DST,Ti.DEVICE,fp.SIZE,fp.SIZE)))}},n.updateTransform=function(t){if(e.prototype.updateTransform.call(this,t),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?n.concat(B$):B$},n.uploadAnimation=function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,n=null;e?(n=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(e){this._modelBounds=e},n._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=e.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(yp,o)}},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(fp.BINDING,r),n.bindBuffer(dp.BINDING,a.buffer),o){var s=this._device.getSampler(uJ);n.bindTexture(yp,o.handle.texture),n.bindSampler(yp,s)}},n._updateInstancedAttributes=function(t,n){e.prototype._updateInstancedAttributes.call(this,t,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(pp)),this.updateInstancedJointTextureInfo()},n._setInstAnimInfoIdx=function(e){this._instAnimInfoIdx=e},n.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,n=e.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=t[1],r[2]=t[2]}},t}(_K),z$=function(t){return e({SkinnedMeshRenderer:t,SkinningModelComponent:t}),t}((RJ=Ic("cc.SkinnedMeshRenderer"),OJ=Xc(),DJ=Rc(100),NJ=Hc(),MJ=hl(GK),LJ=hl(ub),BJ=hl(GK),FJ=hl(ub),zJ=Zc(),RJ(UJ=OJ(UJ=DJ(UJ=kc(UJ=NJ((VJ=function(e){function t(){var t;return le(t=e.call(this)||this,"_skeleton",kJ,ae(t)),le(t,"_skinningRoot",HJ,ae(t)),t._clip=null,t.associatedAnimation=null,t._modelType=F$,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this._tryBindAnimation()},n.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),e.prototype.onDestroy.call(this)},n.uploadAnimation=function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)},n.setUseBakedAnimation=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1);var n=e?F$:L$;(t||this._modelType!==n)&&(this._modelType=n,this._model&&(h.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(t,n){e.prototype.setMaterial.call(this,t,n),this._modelType===L$&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),e.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var e=this._skinningRoot;if(e){for(var t=!1,n=this.node;n;n=n.parent)if(n===e){t=!0;break}if(t){var i=e.getComponent("cc.SkeletalAnimation");i?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},J(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._tryBindAnimation(),e!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),t}(mK),kJ=ue((GJ=VJ).prototype,"_skeleton",[MJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HJ=ue(GJ.prototype,"_skinningRoot",[LJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(GJ.prototype,"skeleton",[BJ],Object.getOwnPropertyDescriptor(GJ.prototype,"skeleton"),GJ.prototype),ue(GJ.prototype,"skinningRoot",[FJ,zJ],Object.getOwnPropertyDescriptor(GJ.prototype,"skinningRoot"),GJ.prototype),UJ=GJ))||UJ)||UJ)||UJ)||UJ)||UJ)),U$=new Br(ir.ATTR_BATCH_ID,vi.R32F),G$=new Br(ir.ATTR_BATCH_UV,vi.RG32F),k$=ao[U$.format].size+ao[G$.format].size,H$=function(t){return e({SkinnedMeshUnit:t,SkinningModelUnit:t}),t}((WJ=Ic("cc.SkinnedMeshUnit"),jJ=hl(aY),XJ=hl(GK),qJ=hl(ig),YJ=hl(z$),WJ((i$=function(){function e(){le(this,"mesh",ZJ,this),le(this,"skeleton",JJ,this),le(this,"material",$J,this),le(this,"_localTransform",e$,this),le(this,"_offset",t$,this),le(this,"_size",n$,this)}return J(e,[{key:"offset",get:function(){return this._offset},set:function(e){Jn.copy(this._offset,e)}},{key:"size",get:function(){return this._size},set:function(e){Jn.copy(this._size,e)}},{key:"copyFrom",get:function(){return null},set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&lJ(e.node,e.skinningRoot,this._localTransform))}}]),e}(),ZJ=ue((QJ=i$).prototype,"mesh",[jJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JJ=ue(QJ.prototype,"skeleton",[XJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$J=ue(QJ.prototype,"material",[qJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e$=ue(QJ.prototype,"_localTransform",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn}}),t$=ue(QJ.prototype,"_offset",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(0,0)}}),n$=ue(QJ.prototype,"_size",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(1,1)}}),ue(QJ.prototype,"offset",[qc],Object.getOwnPropertyDescriptor(QJ.prototype,"offset"),QJ.prototype),ue(QJ.prototype,"size",[qc],Object.getOwnPropertyDescriptor(QJ.prototype,"size"),QJ.prototype),ue(QJ.prototype,"copyFrom",[YJ],Object.getOwnPropertyDescriptor(QJ.prototype,"copyFrom"),QJ.prototype),KJ=QJ))||KJ)),V$=new Yn,W$=(new Yn,new Nn),j$=function(t){return e({SkinnedMeshBatchRenderer:t,BatchedSkinningModelComponent:t}),t}((r$=Ic("cc.SkinnedMeshBatchRenderer"),o$=Xc(),a$=Rc(100),s$=Hc(),c$=Zc(),l$=hl([zt]),u$=Zc(),h$=hl([H$]),_$=Zc(),f$=Yc(),d$=Yc(),r$(p$=o$(p$=a$(p$=kc(p$=s$((S$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"atlasSize",v$,ae(t)),le(t,"batchableTextureNames",g$,ae(t)),le(t,"units",y$,ae(t)),t._textures={},t._batchMaterial=null,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),e.prototype.onDestroy.call(this)},n._onMaterialModified=function(t){this.cookMaterials(),e.prototype._onMaterialModified.call(this,t,this.getMaterialInstance(t))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var n=t.effectAsset.techniques[t.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=yi.SAMPLER1D){var o=null;e.batchableTextureNames.find((function(e){return e===n}))?((o=e._textures[n])||(o=e.createTexture(n)),e.cookTextures(o,n,i)):e.units.some((function(e){return o=e.material&&e.material.getProperty(n,i)})),o&&t.setProperty(n,o,i)}else{for(var a=[],s=0;s<e.units.length;s++){var c=e.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}t.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var e=[],t=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;Yn.invert(V$,i._localTransform);for(var o=function(n){var i=r.joints[n];if(e.findIndex((function(e){return e===i}))>=0)return"continue";e.push(i),t.push(Yn.multiply(new Yn,r.bindposes[n]||Yn.IDENTITY,V$))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(e.length).keys()).sort((function(t,n){return e[t]>e[n]?1:e[t]<e[n]?-1:0})),c=new GK;c.joints=e.map((function(e,t,n){return n[s[t]]})),c.bindposes=t.map((function(e,t,n){return n[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var e=this,t=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){t=!0;break}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new aY;for(var i=0,r=vi.UNKNOWN,o=0,a=vi.UNKNOWN,s=0,c=vi.UNKNOWN,l=0,u=vi.UNKNOWN,h=0,_=vi.UNKNOWN,f=new Array(this.units.length),d=this.units.length,p=0;p<d;p++){var m=this.units[p];m&&m.skeleton&&(f[p]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var n=e.units[t];if(!n||!n.mesh||!n.mesh.data)return"continue";var d=e._createUnitMesh(t,n.mesh),p=new DataView(d.data.buffer);Yn.inverseTranspose(V$,n._localTransform);for(var m=n.offset,v=n.size,g=function(e){var g=d.struct.vertexBundles[e];i=g.view.offset,r=vi.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var S=g.attributes[y];if(S.name===ir.ATTR_POSITION){r=S.format;break}i+=ao[S.format].size}if(r){for(var x=iw(p,r,i,g.view.length,g.view.stride),E=0;E<x.length;E+=3)Nn.fromArray(W$,x,E),Nn.transformMat4(W$,W$,n._localTransform),Nn.toArray(x,W$,E);nw(p,x,r,i,g.view.stride)}o=g.view.offset,a=vi.UNKNOWN;for(var T=0;T<g.attributes.length;T++){var C=g.attributes[T];if(C.name===ir.ATTR_NORMAL){a=C.format;break}o+=ao[C.format].size}if(a){for(var A=iw(p,a,o,g.view.length,g.view.stride),b=0;b<A.length;b+=3)Nn.fromArray(W$,A,b),Nn.transformMat4Normal(W$,W$,V$),Nn.toArray(A,W$,b);nw(p,A,a,o,g.view.stride)}s=g.view.offset,c=vi.UNKNOWN;for(var w=0;w<g.attributes.length;w++){var I=g.attributes[w];if(I.name===ir.ATTR_TANGENT){c=I.format;break}s+=ao[I.format].size}if(c){for(var P=iw(p,c,s,g.view.length,g.view.stride),R=0;R<P.length;R+=3)Nn.fromArray(W$,P,R),Nn.transformMat4Normal(W$,W$,V$),Nn.toArray(P,W$,R);nw(p,P,c,s,g.view.stride)}l=g.view.offset,u=vi.UNKNOWN;for(var O=0;O<g.attributes.length;O++){var D=g.attributes[O];if(D.name===ir.ATTR_BATCH_UV){u=D.format;break}l+=ao[D.format].size}u&&rw(p,(function(e,t){var n,i=0===t?"x":"y";return(e=(n=e)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,p);var N=f[t];if(!N)return"continue";h=g.view.offset,_=vi.UNKNOWN;for(var M=0;M<g.attributes.length;M++){var L=g.attributes[M];if(L.name===ir.ATTR_JOINTS){_=L.format;break}h+=ao[L.format].size}_&&rw(p,(function(e){return N[e]}),_,h,g.view.length,g.view.stride,p)},y=0;y<d.struct.vertexBundles.length;y++)g(y);e._mesh.merge(d)},g=0;g<d;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(e,t,n){for(var i=[],r=[],o=[],a=[],s=0;s<this.units.length;s++){var c=this.units[s];if(c.material){var l=c.material.getProperty(t,n);if(l&&l.image&&l.image.data){var u=new fr;u.texOffset.x=c.offset.x*this.atlasSize,u.texOffset.y=c.offset.y*this.atlasSize,u.texExtent.width=c.size.x*this.atlasSize,u.texExtent.height=c.size.y*this.atlasSize;var _=l.image.data;ArrayBuffer.isView(_)?(o.push(_),a.push(u)):(i.push(_),r.push(u))}}}var f=e.getGFXTexture(),d=h.director.root.device;o.length>0&&d.copyBuffersToTexture(o,f,a),i.length>0&&d.copyTexImagesToTexture(i,f,r)},n.createTexture=function(e){var t=new gv;return t.setFilters(Im.LINEAR,Im.LINEAR),t.setMipFilter(Im.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:bm.RGBA8888}),this._textures[e]=t,t},n.resizeAtlases=function(){for(var e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:bm.RGBA8888})},n._createUnitMesh=function(e,t){for(var n=JSON.parse(JSON.stringify(t.struct)),i={},r=0;r<t.struct.primitives.length;r++){for(var o=t.struct.primitives[r],a=0,s=vi.UNKNOWN,c=0;c<o.vertexBundelIndices.length;c++){var l=t.struct.vertexBundles[o.vertexBundelIndices[c]];a=l.view.offset,s=vi.UNKNOWN;for(var u=0;u<l.attributes.length;u++){var _=l.attributes[u];if(_.name===ir.ATTR_TEX_COORD){s=_.format;break}a+=ao[_.format].size}if(s)break}if(void 0===i[c]){i[c]=[s,a];var f=n.vertexBundles[c];f.attributes.push(U$),f.attributes.push(G$),f.view.offset=0,f.view.length+=f.view.count*k$,f.view.stride+=k$}}for(var d=0,p=0;p<n.vertexBundles.length;p++)d+=n.vertexBundles[p].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=d,d+=v.indexView.length)}var g=new Uint8Array(d),y=t.data,S=new DataView(g.buffer),x=new DataView(y.buffer),E=h.sys.isLittleEndian;for(var T in i)for(var C=n.vertexBundles[T],A=t.struct.vertexBundles[T],b=i[T],w=iw(x,b[0],b[1],A.view.length,A.view.stride),I=A.view,P=C.view,R=I.stride,O=P.stride,D=I.offset,N=P.offset,M=0;M<P.count;M++){var L=y.subarray(D,D+R);g.set(L,N),S.setFloat32(N+R,e),S.setFloat32(N+R+4,w[2*M],E),S.setFloat32(N+R+8,w[2*M+1],E),N+=O,D+=R}for(var B=0;B<n.primitives.length;B++){var F=t.struct.primitives[B],z=n.primitives[B];if(F.indexView&&z.indexView)for(var U=F.indexView.stride,G=z.indexView.stride,k=F.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var W=y.subarray(k,k+U);g.set(W,H),H+=G,k+=U}}var j=new aY;return j.reset({struct:n,data:g}),j},J(t,[{key:"mesh",get:function(){return e.prototype.mesh},set:function(e){this.mesh=e}},{key:"skeleton",get:function(){return e.prototype.skeleton},set:function(e){this.skeleton=e}}]),t}(z$),v$=ue((m$=S$).prototype,"atlasSize",[Bc,c$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),g$=ue(m$.prototype,"batchableTextureNames",[l$,Bc,u$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),y$=ue(m$.prototype,"units",[h$,Bc,_$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ue(m$.prototype,"mesh",[fl,f$],Object.getOwnPropertyDescriptor(m$.prototype,"mesh"),m$.prototype),ue(m$.prototype,"skeleton",[fl,d$],Object.getOwnPropertyDescriptor(m$.prototype,"skeleton"),m$.prototype),p$=m$))||p$)||p$)||p$)||p$)||p$));function X$(e){return"string"==typeof e||"number"==typeof e}h.SkinningModelComponent=z$,ot.setClassAlias(z$,"cc.SkinningModelComponent"),h.SkinningModelUnit=H$,ot.setClassAlias(H$,"cc.SkinningModelUnit"),h.BatchedSkinningModelComponent=j$,ot.setClassAlias(j$,"cc.BatchedSkinningModelComponent"),h.utils=pY;var q$,Y$,K$,Q$,Z$,J$,$$,e0,t0,n0,i0,r0,o0,a0,s0,c0,l0,u0,h0,_0,f0,d0,p0=Ic("cc.animation.HierarchyPath")((C$=function(){function e(e){le(this,"path",T$,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof ub?e.getChildByPath(this.path)||(D(3926,e.name,this.path),null):(D(3925),null)},e}(),T$=ue((E$=C$).prototype,"path",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),x$=E$))||x$,m0=Ic("cc.animation.ComponentPath")((I$=function(){function e(e){le(this,"component",w$,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof ub?e.getComponent(this.component)||(D(3928,e.name,this.component),null):(D(3927),null)},e}(),w$=ue((b$=I$).prototype,"component",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),A$=b$))||A$,v0=Ic("cc.animation.UniformProxyFactory")((J$=function(){function e(e,t){le(this,"passIndex",K$,this),le(this,"uniformName",Q$,this),le(this,"channelIndex",Z$,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(Mv.getTypeFromHandle(n)<yi.SAMPLER1D){var i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,yi.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=ce(e.shaderInfo.blocks);!(n=i()).done;)for(var r,o=ce(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(i,e)}}:{set:function(e){t.setUniform(i,e)}}}var r=Mv.getBindingFromHandle(n),o=t.properties[this.uniformName],a=o&&o.value?o.value+"-texture":sm(o.type),s=wv.get(a);return s||(E("Illegal texture default value: "+a+"."),s=wv.get("default-texture")),{set:function(e){e||(e=s);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(r,n),e instanceof qm&&t.bindSampler(r,h.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),K$=ue((Y$=J$).prototype,"passIndex",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q$=ue(Y$.prototype,"uniformName",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Z$=ue(Y$.prototype,"channelIndex",[cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),q$=Y$))||q$,g0=Ic("cc.animation.MorphWeightValueProxy")((i0=function(){function e(){le(this,"subMeshIndex",t0,this),le(this,"shapeIndex",n0,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),t0=ue((e0=i0).prototype,"subMeshIndex",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n0=ue(e0.prototype,"shapeIndex",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$$=e0))||$$,y0=Ic("cc.animation.MorphWeightsValueProxy")((s0=function(){function e(){le(this,"subMeshIndex",a0,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),a0=ue((o0=s0).prototype,"subMeshIndex",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r0=o0))||r0,S0=Ic("cc.animation.MorphWeightsAllValueProxy")(c0=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)e.setWeights(t,o)}}},e}())||c0;function x0(e,t,n,i){var r,o,a,s,c,l,u=new t,h=new t,_=new t,f=Ic(e)((l=function(){function e(e,n,i){le(this,"dataPoint",a,this),le(this,"inTangent",s,this),le(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var o=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,r),_=n(_,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,d=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,d)},r.getNoLerp=function(){return this.dataPoint},e}(),a=ue((o=l).prototype,"dataPoint",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=ue(o.prototype,"inTangent",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=ue(o.prototype,"outTangent",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=o))||r;if(t===Gn){var d=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=d.call(this,e,t,n);return Gn.normalize(i,i),i}}return f}var E0,T0,C0,A0,b0,w0,I0,P0,R0,O0,D0,N0,M0,L0,B0,F0,z0,U0,G0,k0,H0,V0,W0,j0,X0,q0,Y0,K0=x0("cc.CubicSplineVec2Value",Jn,Jn.multiplyScalar,Jn.scaleAndAdd),Q0=x0("cc.CubicSplineVec3Value",Nn,Nn.multiplyScalar,Nn.scaleAndAdd),Z0=x0("cc.CubicSplineVec4Value",ni,ni.multiplyScalar,ni.scaleAndAdd),J0=x0("cc.CubicSplineQuatValue",Gn,Gn.multiplyScalar,Gn.scaleAndAdd),$0=Ic("cc.CubicSplineNumberValue")((d0=function(){function e(e,t,n){le(this,"dataPoint",h0,this),le(this,"inTangent",_0,this),le(this,"outTangent",f0,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*n*(o-a)},t.getNoLerp=function(){return this.dataPoint},e}(),h0=ue((u0=d0).prototype,"dataPoint",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_0=ue(u0.prototype,"inTangent",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f0=ue(u0.prototype,"outTangent",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),l0=u0))||l0,e1=Symbol("CreateEval"),t1=Symbol("NormalizedFollow"),n1=Symbol("ConvertAsTrsPath"),i1=Symbol("TrackBinding"),r1=Ic("cc.animation.TrackPath")((A0=function(){function e(){le(this,"_paths",C0,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new p0(e)),this},t.toComponent=function(e){var t=new m0("string"==typeof e?e:ot.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof p0},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof m0},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[t1](e,t,n)},t[n1]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var o=t[i];if(!(o instanceof p0))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[t1]=function(e,t,n){for(var i=this._paths,r=e,o=t;o<n;++o){var a=i[o];if(X$(a)){if(!(a in r))return D(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},J(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),C0=ue((T0=A0).prototype,"_paths",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),E0=T0))||E0,o1=Ic("cc.animation.TrackBinding")(b0=Gc((R0=function(){function e(){le(this,"path",I0,this),le(this,"proxy",P0,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[n1]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[t1](e,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return M(3921),null}var h=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),_=i[t1](e,0,o-1);return null===_?null:t&&_ instanceof ub&&function(e){return"position"===e||"rotation"===e||"scale"===e||"eulerAngles"===e}(h)?t.createPoseWriter(_,h,n):{setValue:function(e){_[h]=e},getValue:function(){return _[h]}}},t.isMaskedOff=function(e){var t=this.parseTrsPath();if(!t)return!1;for(var n=e.joints[Symbol.iterator](),i=n.next();!i.done;i=n.next()){var r=i.value;if(r.path===t.node)return!r.enabled}return!1},e}(),I0=ue((w0=R0).prototype,"path",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r1}}),P0=ue(w0.prototype,"proxy",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),b0=w0))||b0)||b0,a1=Ic("cc.animation.Track")((M0=function(){function e(){le(this,"_binding",N0,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=ce(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},J(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:i1,get:function(){return this._binding}}]),e}(),N0=ue((D0=M0).prototype,"_binding",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o1}}),O0=D0))||O0,s1=Ic("cc.animation.Channel")((z0=function(){function e(e){this.name="",le(this,"_curve",F0,this),this._curve=e}return J(e,[{key:"curve",get:function(){return this._curve}}]),e}(),F0=ue((B0=z0).prototype,"_curve",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),L0=B0))||L0,c1=Ic("cc.animation.SingleChannelTrack")((H0=function(e){function t(){var t;return le(t=e.call(this)||this,"_channel",k0,ae(t)),t._channel=new s1(t.createCurve()),t}ee(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[e1]=function(){var e=this._channel.curve;return new l1(e)},J(t,[{key:"channel",get:function(){return this._channel}}]),t}(a1),k0=ue((G0=H0).prototype,"_channel",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),U0=G0))||U0,l1=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),u1=Ic("cc.animation.RealTrack")(V0=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t.prototype.createCurve=function(){return new df},t}(c1))||V0;function h1(e){return 0===e.keyFramesCount?void 0:e}var _1,f1,d1,p1,m1,v1,g1,y1,S1,x1,E1,T1,C1=["X","Y","Z","W"],A1=Ic("cc.animation.VectorTrack")((Y0=function(e){function t(){var t;le(t=e.call(this)||this,"_channels",X0,ae(t)),le(t,"_nComponents",q0,ae(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new s1(new df);i.name=C1[n],t._channels[n]=i}return t}ee(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[e1]=function(){switch(this._nComponents){default:case 2:return new b1(h1(this._channels[0].curve),h1(this._channels[1].curve));case 3:return new w1(h1(this._channels[0].curve),h1(this._channels[1].curve),h1(this._channels[2].curve));case 4:return new I1(h1(this._channels[0].curve),h1(this._channels[1].curve),h1(this._channels[2].curve),h1(this._channels[3].curve))}},J(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(a1),X0=ue((j0=Y0).prototype,"_channels",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),q0=ue(j0.prototype,"_nComponents",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),W0=j0))||W0,b1=function(){function e(e,t){this._result=new Jn,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||Jn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),w1=function(){function e(e,t,n){this._result=new Nn,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||Nn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),I1=function(){function e(e,t,n,i){this._result=new ni,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||ni.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),P1=Ic("cc.animation.QuatTrack")(_1=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.createCurve=function(){return new ed},n[e1]=function(){return new R1(this.channels()[0].curve)},t}(c1))||_1,R1=function(){function e(e){this._result=new Gn,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),O1=["Red","Green","Blue","Alpha"],D1=Ic("cc.animation.ColorTrack")((m1=function(e){function t(){var t;le(t=e.call(this)||this,"_channels",p1,ae(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new s1(new df);i.name=O1[n],t._channels[n]=i}return t}ee(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[e1]=function(){return new N1(h1(this._channels[0].curve),h1(this._channels[1].curve),h1(this._channels[2].curve),h1(this._channels[3].curve))},t}(a1),p1=ue((d1=m1).prototype,"_channels",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),f1=d1))||f1,N1=function(){function e(e,t,n,i){this._result=new On,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||On.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),M1=["Width","Height"],L1=Ic("cc.animation.SizeTrack")((S1=function(e){function t(){var t;le(t=e.call(this)||this,"_channels",y1,ae(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new s1(new df);i.name=M1[n],t._channels[n]=i}return t}ee(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[e1]=function(){return new B1(h1(this._channels[0].curve),h1(this._channels[1].curve))},t}(a1),y1=ue((g1=S1).prototype,"_channels",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),v1=g1))||v1,B1=function(){function e(e,t){this._result=new oi,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),F1=Ic("cc.animation.ObjectTrack")(x1=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t.prototype.createCurve=function(){return new ud},t}(c1))||x1,z1=Symbol("[[Owner]]");function U1(e){e[z1]}!function(e){e[e.FLOAT=0]="FLOAT",e[e.BOOLEAN=1]="BOOLEAN",e[e.TRIGGER=2]="TRIGGER",e[e.INTEGER=3]="INTEGER"}(E1||(E1={})),function(e){e[e.AFTER_CONSUMED=0]="AFTER_CONSUMED",e[e.NEXT_FRAME_OR_AFTER_CONSUMED=1]="NEXT_FRAME_OR_AFTER_CONSUMED"}(T1||(T1={}));var G1,k1,H1,V1,W1,j1,X1,q1,Y1,K1,Q1,Z1,J1,$1,e2,t2,n2,i2,r2,o2,a2,s2,c2,l2,u2,h2,_2,f2,d2,p2,m2,v2,g2,y2,S2,x2,E2,T2,C2,A2,b2,w2,I2,P2,R2,O2,D2,N2,M2,L2,B2,F2,z2,U2,G2,k2,H2,V2,W2,j2,X2,q2,Y2,K2,Q2,Z2,J2,$2=function(){function e(e,t){this.type=void 0,this.resetMode=T1.AFTER_CONSUMED,this._value=void 0,this._refs=[],this.type=e,this._value=t}return e.prototype.bind=function(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this._refs.push({fn:e,thisArg:t,args:i}),this._value},J(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e;for(var t,n=ce(this._refs);!(t=n()).done;){var i=t.value,r=i.fn,o=i.thisArg,a=i.args;r.call.apply(r,[o,e].concat(a))}}}]),e}(),e4=function(e){function t(t){var n;return(n=e.call(this,t+" transition is invalid")||this).name="TransitionRejectError",n}return ee(t,e),t}(oe(Error)),t4=function(e){function t(t){return e.call(this,"Graph variable "+t+" is not defined")||this}return ee(t,e),t}(oe(Error)),n4=function(e){function t(t,n,i){return e.call(this,"Expect graph variable "+t+" to have type '"+n+"' instead of received '"+(null!=i?i:typeof i)+"'")||this}return ee(t,e),t}(oe(Error)),i4=Symbol("[[createEval]]"),r4=Symbol("[[Outgoing transitions]]"),o4=Symbol("[[Incoming transitions]]"),a4=Ic("cc.animation.State")((V1=function(e){function t(){var t;return le(t=e.call(this)||this,"name",H1,ae(t)),t[r4]=[],t[o4]=[],t}return ee(t,e),t}(pl),H1=ue((k1=V1).prototype,"name",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),G1=k1))||G1,s4=Ic("cc.animation.InteractiveState")((q1=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_components",X1,ae(t)),t}ee(t,e);var n=t.prototype;return n.addComponent=function(e){var t=new e;return this._components.push(t),t},n.removeComponent=function(e){de(this._components,e)},n.instantiateComponents=function(){return this._components.map((function(e){return t_(e)}))},J(t,[{key:"components",get:function(){return this._components}}]),t}(a4),X1=ue((j1=q1).prototype,"_components",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),W1=j1))||W1,c4=Ic("cc.animation.Motion")((e2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"motion",Q1,ae(t)),le(t,"speed",Z1,ae(t)),le(t,"speedMultiplier",J1,ae(t)),le(t,"speedMultiplierEnabled",$1,ae(t)),t}return ee(t,e),t.prototype.clone=function(){var e,n,i=new t;return i.motion=null!==(e=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==e?e:null,i.speed=this.speed,i.speedMultiplier=this.speedMultiplier,i.speedMultiplierEnabled=this.speedMultiplierEnabled,i},t}(s4),Q1=ue((K1=e2).prototype,"motion",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Z1=ue(K1.prototype,"speed",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),J1=ue(K1.prototype,"speedMultiplier",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$1=ue(K1.prototype,"speedMultiplierEnabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y1=K1))||Y1,l4=Symbol("[[OnAfterDeserialized]]"),u4=Ic("cc.animation.Transition")((a2=function(e){function t(t,n,i){var r;return le(r=e.call(this)||this,"from",i2,ae(r)),le(r,"to",r2,ae(r)),le(r,"conditions",o2,ae(r)),r[z1]=void 0,r.from=t,r.to=n,i&&(r.conditions=i),r}return ee(t,e),t}(pl),i2=ue((n2=a2).prototype,"from",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r2=ue(n2.prototype,"to",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),o2=ue(n2.prototype,"conditions",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),t2=n2))||t2,h4=Ic("cc.animation.AnimationTransition")((f2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"duration",l2,ae(t)),le(t,"relativeDuration",u2,ae(t)),le(t,"exitConditionEnabled",h2,ae(t)),le(t,"_exitCondition",_2,ae(t)),t}return ee(t,e),J(t,[{key:"exitCondition",get:function(){return this._exitCondition},set:function(e){this._exitCondition=e}}]),t}(u4),l2=ue((c2=f2).prototype,"duration",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),u2=ue(c2.prototype,"relativeDuration",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h2=ue(c2.prototype,"exitConditionEnabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_2=ue(c2.prototype,"_exitCondition",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),s2=c2))||s2,_4=Ic("cc.animation.EmptyState")(d2=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(a4))||d2,f4=Ic("cc.animation.EmptyStateTransition")((g2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"duration",v2,ae(t)),t}return ee(t,e),t}(u4),v2=ue((m2=g2).prototype,"duration",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),p2=m2))||p2,d4=Ic("cc.animation.StateMachine")((b2=function(e){ee(n,e);var t=n.prototype;function n(){var t;return le(t=e.call(this)||this,"_states",x2,ae(t)),le(t,"_transitions",E2,ae(t)),le(t,"_entryState",T2,ae(t)),le(t,"_exitState",C2,ae(t)),le(t,"_anyState",A2,ae(t)),t._entryState=t._addState(new a4),t._entryState.name="Entry",t._exitState=t._addState(new a4),t._exitState.name="Exit",t._anyState=t._addState(new a4),t._anyState.name="Any",t}return t.__callOnAfterDeserializeRecursive=function(){this[l4]();for(var e=this._states.length,t=0;t<e;++t){var n=this._states[t];n instanceof p4&&n.stateMachine.__callOnAfterDeserializeRecursive()}},t[l4]=function(){this._states.forEach((function(){})),this._transitions.forEach((function(e){e.from[r4].push(e),e.to[o4].push(e)}))},t[i4]=function(){throw new Error("Method not implemented.")},t.states=function(){return this._states},t.transitions=function(){return this._transitions},t.getTransitionsBetween=function(e,t){return U1(e),U1(t),e[r4].filter((function(e){return e.to===t}))},t.getOutgoings=function(e){return U1(e),e[r4]},t.getIncomings=function(e){return U1(e),e[o4]},t.addMotion=function(){return this._addState(new c4)},t.addSubStateMachine=function(){return this._addState(new p4)},t.addEmpty=function(){return this._addState(new _4)},t.remove=function(e){U1(e),e!==this.entryState&&e!==this.exitState&&e!==this.anyState&&(this.eraseTransitionsIncludes(e),de(this._states,e))},t.connect=function(e,t,n){if(U1(e),U1(t),t===this.entryState)throw new e4("to-entry");if(t===this.anyState)throw new e4("to-any");if(e===this.exitState)throw new e4("from-exit");var i=e instanceof c4||e===this._anyState?new h4(e,t,n):e instanceof _4?new f4(e,t,n):new u4(e,t,n);return this._transitions.push(i),e[r4].push(i),t[o4].push(i),i},t.disconnect=function(e,t){U1(e),U1(t);for(var n=e[r4],i=t[o4],r=this._transitions,o=n.filter((function(e){return e.to===t})),a=o.length,s=function(e){var t=o[e];de(n,t),de(r,t),pe(i,(function(e){return e===t}))},c=0;c<a;++c)s(c)},t.removeTransition=function(e){de(this._transitions,e),pe(e.from[r4],(function(t){return t===e})),pe(e.to[o4],(function(t){return t===e}))},t.eraseOutgoings=function(e){var t=this;U1(e);for(var n=e[r4],i=function(e){var i=n[e],r=i.to;de(t._transitions,i),pe(r[o4],(function(e){return e===i}))},r=0;r<n.length;++r)i(r);n.length=0},t.eraseIncomings=function(e){var t=this;U1(e);for(var n=e[o4],i=function(e){var i=n[e],r=i.from;de(t._transitions,i),pe(r[r4],(function(e){return e===i}))},r=0;r<n.length;++r)i(r);n.length=0},t.eraseTransitionsIncludes=function(e){this.eraseIncomings(e),this.eraseOutgoings(e)},t.clone=function(){for(var e,t=new n,i=new Map,r=ce(this._states);!(e=r()).done;){var o=e.value;switch(o){case this._entryState:i.set(o,t._entryState);break;case this._exitState:i.set(o,t._exitState);break;case this._anyState:i.set(o,t._anyState);break;default:if(o instanceof c4||o instanceof p4){var a=o.clone();t._addState(a),i.set(o,a)}}}for(var s,c=ce(this._transitions);!(s=c()).done;){var l=s.value,u=i.get(l.from),h=i.get(l.to),_=t.connect(u,h);_.conditions=l.conditions.map((function(e){return e.clone()})),_ instanceof h4&&(_.duration=l.duration,_.exitConditionEnabled=l.exitConditionEnabled,_.exitCondition=l.exitCondition)}return t},t._addState=function(e){return this._states.push(e),e},J(n,[{key:"entryState",get:function(){return this._entryState}},{key:"exitState",get:function(){return this._exitState}},{key:"anyState",get:function(){return this._anyState}}]),n}(pl),x2=ue((S2=b2).prototype,"_states",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),E2=ue(S2.prototype,"_transitions",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T2=ue(S2.prototype,"_entryState",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),C2=ue(S2.prototype,"_exitState",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),A2=ue(S2.prototype,"_anyState",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),y2=S2))||y2,p4=Ic("cc.animation.SubStateMachine")((R2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_stateMachine",P2,ae(t)),t}return ee(t,e),t.prototype.clone=function(){var e=new t;return e._stateMachine=this._stateMachine.clone(),e},J(t,[{key:"stateMachine",get:function(){return this._stateMachine}}]),t}(s4),P2=ue((I2=R2).prototype,"_stateMachine",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d4}}),w2=I2))||w2,m4=Ic("cc.animation.Layer")((F2=function(){function e(){this[z1]=void 0,le(this,"_stateMachine",N2,this),le(this,"name",M2,this),le(this,"weight",L2,this),le(this,"mask",B2,this),this._stateMachine=new d4}return J(e,[{key:"stateMachine",get:function(){return this._stateMachine}}]),e}(),N2=ue((D2=F2).prototype,"_stateMachine",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),M2=ue(D2.prototype,"name",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),L2=ue(D2.prototype,"weight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),B2=ue(D2.prototype,"mask",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),O2=D2))||O2;!function(e){e[e.override=0]="override",e[e.additive=1]="additive"}(J2||(J2={})),T1.AFTER_CONSUMED;var v4=Ic("cc.animation.PlainVariable")((H2=function(){function e(e){if(le(this,"_type",G2,this),le(this,"_value",k2,this),void 0!==e)switch(this._type=e,e){default:break;case E1.FLOAT:case E1.INTEGER:this._value=0;break;case E1.BOOLEAN:this._value=!1}}return J(e,[{key:"type",get:function(){return this._type}},{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),e}(),G2=ue((U2=H2).prototype,"_type",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return E1.FLOAT}}),k2=ue(U2.prototype,"_value",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),z2=U2))||z2,g4=Ic("cc.animation.TriggerVariable")((X2=function(){function e(){le(this,"_flags",j2,this)}return J(e,[{key:"type",get:function(){return E1.TRIGGER}},{key:"value",get:function(){return!!((1&this._flags)>>0)},set:function(e){e?this._flags|=1:this._flags&=-2}},{key:"resetMode",get:function(){return(6&this._flags)>>1},set:function(e){this._flags&=-7,this._flags|=e<<1}}]),e}(),j2=ue((W2=X2).prototype,"_flags",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),V2=W2))||V2,y4=Ic("cc.animation.AnimationGraph")((Z2=function(e){function t(){var t;return le(t=e.call(this)||this,"_layers",K2,ae(t)),le(t,"_variables",Q2,ae(t)),t}ee(t,e);var n=t.prototype;return n.onLoaded=function(){for(var e=this._layers,t=e.length,n=0;n<t;++n)e[n].stateMachine.__callOnAfterDeserializeRecursive()},n.addLayer=function(){var e=new m4;return this._layers.push(e),e},n.removeLayer=function(e){rt.removeAt(this._layers,e)},n.moveLayer=function(e,t){!function(e,t,n){if(st(e,t),st(e,n),t===n)return e;var i=e[t];if(t<n)for(var r=t+1;r<=n;++r)e[r-1]=e[r];else for(var o=t;o!==n;--o)e[o]=e[o-1];e[n]=i}(this._layers,e,t)},n.addBoolean=function(e,t){void 0===t&&(t=!1);var n=new v4(E1.BOOLEAN);n.value=t,this._variables[e]=n},n.addFloat=function(e,t){void 0===t&&(t=0);var n=new v4(E1.FLOAT);n.value=t,this._variables[e]=n},n.addInteger=function(e,t){void 0===t&&(t=0);var n=new v4(E1.INTEGER);n.value=t,this._variables[e]=n},n.addTrigger=function(e,t,n){void 0===t&&(t=!1),void 0===n&&(n=T1.AFTER_CONSUMED);var i=new g4;i.resetMode=n,i.value=t,this._variables[e]=i},n.removeVariable=function(e){delete this._variables[e]},n.getVariable=function(e){return this._variables[e]},J(t,[{key:"layers",get:function(){return this._layers}},{key:"variables",get:function(){return Object.entries(this._variables)}}]),t}(Mu),K2=ue((Y2=Z2).prototype,"_layers",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Q2=ue(Y2.prototype,"_variables",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),q2=Y2))||q2,S4=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,o=e.length;r<o;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?C4:dc}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());h.RatioSampler=S4;var x4=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(t.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=N4(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-n,s=(e-n)/a;if(o&&(s=T4(s,o)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function E4(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function T4(e,t){if("string"==typeof t){var n=nf[t];n?e=n(e):M(3906,t)}else Array.isArray(t)&&(e=Qf(t,e));return e}function C4(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var o=(t=(t-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}x4.Linear=null,h.AnimCurve=x4,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),h.sampleAnimationCurve=E4;var A4,b4,w4,I4,P4,R4,O4,D4,N4=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return dn;if("object"==typeof t&&t.constructor){if(t instanceof Gn)return n=new Gn,function(e,t,i){return Gn.slerp(n,e,t,i)};if(t instanceof _t)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return dn;if("function"==typeof t.lerp)return e}var n}}}(),M4=Ic("cc.animation.UntypedTrackChannel")((I4=function(e){function t(){var t;return le(t=e.call(this,new df)||this,"property",w4,ae(t)),t}return ee(t,e),t}(s1),w4=ue((b4=I4).prototype,"property",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),A4=b4))||A4,L4=Ic("cc.animation.UntypedTrack")((D4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_channels",O4,ae(t)),t}ee(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[e1]=function(e){var t=this;if(!e.getValue)throw new Error(z(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(z(3931));case i instanceof Jn:return new b1(n("x"),n("y"));case i instanceof Nn:return new w1(n("x"),n("y"),n("z"));case i instanceof ni:return new I1(n("x"),n("y"),n("z"),n("w"));case i instanceof On:return new N1(n("r"),n("g"),n("b"),n("a"));case i instanceof oi:return new B1(n("width"),n("height"))}},n.addChannel=function(e){var t=new M4;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new A1;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new D1,h=u.channels(),_=h[0],f=h[1],d=h[2],p=h[3];return n("r",_),n("g",f),n("b",d),n("a",p),n("x",_),n("y",f),n("z",d),n("w",p),u;case"size":}return null},t}(a1),O4=ue((R4=D4).prototype,"_channels",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),P4=R4))||P4,B4=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(e,t,n){for(var i,r=new r1,o=ce(t);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof p0?r.toHierarchy(a.path):a instanceof m0?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=n},a=r.map((function(e){var n=new L4;return o(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new z4(s,l.length),f=function(e){o(e,r.modifiers,r.valueAdapter)},d=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return D(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return D(3933),"continue";var p=r.modifiers[0],m=a[r.commonTarget].addChannel(p).curve;d=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void D(3934);var e;if(d)e=d;else{var n=new u1;f(n),t.push(n),e=n.channel.curve}var i=h?pc.LINEAR:pc.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void _.convert(e)}if("object"==typeof u)switch(!0){default:break;case F4(c,Jn):case F4(c,Nn):case F4(c,ni):var r=u instanceof Jn?2:u instanceof Nn?3:4,o=new A1;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,p=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?pc.LINEAR:pc.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),_.convert(s),p.assignSorted(l,c.map((function(e){return y(e.y)}))),_.convert(p)}return void t.push(o);case F4(c,Gn):var S=new P1;f(S);var x=h?Vf.SLERP:Vf.CONSTANT;return S.channel.curve.assignSorted(l,c.map((function(e){return{value:Gn.clone(e),interpolationMode:x}}))),_.convertQuatCurve(S.channel.curve),void t.push(S);case F4(c,On):var E=new D1;f(E);var T=E.channels(),C=T[0].curve,A=T[1].curve,b=T[2].curve,w=T[3].curve,I=h?pc.LINEAR:pc.CONSTANT,P=function(e){return{value:e,interpolationMode:I}};return C.assignSorted(l,c.map((function(e){return P(e.r)}))),_.convert(C),A.assignSorted(l,c.map((function(e){return P(e.g)}))),_.convert(A),b.assignSorted(l,c.map((function(e){return P(e.b)}))),_.convert(b),w.assignSorted(l,c.map((function(e){return P(e.a)}))),_.convert(w),void t.push(E);case F4(c,oi):var R=new L1;f(R);var O=R.channels(),N=O[0].curve,M=O[1].curve,L=h?pc.LINEAR:pc.CONSTANT,B=function(e){return{value:e,interpolationMode:L}};return N.assignSorted(l,c.map((function(e){return B(e.width)}))),_.convert(N),M.assignSorted(l,c.map((function(e){return B(e.height)}))),_.convert(M),void t.push(R);case F4(c,$0):var F=new u1;f(F);var z=h?pc.CUBIC:pc.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:z}}))),void t.push(F);case F4(c,K0):case F4(c,Q0):case F4(c,Z0):var U=u instanceof K0?2:u instanceof Q0?3:4,G=new A1;f(G),G.componentsCount=U;var k=G.channels(),H=k[0],V=k[1],W=k[2],j=k[3],X=h?pc.LINEAR:pc.CONSTANT,q=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:X}};switch(U){case 4:j.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:W.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(e){return q(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(G);case c.every((function(e){return e instanceof J0})):D(3935)}var Y=new F1;f(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=ce(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new S4(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new x4(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},J(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function F4(e,t){return e.every((function(e){return e instanceof t}))}var z4=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,S,x,E,T=this._easingMethods;if(T){var C=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(T)&&T.length;for(var A=C-1,b=0;b<A;++b){var w=T[b];w&&(Array.isArray(w)?(t=w,n=e.getKeyframeTime(b),i=e.getKeyframeValue(b),r=e.getKeyframeTime(b+1),o=e.getKeyframeValue(b+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,d=void 0,p=void 0,m=void 0,v=void 0,g=void 0,y=void 0,S=void 0,x=void 0,E=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(p=c*f)/(d=s*_),S=Math.sqrt(d*d+p*p)*g,x=v/m,E=Math.sqrt(m*m+v*v)*g,i.interpolationMode=pc.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===vc.NONE?vc.RIGHT:a===vc.LEFT?vc.BOTH:a,i.rightTangent=y,i.rightTangentWeight=S,o.tangentWeightMode=function(e){return e===vc.NONE?vc.LEFT:e===vc.RIGHT?vc.BOTH:e}(o.tangentWeightMode),o.leftTangent=x,o.leftTangentWeight=E):U4(w,e,b))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var o=t[r];o&&(Array.isArray(o)?e.getKeyframeValue(r).easingMethod=o.slice():G4(o,e,r))}}}},J(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function U4(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=m3[e];r===tf.CONSTANT?i.interpolationMode=pc.CONSTANT:(i.interpolationMode=pc.LINEAR,i.easingMethod=r)}function G4(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=m3[e];i.easingMethod=r}var k4,H4,V4,W4,j4,X4,q4,Y4,K4,Q4,Z4,J4,$4,e3,t3,n3,i3,r3,o3,a3,s3,c3,l3,u3,h3,_3,f3,d3,p3,m3={constant:tf.CONSTANT,linear:tf.LINEAR,quadIn:tf.QUAD_IN,quadOut:tf.QUAD_OUT,quadInOut:tf.QUAD_IN_OUT,quadOutIn:tf.QUAD_OUT_IN,cubicIn:tf.CUBIC_IN,cubicOut:tf.CUBIC_OUT,cubicInOut:tf.CUBIC_IN_OUT,cubicOutIn:tf.CUBIC_OUT_IN,quartIn:tf.QUART_IN,quartOut:tf.QUART_OUT,quartInOut:tf.QUART_IN_OUT,quartOutIn:tf.QUART_OUT_IN,quintIn:tf.QUINT_IN,quintOut:tf.QUINT_OUT,quintInOut:tf.QUINT_IN_OUT,quintOutIn:tf.QUINT_OUT_IN,sineIn:tf.SINE_IN,sineOut:tf.SINE_OUT,sineInOut:tf.SINE_IN_OUT,sineOutIn:tf.SINE_OUT_IN,expoIn:tf.EXPO_IN,expoOut:tf.EXPO_OUT,expoInOut:tf.EXPO_IN_OUT,expoOutIn:tf.EXPO_OUT_IN,circIn:tf.CIRC_IN,circOut:tf.CIRC_OUT,circInOut:tf.CIRC_IN_OUT,circOutIn:tf.CIRC_OUT_IN,elasticIn:tf.ELASTIC_IN,elasticOut:tf.ELASTIC_OUT,elasticInOut:tf.ELASTIC_IN_OUT,elasticOutIn:tf.ELASTIC_OUT_IN,backIn:tf.BACK_IN,backOut:tf.BACK_OUT,backInOut:tf.BACK_IN_OUT,backOutIn:tf.BACK_OUT_IN,bounceIn:tf.BOUNCE_IN,bounceOut:tf.BOUNCE_OUT,bounceInOut:tf.BOUNCE_IN_OUT,bounceOutIn:tf.BOUNCE_OUT_IN,smooth:tf.SMOOTH,fade:tf.FADE};function v3(){throw new Error("split() only valid in Editor.")}Ic("cc.animation.ExoticAnimation")((V4=function(){function e(){le(this,"_nodeAnimations",H4,this)}var t=e.prototype;return t.createEvaluator=function(e){return new w3(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new g3(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return v3()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),H4=ue((k4=V4).prototype,"_nodeAnimations",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),k4));var g3=Ic("cc.animation.ExoticNodeAnimation")((Q4=function(){function e(e){le(this,"_path",X4,this),le(this,"_position",q4,this),le(this,"_rotation",Y4,this),le(this,"_scale",K4,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new C3(e,new E3(t))},t.createRotation=function(e,t){this._rotation=new C3(e,new T3(t))},t.createScale=function(e,t){this._scale=new C3(e,new E3(t))},t.createEvaluator=function(e){return new I3(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return v3()},t.toHashString=function(){var e,t,n,i,r,o;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},J(e,[{key:"path",get:function(){return this._path}}]),e}(),X4=ue((j4=Q4).prototype,"_path",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),q4=ue(j4.prototype,"_position",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y4=ue(j4.prototype,"_rotation",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),K4=ue(j4.prototype,"_scale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W4=j4))||W4;function y3(e){return e.toPrecision(2)}function S3(e){return e.map(y3).join(" ")}var x3=Ic("cc.animation.ExoticVectorLikeTrackValues")((t3=function(){function e(e){le(this,"_values",$4,this),le(this,"_isQuantized",e3,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=R3[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),o=Math.max(e,o)}));var a=o-r,s=n.from(e,(function(e){return(e-r)/a*i}));return new j3(O3(e),s,a,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():S3(t))},J(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:O3(this._values)}}]),e}(),$4=ue((J4=t3).prototype,"_values",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),e3=ue(J4.prototype,"_isQuantized",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Z4=J4))||Z4,E3=Ic("cc.animation.ExoticVec3TrackValues")(n3=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?Y3(n,e,t):Nn.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(Y3(a,e,i),Y3(a,t,r)):(Nn.fromArray(i,a,3*e),Nn.fromArray(r,a,3*t)),Nn.lerp(o,i,r,n)},t}(x3))||n3,T3=Ic("cc.animation.ExoticQuatTrackValues")(i3=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?K3(n,e,t):Gn.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(K3(a,e,i),K3(a,t,r)):(Gn.fromArray(i,a,4*e),Gn.fromArray(r,a,4*t)),Gn.slerp(o,i,r,n)},t}(x3))||i3,C3=Ic("cc.animation.ExoticTrack")((c3=function(){function e(e,t){le(this,"times",a3,this),le(this,"values",s3,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+S3(e)+"; values: "+t.toHashString()},e}(),a3=ue((o3=c3).prototype,"times",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),s3=ue(o3.prototype,"values",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r3=o3))||r3;function A3(e,t){e.length,e.length;var n=0,i=0,r=dc(e,t);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=e[o],c=e[a];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],o=e[i-1],a=_n(t,r,o),s=_n(n,r,o);this._timeOffset=a;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=A3(e,t),o=r.index,a=r.ratio,s=A3(e,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(e,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,d=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,d||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},J(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var b3,w3=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),I3=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=q3(t.times,t.values,Nn,e,"position",r)),n&&(this._rotation=q3(n.times,n.values,Gn,e,"rotation",r)),i&&(this._scale=q3(i.times,i.values,Nn,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),P3=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],o=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>o)n.just=!0,n.index=i-1;else{var a=dc(e,t);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),R3={uint8:Uint8Array,uint16:Uint16Array};function O3(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return b3.FLOAT_32;case 8:return b3.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(b3||(b3={}));var D3,N3,M3,L3,B3,F3,z3,U3,G3,k3,H3,V3,W3,j3=Ic("cc.animation.QuantizedFloatArray")((p3=function(){function e(e,t,n,i){void 0===i&&(i=0),le(this,"originalPrecision",h3,this),le(this,"min",_3,this),le(this,"extent",f3,this),le(this,"values",d3,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+y3(t)+" "+y3(n)+" "+i.join(" ")},J(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),h3=ue((u3=p3).prototype,"originalPrecision",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_3=ue(u3.prototype,"min",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),f3=ue(u3.prototype,"extent",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),d3=ue(u3.prototype,"values",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),l3=u3))||l3;function X3(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function q3(e,t,n,i,r,o){var a=new o1;a.path=(new r1).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new P3(e,t,n)}:null}function Y3(e,t,n){Nn.set(n,X3(e,3*t+0),X3(e,3*t+1),X3(e,3*t+2))}function K3(e,t,n){Gn.set(n,X3(e,4*t+0),X3(e,4*t+1),X3(e,4*t+2),X3(e,4*t+3))}function Q3(){return h.director.getAnimationManager()}var Z3=Symbol("SearchForRootBonePath"),J3=Symbol("ExoticAnimation"),$3=e("AnimationClip",Ic("cc.AnimationClip")((W3=V3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"sample",M3,ae(t)),le(t,"speed",L3,ae(t)),le(t,"wrapMode",B3,ae(t)),le(t,"enableTrsBlending",F3,ae(t)),le(t,"_duration",z3,ae(t)),le(t,"_hash",U3,ae(t)),t.frameRate=0,le(t,"_tracks",G3,ae(t)),le(t,"_exoticAnimation",k3,ae(t)),t._legacyData=void 0,t._legacyDataDirty=!1,le(t,"_events",H3,ae(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}ee(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,o=new F1;return o.path=(new r1).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(o),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new s5(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){if(!e.mask||!i.isMaskedOff(e.mask)){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=h.director.root)||void 0===t?void 0:t.dataPoolManager)&&h.director.root.dataPoolManager.releaseAnimationClip(this),sJ.destroy(this),e.prototype.destroy.call(this)},n[aJ]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Yn}))};var c=r.reduce((function(e,t){return e[t]=new n5,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var d=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return a5(n,t.property)}}),void 0),p=0;p<n;++p){var m=e+i*p;d.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Yn.copy(a[g].transforms[p],c[g].globalTransform)}for(var y=0;y<o;++y){var S=r[y];c[S].invalidate()}}return{samples:t,frames:n,joints:a}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof L4){var s=a.upgrade(e);s&&(t.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)rt.remove(i,n[l]);i.push.apply(i,t)},n[Z3]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[i1]);if(h){var _=u[e1](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new e5(a,o,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof ub){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var o=new t5,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[i1].parseTrsPath();if(h&&h.node===i){n.push(u);var _=a5(o,h.property);if(_){var f=u[e1](_);a.push({binding:_,trackEval:f})}}}return new r5(r,this._duration,o,a)}D(3924)}else D(3923)}else M(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[i1].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,o=t+1;o<n;++o){var a=e[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new B4(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][i1].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},J(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=bo(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),o=r.length,a=function(e){var o=r[e],a=o.frame/t._duration,s=n.findIndex((function(e){return e===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:J3,get:function(){return this._exoticAnimation}},{key:J3,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(Mu),V3.WrapMode=sc,M3=ue((N3=W3).prototype,"sample",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),L3=ue(N3.prototype,"speed",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),B3=ue(N3.prototype,"wrapMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sc.Normal}}),F3=ue(N3.prototype,"enableTrsBlending",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),z3=ue(N3.prototype,"_duration",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),U3=ue(N3.prototype,"_hash",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G3=ue(N3.prototype,"_tracks",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),k3=ue(N3.prototype,"_exoticAnimation",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H3=ue(N3.prototype,"_events",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),D3=N3))||D3);h.AnimationClip=$3;var e5=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var o=t[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),t5=function(){function e(){this.position=new Nn,this.scale=new Nn(1,1,1),this.rotation=new Gn,this.eulerAngles=new Nn}return e.prototype.getTransform=function(e){Yn.fromRTS(e,this.rotation,this.position,this.scale)},e}(),n5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new Yn,t}return ee(t,e),t.prototype.invalidate=function(){this._dirty=!0},J(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,Yn.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&Yn.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(t5),i5=new Yn,r5=function(){function e(e,t,n,i){this._initialTransformCache=new Yn,this._clipEndTransformCache=new Yn,this._startTransformCache=new Yn,this._endTransformCache=new Yn,this._motionTransformCache=new Yn,this._translationMotionCache=new Nn,this._rotationMotionCache=new Gn,this._scaleMotionCache=new Nn,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Yn.toRTS(n,r,i,o),Nn.add(i,i,a.position),a.setPosition(i),Gn.multiply(r,r,a.rotation),a.setRotation(r),Nn.multiply(o,o,a.scale),a.setScale(o)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);o5(n,o,a)}else{Yn.identity(n);var s=function(e,t){o5(i5,e,t),Yn.multiply(n,n,i5)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),o5(i5,h,_);for(var d=0;d<l;++d)Yn.multiply(n,n,i5);s(h,f)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function o5(e,t,n){Yn.invert(e,t),Yn.multiply(e,n,e)}function a5(e,t){switch(t){default:return;case"position":return{setValue:function(t){Nn.copy(e.position,t)}};case"rotation":return{setValue:function(t){Gn.copy(e.rotation,t)}};case"scale":return{setValue:function(t){Nn.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){Nn.copy(e.eulerAngles,t)}}}}var s5=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=l5(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=l5(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var o=this._wrapMode,a=c5(n),s=c5(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((o&ac.PingPong)===ac.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((o&ac.PingPong)===ac.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?Q3().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},e}();function c5(e){return e-(0|e)==0&&(e-=1),0|e}function l5(e,t){return dc(t,e)}var u5,h5=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(z(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},J(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),_5=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(u5||(u5={})),ht(u5);var f5=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=sc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new fc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||A("Clip "+t.name+" has zero duration."),i}ee(t,e);var n=t.prototype;return n.initialize=function(e,t,n){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var i=this._clip;if(this.duration=i.duration,this._invDuration=1/this.duration,this.speed=i.speed,this.wrapMode=i.wrapMode,this.frameRate=i.sample,this._playbackRange.min=0,this._playbackRange.max=i.duration,this._playbackDuration=i.duration,(this.wrapMode&ac.Loop)===ac.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,o,a,s=null!==(r=null!=t?t:null===(o=Q3())||void 0===o?void 0:o.blendState)&&void 0!==r?r:null;s&&(this._poseOutput=new _5(s)),this._clipEval=i.createEvaluator({target:e,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0,mask:n})}this._clipEventEval=i.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||Q3().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Q3().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(u5.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(u5.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(u5.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(u5.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new fc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(u5.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(u5.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(u5.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&ac.PingPong)===ac.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&ac.Reverse)===ac.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new fc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(e-=n)>0?e/i:-e/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&ac.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){Q3().addAnimation(this)},n._onPauseOrStop=function(){Q3().removeAnimation(this)},J(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&ac.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&ac.ShouldWrap,n=(this.wrapMode&ac.Reverse)===ac.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(h5));h.AnimationState=f5;var d5,p5,m5,v5,g5,y5=x5,S5=x5;function x5(){}d5=Ic("cc.animation.ClipMotion"),p5=hl($3),d5((g5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"clip",v5,ae(t)),t}ee(t,e);var n=t.prototype;return n[i4]=function(e){return this.clip?new G5(e,this.clip):null},n.clone=function(){var e=new t;return e.clip=this.clip,e},t}(pl),v5=ue((m5=g5).prototype,"clip",[p5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m5));var E5,T5,C5,A5,b5,w5,I5,P5,R5,O5,D5,N5,M5,L5,B5,F5,z5,U5,G5=function(){function e(e,t){this.duration=t.duration/t.speed,this._state=new f5(t),this._state.initialize(e.node,e.blendBuffer,e.mask)}var t=e.prototype;return t.getClipStatuses=function(e){var t=this,n=!1;return{next:function(){return n?{done:!0,value:void 0}:(n=!0,{done:!1,value:{__DEBUG_ID__:t.__DEBUG__ID__,clip:t._state.clip,weight:e}})}}},t.sample=function(e,t){if(0!==t){var n=this._state.duration*e;this._state.time=n,this._state.weight=t,this._state.sample(),this._state.weight=0}},J(e,[{key:"progress",get:function(){return this._state.time/this.duration}}]),e}(),k5=Ic("cc.animation.BindableNumber")((b5=function(){function e(e){void 0===e&&(e=0),le(this,"variable",C5,this),le(this,"value",A5,this),this.value=e}return e.prototype.clone=function(){var t=new e;return t.value=this.value,t.variable=this.variable,t},e}(),C5=ue((T5=b5).prototype,"variable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),A5=ue(T5.prototype,"value",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),E5=T5))||E5,H5=Ic("cc.animation.BindableBoolean")((O5=function(){function e(e){void 0===e&&(e=!1),le(this,"variable",P5,this),le(this,"value",R5,this),this.value=e}return e.prototype.clone=function(){var t=new e;return t.value=this.value,t.variable=this.variable,t},e}(),P5=ue((I5=O5).prototype,"variable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),R5=ue(I5.prototype,"value",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w5=I5))||w5;function V5(e,t,n,i,r){var o=t.variable,a=t.value;if(!o)return a;var s=e.getVar(o);if(!j5(s,o))return a;if(s.type!==n)throw new n4(o,"number");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function W5(e,t,n,i,r){var o=t.variable,a=t.value;if(!o)return a;var s=e.getVar(o);if(!j5(s,o))return a;if(n!==E1.FLOAT&&n!==E1.INTEGER)throw new n4(o,"number or integer");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function j5(e,t){if(e)return!0;throw new t4(t)}var X5,q5,Y5,K5,Q5,Z5,J5,$5,e8,t8,n8,i8=Ic("cc.animation.AnimationBlendItem")((L5=function(){function e(){le(this,"motion",M5,this)}var t=e.prototype;return t.clone=function(){var t=new e;return this._assign(t),t},t._assign=function(e){var t,n;return e.motion=null!==(t=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==t?t:null,e},e}(),M5=ue((N5=L5).prototype,"motion",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D5=N5))||D5,r8=Ic("cc.animation.AnimationBlend")((U5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"name",z5,ae(t)),t}return ee(t,e),t}(pl),z5=ue((F5=U5).prototype,"name",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),B5=F5))||B5,o8=function(){function e(e,t,n,i){this._childEvaluators=n.map((function(t){var n,i;return null!==(n=null===(i=t.motion)||void 0===i?void 0:i[i4](e))&&void 0!==n?n:null})),this._weights=new Array(this._childEvaluators.length).fill(0),this._inputs=[].concat(i)}var t=e.prototype;return t.getChildWeight=function(e){return this._weights[e]},t.getChildMotionEval=function(e){return this._childEvaluators[e]},t.getClipStatuses=function(e){var t,n=this._childEvaluators,i=this._weights,r=n.length,o=0;return{next:function(){for(;;){if(t){var a=t.next();if(!a.done)return a}if(o>=r)return{done:!0,value:void 0};var s=n[o];t=null==s?void 0:s.getClipStatuses(e*i[o]),++o}}}},t.sample=function(e,t){for(var n=0;n<this._childEvaluators.length;++n){var i;null===(i=this._childEvaluators[n])||void 0===i||i.sample(e,t*this._weights[n])}},t.setInput=function(e,t){this._inputs[t]=e,this.doEval()},t.doEval=function(){this.eval(this._weights,this._inputs)},t.eval=function(){},J(e,[{key:"childCount",get:function(){return this._weights.length}},{key:"duration",get:function(){for(var e=0,t=0;t<this._childEvaluators.length;++t){var n,i;e+=(null!==(n=null===(i=this._childEvaluators[t])||void 0===i?void 0:i.duration)&&void 0!==n?n:0)*this._weights[t]}return e}}]),e}(),a8=Ic("cc.animation.AnimationBlend1DItem")((K5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"threshold",Y5,ae(t)),t}ee(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),t.threshold=this.threshold,t},t}(i8),Y5=ue((q5=K5).prototype,"threshold",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X5=q5))||X5,s8=(Ic("cc.animation.AnimationBlend1D")((e8=$5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_items",Z5,ae(t)),le(t,"param",J5,ae(t)),t}ee(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){return e.clone()})),e.param=this.param.clone(),e},n[i4]=function(e){var t=new s8(e,this,this._items,this._items.map((function(e){return e.threshold})),0),n=V5(e,this.param,E1.FLOAT,t.setInput,t,0);return t.setInput(n,0),t},J(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e).sort((function(e,t){return e.threshold-t.threshold}))}}]),t}(r8),$5.Item=a8,Z5=ue((Q5=e8).prototype,"_items",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),J5=ue(Q5.prototype,"param",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new k5}}),Q5)),function(e){function t(t,n,i,r,o){var a;return(a=e.call(this,t,n,i,[o])||this)._thresholds=r,a.doEval(),a}return ee(t,e),t.prototype.eval=function(e,t){var n=t[0];!function(e,t,n){if(e.fill(0),0===t.length);else if(n<=t[0])e[0]=1;else if(n>=t[t.length-1])e[e.length-1]=1;else{for(var i=0,r=1;r<t.length;++r)if(t[r]>n){i=r;break}var o=t[i-1],a=t[i],s=a-o;e[i-1]=(a-n)/s,e[i]=(n-o)/s}}(e,this._thresholds,n)},t}(o8)),c8=(t8=new Jn,n8={wA:0,wB:0},function(e,t,n){if(e.length,t.length,0!==t.length)if(1!==t.length)if(Jn.strictEquals(n,Jn.ZERO)){var i=t.findIndex((function(e){return Jn.strictEquals(e,Jn.ZERO)}));i>=0?e[i]=1:e.fill(1/t.length)}else{for(var r=-1,o=-1,a=-1,s=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=n.x,u=n.y,h=0;h<t.length;++h){var _=t[h];if(Jn.equals(_,Jn.ZERO))a=h;else{var f=Jn.normalize(t8,_),d=Jn.dot(f,n);f.x*u-f.y*l>0?d>=c&&(c=d,r=h):d>=s&&(s=d,o=h)}}var p=0;if(r<0||o<0)p=1;else{var m=(C=t[r],A=t[o],b=n,w=n8,(I=Jn.cross(C,A))?(w.wA=Jn.cross(b,A)/I,w.wB=Jn.cross(b,C)/-I):(w.wA=0,w.wB=0),w),v=m.wA,g=m.wB,y=0,S=0,x=v+g;x>1?(y=v/x,S=g/x):x<0?(y=0,S=0,p=1):(y=v,S=g,p=1-x),e[r]=y,e[o]=S}if(p>0)if(a>=0)e[a]=p;else for(var E=p/e.length,T=0;T<e.length;++T)e[T]+=E}else e[0]=1;var C,A,b,w,I});function l8(e,t,n,i){e.fill(0);for(var r=new Jn(0,0),o=new Jn(0,0),a=0,s=t.length,c=0;c<s;++c){for(var l=Number.MAX_VALUE,u=!1,h=0;h<s;++h)if(c!==h){i(t[c],t[h],n,r,o);var _=1-Jn.dot(r,o)/Jn.lengthSqr(o);if(_<0){u=!0;break}l=Math.min(l,_)}u||(e[c]=l,a+=l)}a>0&&e.forEach((function(t,n){return e[n]=t/a}))}var u8,h8,_8,f8,d8,p8,m8,v8,g8,y8,S8,x8,E8,T8,C8,A8,b8,w8,I8=function(e,t,n,i,r){Jn.subtract(i,n,e),Jn.subtract(r,t,e)},P8=(u8=new Nn(0,0,0),h8=new Nn(0,0,0),_8=new Nn(0,0,0),f8=new Nn(0,0,0),d8=new Nn(0,0,0),p8=new Nn(0,0,0),function(e,t,n,i,r){var o=0,a=0,s=2;Nn.set(_8,n.x,n.y,0),Jn.equals(e,Jn.ZERO)?(o=Jn.angle(n,t),a=0,s=1):Jn.equals(t,Jn.ZERO)?(a=o=Jn.angle(n,e),s=1):(o=Jn.angle(e,t))<=0?a=0:Jn.equals(n,Jn.ZERO)?a=o:(Nn.set(f8,e.x,e.y,0),Nn.set(d8,t.x,t.y,0),Nn.set(p8,n.x,n.y,0),Nn.cross(u8,f8,d8),Nn.projectOnPlane(_8,p8,u8),a=Nn.angle(f8,_8),o<.99*Math.PI&&Nn.dot(Nn.cross(h8,f8,_8),u8)<0&&(a=-a));var c=Jn.len(e),l=Jn.len(t),u=(l+c)/2;Jn.set(r,(l-c)/u,o*s),Jn.set(i,(Nn.len(_8)-c)/u,a*s)});!function(e){e[e.SIMPLE_DIRECTIONAL=0]="SIMPLE_DIRECTIONAL",e[e.FREEFORM_CARTESIAN=1]="FREEFORM_CARTESIAN",e[e.FREEFORM_DIRECTIONAL=2]="FREEFORM_DIRECTIONAL"}(w8||(w8={})),ht(w8);var R8,O8,D8,N8,M8,L8,B8,F8,z8,U8,G8,k8,H8,V8,W8,j8,X8,q8,Y8,K8,Q8,Z8,J8,$8,e6,t6,n6,i6,r6,o6,a6,s6=Ic("cc.animation.AnimationBlend2DItem")((y8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"threshold",g8,ae(t)),t}ee(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),Jn.copy(t.threshold,this.threshold),t},t}(i8),g8=ue((v8=y8).prototype,"threshold",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn}}),m8=v8))||m8,c6=(Ic("cc.animation.AnimationBlend2D")((b8=A8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"algorithm",x8,ae(t)),le(t,"_items",E8,ae(t)),le(t,"paramX",T8,ae(t)),le(t,"paramY",C8,ae(t)),t}ee(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){var t;return null!==(t=null==e?void 0:e.clone())&&void 0!==t?t:null})),e.paramX=this.paramX.clone(),e.paramY=this.paramY.clone(),e},n[i4]=function(e){var t=new c6(e,this,this._items,this._items.map((function(e){return e.threshold})),this.algorithm,[0,0]),n=V5(e,this.paramX,E1.FLOAT,t.setInput,t,0),i=V5(e,this.paramY,E1.FLOAT,t.setInput,t,1);return t.setInput(n,0),t.setInput(i,1),t},J(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e)}}]),t}(r8),A8.Algorithm=w8,A8.Item=s6,x8=ue((S8=b8).prototype,"algorithm",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w8.SIMPLE_DIRECTIONAL}}),E8=ue(S8.prototype,"_items",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T8=ue(S8.prototype,"paramX",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new k5}}),C8=ue(S8.prototype,"paramY",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new k5}}),S8)),function(e){function t(t,n,i,r,o,a){var s;return(s=e.call(this,t,n,i,a)||this)._thresholds=void 0,s._algorithm=void 0,s._value=new Jn,s._thresholds=r,s._algorithm=o,s.doEval(),s}return ee(t,e),t.prototype.eval=function(e,t){var n=t[0],i=t[1];switch(Jn.set(this._value,n,i),e.fill(0),this._algorithm){case w8.SIMPLE_DIRECTIONAL:c8(e,this._thresholds,this._value);break;case w8.FREEFORM_CARTESIAN:!function(e,t,n){l8(e,t,n,I8)}(e,this._thresholds,this._value);break;case w8.FREEFORM_DIRECTIONAL:!function(e,t,n){l8(e,t,n,P8)}(e,this._thresholds,this._value)}},t}(o8)),l6=Ic("cc.animation.AnimationBlendDirectItem")((N8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"weight",D8,ae(t)),t}ee(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),t.weight=this.weight,t},t}(i8),D8=ue((O8=N8).prototype,"weight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),R8=O8))||R8,u6=(Ic("cc.animation.AnimationBlendDirect")((F8=B8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_items",L8,ae(t)),t}ee(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){var t;return null!==(t=null==e?void 0:e.clone())&&void 0!==t?t:null})),e},n[i4]=function(e){return new u6(e,this,this._items,this._items.map((function(e){return e.weight})))},J(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e)}}]),t}(r8),B8.Item=l6,L8=ue((M8=F8).prototype,"_items",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),M8)),function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).doEval(),t}return ee(t,e),t.prototype.eval=function(e,t){for(var n=e.length,i=0;i<n;++i)e[i]=t[i]},t}(o8)),h6=(Ic("cc.animation.AnimationMask")((G8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_jointMasks",U8,ae(t)),t}ee(t,e);var n=t.prototype;return n.addJoint=function(e,t){var n=new h6;n.path=e,n.enabled=t,this._jointMasks.push(n)},n.removeJoint=function(e){pe(this._jointMasks,(function(t){return t.path===e}))},n.clear=function(){this._jointMasks.length=0},n.filterDisabledNodes=function(e){for(var t=this._jointMasks,n=t.length,i=new Set,r=0;r<n;++r){var o=t[r],a=o.path;if(!o.enabled){var s=e.getChildByPath(a);s&&i.add(s)}}return i},J(t,[{key:"joints",get:function(){return this._jointMasks},set:function(e){this.clear();for(var t,n=ce(e);!(t=n()).done;){var i=t.value;this.addJoint(i.path,i.enabled)}}}]),t}(Mu),U8=ue((z8=G8).prototype,"_jointMasks",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ue(z8.prototype,"joints",[qc],Object.getOwnPropertyDescriptor(z8.prototype,"joints"),z8.prototype),z8)),Ic("cc.JointMask")((V8=ue((H8=function(){le(this,"path",V8,this),le(this,"enabled",W8,this)}).prototype,"path",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),W8=ue(H8.prototype,"enabled",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),k8=H8))||k8);!function(e){e[e.EQUAL_TO=0]="EQUAL_TO",e[e.NOT_EQUAL_TO=1]="NOT_EQUAL_TO",e[e.LESS_THAN=2]="LESS_THAN",e[e.LESS_THAN_OR_EQUAL_TO=3]="LESS_THAN_OR_EQUAL_TO",e[e.GREATER_THAN=4]="GREATER_THAN",e[e.GREATER_THAN_OR_EQUAL_TO=5]="GREATER_THAN_OR_EQUAL_TO"}(a6||(a6={})),Ic("cc.animation.BinaryCondition")((Q8=K8=function(){function e(){le(this,"operator",X8,this),le(this,"lhs",q8,this),le(this,"rhs",Y8,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.operator=this.operator,t.lhs=this.lhs.clone(),t.rhs=this.rhs.clone(),t},t[i4]=function(e){var t=this.operator,n=this.lhs,i=this.rhs,r=new f6(t,0,0),o=W5(e,n,E1.FLOAT,r.setLhs,r),a=W5(e,i,E1.FLOAT,r.setRhs,r);return r.reset(o,a),r},e}(),K8.Operator=a6,X8=ue((j8=Q8).prototype,"operator",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a6.EQUAL_TO}}),q8=ue(j8.prototype,"lhs",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new k5}}),Y8=ue(j8.prototype,"rhs",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new k5}}),j8));var _6,f6=function(){function e(e,t,n){this._operator=e,this._lhs=t,this._rhs=n,this._eval()}var t=e.prototype;return t.reset=function(e,t){this._lhs=e,this._rhs=t,this._eval()},t.setLhs=function(e){this._lhs=e,this._eval()},t.setRhs=function(e){this._rhs=e,this._eval()},t.eval=function(){return this._result},t._eval=function(){var e=this._lhs,t=this._rhs;switch(this._operator){default:case a6.EQUAL_TO:this._result=e===t;break;case a6.NOT_EQUAL_TO:this._result=e!==t;break;case a6.LESS_THAN:this._result=e<t;break;case a6.LESS_THAN_OR_EQUAL_TO:this._result=e<=t;break;case a6.GREATER_THAN:this._result=e>t;break;case a6.GREATER_THAN_OR_EQUAL_TO:this._result=e>=t}},e}();!function(e){e[e.TRUTHY=0]="TRUTHY",e[e.FALSY=1]="FALSY"}(_6||(_6={})),Ic("cc.animation.UnaryCondition")((t6=e6=function(){function e(){le(this,"operator",J8,this),le(this,"operand",$8,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.operator=this.operator,t.operand=this.operand.clone(),t},t[i4]=function(e){var t=this.operator,n=this.operand,i=new p6(t,!1),r=V5(e,n,E1.BOOLEAN,i.setOperand,i);return i.reset(r),i},e}(),e6.Operator=_6,J8=ue((Z8=t6).prototype,"operator",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _6.TRUTHY}}),$8=ue(Z8.prototype,"operand",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H5}}),Z8));var d6,p6=function(){function e(e,t){this._operator=e,this._operand=t,this._eval()}var t=e.prototype;return t.reset=function(e){this.setOperand(e)},t.setOperand=function(e){this._operand=e,this._eval()},t.eval=function(){return this._result},t._eval=function(){var e=this._operand;switch(this._operator){default:case _6.TRUTHY:this._result=!!e;break;case _6.FALSY:this._result=!e}},e}(),m6=Ic("cc.animation.TriggerCondition")((o6=function(){function e(){le(this,"trigger",r6,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.trigger=this.trigger,t},t[i4]=function(e){var t=new v6(!1),n=e.getVar(this.trigger);return j5(n,this.trigger)&&(function(e,t){if(e!==E1.TRIGGER)throw new n4(t,"trigger")}(n.type,this.trigger),t.setTrigger(n.bind(t.setTrigger,t))),t},e}(),r6=ue((i6=o6).prototype,"trigger",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),n6=i6))||n6,v6=function(){function e(e){this._triggered=!1,this._triggered=e}var t=e.prototype;return t.setTrigger=function(e){this._triggered=e},t.eval=function(){return this._triggered},e}(),g6=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new y6(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=this.createNodeBlendState(),this._nodeBlendStates.set(e,n)),n.refProperty(e,t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),y6=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},J(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}();!function(e){e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.EULER_ANGLES=8]="EULER_ANGLES"}(d6||(d6={}));var S6,x6=d6.POSITION|d6.ROTATION|d6.SCALE|d6.EULER_ANGLES,E6=function(){function e(){this.refCount=0,this.accumulatedWeight=0,this.result=new Nn}var t=e.prototype;return t.blend=function(e,t){this.accumulatedWeight=O6(this.result,this.result,this.accumulatedWeight,e,t)},t.reset=function(){this.accumulatedWeight=0,Nn.zero(this.result)},e}(),T6=function(){function e(){this.refCount=0,this.accumulatedWeight=0,this.result=new Gn}var t=e.prototype;return t.blend=function(e,t){this.accumulatedWeight=D6(this.result,this.result,this.accumulatedWeight,e,t)},t.reset=function(){this.accumulatedWeight=0,Gn.identity(this.result)},e}(),C6=function(){function e(){this._transformApplyFlags=0,this._properties={}}var t=e.prototype;return t.refProperty=function(e,t){var n,i,r,o=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":r=null!==(n=o[t])&&void 0!==n?n:o[t]=this._createVec3BlendState(e[t]);break;case"rotation":r=null!==(i=o[t])&&void 0!==i?i:o[t]=this._createQuatBlendState(e.rotation)}return++r.refCount,r},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._transformApplyFlags,o=this._properties,a=o.position,s=o.scale,c=o.rotation,l=o.eulerAngles;r&&(a&&r&d6.POSITION&&(t=a.result),s&&r&d6.SCALE&&(n=s.result),l&&r&d6.EULER_ANGLES&&(i=l.result),c&&r&d6.ROTATION&&(i=c.result),(i||t||n)&&e.setRTS(i,t,n),this._transformApplyFlags=0)},J(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),A6=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.apply=function(t){var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;i&&i.accumulatedWeight&&(this._transformApplyFlags|=d6.POSITION,i.accumulatedWeight<1&&i.blend(t.position,1-i.accumulatedWeight)),r&&r.accumulatedWeight&&(this._transformApplyFlags|=d6.SCALE,r.accumulatedWeight<1&&r.blend(t.scale,1-r.accumulatedWeight)),a&&a.accumulatedWeight&&(this._transformApplyFlags|=d6.EULER_ANGLES,a.accumulatedWeight<1&&a.blend(t.eulerAngles,1-a.accumulatedWeight)),o&&o.accumulatedWeight&&(this._transformApplyFlags|=d6.ROTATION,o.accumulatedWeight<1&&o.blend(t.rotation,1-o.accumulatedWeight)),e.prototype.apply.call(this,t),null==i||i.reset(),null==r||r.reset(),null==o||o.reset(),null==a||a.reset()},n._createVec3BlendState=function(){return new E6},n._createQuatBlendState=function(){return new T6},t}(C6),b6=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t.prototype.createNodeBlendState=function(){return new A6},t}(g6),w6=function(){function e(e){this.refCount=0,this.result=new Nn,this._defaultValue=new Nn,this._clipBlendResult=new Nn,this._accumulatedWeight=0,Nn.copy(this._defaultValue,e),Nn.copy(this.result,e)}var t=e.prototype;return t.blend=function(e,t){this._accumulatedWeight=O6(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)},t.commitLayerChange=function(e){var t=this.result,n=this._clipBlendResult,i=this._accumulatedWeight;i<1&&this.blend(this._defaultValue,1-i),Nn.lerp(t,t,n,e),Nn.zero(this._clipBlendResult),this._accumulatedWeight=0},t.reset=function(){Nn.copy(this.result,this._defaultValue)},e}(),I6=function(){function e(e){this.refCount=0,this.result=new Gn,this._defaultValue=new Gn,this._clipBlendResult=new Gn,this._accumulatedWeight=0,Gn.copy(this._defaultValue,e),Gn.copy(this.result,e)}var t=e.prototype;return t.blend=function(e,t){this._accumulatedWeight=D6(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)},t.commitLayerChange=function(e){var t=this.result,n=this._clipBlendResult,i=this._accumulatedWeight;i<1&&this.blend(this._defaultValue,1-i),Gn.slerp(t,t,n,e),Gn.identity(this._clipBlendResult),this._accumulatedWeight=0},t.reset=function(){Gn.copy(this.result,this._defaultValue)},e}(),P6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._layerMask=-1>>>0,t}ee(t,e);var n=t.prototype;return n.setLayerMask=function(e){this._layerMask&=~(1<<e)},n.commitLayerChanges=function(e,t){if(this._layerMask&1<<e){var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;i&&i.commitLayerChange(t),r&&r.commitLayerChange(t),o&&o.commitLayerChange(t),a&&a.commitLayerChange(t)}},n.apply=function(t){this._transformApplyFlags=x6,e.prototype.apply.call(this,t);var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;null==i||i.reset(),null==r||r.reset(),null==o||o.reset(),null==a||a.reset()},n._createVec3BlendState=function(e){return new w6(e)},n._createQuatBlendState=function(e){return new I6(e)},t}(C6),R6=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.setMask=function(e,t){this._nodeBlendStates.forEach((function(n,i){t.has(i)&&n.setLayerMask(e)}))},n.commitLayerChanges=function(e,t){this._nodeBlendStates.forEach((function(n){n.commitLayerChanges(e,t)}))},n.createNodeBlendState=function(){return new P6},t}(g6);function O6(e,t,n,i,r){var o=n+r;if(1!==r||n){if(o){var a=r/o;Nn.lerp(e,e,i,a)}}else Nn.copy(e,i);return o}function D6(e,t,n,i,r){var o=n+r;if(1!==r||n){if(o){var a=r/o;Gn.slerp(e,t,i,a)}}else Gn.copy(e,i);return o}var N6,M6,L6=Ic("cc.animation.StateMachineComponent")(S6=function(){function e(){}var t=e.prototype;return t.onMotionStateEnter=function(){},t.onMotionStateExit=function(){},t.onMotionStateUpdate=function(){},t.onStateMachineEnter=function(){},t.onStateMachineExit=function(){},e}())||S6,B6=function(){function e(e,t,n){var i=this;this._blendBuffer=new R6,this._currentTransitionCache={duration:0,time:0},this._varInstances={},this._hasAutoTrigger=!1;for(var r,o=ce(e.variables);!(r=o()).done;){var a=r.value,s=a[0],c=a[1],l=this._varInstances[s]=new $2(c.type,c.value);if(c.type===E1.TRIGGER){var u=c.resetMode;l.resetMode=u,u===T1.NEXT_FRAME_OR_AFTER_CONSUMED&&(this._hasAutoTrigger=!0)}}for(var h={controller:n,blendBuffer:this._blendBuffer,node:t,getVar:function(e){return i._varInstances[e]},triggerResetFn:function(e){i.setValue(e,!1)}},_=(this._layerEvaluations=e.layers.map((function(e){var t;return new F6(e,$({},h,{mask:null!==(t=e.mask)&&void 0!==t?t:void 0}))}))).length,f=0;f<_;++f){var d=e.layers[f].mask;if(d){var p=d.filterDisabledNodes(h.node);this._blendBuffer.setMask(f,p)}}}var t=e.prototype;return t.update=function(e){for(var t=this._blendBuffer,n=this._layerEvaluations,i=n.length,r=0;r<i;++r){var o=n[r];o.update(e),t.commitLayerChanges(r,o.weight*o.passthroughWeight)}if(this._hasAutoTrigger){var a=this._varInstances;for(var s in a){var c=a[s];c.type===E1.TRIGGER&&c.resetMode===T1.NEXT_FRAME_OR_AFTER_CONSUMED&&(c.value=!1)}}this._blendBuffer.apply()},t.getVariables=function(){return Object.entries(this._varInstances)},t.getCurrentStateStatus=function(e){return this._layerEvaluations[e].getCurrentStateStatus()},t.getCurrentClipStatuses=function(e){return this._layerEvaluations[e].getCurrentClipStatuses()},t.getCurrentTransition=function(e){var t=this._layerEvaluations,n=this._currentTransitionCache;return t[e].getCurrentTransition(n)?n:null},t.getNextStateStatus=function(e){return this._layerEvaluations[e].getNextStateStatus()},t.getNextClipStatuses=function(e){return this.getCurrentTransition(e),this._layerEvaluations[e].getNextClipStatuses()},t.getValue=function(e){var t=this._varInstances[e];return t?t.value:void 0},t.setValue=function(e,t){var n=this._varInstances[e];n&&(n.value=t)},t.setLayerWeight=function(e,t){this._layerEvaluations[e].weight=t},e}(),F6=function(){function e(e,t){this.passthroughWeight=1,this._nodes=[],this._topLevelEntry=void 0,this._topLevelExit=void 0,this._currentNode=void 0,this._currentTransitionToNode=null,this._currentTransitionPath=[],this._transitionProgress=0,this._fromWeight=0,this._toWeight=0,this._fromUpdated=!1,this._toUpdated=!1,this.name=e.name,this._controller=t.controller,this.weight=e.weight;var n=this._addStateMachine(e.stateMachine,null,$({},t),e.name),i=n.entry,r=n.exit;this._topLevelEntry=i,this._topLevelExit=r,this._currentNode=i,this._resetTrigger=t.triggerResetFn}var t=e.prototype;return t.update=function(e){this.exited||(this._fromWeight=1,this._toWeight=0,this._eval(e),this._sample())},t.getCurrentStateStatus=function(){var e=this._currentNode;return e.kind===M6.animation?e.getFromPortStatus():null},t.getCurrentClipStatuses=function(){var e=this._currentNode;return e.kind===M6.animation?e.getClipStatuses(this._fromWeight):U6},t.getCurrentTransition=function(e){var t=this._currentTransitionPath;if(0!==t.length){if(t[t.length-1].to.kind!==M6.animation)return!1;var n=t[0],i=n.duration,r=n.normalizedDuration,o=e.duration=r?i*(this._currentNode.kind===M6.animation?this._currentNode.duration:0):i;return e.time=this._transitionProgress*o,!0}return!1},t.getNextStateStatus=function(){return this._currentTransitionToNode&&(this._currentTransitionToNode.kind,M6.empty),this._currentTransitionToNode.getToPortStatus()},t.getNextClipStatuses=function(){var e,t=this._currentTransitionPath,n=t[t.length-1].to;return n.kind,M6.animation,null!==(e=n.getClipStatuses(this._toWeight))&&void 0!==e?e:U6},t._addStateMachine=function(e,t,n,i){for(var r,o,a,s=this,c=Array.from(e.states()),l=c.map((function(t){return t instanceof c4?new X6(t,n):t===e.entryState?r=new o7(t,M6.entry,t.name):t===e.exitState?a=new o7(t,M6.exit,t.name):t===e.anyState?o=new o7(t,M6.any,t.name):t instanceof _4?new a7(t):null})),u={components:null,parent:t,entry:r,exit:a,any:o},h=0;h<c.length;++h){var _=l[h];_&&(_.stateMachine=u)}for(var f=c.map((function(e){if(e instanceof p4){var t=s._addStateMachine(e.stateMachine,u,n,i+"/"+e.name);return t.components=new j6(e),t}return null})),d=0;d<c.length;++d){var p=c[d],m=e.getOutgoings(p),v=[],g=void 0;g=p instanceof p4?f[d].exit:l[d];for(var y,S=function(){var e=y.value,t=e.to,i=c.findIndex((function(t){return t===e.to})),r=void 0;r=t instanceof p4?f[i].entry:l[i];var o={conditions:e.conditions.map((function(e){return e[i4](n)})),to:r,triggers:void 0,duration:0,normalizedDuration:!1,exitCondition:0,exitConditionEnabled:!1};e instanceof h4?(o.duration=e.duration,o.normalizedDuration=e.relativeDuration,o.exitConditionEnabled=e.exitConditionEnabled,o.exitCondition=e.exitCondition):e instanceof f4&&(o.duration=e.duration),o.conditions.forEach((function(t,n){var i,r=e.conditions[n];r instanceof m6&&r.trigger&&(null!==(i=o.triggers)&&void 0!==i?i:o.triggers=[]).push(r.trigger)})),v.push(o)},x=ce(m);!(y=x()).done;)S();g.outgoingTransitions=v}return u},t._eval=function(e){if(this.exited,S5("[Layer "+this.name+"]: UpdateStart "+e+"s"),this._continueDanglingTransition())return 0;for(var t=e,n=!0,i=0;n||t>0;){if(n=!1,100===i){D(14e3,100);break}if(++i,this._currentTransitionPath.length>0){if(t-=this._updateCurrentTransition(t),this._currentNode.kind===M6.exit)break;0===this._currentTransitionPath.length&&(n=!0)}else{var r=this._currentNode,o=this._matchCurrentNodeTransition(t);if(o){var a=o.transition,s=o.requires;if(y5("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),t-=s,r.kind===M6.animation&&(r.updateFromPort(s),this._fromUpdated=!0),this._switchTo(a))break;n=!0}else y5("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),r.kind===M6.animation?(r.updateFromPort(t),this._fromUpdated=!0,t=0):t=0}}return y5("[SubStateMachine "+this.name+"]: UpdateEnd"),this._fromUpdated&&this._currentNode.kind===M6.animation&&(this._fromUpdated=!1,this._currentNode.triggerFromPortUpdate(this._controller)),this._currentTransitionToNode&&this._toUpdated&&this._currentTransitionToNode.kind===M6.animation&&(this._toUpdated=!1,this._currentTransitionToNode.triggerToPortUpdate(this._controller)),t},t._sample=function(){var e=this._currentNode,t=this._currentTransitionToNode,n=this._fromWeight,i=this._toWeight;e.kind===M6.empty?(this.passthroughWeight=i,t&&t.kind===M6.animation&&t.sampleToPort(1)):t&&t.kind===M6.empty?(this.passthroughWeight=n,e.kind===M6.animation&&e.sampleFromPort(1)):(this.passthroughWeight=1,e.kind===M6.animation&&e.sampleFromPort(n),t&&t.kind===M6.animation&&t.sampleToPort(i))},t._matchCurrentNodeTransition=function(e){var t=this._currentNode,n=1/0,i=null,r=this._matchTransition(t,t,e,H6);if(r&&(n=r.requires,i=r.transition),t.kind===M6.animation)for(var o=t.stateMachine;null!==o;o=o.parent){var a=this._matchTransition(o.any,t,e,V6);a&&a.requires<n&&(n=a.requires,i=a.transition)}return i?k6.set(i,n):null},t._matchTransition=function(e,t,n,i){e===t||(e.kind,M6.any);for(var r=e.outgoingTransitions,o=r.length,a=1/0,s=null,c=0;c<o;++c){var l=r[c],u=l.conditions,h=u.length;if(0===h){if(e.kind===M6.entry||e.kind===M6.exit)return i.set(l,0);if(!l.exitConditionEnabled)continue}var _=0;if(t.kind===M6.animation&&l.exitConditionEnabled){var f=t.duration*l.exitCondition;if((_=Math.max(f-t.fromPortTime,0))>n)continue}for(var d=!0,p=0;p<h;++p)if(!u[p].eval()){d=!1;break}if(d){if(0===_)return i.set(l,0);_<a&&(a=_,s=l)}}return s?i.set(s,a):null},t._switchTo=function(e){var t=this._currentNode;S5("[SubStateMachine "+this.name+"]: STARTED "+t.name+" -> "+e.to.name+".");var n=this._currentTransitionPath;this._consumeTransition(e),n.push(e);var i=this._matchTransitionPathUntilMotion();return!i||(this._doTransitionToMotion(i),!1)},t._continueDanglingTransition=function(){var e=this._currentTransitionPath,t=e.length;if(0===t)return!1;var n=e[t-1].to;if(n.kind!==M6.animation&&n.kind!==M6.empty){var i=this._matchTransitionPathUntilMotion();return!i||(this._doTransitionToMotion(i),!1)}return!1},t._matchTransitionPathUntilMotion=function(){for(var e=this._currentTransitionPath,t=e[e.length-1].to;t.kind!==M6.animation&&t.kind!==M6.empty;){var n=this._matchTransition(t,t,0,k6);if(!n)break;var i=n.transition;this._consumeTransition(i),e.push(i),t=i.to}return t.kind===M6.animation||t.kind===M6.empty?t:null},t._consumeTransition=function(e){var t=e.to;t.kind===M6.entry&&this._callEnterMethods(t)},t._resetTriggersAlongThePath=function(){for(var e=this._currentTransitionPath,t=e.length,n=0;n<t;++n){var i=e[n];this._resetTriggersOnTransition(i)}},t._doTransitionToMotion=function(e){this._resetTriggersAlongThePath(),this._transitionProgress=0,this._currentTransitionToNode=e,this._toUpdated=!1,e.kind===M6.animation&&e.resetToPort(),this._callEnterMethods(e)},t._updateCurrentTransition=function(e){var t,n=this._currentTransitionPath,i=this._currentTransitionToNode;n.length;var r=n[0],o=r.duration,a=r.normalizedDuration,s=this._currentNode,c=i,l=0,u=0;if(o<=0)l=0,u=1;else{s.kind===M6.animation||(s.kind,M6.empty);var h=this._transitionProgress,_=s.kind===M6.empty?o:a?o*s.duration:o,f=h*_,d=_-f;l=Math.min(d,e),u=this._transitionProgress=(f+l)/_}var p=null!==(t=null==c?void 0:c.name)&&void 0!==t?t:"<Empty>";this._fromWeight=1-u,this._toWeight=u;var m=0!==l,v=1===u;if(s.kind===M6.animation&&m&&(S5("Update "+s.name),s.updateFromPort(l),this._fromUpdated=!0),c.kind===M6.animation&&m&&(S5("Update "+c.name),c.updateToPort(l),this._toUpdated=!0),v){y5("[SubStateMachine "+this.name+"]: Transition finished:  "+s.name+" -> "+p+"."),this._callExitMethods(s);for(var g=this._currentTransitionPath,y=g.length,S=0;S<y;++S){var x=g[S].to;x.kind===M6.exit&&this._callExitMethods(x)}this._fromUpdated=this._toUpdated,this._toUpdated=!1,c.kind===M6.animation&&c.finishTransition(),this._currentNode=c,this._currentTransitionToNode=null,this._currentTransitionPath.length=0,this._fromWeight=1,this._toWeight=0}return l},t._resetTriggersOnTransition=function(e){var t=e.triggers;if(t)for(var n=t.length,i=0;i<n;++i){var r=t[i];this._resetTrigger(r)}},t._resetTrigger=function(e){(0,this._triggerReset)(e)},t._callEnterMethods=function(e){var t,n=this._controller;switch(e.kind){default:break;case M6.animation:e.components.callMotionStateEnterMethods(n,e.getToPortStatus());break;case M6.entry:null===(t=e.stateMachine.components)||void 0===t||t.callStateMachineEnterMethods(n)}},t._callExitMethods=function(e){var t,n=this._controller;switch(e.kind){default:break;case M6.animation:e.components.callMotionStateExitMethods(n,e.getFromPortStatus());break;case M6.exit:null===(t=e.stateMachine.components)||void 0===t||t.callStateMachineExitMethods(n)}},J(e,[{key:"exited",get:function(){return this._currentNode===this._topLevelExit}}]),e}(),z6=Object.freeze({next:function(){return{done:!0,value:void 0}}}),U6=Object.freeze(((N6={})[Symbol.iterator]=function(){return z6},N6)),G6=function(){function e(){this.transition=null,this.requires=0}return e.prototype.set=function(e,t){return this.transition=e,this.requires=t,this},e}(),k6=new G6,H6=new G6,V6=new G6;!function(e){e[e.entry=0]="entry",e[e.exit=1]="exit",e[e.any=2]="any",e[e.animation=3]="animation",e[e.empty=4]="empty"}(M6||(M6={}));var W6=function(e){this.name=void 0,this.outgoingTransitions=[],this.name=e.name},j6=function(){function e(e){this._components=e.instantiateComponents()}var t=e.prototype;return t.callMotionStateEnterMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateEnter",e,t)},t.callMotionStateUpdateMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateUpdate",e,t)},t.callMotionStateExitMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateExit",e,t)},t.callStateMachineEnterMethods=function(e){this._callStateMachineCallbackIfNonDefault("onStateMachineEnter",e)},t.callStateMachineExitMethods=function(e){this._callStateMachineCallbackIfNonDefault("onStateMachineExit",e)},t._callMotionStateCallbackIfNonDefault=function(e,t,n){for(var i=this._components,r=i.length,o=0;o<r;++o){var a=i[o];a[e]!==L6.prototype[e]&&a[e](t,n)}},t._callStateMachineCallbackIfNonDefault=function(e,t){for(var n=this._components,i=n.length,r=0;r<i;++r){var o=n[r];o[e]!==L6.prototype[e]&&o[e](t)}},e}(),X6=function(e){function t(t,n){var i,r,o;if((o=e.call(this,t)||this).kind=M6.animation,o._source=null,o._baseSpeed=1,o._speed=1,o._fromPort={progress:0,statusCache:{progress:0}},o._toPort={progress:0,statusCache:{progress:0}},o._baseSpeed=t.speed,o._setSpeedMultiplier(1),t.speedMultiplierEnabled&&t.speedMultiplier){var a=t.speedMultiplier,s=n.getVar(a);if(j5(s,a)){!function(e,t,n){if(e!==t)throw new n4(n,"number")}(s.type,E1.FLOAT,a),s.bind(o._setSpeedMultiplier,ae(o));var c=s.value;o._setSpeedMultiplier(c)}}var l=$({},n),u=null!==(i=null===(r=t.motion)||void 0===r?void 0:r[i4](l))&&void 0!==i?i:null;return u&&Object.defineProperty(u,"__DEBUG_ID__",{value:o.name}),o._source=u,o.components=new j6(t),o}ee(t,e);var n=t.prototype;return n.updateFromPort=function(e){this._fromPort.progress=q6(this._fromPort.progress,this.duration,e*this._speed)},n.updateToPort=function(e){this._toPort.progress=q6(this._toPort.progress,this.duration,e*this._speed)},n.triggerFromPortUpdate=function(e){this.components.callMotionStateUpdateMethods(e,this.getFromPortStatus())},n.triggerToPortUpdate=function(e){this.components.callMotionStateUpdateMethods(e,this.getToPortStatus())},n.getFromPortStatus=function(){var e=this._fromPort.statusCache;return e.progress=Y6(this._fromPort.progress),e},n.getToPortStatus=function(){var e=this._toPort.statusCache;return e.progress=Y6(this._toPort.progress),e},n.resetToPort=function(){this._toPort.progress=0},n.finishTransition=function(){this._fromPort.progress=this._toPort.progress},n.sampleFromPort=function(e){var t;null===(t=this._source)||void 0===t||t.sample(this._fromPort.progress,e)},n.sampleToPort=function(e){var t;null===(t=this._source)||void 0===t||t.sample(this._toPort.progress,e)},n.getClipStatuses=function(e){var t,n=this._source;return n?((t={})[Symbol.iterator]=function(){return n.getClipStatuses(e)},t):U6},n._setSpeedMultiplier=function(e){this._speed=this._baseSpeed*e},J(t,[{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._source)||void 0===t?void 0:t.duration)&&void 0!==e?e:0}},{key:"fromPortTime",get:function(){return this._fromPort.progress*this.duration}}]),t}(W6);function q6(e,t,n){return 0===t?0:e+n/t}function Y6(e){return e-Math.trunc(e)}var K6,Q6,Z6,J6,$6,e7,t7,n7,i7,r7,o7=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).kind=void 0,i.kind=n,i}return ee(t,e),t}(W6),a7=function(e){function t(t){var n;return(n=e.call(this,t)||this).kind=M6.empty,n}return ee(t,e),t}(W6),s7=(K6=Ic("cc.animation.AnimationController"),Q6=Hc(),Z6=Dc(y4),K6(J6=Q6((t7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"graph",e7,ae(t)),t._graphEval=null,t}ee(t,e);var n=t.prototype;return n.__preload=function(){this.graph&&(this._graphEval=new B6(this.graph,this.node,this))},n.update=function(e){var t;null===(t=this._graphEval)||void 0===t||t.update(e)},n.getVariables=function(){return this._graphEval.getVariables()},n.setValue=function(e,t){this._graphEval.setValue(e,t)},n.getValue=function(e){return this._graphEval.getValue(e)},n.getCurrentStateStatus=function(e){return this._graphEval.getCurrentStateStatus(e)},n.getCurrentClipStatuses=function(e){return this._graphEval.getCurrentClipStatuses(e)},n.getCurrentTransition=function(e){return this._graphEval.getCurrentTransition(e)},n.getNextStateStatus=function(e){return this._graphEval.getNextStateStatus(e)},n.getNextClipStatuses=function(e){return this._graphEval.getNextClipStatuses(e)},n.setLayerWeight=function(e,t){return this._graphEval.setLayerWeight(e,t)},t}(th),e7=ue(($6=t7).prototype,"graph",[Z6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J6=$6))||J6)||J6);e("animation",Object.freeze({__proto__:null,UniformProxyFactory:v0,MorphWeightValueProxy:g0,MorphWeightsValueProxy:y0,MorphWeightsAllValueProxy:S0,Track:a1,TrackPath:r1,RealTrack:u1,VectorTrack:A1,QuatTrack:P1,ColorTrack:D1,SizeTrack:L1,ObjectTrack:F1,isPropertyPath:X$,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:p0,ComponentPath:m0,CubicSplineVec2Value:K0,CubicSplineVec3Value:Q0,CubicSplineVec4Value:Z0,CubicSplineQuatValue:J0,CubicSplineNumberValue:$0,AnimationController:s7,get VariableType(){return E1},StateMachineComponent:L6}));var c7=e("AnimationManager",Ic((r7=i7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new he([]),t._crossFades=new he([]),t._delayEvents=[],t._blendStateBuffer=new b6,t._sockets=[],t}ee(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):M(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(e);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(e)}this._blendStateBuffer.apply();for(var c=h.director.getTotalFrames(),l=0,u=i.length;l<u;l++){var _=i[l],f=_.target,d=_.transform;f.matrix=AJ(d,c)}for(var p=0,m=t.length;p<m;p++){var v=t[p];v.fn.apply(v.thisArg,v.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):M(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var o=e.getChildByPath(r.path),a=r.target&&o&&bJ(o,e);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){wJ(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},J(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(KD),i7.ID="animation",n7=r7))||n7);lN.on(cN.EVENT_INIT,(function(){var e=new c7;lN.registerSystem(c7.ID,e,KD.Priority.HIGH)})),h.AnimationManager=c7;var l7,u7,h7,_7,f7,d7,p7,m7,v7,g7,y7,S7,x7,E7,T7,C7,A7,b7,w7,I7,P7=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:Q3(),n}ee(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:fn(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),de(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(h5),R7=function(t){return e({Animation:t,AnimationComponent:t}),t}((l7=Ic("cc.Animation"),u7=Xc(),h7=Rc(99),_7=Hc(),f7=hl([$3]),d7=Zc(),p7=hl($3),m7=Zc(),v7=Zc(),g7=hl([$3]),l7(y7=u7(y7=h7(y7=kc(y7=_7((A7=C7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",x7,ae(t)),t._crossFade=new P7,t._nameToState=Re(!0),le(t,"_clips",E7,ae(t)),le(t,"_defaultClip",T7,ae(t)),t._hasBeenPlayed=!1,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=Re(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&this.doPlayOrCrossFade(n,t)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return me(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void D(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void D(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return t===u5.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===u5.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===u5.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new f5(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(u5.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];O7(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(u5.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(u5.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},J(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=ce(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=ce(e);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=e.find((function(e){return O7(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return O7(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(ou(th)),C7.EventType=u5,ue((S7=A7).prototype,"clips",[f7,d7],Object.getOwnPropertyDescriptor(S7.prototype,"clips"),S7.prototype),ue(S7.prototype,"defaultClip",[p7,m7],Object.getOwnPropertyDescriptor(S7.prototype,"defaultClip"),S7.prototype),x7=ue(S7.prototype,"playOnLoad",[Bc,v7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),E7=ue(S7.prototype,"_clips",[g7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T7=ue(S7.prototype,"_defaultClip",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y7=S7))||y7)||y7)||y7)||y7)||y7));function O7(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}h.Animation=R7,h.AnimationComponent=R7,ot.setClassAlias(R7,"cc.AnimationComponent"),h.easing=nf,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(b7||(b7={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(w7||(w7={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(I7||(I7={}));var D7,N7=0;function M7(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(t.args)).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&M7(e,n)})).catch((function(){})))}function L7(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=N7++,o=e;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),t),M7(o,o._operationQueue[0])}))}}function B7(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var F7,z7,U7=function(){function e(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=e,e.volume=t}var t=e.prototype;return t.play=function(){var e=this;B7(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))},t.stop=function(){this._domAudio.pause()},J(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}}]),e}(),G7=(ue((D7=function(){function e(e){var t=this;this._domAudio=void 0,this._state=I7.INIT,this._onEnded=void 0,this._eventTarget=new _u,this._operationQueue=[],this._domAudio=e,vu.on("hide",this._onHide,this),vu.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch((function(){})),t._state=I7.INIT,t._eventTarget.emit(b7.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var t=e.prototype;return t.destroy=function(){vu.off("hide",this._onHide,this),vu.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";vu.os===lu.IOS?r="loadedmetadata":vu.browserType===au.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),t(i)},c=function(){a(),n("load audio failure - "+e)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new U7(e,n);i(t)})).catch(r)}))},t._onHide=function(){var e=this;this._state===I7.PLAYING&&this.pause().then((function(){e._state=I7.INTERRUPTED,e._eventTarget.emit(b7.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===I7.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(b7.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){return e=_n(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},t.play=function(){var e=this;return new Promise((function(t){B7(e._domAudio).then((function(){e._state=I7.PLAYING,t()})).catch((function(){}))}))},t.pause=function(){return this._domAudio.pause(),this._state=I7.PAUSED,Promise.resolve()},t.stop=function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=I7.STOPPED,t()}))},t.onInterruptionBegin=function(e){this._eventTarget.on(b7.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(b7.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(b7.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(b7.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(b7.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(b7.ENDED,e)},J(e,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return w7.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=fn(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),e}()).prototype,"seek",[L7],Object.getOwnPropertyDescriptor(D7.prototype,"seek"),D7.prototype),ue(D7.prototype,"play",[L7],Object.getOwnPropertyDescriptor(D7.prototype,"play"),D7.prototype),ue(D7.prototype,"pause",[L7],Object.getOwnPropertyDescriptor(D7.prototype,"pause"),D7.prototype),ue(D7.prototype,"stop",[L7],Object.getOwnPropertyDescriptor(D7.prototype,"stop"),D7.prototype),D7),k7=function(){function e(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e}var t=e.prototype;return t.destroy=function(){this._nativeAudio=void 0},t._now=function(){return performance.now()/1e3},t._calculateCurrentTime=function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration},t.start=function(){this._isPaused=!1,this._startTime=this._now()},t.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},t.stop=function(){this._isPaused=!0,this._startOffset=0},t.seek=function(e){this._startTime=this._now(),this._startOffset=_n(e,0,this.duration)},J(e,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),e}(),H7=new(function(){function e(){this._audioBufferDataMap={}}var t=e.prototype;return t.addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},t.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},t.getCache=function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer},t.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},e}()),V7=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,W7=function(){function e(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var t=e.prototype;return t.decodeAudioData=function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))},t.runContext=function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))},t.createBufferSource=function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n},t.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},t.setGainValue=function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t},t.connectContext=function(e){this._context&&e.connect(this._context.destination)},J(e,[{key:"currentTime",get:function(){return this._context.currentTime}}]),e}();W7.support=!!V7,W7.support&&(z7=new W7);var j7,X7,q7,Y7,K7,Q7=function(){function e(e,t,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=n,this._bufferSourceNode=z7.createBufferSource(e,!1);var i=z7.createGain(t);this._bufferSourceNode.connect(i),z7.connectContext(i)}var t=e.prototype;return t.play=function(){var e=this;this._bufferSourceNode.start(),z7.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;H7.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))},t.stop=function(){clearTimeout(this._currentTimer),H7.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},J(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]),e}(),Z7=(ue((F7=function(){function e(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=I7.INIT,this._audioTimer=void 0,this._eventTarget=new _u,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new k7(e),this._gainNode=z7.createGain(),z7.connectContext(this._gainNode),this._src=t,vu.on("hide",this._onHide,this),vu.on("show",this._onShow,this)}var t=e.prototype;return t.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),H7.tryReleasingCache(this._src),vu.off("hide",this._onHide,this),vu.off("show",this._onShow,this)},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=H7.getCache(e);if(i)return H7.retainCache(e),void t(i);var r=new XMLHttpRequest,o="load audio failed: "+e+", status: ";r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?z7.decodeAudioData(r.response).then((function(n){H7.addCache(e,n),t(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new Q7(e,n,t);i(r)})).catch(r)}))},t._onHide=function(){var e=this;this._state===I7.PLAYING&&this.pause().then((function(){e._state=I7.INTERRUPTED,e._eventTarget.emit(b7.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===I7.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(b7.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===I7.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))},t.play=function(){return this._doPlay()},t._doPlay=function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=z7.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),z7.runContext().then((function(){e._state=I7.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(b7.ENDED),e._state=I7.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))},t._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}},t.pause=function(){return this._state===I7.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=I7.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=I7.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.onInterruptionBegin=function(e){this._eventTarget.on(b7.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(b7.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(b7.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(b7.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(b7.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(b7.ENDED,e)},J(e,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return w7.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=fn(e),this._volume=e,z7.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),e}()).prototype,"seek",[L7],Object.getOwnPropertyDescriptor(F7.prototype,"seek"),F7.prototype),ue(F7.prototype,"play",[L7],Object.getOwnPropertyDescriptor(F7.prototype,"play"),F7.prototype),ue(F7.prototype,"pause",[L7],Object.getOwnPropertyDescriptor(F7.prototype,"pause"),F7.prototype),ue(F7.prototype,"stop",[L7],Object.getOwnPropertyDescriptor(F7.prototype,"stop"),F7.prototype),F7),J7=function(){function e(e){this._audio=void 0,this._audio=e}var t=e.prototype;return t.play=function(){this._audio.play()},t.stop=function(){this._audio.stop()},J(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),e}(),$7=function(){function e(e){this._player=void 0,this._player=e}e.load=function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==w7.DOM_AUDIO&&W7.support?Z7.load(t).then((function(t){i(new e(t))})).catch((function(){})):(W7.support||D(5201),G7.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))};var t=e.prototype;return t.destroy=function(){this._player.destroy()},e.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==w7.DOM_AUDIO&&W7.support?Z7.loadNative(e):(W7.support||D(5201),G7.loadNative(e))},e.loadOneShotAudio=function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==w7.DOM_AUDIO&&W7.support?Z7.loadOneShotAudio(e,t).then((function(e){i(new J7(e))})).catch(r):(W7.support||D(5201),G7.loadOneShotAudio(e,t).then((function(e){i(new J7(e))})).catch(r))}))},t.seek=function(e){return this._player.seek(e)},t.play=function(){return this._player.play()},t.pause=function(){return this._player.pause()},t.stop=function(){return this._player.stop()},t.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},t.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},t.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},t.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},t.onEnded=function(e){this._player.onEnded(e)},t.offEnded=function(e){this._player.offEnded(e)},J(e,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),e}();$7.maxAudioChannel=24;var e9=e("AudioClip",Ic("cc.AudioClip")((K7=Y7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_duration",q7,ae(t)),t._loadMode=w7.UNKNOWN_AUDIO,t._meta=null,t._player=null,t}ee(t,e);var n=t.prototype;return n.destroy=function(){var t,n=e.prototype.destroy.call(this);return null===(t=this._player)||void 0===t||t.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))},n.setVolume=function(e){this._player&&(this._player.volume=e)},n.setLoop=function(e){this._player&&(this._player.loop=e)},n.play=function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))},n.pause=function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))},n.stop=function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))},n.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&$7.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))},J(t,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=w7.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:I7.INIT}}]),t}(Mu),Y7.AudioType=w7,q7=ue((X7=K7).prototype,"_duration",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(X7.prototype,"_nativeDep",[fl],Object.getOwnPropertyDescriptor(X7.prototype,"_nativeDep"),X7.prototype),j7=X7))||j7);function t9(e,t,n){$7.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function n9(e,t,n,i){var r=new e9;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}h.AudioClip=e9,$N.register({".mp3":t9,".ogg":t9,".wav":t9,".m4a":t9}),aM.register({".mp3":n9,".ogg":n9,".wav":n9,".m4a":n9});var i9,r9,o9,a9,s9,c9,l9,u9,h9,_9,f9,d9,p9,m9,v9,g9,y9,S9,x9,E9=new(function(){function e(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var t=e.prototype;return t._findIndex=function(e,t){return e.findIndex((function(e){return e.audio===t}))},t._tryAddPlaying=function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},t.addPlaying=function(e){if(e instanceof $7){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)},t._tryRemovePlaying=function(e,t){var n=this._findIndex(e,t);return-1!==n&&(fe(e,n),!0)},t.removePlaying=function(e){if(e instanceof $7){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)},t.discardOnePlayingIfNeeded=function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<$7.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))},e}());!function(e){e.STARTED="started",e.ENDED="ended"}(x9||(x9={}));var T9=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((i9=Ic("cc.AudioSource"),r9=Xc(),o9=Hc(),a9=hl(e9),s9=hl(e9),c9=Zc(),l9=Zc(),u9=Zc(),h9=Jc(),_9=Zc(),i9(f9=r9(f9=o9((S9=y9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_clip",p9,ae(t)),t._player=null,le(t,"_loop",m9,ae(t)),le(t,"_playOnAwake",v9,ae(t)),le(t,"_volume",g9,ae(t)),t._cachedCurrentTime=0,t._operationsBeforeLoading=[],t._isLoaded=!1,t._lastSetClip=null,t}ee(t,e);var n=t.prototype;return n._syncPlayer=function(){var e=this,t=this._clip;this._isLoaded=!1,this._lastSetClip!==t&&(t?t._nativeAsset?(this._lastSetClip=t,$7.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t?(e._isLoaded=!0,e._player&&(E9.removePlaying(e._player),e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){E9.removePlaying(n),e.node.emit(x9.ENDED,e)})),n.onInterruptionBegin((function(){E9.removePlaying(n)})),n.onInterruptionEnd((function(){E9.addPlaying(n)})),e._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()},n.onDestroy=function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy(),this._player=null},n._getRootNode=function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var e,t,n=this;this._isLoaded?(E9.discardOnePlayingIfNeeded(),this.state===I7.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){E9.addPlaying(n._player),n.node.emit(x9.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){E9.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){E9.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?$7.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){E9.discardOnePlayingIfNeeded(),e.onPlay=function(){E9.addPlaying(e)},e.onEnd=function(){E9.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))},J(t,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=_n(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=_n(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.duration:0}},{key:"state",get:function(){return this._player?this._player.state:I7.INIT}},{key:"playing",get:function(){return this.state===t.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return $7.maxAudioChannel}}]),t}(th),y9.AudioState=I7,y9.EventType=x9,p9=ue((d9=S9).prototype,"_clip",[a9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m9=ue(d9.prototype,"_loop",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),v9=ue(d9.prototype,"_playOnAwake",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),g9=ue(d9.prototype,"_volume",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ue(d9.prototype,"clip",[s9,c9],Object.getOwnPropertyDescriptor(d9.prototype,"clip"),d9.prototype),ue(d9.prototype,"loop",[l9],Object.getOwnPropertyDescriptor(d9.prototype,"loop"),d9.prototype),ue(d9.prototype,"playOnAwake",[u9],Object.getOwnPropertyDescriptor(d9.prototype,"playOnAwake"),d9.prototype),ue(d9.prototype,"volume",[h9,_9],Object.getOwnPropertyDescriptor(d9.prototype,"volume"),d9.prototype),f9=d9))||f9)||f9)||f9));k(e9,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:T9,targetName:"AudioSource"}]),V(e9.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(e){return{name:e,suggest:"please use AudioSource.prototype."+e+" instead"}}))),h.AudioSourceComponent=T9,ot.setClassAlias(T9,"cc.AudioSourceComponent"),h.log=x,h.warn=E,h.error=T,h.assert=C,h._throw=w,h.logID=R,h.warnID=D,h.errorID=M,h.assertID=F,h.debug=q,h.path={join:xu,extname:Eu,mainFileName:Tu,basename:Cu,dirname:Au,changeExtname:bu,changeBasename:wu,_normalize:Iu,stripSep:Pu,get sep(){return Ru()}};var C9=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},e}());h.NodePool=C9,h.renderer=Qy;var A9,b9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&so){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&co&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},J(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Io);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(A9||(A9={}));var w9=function(){function e(){}return e.setInstance=function(t){e._instance=t},J(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function I9(e,t){switch(e){case vi.R8:return t.UNSIGNED_BYTE;case vi.R8SN:return t.BYTE;case vi.R8UI:return t.UNSIGNED_BYTE;case vi.R8I:return t.BYTE;case vi.R16F:return A9.HALF_FLOAT_OES;case vi.R16UI:return t.UNSIGNED_SHORT;case vi.R16I:return t.SHORT;case vi.R32F:return t.FLOAT;case vi.R32UI:return t.UNSIGNED_INT;case vi.R32I:return t.INT;case vi.RG8:return t.UNSIGNED_BYTE;case vi.RG8SN:return t.BYTE;case vi.RG8UI:return t.UNSIGNED_BYTE;case vi.RG8I:return t.BYTE;case vi.RG16F:return A9.HALF_FLOAT_OES;case vi.RG16UI:return t.UNSIGNED_SHORT;case vi.RG16I:return t.SHORT;case vi.RG32F:return t.FLOAT;case vi.RG32UI:return t.UNSIGNED_INT;case vi.RG32I:return t.INT;case vi.RGB8:case vi.SRGB8:return t.UNSIGNED_BYTE;case vi.RGB8SN:return t.BYTE;case vi.RGB8UI:return t.UNSIGNED_BYTE;case vi.RGB8I:return t.BYTE;case vi.RGB16F:return A9.HALF_FLOAT_OES;case vi.RGB16UI:return t.UNSIGNED_SHORT;case vi.RGB16I:return t.SHORT;case vi.RGB32F:return t.FLOAT;case vi.RGB32UI:return t.UNSIGNED_INT;case vi.RGB32I:return t.INT;case vi.BGRA8:case vi.RGBA8:case vi.SRGB8_A8:return t.UNSIGNED_BYTE;case vi.RGBA8SN:return t.BYTE;case vi.RGBA8UI:return t.UNSIGNED_BYTE;case vi.RGBA8I:return t.BYTE;case vi.RGBA16F:return A9.HALF_FLOAT_OES;case vi.RGBA16UI:return t.UNSIGNED_SHORT;case vi.RGBA16I:return t.SHORT;case vi.RGBA32F:return t.FLOAT;case vi.RGBA32UI:return t.UNSIGNED_INT;case vi.RGBA32I:return t.INT;case vi.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case vi.R11G11B10F:return t.FLOAT;case vi.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case vi.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case vi.RGB10A2:return t.UNSIGNED_BYTE;case vi.RGB10A2UI:return t.UNSIGNED_INT;case vi.RGB9E5:return t.UNSIGNED_BYTE;case vi.DEPTH:return t.UNSIGNED_INT;case vi.DEPTH_STENCIL:return A9.UNSIGNED_INT_24_8_WEBGL;case vi.BC1:case vi.BC1_SRGB:case vi.BC2:case vi.BC2_SRGB:case vi.BC3:case vi.BC3_SRGB:case vi.BC4:return t.UNSIGNED_BYTE;case vi.BC4_SNORM:return t.BYTE;case vi.BC5:return t.UNSIGNED_BYTE;case vi.BC5_SNORM:return t.BYTE;case vi.BC6H_SF16:case vi.BC6H_UF16:return t.FLOAT;case vi.BC7:case vi.BC7_SRGB:case vi.ETC_RGB8:case vi.ETC2_RGB8:case vi.ETC2_SRGB8:case vi.ETC2_RGB8_A1:case vi.ETC2_SRGB8_A1:case vi.EAC_R11:return t.UNSIGNED_BYTE;case vi.EAC_R11SN:return t.BYTE;case vi.EAC_RG11:return t.UNSIGNED_BYTE;case vi.EAC_RG11SN:return t.BYTE;case vi.PVRTC_RGB2:case vi.PVRTC_RGBA2:case vi.PVRTC_RGB4:case vi.PVRTC_RGBA4:case vi.PVRTC2_2BPP:case vi.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case vi.ASTC_RGBA_4X4:case vi.ASTC_RGBA_5X4:case vi.ASTC_RGBA_5X5:case vi.ASTC_RGBA_6X5:case vi.ASTC_RGBA_6X6:case vi.ASTC_RGBA_8X5:case vi.ASTC_RGBA_8X6:case vi.ASTC_RGBA_8X8:case vi.ASTC_RGBA_10X5:case vi.ASTC_RGBA_10X6:case vi.ASTC_RGBA_10X8:case vi.ASTC_RGBA_10X10:case vi.ASTC_RGBA_12X10:case vi.ASTC_RGBA_12X12:case vi.ASTC_SRGBA_4X4:case vi.ASTC_SRGBA_5X4:case vi.ASTC_SRGBA_5X5:case vi.ASTC_SRGBA_6X5:case vi.ASTC_SRGBA_6X6:case vi.ASTC_SRGBA_8X5:case vi.ASTC_SRGBA_8X6:case vi.ASTC_SRGBA_8X8:case vi.ASTC_SRGBA_10X5:case vi.ASTC_SRGBA_10X6:case vi.ASTC_SRGBA_10X8:case vi.ASTC_SRGBA_10X10:case vi.ASTC_SRGBA_12X10:case vi.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function P9(e,t){switch(e){case yi.BOOL:return t.BOOL;case yi.BOOL2:return t.BOOL_VEC2;case yi.BOOL3:return t.BOOL_VEC3;case yi.BOOL4:return t.BOOL_VEC4;case yi.INT:return t.INT;case yi.INT2:return t.INT_VEC2;case yi.INT3:return t.INT_VEC3;case yi.INT4:return t.INT_VEC4;case yi.UINT:return t.UNSIGNED_INT;case yi.FLOAT:return t.FLOAT;case yi.FLOAT2:return t.FLOAT_VEC2;case yi.FLOAT3:return t.FLOAT_VEC3;case yi.FLOAT4:return t.FLOAT_VEC4;case yi.MAT2:return t.FLOAT_MAT2;case yi.MAT3:return t.FLOAT_MAT3;case yi.MAT4:return t.FLOAT_MAT4;case yi.SAMPLER2D:return t.SAMPLER_2D;case yi.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),yi.UNKNOWN}}function R9(e){switch(e){case yi.BOOL:case yi.BOOL2:case yi.BOOL3:case yi.BOOL4:case yi.INT:case yi.INT2:case yi.INT3:case yi.INT4:case yi.UINT:return Int32Array;case yi.FLOAT:case yi.FLOAT2:case yi.FLOAT3:case yi.FLOAT4:case yi.MAT2:case yi.MAT3:case yi.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function O9(e,t){switch(e){case t.BOOL:return yi.BOOL;case t.BOOL_VEC2:return yi.BOOL2;case t.BOOL_VEC3:return yi.BOOL3;case t.BOOL_VEC4:return yi.BOOL4;case t.INT:return yi.INT;case t.INT_VEC2:return yi.INT2;case t.INT_VEC3:return yi.INT3;case t.INT_VEC4:return yi.INT4;case t.UNSIGNED_INT:return yi.UINT;case t.FLOAT:return yi.FLOAT;case t.FLOAT_VEC2:return yi.FLOAT2;case t.FLOAT_VEC3:return yi.FLOAT3;case t.FLOAT_VEC4:return yi.FLOAT4;case t.FLOAT_MAT2:return yi.MAT2;case t.FLOAT_MAT3:return yi.MAT3;case t.FLOAT_MAT4:return yi.MAT4;case t.SAMPLER_2D:return yi.SAMPLER2D;case t.SAMPLER_CUBE:return yi.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),yi.UNKNOWN}}function D9(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function N9(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}w9._instance=null;var M9,L9=[512,513,514,515,516,517,518,519],B9=[0,7680,7681,7682,7683,5386,34055,34056],F9=[32774,32778,32779,32775,32776],z9=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(M9||(M9={}));var U9=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},G9=function(e){function t(){var t;return(t=e.call(this,M9.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new sr,t.clearFlag=$i.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return ee(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(U9),k9=function(e){function t(){var t;return(t=e.call(this,M9.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new ro,t}return ee(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(U9),H9=function(e){function t(){var t;return(t=e.call(this,M9.DRAW)||this).drawInfo=new xr,t}return ee(t,e),t.prototype.clear=function(){},t}(U9),V9=function(e){function t(){var t;return(t=e.call(this,M9.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return ee(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(U9),W9=function(e){function t(){var t;return(t=e.call(this,M9.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return ee(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(U9),j9=function(){function e(){this.cmds=new Zl(1),this.beginRenderPassCmds=new Zl(1),this.bindStatesCmds=new Zl(1),this.drawCmds=new Zl(1),this.updateBufferCmds=new Zl(1),this.copyBufferToTextureCmds=new Zl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function X9(e,t,n,i,r){if(t.usage&Si.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&Si.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),q9.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),q9.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var q9={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},Y9=new sr;function K9(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&(Y9.x=i.x<<n.lodLevel,Y9.y=i.y<<n.lodLevel,Y9.width=i.width<<n.lodLevel,Y9.height=i.height<<n.lodLevel),n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===Y9.x&&c.viewport.top===Y9.y&&c.viewport.width===Y9.width&&c.viewport.height===Y9.height||(s.viewport(Y9.x,Y9.y,Y9.width,Y9.height),c.viewport.left=Y9.x,c.viewport.top=Y9.y,c.viewport.width=Y9.width,c.viewport.height=Y9.height),c.scissorRect.x===Y9.x&&c.scissorRect.y===Y9.y&&c.scissorRect.width===Y9.width&&c.scissorRect.height===Y9.height||(s.scissor(Y9.x,Y9.y,Y9.width,Y9.height),c.scissorRect.x=Y9.x,c.scissorRect.y=Y9.y,c.scissorRect.width=Y9.width,c.scissorRect.height=Y9.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=t.colorAttachments[h];if(_.format!==vi.UNKNOWN)switch(_.loadOp){case zi.LOAD:break;case zi.CLEAR:c.bs.targets[0].blendColorMask!==Bi.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case zi.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==vi.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case zi.LOAD:break;case zi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case zi.DISCARD:}if(ao[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case zi.LOAD:break;case zi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case zi.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var d=c.bs.targets[0].blendColorMask;if(d!==Bi.ALL){var p=(d&Bi.R)!==Bi.NONE,m=(d&Bi.G)!==Bi.NONE,v=(d&Bi.B)!==Bi.NONE,g=(d&Bi.A)!==Bi.NONE;s.colorMask(p,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function Q9(e,t,n,i,r,o){var a,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,_=!1;if(t&&q9.gpuPipelineState!==t){if(q9.gpuPipelineState=t,q9.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var d=t.rs;if(d){if(u.rs.cullMode!==d.cullMode){switch(d.cullMode){case Xi.NONE:l.disable(l.CULL_FACE);break;case Xi.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Xi.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=d.cullMode}var p=d.isFrontFaceCCW;u.rs.isFrontFaceCCW!==p&&(l.frontFace(p?l.CCW:l.CW),u.rs.isFrontFaceCCW=p),u.rs.depthBias===d.depthBias&&u.rs.depthBiasSlop===d.depthBiasSlop||(l.polygonOffset(d.depthBias,d.depthBiasSlop),u.rs.depthBias=d.depthBias,u.rs.depthBiasSlop=d.depthBiasSlop),u.rs.lineWidth!==d.lineWidth&&(l.lineWidth(d.lineWidth),u.rs.lineWidth=d.lineWidth)}var m=t.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(L9[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,L9[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,B9[m.stencilFailOpFront],B9[m.stencilZFailOpFront],B9[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,L9[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,B9[m.stencilFailOpBack],B9[m.stencilZFailOpBack],B9[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=t.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(F9[g.blendEq],F9[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(z9[g.blendSrc],z9[g.blendDst],z9[g.blendSrcAlpha],z9[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Bi.R)!==Bi.NONE,(g.blendColorMask&Bi.G)!==Bi.NONE,(g.blendColorMask&Bi.B)!==Bi.NONE,(g.blendColorMask&Bi.A)!==Bi.NONE),y.blendColorMask=g.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var S=h.glBlocks.length,x=t.gpuPipelineLayout.dynamicOffsetIndices,E=0;E<S;E++){var C=h.glBlocks[E],A=i[C.set],b=A&&A.descriptorIndices[C.binding],w=b>=0&&A.gpuDescriptors[b],I=null,P=0;if(w&&w.gpuBuffer){var R=w.gpuBuffer,O=x[C.set],D=O&&O[C.binding];D>=0&&(P=r[D]),"vf32"in R?I=R.vf32:(P+=R.offset,I=R.gpuBuffer.vf32),P>>=2}if(I)for(var N=C.glActiveUniforms.length,M=0;M<N;M++){var L=C.glActiveUniforms[M];switch(L.glType){case l.BOOL:case l.INT:for(var B=0;B<L.array.length;++B){var F=L.offset+P+B;if(I[F]!==L.array[B]){for(var z=B,U=F;z<L.array.length;++z,++U)L.array[z]=I[U];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var G=0;G<L.array.length;++G){var k=L.offset+P+G;if(I[k]!==L.array[G]){for(var H=G,V=k;H<L.array.length;++H,++V)L.array[H]=I[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var W=0;W<L.array.length;++W){var j=L.offset+P+W;if(I[j]!==L.array[W]){for(var X=W,q=j;X<L.array.length;++X,++q)L.array[X]=I[q];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+P+Y;if(I[K]!==L.array[Y]){for(var Q=Y,Z=K;Q<L.array.length;++Q,++Z)L.array[Q]=I[Z];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var J=0;J<L.array.length;++J){var $=L.offset+P+J;if(I[$]!==L.array[J]){for(var ee=J,te=$;ee<L.array.length;++ee,++te)L.array[ee]=I[te];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<L.array.length;++ne){var ie=L.offset+P+ne;if(I[ie]!==L.array[ne]){for(var re=ne,oe=ie;re<L.array.length;++re,++oe)L.array[re]=I[oe];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var ae=0;ae<L.array.length;++ae){var se=L.offset+P+ae;if(I[se]!==L.array[ae]){for(var ce=ae,le=se;ce<L.array.length;++ce,++le)L.array[ce]=I[le];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<L.array.length;++ue){var he=L.offset+P+ue;if(I[he]!==L.array[ue]){for(var _e=ue,fe=he;_e<L.array.length;++_e,++fe)L.array[_e]=I[fe];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var de=0;de<L.array.length;++de){var pe=L.offset+P+de;if(I[pe]!==L.array[de]){for(var me=de,ve=pe;me<L.array.length;++me,++ve)L.array[me]=I[ve];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<L.array.length;++ge){var ye=L.offset+P+ge;if(I[ye]!==L.array[ge]){for(var Se=ge,xe=ye;Se<L.array.length;++Se,++xe)L.array[Se]=I[xe];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var Ee=0;Ee<L.array.length;++Ee){var Te=L.offset+P+Ee;if(I[Te]!==L.array[Ee]){for(var Ce=Ee,Ae=Te;Ce<L.array.length;++Ce,++Ae)L.array[Ce]=I[Ae];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else T("Buffer binding '"+C.name+"' at set "+C.set+" binding "+C.binding+" is not bounded")}for(var be=h.glSamplerTextures.length,we=0;we<be;we++)for(var Ie=h.glSamplerTextures[we],Pe=i[Ie.set],Re=Pe&&Pe.descriptorIndices[Ie.binding],Oe=Re>=0&&Pe.gpuDescriptors[Re],De=Ie.units.length,Ne=0;Ne<De;Ne++){var Me=Ie.units[Ne];if(Oe&&Oe.gpuSampler){if(Oe.gpuTexture&&Oe.gpuTexture.size>0){var Le=Oe.gpuTexture,Be=u.glTexUnits[Me];Be.glTexture!==Le.glTexture&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),Le.glTexture?l.bindTexture(Le.glTarget,Le.glTexture):l.bindTexture(Le.glTarget,e.nullTex2D.gpuTexture.glTexture),Be.glTexture=Le.glTexture);var Fe=Oe.gpuSampler;Le.isPowerOf2?(a=Fe.glWrapS,s=Fe.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Le.isPowerOf2?Le.mipLevel<=1&&(Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Fe.glMinFilter:Fe.glMinFilter===l.LINEAR||Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Le.glWrapS!==a&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_S,a),Le.glWrapS=a),Le.glWrapT!==s&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_T,s),Le.glWrapT=s),Le.glMinFilter!==c&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_MIN_FILTER,c),Le.glMinFilter=c),Le.glMagFilter!==Fe.glMagFilter&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_MAG_FILTER,Fe.glMagFilter),Le.glMagFilter=Fe.glMagFilter)}Oe=Pe.gpuDescriptors[++Re]}else T("Sampler binding '"+Ie.name+"' at set "+Ie.set+" binding "+Ie.binding+" index "+Ne+" is not bounded")}}if(n&&h&&(_||q9.gpuInputAssembler!==n)){q9.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ue=e.extensions.OES_vertex_array_object,Ge=n.glVAOs.get(h.glProgram);if(!Ge){var ke;Ge=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,Ge),Ue.bindVertexArrayOES(Ge),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var We=h.glInputs[Ve];ke=null;for(var je=n.glAttribs.length,Xe=0;Xe<je;Xe++){var qe=n.glAttribs[Xe];if(qe.name===We.name){ke=qe;break}}if(ke){u.glArrayBuffer!==ke.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,ke.glBuffer),u.glArrayBuffer=ke.glBuffer);for(var Ye=0;Ye<ke.componentCount;++Ye){var Ke=We.glLoc+Ye,Qe=ke.offset+ke.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,ke.count,ke.glType,ke.isNormalized,ke.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,ke.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==Ge&&(Ue.bindVertexArrayOES(Ge),u.glVAO=Ge)}else{for(var Je=0;Je<e.capabilities.maxVertexAttributes;++Je)u.glCurrentAttribLocs[Je]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var ot=n.glAttribs[rt];if(ot.name===tt.name){nt=ot;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var at=0;at<nt.componentCount;++at){var st=tt.glLoc+at,ct=nt.offset+nt.size*at;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,_t=0;_t<ht;_t++)switch(t.dynamicStates[_t]){case qi.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case qi.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case qi.BLEND_CONSTANTS:var ft=o.blendConstant;u.bs.blendColor.x===ft.x&&u.bs.blendColor.y===ft.y&&u.bs.blendColor.z===ft.z&&u.bs.blendColor.w===ft.w||(l.blendColor(ft.x,ft.y,ft.z,ft.w),u.bs.blendColor.copy(ft));break;case qi.STENCIL_WRITE_MASK:var dt=o.stencilStatesFront,pt=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==dt.writeMask&&(l.stencilMaskSeparate(l.FRONT,dt.writeMask),u.dss.stencilWriteMaskFront=dt.writeMask),u.dss.stencilWriteMaskBack!==pt.writeMask&&(l.stencilMaskSeparate(l.BACK,pt.writeMask),u.dss.stencilWriteMaskBack=pt.writeMask);break;case qi.STENCIL_COMPARE_MASK:var mt=o.stencilStatesFront,vt=o.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,L9[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,L9[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function Z9(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=q9.gpuInputAssembler,s=q9.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var f=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,a.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var d=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,a.glIndexType,d)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var J9=new Array(M9.COUNT);function $9(e,t){J9.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=J9[i]++;switch(i){case M9.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];K9(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case M9.BIND_STATES:var a=t.bindStatesCmds.array[r];Q9(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case M9.DRAW:Z9(e,t.drawCmds.array[r].drawInfo);break;case M9.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];X9(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case M9.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];eee(e,c.buffers,c.gpuTexture,c.regions)}}}function eee(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=ao[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt===A9.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[a++];u?n.glInternalFmt===A9.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&bi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var tee=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=s(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),nee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Si.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new tee,glTarget:0,glBuffer:null},this._usage&Si.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Ti.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&Si.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),q9.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Si.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),q9.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&Si.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&Si.INDIRECT||t.usage&Si.TRANSFER_DST||t.usage&Si.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(w9.instance,this._gpuBuffer),w9.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),q9.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),q9.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(w9.instance,this._gpuBuffer),w9.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Ti.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&Si.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),q9.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&Si.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),q9.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Si.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&Si.INDIRECT||t.usage&Si.TRANSFER_DST||t.usage&Si.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(w9.instance,this._gpuBuffer),w9.instance.memoryStatus.bufferSize-=t,w9.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&Si.INDIRECT?0:e.byteLength,X9(w9.instance,this._gpuBuffer,e,0,n))},J(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(yo),iee=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Zl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),ree=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new iee(G9,1),this.bindStatesCmdPool=new iee(k9,1),this.drawCmdPool=new iee(H9,1),this.updateBufferCmdPool=new iee(V9,1),this.copyBufferToTextureCmdPool=new iee(W9,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),oee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new j9,t._cmdAllocator=new ree,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new ro,t._isStateInvalied=!1,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=w9.instance.bindingMappings.blockOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(G9);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea.copy(n),a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(M9.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Yi.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Yi.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Yi.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Yi.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Ji.PRIMARY&&this._isInRenderPass||this._type===Ji.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(H9);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(M9.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Ji.PRIMARY&&!this._isInRenderPass||this._type===Ji.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(V9),a=0;e.usage&Si.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(M9.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Ji.PRIMARY&&!this._isInRenderPass||this._type===Ji.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(W9);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(M9.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(k9);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(M9.BIND_STATES),this._isStateInvalied=!1)},t}(So),aee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=0,n=[],i=0;i<e.colorTextures.length;++i){var r=e.colorTextures[i];r&&(n.push(r.gpuTexture),t=r.lodLevel)}var o=null;e.depthStencilTexture&&(o=e.depthStencilTexture.gpuTexture,t=e.depthStencilTexture.lodLevel);var a=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:n,gpuDepthStencilTexture:o,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(e){a=e},get height(){return this.isOffscreen?s:this.gpuColorTextures[0].height},set height(e){s=e},lodLevel:t},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=ao[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(w9.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=w9.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},J(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(To),see=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=I9(o.format,n),l=ao[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:ao[o.format].count,stride:s.stride,componentCount:N9(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(w9.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=w9.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.extensions.OES_vertex_array_object,o=e.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();e.stateCache.glVAO=o,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},J(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(wo),cee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&lo)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},J(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Po),lee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},J(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Ro),uee=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],hee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:uee[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},J(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Bo),_ee=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){K9(w9.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;Z9(w9.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=w9.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=w9.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&Si.INDIRECT?0:t.byteLength,X9(w9.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&eee(w9.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];$9(w9.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){Q9(w9.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(oee),fee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Fo),dee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},J(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(zo),pee=[10497,33648,33071,33071],mee=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===Ri.LINEAR||a===Ri.ANISOTROPIC?c===Ri.LINEAR||c===Ri.ANISOTROPIC?9987:c===Ri.POINT?9985:9729:c===Ri.LINEAR||c===Ri.ANISOTROPIC?9986:c===Ri.POINT?9984:9728,o=s===Ri.LINEAR||s===Ri.ANISOTROPIC?9729:9728;var l=pee[i._info.addressU],u=pee[i._info.addressV],h=pee[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return ee(t,e),J(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Uo),vee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Fi.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Fi.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));A("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(t.glProgram,d),v=O9(f.type,n),g=D9(f.type,n);t.glInputs[_]={binding:m,name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var y=0;y<t.blocks.length;++y){var S=t.blocks[y],x={set:S.set,binding:S.binding,name:S.name,size:0,glUniforms:new Array(S.members.length),glActiveUniforms:[]};t.glBlocks[y]=x;for(var E=0;E<S.members.length;++E){var T=S.members[E],C=P9(T.type,n),b=D9(C,n),w=b*T.count;x.glUniforms[E]={binding:-1,name:T.name,type:T.type,stride:b,count:T.count,size:w,offset:0,glType:C,glLoc:null,array:null}}}}for(var I=0;I<t.subpassInputs.length;++I){var P=t.subpassInputs[I];t.samplerTextures.push(new Pr(P.set,P.binding,P.name,yi.SAMPLER2D,P.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var R=0;R<t.samplerTextures.length;++R){var O=t.samplerTextures[R];t.glSamplerTextures[R]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:P9(O.type,n),glLoc:null}}}for(var D=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),N=0;N<D;++N){var M=n.getActiveUniform(t.glProgram,N);if(M&&M.type!==n.SAMPLER_2D&&M.type!==n.SAMPLER_CUBE){var L=n.getUniformLocation(t.glProgram,M.name);if(e.extensions.isLocationActive(L)){var B,F=M.name.indexOf("[");B=-1!==F?M.name.substr(0,F):M.name;for(var z=0;z<t.glBlocks.length;z++)for(var U=t.glBlocks[z],G=0;G<U.glUniforms.length;G++){var k=U.glUniforms[G];if(k.name===B){k.glLoc=L,k.count=M.size,k.size=k.stride*k.count,k.array=new(R9(k.type))(k.size/4),U.glActiveUniforms.push(k);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],W=0;W<V.glUniforms.length;W++){var j=V.glUniforms[W];j.offset=V.size/4,V.size+=j.size}for(var X=[],q=[],Y=e.bindingMappings,K=e.stateCache.texUnitCacheMap,Q=0,Z=0;Z<t.blocks.length;++Z)t.blocks[Z].set===Y.flexibleSet&&Q++;for(var J=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(X.push(t.glSamplerTextures[$]),q.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerTextureOffsets[ee.set]+J;ee.set===Y.flexibleSet&&(ne-=Q),K[ee.name]=ne%e.capabilities.maxTextureUnits,J+=ee.count-1}}if(X.length){for(var ie=[],re=0;re<X.length;++re){var oe=X[re],ae=K[oe.name];if(void 0!==ae){oe.glLoc=q[re];for(var se=0;se<oe.count;++se){for(;ie[ae];)ae=(ae+1)%e.capabilities.maxTextureUnits;oe.units.push(ae),ie[ae]=!0}}}for(var ce=0,le=0;le<X.length;++le){var ue=X[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=q[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var _e=0;_e<X.length;_e++){var fe=X[_e];fe.glUnits=new Int32Array(fe.units),n.uniform1iv(fe.glLoc,fe.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var de=0;de<t.glBlocks.length;)t.glBlocks[de].glActiveUniforms.length?de++:(t.glBlocks[de]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=X}}(w9.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(w9.instance,this._gpuShader),this._gpuShader=null)},J(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Go),gee=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new dr,this.scissorRect=new sr(0,0,0,0),this.rs=new Oo,this.dss=new Do,this.bs=new Mo,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),yee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t._lodLevel=0,t}ee(t,e);var n=t.prototype;return n.initialize=function(e,t){var n=e,i=e;"texture"in e&&(n=i.texture.info,this._isTextureView=!0),this._info.copy(n),this._isPowerOf2=ho(this._info.width)&&ho(this._info.height),this._size=fo(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(i),this._lodLevel=i.baseLevel,this._gpuTexture=i.texture._gpuTexture):(this._gpuTexture={type:n.type,format:n.format,usage:n.usage,width:n.width,height:n.height,depth:n.depth,size:this._size,arrayLayer:n.layerCount,mipLevel:n.levelCount,samples:n.samples,flags:n.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case vi.A8:return t.ALPHA;case vi.L8:return t.LUMINANCE;case vi.LA8:return t.LUMINANCE_ALPHA;case vi.RGB8:case vi.RGB16F:case vi.RGB32F:return t.RGB;case vi.BGRA8:case vi.RGBA8:case vi.SRGB8_A8:case vi.RGBA16F:case vi.RGBA32F:return t.RGBA;case vi.R5G6B5:return t.RGB;case vi.RGB5A1:case vi.RGBA4:return t.RGBA;case vi.DEPTH:return t.DEPTH_COMPONENT;case vi.DEPTH_STENCIL:return t.DEPTH_STENCIL;case vi.BC1:return A9.COMPRESSED_RGB_S3TC_DXT1_EXT;case vi.BC1_ALPHA:return A9.COMPRESSED_RGBA_S3TC_DXT1_EXT;case vi.BC1_SRGB:return A9.COMPRESSED_SRGB_S3TC_DXT1_EXT;case vi.BC1_SRGB_ALPHA:return A9.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case vi.BC2:return A9.COMPRESSED_RGBA_S3TC_DXT3_EXT;case vi.BC2_SRGB:return A9.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case vi.BC3:return A9.COMPRESSED_RGBA_S3TC_DXT5_EXT;case vi.BC3_SRGB:return A9.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case vi.ETC_RGB8:return A9.COMPRESSED_RGB_ETC1_WEBGL;case vi.ETC2_RGB8:return A9.COMPRESSED_RGB8_ETC2;case vi.ETC2_SRGB8:return A9.COMPRESSED_SRGB8_ETC2;case vi.ETC2_RGB8_A1:return A9.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case vi.ETC2_SRGB8_A1:return A9.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case vi.ETC2_RGBA8:return A9.COMPRESSED_RGBA8_ETC2_EAC;case vi.ETC2_SRGB8_A8:return A9.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case vi.EAC_R11:return A9.COMPRESSED_R11_EAC;case vi.EAC_R11SN:return A9.COMPRESSED_SIGNED_R11_EAC;case vi.EAC_RG11:return A9.COMPRESSED_RG11_EAC;case vi.EAC_RG11SN:return A9.COMPRESSED_SIGNED_RG11_EAC;case vi.PVRTC_RGB2:return A9.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case vi.PVRTC_RGBA2:return A9.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case vi.PVRTC_RGB4:return A9.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case vi.PVRTC_RGBA4:return A9.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case vi.ASTC_RGBA_4X4:return A9.COMPRESSED_RGBA_ASTC_4x4_KHR;case vi.ASTC_RGBA_5X4:return A9.COMPRESSED_RGBA_ASTC_5x4_KHR;case vi.ASTC_RGBA_5X5:return A9.COMPRESSED_RGBA_ASTC_5x5_KHR;case vi.ASTC_RGBA_6X5:return A9.COMPRESSED_RGBA_ASTC_6x5_KHR;case vi.ASTC_RGBA_6X6:return A9.COMPRESSED_RGBA_ASTC_6x6_KHR;case vi.ASTC_RGBA_8X5:return A9.COMPRESSED_RGBA_ASTC_8x5_KHR;case vi.ASTC_RGBA_8X6:return A9.COMPRESSED_RGBA_ASTC_8x6_KHR;case vi.ASTC_RGBA_8X8:return A9.COMPRESSED_RGBA_ASTC_8x8_KHR;case vi.ASTC_RGBA_10X5:return A9.COMPRESSED_RGBA_ASTC_10x5_KHR;case vi.ASTC_RGBA_10X6:return A9.COMPRESSED_RGBA_ASTC_10x6_KHR;case vi.ASTC_RGBA_10X8:return A9.COMPRESSED_RGBA_ASTC_10x8_KHR;case vi.ASTC_RGBA_10X10:return A9.COMPRESSED_RGBA_ASTC_10x10_KHR;case vi.ASTC_RGBA_12X10:return A9.COMPRESSED_RGBA_ASTC_12x10_KHR;case vi.ASTC_RGBA_12X12:return A9.COMPRESSED_RGBA_ASTC_12x12_KHR;case vi.ASTC_SRGBA_4X4:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case vi.ASTC_SRGBA_5X4:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case vi.ASTC_SRGBA_5X5:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case vi.ASTC_SRGBA_6X5:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case vi.ASTC_SRGBA_6X6:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case vi.ASTC_SRGBA_8X5:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case vi.ASTC_SRGBA_8X6:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case vi.ASTC_SRGBA_8X8:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case vi.ASTC_SRGBA_10X5:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case vi.ASTC_SRGBA_10X6:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case vi.ASTC_SRGBA_10X8:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case vi.ASTC_SRGBA_10X10:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case vi.ASTC_SRGBA_12X10:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case vi.ASTC_SRGBA_12X12:return A9.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=I9(t.format,n);var i=t.width,r=t.height;switch(t.type){case Ci.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&M(9100,o,e.capabilities.maxTextureSize),e.textureExclusive[t.format]||e.extensions.WEBGL_depth_texture||!ao[t.format].hasDepth){if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),ao[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=_o(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}}else t.glInternalFmt=function(e,t){switch(e){case vi.R5G6B5:return t.RGB565;case vi.RGB5A1:return t.RGB5_A1;case vi.RGBA4:return t.RGBA4;case vi.RGBA16F:return A9.RGBA16F_EXT;case vi.RGBA32F:return A9.RGBA32F_EXT;case vi.SRGB8_A8:return A9.SRGB8_ALPHA8_EXT;case vi.DEPTH:return t.DEPTH_COMPONENT16;case vi.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));break;case Ci.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&M(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),ao[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=_o(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Ci.TEX2D,t.glTarget=n.TEXTURE_2D}}(w9.instance,this._gpuTexture),w9.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount)},n.destroy=function(){!this._isTextureView&&this._gpuTexture&&(function(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(t.glTarget,null),i[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}(w9.instance,this._gpuTexture),w9.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,n){if(this._info.width!==e||this._info.height!==n){this._info.levelCount===t.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=t.getLevelCount(e,n):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,t.getLevelCount(e,n)));var i=this._size;this._info.width=e,this._info.height=n,this._size=fo(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=n,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Ci.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&M(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),ao[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=_o(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Ci.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&M(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),ao[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=_o(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Ci.TEX2D,t.glTarget=n.TEXTURE_2D}}}(w9.instance,this._gpuTexture),w9.instance.memoryStatus.textureSize-=i,w9.instance.memoryStatus.textureSize+=this._size)}},n.initAsSwapchainTexture=function(e){var t=new Cr;t.format=e.format,t.usage=ao[e.format].hasDepth?Ai.DEPTH_STENCIL_ATTACHMENT:Ai.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},J(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}}]),t}(ko),See="webglcontextlost";function xee(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function Eee(e){var t={EXT_texture_filter_anisotropic:xee(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:xee(e,"EXT_blend_minmax"),EXT_frag_depth:xee(e,"EXT_frag_depth"),EXT_shader_texture_lod:xee(e,"EXT_shader_texture_lod"),EXT_sRGB:xee(e,"EXT_sRGB"),OES_vertex_array_object:xee(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:xee(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:xee(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:xee(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:xee(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:xee(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:xee(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:xee(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:xee(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:xee(e,"WEBGL_draw_buffers"),WEBGL_lose_context:xee(e,"WEBGL_lose_context"),WEBGL_depth_texture:xee(e,"WEBGL_depth_texture"),OES_texture_half_float:xee(e,"OES_texture_half_float"),OES_texture_half_float_linear:xee(e,"OES_texture_half_float_linear"),OES_texture_float:xee(e,"OES_texture_float"),OES_texture_float_linear:xee(e,"OES_texture_float_linear"),OES_standard_derivatives:xee(e,"OES_standard_derivatives"),OES_element_index_uint:xee(e,"OES_element_index_uint"),ANGLE_instanced_arrays:xee(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:xee(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return vu.os===lu.IOS&&14===vu.osMainVersion&&vu.isBrowser||(t.WEBGL_compressed_texture_astc=xee(e,"WEBGL_compressed_texture_astc")),vu.os!==lu.ANDROID&&vu.os!==lu.IOS&&(t.WEBGL_multi_draw=xee(e,"WEBGL_multi_draw")),vu.browserType===au.UC&&(t.ANGLE_instanced_arrays=null),vu.os===lu.IOS&&vu.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var Tee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new gee,t.cmdAllocator=new ree,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(See,this._onWebGLContextLost);var t=w9.instance.gl;this.stateCache.initialize(w9.instance.capabilities.maxTextureUnits,w9.instance.capabilities.maxVertexAttributes),this._extensions=Eee(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=vi.RGBA8,i=vi.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=vi.DEPTH_STENCIL:r&&(i=vi.DEPTH),this._colorTexture=new yee,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new yee,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=w9.instance.createTexture(new Cr(Ci.TEX2D,Ai.SAMPLED,vi.RGBA8,2,2,bi.GEN_MIPMAP)),this.nullTexCube=w9.instance.createTexture(new Cr(Ci.CUBE,Ai.SAMPLED,vi.RGBA8,2,2,bi.GEN_MIPMAP,6));var a=new fr;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),w9.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,w9.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(See,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(A("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){D(11e3),E(e)},J(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(Eo),Cee=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(vi.COUNT),t}ee(t,e);var n=t.prototype;return n.initialize=function(e){w9.setInstance(this),this._gfxAPI=di.WEBGL;var t=this._bindingMappingInfo=e.bindingMappingInfo,n=[],i=[],r=t.setIndices[0];n[r]=0,i[r]=0;for(var o=1;o<t.setIndices.length;++o){var a=t.setIndices[o],s=t.setIndices[o-1];n[a]=t.maxBlockCounts[s]+n[s],i[a]=t.maxSamplerTextureCounts[s]+i[s]}for(var c=0;c<t.setIndices.length;++c){var l=t.setIndices[c];i[l]-=t.maxBlockCounts[l]}this._bindingMappings={blockOffsets:n,samplerTextureOffsets:i,flexibleSet:t.setIndices[t.setIndices.length-1]};var u=this._context=function(e){var t=null;try{var n={alpha:ft.ENABLE_TRANSPARENT_CANVAS,antialias:ft.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(xo.canvas);if(!u)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new $r(Qi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Jr(this._queue)),this._caps.maxVertexAttributes=u.getParameter(u.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=u.getParameter(u.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=u.getParameter(u.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=u.getParameter(u.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=u.getParameter(u.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=u.getParameter(u.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var h=u.getSupportedExtensions(),_="";if(h)for(var f,d=ce(h);!(f=d()).done;)_+=f.value+" ";var p=Eee(u);p.WEBGL_debug_renderer_info?(this._renderer=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=u.getParameter(u.RENDERER),this._vendor=u.getParameter(u.VENDOR));var m=u.getParameter(u.VERSION);this._features.fill(!1),this.initFormatFeatures(p),p.EXT_blend_minmax&&(this._features[mi.BLEND_MINMAX]=!0),p.OES_element_index_uint&&(this._features[mi.ELEMENT_INDEX_UINT]=!0),p.ANGLE_instanced_arrays&&(this._features[mi.INSTANCED_ARRAYS]=!0),p.WEBGL_draw_buffers&&(this._features[mi.MULTIPLE_RENDER_TARGETS]=!0);var v="";return this.getFormatFeatures(vi.ETC_RGB8)&&(v+="etc1 "),this.getFormatFeatures(vi.ETC2_RGB8)&&(v+="etc2 "),this.getFormatFeatures(vi.BC1)&&(v+="dxt "),this.getFormatFeatures(vi.PVRTC_RGB2)&&(v+="pvrtc "),this.getFormatFeatures(vi.ASTC_RGBA_4X4)&&(v+="astc "),A("WebGL device initialized."),A("RENDERER: "+this._renderer),A("VENDOR: "+this._vendor),A("VERSION: "+m),A("COMPRESSED_FORMAT: "+v),A("EXTENSIONS: "+_),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.initFormatFeatures=function(e){this._formatFeatures.fill(wi.NONE),this._textureExclusive.fill(!0);var t=wi.RENDER_TARGET|wi.SAMPLED_TEXTURE|wi.LINEAR_FILTER;this._formatFeatures[vi.RGB8]=t,this._formatFeatures[vi.R5G6B5]=t,this._textureExclusive[vi.R5G6B5]=!1,this._formatFeatures[vi.RGBA8]=t,this._formatFeatures[vi.RGBA4]=t,this._textureExclusive[vi.RGBA4]=!1,this._formatFeatures[vi.RGB5A1]=t,this._textureExclusive[vi.RGB5A1]=!1,this._formatFeatures[vi.DEPTH]=wi.RENDER_TARGET,this._textureExclusive[vi.DEPTH]=!1,this._formatFeatures[vi.DEPTH_STENCIL]=wi.RENDER_TARGET,this._textureExclusive[vi.DEPTH_STENCIL]=!1,this._formatFeatures[vi.R8I]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RG8I]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGB8I]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGBA8I]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.R8UI]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RG8UI]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGB8UI]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGBA8UI]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.R8I]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RG8I]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGB8I]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGBA8I]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.R8UI]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RG8UI]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGB8UI]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGBA8UI]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.R32F]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RG32F]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGB32F]|=wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.RGBA32F]|=wi.VERTEX_ATTRIBUTE,e.EXT_sRGB&&(this._formatFeatures[vi.SRGB8]=t,this._formatFeatures[vi.SRGB8_A8]=t,this._textureExclusive[vi.SRGB8_A8]=!1),e.WEBGL_depth_texture&&(this._formatFeatures[vi.DEPTH]|=t,this._formatFeatures[vi.DEPTH_STENCIL]|=t),e.WEBGL_color_buffer_float&&(this._formatFeatures[vi.RGB32F]|=wi.RENDER_TARGET,this._formatFeatures[vi.RGBA32F]|=wi.RENDER_TARGET,this._textureExclusive[vi.RGB32F]=!1,this._textureExclusive[vi.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._formatFeatures[vi.RGB16F]|=wi.RENDER_TARGET,this._formatFeatures[vi.RGBA16F]|=wi.RENDER_TARGET,this._textureExclusive[vi.RGB16F]=!1,this._textureExclusive[vi.RGBA16F]=!1),e.OES_texture_float&&(this._formatFeatures[vi.RGB32F]|=wi.RENDER_TARGET|wi.SAMPLED_TEXTURE,this._formatFeatures[vi.RGBA32F]|=wi.RENDER_TARGET|wi.SAMPLED_TEXTURE),e.OES_texture_half_float&&(this._formatFeatures[vi.RGB16F]|=wi.RENDER_TARGET|wi.SAMPLED_TEXTURE,this._formatFeatures[vi.RGBA16F]|=wi.RENDER_TARGET|wi.SAMPLED_TEXTURE),e.OES_texture_float_linear&&(this._formatFeatures[vi.RGB32F]|=wi.LINEAR_FILTER,this._formatFeatures[vi.RGBA32F]|=wi.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[vi.RGB16F]|=wi.LINEAR_FILTER,this._formatFeatures[vi.RGBA16F]|=wi.LINEAR_FILTER);var n=wi.SAMPLED_TEXTURE|wi.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[vi.ETC_RGB8]=n),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[vi.ETC2_RGB8]=n,this._formatFeatures[vi.ETC2_RGBA8]=n,this._formatFeatures[vi.ETC2_SRGB8]=n,this._formatFeatures[vi.ETC2_SRGB8_A8]=n,this._formatFeatures[vi.ETC2_RGB8_A1]=n,this._formatFeatures[vi.ETC2_SRGB8_A1]=n),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[vi.BC1]=n,this._formatFeatures[vi.BC1_ALPHA]=n,this._formatFeatures[vi.BC1_SRGB]=n,this._formatFeatures[vi.BC1_SRGB_ALPHA]=n,this._formatFeatures[vi.BC2]=n,this._formatFeatures[vi.BC2_SRGB]=n,this._formatFeatures[vi.BC3]=n,this._formatFeatures[vi.BC3_SRGB]=n),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[vi.PVRTC_RGB2]|=n,this._formatFeatures[vi.PVRTC_RGBA2]|=n,this._formatFeatures[vi.PVRTC_RGB4]|=n,this._formatFeatures[vi.PVRTC_RGBA4]|=n),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[vi.ASTC_RGBA_4X4]|=n,this._formatFeatures[vi.ASTC_RGBA_5X4]|=n,this._formatFeatures[vi.ASTC_RGBA_5X5]|=n,this._formatFeatures[vi.ASTC_RGBA_6X5]|=n,this._formatFeatures[vi.ASTC_RGBA_6X6]|=n,this._formatFeatures[vi.ASTC_RGBA_8X5]|=n,this._formatFeatures[vi.ASTC_RGBA_8X6]|=n,this._formatFeatures[vi.ASTC_RGBA_8X8]|=n,this._formatFeatures[vi.ASTC_RGBA_10X5]|=n,this._formatFeatures[vi.ASTC_RGBA_10X6]|=n,this._formatFeatures[vi.ASTC_RGBA_10X8]|=n,this._formatFeatures[vi.ASTC_RGBA_10X10]|=n,this._formatFeatures[vi.ASTC_RGBA_12X10]|=n,this._formatFeatures[vi.ASTC_RGBA_12X12]|=n,this._formatFeatures[vi.ASTC_SRGBA_4X4]|=n,this._formatFeatures[vi.ASTC_SRGBA_5X4]|=n,this._formatFeatures[vi.ASTC_SRGBA_5X5]|=n,this._formatFeatures[vi.ASTC_SRGBA_6X5]|=n,this._formatFeatures[vi.ASTC_SRGBA_6X6]|=n,this._formatFeatures[vi.ASTC_SRGBA_8X5]|=n,this._formatFeatures[vi.ASTC_SRGBA_8X6]|=n,this._formatFeatures[vi.ASTC_SRGBA_8X8]|=n,this._formatFeatures[vi.ASTC_SRGBA_10X5]|=n,this._formatFeatures[vi.ASTC_SRGBA_10X6]|=n,this._formatFeatures[vi.ASTC_SRGBA_10X8]|=n,this._formatFeatures[vi.ASTC_SRGBA_10X10]|=n,this._formatFeatures[vi.ASTC_SRGBA_12X10]|=n,this._formatFeatures[vi.ASTC_SRGBA_12X12]|=n)},n.createCommandBuffer=function(e){var t=new(e.type===Ji.PRIMARY?_ee:oee);return t.initialize(e),t},n.createSwapchain=function(e){var t=new Tee;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new nee;return t.initialize(e),t},n.createTexture=function(e){var t=new yee;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new b9;return t.initialize(e),t},n.createShader=function(e){var t=new vee;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new see;return t.initialize(e),t},n.createRenderPass=function(e){var t=new dee;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new aee;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new cee;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new lee;return t.initialize(e),t},n.createPipelineState=function(e){var t=new hee;return t.initialize(e),t},n.createQueue=function(e){var t=new fee;return t.initialize(e),t},n.getSampler=function(e){var t=Uo.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new mee(e,t)),this._samplers.get(t)},n.getGeneralBarrier=function(e){var t=Ho.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new Ho(e,t)),this._generalBarrierss.get(t)},n.getTextureBarrier=function(e){var t=Vo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Vo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){eee(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&bi.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},J(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),t}(xo));h.WebGLDevice=Cee;var Aee,bee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTextureView:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&so?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&co&&(this._textures[t]&&(e[t].gpuTextureView=this._textures[t].gpuTextureView),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},J(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Io);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(Aee||(Aee={}));var wee=function(){function e(){}return e.setInstance=function(t){e._instance=t},J(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();wee._instance=null;var Iee=[10497,33648,33071,33071],Pee=new Float32Array(4);function Ree(e,t){switch(e){case vi.R8:return t.UNSIGNED_BYTE;case vi.R8SN:return t.BYTE;case vi.R8UI:return t.UNSIGNED_BYTE;case vi.R8I:return t.BYTE;case vi.R16F:return t.HALF_FLOAT;case vi.R16UI:return t.UNSIGNED_SHORT;case vi.R16I:return t.SHORT;case vi.R32F:return t.FLOAT;case vi.R32UI:return t.UNSIGNED_INT;case vi.R32I:return t.INT;case vi.RG8:return t.UNSIGNED_BYTE;case vi.RG8SN:return t.BYTE;case vi.RG8UI:return t.UNSIGNED_BYTE;case vi.RG8I:return t.BYTE;case vi.RG16F:return t.HALF_FLOAT;case vi.RG16UI:return t.UNSIGNED_SHORT;case vi.RG16I:return t.SHORT;case vi.RG32F:return t.FLOAT;case vi.RG32UI:return t.UNSIGNED_INT;case vi.RG32I:return t.INT;case vi.RGB8:case vi.SRGB8:return t.UNSIGNED_BYTE;case vi.RGB8SN:return t.BYTE;case vi.RGB8UI:return t.UNSIGNED_BYTE;case vi.RGB8I:return t.BYTE;case vi.RGB16F:return t.HALF_FLOAT;case vi.RGB16UI:return t.UNSIGNED_SHORT;case vi.RGB16I:return t.SHORT;case vi.RGB32F:return t.FLOAT;case vi.RGB32UI:return t.UNSIGNED_INT;case vi.RGB32I:return t.INT;case vi.BGRA8:case vi.RGBA8:case vi.SRGB8_A8:return t.UNSIGNED_BYTE;case vi.RGBA8SN:return t.BYTE;case vi.RGBA8UI:return t.UNSIGNED_BYTE;case vi.RGBA8I:return t.BYTE;case vi.RGBA16F:return t.HALF_FLOAT;case vi.RGBA16UI:return t.UNSIGNED_SHORT;case vi.RGBA16I:return t.SHORT;case vi.RGBA32F:return t.FLOAT;case vi.RGBA32UI:return t.UNSIGNED_INT;case vi.RGBA32I:return t.INT;case vi.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case vi.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case vi.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case vi.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case vi.RGB10A2:case vi.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case vi.RGB9E5:case vi.DEPTH:return t.FLOAT;case vi.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case vi.BC1:case vi.BC1_SRGB:case vi.BC2:case vi.BC2_SRGB:case vi.BC3:case vi.BC3_SRGB:case vi.BC4:return t.UNSIGNED_BYTE;case vi.BC4_SNORM:return t.BYTE;case vi.BC5:return t.UNSIGNED_BYTE;case vi.BC5_SNORM:return t.BYTE;case vi.BC6H_SF16:case vi.BC6H_UF16:return t.FLOAT;case vi.BC7:case vi.BC7_SRGB:case vi.ETC_RGB8:case vi.ETC2_RGB8:case vi.ETC2_SRGB8:case vi.ETC2_RGB8_A1:case vi.ETC2_SRGB8_A1:case vi.EAC_R11:return t.UNSIGNED_BYTE;case vi.EAC_R11SN:return t.BYTE;case vi.EAC_RG11:return t.UNSIGNED_BYTE;case vi.EAC_RG11SN:return t.BYTE;case vi.PVRTC_RGB2:case vi.PVRTC_RGBA2:case vi.PVRTC_RGB4:case vi.PVRTC_RGBA4:case vi.PVRTC2_2BPP:case vi.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case vi.ASTC_RGBA_4X4:case vi.ASTC_RGBA_5X4:case vi.ASTC_RGBA_5X5:case vi.ASTC_RGBA_6X5:case vi.ASTC_RGBA_6X6:case vi.ASTC_RGBA_8X5:case vi.ASTC_RGBA_8X6:case vi.ASTC_RGBA_8X8:case vi.ASTC_RGBA_10X5:case vi.ASTC_RGBA_10X6:case vi.ASTC_RGBA_10X8:case vi.ASTC_RGBA_10X10:case vi.ASTC_RGBA_12X10:case vi.ASTC_RGBA_12X12:case vi.ASTC_SRGBA_4X4:case vi.ASTC_SRGBA_5X4:case vi.ASTC_SRGBA_5X5:case vi.ASTC_SRGBA_6X5:case vi.ASTC_SRGBA_6X6:case vi.ASTC_SRGBA_8X5:case vi.ASTC_SRGBA_8X6:case vi.ASTC_SRGBA_8X8:case vi.ASTC_SRGBA_10X5:case vi.ASTC_SRGBA_10X6:case vi.ASTC_SRGBA_10X8:case vi.ASTC_SRGBA_10X10:case vi.ASTC_SRGBA_12X10:case vi.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function Oee(e,t){switch(e){case yi.BOOL:return t.BOOL;case yi.BOOL2:return t.BOOL_VEC2;case yi.BOOL3:return t.BOOL_VEC3;case yi.BOOL4:return t.BOOL_VEC4;case yi.INT:return t.INT;case yi.INT2:return t.INT_VEC2;case yi.INT3:return t.INT_VEC3;case yi.INT4:return t.INT_VEC4;case yi.UINT:return t.UNSIGNED_INT;case yi.FLOAT:return t.FLOAT;case yi.FLOAT2:return t.FLOAT_VEC2;case yi.FLOAT3:return t.FLOAT_VEC3;case yi.FLOAT4:return t.FLOAT_VEC4;case yi.MAT2:return t.FLOAT_MAT2;case yi.MAT2X3:return t.FLOAT_MAT2x3;case yi.MAT2X4:return t.FLOAT_MAT2x4;case yi.MAT3X2:return t.FLOAT_MAT3x2;case yi.MAT3:return t.FLOAT_MAT3;case yi.MAT3X4:return t.FLOAT_MAT3x4;case yi.MAT4X2:return t.FLOAT_MAT4x2;case yi.MAT4X3:return t.FLOAT_MAT4x3;case yi.MAT4:return t.FLOAT_MAT4;case yi.SAMPLER2D:return t.SAMPLER_2D;case yi.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case yi.SAMPLER3D:return t.SAMPLER_3D;case yi.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),yi.UNKNOWN}}function Dee(e,t){switch(e){case t.BOOL:return yi.BOOL;case t.BOOL_VEC2:return yi.BOOL2;case t.BOOL_VEC3:return yi.BOOL3;case t.BOOL_VEC4:return yi.BOOL4;case t.INT:return yi.INT;case t.INT_VEC2:return yi.INT2;case t.INT_VEC3:return yi.INT3;case t.INT_VEC4:return yi.INT4;case t.UNSIGNED_INT:return yi.UINT;case t.UNSIGNED_INT_VEC2:return yi.UINT2;case t.UNSIGNED_INT_VEC3:return yi.UINT3;case t.UNSIGNED_INT_VEC4:return yi.UINT4;case t.FLOAT:return yi.FLOAT;case t.FLOAT_VEC2:return yi.FLOAT2;case t.FLOAT_VEC3:return yi.FLOAT3;case t.FLOAT_VEC4:return yi.FLOAT4;case t.FLOAT_MAT2:return yi.MAT2;case t.FLOAT_MAT2x3:return yi.MAT2X3;case t.FLOAT_MAT2x4:return yi.MAT2X4;case t.FLOAT_MAT3x2:return yi.MAT3X2;case t.FLOAT_MAT3:return yi.MAT3;case t.FLOAT_MAT3x4:return yi.MAT3X4;case t.FLOAT_MAT4x2:return yi.MAT4X2;case t.FLOAT_MAT4x3:return yi.MAT4X3;case t.FLOAT_MAT4:return yi.MAT4;case t.SAMPLER_2D:return yi.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return yi.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return yi.SAMPLER3D;case t.SAMPLER_CUBE:return yi.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),yi.UNKNOWN}}function Nee(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Mee(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var Lee,Bee=[512,513,514,515,516,517,518,519],Fee=[0,7680,7681,7682,7683,5386,34055,34056],zee=[32774,32778,32779,32775,32776],Uee=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(Lee||(Lee={}));var Gee=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},kee=function(e){function t(){var t;return(t=e.call(this,Lee.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new sr,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return ee(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(Gee),Hee=function(e){function t(){var t;return(t=e.call(this,Lee.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new ro,t}return ee(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},t}(Gee),Vee=function(e){function t(){var t;return(t=e.call(this,Lee.DRAW)||this).drawInfo=new xr,t}return ee(t,e),t.prototype.clear=function(){},t}(Gee),Wee=function(e){function t(){var t;return(t=e.call(this,Lee.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return ee(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(Gee),jee=function(e){function t(){var t;return(t=e.call(this,Lee.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return ee(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(Gee),Xee=function(){function e(){this.cmds=new Zl(1),this.beginRenderPassCmds=new Zl(1),this.bindStatesCmds=new Zl(1),this.drawCmds=new Zl(1),this.updateBufferCmds=new Zl(1),this.copyBufferToTextureCmds=new Zl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function qee(e,t,n,i,r){if(t.usage&Si.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),Qee.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),Qee.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function Yee(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case vi.A8:return t.ALPHA;case vi.L8:return t.LUMINANCE;case vi.LA8:return t.LUMINANCE_ALPHA;case vi.R8:return t.R8;case vi.R8SN:return t.R8_SNORM;case vi.R8UI:return t.R8UI;case vi.R8I:return t.R8I;case vi.RG8:return t.RG8;case vi.RG8SN:return t.RG8_SNORM;case vi.RG8UI:return t.RG8UI;case vi.RG8I:return t.RG8I;case vi.RGB8:return t.RGB8;case vi.RGB8SN:return t.RGB8_SNORM;case vi.RGB8UI:return t.RGB8UI;case vi.RGB8I:return t.RGB8I;case vi.BGRA8:case vi.RGBA8:return t.RGBA8;case vi.RGBA8SN:return t.RGBA8_SNORM;case vi.RGBA8UI:return t.RGBA8UI;case vi.RGBA8I:return t.RGBA8I;case vi.R16I:return t.R16I;case vi.R16UI:return t.R16UI;case vi.R16F:return t.R16F;case vi.RG16I:return t.RG16I;case vi.RG16UI:return t.RG16UI;case vi.RG16F:return t.RG16F;case vi.RGB16I:return t.RGB16I;case vi.RGB16UI:return t.RGB16UI;case vi.RGB16F:return t.RGB16F;case vi.RGBA16I:return t.RGBA16I;case vi.RGBA16UI:return t.RGBA16UI;case vi.RGBA16F:return t.RGBA16F;case vi.R32I:return t.R32I;case vi.R32UI:return t.R32UI;case vi.R32F:return t.R32F;case vi.RG32I:return t.RG32I;case vi.RG32UI:return t.RG32UI;case vi.RG32F:return t.RG32F;case vi.RGB32I:return t.RGB32I;case vi.RGB32UI:return t.RGB32UI;case vi.RGB32F:return t.RGB32F;case vi.RGBA32I:return t.RGBA32I;case vi.RGBA32UI:return t.RGBA32UI;case vi.RGBA32F:return t.RGBA32F;case vi.R5G6B5:return t.RGB565;case vi.RGB5A1:return t.RGB5_A1;case vi.RGBA4:return t.RGBA4;case vi.SRGB8:return t.SRGB8;case vi.SRGB8_A8:return t.SRGB8_ALPHA8;case vi.RGB10A2:return t.RGB10_A2;case vi.RGB10A2UI:return t.RGB10_A2UI;case vi.R11G11B10F:return t.R11F_G11F_B10F;case vi.DEPTH:return t.DEPTH_COMPONENT32F;case vi.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case vi.BC1:return Aee.COMPRESSED_RGB_S3TC_DXT1_EXT;case vi.BC1_ALPHA:return Aee.COMPRESSED_RGBA_S3TC_DXT1_EXT;case vi.BC1_SRGB:return Aee.COMPRESSED_SRGB_S3TC_DXT1_EXT;case vi.BC1_SRGB_ALPHA:return Aee.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case vi.BC2:return Aee.COMPRESSED_RGBA_S3TC_DXT3_EXT;case vi.BC2_SRGB:return Aee.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case vi.BC3:return Aee.COMPRESSED_RGBA_S3TC_DXT5_EXT;case vi.BC3_SRGB:return Aee.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case vi.ETC_RGB8:return Aee.COMPRESSED_RGB_ETC1_WEBGL;case vi.ETC2_RGB8:return Aee.COMPRESSED_RGB8_ETC2;case vi.ETC2_SRGB8:return Aee.COMPRESSED_SRGB8_ETC2;case vi.ETC2_RGB8_A1:return Aee.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case vi.ETC2_SRGB8_A1:return Aee.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case vi.ETC2_RGBA8:return Aee.COMPRESSED_RGBA8_ETC2_EAC;case vi.ETC2_SRGB8_A8:return Aee.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case vi.EAC_R11:return Aee.COMPRESSED_R11_EAC;case vi.EAC_R11SN:return Aee.COMPRESSED_SIGNED_R11_EAC;case vi.EAC_RG11:return Aee.COMPRESSED_RG11_EAC;case vi.EAC_RG11SN:return Aee.COMPRESSED_SIGNED_RG11_EAC;case vi.PVRTC_RGB2:return Aee.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case vi.PVRTC_RGBA2:return Aee.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case vi.PVRTC_RGB4:return Aee.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case vi.PVRTC_RGBA4:return Aee.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case vi.ASTC_RGBA_4X4:return Aee.COMPRESSED_RGBA_ASTC_4x4_KHR;case vi.ASTC_RGBA_5X4:return Aee.COMPRESSED_RGBA_ASTC_5x4_KHR;case vi.ASTC_RGBA_5X5:return Aee.COMPRESSED_RGBA_ASTC_5x5_KHR;case vi.ASTC_RGBA_6X5:return Aee.COMPRESSED_RGBA_ASTC_6x5_KHR;case vi.ASTC_RGBA_6X6:return Aee.COMPRESSED_RGBA_ASTC_6x6_KHR;case vi.ASTC_RGBA_8X5:return Aee.COMPRESSED_RGBA_ASTC_8x5_KHR;case vi.ASTC_RGBA_8X6:return Aee.COMPRESSED_RGBA_ASTC_8x6_KHR;case vi.ASTC_RGBA_8X8:return Aee.COMPRESSED_RGBA_ASTC_8x8_KHR;case vi.ASTC_RGBA_10X5:return Aee.COMPRESSED_RGBA_ASTC_10x5_KHR;case vi.ASTC_RGBA_10X6:return Aee.COMPRESSED_RGBA_ASTC_10x6_KHR;case vi.ASTC_RGBA_10X8:return Aee.COMPRESSED_RGBA_ASTC_10x8_KHR;case vi.ASTC_RGBA_10X10:return Aee.COMPRESSED_RGBA_ASTC_10x10_KHR;case vi.ASTC_RGBA_12X10:return Aee.COMPRESSED_RGBA_ASTC_12x10_KHR;case vi.ASTC_RGBA_12X12:return Aee.COMPRESSED_RGBA_ASTC_12x12_KHR;case vi.ASTC_SRGBA_4X4:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case vi.ASTC_SRGBA_5X4:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case vi.ASTC_SRGBA_5X5:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case vi.ASTC_SRGBA_6X5:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case vi.ASTC_SRGBA_6X6:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case vi.ASTC_SRGBA_8X5:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case vi.ASTC_SRGBA_8X6:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case vi.ASTC_SRGBA_8X8:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case vi.ASTC_SRGBA_10X5:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case vi.ASTC_SRGBA_10X6:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case vi.ASTC_SRGBA_10X8:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case vi.ASTC_SRGBA_10X10:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case vi.ASTC_SRGBA_12X10:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case vi.ASTC_SRGBA_12X12:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=function(e,t){switch(e){case vi.A8:return t.ALPHA;case vi.L8:return t.LUMINANCE;case vi.LA8:return t.LUMINANCE_ALPHA;case vi.R8:case vi.R8SN:return t.RED;case vi.R8UI:case vi.R8I:return t.RED;case vi.RG8:case vi.RG8SN:case vi.RG8UI:case vi.RG8I:return t.RG;case vi.RGB8:case vi.RGB8SN:case vi.RGB8UI:case vi.RGB8I:return t.RGB;case vi.BGRA8:case vi.RGBA8:case vi.RGBA8SN:case vi.RGBA8UI:case vi.RGBA8I:return t.RGBA;case vi.R16UI:case vi.R16I:case vi.R16F:return t.RED;case vi.RG16UI:case vi.RG16I:case vi.RG16F:return t.RG;case vi.RGB16UI:case vi.RGB16I:case vi.RGB16F:return t.RGB;case vi.RGBA16UI:case vi.RGBA16I:case vi.RGBA16F:return t.RGBA;case vi.R32UI:case vi.R32I:case vi.R32F:return t.RED;case vi.RG32UI:case vi.RG32I:case vi.RG32F:return t.RG;case vi.RGB32UI:case vi.RGB32I:case vi.RGB32F:return t.RGB;case vi.RGBA32UI:case vi.RGBA32I:case vi.RGBA32F:case vi.RGB10A2:return t.RGBA;case vi.R11G11B10F:case vi.R5G6B5:return t.RGB;case vi.RGB5A1:case vi.RGBA4:return t.RGBA;case vi.SRGB8:return t.RGB;case vi.SRGB8_A8:return t.RGBA;case vi.DEPTH:return t.DEPTH_COMPONENT;case vi.DEPTH_STENCIL:return t.DEPTH_STENCIL;case vi.BC1:return Aee.COMPRESSED_RGB_S3TC_DXT1_EXT;case vi.BC1_ALPHA:return Aee.COMPRESSED_RGBA_S3TC_DXT1_EXT;case vi.BC1_SRGB:return Aee.COMPRESSED_SRGB_S3TC_DXT1_EXT;case vi.BC1_SRGB_ALPHA:return Aee.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case vi.BC2:return Aee.COMPRESSED_RGBA_S3TC_DXT3_EXT;case vi.BC2_SRGB:return Aee.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case vi.BC3:return Aee.COMPRESSED_RGBA_S3TC_DXT5_EXT;case vi.BC3_SRGB:return Aee.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case vi.ETC_RGB8:return Aee.COMPRESSED_RGB_ETC1_WEBGL;case vi.ETC2_RGB8:return Aee.COMPRESSED_RGB8_ETC2;case vi.ETC2_SRGB8:return Aee.COMPRESSED_SRGB8_ETC2;case vi.ETC2_RGB8_A1:return Aee.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case vi.ETC2_SRGB8_A1:return Aee.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case vi.ETC2_RGBA8:return Aee.COMPRESSED_RGBA8_ETC2_EAC;case vi.ETC2_SRGB8_A8:return Aee.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case vi.EAC_R11:return Aee.COMPRESSED_R11_EAC;case vi.EAC_R11SN:return Aee.COMPRESSED_SIGNED_R11_EAC;case vi.EAC_RG11:return Aee.COMPRESSED_RG11_EAC;case vi.EAC_RG11SN:return Aee.COMPRESSED_SIGNED_RG11_EAC;case vi.PVRTC_RGB2:return Aee.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case vi.PVRTC_RGBA2:return Aee.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case vi.PVRTC_RGB4:return Aee.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case vi.PVRTC_RGBA4:return Aee.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case vi.ASTC_RGBA_4X4:return Aee.COMPRESSED_RGBA_ASTC_4x4_KHR;case vi.ASTC_RGBA_5X4:return Aee.COMPRESSED_RGBA_ASTC_5x4_KHR;case vi.ASTC_RGBA_5X5:return Aee.COMPRESSED_RGBA_ASTC_5x5_KHR;case vi.ASTC_RGBA_6X5:return Aee.COMPRESSED_RGBA_ASTC_6x5_KHR;case vi.ASTC_RGBA_6X6:return Aee.COMPRESSED_RGBA_ASTC_6x6_KHR;case vi.ASTC_RGBA_8X5:return Aee.COMPRESSED_RGBA_ASTC_8x5_KHR;case vi.ASTC_RGBA_8X6:return Aee.COMPRESSED_RGBA_ASTC_8x6_KHR;case vi.ASTC_RGBA_8X8:return Aee.COMPRESSED_RGBA_ASTC_8x8_KHR;case vi.ASTC_RGBA_10X5:return Aee.COMPRESSED_RGBA_ASTC_10x5_KHR;case vi.ASTC_RGBA_10X6:return Aee.COMPRESSED_RGBA_ASTC_10x6_KHR;case vi.ASTC_RGBA_10X8:return Aee.COMPRESSED_RGBA_ASTC_10x8_KHR;case vi.ASTC_RGBA_10X10:return Aee.COMPRESSED_RGBA_ASTC_10x10_KHR;case vi.ASTC_RGBA_12X10:return Aee.COMPRESSED_RGBA_ASTC_12x10_KHR;case vi.ASTC_RGBA_12X12:return Aee.COMPRESSED_RGBA_ASTC_12x12_KHR;case vi.ASTC_SRGBA_4X4:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case vi.ASTC_SRGBA_5X4:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case vi.ASTC_SRGBA_5X5:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case vi.ASTC_SRGBA_6X5:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case vi.ASTC_SRGBA_6X6:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case vi.ASTC_SRGBA_8X5:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case vi.ASTC_SRGBA_8X6:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case vi.ASTC_SRGBA_8X8:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case vi.ASTC_SRGBA_10X5:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case vi.ASTC_SRGBA_10X6:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case vi.ASTC_SRGBA_10X8:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case vi.ASTC_SRGBA_10X10:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case vi.ASTC_SRGBA_12X10:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case vi.ASTC_SRGBA_12X12:return Aee.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=Ree(t.format,n);var i=t.width,r=t.height;switch(t.type){case Ci.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&M(9100,o,e.capabilities.maxTextureSize),t.samples===Ii.ONE){if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),ao[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=_o(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r)}}else t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Ci.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>e.capabilities.maxCubeMapTextureSize&&M(9100,u,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),ao[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){for(var f=_o(t.format,i,r,1),d=new Uint8Array(f),p=0;p<6;++p)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,_,t.glInternalFmt,i,r,0,d);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Ci.TEX2D,t.glTarget=n.TEXTURE_2D}}function Kee(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var o=0;o<i.length;++o)i[o].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(t.glTarget,null),i[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}var Qee={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function Zee(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),Qee.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==vi.UNKNOWN)switch(h.loadOp){case zi.LOAD:break;case zi.CLEAR:if(c.bs.targets[0].blendColorMask!==Bi.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)Pee[0]=r[u].x,Pee[1]=r[u].y,Pee[2]=r[u].z,Pee[3]=r[u].w,s.clearBufferfv(s.COLOR,u,Pee);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case zi.DISCARD:Qee.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==vi.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case zi.LOAD:break;case zi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case zi.DISCARD:Qee.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(ao[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case zi.LOAD:break;case zi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case zi.DISCARD:Qee.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&Qee.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,Qee.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==Bi.ALL){var d=(f&Bi.R)!==Bi.NONE,p=(f&Bi.G)!==Bi.NONE,m=(f&Bi.B)!==Bi.NONE,v=(f&Bi.A)!==Bi.NONE;s.colorMask(d,p,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function Jee(e,t,n,i,r,o){var a=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&Qee.gpuPipelineState!==t){if(Qee.gpuPipelineState=t,Qee.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Xi.NONE:a.disable(a.CULL_FACE);break;case Xi.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case Xi.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}e.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==_&&(a.frontFace(_?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=_),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var f=t.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(a.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(a.depthFunc(Bee[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,Bee[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,Fee[f.stencilFailOpFront],Fee[f.stencilZFailOpFront],Fee[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,Bee[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,Fee[f.stencilFailOpBack],Fee[f.stencilZFailOpBack],Fee[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var d=t.bs;if(d){s.bs.isA2C!==d.isA2C&&(d.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=d.isA2C),s.bs.blendColor.x===d.blendColor.x&&s.bs.blendColor.y===d.blendColor.y&&s.bs.blendColor.z===d.blendColor.z&&s.bs.blendColor.w===d.blendColor.w||(a.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),s.bs.blendColor.x=d.blendColor.x,s.bs.blendColor.y=d.blendColor.y,s.bs.blendColor.z=d.blendColor.z,s.bs.blendColor.w=d.blendColor.w);var p=d.targets[0],m=s.bs.targets[0];m.blend!==p.blend&&(p.blend?a.enable(a.BLEND):a.disable(a.BLEND),m.blend=p.blend),m.blendEq===p.blendEq&&m.blendAlphaEq===p.blendAlphaEq||(a.blendEquationSeparate(zee[p.blendEq],zee[p.blendAlphaEq]),m.blendEq=p.blendEq,m.blendAlphaEq=p.blendAlphaEq),m.blendSrc===p.blendSrc&&m.blendDst===p.blendDst&&m.blendSrcAlpha===p.blendSrcAlpha&&m.blendDstAlpha===p.blendDstAlpha||(a.blendFuncSeparate(Uee[p.blendSrc],Uee[p.blendDst],Uee[p.blendSrcAlpha],Uee[p.blendDstAlpha]),m.blendSrc=p.blendSrc,m.blendDst=p.blendDst,m.blendSrcAlpha=p.blendSrcAlpha,m.blendDstAlpha=p.blendDstAlpha),m.blendColorMask!==p.blendColorMask&&(a.colorMask((p.blendColorMask&Bi.R)!==Bi.NONE,(p.blendColorMask&Bi.G)!==Bi.NONE,(p.blendColorMask&Bi.B)!==Bi.NONE,(p.blendColorMask&Bi.A)!==Bi.NONE),m.blendColorMask=p.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var v=c.glBlocks.length,g=t.gpuPipelineLayout.dynamicOffsetIndices,y=0;y<v;y++){var S=c.glBlocks[y],x=i[S.set],E=x&&x.descriptorIndices[S.binding],C=E>=0&&x.gpuDescriptors[E];if(C&&C.gpuBuffer){var A=g[S.set],b=A&&A[S.binding],w=C.gpuBuffer.glOffset;b>=0&&(w+=r[b]),s.glBindUBOs[S.glBinding]===C.gpuBuffer.glBuffer&&s.glBindUBOOffsets[S.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,S.glBinding,C.gpuBuffer.glBuffer,w,C.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,S.glBinding,C.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[S.glBinding]=C.gpuBuffer.glBuffer,s.glBindUBOOffsets[S.glBinding]=w)}else T("Buffer binding '"+S.name+"' at set "+S.set+" binding "+S.binding+" is not bounded")}for(var I=c.glSamplerTextures.length,P=0;P<I;P++)for(var R=c.glSamplerTextures[P],O=i[R.set],D=O&&O.descriptorIndices[R.binding],N=D>=0&&O.gpuDescriptors[D],M=0;M<R.units.length;M++){var L=R.units[M],B=s.glTexUnits[L];if(N&&N.gpuTextureView&&N.gpuTextureView.gpuTexture&&N.gpuSampler){var F=N.gpuTextureView,z=F.gpuTexture,U=F.baseLevel,G=U+F.levelCount;if(z.size>0){B.glTexture!==z.glTexture&&(s.texUnit!==L&&(a.activeTexture(a.TEXTURE0+L),s.texUnit=L),z.glTexture?a.bindTexture(z.glTarget,z.glTexture):a.bindTexture(z.glTarget,e.nullTex2D.gpuTexture.glTexture),B.glTexture=z.glTexture);var k=N.gpuSampler.getGLSampler(e,U,G);s.glSamplerUnits[L]!==k&&(a.bindSampler(L,k),s.glSamplerUnits[L]=k)}N=O.gpuDescriptors[++D]}else T("Sampler binding '"+R.name+"' at set "+R.set+" binding "+R.binding+" index "+M+" is not bounded")}}if(n&&c&&(l||Qee.gpuInputAssembler!==n))if(Qee.gpuInputAssembler=n,e.extensions.useVAO){var H=n.glVAOs.get(c.glProgram);if(!H){var V;H=a.createVertexArray(),n.glVAOs.set(c.glProgram,H),a.bindVertexArray(H),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var W=0;W<c.glInputs.length;W++){var j=c.glInputs[W];V=null;for(var X=0;X<n.glAttribs.length;X++){var q=n.glAttribs[X];if(q.name===j.name){V=q;break}}if(V){s.glArrayBuffer!==V.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,V.glBuffer),s.glArrayBuffer=V.glBuffer);for(var Y=0;Y<V.componentCount;++Y){var K=j.glLoc+Y,Q=V.offset+V.size*Y;a.enableVertexAttribArray(K),s.glCurrentAttribLocs[K]=!0,a.vertexAttribPointer(K,V.count,V.glType,V.isNormalized,V.stride,Q),a.vertexAttribDivisor(K,V.isInstanced?1:0)}}}var Z=n.gpuIndexBuffer;Z&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Z.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==H&&(a.bindVertexArray(H),s.glVAO=H)}else{for(var J=0;J<e.capabilities.maxVertexAttributes;++J)s.glCurrentAttribLocs[J]=!1;for(var $=0;$<c.glInputs.length;$++){for(var ee=c.glInputs[$],te=null,ne=0;ne<n.glAttribs.length;ne++){var ie=n.glAttribs[ne];if(ie.name===ee.name){te=ie;break}}if(te){s.glArrayBuffer!==te.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,te.glBuffer),s.glArrayBuffer=te.glBuffer);for(var re=0;re<te.componentCount;++re){var oe=ee.glLoc+re,ae=te.offset+te.size*re;!s.glEnabledAttribLocs[oe]&&oe>=0&&(a.enableVertexAttribArray(oe),s.glEnabledAttribLocs[oe]=!0),s.glCurrentAttribLocs[oe]=!0,a.vertexAttribPointer(oe,te.count,te.glType,te.isNormalized,te.stride,ae),a.vertexAttribDivisor(oe,te.isInstanced?1:0)}}}var se=n.gpuIndexBuffer;se&&s.glElementArrayBuffer!==se.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,se.glBuffer),s.glElementArrayBuffer=se.glBuffer);for(var ce=0;ce<e.capabilities.maxVertexAttributes;++ce)s.glEnabledAttribLocs[ce]!==s.glCurrentAttribLocs[ce]&&(a.disableVertexAttribArray(ce),s.glEnabledAttribLocs[ce]=!1)}if(t&&t.dynamicStates.length)for(var le=t.dynamicStates.length,ue=0;ue<le;ue++)switch(t.dynamicStates[ue]){case qi.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case qi.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case qi.BLEND_CONSTANTS:var he=o.blendConstant;s.bs.blendColor.x===he.x&&s.bs.blendColor.y===he.y&&s.bs.blendColor.z===he.z&&s.bs.blendColor.w===he.w||(a.blendColor(he.x,he.y,he.z,he.w),s.bs.blendColor.copy(he));break;case qi.STENCIL_WRITE_MASK:var _e=o.stencilStatesFront,fe=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==_e.writeMask&&(a.stencilMaskSeparate(a.FRONT,_e.writeMask),s.dss.stencilWriteMaskFront=_e.writeMask),s.dss.stencilWriteMaskBack!==fe.writeMask&&(a.stencilMaskSeparate(a.BACK,fe.writeMask),s.dss.stencilWriteMaskBack=fe.writeMask);break;case qi.STENCIL_COMPARE_MASK:var de=o.stencilStatesFront,pe=o.stencilStatesBack;s.dss.stencilRefFront===de.reference&&s.dss.stencilReadMaskFront===de.compareMask||(a.stencilFuncSeparate(a.FRONT,Bee[s.dss.stencilFuncFront],de.reference,de.compareMask),s.dss.stencilRefFront=de.reference,s.dss.stencilReadMaskFront=de.compareMask),s.dss.stencilRefBack===pe.reference&&s.dss.stencilReadMaskBack===pe.compareMask||(a.stencilFuncSeparate(a.BACK,Bee[s.dss.stencilFuncBack],pe.reference,pe.compareMask),s.dss.stencilRefBack=pe.reference,s.dss.stencilReadMaskBack=pe.compareMask)}}function $ee(e,t){var n=e.gl,i=Qee.gpuInputAssembler,r=Qee.glPrimitive,o=e.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(t.instanceCount)if(a){if(t.indexCount>0){var h=t.firstIndex*a.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(a){if(t.indexCount>0){var _=t.firstIndex*a.stride;n.drawElements(r,t.indexCount,i.glIndexType,_)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}var ete=new Array(Lee.COUNT);function tte(e,t){ete.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=ete[i]++;switch(i){case Lee.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];Zee(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case Lee.BIND_STATES:var a=t.bindStatesCmds.array[r];Jee(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case Lee.DRAW:$ee(e,t.drawCmds.array[r].drawInfo);break;case Lee.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];qee(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case Lee.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];nte(e,c.buffers,c.gpuTexture,c.regions)}}}function nte(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=ao[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt!==Aee.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[a++];u?n.glInternalFmt!==Aee.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&bi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var ite=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=s(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),rte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new ite,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Ti.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&Si.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),Qee.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Si.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),Qee.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&Si.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&Si.INDIRECT||t.usage&Si.TRANSFER_DST||t.usage&Si.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(wee.instance,this._gpuBuffer),wee.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),Qee.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),Qee.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(wee.instance,this._gpuBuffer),wee.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Ti.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&Si.VERTEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),Qee.gpuInputAssembler=null,i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&Si.INDEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),Qee.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Si.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&Si.INDIRECT||t.usage&Si.TRANSFER_DST||t.usage&Si.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(wee.instance,this._gpuBuffer),wee.instance.memoryStatus.bufferSize-=t,wee.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&Si.INDIRECT?0:e.byteLength,qee(wee.instance,this._gpuBuffer,e,0,n))},J(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(yo),ote=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Zl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),ate=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new ote(kee,1),this.bindStatesCmdPool=new ote(Hee,1),this.drawCmdPool=new ote(Vee,1),this.updateBufferCmdPool=new ote(Wee,1),this.copyBufferToTextureCmdPool=new ote(jee,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),ste=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new Xee,t._cmdAllocator=new ate,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new ro,t._isStateInvalied=!1,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=wee.instance.bindingMappings.blockOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(kee);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea.copy(n);for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(Lee.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Yi.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Yi.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Yi.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Yi.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Ji.PRIMARY&&this._isInRenderPass||this._type===Ji.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(Vee);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(Lee.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Ji.PRIMARY&&!this._isInRenderPass||this._type===Ji.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(Wee),a=0;e.usage&Si.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(Lee.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Ji.PRIMARY&&!this._isInRenderPass||this._type===Ji.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(jee);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(Lee.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(Hee);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(Lee.BIND_STATES),this._isStateInvalied=!1},t}(So),cte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTextureView)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTextureView);var o=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.width:this.gpuDepthStencilView.gpuTexture.width},set width(e){o=e},get height(){return this.isOffscreen?o:this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.height:this.gpuDepthStencilView.gpuTexture.height},set height(e){}},function(e,t){for(var n=0;n<t.gpuColorViews.length;++n)if(t.gpuColorViews[n].gpuTexture.isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a],c=s.gpuTexture;c&&(c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,c.glTarget,c.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,c.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,c.width>>s.baseLevel),t.height=Math.min(t.height,c.height>>s.baseLevel))}var l=t.gpuDepthStencilView;if(l){var u=l.gpuTexture,h=ao[u.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;u.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,h,u.glTarget,u.glTexture,t.gpuDepthStencilView.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,h,i.RENDERBUFFER,u.glRenderbuffer),t.width=Math.min(t.width,u.width>>l.baseLevel),t.height=Math.min(t.height,u.height>>l.baseLevel)}i.drawBuffers(r);var _=i.checkFramebufferStatus(i.FRAMEBUFFER);if(_!==i.FRAMEBUFFER_COMPLETE)switch(_){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(wee.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=wee.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},J(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(To),lte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=Ree(o.format,n),l=ao[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:ao[o.format].count,stride:s.stride,componentCount:Mee(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(wee.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=wee.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.gl,o=e.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),o===i.value&&(r.bindVertexArray(null),o=null),i=n.next();e.stateCache.glVAO=o,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},J(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(wo),ute=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&lo)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},J(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Po),hte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},J(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Ro),_te=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],fte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:_te[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},J(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Bo),dte=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){Zee(wee.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;$ee(wee.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=wee.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=wee.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&Si.INDIRECT?0:t.byteLength,qee(wee.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&nte(wee.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];tte(wee.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){Jee(wee.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(ste),pte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Fo),mte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},J(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(zo),vte=function(e){function t(t,n){var i,r,o,a;return(i=e.call(this,t,n)||this)._gpuSampler=null,i._gpuSampler={glSamplers:new Map,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0,getGLSampler:function(e,t,n){var i=e.gl,r=t<<16|n;if(!this.glSamplers.has(r)){var o=i.createSampler();o&&(this.glSamplers.set(r,o),i.samplerParameteri(o,i.TEXTURE_MIN_FILTER,this.glMinFilter),i.samplerParameteri(o,i.TEXTURE_MAG_FILTER,this.glMagFilter),i.samplerParameteri(o,i.TEXTURE_WRAP_S,this.glWrapS),i.samplerParameteri(o,i.TEXTURE_WRAP_T,this.glWrapT),i.samplerParameteri(o,i.TEXTURE_WRAP_R,this.glWrapR),i.samplerParameterf(o,i.TEXTURE_MIN_LOD,t),i.samplerParameterf(o,i.TEXTURE_MAX_LOD,n))}return this.glSamplers.get(r)}},r=wee.instance,o=i._gpuSampler,a=r.gl,o.minFilter===Ri.LINEAR||o.minFilter===Ri.ANISOTROPIC?o.mipFilter===Ri.LINEAR||o.mipFilter===Ri.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===Ri.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===Ri.LINEAR||o.mipFilter===Ri.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===Ri.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===Ri.LINEAR||o.magFilter===Ri.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=Iee[o.addressU],o.glWrapT=Iee[o.addressV],o.glWrapR=Iee[o.addressW],i}return ee(t,e),t.prototype.destroy=function(){this._gpuSampler&&(function(e,t){for(var n=e.gl,i=t.glSamplers.values().next();!i.done;){n.deleteSampler(i.value);for(var r=e.stateCache.glSamplerUnits,o=0;o<r.length;++o)r[o]===i.value&&(n.bindSampler(o,null),r[o]=null)}t.glSamplers.clear()}(wee.instance,this._gpuSampler),this._gpuSampler=null)},J(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Uo),gte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Fi.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Fi.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));A("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(t.glProgram,d),v=Dee(f.type,n),g=Nee(f.type,n);t.glInputs[_]={name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}var y,S,x,E,C=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(C){t.glBlocks=new Array(C);for(var b=0;b<C;++b){var w=(y=n.getActiveUniformBlockName(t.glProgram,b)).indexOf("[");-1!==w&&(y=y.substr(0,w)),E=null;for(var I=0;I<t.blocks.length;I++)if(t.blocks[I].name===y){E=t.blocks[I];break}if(E){S=b,x=n.getActiveUniformBlockParameter(t.glProgram,S,n.UNIFORM_BLOCK_DATA_SIZE);var P=E.binding+(e.bindingMappings.blockOffsets[E.set]||0);n.uniformBlockBinding(t.glProgram,S,P),t.glBlocks[b]={set:E.set,binding:E.binding,idx:S,name:y,size:x,glBinding:P}}else T("Block '"+y+"' does not bound")}}for(var R=0;R<t.subpassInputs.length;++R){var O=t.subpassInputs[R];t.samplerTextures.push(new Pr(O.set,O.binding,O.name,yi.SAMPLER2D,O.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var D=0;D<t.samplerTextures.length;++D){var N=t.samplerTextures[D];t.glSamplerTextures[D]={set:N.set,binding:N.binding,name:N.name,type:N.type,count:N.count,units:[],glUnits:null,glType:Oee(N.type,n),glLoc:null}}}for(var M=[],L=[],B=e.stateCache.texUnitCacheMap,F=0,z=0;z<t.blocks.length;++z)t.blocks[z].set===e.bindingMappings.flexibleSet&&F++;for(var U=0,G=0;G<t.samplerTextures.length;++G){var k=t.samplerTextures[G],H=n.getUniformLocation(t.glProgram,k.name);if(H&&-1!==H.id&&(M.push(t.glSamplerTextures[G]),L.push(H)),void 0===B[k.name]){var V=k.binding+e.bindingMappings.samplerTextureOffsets[k.set]+U;k.set===e.bindingMappings.flexibleSet&&(V-=F),B[k.name]=V%e.capabilities.maxTextureUnits,U+=k.count-1}}if(M.length){for(var W=[],j=0;j<M.length;++j){var X=M[j],q=B[X.name];if(void 0!==q){X.glLoc=L[j];for(var Y=0;Y<X.count;++Y){for(;W[q];)q=(q+1)%e.capabilities.maxTextureUnits;X.units.push(q),W[q]=!0}}}for(var K=0,Q=0;Q<M.length;++Q){var Z=M[Q];if(!Z.glLoc){for(Z.glLoc=L[Q];W[K];)K++;for(var J=0;J<Z.count;++J){for(;W[K];)K=(K+1)%e.capabilities.maxTextureUnits;void 0===B[Z.name]&&(B[Z.name]=K),Z.units.push(K),W[K]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var $=0;$<M.length;$++){var ee=M[$];ee.glUnits=new Int32Array(ee.units),n.uniform1iv(ee.glLoc,ee.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=M}}(wee.instance,this._gpuShader)},n.destroy=function(){var e,t;this._gpuShader&&(e=wee.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)},J(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Go),yte=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new dr,this.scissorRect=new sr(0,0,0,0),this.rs=new Oo,this.dss=new Do,this.bs=new Mo,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},e}(),Ste=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t._gpuTextureView=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e,t){var n=e,i=e;if("texture"in e&&(n=i.texture.info,this._isTextureView=!0),this._info.copy(n),this._isPowerOf2=ho(this._info.width)&&ho(this._info.height),this._size=fo(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView){var r;if(this._viewInfo.copy(i),this._gpuTexture=i.texture._gpuTexture,(null===(r=this._gpuTexture)||void 0===r?void 0:r.format)!==n.format)return void console.log("GPU memory alias is not supported");this._gpuTextureView={gpuTexture:this._gpuTexture,type:i.type,format:i.format,baseLevel:i.baseLevel,levelCount:i.levelCount}}else this._gpuTexture={type:n.type,format:n.format,usage:n.usage,width:n.width,height:n.height,depth:n.depth,size:this._size,arrayLayer:n.layerCount,mipLevel:n.levelCount,samples:n.samples,flags:n.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},Yee(wee.instance,this._gpuTexture),wee.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount,this._gpuTextureView={gpuTexture:this._gpuTexture,type:this._viewInfo.type,format:this._viewInfo.format,baseLevel:this._viewInfo.baseLevel,levelCount:this._viewInfo.levelCount}},n.destroy=function(){!this._isTextureView&&this._gpuTexture&&(Kee(wee.instance,this._gpuTexture),wee.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,n){if(this._info.width!==e||this._info.height!==n){this._info.levelCount===t.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=t.getLevelCount(e,n):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,t.getLevelCount(e,n)));var i=this._size;this._info.width=e,this._info.height=n,this._size=fo(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=n,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Ci.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&M(9100,o,e.capabilities.maxTextureSize),t.samples===Ii.ONE){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),ao[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=_o(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else Kee(e,t),Yee(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Ci.CUBE:t.type=Ci.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>e.capabilities.maxCubeMapTextureSize&&M(9100,u,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),ao[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var f=0;f<t.mipLevel;++f){var d=_o(t.format,i,r,1),p=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,t.glInternalFmt,i,r,0,p),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else Kee(e,t),Yee(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Ci.TEX2D,t.glTarget=n.TEXTURE_2D}}}(wee.instance,this._gpuTexture),wee.instance.memoryStatus.textureSize-=i,wee.instance.memoryStatus.textureSize+=this._size)}},n.initAsSwapchainTexture=function(e){var t=new Cr;t.format=e.format,t.usage=ao[e.format].hasDepth?Ai.DEPTH_STENCIL_ATTACHMENT:Ai.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},J(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),t}(ko),xte="webglcontextlost";function Ete(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function Tte(e){var t={EXT_texture_filter_anisotropic:Ete(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:Ete(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:Ete(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:Ete(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:Ete(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:Ete(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:Ete(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:Ete(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:Ete(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:Ete(e,"WEBGL_debug_shaders"),WEBGL_lose_context:Ete(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:Ete(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:Ete(e,"OES_texture_half_float_linear"),OES_texture_float_linear:Ete(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return vu.os!==lu.ANDROID&&vu.os!==lu.IOS&&(t.WEBGL_multi_draw=Ete(e,"WEBGL_multi_draw")),t}var Cte,Ate,bte,wte,Ite,Pte,Rte,Ote,Dte,Nte,Mte,Lte,Bte,Fte,zte,Ute,Gte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new yte,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}ee(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(xte,this._onWebGLContextLost);var t=wee.instance.gl;this.stateCache.initialize(wee.instance.capabilities.maxTextureUnits,wee.instance.capabilities.maxUniformBufferBindings,wee.instance.capabilities.maxVertexAttributes),this._extensions=Tte(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=vi.RGBA8,i=vi.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=vi.DEPTH_STENCIL:r&&(i=vi.DEPTH),this._colorTexture=new Ste,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new Ste,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=wee.instance.createTexture(new Cr(Ci.TEX2D,Ai.SAMPLED,vi.RGBA8,2,2,bi.NONE)),this.nullTexCube=wee.instance.createTexture(new Cr(Ci.CUBE,Ai.SAMPLED,vi.RGBA8,2,2,bi.NONE,6));var a=new fr;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),wee.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,wee.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(xte,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(A("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){D(11e3),E(e)},J(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(Eo),kte=e("WebGL2Device",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(vi.COUNT),t}ee(t,e);var n=t.prototype;return n.initialize=function(e){wee.setInstance(this),this._gfxAPI=di.WEBGL2;var t=this._bindingMappingInfo=e.bindingMappingInfo,n=[],i=[],r=t.setIndices[0];n[r]=0,i[r]=0;for(var o=1;o<t.setIndices.length;++o){var a=t.setIndices[o],s=t.setIndices[o-1];n[a]=t.maxBlockCounts[s]+n[s],i[a]=t.maxSamplerTextureCounts[s]+i[s]}for(var c=0;c<t.setIndices.length;++c){var l=t.setIndices[c];i[l]-=t.maxBlockCounts[l]}this._bindingMappings={blockOffsets:n,samplerTextureOffsets:i,flexibleSet:t.setIndices[t.setIndices.length-1]};var u=this._context=function(e){var t=null;try{var n={alpha:ft.ENABLE_TRANSPARENT_CANVAS,antialias:ft.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(xo.canvas);if(!u)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new $r(Qi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Jr(this._queue)),this._caps.maxVertexAttributes=u.getParameter(u.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=u.getParameter(u.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=u.getParameter(u.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=u.getParameter(u.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=u.getParameter(u.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=u.getParameter(u.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=u.getParameter(u.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=u.getParameter(u.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=u.getParameter(u.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var h=u.getSupportedExtensions(),_="";if(h)for(var f,d=ce(h);!(f=d()).done;)_+=f.value+" ";var p=Tte(u);p.WEBGL_debug_renderer_info?(this._renderer=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=u.getParameter(u.RENDERER),this._vendor=u.getParameter(u.VENDOR));var m=u.getParameter(u.VERSION);this._features.fill(!1),this.initFormatFeatures(p),this._features[mi.ELEMENT_INDEX_UINT]=!0,this._features[mi.INSTANCED_ARRAYS]=!0,this._features[mi.MULTIPLE_RENDER_TARGETS]=!0,this._features[mi.BLEND_MINMAX]=!0;var v="";return this.getFormatFeatures(vi.ETC_RGB8)&&(v+="etc1 "),this.getFormatFeatures(vi.ETC2_RGB8)&&(v+="etc2 "),this.getFormatFeatures(vi.BC1)&&(v+="dxt "),this.getFormatFeatures(vi.PVRTC_RGB2)&&(v+="pvrtc "),this.getFormatFeatures(vi.ASTC_RGBA_4X4)&&(v+="astc "),A("WebGL2 device initialized."),A("RENDERER: "+this._renderer),A("VENDOR: "+this._vendor),A("VERSION: "+m),A("COMPRESSED_FORMAT: "+v),A("EXTENSIONS: "+_),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.initFormatFeatures=function(e){this._formatFeatures.fill(wi.NONE),this._textureExclusive.fill(!0);var t=wi.RENDER_TARGET|wi.SAMPLED_TEXTURE|wi.STORAGE_TEXTURE|wi.LINEAR_FILTER|wi.VERTEX_ATTRIBUTE;this._formatFeatures[vi.R8]=t,this._formatFeatures[vi.RG8]=t,this._formatFeatures[vi.RGB8]=t,this._formatFeatures[vi.RGBA8]=t,t=wi.RENDER_TARGET|wi.SAMPLED_TEXTURE|wi.STORAGE_TEXTURE|wi.LINEAR_FILTER,this._formatFeatures[vi.R8SN]=t,this._formatFeatures[vi.RG8SN]=t,this._formatFeatures[vi.RGB8SN]=t,this._formatFeatures[vi.RGBA8SN]=t,this._formatFeatures[vi.R5G6B5]=t,this._formatFeatures[vi.RGBA4]=t,this._formatFeatures[vi.RGB5A1]=t,this._formatFeatures[vi.RGB10A2]=t,this._formatFeatures[vi.SRGB8]=t,this._formatFeatures[vi.SRGB8_A8]=t,this._formatFeatures[vi.R11G11B10F]=t,this._formatFeatures[vi.RGB9E5]=t,this._formatFeatures[vi.DEPTH]=t,this._formatFeatures[vi.DEPTH_STENCIL]=t,this._formatFeatures[vi.RGB10A2UI]=wi.RENDER_TARGET|wi.STORAGE_TEXTURE|wi.SAMPLED_TEXTURE|wi.LINEAR_FILTER,t=wi.RENDER_TARGET|wi.SAMPLED_TEXTURE|wi.STORAGE_TEXTURE|wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.R16F]=t,this._formatFeatures[vi.RG16F]=t,this._formatFeatures[vi.RGB16F]=t,this._formatFeatures[vi.RGBA16F]=t,t=wi.STORAGE_TEXTURE|wi.SAMPLED_TEXTURE|wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.R32F]=t,this._formatFeatures[vi.RG32F]=t,this._formatFeatures[vi.RGB32F]=t,this._formatFeatures[vi.RGBA32F]=t,this._formatFeatures[vi.RGB10A2UI]=wi.RENDER_TARGET|wi.STORAGE_TEXTURE|wi.SAMPLED_TEXTURE|wi.LINEAR_FILTER,t=wi.RENDER_TARGET|wi.STORAGE_TEXTURE|wi.SAMPLED_TEXTURE|wi.LINEAR_FILTER|wi.VERTEX_ATTRIBUTE,this._formatFeatures[vi.R8I]=t,this._formatFeatures[vi.R8UI]=t,this._formatFeatures[vi.R16I]=t,this._formatFeatures[vi.R16UI]=t,this._formatFeatures[vi.R32I]=t,this._formatFeatures[vi.R32UI]=t,this._formatFeatures[vi.RG8I]=t,this._formatFeatures[vi.RG8UI]=t,this._formatFeatures[vi.RG16I]=t,this._formatFeatures[vi.RG16UI]=t,this._formatFeatures[vi.RG32I]=t,this._formatFeatures[vi.RG32UI]=t,this._formatFeatures[vi.RGB8I]=t,this._formatFeatures[vi.RGB8UI]=t,this._formatFeatures[vi.RGB16I]=t,this._formatFeatures[vi.RGB16UI]=t,this._formatFeatures[vi.RGB32I]=t,this._formatFeatures[vi.RGB32UI]=t,this._formatFeatures[vi.RGBA8I]=t,this._formatFeatures[vi.RGBA8UI]=t,this._formatFeatures[vi.RGBA16I]=t,this._formatFeatures[vi.RGBA16UI]=t,this._formatFeatures[vi.RGBA32I]=t,this._formatFeatures[vi.RGBA32UI]=t,this._textureExclusive[vi.R8]=!1,this._textureExclusive[vi.RG8]=!1,this._textureExclusive[vi.RGB8]=!1,this._textureExclusive[vi.R5G6B5]=!1,this._textureExclusive[vi.RGBA4]=!1,this._textureExclusive[vi.RGB5A1]=!1,this._textureExclusive[vi.RGBA8]=!1,this._textureExclusive[vi.RGB10A2]=!1,this._textureExclusive[vi.RGB10A2UI]=!1,this._textureExclusive[vi.SRGB8_A8]=!1,this._textureExclusive[vi.R8I]=!1,this._textureExclusive[vi.R8UI]=!1,this._textureExclusive[vi.R16I]=!1,this._textureExclusive[vi.R16UI]=!1,this._textureExclusive[vi.R32I]=!1,this._textureExclusive[vi.R32UI]=!1,this._textureExclusive[vi.RG8I]=!1,this._textureExclusive[vi.RG8UI]=!1,this._textureExclusive[vi.RG16I]=!1,this._textureExclusive[vi.RG16UI]=!1,this._textureExclusive[vi.RG32I]=!1,this._textureExclusive[vi.RG32UI]=!1,this._textureExclusive[vi.RGBA8I]=!1,this._textureExclusive[vi.RGBA8UI]=!1,this._textureExclusive[vi.RGBA16I]=!1,this._textureExclusive[vi.RGBA16UI]=!1,this._textureExclusive[vi.RGBA32I]=!1,this._textureExclusive[vi.RGBA32UI]=!1,this._textureExclusive[vi.DEPTH]=!1,this._textureExclusive[vi.DEPTH_STENCIL]=!1,e.EXT_color_buffer_float&&(this._formatFeatures[vi.R32F]|=wi.RENDER_TARGET,this._formatFeatures[vi.RG32F]|=wi.RENDER_TARGET,this._formatFeatures[vi.RGBA32F]|=wi.RENDER_TARGET,this._textureExclusive[vi.R32F]=!1,this._textureExclusive[vi.RG32F]=!1,this._textureExclusive[vi.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._textureExclusive[vi.R16F]=!1,this._textureExclusive[vi.RG16F]=!1,this._textureExclusive[vi.RGBA16F]=!1),e.OES_texture_float_linear&&(this._formatFeatures[vi.RGB32F]|=wi.LINEAR_FILTER,this._formatFeatures[vi.RGBA32F]|=wi.LINEAR_FILTER,this._formatFeatures[vi.R32F]|=wi.LINEAR_FILTER,this._formatFeatures[vi.RG32F]|=wi.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[vi.RGB16F]|=wi.LINEAR_FILTER,this._formatFeatures[vi.RGBA16F]|=wi.LINEAR_FILTER,this._formatFeatures[vi.R16F]|=wi.LINEAR_FILTER,this._formatFeatures[vi.RG16F]|=wi.LINEAR_FILTER);var n=wi.SAMPLED_TEXTURE|wi.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[vi.ETC_RGB8]=n),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[vi.ETC2_RGB8]=n,this._formatFeatures[vi.ETC2_RGBA8]=n,this._formatFeatures[vi.ETC2_SRGB8]=n,this._formatFeatures[vi.ETC2_SRGB8_A8]=n,this._formatFeatures[vi.ETC2_RGB8_A1]=n,this._formatFeatures[vi.ETC2_SRGB8_A1]=n),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[vi.BC1]=n,this._formatFeatures[vi.BC1_ALPHA]=n,this._formatFeatures[vi.BC1_SRGB]=n,this._formatFeatures[vi.BC1_SRGB_ALPHA]=n,this._formatFeatures[vi.BC2]=n,this._formatFeatures[vi.BC2_SRGB]=n,this._formatFeatures[vi.BC3]=n,this._formatFeatures[vi.BC3_SRGB]=n),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[vi.PVRTC_RGB2]=n,this._formatFeatures[vi.PVRTC_RGBA2]=n,this._formatFeatures[vi.PVRTC_RGB4]=n,this._formatFeatures[vi.PVRTC_RGBA4]=n),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[vi.ASTC_RGBA_4X4]=n,this._formatFeatures[vi.ASTC_RGBA_5X4]=n,this._formatFeatures[vi.ASTC_RGBA_5X5]=n,this._formatFeatures[vi.ASTC_RGBA_6X5]=n,this._formatFeatures[vi.ASTC_RGBA_6X6]=n,this._formatFeatures[vi.ASTC_RGBA_8X5]=n,this._formatFeatures[vi.ASTC_RGBA_8X6]=n,this._formatFeatures[vi.ASTC_RGBA_8X8]=n,this._formatFeatures[vi.ASTC_RGBA_10X5]=n,this._formatFeatures[vi.ASTC_RGBA_10X6]=n,this._formatFeatures[vi.ASTC_RGBA_10X8]=n,this._formatFeatures[vi.ASTC_RGBA_10X10]=n,this._formatFeatures[vi.ASTC_RGBA_12X10]=n,this._formatFeatures[vi.ASTC_RGBA_12X12]=n,this._formatFeatures[vi.ASTC_SRGBA_4X4]=n,this._formatFeatures[vi.ASTC_SRGBA_5X4]=n,this._formatFeatures[vi.ASTC_SRGBA_5X5]=n,this._formatFeatures[vi.ASTC_SRGBA_6X5]=n,this._formatFeatures[vi.ASTC_SRGBA_6X6]=n,this._formatFeatures[vi.ASTC_SRGBA_8X5]=n,this._formatFeatures[vi.ASTC_SRGBA_8X6]=n,this._formatFeatures[vi.ASTC_SRGBA_8X8]=n,this._formatFeatures[vi.ASTC_SRGBA_10X5]=n,this._formatFeatures[vi.ASTC_SRGBA_10X6]=n,this._formatFeatures[vi.ASTC_SRGBA_10X8]=n,this._formatFeatures[vi.ASTC_SRGBA_10X10]=n,this._formatFeatures[vi.ASTC_SRGBA_12X10]=n,this._formatFeatures[vi.ASTC_SRGBA_12X12]=n)},n.createCommandBuffer=function(e){var t=new(e.type===Ji.PRIMARY?dte:ste);return t.initialize(e),t},n.createSwapchain=function(e){var t=new Gte;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new rte;return t.initialize(e),t},n.createTexture=function(e){var t=new Ste;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new bee;return t.initialize(e),t},n.createShader=function(e){var t=new gte;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new lte;return t.initialize(e),t},n.createRenderPass=function(e){var t=new mte;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new cte;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new ute;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new hte;return t.initialize(e),t},n.createPipelineState=function(e){var t=new fte;return t.initialize(e),t},n.createQueue=function(e){var t=new pte;return t.initialize(e),t},n.getSampler=function(e){var t=Uo.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new vte(e,t)),this._samplers.get(t)},n.getGeneralBarrier=function(e){var t=Ho.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new Ho(e,t)),this._generalBarrierss.get(t)},n.getTextureBarrier=function(e){var t=Vo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Vo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){nte(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&bi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},J(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),t}(xo));h.WebGL2Device=kte;var Hte,Vte,Wte,jte=function(t){return e({Billboard:t,BillboardComponent:t}),t}((Cte=Ic("cc.Billboard"),Ate=Xc(),bte=Hc(),wte=hl(gv),Ite=hl(gv),Pte=Zc(),Rte=Zc(),Ote=Zc(),Dte=Zc(),Cte(Nte=Ate(Nte=bte(Nte=kc((Ute=function(e){function t(){var t;return le(t=e.call(this)||this,"_texture",Lte,ae(t)),le(t,"_height",Bte,ae(t)),le(t,"_width",Fte,ae(t)),le(t,"_rotation",zte,ae(t)),t._model=null,t._mesh=null,t._material=null,t._uniform=new ni(1,1,0,0),t}ee(t,e);var n=t.prototype;return n.onLoad=function(){this.createModel()},n.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},n.onDisable=function(){this.detachFromScene()},n.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},n.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n.createModel=function(){this._mesh=dY({primitiveMode:Vi.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[On.WHITE.r,On.WHITE.g,On.WHITE.b,On.WHITE.a,On.WHITE.r,On.WHITE.g,On.WHITE.b,On.WHITE.a,On.WHITE.r,On.WHITE.g,On.WHITE.b,On.WHITE.a,On.WHITE.r,On.WHITE.g,On.WHITE.b,On.WHITE.a],attributes:[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RG32F),new Br(ir.ATTR_COLOR,vi.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var e=this._model=h.director.root.createModel(uy,this.node);e.node=e.transform=this.node,null==this._material&&(this._material=new ig,this._material.copy(wv.get("default-billboard-material"))),e.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},J(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*mn(this._rotation))/100},set:function(e){this._rotation=pn(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),t}(th),Lte=ue((Mte=Ute).prototype,"_texture",[wte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(Mte.prototype,"texture",[Ite,Pte],Object.getOwnPropertyDescriptor(Mte.prototype,"texture"),Mte.prototype),Bte=ue(Mte.prototype,"_height",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(Mte.prototype,"height",[Rte],Object.getOwnPropertyDescriptor(Mte.prototype,"height"),Mte.prototype),Fte=ue(Mte.prototype,"_width",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(Mte.prototype,"width",[Ote],Object.getOwnPropertyDescriptor(Mte.prototype,"width"),Mte.prototype),zte=ue(Mte.prototype,"_rotation",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(Mte.prototype,"rotation",[Dte],Object.getOwnPropertyDescriptor(Mte.prototype,"rotation"),Mte.prototype),Nte=Mte))||Nte)||Nte)||Nte)||Nte)),Xte=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RGBA32F),new Br(ir.ATTR_TEX_COORD1,vi.RGB32F),new Br(ir.ATTR_COLOR,vi.RGBA8,!0)],qte=new Nn,Yte=new Nn,Kte=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=null,t._vertCount=0,t._indexCount=0,t._material=null,t.type=Zg.LINE,t._capacity=100,t._iaInfo=new Tr([new xr]),t._iaInfoBuffer=t._device.createBuffer(new yr(Si.INDIRECT,Ti.DEVICE,uo,uo)),t}ee(t,e);var n=t.prototype;return n.setCapacity=function(e){this._capacity=e,this.createBuffer()},n.createBuffer=function(){this._vertSize=0;for(var e,t=ce(Xte);!(e=t()).done;){var n=e.value;n.offset=this._vertSize,this._vertSize+=ao[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.updateMaterial=function(t){this._material=t,e.prototype.setSubModelMaterial.call(this,0,t)},n.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var n=new Uint16Array((this._capacity-1)*this._indexCount),i=0,r=0;r<this._capacity-1;++r){var o=2*r;n[i++]=o,n[i++]=o+1,n[i++]=o+2,n[i++]=o+3,n[i++]=o+2,n[i++]=o+1}var a=this._device.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(n),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new sw([e],Xte,Vi.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.addLineVertexData=function(e,t,n){if(e.length>1){var i=0;Nn.subtract(qte,e[1],e[0]),this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=0,this._vdataF32[i++]=qte.x,this._vdataF32[i++]=qte.y,this._vdataF32[i++]=qte.z,this._vdataUint32[i++]=n.evaluate(0,1)._val,this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=1,this._vdataF32[i++]=qte.x,this._vdataF32[i++]=qte.y,this._vdataF32[i++]=qte.z,this._vdataUint32[i++]=n.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){Nn.subtract(qte,e[r-1],e[r]),Nn.subtract(Yte,e[r+1],e[r]),Nn.subtract(Yte,Yte,qte);var o=r/e.length;this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=0,this._vdataF32[i++]=Yte.x,this._vdataF32[i++]=Yte.y,this._vdataF32[i++]=Yte.z,this._vdataUint32[i++]=n.evaluate(o,1)._val,this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=1,this._vdataF32[i++]=Yte.x,this._vdataF32[i++]=Yte.y,this._vdataF32[i++]=Yte.z,this._vdataUint32[i++]=n.evaluate(o,1)._val}Nn.subtract(qte,e[e.length-1],e[e.length-2]),this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=0,this._vdataF32[i++]=qte.x,this._vdataF32[i++]=qte.y,this._vdataF32[i++]=qte.z,this._vdataUint32[i++]=n.evaluate(1,1)._val,this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=1,this._vdataF32[i++]=qte.x,this._vdataF32[i++]=qte.y,this._vdataF32[i++]=qte.z,this._vdataUint32[i++]=n.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))},n.updateIA=function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},t}(uy),Qte=nn.Attr.setClassAttr,Zte=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],Jte=ct({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),$te=e("CurveRange",Ic("cc.CurveRange")((Wte=Vte=function(){function e(){this.mode=Jte.Constant,this.spline=md(),this.splineMin=md(),this.splineMax=md(),this.constant=0,this.constantMin=0,this.constantMax=0,this.multiplier=1}var t=e.prototype;return t.evaluate=function(e,t){switch(this.mode){default:case Jte.Constant:return this.constant;case Jte.Curve:return this.spline.evaluate(e)*this.multiplier;case Jte.TwoCurves:return dn(this.splineMin.evaluate(e),this.splineMax.evaluate(e),t)*this.multiplier;case Jte.TwoConstants:return dn(this.constantMin,this.constantMax,t)}},t.getMax=function(){switch(this.mode){default:case Jte.Constant:return this.constant;case Jte.Curve:return this.multiplier;case Jte.TwoConstants:return this.constantMax;case Jte.TwoCurves:return this.multiplier}},t._onBeforeSerialize=function(){return Zte[this.mode]},J(e,[{key:"curve",get:function(){var e;return null!==(e=this._curve)&&void 0!==e?e:this._curve=new fd(this.spline)},set:function(e){this._curve=e,this.spline=e._internalCurve}},{key:"curveMin",get:function(){var e;return null!==(e=this._curveMin)&&void 0!==e?e:this._curveMin=new fd(this.splineMin)},set:function(e){this._curveMin=e,this.splineMin=e._internalCurve}},{key:"curveMax",get:function(){var e;return null!==(e=this._curveMax)&&void 0!==e?e:this._curveMax=new fd(this.splineMax)},set:function(e){this._curveMax=e,this.splineMax=e._internalCurve}}]),e}(),Vte.Mode=Jte,Hte=Wte))||Hte);function ene(e,t,n){switch(e.mode){case Jte.Constant:return e.constant;case Jte.Curve:return e.spline.evaluate(t)*e.multiplier;case Jte.TwoCurves:return 0===n?e.splineMin.evaluate(t)*e.multiplier:e.splineMax.evaluate(t)*e.multiplier;case Jte.TwoConstants:return 0===n?e.constantMin:e.constantMax;default:return 0}}function tne(e){switch(e.mode){case Jte.TwoConstants:case Jte.TwoCurves:return 2;default:return 1}}function nne(e,t,n){var i=new Km({width:t,height:n,_data:e,_compressed:!1,format:bm.RGBA32F}),r=new gv;return r.setFilters(Im.NEAREST,Im.NEAREST),r.setMipFilter(Im.NONE),r.setWrapMode(wm.CLAMP_TO_EDGE,wm.CLAMP_TO_EDGE,wm.CLAMP_TO_EDGE),r.image=i,r}function ine(e,t,n,i,r){for(var o=Math.max(tne(t),tne(n),tne(i)),a=new Float32Array(e*o*4),s=[t,n,i],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],_=0,f=0,d=0;d<e;d++){var p=ene(h,c*d,l);f=r?p:(_+=p)/(d+1),a[4*d+u]=f}return nne(a,e,o)}nn.fastDefine("cc.CurveRange",$te,{multiplier:1,constantMax:0,constantMin:0,constant:0,mode:Jte.Constant,splineMax:Object.freeze(md()),splineMin:Object.freeze(md()),spline:Object.freeze(md())}),Qte($te,"multiplier","visible",!0),Qte($te,"constantMax","visible",!0),Qte($te,"constantMin","visible",!0),Qte($te,"constant","visible",!0),Qte($te,"mode","type","Enum"),Qte($te,"mode","enumList",ct.getList(Jte)),Qte($te,"mode","visible",!0),Qte($te,"splineMax","type","Object"),Qte($te,"splineMax","ctor",df),Qte($te,"splineMax","visible",!0),Qte($te,"splineMin","type","Object"),Qte($te,"splineMin","ctor",df),Qte($te,"splineMin","visible",!0),Qte($te,"spline","type","Object"),Qte($te,"spline","ctor",df),Qte($te,"spline","visible",!0);var rne=ct({Blend:0,Fixed:1}),one=e("ColorKey",(function(){this.color=On.WHITE.clone(),this.time=0}));nn.fastDefine("cc.ColorKey",one,{color:On.WHITE.clone(),time:0}),nn.Attr.setClassAttr(one,"color","visible",!0),nn.Attr.setClassAttr(one,"time","visible",!0);var ane=e("AlphaKey",(function(){this.alpha=1,this.time=0}));nn.fastDefine("cc.AlphaKey",ane,{alpha:1,time:0}),nn.Attr.setClassAttr(ane,"alpha","visible",!0),nn.Attr.setClassAttr(ane,"time","visible",!0);var sne,cne,lne,une,hne,_ne,fne,dne,pne,mne,vne,gne,yne,Sne,xne,Ene,Tne,Cne=e("Gradient",function(){function e(){this.colorKeys=new Array,this.alphaKeys=new Array,this.mode=rne.Blend,this._color=void 0,this._color=On.WHITE.clone()}var t=e.prototype;return t.setKeys=function(e,t){this.colorKeys=e,this.alphaKeys=t},t.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(e,t){return e.time-t.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(e,t){return e.time-t.time}))},t.evaluate=function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color},t.randomColor=function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color},t.getRGB=function(e){if(this.colorKeys.length>1){e=Cn(e,1);for(var t=1;t<this.colorKeys.length;++t){var n=this.colorKeys[t-1].time,i=this.colorKeys[t].time;if(e>=n&&e<i){if(this.mode===rne.Fixed)return this.colorKeys[t].color;var r=(e-n)/(i-n);return On.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var o=this.colorKeys.length-1;return e<this.colorKeys[0].time?On.lerp(this._color,On.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[o].time&&On.lerp(this._color,this.colorKeys[o].color,On.BLACK,(e-this.colorKeys[o].time)/(1-this.colorKeys[o].time)),this._color}return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(On.WHITE),this._color)},t.getAlpha=function(e){if(this.alphaKeys.length>1){e=Cn(e,1);for(var t=1;t<this.alphaKeys.length;++t){var n=this.alphaKeys[t-1].time,i=this.alphaKeys[t].time;if(e>=n&&e<i){if(this.mode===rne.Fixed)return this.alphaKeys[t].alpha;var r=(e-n)/(i-n);return dn(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var o=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?dn(0,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[o].time?dn(this.alphaKeys[o].alpha,0,(e-this.alphaKeys[o].time)/(1-this.alphaKeys[o].time)):255}return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255},e}());Cne.Mode=rne,nn.fastDefine("cc.Gradient",Cne,{colorKeys:[],alphaKeys:[],mode:rne.Blend}),nn.Attr.setClassAttr(Cne,"colorKeys","visible",!0),nn.Attr.setClassAttr(Cne,"alphaKeys","visible",!0),nn.Attr.setClassAttr(Cne,"mode","visible",!0);var Ane,bne,wne,Ine,Pne,Rne,One,Dne,Nne,Mne,Lne,Bne,Fne,zne,Une,Gne,kne,Hne,Vne,Wne,jne,Xne,qne,Yne,Kne,Qne,Zne,Jne,$ne,eie,tie,nie,iie,rie,oie,aie,sie,cie,lie=ct({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),uie=e("GradientRange",(sne=Ic("cc.GradientRange"),cne=hl(lie),lne=hl(Cne),une=hl(Cne),hne=hl(Cne),_ne=hl(lie),sne((Tne=Ene=function(){function e(){le(this,"color",pne,this),le(this,"colorMin",mne,this),le(this,"colorMax",vne,this),le(this,"gradient",gne,this),le(this,"gradientMin",yne,this),le(this,"gradientMax",Sne,this),le(this,"_mode",xne,this),this._color=On.WHITE.clone()}var t=e.prototype;return t.evaluate=function(e,t){switch(this._mode){case lie.Color:return this.color;case lie.TwoColors:return On.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case lie.RandomColor:return this.gradient.randomColor();case lie.Gradient:return this.gradient.evaluate(e);case lie.TwoGradients:return On.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}},t._onBeforeSerialize=function(){return(!1)[this._mode]},J(e,[{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),Ene.Mode=lie,ue((dne=Tne).prototype,"mode",[cne],Object.getOwnPropertyDescriptor(dne.prototype,"mode"),dne.prototype),pne=ue(dne.prototype,"color",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.WHITE.clone()}}),mne=ue(dne.prototype,"colorMin",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.WHITE.clone()}}),vne=ue(dne.prototype,"colorMax",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.WHITE.clone()}}),gne=ue(dne.prototype,"gradient",[lne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Cne}}),yne=ue(dne.prototype,"gradientMin",[une],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Cne}}),Sne=ue(dne.prototype,"gradientMax",[hne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Cne}}),xne=ue(dne.prototype,"_mode",[_ne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lie.Color}}),fne=dne))||fne));function hie(e,t,n){switch(e.mode){case lie.Color:return e.color;case lie.TwoColors:return 0===n?e.colorMin:e.colorMax;case lie.RandomColor:return e.gradient.randomColor();case lie.Gradient:return e.gradient.evaluate(t);case lie.TwoGradients:return 0===n?e.gradientMin.evaluate(t):e.gradientMax.evaluate(t);default:return e.color}}var _ie={parent:null,owner:null,subModelIdx:0},fie={CC_USE_WORLD_SPACE:!1},die=function(t){return e({Line:t,LineComponent:t}),t}((Ane=Ic("cc.Line"),bne=Xc(),wne=Hc(),Ine=hl(gv),Pne=hl(gv),Rne=il(),One=Zc(),Dne=il(),Nne=Zc(),Mne=hl([Nn]),Lne=hl([Nn]),Bne=il(),Fne=Zc(),zne=hl($te),Une=hl($te),Gne=Jc(),kne=il(),Hne=Zc(),Vne=hl(Jn),Wne=il(),jne=Zc(),Xne=hl(Jn),qne=il(),Yne=Zc(),Kne=hl(uie),Qne=hl(uie),Zne=il(),Jne=Zc(),Ane($ne=bne($ne=wne($ne=kc((cie=function(e){function t(){var t;return le(t=e.call(this)||this,"_texture",tie,ae(t)),t._material=null,t._materialInstance=null,le(t,"_worldSpace",nie,ae(t)),le(t,"_positions",iie,ae(t)),le(t,"_width",rie,ae(t)),le(t,"_tile",oie,ae(t)),le(t,"_offset",aie,ae(t)),le(t,"_color",sie,ae(t)),t._model=null,t._tile_offset=new ni,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){var e=this._model=h.director.root.createModel(Kte);e.node=e.transform=this.node,null===this._material&&(this._material=new ig,this._material.copy(wv.get("default-trail-material")),fie.CC_USE_WORLD_SPACE=this.worldSpace,_ie.parent=this._material,_ie.subModelIdx=0,this._materialInstance=new fy(_ie),_ie.parent=null,_ie.subModelIdx=0,this._materialInstance.recompileShaders(fie)),e.updateMaterial(this._materialInstance),e.setCapacity(100)},n.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},n.onDisable=function(){this._model&&this._detachFromScene()},n._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},J(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._materialInstance&&this._materialInstance.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._materialInstance&&(fie.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(fie),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),t}(th),tie=ue((eie=cie).prototype,"_texture",[Ine],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(eie.prototype,"texture",[Pne,Rne,One],Object.getOwnPropertyDescriptor(eie.prototype,"texture"),eie.prototype),nie=ue(eie.prototype,"_worldSpace",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(eie.prototype,"worldSpace",[Dne,Nne],Object.getOwnPropertyDescriptor(eie.prototype,"worldSpace"),eie.prototype),iie=ue(eie.prototype,"_positions",[Mne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ue(eie.prototype,"positions",[Lne,Bne,Fne],Object.getOwnPropertyDescriptor(eie.prototype,"positions"),eie.prototype),rie=ue(eie.prototype,"_width",[zne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),ue(eie.prototype,"width",[Une,Gne,kne,Hne],Object.getOwnPropertyDescriptor(eie.prototype,"width"),eie.prototype),oie=ue(eie.prototype,"_tile",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(1,1)}}),ue(eie.prototype,"tile",[Vne,Wne,jne],Object.getOwnPropertyDescriptor(eie.prototype,"tile"),eie.prototype),aie=ue(eie.prototype,"_offset",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(0,0)}}),ue(eie.prototype,"offset",[Xne,qne,Yne],Object.getOwnPropertyDescriptor(eie.prototype,"offset"),eie.prototype),sie=ue(eie.prototype,"_color",[Kne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uie}}),ue(eie.prototype,"color",[Qne,Zne,Jne],Object.getOwnPropertyDescriptor(eie.prototype,"color"),eie.prototype),$ne=eie))||$ne)||$ne)||$ne)||$ne)),pie=function(){function e(e){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new Nn(0,0,0),this.velocity=new Nn(0,0,0),this.animatedVelocity=new Nn(0,0,0),this.ultimateVelocity=new Nn(0,0,0),this.angularVelocity=new Nn(0,0,0),this.axisOfRotation=new Nn(0,0,0),this.rotation=new Nn(0,0,0),this.startEuler=new Nn(0,0,0),this.startRotation=new Gn,this.startRotated=!1,this.deltaQuat=new Gn,this.deltaMat=new Yn,this.localMat=new Yn,this.startSize=new Nn(0,0,0),this.size=new Nn(0,0,0),this.startColor=On.WHITE.clone(),this.color=On.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return e.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},e}();pie.INDENTIFY_NEG_QUAT=10,pie.R2D=180/Math.PI;var mie,vie,gie,yie,Sie,xie,Eie,Tie,Cie,Aie,bie,wie,Iie,Pie,Rie,Oie,Die,Nie,Mie,Lie,Bie,Fie,zie,Uie,Gie,kie,Hie,Vie,Wie,jie,Xie,qie,Yie,Kie,Qie="colorModule",Zie="rotationModule",Jie="sizeModule",$ie="textureModule",ere=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],tre=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],nre=function(){function e(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var t=e.prototype;return t.bindTarget=function(e){this.target=e},t.update=function(){},e}(),ire=ct({World:0,Local:1,Custom:2}),rre=ct({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),ore=ct({World:0,Local:1,View:2}),are=ct({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),sre=ct({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),cre=ct({Base:0,Edge:1,Shell:2,Volume:3}),lre=ct({Random:0,Loop:1,PingPong:2}),ure=ct({Particles:0}),hre=ct({Stretch:0}),_re=(mie=Ic("cc.ColorOvertimeModule"),vie=il(),gie=hl(uie),yie=il(),mie((Cie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_enable",Eie,ae(t)),le(t,"color",Tie,ae(t)),t.name=Qie,t}return ee(t,e),t.prototype.animate=function(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,Sn(e.randomSeed+91041)))},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(nre),Eie=ue((xie=Cie).prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(xie.prototype,"enable",[vie],Object.getOwnPropertyDescriptor(xie.prototype,"enable"),xie.prototype),Tie=ue(xie.prototype,"color",[gie,Bc,yie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uie}}),Sie=xie))||Sie),fre=new Nn(0,0,-1);function dre(e,t,n,i){return t!==e?(e===ire.World||Yn.invert(n,n),Yn.getRotation(i,n),!0):(Gn.set(i,0,0,0,1),!1)}function pre(e,t){Jn.set(e,Math.cos(t),Math.sin(t))}function mre(e){var t=gn(-1,1),n=gn(0,2*Math.PI),i=Math.sqrt(1-t*t),r=i*Math.cos(n),o=i*Math.sin(n);Nn.set(e,r,o,t)}function vre(e,t,n){mre(e),Nn.multiplyScalar(e,e,t+(n-t)*vn())}function gre(e,t,n,i){pre(e,i),e.z=0,Nn.multiplyScalar(e,e,t+(n-t)*vn())}function yre(e){for(var t=0;t<e.length;t++){var n=t+yn(0,e.length-t),i=e[n];e[n]=e[t],e[t]=i}}function Sre(){var e=gn(-1,1);return 0===e&&e++,i(e)}var xre,Ere,Tre,Cre,Are,bre,wre,Ire,Pre,Rre,Ore,Dre,Nre,Mre,Lre,Bre,Fre,zre,Ure,Gre,kre,Hre,Vre,Wre,jre,Xre,qre,Yre,Kre,Qre,Zre,Jre,$re,eoe,toe,noe,ioe,roe,ooe,aoe,soe,coe,loe,uoe,hoe,_oe,foe,doe,poe,moe,voe,goe,yoe,Soe,xoe,Eoe,Toe,Coe,Aoe,boe,woe=212165,Ioe=new Nn,Poe=(Aie=Ic("cc.ForceOvertimeModule"),bie=il(),wie=hl($te),Iie=Jc(),Pie=il(),Rie=Zc(),Oie=hl($te),Die=Jc(),Nie=il(),Mie=Zc(),Lie=hl($te),Bie=Jc(),Fie=il(),zie=Zc(),Uie=hl(ire),Gie=il(),kie=Zc(),Aie((Kie=function(e){function t(){var t;return le(t=e.call(this)||this,"_enable",Wie,ae(t)),le(t,"x",jie,ae(t)),le(t,"y",Xie,ae(t)),le(t,"z",qie,ae(t)),le(t,"space",Yie,ae(t)),t.randomized=!1,t.rotation=void 0,t.needTransform=void 0,t.name="forceModule",t.rotation=new Gn,t.needTransform=!1,t.needUpdate=!0,t}ee(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=dre(e,this.space,t,this.rotation)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=Nn.set(Ioe,this.x.evaluate(n,Sn(e.randomSeed+woe)),this.y.evaluate(n,Sn(e.randomSeed+woe)),this.z.evaluate(n,Sn(e.randomSeed+woe)));this.needTransform&&Nn.transformQuat(i,i,this.rotation),Nn.scaleAndAdd(e.velocity,e.velocity,i,t),Nn.copy(e.ultimateVelocity,e.velocity)},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(nre),Wie=ue((Vie=Kie).prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(Vie.prototype,"enable",[bie],Object.getOwnPropertyDescriptor(Vie.prototype,"enable"),Vie.prototype),jie=ue(Vie.prototype,"x",[wie,Bc,Iie,Pie,Rie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Xie=ue(Vie.prototype,"y",[Oie,Bc,Die,Nie,Mie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),qie=ue(Vie.prototype,"z",[Lie,Bc,Bie,Fie,zie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Yie=ue(Vie.prototype,"space",[Uie,Bc,Gie,kie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ire.Local}}),Hie=Vie))||Hie),Roe=23541,Ooe=new Nn,Doe=new Nn,Noe=(xre=Ic("cc.LimitVelocityOvertimeModule"),Ere=il(),Tre=hl($te),Cre=Jc(),Are=il(),bre=Zc(),wre=hl($te),Ire=Jc(),Pre=il(),Rre=Zc(),Ore=hl($te),Dre=Jc(),Nre=il(),Mre=Zc(),Lre=hl($te),Bre=Jc(),Fre=il(),zre=Zc(),Ure=il(),Gre=Zc(),kre=il(),Hre=Zc(),Vre=hl(ire),Wre=il(),jre=Zc(),xre((noe=function(e){function t(){var t;return le(t=e.call(this)||this,"_enable",Yre,ae(t)),le(t,"limitX",Kre,ae(t)),le(t,"limitY",Qre,ae(t)),le(t,"limitZ",Zre,ae(t)),le(t,"limit",Jre,ae(t)),le(t,"dampen",$re,ae(t)),le(t,"separateAxes",eoe,ae(t)),le(t,"space",toe,ae(t)),t.drag=null,t.multiplyDragByParticleSize=!1,t.multiplyDragByParticleVelocity=!1,t.name="limitModule",t.rotation=void 0,t.needTransform=void 0,t.rotation=new Gn,t.needTransform=!1,t.needUpdate=!0,t}ee(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=dre(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=Ooe;this.separateAxes?(Nn.set(Doe,this.limitX.evaluate(t,Sn(e.randomSeed+Roe)),this.limitY.evaluate(t,Sn(e.randomSeed+Roe)),this.limitZ.evaluate(t,Sn(e.randomSeed+Roe))),this.needTransform&&Nn.transformQuat(Doe,Doe,this.rotation),Nn.set(n,Moe(e.ultimateVelocity.x,Doe.x,this.dampen),Moe(e.ultimateVelocity.y,Doe.y,this.dampen),Moe(e.ultimateVelocity.z,Doe.z,this.dampen))):(Nn.normalize(n,e.ultimateVelocity),Nn.multiplyScalar(n,n,Moe(e.ultimateVelocity.length(),this.limit.evaluate(t,Sn(e.randomSeed+Roe)),this.dampen))),Nn.copy(e.ultimateVelocity,n)},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(nre),Yre=ue((qre=noe).prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(qre.prototype,"enable",[Ere],Object.getOwnPropertyDescriptor(qre.prototype,"enable"),qre.prototype),Kre=ue(qre.prototype,"limitX",[Tre,Bc,Cre,Are,bre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Qre=ue(qre.prototype,"limitY",[wre,Bc,Ire,Pre,Rre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Zre=ue(qre.prototype,"limitZ",[Ore,Bc,Dre,Nre,Mre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Jre=ue(qre.prototype,"limit",[Lre,Bc,Bre,Fre,zre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),$re=ue(qre.prototype,"dampen",[Bc,Ure,Gre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),eoe=ue(qre.prototype,"separateAxes",[Bc,kre,Hre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),toe=ue(qre.prototype,"space",[Vre,Bc,Wre,jre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ire.Local}}),Xre=qre))||Xre);function Moe(e,t,n){var i=Math.sign(e),r=Math.abs(e);return r>t&&(r=dn(r,t,n)),r*i}var Loe,Boe,Foe,zoe,Uoe,Goe,koe,Hoe,Voe,Woe,joe,Xoe,qoe,Yoe,Koe,Qoe,Zoe,Joe,$oe,eae,tae,nae,iae,rae,oae,aae,sae,cae,lae,uae,hae,_ae,fae,dae,pae,mae,vae,gae,yae,Sae,xae,Eae,Tae,Cae,Aae,bae,wae,Iae,Pae,Rae,Oae,Dae,Nae,Mae,Lae,Bae,Fae,zae,Uae,Gae,kae,Hae,Vae,Wae,jae,Xae,qae,Yae,Kae,Qae,Zae,Jae,$ae,ese,tse,nse,ise,rse,ose,ase,sse,cse,lse,use,hse,_se,fse,dse,pse,mse,vse,gse,yse,Sse,xse,Ese,Tse,Cse,Ase,bse,wse,Ise,Pse,Rse,Ose,Dse,Nse,Mse,Lse,Bse,Fse,zse,Use,Gse,kse,Hse,Vse,Wse,jse,Xse,qse,Yse,Kse,Qse,Zse,Jse,$se,ece,tce,nce,ice,rce,oce,ace,sce,cce,lce,uce,hce,_ce,fce,dce,pce,mce,vce,gce,yce,Sce,xce,Ece,Tce,Cce,Ace,bce,wce,Ice,Pce,Rce,Oce,Dce,Nce,Mce,Lce,Bce,Fce,zce,Uce,Gce,kce,Hce,Vce,Wce,jce,Xce,qce,Yce,Kce,Qce,Zce,Jce,$ce,ele,tle=(ioe=Ic("cc.RotationOvertimeModule"),roe=il(),ooe=il(),aoe=Zc(),soe=hl($te),coe=Jc(),loe=il(),uoe=Zc(),hoe=hl($te),_oe=Jc(),foe=il(),doe=Zc(),poe=hl($te),moe=Jc(),voe=il(),goe=Zc(),ioe((boe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_enable",xoe,ae(t)),le(t,"_separateAxes",Eoe,ae(t)),le(t,"x",Toe,ae(t)),le(t,"y",Coe,ae(t)),le(t,"z",Aoe,ae(t)),t.name=Zie,t._startMat=new Yn,t._matRot=new Yn,t._quatRot=new Gn,t._otherEuler=new Nn,t}ee(t,e);var n=t.prototype;return n._processRotation=function(e){var t=e.particleSystem.processor.getInfo().renderMode;t!==are.Mesh&&t===are.StrecthedBillboard&&this._quatRot.set(0,0,0,1),Gn.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=pie.INDENTIFY_NEG_QUAT)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=Sn(e.randomSeed+125292),r=e.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==are.VerticalBillboard&&r!==are.HorizontalBillboard?Gn.fromEuler(e.deltaQuat,this.x.evaluate(n,i)*t*pie.R2D,this.y.evaluate(n,i)*t*pie.R2D,this.z.evaluate(n,i)*t*pie.R2D):Gn.fromEuler(e.deltaQuat,0,0,this.z.evaluate(n,i)*t*pie.R2D),e.deltaMat=Yn.fromQuat(e.deltaMat,e.deltaQuat),e.localMat=e.localMat.multiply(e.deltaMat),e.startRotated||(r!==are.Mesh&&(r===are.StrecthedBillboard?e.startEuler.set(0,0,0):r!==are.Billboard&&e.startEuler.set(0,0,e.startEuler.z)),Gn.fromEuler(e.startRotation,e.startEuler.x*pie.R2D,e.startEuler.y*pie.R2D,e.startEuler.z*pie.R2D),e.startRotated=!0),this._startMat=Yn.fromQuat(this._startMat,e.startRotation),this._matRot=this._startMat.multiply(e.localMat),Yn.getRotation(this._quatRot,this._matRot),this._processRotation(e,pie.R2D),e.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),t}(nre),xoe=ue((Soe=boe).prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(Soe.prototype,"enable",[roe],Object.getOwnPropertyDescriptor(Soe.prototype,"enable"),Soe.prototype),Eoe=ue(Soe.prototype,"_separateAxes",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(Soe.prototype,"separateAxes",[ooe,aoe],Object.getOwnPropertyDescriptor(Soe.prototype,"separateAxes"),Soe.prototype),Toe=ue(Soe.prototype,"x",[soe,Bc,coe,rl,loe,uoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Coe=ue(Soe.prototype,"y",[hoe,Bc,_oe,rl,foe,doe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Aoe=ue(Soe.prototype,"z",[poe,Bc,moe,rl,voe,goe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),yoe=Soe))||yoe),nle=(Loe=Ic("cc.SizeOvertimeModule"),Boe=il(),Foe=il(),zoe=Zc(),Uoe=hl($te),Goe=Jc(),koe=il(),Hoe=Zc(),Voe=hl($te),Woe=Jc(),joe=il(),Xoe=Zc(),qoe=hl($te),Yoe=Jc(),Koe=il(),Qoe=Zc(),Zoe=hl($te),Joe=Jc(),$oe=il(),eae=Zc(),Loe((lae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_enable",iae,ae(t)),le(t,"separateAxes",rae,ae(t)),le(t,"size",oae,ae(t)),le(t,"x",aae,ae(t)),le(t,"y",sae,ae(t)),le(t,"z",cae,ae(t)),t.name=Jie,t}return ee(t,e),t.prototype.animate=function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,n=Sn(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,n),e.size.y=e.startSize.y*this.y.evaluate(t,n),e.size.z=e.startSize.z*this.z.evaluate(t,n)}else Nn.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,Sn(e.randomSeed+39825)))},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(nre),iae=ue((nae=lae).prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(nae.prototype,"enable",[Boe],Object.getOwnPropertyDescriptor(nae.prototype,"enable"),nae.prototype),rae=ue(nae.prototype,"separateAxes",[Bc,Foe,zoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oae=ue(nae.prototype,"size",[Uoe,Bc,Goe,koe,Hoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),aae=ue(nae.prototype,"x",[Voe,Bc,Woe,joe,Xoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),sae=ue(nae.prototype,"y",[qoe,Bc,Yoe,Koe,Qoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),cae=ue(nae.prototype,"z",[Zoe,Bc,Joe,$oe,eae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),tae=nae))||tae),ile=90794,rle=ct({Grid:0}),ole=ct({WholeSheet:0,SingleRow:1}),ale=(uae=Ic("cc.TextureAnimationModule"),hae=Fc("numTilesX"),_ae=Fc("numTilesY"),fae=il(),dae=hl(rle),pae=hl(rle),mae=il(),vae=Zc(),gae=il(),yae=Zc(),Sae=il(),xae=Zc(),Eae=hl(ole),Tae=il(),Cae=Zc(),Aae=hl($te),bae=Jc(),wae=il(),Iae=Zc(),Pae=hl($te),Rae=Jc(),Oae=il(),Dae=Zc(),Nae=il(),Mae=Zc(),Lae=il(),Bae=Zc(),Fae=il(),zae=Zc(),uae((ese=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_enable",kae,ae(t)),le(t,"_numTilesX",Hae,ae(t)),le(t,"_numTilesY",Vae,ae(t)),le(t,"_mode",Wae,ae(t)),le(t,"animation",jae,ae(t)),le(t,"frameOverTime",Xae,ae(t)),le(t,"startFrame",qae,ae(t)),le(t,"cycleCount",Yae,ae(t)),le(t,"_flipU",Kae,ae(t)),le(t,"_flipV",Qae,ae(t)),le(t,"_uvChannelMask",Zae,ae(t)),le(t,"randomRow",Jae,ae(t)),le(t,"rowIndex",$ae,ae(t)),t.name=$ie,t}ee(t,e);var n=t.prototype;return n.init=function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=this.startFrame.evaluate(t,Sn(e.randomSeed+ile))/(this.numTilesX*this.numTilesY);if(this.animation===ole.WholeSheet)e.frameIndex=Cn(this.cycleCount*(this.frameOverTime.evaluate(t,Sn(e.randomSeed+ile))+n),1);else if(this.animation===ole.SingleRow){var i=1/this.numTilesY;if(this.randomRow){var r=Cn(this.cycleCount*(this.frameOverTime.evaluate(t,Sn(e.randomSeed+ile))+n),1),o=e.startRow*i,a=o+i;e.frameIndex=dn(o,a,r)}else{var s=this.rowIndex*i,c=s+i;e.frameIndex=dn(s,c,Cn(this.cycleCount*(this.frameOverTime.evaluate(t,Sn(e.randomSeed+ile))+n),1))}}},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}},{key:"mode",get:function(){return this._mode},set:function(e){e!==rle.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),t}(nre),kae=ue((Gae=ese).prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hae=ue(Gae.prototype,"_numTilesX",[hae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vae=ue(Gae.prototype,"_numTilesY",[_ae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(Gae.prototype,"enable",[fae],Object.getOwnPropertyDescriptor(Gae.prototype,"enable"),Gae.prototype),Wae=ue(Gae.prototype,"_mode",[dae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rle.Grid}}),ue(Gae.prototype,"mode",[pae,mae,vae],Object.getOwnPropertyDescriptor(Gae.prototype,"mode"),Gae.prototype),ue(Gae.prototype,"numTilesX",[gae,yae],Object.getOwnPropertyDescriptor(Gae.prototype,"numTilesX"),Gae.prototype),ue(Gae.prototype,"numTilesY",[Sae,xae],Object.getOwnPropertyDescriptor(Gae.prototype,"numTilesY"),Gae.prototype),jae=ue(Gae.prototype,"animation",[Eae,Bc,Tae,Cae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ole.WholeSheet}}),Xae=ue(Gae.prototype,"frameOverTime",[Aae,Bc,bae,wae,Iae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),qae=ue(Gae.prototype,"startFrame",[Pae,Bc,Rae,Oae,Dae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Yae=ue(Gae.prototype,"cycleCount",[Bc,Nae,Mae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kae=ue(Gae.prototype,"_flipU",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qae=ue(Gae.prototype,"_flipV",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zae=ue(Gae.prototype,"_uvChannelMask",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Jae=ue(Gae.prototype,"randomRow",[Bc,Lae,Bae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$ae=ue(Gae.prototype,"rowIndex",[Bc,Fae,zae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uae=Gae))||Uae),sle=197866,cle=new Nn,lle=(tse=Ic("cc.VelocityOvertimeModule"),nse=il(),ise=hl($te),rse=Jc(),ose=il(),ase=Zc(),sse=hl($te),cse=Jc(),lse=il(),use=Zc(),hse=hl($te),_se=Jc(),fse=il(),dse=Zc(),pse=hl($te),mse=Jc(),vse=il(),gse=Zc(),yse=hl(ire),Sse=il(),xse=Zc(),tse((Rse=function(e){function t(){var t;return le(t=e.call(this)||this,"_enable",Cse,ae(t)),le(t,"x",Ase,ae(t)),le(t,"y",bse,ae(t)),le(t,"z",wse,ae(t)),le(t,"speedModifier",Ise,ae(t)),le(t,"space",Pse,ae(t)),t.rotation=void 0,t.needTransform=void 0,t.name="velocityModule",t.rotation=new Gn,t.speedModifier.constant=1,t.needTransform=!1,t.needUpdate=!0,t}ee(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=dre(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=Nn.set(cle,this.x.evaluate(t,Sn(e.randomSeed^sle)),this.y.evaluate(t,Sn(156497^e.randomSeed)),this.z.evaluate(t,Sn(984136^e.randomSeed)));this.needTransform&&Nn.transformQuat(n,n,this.rotation),Nn.add(e.animatedVelocity,e.animatedVelocity,n),Nn.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),Nn.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,Sn(e.randomSeed+sle)))},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(nre),Cse=ue((Tse=Rse).prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(Tse.prototype,"enable",[nse],Object.getOwnPropertyDescriptor(Tse.prototype,"enable"),Tse.prototype),Ase=ue(Tse.prototype,"x",[ise,Bc,rse,ose,ase],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),bse=ue(Tse.prototype,"y",[sse,Bc,cse,lse,use],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),wse=ue(Tse.prototype,"z",[hse,Bc,_se,fse,dse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Ise=ue(Tse.prototype,"speedModifier",[pse,Bc,mse,vse,gse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Pse=ue(Tse.prototype,"space",[yse,Bc,Sse,xse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ire.Local}}),Ese=Tse))||Ese),ule=e("Burst",(Ose=Ic("cc.Burst"),Dse=hl($te),Nse=Jc(),Ose((Gse=function(){function e(){le(this,"_time",Bse,this),le(this,"_repeatCount",Fse,this),le(this,"repeatInterval",zse,this),le(this,"count",Use,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var t=e.prototype;return t.update=function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var n=Cn(e._time-e.startDelay.evaluate(0,1),e.duration)-t;n=n>0?n:0;var i=Cn(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=n&&this._curTime<i&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(i-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},t.reset=function(){this._remainingCount=0,this._curTime=0},t.getMaxCount=function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)},J(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),e}(),Bse=ue((Lse=Gse).prototype,"_time",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(Lse.prototype,"time",[qc],Object.getOwnPropertyDescriptor(Lse.prototype,"time"),Lse.prototype),Fse=ue(Lse.prototype,"_repeatCount",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ue(Lse.prototype,"repeatCount",[qc],Object.getOwnPropertyDescriptor(Lse.prototype,"repeatCount"),Lse.prototype),zse=ue(Lse.prototype,"repeatInterval",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Use=ue(Lse.prototype,"count",[Dse,Bc,Nse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Mse=Lse))||Mse)),hle=new Nn(0,0,0),_le=[],fle=new Nn(.5,.5,.5),dle=(kse=Ic("cc.ShapeModule"),Hse=il(),Vse=Zc(),Wse=il(),jse=Zc(),Xse=il(),qse=Zc(),Yse=il(),Kse=Zc(),Qse=il(),Zse=Zc(),Jse=il(),$se=hl(sre),ece=Fc("shapeType"),tce=il(),nce=hl(sre),ice=Zc(),rce=hl(cre),oce=il(),ace=Zc(),sce=il(),cce=Zc(),lce=il(),uce=Zc(),hce=il(),_ce=Zc(),fce=il(),dce=Zc(),pce=il(),mce=Zc(),vce=il(),gce=Zc(),yce=hl(lre),Sce=il(),xce=Zc(),Ece=Yc(),Tce=il(),Cce=Zc(),Ace=hl($te),bce=Yc(),wce=Jc(),Ice=il(),Pce=Zc(),Rce=il(),Oce=Zc(),Dce=il(),Nce=Zc(),kse((ue((Lce=function(){function e(){le(this,"_enable",Bce,this),le(this,"_shapeType",Fce,this),le(this,"emitFrom",zce,this),le(this,"alignToDirection",Uce,this),le(this,"randomDirectionAmount",Gce,this),le(this,"sphericalDirectionAmount",kce,this),le(this,"randomPositionAmount",Hce,this),le(this,"radius",Vce,this),le(this,"radiusThickness",Wce,this),le(this,"arcMode",jce,this),le(this,"arcSpread",Xce,this),le(this,"arcSpeed",qce,this),le(this,"length",Yce,this),le(this,"boxThickness",Kce,this),le(this,"_position",Qce,this),le(this,"_rotation",Zce,this),le(this,"_scale",Jce,this),le(this,"_arc",$ce,this),le(this,"_angle",ele,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Yn,this.quat=new Gn,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var t=e.prototype;return t.onInit=function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time},t.emit=function(e){switch(this.shapeType){case sre.Box:!function(e,t,n,i){switch(e){case cre.Volume:r=n,o=fle,Nn.set(r,gn(-o.x,o.x),gn(-o.y,o.y),gn(-o.z,o.z));break;case cre.Shell:_le.splice(0,_le.length),_le.push(gn(-.5,.5)),_le.push(gn(-.5,.5)),_le.push(.5*Sre()),yre(_le),ple(_le,t),Nn.set(n,_le[0],_le[1],_le[2]);break;case cre.Edge:_le.splice(0,_le.length),_le.push(gn(-.5,.5)),_le.push(.5*Sre()),_le.push(.5*Sre()),yre(_le),ple(_le,t),Nn.set(n,_le[0],_le[1],_le[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,o;Nn.copy(i,fre)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case sre.Circle:!function(e,t,n,i,r){gre(i,e*(1-t),e,n),Nn.normalize(r,i)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case sre.Cone:!function(e,t,n,i,r,o,a,s){switch(e){case cre.Base:gre(a,t*(1-n),t,i),Jn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,Nn.normalize(s,s),a.z=0;break;case cre.Shell:pre(a,i),Jn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r),Nn.normalize(s,s),Jn.multiplyScalar(a,a,t),a.z=0;break;case cre.Volume:gre(a,t*(1-n),t,i),Jn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,Nn.normalize(s,s),a.z=0,Nn.add(a,a,Nn.multiplyScalar(hle,s,o*vn()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case sre.Sphere:!function(e,t,n,i,r){switch(e){case cre.Volume:vre(i,t*(1-n),t),Nn.normalize(r,i);break;case cre.Shell:mre(i),Nn.multiplyScalar(i,i,t),Nn.normalize(r,i);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case sre.Hemisphere:!function(e,t,n,i,r){switch(e){case cre.Volume:vre(i,t*(1-n),t),i.z>0&&(i.z*=-1),Nn.normalize(r,i);break;case cre.Shell:mre(i),Nn.multiplyScalar(i,i,t),i.z>0&&(i.z*=-1),Nn.normalize(r,i);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(e.position.x+=gn(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=gn(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=gn(-this.randomPositionAmount,this.randomPositionAmount)),Nn.transformQuat(e.velocity,e.velocity,this.quat),Nn.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){var t=Nn.normalize(hle,e.position);Nn.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},t.constructMat=function(){Gn.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Yn.fromRTS(this.mat,this.quat,this._position,this._scale)},t.generateArcAngle=function(){if(this.arcMode===lre.Random)return gn(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case lre.Loop:return Cn(e,this._arc);case lre.PingPong:return An(e,this._arc);default:return Cn(e,this._arc)}},J(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return mn(this._arc)},set:function(e){this._arc=pn(e)}},{key:"angle",get:function(){return Math.round(100*mn(this._angle))/100},set:function(e){this._angle=pn(e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case sre.Box:this.emitFrom===cre.Base&&(this.emitFrom=cre.Volume);break;case sre.Cone:this.emitFrom===cre.Edge&&(this.emitFrom=cre.Base);break;case sre.Sphere:case sre.Hemisphere:this.emitFrom!==cre.Base&&this.emitFrom!==cre.Edge||(this.emitFrom=cre.Volume)}}}]),e}()).prototype,"position",[Hse,Vse],Object.getOwnPropertyDescriptor(Lce.prototype,"position"),Lce.prototype),ue(Lce.prototype,"rotation",[Wse,jse],Object.getOwnPropertyDescriptor(Lce.prototype,"rotation"),Lce.prototype),ue(Lce.prototype,"scale",[Xse,qse],Object.getOwnPropertyDescriptor(Lce.prototype,"scale"),Lce.prototype),ue(Lce.prototype,"arc",[Yse,Kse],Object.getOwnPropertyDescriptor(Lce.prototype,"arc"),Lce.prototype),ue(Lce.prototype,"angle",[Qse,Zse],Object.getOwnPropertyDescriptor(Lce.prototype,"angle"),Lce.prototype),Bce=ue(Lce.prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(Lce.prototype,"enable",[Jse],Object.getOwnPropertyDescriptor(Lce.prototype,"enable"),Lce.prototype),Fce=ue(Lce.prototype,"_shapeType",[$se,ece,tce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sre.Cone}}),ue(Lce.prototype,"shapeType",[nce,ice],Object.getOwnPropertyDescriptor(Lce.prototype,"shapeType"),Lce.prototype),zce=ue(Lce.prototype,"emitFrom",[rce,Bc,oce,ace],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cre.Volume}}),Uce=ue(Lce.prototype,"alignToDirection",[Bc,sce,cce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gce=ue(Lce.prototype,"randomDirectionAmount",[Bc,lce,uce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kce=ue(Lce.prototype,"sphericalDirectionAmount",[Bc,hce,_ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hce=ue(Lce.prototype,"randomPositionAmount",[Bc,fce,dce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vce=ue(Lce.prototype,"radius",[Bc,pce,mce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Wce=ue(Lce.prototype,"radiusThickness",[Bc,vce,gce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jce=ue(Lce.prototype,"arcMode",[yce,Bc,Sce,xce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lre.Random}}),Xce=ue(Lce.prototype,"arcSpread",[Ece,Bc,Tce,Cce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qce=ue(Lce.prototype,"arcSpeed",[Ace,bce,wce,Bc,Ice,Pce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Yce=ue(Lce.prototype,"length",[Bc,Rce,Oce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Kce=ue(Lce.prototype,"boxThickness",[Bc,Dce,Nce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(0,0,0)}}),Qce=ue(Lce.prototype,"_position",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(0,0,0)}}),Zce=ue(Lce.prototype,"_rotation",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(0,0,0)}}),Jce=ue(Lce.prototype,"_scale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(1,1,1)}}),$ce=ue(Lce.prototype,"_arc",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pn(360)}}),ele=ue(Lce.prototype,"_angle",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pn(25)}}),Mce=Lce))||Mce);function ple(e,t){t.x>0&&(e[0]+=.5*gn(-t.x,t.x),e[0]=_n(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*gn(-t.y,t.y),e[1]=_n(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*gn(-t.z,t.z),e[2]=_n(e[2],-.5,.5))}var mle,vle,gle,yle,Sle,xle,Ele,Tle,Cle,Ale,ble,wle,Ile,Ple,Rle,Ole,Dle,Nle,Mle,Lle,Ble,Fle,zle,Ule,Gle,kle,Hle,Vle,Wle,jle,Xle,qle,Yle,Kle,Qle=[0,0,1,0,0,1,1,1],Zle=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertAttrs=void 0,t._vertSize=void 0,t._vBuffer=void 0,t._vertAttrsFloatCount=void 0,t._vdataF32=void 0,t._vdataUint32=void 0,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=void 0,t._mesh=void 0,t._vertCount=0,t._indexCount=0,t._startTimeOffset=0,t._lifeTimeOffset=0,t._material=null,t.type=Zg.PARTICLE_BATCH,t._capacity=0,t._vertAttrs=null,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=new Tr([new xr]),t._iaInfoBuffer=t._device.createBuffer(new yr(Si.INDIRECT,Ti.HOST|Ti.DEVICE,uo,uo)),t._subMeshData=null,t._mesh=null,t}ee(t,e);var n=t.prototype;return n.setCapacity=function(e){var t=this._capacity!==e;this._capacity=e,this._subMeshData&&t&&this.rebuild()},n.setVertexAttributes=function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(var n,i=ce(this._vertAttrs);!(n=i()).done;){var r=n.value;r.offset=this._vertSize,this._vertSize+=ao[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},n.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh&&this._capacity>0){var n=this._vertAttrs[this._vertAttrs.findIndex((function(e){return e.name===ir.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,ir.ATTR_TEX_COORD,t,this._vertSize,n);var i=this._vertAttrs.findIndex((function(e){return e.name===ir.ATTR_TEX_COORD3}));if(n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,ir.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,ir.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,ir.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+n/4]=On.WHITE._val;for(var a=new Float32Array(t),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,_=0;_<this._capacity;++_){var f=4*_;c[h++]=f,c[h++]=f+1,c[h++]=f+2,c[h++]=f+3,c[h++]=f+2,c[h++]=f+1}var d=this._device.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return d.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new yr(Si.INDIRECT,Ti.HOST|Ti.DEVICE,uo,uo))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new sw([e],this._vertAttrs,Vi.TRIANGLE_LIST,d,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.updateMaterial=function(e){this._material=e,this.setSubModelMaterial(0,e)},n.addParticleVertexData=function(e,t){if(this._mesh)for(var n=0;n<this._vertCount;n++){var i=(e*this._vertCount+n)*this._vertAttrsFloatCount;this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,i+=2,this._vdataF32[i++]=t[1].z,this._vdataF32[i++]=t[2].x,this._vdataF32[i++]=t[2].y,this._vdataF32[i++]=t[2].z,this._vdataF32[i++]=t[3].x,this._vdataF32[i++]=t[3].y,this._vdataF32[i++]=t[3].z,this._vdataUint32[i++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}},n.addGPUParticleVertexData=function(e,t,n){for(var i=t*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=i;this._vdataF32[o++]=e.position.x,this._vdataF32[o++]=e.position.y,this._vdataF32[o++]=e.position.z,this._vdataF32[o++]=n,this._vdataF32[o++]=e.startSize.x,this._vdataF32[o++]=e.startSize.y,this._vdataF32[o++]=e.startSize.z,this._vdataF32[o++]=Qle[2*r],this._vdataF32[o++]=e.rotation.x,this._vdataF32[o++]=e.rotation.y,this._vdataF32[o++]=e.rotation.z,this._vdataF32[o++]=Qle[2*r+1],this._vdataF32[o++]=e.startColor.r/255,this._vdataF32[o++]=e.startColor.g/255,this._vdataF32[o++]=e.startColor.b/255,this._vdataF32[o++]=e.startColor.a/255,this._vdataF32[o++]=e.velocity.x,this._vdataF32[o++]=e.velocity.y,this._vdataF32[o++]=e.velocity.z,this._vdataF32[o++]=e.startLifetime,this._vdataF32[o++]=e.randomSeed,i+=this._vertAttrsFloatCount}},n.updateGPUParticles=function(e,t,n){for(var i=this._vertAttrsFloatCount*this._vertCount,r=0,o=0,a=0,s=0;s<e;++s)r=s*i,o=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(t-o)<n&&(a=--e*i,this._vdataF32.copyWithin(r,a,a+i),s--);return e},n.constructAttributeIndex=function(){if(this._vertAttrs){var e=this._vertAttrs.findIndex((function(e){return"a_position_starttime"===e.name})),t=this._vertAttrs[e].offset;this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex((function(e){return"a_dir_life"===e.name})),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3}},n.updateIA=function(e){e<=0||(this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo))},n.clear=function(){this._subModels[0].inputAssembler.indexCount=0},n.destroy=function(){e.prototype.destroy.call(this),this._vertAttrs=null,this._vBuffer=null,this._vdataF32=null,this._vdataUint32=null,this._material=null,this._mesh=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},n.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},t}(uy),Jle=function(){function e(e){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=e}var t=e.prototype;return t.getInfo=function(){return this._renderInfo},t.onInit=function(e){this._particleSystem=e},t.onEnable=function(){if(this._particleSystem){this.attachToScene();var e=this._model;e&&(e.node=e.transform=this._particleSystem.node)}},t.onDisable=function(){this.detachFromScene()},t.onDestroy=function(){this._model&&(h.director.root.destroyModel(this._model),this._model=null)},t.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},t.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},t.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===are.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},t.clear=function(){this._model&&(this._model.enabled=!1)},t.getModel=function(){return this._model},t._initModel=function(){this._model||(this._model=h.director.root.createModel(Zle),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},t.updateTrailMaterial=function(){},t.getDefaultTrailMaterial=function(){return null},e}(),$le=new Nn,eue=new Yn,tue=new Gn,nue=(new Nn,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),iue=[0,0,1,0,0,1,1,1],rue=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RGB32F),new Br(ir.ATTR_TEX_COORD1,vi.RGB32F),new Br(ir.ATTR_TEX_COORD2,vi.RGB32F),new Br(ir.ATTR_COLOR,vi.RGBA8,!0)],oue=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RGB32F),new Br(ir.ATTR_TEX_COORD1,vi.RGB32F),new Br(ir.ATTR_TEX_COORD2,vi.RGB32F),new Br(ir.ATTR_COLOR,vi.RGBA8,!0),new Br(ir.ATTR_COLOR1,vi.RGB32F)],aue=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RGB32F),new Br(ir.ATTR_TEX_COORD1,vi.RGB32F),new Br(ir.ATTR_TEX_COORD2,vi.RGB32F),new Br(ir.ATTR_COLOR,vi.RGBA8,!0),new Br(ir.ATTR_TEX_COORD3,vi.RGB32F),new Br(ir.ATTR_NORMAL,vi.RGB32F),new Br(ir.ATTR_COLOR1,vi.RGBA8,!0)],sue={parent:null,owner:null,subModelIdx:0},cue=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._trailDefines=void 0,n._frameTile_velLenScale=void 0,n._tmp_velLenScale=void 0,n._defaultMat=null,n._node_scale=void 0,n._attrs=void 0,n._particles=null,n._defaultTrailMat=null,n._updateList=new Map,n._animateList=new Map,n._runAnimateList=new Array,n._fillDataFunc=null,n._uScaleHandle=0,n._uLenHandle=0,n._uNodeRotHandle=0,n._alignSpace=ore.View,n._inited=!1,n._localMat=new Yn,n._gravity=new ni,n._model=null,n._frameTile_velLenScale=new ni(1,1,0,0),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new ni,n._attrs=new Array(5),n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},n._trailDefines={CC_USE_WORLD_SPACE:!0},n}ee(t,e);var n=t.prototype;return n.onInit=function(t){var n=this;e.prototype.onInit.call(this,t),this._particles=new Ql((function(){return new pie(n)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},n.clear=function(){e.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},n.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},n.onDestroy=function(){var t;null===(t=this._particles)||void 0===t||t.destroy(),e.prototype.onDestroy.call(this)},n.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},n.getDefaultTrailMaterial=function(){return this._defaultTrailMat},n.setNewParticle=function(){},n._initModuleList=function(){var e=this;nue.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=ere.length;t<n;t++){var i=this._animateList[ere[t]];i&&this._runAnimateList.push(i)}},n.enableModule=function(e,t,n){t?(n.needUpdate&&(this._updateList[n.name]=n),n.needAnimate&&(this._animateList[n.name]=n)):(delete this._animateList[e],delete this._updateList[e]),this._runAnimateList.length=0;for(var i=0,r=ere.length;i<r;i++){var o=this._animateList[ere[i]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},n.updateAlignSpace=function(e){this._alignSpace=e},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(e){e&&this.doUpdateRotation(e)},n.doUpdateRotation=function(e){if(this._renderInfo.renderMode===are.Mesh||this._alignSpace!==ore.View){if(this._alignSpace===ore.Local)this._particleSystem.node.getRotation(tue);else if(this._alignSpace===ore.World)this._particleSystem.node.getWorldRotation(tue);else if(this._alignSpace===ore.View){var t;tue.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Gn.fromViewUp(tue,r.forward);break}}}else tue.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,tue)}},n.updateScale=function(e){e&&this.doUpdateScale(e)},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case ire.Local:this._particleSystem.node.getScale(this._node_scale);break;case ire.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(this._uScaleHandle,this._node_scale)},n.updateParticles=function(e){var t=this,n=this._particleSystem;if(!n)return this._particles.length;n.node.getWorldMatrix(eue);var i=(n.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(i),this.doUpdateRotation(i),this._updateList.forEach((function(e){e.update(n._simulationSpace,eue)}));var r=n._trailModule,o=r&&r.enable;if(o&&r.update(),n.simulationSpace===ire.Local){var a=n.node.getRotation();Yn.fromQuat(this._localMat,a),this._localMat.transpose()}for(var s=function(i){var a=t._particles.data[i];if(a.remainingLifetime-=e,Nn.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return o&&r.removeParticle(a),t._particles.removeAt(i),--i,c=i,"continue";if(n.simulationSpace===ire.Local){var s=9.8*-n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,Sn(a.randomSeed))*e;t._gravity.x=0,t._gravity.y=s,t._gravity.z=0,t._gravity.w=1,t._gravity=t._gravity.transformMat4(t._localMat),a.velocity.x+=t._gravity.x,a.velocity.y+=t._gravity.y,a.velocity.z+=t._gravity.z}else a.velocity.y-=9.8*n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,Sn(a.randomSeed))*e;Nn.copy(a.ultimateVelocity,a.velocity),t._runAnimateList.forEach((function(t){t.animate(a,e)})),Nn.scaleAndAdd(a.position,a.position,a.ultimateVelocity,e),o&&r.animate(a,e),c=i},c=0;c<this._particles.length;++c)s(c);return this._model.enabled=this._particles.length>0,this._particles.length},n.updateRenderData=function(){for(var e=0,t=0;t<this._particles.length;++t){var n=this._particles.data[t],i=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(i=n.frameIndex),e=4*t,this._fillDataFunc(n,e,i)}},n.beforeRender=function(){this._model.updateIA(this._particles.length)},n.getParticleCount=function(){return this._particles.length},n.onMaterialModified=function(e){this._inited&&(0===e?this.updateMaterialParams():this.updateTrailMaterial())},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);var n=this._particleSystem._trailModule;n&&n._trailModel&&1===e&&n._trailModel.setSubModelMaterial(0,t)},n._setFillFunc=function(){this._renderInfo.renderMode===are.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===are.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},n._fillMeshData=function(e,t,n){var i=t/4;this._attrs[0]=e.position,$le.z=n,this._attrs[1]=$le,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._model.addParticleVertexData(i,this._attrs)},n._fillStrecthedData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,$le.x=iue[2*i],$le.y=iue[2*i+1],$le.z=n,this._attrs[1]=$le,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=e.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(t++,this._attrs)},n._fillNormalData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,$le.x=iue[2*i],$le.y=iue[2*i+1],$le.z=n,this._attrs[1]=$le,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=null,this._model.addParticleVertexData(t++,this._attrs)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case are.StrecthedBillboard:this._vertAttrs=oue.slice();break;case are.Mesh:this._vertAttrs=aue.slice();break;default:this._vertAttrs=rue.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!=t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1!==n.indexOf("particle")&&-1===n.indexOf("particle-gpu")||e.setMaterial(null,0)}null==e.sharedMaterial&&null==this._defaultMat&&(sue.parent=wv.get("default-particle-material"),sue.owner=this._particleSystem,sue.subModelIdx=0,this._defaultMat=new fy(sue),sue.parent=null,sue.owner=null,sue.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e._simulationSpace===ire.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=i.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var o=this._renderInfo.renderMode,a=this._frameTile_velLenScale;o===are.Billboard?this._defines.CC_RENDER_MODE=0:o===are.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,a.z=this._renderInfo.velocityScale,a.w=this._renderInfo.lengthScale):o===are.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:o===are.VerticalBillboard?this._defines.CC_RENDER_MODE=3:o===are.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+o+" not support.");var s=e._textureAnimationModule;s&&s.enable?(ni.copy(this._tmp_velLenScale,a),Jn.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)):r.setUniform(this._uLenHandle,a);var c,l=this._particleSystem._rotationOvertimeModule;c=l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=c,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},n.updateTrailMaterial=function(){if(this._particleSystem){var e=this._particleSystem,t=e._trailModule;if(t&&t.enable){e.simulationSpace===ire.World||t.space===ire.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var n=e.getMaterialInstance(1);null===n&&null===this._defaultTrailMat&&(sue.parent=wv.get("default-trail-material"),sue.owner=this._particleSystem,sue.subModelIdx=1,this._defaultTrailMat=new fy(sue),sue.parent=null,sue.owner=null,sue.subModelIdx=0),(n=n||this._defaultTrailMat).recompileShaders(this._trailDefines),t.updateMaterial()}}},t}(Jle),lue=new Yn,uue=new ni,hue=new Gn,_ue=new Gn,fue=(new Nn,32),due="a_position_starttime",pue="a_size_uv",mue="a_rotation_uv",vue="a_color",gue="a_dir_life",yue="a_rndSeed",Sue=[new Br(due,vi.RGBA32F),new Br(pue,vi.RGBA32F),new Br(mue,vi.RGBA32F),new Br(vue,vi.RGBA32F),new Br(gue,vi.RGBA32F),new Br(yue,vi.R32F)],xue=[new Br(due,vi.RGBA32F),new Br(pue,vi.RGBA32F),new Br(mue,vi.RGBA32F),new Br(vue,vi.RGBA32F),new Br(gue,vi.RGBA32F),new Br(yue,vi.R32F),new Br(ir.ATTR_TEX_COORD,vi.RGB32F),new Br(ir.ATTR_TEX_COORD3,vi.RGB32F),new Br(ir.ATTR_NORMAL,vi.RGB32F),new Br(ir.ATTR_COLOR1,vi.RGBA8,!0)],Eue={parent:null,owner:null,subModelIdx:0},Tue=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._frameTile_velLenScale=void 0,n._unifrom_velLenScale=void 0,n._tmp_velLenScale=void 0,n._node_scale=void 0,n._vertAttrs=[],n._defaultMat=null,n._particleNum=0,n._tempParticle=null,n._colorTexture=null,n._forceTexture=null,n._velocityTexture=null,n._rotationTexture=null,n._sizeTexture=null,n._animTexture=null,n._uTimeHandle=0,n._uRotHandle=0,n._uNodeRotHandle=0,n._alignSpace=ore.View,n._inited=!1,n._frameTile_velLenScale=new ni(1,1,0,0),n._unifrom_velLenScale=n._frameTile_velLenScale.clone(),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new ni,n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},n._tempParticle=new pie(null),n._particleNum=0,n}ee(t,e);var n=t.prototype;return n.onInit=function(t){e.prototype.onInit.call(this,t),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},n.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},n.setVertexAttributes=function(){e.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},n.clear=function(){e.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},n.enableModule=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;e&&(this.initShaderUniform(e),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e))},n.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},n.setNewParticle=function(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(e){e&&this.doUpdateRotation(e)},n.doUpdateRotation=function(e){if(this._renderInfo.renderMode===are.Mesh||this._alignSpace!==ore.View){if(this._alignSpace===ore.Local)this._particleSystem.node.getRotation(_ue);else if(this._alignSpace===ore.World)this._particleSystem.node.getWorldRotation(_ue);else if(this._alignSpace===ore.View){var t;_ue.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Gn.fromViewUp(_ue,r.forward);break}}}else _ue.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,_ue)}},n.updateScale=function(e){e&&this.doUpdateScale(e)},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case ire.Local:this._particleSystem.node.getScale(this._node_scale);break;case ire.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(e.getHandle("scale"),this._node_scale)},n.updateParticles=function(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._model.enabled=this._particleNum>0,this._particleNum},n.updateRenderData=function(){},n.beforeRender=function(){this._model.updateIA(this._particleNum)},n.updateAlignSpace=function(e){this._alignSpace=e},n.updateShaderUniform=function(e){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(t){var n=t.passes[0];uue.x=this._particleSystem._time,uue.y=e,n.setUniform(this._uTimeHandle,uue),this._particleSystem.node.getWorldRotation(hue),n.setUniform(this._uRotHandle,hue),this.doUpdateRotation(n)}},n.initShaderUniform=function(e){var t=e.passes[0];this._uTimeHandle=t.getHandle("u_timeDelta"),this._uRotHandle=t.getHandle("u_worldRot"),this._uNodeRotHandle=t.getHandle("nodeRotation"),this.doUpdateScale(t),t.setUniform(t.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),uue.x=fue,uue.y=.03125,t.setUniform(t.getHandle("u_sampleInfo"),uue);var n=!1,i=this._particleSystem._forceOvertimeModule;if(n=i&&i.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=n,n){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=ine(fue,i.x,i.y,i.z);var r=t.getHandle("force_over_time_tex0"),o=Mv.getBindingFromHandle(r);t.bindSampler(o,this._forceTexture.getGFXSampler()),t.bindTexture(o,this._forceTexture.getGFXTexture());var a=t.getHandle("u_force_space");t.setUniform(a,i.space);var s=t.getHandle("u_force_mode");t.setUniform(s,this._forceTexture.height)}var c=this._particleSystem._velocityOvertimeModule;if(n=c&&c.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=n,n){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,n,i,r){for(var o=Math.max(tne(t),tne(n),tne(i),tne(r)),a=new Float32Array(e*o*4),s=[t,n,i,r],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<4;u++)for(var h=s[u],_=0,f=0,d=0;d<e;d++){var p=ene(h,c*d,l);f=(_+=p)/(d+1),a[4*d+u]=f}return nne(a,e,o)}(fue,c.x,c.y,c.z,c.speedModifier);var l=t.getHandle("velocity_over_time_tex0"),u=Mv.getBindingFromHandle(l);t.bindSampler(u,this._velocityTexture.getGFXSampler()),t.bindTexture(u,this._velocityTexture.getGFXTexture());var _=t.getHandle("u_velocity_space");t.setUniform(_,c.space);var f=t.getHandle("u_velocity_mode");t.setUniform(f,this._velocityTexture.height)}var d=this._particleSystem._colorOverLifetimeModule;if(n=d&&d.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=n,n){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(e,t){for(var n=function(e){switch(e.mode){case lie.TwoColors:case lie.TwoGradients:return 2;default:return 1}}(t),i=new Uint8Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=hie(t,r*s,a);i[o]=c.r,i[o+1]=c.g,i[o+2]=c.b,i[o+3]=c.a,o+=4}var l=new gv;return l.create(e,n,bm.RGBA8888),l.setFilters(Im.LINEAR,Im.LINEAR),l.setWrapMode(wm.CLAMP_TO_EDGE,wm.CLAMP_TO_EDGE),l.uploadData(i),l}(fue,d.color);var p=t.getHandle("color_over_time_tex0"),m=Mv.getBindingFromHandle(p);t.bindSampler(m,this._colorTexture.getGFXSampler()),t.bindTexture(m,this._colorTexture.getGFXTexture());var v=t.getHandle("u_color_mode");t.setUniform(v,this._colorTexture.height)}var g=this._particleSystem._rotationOvertimeModule;if(n=g&&g.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=n,n){this._rotationTexture&&this._rotationTexture.destroy(),g.separateAxes?this._rotationTexture=ine(fue,g.x,g.y,g.z):this._rotationTexture=function(e,t){for(var n=tne(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=ene(t,r*s,a);i[o+2]=c,o+=4}return nne(i,e,n)}(fue,g.z);var y=t.getHandle("rotation_over_time_tex0"),S=Mv.getBindingFromHandle(y);t.bindSampler(S,this._rotationTexture.getGFXSampler()),t.bindTexture(S,this._rotationTexture.getGFXTexture());var x=t.getHandle("u_rotation_mode");t.setUniform(x,this._rotationTexture.height)}var E=this._particleSystem._sizeOvertimeModule;if(n=E&&E.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=n,n){this._sizeTexture&&this._sizeTexture.destroy(),E.separateAxes?this._sizeTexture=ine(fue,E.x,E.y,E.z,!0):this._sizeTexture=function(e,t){for(var n=tne(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0,s=0;s<n;s++){0;for(var c=0;c<e;c++){var l=ene(t,r*c,s);o=l,i[a]=o,i[a+1]=o,i[a+2]=o,a+=4}}return nne(i,e,n)}(fue,E.size);var T=t.getHandle("size_over_time_tex0"),C=Mv.getBindingFromHandle(T);t.bindSampler(C,this._sizeTexture.getGFXSampler()),t.bindTexture(C,this._sizeTexture.getGFXTexture());var A=t.getHandle("u_size_mode");t.setUniform(A,this._sizeTexture.height)}var b=this._particleSystem._textureAnimationModule;if(n=b&&b.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=n,n){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t,n){for(var i=Math.max(tne(t),tne(n)),r=new Float32Array(e*i*4),o=[t,n],a=1/(e-1),s=0;s<i;s++)for(var c=0;c<2;c++)for(var l=o[c],u=0,h=0,_=0;_<e;_++){var f=ene(l,a*_,s);h=(u+=f)/(_+1),r[4*_+c]=h}return nne(r,e,i)}(fue,b.startFrame,b.frameOverTime);var w=t.getHandle("texture_animation_tex0"),I=Mv.getBindingFromHandle(w);t.bindSampler(I,this._animTexture.getGFXSampler()),t.bindTexture(I,this._animTexture.getGFXTexture());var P=t.getHandle("u_anim_info");uue.x=this._animTexture.height,uue.y=b.numTilesX*b.numTilesY,uue.z=b.cycleCount,t.setUniform(P,uue)}this._defines.USE_VK_SHADER=h.game._gfxDevice.gfxAPI===di.VULKAN},n.getParticleCount=function(){return this._particleNum},n.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case are.StrecthedBillboard:this._vertAttrs=Sue.slice();break;case are.Mesh:this._vertAttrs=xue.slice();break;default:this._vertAttrs=Sue.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!==t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1===n.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=t.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==e.sharedMaterial&&null==this._defaultMat&&(Eue.parent=wv.get("default-particle-gpu-material"),Eue.owner=e,Eue.subModelIdx=0,this._defaultMat=new fy(Eue),Eue.parent=null,Eue.owner=null,Eue.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e.node.getWorldMatrix(lue),e._simulationSpace===ire.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===are.Billboard?this._defines.CC_RENDER_MODE=0:r===are.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===are.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===are.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===are.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support.");var o=e._textureAnimationModule;o&&o.enable?(Jn.set(this._frameTile_velLenScale,o.numTilesX,o.numTilesY),ni.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,ni.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},t}(Jle);function Cue(){var e=lN.root.device;return!!(e.capabilities.maxVertexTextureUnits>=8&&e.getFormatFeatures(vi.RGBA32F)&(wi.RENDER_TARGET|wi.SAMPLED_TEXTURE))||(h.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var Aue,bue,wue,Iue,Pue,Rue,Oue,Due,Nue,Mue,Lue,Bue,Fue,zue,Uue,Gue,kue,Hue,Vue,Wue,jue,Xue,que,Yue,Kue,Que,Zue,Jue,$ue,ehe,the,nhe,ihe,rhe,ohe,ahe,she,che,lhe,uhe,hhe,_he,fhe,dhe,phe,mhe,vhe,ghe,yhe,She,xhe,Ehe,The,Che,Ahe,bhe,whe,Ihe,Phe,Rhe,Ohe,Dhe,Nhe,Mhe,Lhe,Bhe,Fhe,zhe,Uhe,Ghe,khe,Hhe,Vhe,Whe,jhe,Xhe,qhe,Yhe,Khe,Qhe,Zhe,Jhe,$he,e_e,t_e,n_e,i_e,r_e,o_e,a_e,s_e,c_e,l_e,u_e,h_e,__e,f_e,d_e,p_e,m_e,v_e,g_e,y_e,S_e,x_e,E_e,T_e,C_e,A_e,b_e,w_e,I_e,P_e,R_e,O_e,D_e,N_e,M_e,L_e,B_e,F_e,z_e,U_e,G_e,k_e,H_e,V_e,W_e,j_e,X_e,q_e,Y_e,K_e,Q_e,Z_e,J_e,$_e,efe,tfe,nfe,ife,rfe,ofe,afe,sfe,cfe,lfe,ufe,hfe,_fe,ffe,dfe,pfe,mfe,vfe,gfe,yfe,Sfe,xfe,Efe,Tfe,Cfe,Afe,bfe,wfe,Ife,Pfe,Rfe,Ofe,Dfe,Nfe,Mfe,Lfe,Bfe,Ffe,zfe,Ufe,Gfe,kfe,Hfe,Vfe,Wfe,jfe,Xfe,qfe,Yfe,Kfe,Qfe,Zfe,Jfe,$fe,ede,tde,nde,ide,rde,ode,ade,sde,cde,lde,ude,hde,_de,fde,dde,pde,mde,vde,gde,yde,Sde,xde,Ede,Tde,Cde,Ade,bde,wde,Ide,Pde,Rde,Ode,Dde,Nde,Mde,Lde,Bde,Fde,zde,Ude,Gde,kde,Hde,Vde=(mle=Ic("cc.ParticleSystemRenderer"),vle=hl(are),gle=il(),yle=Zc(),Sle=il(),xle=Zc(),Ele=il(),Tle=Zc(),Cle=hl(are),Ale=hl(aY),ble=il(),wle=Zc(),Ile=hl(ig),Ple=il(),Rle=Zc(),Ole=hl(ig),Dle=il(),Nle=Zc(),Mle=il(),Lle=Zc(),Ble=hl(ore),Fle=il(),zle=Zc(),mle((Kle=Yle=function(){function e(){le(this,"_renderMode",kle,this),le(this,"_velocityScale",Hle,this),le(this,"_lengthScale",Vle,this),le(this,"_mesh",Wle,this),le(this,"_mainTexture",jle,this),le(this,"_useGPU",Xle,this),le(this,"_alignSpace",qle,this),this._particleSystem=null}var t=e.prototype;return t.create=function(e){null===this._particleSystem?this._particleSystem=e:this._particleSystem!==e&&M(6033)},t.onInit=function(e){if(this.create(e),this._particleSystem.processor)M(6034);else{var t=this._useGPU&&Cue();this._particleSystem.processor=t?new Tue(this):new cue(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(e)}},t._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new Tue(this):new cue(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},J(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(e){this._mainTexture=e}},{key:"useGPU",get:function(){return this._useGPU},set:function(e){this._useGPU!==e&&(Cue()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(e){this._alignSpace=e,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),e}(),Yle.AlignmentSpace=ore,ue((Gle=Kle).prototype,"renderMode",[vle,gle,yle],Object.getOwnPropertyDescriptor(Gle.prototype,"renderMode"),Gle.prototype),ue(Gle.prototype,"velocityScale",[Sle,xle],Object.getOwnPropertyDescriptor(Gle.prototype,"velocityScale"),Gle.prototype),ue(Gle.prototype,"lengthScale",[Ele,Tle],Object.getOwnPropertyDescriptor(Gle.prototype,"lengthScale"),Gle.prototype),kle=ue(Gle.prototype,"_renderMode",[Cle,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return are.Billboard}}),Hle=ue(Gle.prototype,"_velocityScale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Vle=ue(Gle.prototype,"_lengthScale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Wle=ue(Gle.prototype,"_mesh",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(Gle.prototype,"mesh",[Ale,ble,wle],Object.getOwnPropertyDescriptor(Gle.prototype,"mesh"),Gle.prototype),ue(Gle.prototype,"particleMaterial",[Ile,Ple,al,Rle],Object.getOwnPropertyDescriptor(Gle.prototype,"particleMaterial"),Gle.prototype),ue(Gle.prototype,"trailMaterial",[Ole,Dle,al,Nle],Object.getOwnPropertyDescriptor(Gle.prototype,"trailMaterial"),Gle.prototype),jle=ue(Gle.prototype,"_mainTexture",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xle=ue(Gle.prototype,"_useGPU",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(Gle.prototype,"useGPU",[Mle,Lle],Object.getOwnPropertyDescriptor(Gle.prototype,"useGPU"),Gle.prototype),ue(Gle.prototype,"alignSpace",[Ble,Fle,zle],Object.getOwnPropertyDescriptor(Gle.prototype,"alignSpace"),Gle.prototype),qle=ue(Gle.prototype,"_alignSpace",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ore.View}}),Ule=Gle))||Ule),Wde=Math.cos(pn(100)),jde={position:new Nn,velocity:new Nn},Xde=new Gn,qde=new Yn,Yde=new Nn,Kde=new Nn,Qde=new On,Zde=function(){function e(e){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new Nn,lifetime:0,width:0,velocity:new Nn,direction:0,color:new On})}var t=e.prototype;return t.getElement=function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])},t.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Nn,lifetime:0,width:0,velocity:new Nn,direction:0,color:new On}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]},t.iterateElement=function(e,t,n,i){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)t(e,this.trailElements[o%this.trailElements.length],n,i)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},t.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},t.clear=function(){this.start=-1,this.end=-1},e}(),Jde=(Aue=Ic("cc.TrailModule"),bue=il(),wue=hl(ure),Iue=il(),Pue=Zc(),Rue=hl($te),Oue=Jc(),Due=il(),Nue=Zc(),Mue=il(),Lue=Zc(),Bue=hl(ire),Fue=il(),zue=Zc(),Uue=hl(hre),Gue=il(),kue=Zc(),Hue=il(),Vue=Zc(),Wue=hl($te),jue=Jc(),Xue=il(),que=Zc(),Yue=il(),Kue=Zc(),Que=hl(uie),Zue=il(),Jue=Zc(),$ue=hl(uie),ehe=il(),the=Zc(),nhe=hl(ire),Aue((ue((rhe=function(){var e=t.prototype;function t(){le(this,"_enable",ohe,this),le(this,"mode",ahe,this),le(this,"lifeTime",she,this),le(this,"_minParticleDistance",che,this),le(this,"existWithParticles",lhe,this),le(this,"textureMode",uhe,this),le(this,"widthFromParticle",hhe,this),le(this,"widthRatio",_he,this),le(this,"colorFromParticle",fhe,this),le(this,"colorOverTrail",dhe,this),le(this,"colorOvertime",phe,this),le(this,"_space",mhe,this),le(this,"_particleSystem",vhe,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new Tr([new xr]),this._vertAttrs=[new Br(ir.ATTR_POSITION,vi.RGB32F),new Br(ir.ATTR_TEX_COORD,vi.RGBA32F),new Br(ir.ATTR_TEX_COORD1,vi.RGB32F),new Br(ir.ATTR_COLOR,vi.RGBA8,!0)],this._vertSize=0;for(var e,t=ce(this._vertAttrs);!(e=t()).done;){var n=e.value;this._vertSize+=ao[n.format].size}this._particleTrail=new Map}return e.getModel=function(){return this._trailModel},e.onInit=function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;for(var t=0,n=e.startLifetime.getMax(),i=e.rateOverTime.getMax(),r=e.duration,o=0,a=e.bursts.length;o<a;o++)t+=e.bursts[o].getMaxCount(e)*Math.ceil(n/r);this._trailNum=Math.ceil(n*this.lifeTime.getMax()*60*(i*r+t)),this._trailSegments=new Kl((function(){return new Zde(10)}),Math.ceil(i*r),(function(e){return e.trailElements.length=0})),this._enable&&(this.enable=this._enable)},e.onEnable=function(){this._attachToScene()},e.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},e._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},e._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},e.destroy=function(){this.destroySubMeshData(),this._trailModel&&(lN.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},e.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},e.clear=function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},e.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},e.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===ire.World&&this._particleSystem._simulationSpace===ire.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(qde),this._particleSystem.node.getWorldRotation(Xde)):this._needTransform=!1},e.animate=function(e,t){if(this._trailSegments)if(e.loopCount>e.lastLoop)e.trailDelay>1?(e.lastLoop=e.loopCount,e.trailDelay=0):e.trailDelay++;else{var n=this._particleTrail.get(e);if(!n)return n=this._trailSegments.alloc(),void this._particleTrail.set(e,n);var i=n.getElement(n.end-1);if(this._needTransform?Nn.transformMat4(Yde,e.position,qde):Nn.copy(Yde,e.position),!(i&&(n.iterateElement(this,this._updateTrailElement,e,t),Nn.squaredDistance(i.position,Yde)<this._minSquaredDistance))&&(i=n.addElement())){Nn.copy(i.position,Yde),i.lifetime=0,this.widthFromParticle?i.width=e.size.x*this.widthRatio.evaluate(0,1):i.width=this.widthRatio.evaluate(0,1);var r=n.count();if(2===r){var o=n.getElement(n.end-2);Nn.subtract(o.velocity,i.position,o.position)}else if(r>2){var a=n.getElement(n.end-2),s=n.getElement(n.end-3);Nn.subtract(Yde,s.position,a.position),Nn.subtract(Kde,i.position,a.position),Nn.subtract(a.velocity,Kde,Yde),Nn.equals(Nn.ZERO,a.velocity)&&Nn.copy(a.velocity,Yde),Nn.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,s)}this.colorFromParticle?i.color.set(e.color):i.color.set(this.colorOvertime.evaluate(0,1))}}},e.removeParticle=function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))},e.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var e,t=ce(this._particleTrail.keys());!(e=t()).done;){var n=e.value,i=this._particleTrail.get(n);if(-1!==i.start){var r=4*this.vbOffset/this._vertSize,o=i.start>=i.end?i.end+i.trailElements.length:i.end,a=o-i.start,s=1/a,c=i.trailElements[i.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var l=i.start+1;l<o;l++){var u=i.trailElements[l%i.trailElements.length],h=l-i.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/a,1),r,1-h*s,h,5)}this._needTransform?Nn.transformMat4(jde.position,n.position,qde):Nn.copy(jde.position,n.position);var _=this._trailModel;if(_&&_.node.invalidateChildren(Ty.POSITION),1===a||2===a){var f=i.getElement(i.end-1);Nn.subtract(f.velocity,jde.position,f.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=f.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=f.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=f.velocity.z,this._vbF32[this.vbOffset-4]=f.velocity.x,this._vbF32[this.vbOffset-3]=f.velocity.y,this._vbF32[this.vbOffset-2]=f.velocity.z,Nn.subtract(jde.velocity,jde.position,f.position),this._checkDirectionReverse(jde,f)}else if(a>2){var d=i.getElement(i.end-1),p=i.getElement(i.end-2);Nn.subtract(Yde,p.position,d.position),Nn.subtract(Kde,jde.position,d.position),Nn.normalize(Yde,Yde),Nn.normalize(Kde,Kde),Nn.subtract(d.velocity,Kde,Yde),Nn.normalize(d.velocity,d.velocity),this._checkDirectionReverse(d,p),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(d,this.colorOverTrail.evaluate(s,1),r,s,a-1,5),Nn.subtract(jde.velocity,jde.position,d.position),Nn.normalize(jde.velocity,jde.velocity),this._checkDirectionReverse(jde,d)}this.widthFromParticle?jde.width=n.size.x*this.widthRatio.evaluate(0,1):jde.width=this.widthRatio.evaluate(0,1),jde.color=n.color,Nn.equals(jde.velocity,Nn.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(jde,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel.enabled=this.ibOffset>0},e.updateIA=function(e){var t=this._trailModel&&this._trailModel.subModels;if(t&&t.length>0){var n=t[0];n.inputAssembler.vertexBuffers[0].update(this._vbF32),n.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=e,this._iaInfoBuffer.update(this._iaInfo)}},e.beforeRender=function(){this.updateIA(this.ibOffset)},e._createModel=function(){this._trailModel||(this._trailModel=h.director.root.createModel(uy))},e.rebuild=function(){var e=lN.root.device,t=e.createBuffer(new yr(Si.VERTEX|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),n=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(n),this._vbUint32=new Uint32Array(n),t.update(n);var i=e.createBuffer(new yr(Si.INDEX|Si.TRANSFER_DST,Ti.HOST|Ti.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),i.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer(new yr(Si.INDIRECT,Ti.HOST|Ti.DEVICE,uo,uo)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new sw([t],this._vertAttrs,Vi.TRIANGLE_LIST,i,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},e._updateTrailElement=function(e,t,n,i){return t.lifetime+=i,e.colorFromParticle?(t.color.set(n.color),t.color.multiply(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1)),e.widthFromParticle?t.width=n.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime},e._fillVertexBuffer=function(e,t,n,i,r,o){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,Qde.set(e.color),Qde.multiply(t),this._vbUint32[this.vbOffset++]=Qde._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=Qde._val,1&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r-1,this._iBuffer[this.ibOffset++]=n+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r+1,this._iBuffer[this.ibOffset++]=n+2*r+2)},e._checkDirectionReverse=function(e,t){Nn.dot(e.velocity,t.velocity)<Wde?e.direction=1-t.direction:e.direction=t.direction},e.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){e===this._enable&&this._trailModel||(e&&!this._enable&&(this._enable=e,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),e&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e;var t=this._particleSystem;t&&t.processor&&t.processor.updateTrailMaterial()}}]),t}()).prototype,"enable",[bue],Object.getOwnPropertyDescriptor(rhe.prototype,"enable"),rhe.prototype),ohe=ue(rhe.prototype,"_enable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ahe=ue(rhe.prototype,"mode",[wue,Bc,Iue,Pue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ure.Particles}}),she=ue(rhe.prototype,"lifeTime",[Rue,Bc,Oue,Due,Nue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),che=ue(rhe.prototype,"_minParticleDistance",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),ue(rhe.prototype,"minParticleDistance",[Mue,Lue],Object.getOwnPropertyDescriptor(rhe.prototype,"minParticleDistance"),rhe.prototype),ue(rhe.prototype,"space",[Bue,Fue,zue],Object.getOwnPropertyDescriptor(rhe.prototype,"space"),rhe.prototype),lhe=ue(rhe.prototype,"existWithParticles",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uhe=ue(rhe.prototype,"textureMode",[Uue,Bc,Gue,kue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hre.Stretch}}),hhe=ue(rhe.prototype,"widthFromParticle",[Bc,Hue,Vue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_he=ue(rhe.prototype,"widthRatio",[Wue,Bc,jue,Xue,que],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),fhe=ue(rhe.prototype,"colorFromParticle",[Bc,Yue,Kue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dhe=ue(rhe.prototype,"colorOverTrail",[Que,Bc,Zue,Jue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uie}}),phe=ue(rhe.prototype,"colorOvertime",[$ue,Bc,ehe,the],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uie}}),mhe=ue(rhe.prototype,"_space",[nhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ire.World}}),vhe=ue(rhe.prototype,"_particleSystem",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ihe=rhe))||ihe),$de=new Yn,epe=new Gn,tpe=new Nn,npe=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],ipe=function(){function e(e){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new Yn,this._gravity=new ni,this.minPos=new Nn,this.maxPos=new Nn,this._nodePos=new Nn,this._nodeSize=new Nn,this._particleSystem=e,this._processor=this._particleSystem.processor,this._node=e.node,this._particlesAll=[],this._initModuleList()}var t=e.prototype;return t._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},t.setBoundingBoxSize=function(e){this.maxPos.x=this._nodePos.x+e.x,this.maxPos.y=this._nodePos.y+e.y,this.maxPos.z=this._nodePos.z+e.z,this.minPos.x=this._nodePos.x-e.x,this.minPos.y=this._nodePos.y-e.y,this.minPos.z=this._nodePos.z-e.z,this._updateBoundingNode()},t.setBoundingBoxCenter=function(e,t,n){this.maxPos.x=e+.5*this._nodeSize.x,this.maxPos.y=t+.5*this._nodeSize.y,this.maxPos.z=n+.5*this._nodeSize.z,this.minPos.x=e-.5*this._nodeSize.x,this.minPos.y=t-.5*this._nodeSize.y,this.minPos.z=n-.5*this._nodeSize.z,this._updateBoundingNode()},t._initModuleList=function(){var e=this;npe.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=ere.length;t<n;t++){var i=this._animateList[ere[t]];i&&this._runAnimateList.push(i)}},t._emit=function(e,t,i){var r=this._particleSystem,o=this._node,a=r.time%r.duration/r.duration;o.invalidateChildren(Ty.POSITION),r.simulationSpace===ire.World&&(o.getWorldMatrix($de),o.getWorldRotation(epe));for(var s=0;s<e;++s){var c=new pie(r);c.particleSystem=r,c.reset();var l=Sn(yn(0,n));r._shapeModule&&r._shapeModule.enable?r._shapeModule.emit(c):(Nn.set(c.position,0,0,0),Nn.copy(c.velocity,fre)),r._textureAnimationModule&&r._textureAnimationModule.enable&&r._textureAnimationModule.init(c);var u=r.startSpeed.evaluate(a,l);Nn.multiplyScalar(c.velocity,c.velocity,u),r.simulationSpace===ire.World&&(Nn.transformMat4(c.position,c.position,$de),Nn.transformQuat(c.velocity,c.velocity,epe)),Nn.copy(c.ultimateVelocity,c.velocity),Nn.set(c.rotation,0,0,0),r.startSize3D?Nn.set(c.startSize,r.startSizeX.evaluate(a,l),r.startSizeY.evaluate(a,l),r.startSizeZ.evaluate(a,l)):(Nn.set(c.startSize,r.startSizeX.evaluate(a,l),1,1),c.startSize.y=c.startSize.x),Nn.copy(c.size,c.startSize),c.startLifetime=r.startLifetime.evaluate(a,l)+t,c.remainingLifetime=c.startLifetime,i.push(c)}},t._updateParticles=function(e,t){var n=this,i=this._particleSystem;switch(i.node.getWorldMatrix($de),i.scaleSpace){case ire.Local:i.node.getScale(tpe);break;case ire.World:i.node.getWorldScale(tpe)}if(this._updateList.forEach((function(e){e.update(i.simulationSpace,$de)})),i.simulationSpace===ire.Local){var r=i.node.getRotation();Yn.fromQuat(this._localMat,r),this._localMat.transpose()}for(var o=function(r){var o=t[r];if(o.remainingLifetime-=e,Nn.set(o.animatedVelocity,0,0,0),i.simulationSpace===ire.Local){var a=9.8*-i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,Sn(o.randomSeed))*e;n._gravity.x=0,n._gravity.y=a,n._gravity.z=0,n._gravity.w=1,n._gravity=n._gravity.transformMat4(n._localMat),o.velocity.x+=n._gravity.x,o.velocity.y+=n._gravity.y,o.velocity.z+=n._gravity.z}else o.velocity.y-=9.8*i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,Sn(o.randomSeed))*e;Nn.copy(o.ultimateVelocity,o.velocity),n._runAnimateList.forEach((function(t){t.animate(o,e)})),Nn.scaleAndAdd(o.position,o.position,o.ultimateVelocity,e)},a=0;a<t.length;++a)o(a)},t._calculateBounding=function(e){var t=new Nn,n=new Nn,i=new Nn,r=new Nn,o=new Nn(1,1,1);if(this._processor.getInfo().renderMode===are.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var s=new $s;$s.fromPoints(s,a.struct.minPosition,a.struct.maxPosition);var c=Math.max(s.halfExtents.x,s.halfExtents.y,s.halfExtents.z);o.set(c,c,c)}}for(var l=0;l<this._particlesAll.length;++l){var u=this._particlesAll[l];Nn.multiply(t,tpe,u.size),Nn.multiply(t,t,o),n.set(u.position),this._particleSystem.simulationSpace!==ire.World&&Nn.transformMat4(n,n,this._particleSystem.node._mat),e&&0===l?(Nn.subtract(this.minPos,n,t),Nn.add(this.maxPos,n,t)):(Nn.subtract(i,n,t),Nn.add(r,n,t),Nn.min(this.minPos,this.minPos,i),Nn.max(this.maxPos,this.maxPos,r))}},t.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var e=Sn(yn(0,n));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,e),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},t.clear=function(){this._particlesAll.length=0},t.destroy=function(){},e}(),rpe=new Yn,ope=new Gn,ape=Object.getOwnPropertyDescriptor(wB.prototype,"sharedMaterials"),spe=function(t){return e({ParticleSystem:t,ParticleSystemComponent:t}),t}((ghe=Ic("cc.ParticleSystem"),yhe=Xc(),She=Hc(),xhe=Rc(99),Ehe=Jc(),The=il(),Che=Zc(),Ahe=hl(uie),bhe=il(),whe=Zc(),Ihe=hl(ire),Phe=il(),Rhe=Zc(),Ohe=il(),Dhe=Zc(),Nhe=Fc("startSize"),Mhe=Jc(),Lhe=hl($te),Bhe=il(),Fhe=Zc(),zhe=hl($te),Uhe=Jc(),Ghe=il(),khe=Zc(),Hhe=hl($te),Vhe=Jc(),Whe=il(),jhe=Zc(),Xhe=hl($te),qhe=Jc(),Yhe=il(),Khe=Zc(),Qhe=il(),Zhe=Zc(),Jhe=hl($te),$he=Jc(),e_e=il(),t_e=Zc(),n_e=hl($te),i_e=Jc(),r_e=il(),o_e=Zc(),a_e=hl($te),s_e=Fc("startRotation"),c_e=Jc(),l_e=il(),u_e=Zc(),h_e=hl($te),__e=Jc(),f_e=il(),d_e=Zc(),p_e=hl($te),m_e=Jc(),v_e=il(),g_e=Zc(),y_e=il(),S_e=Zc(),x_e=il(),E_e=Zc(),T_e=il(),C_e=Zc(),A_e=hl(ire),b_e=il(),w_e=Zc(),I_e=il(),P_e=Zc(),R_e=il(),O_e=Zc(),D_e=hl($te),N_e=Jc(),M_e=il(),L_e=Zc(),B_e=hl($te),F_e=Jc(),z_e=il(),U_e=Zc(),G_e=hl($te),k_e=Jc(),H_e=il(),V_e=Zc(),W_e=hl([ule]),j_e=il(),X_e=Zc(),q_e=hl(Boolean),Y_e=il(),K_e=Zc(),Q_e=hl(rre),Z_e=il(),J_e=Zc(),$_e=hl(Number),efe=il(),tfe=Zc(),nfe=hl(Number),ife=il(),rfe=Zc(),ofe=hl(Number),afe=il(),sfe=Zc(),cfe=il(),lfe=Zc(),ufe=Fc("enableCulling"),hfe=Yc(),_fe=hl(ig),ffe=Qc(),dfe=hl(_re),pfe=hl(_re),mfe=il(),vfe=Zc(),gfe=hl(dle),yfe=hl(dle),Sfe=il(),xfe=Zc(),Efe=hl(nle),Tfe=hl(nle),Cfe=il(),Afe=Zc(),bfe=hl(lle),wfe=hl(lle),Ife=il(),Pfe=Zc(),Rfe=hl(Poe),Ofe=hl(Poe),Dfe=il(),Nfe=Zc(),Mfe=hl(Noe),Lfe=hl(Noe),Bfe=il(),Ffe=Zc(),zfe=hl(tle),Ufe=hl(tle),Gfe=il(),kfe=Zc(),Hfe=hl(ale),Vfe=hl(ale),Wfe=il(),jfe=Zc(),Xfe=hl(Jde),qfe=hl(Jde),Yfe=il(),Kfe=Zc(),Qfe=hl(Vde),Zfe=il(),Jfe=Zc(),ghe($fe=yhe($fe=She($fe=xhe($fe=kc((Hde=kde=function(e){function t(){var t;return le(t=e.call(this)||this,"startColor",tde,ae(t)),le(t,"scaleSpace",nde,ae(t)),le(t,"startSize3D",ide,ae(t)),le(t,"startSizeX",rde,ae(t)),le(t,"startSizeY",ode,ae(t)),le(t,"startSizeZ",ade,ae(t)),le(t,"startSpeed",sde,ae(t)),le(t,"startRotation3D",cde,ae(t)),le(t,"startRotationX",lde,ae(t)),le(t,"startRotationY",ude,ae(t)),le(t,"startRotationZ",hde,ae(t)),le(t,"startDelay",_de,ae(t)),le(t,"startLifetime",fde,ae(t)),le(t,"duration",dde,ae(t)),le(t,"loop",pde,ae(t)),le(t,"simulationSpeed",mde,ae(t)),le(t,"playOnAwake",vde,ae(t)),le(t,"gravityModifier",gde,ae(t)),le(t,"rateOverTime",yde,ae(t)),le(t,"rateOverDistance",Sde,ae(t)),le(t,"bursts",xde,ae(t)),le(t,"_renderCulling",Ede,ae(t)),le(t,"_cullingMode",Tde,ae(t)),le(t,"_aabbHalfX",Cde,ae(t)),le(t,"_aabbHalfY",Ade,ae(t)),le(t,"_aabbHalfZ",bde,ae(t)),le(t,"_dataCulling",wde,ae(t)),le(t,"_colorOverLifetimeModule",Ide,ae(t)),le(t,"_shapeModule",Pde,ae(t)),le(t,"_sizeOvertimeModule",Rde,ae(t)),le(t,"_velocityOvertimeModule",Ode,ae(t)),le(t,"_forceOvertimeModule",Dde,ae(t)),le(t,"_limitVelocityOvertimeModule",Nde,ae(t)),le(t,"_rotationOvertimeModule",Mde,ae(t)),le(t,"_textureAnimationModule",Lde,ae(t)),le(t,"_trailModule",Bde,ae(t)),le(t,"renderer",Fde,ae(t)),t._isPlaying=void 0,t._isPaused=void 0,t._isStopped=void 0,t._isEmitting=void 0,t._needRefresh=void 0,t._time=void 0,t._emitRateTimeCounter=void 0,t._emitRateDistanceCounter=void 0,t._oldWPos=void 0,t._curWPos=void 0,t._boundingBox=void 0,t._culler=void 0,t._oldPos=void 0,t._curPos=void 0,t._isCulled=void 0,t._isSimulating=void 0,t._customData1=void 0,t._customData2=void 0,t._subEmitters=void 0,t._needAttach=void 0,le(t,"_prewarm",zde,ae(t)),le(t,"_capacity",Ude,ae(t)),le(t,"_simulationSpace",Gde,ae(t)),t.processor=null,t.rateOverTime.constant=10,t.startLifetime.constant=5,t.startSizeX.constant=1,t.startSpeed.constant=5,t._isPlaying=!1,t._isPaused=!1,t._isStopped=!0,t._isEmitting=!1,t._needRefresh=!0,t._needAttach=!1,t._time=0,t._emitRateTimeCounter=0,t._emitRateDistanceCounter=0,t._oldWPos=new Nn,t._curWPos=new Nn,t._boundingBox=null,t._culler=null,t._oldPos=null,t._curPos=null,t._isCulled=!1,t._isSimulating=!0,t._customData1=new Jn,t._customData2=new Jn,t._subEmitters=[],t}ee(t,e);var i=t.prototype;return i.onFocusInEditor=function(){this.renderer.create(this)},i.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},i._onMaterialModified=function(e,t){null!==this.processor&&this.processor.onMaterialModified(e,t)},i._onRebuildPSO=function(e,t){this.processor.onRebuildPSO(e,t)},i._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},i._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},i._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},i.play=function(){if(this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var e=this.processor.getModel();e&&(e.enabled=this.enabledInHierarchy)}},i.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},i.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0;for(var e,t=ce(this.bursts);!(e=t()).done;)e.value.reset()},i.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},i.getParticleCount=function(){return this.processor.getParticleCount()},i.setCustomData1=function(e,t){Jn.set(this._customData1,e,t)},i.setCustomData2=function(e,t){Jn.set(this._customData2,e,t)},i.onDestroy=function(){h.director.off(h.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.onEnable=function(){h.director.on(h.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},i.onDisable=function(){h.director.off(h.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i._calculateBounding=function(e){this._boundingBox&&(this._culler||(this._culler=new ipe(this)),this._culler.calculatePositions(),$s.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),e?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},i.update=function(e){var t,n,i=e*this.simulationSpeed;if(this.renderCulling){var r;if(this._boundingBox||(this._boundingBox=new $s,this._calculateBounding(!1)),this._curPos||(this._curPos=new Nn),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new Nn,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var o=this._curPos.x-this._oldPos.x,a=this._curPos.y-this._oldPos.y,s=this._curPos.z-this._oldPos.z,c=this._boundingBox.center;c.x+=o,c.y+=a,c.z+=s,this._culler.setBoundingBoxCenter(c.x,c.y,c.z),this._oldPos.set(this._curPos)}var l=null===(r=this.node.scene.renderScene)||void 0===r?void 0:r.cameras,u=!0;if(void 0!==l&&this._boundingBox)for(var h=0;h<l.length;++h){var _=l[h];if((_.visibility&this.node.layer)===this.node.layer&&ys.aabbFrustum(this._boundingBox,_.frustum)){u=!1;break}}if(u){if(this._cullingMode!==rre.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===rre.PauseAndCatchup&&(this._time+=i),this._cullingMode!==rre.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=i,this._emit(i),0!==this.processor.updateParticles(i)||this._isEmitting||this.stop();else{var f=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(f),this.processor.updateScale(f)}(this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData(),this._needAttach&&this.getParticleCount()>0&&!this._isCulled)&&((null===(t=this.processor.getModel())||void 0===t?void 0:t.scene)||this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&((null===(n=this._trailModule.getModel())||void 0===n?void 0:n.scene)||this._trailModule._attachToScene()),this._needAttach=!1)},i.beforeRender=function(){var e,t;this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender(),this.getParticleCount()<=0?(null===(t=this.processor.getModel())||void 0===t?void 0:t.scene)&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._needAttach=!1):(null===(e=this.processor.getModel())||void 0===e?void 0:e.scene)||(this._needAttach=!0))},i._onVisibilityChange=function(e){this.processor._model&&(this.processor._model.visFlags=e)},i.emit=function(e,t){var i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(Ty.POSITION),this._needRefresh=!1),this._simulationSpace===ire.World&&(this.node.getWorldMatrix(rpe),this.node.getWorldRotation(ope));for(var r=0;r<e;++r){var o=this.processor.getFreeParticle();if(null===o)return;o.particleSystem=this,o.reset();var a=Sn(yn(0,n));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(o):(Nn.set(o.position,0,0,0),Nn.copy(o.velocity,fre)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(o);var s=this.startSpeed.evaluate(i,a);Nn.multiplyScalar(o.velocity,o.velocity,s),this._simulationSpace===ire.World&&(Nn.transformMat4(o.position,o.position,rpe),Nn.transformQuat(o.velocity,o.velocity,ope)),Nn.copy(o.ultimateVelocity,o.velocity),this.startRotation3D?o.startEuler.set(this.startRotationX.evaluate(i,a),this.startRotationY.evaluate(i,a),this.startRotationZ.evaluate(i,a)):o.startEuler.set(0,0,this.startRotationZ.evaluate(i,a)),o.rotation.set(o.startEuler),this.startSize3D?Nn.set(o.startSize,this.startSizeX.evaluate(i,a),this.startSizeY.evaluate(i,a),this.startSizeZ.evaluate(i,a)):(Nn.set(o.startSize,this.startSizeX.evaluate(i,a),1,1),o.startSize.y=o.startSize.x),Nn.copy(o.size,o.startSize),o.startColor.set(this.startColor.evaluate(i,a)),o.color.set(o.startColor),o.startLifetime=this.startLifetime.evaluate(i,a)+t,o.remainingLifetime=o.startLifetime,o.randomSeed=yn(0,233280),o.loopCount++,this.processor.setNewParticle(o)}},i._prewarmSystem=function(){this.startDelay.mode=Jte.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)},i._emit=function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){var n=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=n,this.emit(n,e)}this.node.getWorldPosition(this._curWPos);var i=Nn.distance(this._curWPos,this._oldWPos);if(Nn.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=i*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}for(var o,a=ce(this.bursts);!(o=a()).done;)o.value.update(this,e)}},i._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),Nn.copy(this._curWPos,this._oldWPos)},i.addSubEmitter=function(e){this._subEmitters.push(e)},i.removeSubEmitter=function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)},i.addBurst=function(e){this.bursts.push(e)},i.removeBurst=function(e){this.bursts.splice(this.bursts.indexOf(e),1)},i.getBoundingX=function(){return this._aabbHalfX},i.getBoundingY=function(){return this._aabbHalfY},i.getBoundingZ=function(){return this._aabbHalfZ},i.setBoundingX=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=e)},i.setBoundingY=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=e)},i.setBoundingZ=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=e)},i._onBeforeSerialize=function(e){var t=this;return this.dataCulling?e.filter((function(e){return!tre.includes(e)||t[e]&&t[e].enable})):e},J(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=Math.floor(e>0?e:0),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(e){this._renderCulling=e,e&&(this._boundingBox||(this._boundingBox=new $s,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(e){this._cullingMode=e}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(e){this.setBoundingX(e)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(e){this.setBoundingY(e)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(e){this.setBoundingZ(e)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(e){this._dataCulling=e}},{key:"sharedMaterials",get:function(){return ape.get.call(this)},set:function(e){ape.set.call(this,e)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(e){e&&(this._colorOverLifetimeModule=e)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(e){e&&(this._shapeModule=e)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(e){e&&(this._sizeOvertimeModule=e)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(e){e&&(this._velocityOvertimeModule=e)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(e){e&&(this._forceOvertimeModule=e)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(e){e&&(this._limitVelocityOvertimeModule=e)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(e){e&&(this._rotationOvertimeModule=e)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(e){e&&(this._textureAnimationModule=e)}},{key:"trailModule",get:function(){return this._trailModule},set:function(e){e&&(this._trailModule=e)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}(wB),kde.CullingMode=rre,ue((ede=Hde).prototype,"capacity",[Ehe,The,Che],Object.getOwnPropertyDescriptor(ede.prototype,"capacity"),ede.prototype),tde=ue(ede.prototype,"startColor",[Ahe,Bc,bhe,whe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uie}}),nde=ue(ede.prototype,"scaleSpace",[Ihe,Bc,Phe,Rhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ire.Local}}),ide=ue(ede.prototype,"startSize3D",[Bc,Ohe,Dhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rde=ue(ede.prototype,"startSizeX",[Nhe,Mhe,Lhe,Bhe,Fhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),ode=ue(ede.prototype,"startSizeY",[zhe,Bc,Uhe,Ghe,khe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),ade=ue(ede.prototype,"startSizeZ",[Hhe,Bc,Vhe,Whe,jhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),sde=ue(ede.prototype,"startSpeed",[Xhe,Bc,qhe,Yhe,Khe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),cde=ue(ede.prototype,"startRotation3D",[Bc,Qhe,Zhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lde=ue(ede.prototype,"startRotationX",[Jhe,Bc,$he,rl,e_e,t_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),ude=ue(ede.prototype,"startRotationY",[n_e,Bc,i_e,rl,r_e,o_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),hde=ue(ede.prototype,"startRotationZ",[a_e,s_e,c_e,rl,l_e,u_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),_de=ue(ede.prototype,"startDelay",[h_e,Bc,__e,f_e,d_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),fde=ue(ede.prototype,"startLifetime",[p_e,Bc,m_e,v_e,g_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),dde=ue(ede.prototype,"duration",[Bc,y_e,S_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),pde=ue(ede.prototype,"loop",[Bc,x_e,E_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ue(ede.prototype,"prewarm",[T_e,C_e],Object.getOwnPropertyDescriptor(ede.prototype,"prewarm"),ede.prototype),ue(ede.prototype,"simulationSpace",[A_e,Bc,b_e,w_e],Object.getOwnPropertyDescriptor(ede.prototype,"simulationSpace"),ede.prototype),mde=ue(ede.prototype,"simulationSpeed",[Bc,I_e,P_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),vde=ue(ede.prototype,"playOnAwake",[Bc,R_e,O_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gde=ue(ede.prototype,"gravityModifier",[D_e,Bc,N_e,M_e,L_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),yde=ue(ede.prototype,"rateOverTime",[B_e,Bc,F_e,z_e,U_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),Sde=ue(ede.prototype,"rateOverDistance",[G_e,Bc,k_e,H_e,V_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $te}}),xde=ue(ede.prototype,"bursts",[W_e,Bc,j_e,X_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ue(ede.prototype,"renderCulling",[q_e,Y_e,K_e],Object.getOwnPropertyDescriptor(ede.prototype,"renderCulling"),ede.prototype),Ede=ue(ede.prototype,"_renderCulling",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(ede.prototype,"cullingMode",[Q_e,Z_e,J_e],Object.getOwnPropertyDescriptor(ede.prototype,"cullingMode"),ede.prototype),Tde=ue(ede.prototype,"_cullingMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rre.Pause}}),ue(ede.prototype,"aabbHalfX",[$_e,efe,tfe],Object.getOwnPropertyDescriptor(ede.prototype,"aabbHalfX"),ede.prototype),Cde=ue(ede.prototype,"_aabbHalfX",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(ede.prototype,"aabbHalfY",[nfe,ife,rfe],Object.getOwnPropertyDescriptor(ede.prototype,"aabbHalfY"),ede.prototype),Ade=ue(ede.prototype,"_aabbHalfY",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(ede.prototype,"aabbHalfZ",[ofe,afe,sfe],Object.getOwnPropertyDescriptor(ede.prototype,"aabbHalfZ"),ede.prototype),bde=ue(ede.prototype,"_aabbHalfZ",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ue(ede.prototype,"dataCulling",[cfe,lfe],Object.getOwnPropertyDescriptor(ede.prototype,"dataCulling"),ede.prototype),wde=ue(ede.prototype,"_dataCulling",[Bc,ufe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(ede.prototype,"sharedMaterials",[fl,hfe,_fe,Bc,ffe],Object.getOwnPropertyDescriptor(ede.prototype,"sharedMaterials"),ede.prototype),Ide=ue(ede.prototype,"_colorOverLifetimeModule",[dfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"colorOverLifetimeModule",[pfe,mfe,vfe],Object.getOwnPropertyDescriptor(ede.prototype,"colorOverLifetimeModule"),ede.prototype),Pde=ue(ede.prototype,"_shapeModule",[gfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"shapeModule",[yfe,Sfe,xfe],Object.getOwnPropertyDescriptor(ede.prototype,"shapeModule"),ede.prototype),Rde=ue(ede.prototype,"_sizeOvertimeModule",[Efe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"sizeOvertimeModule",[Tfe,Cfe,Afe],Object.getOwnPropertyDescriptor(ede.prototype,"sizeOvertimeModule"),ede.prototype),Ode=ue(ede.prototype,"_velocityOvertimeModule",[bfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"velocityOvertimeModule",[wfe,Ife,Pfe],Object.getOwnPropertyDescriptor(ede.prototype,"velocityOvertimeModule"),ede.prototype),Dde=ue(ede.prototype,"_forceOvertimeModule",[Rfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"forceOvertimeModule",[Ofe,Dfe,Nfe],Object.getOwnPropertyDescriptor(ede.prototype,"forceOvertimeModule"),ede.prototype),Nde=ue(ede.prototype,"_limitVelocityOvertimeModule",[Mfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"limitVelocityOvertimeModule",[Lfe,Bfe,Ffe],Object.getOwnPropertyDescriptor(ede.prototype,"limitVelocityOvertimeModule"),ede.prototype),Mde=ue(ede.prototype,"_rotationOvertimeModule",[zfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"rotationOvertimeModule",[Ufe,Gfe,kfe],Object.getOwnPropertyDescriptor(ede.prototype,"rotationOvertimeModule"),ede.prototype),Lde=ue(ede.prototype,"_textureAnimationModule",[Hfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"textureAnimationModule",[Vfe,Wfe,jfe],Object.getOwnPropertyDescriptor(ede.prototype,"textureAnimationModule"),ede.prototype),Bde=ue(ede.prototype,"_trailModule",[Xfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ue(ede.prototype,"trailModule",[qfe,Yfe,Kfe],Object.getOwnPropertyDescriptor(ede.prototype,"trailModule"),ede.prototype),Fde=ue(ede.prototype,"renderer",[Qfe,Bc,Zfe,Jfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vde}}),zde=ue(ede.prototype,"_prewarm",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ude=ue(ede.prototype,"_capacity",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Gde=ue(ede.prototype,"_simulationSpace",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ire.Local}}),$fe=ede))||$fe)||$fe)||$fe)||$fe)||$fe)),cpe=e("ParticleUtils",function(){function e(){}return e.instantiate=function(e){return this.registeredSceneEvent||(lN.on(cN.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new Kl((function(){return t_(e)||new ub}),1,(function(e){return e.destroy()}))),this.particleSystemPool.get(e._uuid).alloc()},e.destroy=function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))},e.play=function(e){for(var t,n=ce(e.getComponentsInChildren(spe));!(t=n()).done;)t.value.play()},e.stop=function(e){for(var t,n=ce(e.getComponentsInChildren(spe));!(t=n()).done;)t.value.stop()},e.onSceneUnload=function(){this.particleSystemPool.forEach((function(e){return e.destroy()})),this.particleSystemPool.clear()},e}());function lpe(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}cpe.particleSystemPool=new Map,cpe.registeredSceneEvent=!1,H(ule.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),k(spe.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),h.ParticleSystemComponent=spe,ot.setClassAlias(spe,"cc.ParticleSystemComponent"),h.BillboardComponent=jte,ot.setClassAlias(jte,"cc.BillboardComponent"),h.LineComponent=die,ot.setClassAlias(die,"cc.LineComponent"),h.ParticleUtils=cpe;var upe=new Nn,hpe=new Nn,_pe=new Nn,fpe=new Nn,dpe=new Nn,ppe=new Nn,mpe=new Nn,vpe=new Nn,gpe=new Nn,ype=new Nn,Spe=new Nn,xpe=new Nn,Epe=new Nn(0,0,0),Tpe=new Nn(0,0,0);function Cpe(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,s=void 0===i.capped||i.capped,c=i.arc||2*Math.PI,l=0;s||(e>0&&l++,t>0&&l++);var u=(o+1)*(a+1);s&&(u+=(o+1)*l+o*l);var h=o*a*6;s&&(h+=o*l*3);var _=new Array(h),f=new Array(3*u),d=new Array(3*u),p=new Array(2*u),m=Math.max(e,t),v=new Nn(-m,-r,-m),g=new Nn(m,r,m),y=Math.sqrt(m*m+r*r),S=0,x=0;return function(){for(var i=[],s=e-t,l=s*s/n*Math.sign(s),u=0;u<=a;u++){for(var h=[],m=u/a,v=m*s+t,g=0;g<=o;++g){var y=g/o,E=y*c,T=Math.sin(E),C=Math.cos(E);f[3*S]=v*T,f[3*S+1]=m*n-r,f[3*S+2]=v*C,Nn.normalize(Epe,Nn.set(Tpe,T,-l,C)),d[3*S]=Epe.x,d[3*S+1]=Epe.y,d[3*S+2]=Epe.z,p[2*S]=2*(1-y)%1,p[2*S+1]=m,h.push(S),++S}i.push(h)}for(var A=0;A<a;++A)for(var b=0;b<o;++b){var w=i[A][b],I=i[A+1][b],P=i[A+1][b+1],R=i[A][b+1];_[x]=w,++x,_[x]=R,++x,_[x]=I,++x,_[x]=R,++x,_[x]=P,++x,_[x]=I,++x}}(),s&&(t>0&&E(!1),e>0&&E(!0)),{positions:f,normals:d,uvs:p,indices:_,minPos:v,maxPos:g,boundingRadius:y};function E(n){for(var i=n?e:t,a=n?1:-1,s=S,l=1;l<=o;++l)f[3*S]=0,f[3*S+1]=r*a,f[3*S+2]=0,d[3*S]=0,d[3*S+1]=a,d[3*S+2]=0,p[2*S]=.5,p[2*S+1]=.5,++S;for(var u=S,h=0;h<=o;++h){var m=h/o*c,v=Math.cos(m),g=Math.sin(m);f[3*S]=i*g,f[3*S+1]=r*a,f[3*S+2]=i*v,d[3*S]=0,d[3*S+1]=a,d[3*S+2]=0,p[2*S]=.5-.5*g*a,p[2*S+1]=.5+.5*v,++S}for(var y=0;y<o;++y){var E=s+y,T=u+y;n?(_[x]=T+1,++x,_[x]=E,++x,_[x]=T,++x):(_[x]=E,++x,_[x]=T+1,++x,_[x]=T,++x)}}}var Ape,bpe,wpe,Ipe,Ppe,Rpe,Ope,Dpe,Npe,Mpe=new Nn(0,0,0),Lpe=new Nn(0,0,0),Bpe=new Nn(0,0,0),Fpe=new Nn(0,0,0),zpe=new Nn(0,0,0),Upe=new Nn(0,0,0),Gpe=new Nn(0,0,0),kpe=new Nn(0,0,0),Hpe=new Nn(0,0,0),Vpe=Object.freeze({__proto__:null,box:function(e){var t=(e=e||{}).widthSegments||1,n=e.heightSegments||1,i=e.lengthSegments||1,r=(e.width||1)/2,o=(e.height||1)/2,a=(e.length||1)/2,s=[Nn.set(dpe,-r,-o,a),Nn.set(ppe,r,-o,a),Nn.set(mpe,r,o,a),Nn.set(vpe,-r,o,a),Nn.set(gpe,r,-o,-a),Nn.set(ype,-r,-o,-a),Nn.set(Spe,-r,o,-a),Nn.set(xpe,r,o,-a)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],h=[],_=[],f=[],d=[],p=[],m=new Nn(-r,-o,-a),v=new Nn(r,o,a),g=Math.sqrt(r*r+o*o+a*a);function y(e,t,n){var i,r,o,a,m=h.length/3,v=c[e],g=l[e],y=u[e];for(a=0;a<=n;a++)for(o=0;o<=t;o++)if(i=o/t,r=a/n,Nn.lerp(upe,s[v[0]],s[v[1]],i),Nn.lerp(hpe,s[v[0]],s[v[2]],r),Nn.subtract(_pe,hpe,s[v[0]]),Nn.add(fpe,upe,_pe),h.push(fpe.x,fpe.y,fpe.z),_.push(g[0],g[1],g[2]),f.push(i,r),d.push(y[0],y[1],y[2],y[3]),o<t&&a<n){var S=t+1,x=o+a*S,E=o+(a+1)*S,T=o+1+(a+1)*S,C=o+1+a*S;p.push(m+x,m+C,m+E),p.push(m+E,m+C,m+T)}}return y(0,t,n),y(4,i,n),y(1,t,n),y(5,i,n),y(3,t,i),y(2,t,i),{positions:h,normals:_,uvs:f,tangents:d,indices:p,minPos:m,maxPos:v,boundingRadius:g}},cone:function(e,t,n){return void 0===e&&(e=.5),void 0===t&&(t=1),void 0===n&&(n={}),Cpe(0,e,t,n)},cylinder:Cpe,plane:function(e){var t=function(e){return(e=lpe(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),n=t.width,i=t.length,r=t.widthSegments,o=t.lengthSegments,a=.5*n,s=.5*i,c=[],l=[],u=[],h=new Nn(-a,0,-s),_=new Nn(a,0,s),f=Math.sqrt(n*n+i*i);Nn.set(zpe,-a,0,s),Nn.set(Upe,a,0,s),Nn.set(Gpe,-a,0,-s);for(var d=0;d<=o;d++)for(var p=0;p<=r;p++){var m=p/r,v=d/o;if(Nn.lerp(Mpe,zpe,Upe,m),Nn.lerp(Lpe,zpe,Gpe,v),Nn.subtract(Bpe,Lpe,zpe),Nn.add(Fpe,Mpe,Bpe),c.push(Fpe.x,Fpe.y,Fpe.z),t.includeUV&&l.push(m,v),p<r&&d<o){var g=r+1,y=p+d*g,S=p+(d+1)*g,x=p+1+(d+1)*g,E=p+1+d*g;u.push(y,E,S),u.push(E,x,S)}}var T={positions:c,indices:u,minPos:h,maxPos:_,boundingRadius:f};if(t.includeNormal){var C=(o+1)*(r+1),A=new Array(3*C);T.normals=A;for(var b=0;b<C;++b)A[3*b+0]=0,A[3*b+1]=1,A[3*b+2]=0}return t.includeUV&&(T.uvs=l),T},quad:function(e){var t=lpe(e),n={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(n.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(n.uvs=[0,0,0,1,1,1,1,0]),n},sphere:function(e,t){void 0===e&&(e=.5),void 0===t&&(t={});for(var n=void 0!==t.segments?t.segments:32,i=[],r=[],o=[],a=[],s=new Nn(-e,-e,-e),c=new Nn(e,e,e),l=e,u=0;u<=n;++u)for(var h=u*Math.PI/n,_=Math.sin(h),f=-Math.cos(h),d=0;d<=n;++d){var p=2*d*Math.PI/n-Math.PI/2,m=Math.sin(p)*_,v=f,g=Math.cos(p)*_,y=d/n,S=u/n;if(i.push(m*e,v*e,g*e),r.push(m,v,g),o.push(y,S),u<n&&d<n){var x=n+1,E=x*u+d,T=x*(u+1)+d,C=x*(u+1)+d+1,A=x*u+d+1;a.push(E,A,T),a.push(A,C,T)}}return{positions:i,indices:a,normals:r,uvs:o,minPos:s,maxPos:c,boundingRadius:l}},torus:function(e,t,n){void 0===e&&(e=.4),void 0===t&&(t=.1),void 0===n&&(n={});for(var i=n.radialSegments||32,r=n.tubularSegments||32,o=n.arc||2*Math.PI,a=[],s=[],c=[],l=[],u=new Nn(-e-t,-t,-e-t),h=new Nn(e+t,t,e+t),_=e+t,f=0;f<=i;f++)for(var d=0;d<=r;d++){var p=d/r,m=f/i,v=p*o,g=m*Math.PI*2,y=(e+t*Math.cos(g))*Math.sin(v),S=t*Math.sin(g),x=(e+t*Math.cos(g))*Math.cos(v),E=Math.sin(v)*Math.cos(g),T=Math.sin(g),C=Math.cos(v)*Math.cos(g);if(a.push(y,S,x),s.push(E,T,C),c.push(p,m),d<r&&f<i){var A=r+1,b=A*f+d,w=A*(f+1)+d,I=A*(f+1)+d+1,P=A*f+d+1;l.push(b,P,w),l.push(P,I,w)}}return{positions:a,normals:s,uvs:c,indices:l,minPos:u,maxPos:h,boundingRadius:_}},capsule:function(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=n-e-t,o=i.sides||32,a=i.heightSegments||32,s=t/n,c=r/n,l=e/n,u=Math.floor(a*s),h=Math.floor(a*l),_=Math.floor(a*c),f=r+t-n/2,d=t-n/2,p=t-n/2,m=i.arc||2*Math.PI,v=[],g=[],y=[],S=[],x=Math.max(e,t),E=new Nn(-x,-n/2,-x),T=new Nn(x,n/2,x),C=n/2,A=0,b=[];return function(){for(var e=0;e<=u;++e)for(var n=e*Math.PI/u/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,h=r,_=Math.cos(c)*i,f=s/o,d=e/a;if(v.push(l*t,h*t+p,_*t),g.push(l,h,_),y.push(f,d),e<u&&s<o){var m=o+1,x=m*e+s,E=m*(e+1)+s,T=m*(e+1)+s+1,C=m*e+s+1;S.push(x,C,E),S.push(C,T,E)}++A}}(),function(){for(var n=(e-t)/r,i=0;i<=_;i++){for(var a=[],l=i/_,u=l*(e-t)+t,h=0;h<=o;++h){var f=h/o,p=l*c+s,x=f*m-m/4,E=Math.sin(x),T=Math.cos(x);v.push(u*E),v.push(l*r+d),v.push(u*T),Nn.normalize(kpe,Nn.set(Hpe,E,-n,T)),g.push(kpe.x),g.push(kpe.y),g.push(kpe.z),y.push(f,p),a.push(A),++A}b.push(a)}for(var C=0;C<_;++C)for(var w=0;w<o;++w){var I=b[C][w],P=b[C+1][w],R=b[C+1][w+1],O=b[C][w+1];S.push(I),S.push(O),S.push(P),S.push(O),S.push(R),S.push(P)}}(),function(){for(var t=0;t<=h;++t)for(var n=t*Math.PI/h/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,u=Math.sin(c)*i,d=r,p=Math.cos(c)*i,m=s/o,x=t/a+(1-l);if(v.push(u*e,d*e+f,p*e),g.push(u,d,p),y.push(m,x),t<h&&s<o){var E=o+1,T=E*t+s+b[_][o]+1,C=E*(t+1)+s+b[_][o]+1,A=E*(t+1)+s+1+b[_][o]+1,w=E*t+s+1+b[_][o]+1;S.push(T,w,C),S.push(w,A,C)}}}(),{positions:v,normals:g,uvs:y,indices:S,minPos:E,maxPos:T,boundingRadius:C}},circle:function(e){var t=function(e){return(e=lpe(e)).segments=64,e}(e).segments,n=new Array(3*(t+1));n[0]=0,n[1]=0,n[2]=0;var i=new Array(1+2*t);i[0]=0;for(var r=2*Math.PI/t,o=0;o<t;++o){var a=r*o,s=Math.cos(a),c=Math.sin(a),l=3*(o+1);n[l+0]=s,n[l+1]=c,n[l+2]=0;var u=2*o;i[1+u]=o+1,i[1+(u+1)]=o+2}return t>0&&(i[i.length-1]=1),{positions:n,indices:i,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Vi.TRIANGLE_FAN}},translate:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]+=n,e.positions[c]+=i,e.positions[l]+=r}return e.minPos&&(e.minPos.x+=n,e.minPos.y+=i,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=n,e.maxPos.y+=i,e.maxPos.z+=r),e},scale:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]*=n,e.positions[c]*=i,e.positions[l]*=r}return e.minPos&&(e.minPos.x*=n,e.minPos.y*=i,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=n,e.maxPos.y*=i,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(n,i),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Vi.TRIANGLE_LIST)return e;for(var n=[[0,1],[1,2],[2,0]],i=[],r={},o=0;o<t.length;o+=3)for(var a=0;a<3;++a){var s=t[o+n[a][0]],c=t[o+n[a][1]],l=s>c?c<<16|s:s<<16|c;void 0===r[l]&&(r[l]=0,i.push(s,c))}return e.indices=i,e.primitiveMode=Vi.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],n=[],i={},r=0;r<e.length;r+=3)for(var o=0;o<3;++o){var a=e[r+t[o][0]],s=e[r+t[o][1]],c=a>s?s<<16|a:a<<16|s;void 0===i[c]&&(i[c]=0,n.push(a,s))}return n},invWinding:function(e){for(var t=[],n=0;n<e.length;n+=3)t.push(e[n],e[n+2],e[n+1]);return t},toWavefrontOBJ:function(e,t){if(void 0===t&&(t=1),!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Vi.TRIANGLE_LIST)return"";for(var n=e.positions,i=e.uvs,r=e.normals,o=e.indices,a=function(e){return o[e]+1+"/"+(o[e]+1)+"/"+(o[e]+1)},s="",c=0;c<n.length;c+=3)s+="v "+n[c]*t+" "+n[c+1]*t+" "+n[c+2]*t+"\n";for(var l=0;l<i.length;l+=2)s+="vt "+i[l]+" "+i[l+1]+"\n";for(var u=0;u<r.length;u+=3)s+="vn "+r[u]+" "+r[u+1]+" "+r[u+2]+"\n";for(var h=0;h<o.length;h+=3)s+="f "+a(h)+" "+a(h+1)+" "+a(h+2)+"\n";return s},normals:function(e,t,n){void 0===n&&(n=1);for(var i=new Array(2*e.length),r=0;r<e.length/3;++r){var o=3*r,a=6*r;i[a+0]=e[o+0],i[a+1]=e[o+1],i[a+2]=e[o+2],i[a+3]=e[o+0]+t[o+0]*n,i[a+4]=e[o+1]+t[o+1]*n,i[a+5]=e[o+2]+t[o+2]*n}return i},applyDefaultGeometryOptions:lpe});e("primitives",Vpe),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(Npe||(Npe={})),ht(Npe);var Wpe=e("Primitive",(Ape=Ic("cc.Primitive"),bpe=hl(Npe),Ape((Dpe=Ope=function(e){function t(t){var n;return void 0===t&&(t=Npe.BOX),le(n=e.call(this)||this,"type",Ppe,ae(n)),le(n,"info",Rpe,ae(n)),n.type=t,n}return ee(t,e),t.prototype.onLoaded=function(){dY(Vpe[Npe[this.type].toLowerCase()](this.info),this)},t}(aY),Ope.PrimitiveType=Npe,Ppe=ue((Ipe=Dpe).prototype,"type",[bpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Npe.BOX}}),Rpe=ue(Ipe.prototype,"info",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),wpe=Ipe))||wpe));h.Primitive=Wpe,h.primitives=Vpe;var jpe=function(){function e(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new xJ(e),this.jointAnimationInfo=new EJ(e)}var t=e.prototype;return t.releaseSkeleton=function(e){this.jointTexturePool.releaseSkeleton(e)},t.releaseAnimationClip=function(e){this.jointTexturePool.releaseAnimationClip(e)},t.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},e}();h.internal.DataPoolManager=jpe;var Xpe,qpe,Ype,Kpe,Qpe,Zpe,Jpe,$pe,eme,tme,nme,ime,rme,ome,ame,sme,cme,lme,ume,hme,_me=new Yn,fme=new Yn,dme=e("SkeletalAnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this,t,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._parent=null,i._curvesInited=!1,i._animInfoMgr=h.director.root.dataPoolManager.jointAnimationInfo,i}ee(t,e);var n=t.prototype;return n.initialize=function(t){if(!this._curveLoaded){this._parent=t.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,e.prototype.initialize.call(this,t),this._curvesInited=!n;var i=sJ.getOrExtract(this.clip),r=i.frames,o=i.samples;this._frames=r-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/o,this.setUseBaked(n)}},n.setUseBaked=function(t){t?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=e.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,e.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(e){if(this._sockets.length=0,this._targetNode)for(var t=this._targetNode,n=0;n<e.length;++n){var i=e[n],r=t.getChildByPath(i.path);if(i.target){for(var o=sJ.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=Yn.identity(fme)),Yn.fromRTS(_me,c.rotation,c.position,c.scale),Yn.multiply(l,_me,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,_=o.frames,f=[],d=0;d<_;d++){var p;p=h&&l?Yn.multiply(_me,h[d],l):h?h[d]:l||new Yn;var m={pos:new Nn,rot:new Gn,scale:new Nn};Yn.toRTS(p,m.rot,m.pos,m.scale),f.push(m)}this._sockets.push({target:i.target,frames:f})}}},n._setAnimInfoDirty=function(e,t){e.dirty=t},n._sampleCurvesBaked=function(e){var t=e/this.duration,n=this._animInfo,i=this.clip;n.currentClip!==i&&(this._animInfoMgr.switchClip(this._animInfo,i),this._parent.getUsers().forEach((function(e){e.uploadAnimation(i)})));var r=t*this._frames+.5|0;if(r!==n.data[0]){n.data[0]=r,this._setAnimInfoDirty(n,!0);for(var o=0;o<this._sockets.length;++o){var a=this._sockets[o],s=a.target,c=a.frames[r],l=c.pos,u=c.rot,h=c.scale;s.setRTS(u,l,h)}}},t}(f5)),pme=e("Socket",(Xpe=Ic("cc.SkeletalAnimation.Socket"),qpe=hl(ub),Xpe((Qpe=ue((Kpe=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),le(this,"path",Qpe,this),le(this,"target",Zpe,this),this.path=e,this.target=t}).prototype,"path",[Bc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Zpe=ue(Kpe.prototype,"target",[qpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ype=Kpe))||Ype));ot.setClassAlias(pme,"cc.SkeletalAnimationComponent.Socket");var mme=new Yn,vme=new Yn;function gme(e,t,n){void 0===t&&(t=""),void 0===n&&(n=[]);for(var i=0;i<e.children.length;i++){var r=e.children[i];if(r){var o=t?t+"/"+r.name:r.name;n.push(o),gme(r,o,n)}}return n}var yme=function(t){return e({SkeletalAnimation:t,SkeletalAnimationComponent:t}),t}((Jpe=Ic("cc.SkeletalAnimation"),$pe=Xc(),eme=Rc(99),tme=Hc(),nme=hl([pme]),ime=Zc(),rme=Zc(),ome=hl([pme]),Jpe(ame=$pe(ame=eme(ame=kc(ame=tme((hme=ume=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_useBakedAnimation",cme,ae(t)),le(t,"_sockets",lme,ae(t)),t._users=new Set,t._currentBakedState=null,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this);for(var t=this.node.getComponentsInChildren(z$),n=0;n<t.length;++n){var i=t[n];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}},n.onDestroy=function(){e.prototype.onDestroy.call(this),h.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),Q3().removeSockets(this.node,this._sockets),this._removeAllUsers()},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,e.prototype.start.call(this)},n.pause=function(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.pause():e.prototype.pause.call(this)},n.resume=function(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.resume():e.prototype.resume.call(this)},n.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):e.prototype.stop.call(this)},n.querySockets=function(){var e=this._defaultClip&&Object.keys(sJ.getOrExtract(this._defaultClip).joints).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e}),[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],n=0;n<e.length;n++){var i=e[n],r=this.node.getChildByPath(i);r&&(t.push(i),gme(r,i,t))}return t},n.rebuildSocketAnimations=function(){for(var e,t=ce(this._sockets);!(e=t()).done;){var n=e.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,lJ(i,this.node,mme),Yn.fromRTS(vme,r.rotation,r.position,r.scale),Yn.equals(vme,mme)||(r.matrix=mme))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var n=new ub;return n.parent=this.node,this._sockets.push(new pme(e,n)),this.rebuildSocketAnimations(),n},n.notifySkinnedMeshAdded=function(e){var t=this._useBakedAnimation,n=e.associatedAnimation;if(n&&n._users.delete(e),e.associatedAnimation=this,e.setUseBakedAnimation(t,!0),t){var i=this._currentBakedState;i&&e.uploadAnimation(i.clip)}this._users.add(e)},n.notifySkinnedMeshRemoved=function(e){e.associatedAnimation===this||e.associatedAnimation,e.setUseBakedAnimation(!1),e.associatedAnimation=null,this._users.delete(e)},n.getUsers=function(){return this._users},n._createState=function(e,t){return new dme(e,t)},n._doCreateState=function(t,n){var i=e.prototype._doCreateState.call(this,t,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(t,n){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var i=t;this._currentBakedState=i,i.play()}else e.prototype.doPlayOrCrossFade.call(this,t,n)},n._removeAllUsers=function(){var e=this;Array.from(this._users).forEach((function(t){e.notifySkinnedMeshRemoved(t)}))},J(t,[{key:"sockets",get:function(){return this._sockets},set:function(e){if(!this._useBakedAnimation){var t=Q3();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){for(var t in this._useBakedAnimation=e,this._nameToState)this._nameToState[t].setUseBaked(e);this._users.forEach((function(t){t.setUseBakedAnimation(e)})),this._useBakedAnimation?Q3().removeSockets(this.node,this._sockets):(Q3().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),t}(R7),ume.Socket=pme,ue((sme=hme).prototype,"sockets",[nme,ime],Object.getOwnPropertyDescriptor(sme.prototype,"sockets"),sme.prototype),ue(sme.prototype,"useBakedAnimation",[rme],Object.getOwnPropertyDescriptor(sme.prototype,"useBakedAnimation"),sme.prototype),cme=ue(sme.prototype,"_useBakedAnimation",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lme=ue(sme.prototype,"_sockets",[ome],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ame=sme))||ame)||ame)||ame)||ame)||ame));h.SkeletalAnimationComponent=yme,ot.setClassAlias(yme,"cc.SkeletalAnimationComponent");var Sme=function(){function e(){this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}var t=e.prototype;return t.clone=function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t},t.isDone=function(){return!0},t.startWithTarget=function(e){this.originalTarget=e,this.target=e},t.stop=function(){this.target=null},t.step=function(){R(1006)},t.update=function(){R(1007)},t.getTarget=function(){return this.target},t.setTarget=function(e){this.target=e},t.getOriginalTarget=function(){return this.originalTarget},t.setOriginalTarget=function(e){this.originalTarget=e},t.getTag=function(){return this.tag},t.setTag=function(e){this.tag=e},t.reverse=function(){return R(1008),null},t.retain=function(){},t.release=function(){},e}();Sme.TAG_INVALID=-1;var xme=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._duration=0,t._timesForRepeat=1,t}ee(t,e);var n=t.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(e){this._duration=e},n.clone=function(){return new t},t}(Sme),Eme=(function(e){function t(t,n){var i;return void 0===n&&(n=1),(i=e.call(this)||this)._speed=0,i._innerAction=null,t&&i.initWithAction(t,n),i}ee(t,e);var n=t.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(e){this._speed=e},n.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(M(1021),!1)},n.clone=function(){var e=new t;return e.initWithAction(this._innerAction.clone(),this._speed),e},n.startWithTarget=function(e){Sme.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),Sme.prototype.stop.call(this)},n.step=function(e){this._innerAction.step(e*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new t(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction}}(Sme),0),Tme=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},Cme=function(){function e(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var t=e.prototype;return t._searchElementByTarget=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].target)return e[n];return null},t._getElement=function(e,t){var n=this._elementPool.pop();return n||(n=new Tme),n.target=e,n.paused=!!t,n},t._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},t.addAction=function(e,t,n){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+Eme++);var i=this._hashTargets.get(t);i?i.actions||(i.actions=[]):(i=this._getElement(t,n),this._hashTargets.set(t,i),this._arrayTargets.push(i)),i.target=t,i.actions.push(e),e.startWithTarget(t)}else M(1e3)},t.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var n=e[t];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},t.removeAllActionsFromTarget=function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}},t.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),n=this._hashTargets.get(t);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===e){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},t._removeActionByTag=function(e,t,n){for(var i=0,r=t.actions.length;i<r;++i){var o=t.actions[i];if(o&&o.getTag()===e){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t);break}}},t._removeAllActionsByTag=function(e,t,n){for(var i=t.actions.length-1;i>=0;--i){var r=t.actions[i];if(r&&r.getTag()===e){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t)}}},t.removeActionByTag=function(e,t){var n=this;e===Sme.TAG_INVALID&&R(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeActionByTag(e,r,t)}else i.forEach((function(t){n._removeActionByTag(e,t)}))},t.removeAllActionsByTag=function(e,t){var n=this;e===Sme.TAG_INVALID&&R(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeAllActionsByTag(e,r,t)}else i.forEach((function(t){n._removeAllActionsByTag(e,t)}))},t.getActionByTag=function(e,t){e===Sme.TAG_INVALID&&R(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===e)return r}R(1005,e)}return null},t.getNumberOfRunningActionsInTarget=function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0},t.pauseTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)},t.resumeTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)},t.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,n=0;n<t.length;n++){var i=t[n];i&&!i.paused&&(i.paused=!0,e.push(i.target))}return e},t.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},t.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},t.purgeSharedManager=function(){h.director.getScheduler().unscheduleUpdate(this)},t._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},t._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}this._putElement(e),t=!0}return t},t.update=function(e){for(var t,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(t=this._currentTarget).target;if(r instanceof yl&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var o=t.currentAction;t.currentAction=null,this.removeAction(o)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&i--}}},e}(),Ame=e("TweenSystem",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).actionMgr=new Cme,t}return ee(t,e),t.prototype.update=function(e){this.actionMgr.update(e)},J(t,[{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(KD));Ame.ID="TWEEN",Ame.instance=void 0,lN.on(cN.EVENT_INIT,(function(){var e=new Ame;Ame.instance=e,lN.registerSystem(Ame.ID,e,KD.Priority.MEDIUM)}));var bme=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new t},t}(xme),wme=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(wB),t=0;t<e.length;++t)e[t].enabled=!0},n.reverse=function(){return new Ime},n.clone=function(){return new t},t}(bme),Ime=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(wB),t=0;t<e.length;++t)e[t].enabled=!1},n.reverse=function(){return new wme},n.clone=function(){return new t},t}(bme);!function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;n.update=function(){for(var e=this.target.getComponentsInChildren(wB),t=0;t<e.length;++t){var n=e[t];n.enabled=!n.enabled}},n.reverse=function(){return new t},n.clone=function(){return new t}}(bme);var Pme=function(e){function t(t){var n;return(n=e.call(this)||this)._isNeedCleanUp=!0,void 0!==t&&n.init(t),n}ee(t,e);var n=t.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(e){return this._isNeedCleanUp=e,!0},n.reverse=function(){return new t(this._isNeedCleanUp)},n.clone=function(){return new t(this._isNeedCleanUp)},t}(bme),Rme=function(e){function t(t,n,i){var r;return(r=e.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(t,n,i),r}ee(t,e);var n=t.prototype;return n.initWithFunction=function(e,t,n){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},n.clone=function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},t}(bme),Ome=function(e){function t(t){var n;return(n=e.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===t||isNaN(t)||n.initWithDuration(t),n}ee(t,e);var n=t.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(e){return this._duration=0===e?ft.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},n._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},n.clone=function(){var e=new t(this._duration);return this._cloneDecoration(e),e},n.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},n._computeEaseTime=function(e){return e},n.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(e){Sme.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return R(1010),this},n.setAmplitudeRate=function(){R(1011)},n.getAmplitudeRate=function(){return R(1012),0},n.speed=function(e){return e<=0?(R(1013),this):(this._speedMethod=!0,this._speed*=e,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(e){return this._speed=e,this},n.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?(R(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},t}(xme),Dme=function(e){function t(n){var i;(i=e.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return M(1019),ae(i);var o=r.length-1;if(o>=0&&null==r[o]&&R(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}ee(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return M(1025),!1;var n=e._duration,i=t._duration,r=(n*=e._repeatMethod?e._timesForRepeat:1)+(i*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},n.startWithTarget=function(e){Ome.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),Sme.prototype.stop.call(this)},n.update=function(e){var t,n,i=0,r=this._split,o=this._actions,a=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,t=1===r?1:(e-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),t*=n._timesForRepeat,n.update(t>1?t%1:t),this._last=i)},n.reverse=function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},t}(Ome);function Nme(e){var t=e instanceof Array?e:arguments;if(1===t.length)return M(1019),null;var n=t.length-1;n>=0&&null==t[n]&&R(1015);var i=null;if(n>=0){i=t[0];for(var r=1;r<=n;r++)t[r]&&(i=Dme._actionOneTwo(i,t[r]))}return i}Dme._actionOneTwo=function(e,t){var n=new Dme;return n.initWithTwoActions(e,t),n};var Mme=function(e){function t(t,n){var i;return(i=e.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(t,n),i}ee(t,e);var n=t.prototype;return n.initWithAction=function(e,t){var n=e._duration*t;return!!this.initWithDuration(n)&&(this._times=t,this._innerAction=e,e instanceof bme&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},n.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Ome.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),Sme.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<i;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/n,this._nextDt=r>1?1:r;e>=1&&this._total<i&&(t.update(1),this._total++),this._actionInstant||(this._total===i?t.stop():t.update(e-(r-t._duration/n)))}else t.update(e*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(Ome),Lme=function(e){function t(t){var n;return(n=e.call(this)||this)._innerAction=null,t&&n.initWithAction(t),n}ee(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?(this._innerAction=e,!0):(M(1026),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},n.startWithTarget=function(e){Ome.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},n.isDone=function(){return!1},n.reverse=function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(Ome),Bme=function(e){function t(n){var i;(i=e.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return M(1020),ae(i);var o=r.length-1;if(o>=0&&null==r[o]&&R(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}ee(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return M(1027),!1;var n=!1,i=e._duration,r=t._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=e,this._two=t,i>r?this._two=Dme._actionOneTwo(t,Ume(i-r)):i<r&&(this._one=Dme._actionOneTwo(e,Ume(r-i))),n=!0),n},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},n.startWithTarget=function(e){Ome.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},n.stop=function(){this._one.stop(),this._two.stop(),Sme.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},n.reverse=function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},t}(Ome);function Fme(e){var t=e instanceof Array?e:arguments;if(1===t.length)return M(1020),null;t.length>0&&null==t[t.length-1]&&R(1015);for(var n=t[0],i=1;i<t.length;i++)null!=t[i]&&(n=Bme._actionOneTwo(n,t[i]));return n}Bme._actionOneTwo=function(e,t){var n=new Bme;return n.initWithTwoActions(e,t),n};var zme=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.update=function(){},n.reverse=function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e},t}(Ome);function Ume(e){return new zme(e)}var Gme,kme,Hme,Vme,Wme,jme,Xme,qme,Yme,Kme,Qme,Zme,Jme,$me,eve,tve,nve,ive,rve,ove,ave,sve,cve,lve,uve,hve,_ve,fve,dve,pve,mve,vve,gve,yve,Sve,xve,Eve,Tve,Cve,Ave,bve,wve,Ive,Pve,Rve,Ove,Dve,Nve,Mve,Lve,Bve,Fve,zve,Uve,Gve,kve,Hve,Vve,Wve,jve,Xve=function(e){function t(t){var n;return(n=e.call(this)||this)._other=null,t&&n.initWithAction(t),n}ee(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?e===this._other?(M(1029),!1):!!Ome.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(M(1028),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},n.startWithTarget=function(e){Ome.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},n.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),Sme.prototype.stop.call(this)},t}(Ome),qve=e("TweenAction",function(e){function t(t,n,i){var r;if((r=e.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==i)i=Object.create(null);else if(function(e){var t=" [Tween:] ",n=" option is not support in v + "+_,i=e;i.delay&&E(t+"delay"+n),i.repeat&&E(t+"repeat"+n),i.repeatDelay&&E(t+"repeatDelay"+n),i.interpolation&&E(t+"interpolation"+n),i.onStop&&E(t+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var n=(e=e.replace(t,t.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)e="linear";else{var r=n[1];switch(i){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=i+r}}}}return e}(i.easing)),i.progress||(i.progress=r.progress),i.easing&&"string"==typeof i.easing){var o=i.easing;i.easing=nf[o],i.easing||D(1031,o)}for(var a in r._opts=i,r._props=Object.create(null),n)if(n.hasOwnProperty(a)){var s=n[a];if("function"==typeof s&&(s=s()),null!=s&&"string"!=typeof s){var c=void 0,l=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(c=nf[s.easing])||D(1031,s.easing):c=s.easing,l=s.progress,s=s.value);var u=Object.create(null);u.value=s,u.easing=c,u.progress=l,r._props[a]=u}}return r._originProps=n,r.initWithDuration(t),r}ee(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},n.startWithTarget=function(e){Ome.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var i in n){var r=e[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=t?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=t?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(e){var t=this.target;if(t){var n=this._props,i=this._opts,r=e;i.easing&&(r=i.easing(e));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(e):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var _ in u)s.current[_]=l(u[_],h[_],s.current[_],c);t[a]=s.current}i.onUpdate&&i.onUpdate(this.target,e),1===e&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(e,t,n,i){return e+(t-e)*i},t}(Ome)),Yve=function(e){function t(t){var n;return(n=e.call(this)||this)._props=void 0,n._props={},void 0!==t&&n.init(t),n}ee(t,e);var n=t.prototype;return n.init=function(e){for(var t in e)this._props[t]=e[t];return!0},n.update=function(){var e=this._props,t=this.target;for(var n in e)t[n]=e[n]},n.clone=function(){var e=new t;return e.init(this._props),e},t}(bme),Kve=e("Tween",function(){function e(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=Sme.TAG_INVALID,this._target=void 0===e?null:e}var t=e.prototype;return t.tag=function(e){return this._tag=e,this},t.then=function(e){return e instanceof Sme?this._actions.push(e.clone()):this._actions.push(e._union()),this},t.target=function(e){return this._target=e,this},t.start=function(){return this._target?(this._finalAction&&Ame.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),Ame.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(E("Please set target to tween first"),this)},t.stop=function(){return this._finalAction&&Ame.instance.ActionManager.removeAction(this._finalAction),this},t.clone=function(e){var t=this._union();return Qve(e).then(t.clone())},t.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},t.to=function(e,t,n){(n=n||Object.create(null)).relative=!1;var i=new qve(e,t,n);return this._actions.push(i),this},t.by=function(e,t,n){(n=n||Object.create(null)).relative=!0;var i=new qve(e,t,n);return this._actions.push(i),this},t.set=function(e){var t=new Yve(e);return this._actions.push(t),this},t.delay=function(e){var t=Ume(e);return this._actions.push(t),this},t.call=function(e){var t=new Rme(e,undefined,undefined);return this._actions.push(t),this},t.sequence=function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this},t.parallel=function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this},t.repeat=function(t,n){if(t===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof e?n._union():r.pop(),r.push(function(e,t){return new Mme(e,t)}(i,t)),this},t.repeatForever=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new Lme(e)}(n)),this},t.reverseTime=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new Xve(e)}(n)),this},t.hide=function(){var e=new Ime;return this._actions.push(e),this},t.show=function(){var e=new wme;return this._actions.push(e),this},t.removeSelf=function(){var e=new Pme(!1);return this._actions.push(e),this},e.stopAll=function(){Ame.instance.ActionManager.removeAllActions()},e.stopAllByTag=function(e,t){Ame.instance.ActionManager.removeAllActionsByTag(e,t)},e.stopAllByTarget=function(e){Ame.instance.ActionManager.removeAllActionsFromTarget(e)},t._union=function(){var e=this._actions;return 1===e.length?e[0]:Nme(e)},t._destroy=function(){this.stop()},e._wrappedSequence=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return Nme.apply(Nme,t)},e._wrappedParallel=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return Fme.apply(Fme,t)},e}());function Qve(e){return new Kve(e)}function Zve(e){return E("tweenUtil' is deprecated, please use 'tween' instead "),new Kve(e)}Kve._tmp_args=[],h.Tween=Kve,h.tween=Qve,h.tweenUtil=Zve;var Jve,$ve,ege,tge=new On;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(Jve||(Jve={})),ht(Jve),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}($ve||($ve={})),function(e){e.CLICK="click"}(ege||(ege={}));var nge=function(t){return e({Button:t,ButtonComponent:t}),t}((Gme=Ic("cc.Button"),kme=Xc(),Hme=Rc(110),Vme=Hc(),Wme=Pc(Sz),jme=hl(ub),Xme=il(),qme=Zc(),Yme=il(),Kme=Zc(),Qme=hl(Jve),Zme=il(),Jme=Zc(),$me=il(),eve=Zc(),tve=il(),nve=Zc(),ive=il(),rve=Zc(),ove=il(),ave=Zc(),sve=$c(),cve=el(),lve=il(),uve=Zc(),hve=il(),_ve=Zc(),fve=hl(WB),dve=il(),pve=Zc(),mve=hl(WB),vve=il(),gve=Zc(),yve=hl(WB),Sve=il(),xve=Zc(),Eve=hl(WB),Tve=il(),Cve=Zc(),Ave=hl([sB]),bve=il(),wve=Zc(),Gme(Ive=kme(Ive=Hme(Ive=Vme(Ive=Wme(Ive=kc((jve=Wve=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",Rve,ae(t)),le(t,"_interactable",Ove,ae(t)),le(t,"_transition",Dve,ae(t)),le(t,"_normalColor",Nve,ae(t)),le(t,"_hoverColor",Mve,ae(t)),le(t,"_pressedColor",Lve,ae(t)),le(t,"_disabledColor",Bve,ae(t)),le(t,"_normalSprite",Fve,ae(t)),le(t,"_hoverSprite",zve,ae(t)),le(t,"_pressedSprite",Uve,ae(t)),le(t,"_disabledSprite",Gve,ae(t)),le(t,"_duration",kve,ae(t)),le(t,"_zoomScale",Hve,ae(t)),le(t,"_target",Vve,ae(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new On,t._toColor=new On,t._time=0,t._transitionFinished=!0,t._fromScale=new Nn,t._toScale=new Nn,t._originalScale=null,t._sprite=null,t._targetScale=new Nn,t}ee(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(zH);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===Jve.COLOR||this._transition===Jve.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===Jve.COLOR){var i=t._uiProps.uiComp;On.lerp(tge,this._fromColor,this._toColor,n),i&&(i.color=tge)}else this.transition===Jve.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=dn(this._fromScale.x,this._toScale.x,n),this._targetScale.y=dn(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===Jve.COLOR&&this._interactable){var n=e.getComponent(rG);n&&(n.color=this._normalColor)}else t===Jve.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(cC.TOUCH_START,this._onTouchBegan,this),this.node.on(cC.TOUCH_MOVE,this._onTouchMove,this),this.node.on(cC.TOUCH_END,this._onTouchEnded,this),this.node.on(cC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(cC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(cC.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(cC.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(cC.TOUCH_START,this._onTouchBegan,this),this.node.off(cC.TOUCH_MOVE,this._onTouchMove,this),this.node.off(cC.TOUCH_END,this._onTouchEnded,this),this.node.off(cC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(cC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(cC.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(cC.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(zH)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Nn),Nn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===Jve.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case $ve.NORMAL:this._normalSprite=e;break;case $ve.HOVER:this._hoverSprite=e;break;case $ve.PRESSED:this._pressedSprite=e;break;case $ve.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===Jve.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case $ve.NORMAL:this._normalColor=e;break;case $ve.HOVER:this._hoverColor=e;break;case $ve.PRESSED:this._pressedColor=e;break;case $ve.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&Ty.SCALE&&this._originalScale&&this._transition===Jve.SCALE&&this._transitionFinished&&Nn.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.hitTest(t.getLocation());this._transition===Jve.SCALE&&this.target&&this._originalScale?i?(Nn.copy(this._fromScale,this._originalScale),Nn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?$ve.PRESSED:$ve.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(sB.emitEvents(this.clickEvents,e),this.node.emit(ege.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==Jve.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=$ve.NORMAL;return this._interactable?this._pressed?e=$ve.PRESSED:this._hovered&&(e=$ve.HOVER):e=$ve.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(rG);i&&(e===$ve.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===$ve.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(Nn.copy(this._fromScale,this._originalScale),Nn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(Nn.copy(this._fromScale,this.target.getScale()),Nn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===Jve.COLOR?this._updateColorTransition(e):t===Jve.SPRITE?this._updateSpriteTransition(e):t===Jve.SCALE&&this._updateScaleTransition(e)},J(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable!==e&&(this._interactable=e,this._updateState(),this._interactable||this._resetState())}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===Jve.COLOR?this._updateColorTransition($ve.NORMAL):this._transition===Jve.SPRITE&&this._updateSpriteTransition($ve.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(zH);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(th),Wve.Transition=Jve,Wve.EventType=ege,ue((Pve=jve).prototype,"target",[jme,Xme,qme],Object.getOwnPropertyDescriptor(Pve.prototype,"target"),Pve.prototype),ue(Pve.prototype,"interactable",[Yme,Kme],Object.getOwnPropertyDescriptor(Pve.prototype,"interactable"),Pve.prototype),ue(Pve.prototype,"transition",[Qme,Zme,Jme],Object.getOwnPropertyDescriptor(Pve.prototype,"transition"),Pve.prototype),ue(Pve.prototype,"normalColor",[$me,eve],Object.getOwnPropertyDescriptor(Pve.prototype,"normalColor"),Pve.prototype),ue(Pve.prototype,"pressedColor",[tve,nve],Object.getOwnPropertyDescriptor(Pve.prototype,"pressedColor"),Pve.prototype),ue(Pve.prototype,"hoverColor",[ive,rve],Object.getOwnPropertyDescriptor(Pve.prototype,"hoverColor"),Pve.prototype),ue(Pve.prototype,"disabledColor",[ove,ave],Object.getOwnPropertyDescriptor(Pve.prototype,"disabledColor"),Pve.prototype),ue(Pve.prototype,"duration",[sve,cve,lve,uve],Object.getOwnPropertyDescriptor(Pve.prototype,"duration"),Pve.prototype),ue(Pve.prototype,"zoomScale",[hve,_ve],Object.getOwnPropertyDescriptor(Pve.prototype,"zoomScale"),Pve.prototype),ue(Pve.prototype,"normalSprite",[fve,dve,pve],Object.getOwnPropertyDescriptor(Pve.prototype,"normalSprite"),Pve.prototype),ue(Pve.prototype,"pressedSprite",[mve,vve,gve],Object.getOwnPropertyDescriptor(Pve.prototype,"pressedSprite"),Pve.prototype),ue(Pve.prototype,"hoverSprite",[yve,Sve,xve],Object.getOwnPropertyDescriptor(Pve.prototype,"hoverSprite"),Pve.prototype),ue(Pve.prototype,"disabledSprite",[Eve,Tve,Cve],Object.getOwnPropertyDescriptor(Pve.prototype,"disabledSprite"),Pve.prototype),Rve=ue(Pve.prototype,"clickEvents",[Ave,Bc,bve,wve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ove=ue(Pve.prototype,"_interactable",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dve=ue(Pve.prototype,"_transition",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jve.NONE}}),Nve=ue(Pve.prototype,"_normalColor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.WHITE.clone()}}),Mve=ue(Pve.prototype,"_hoverColor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(211,211,211,255)}}),Lve=ue(Pve.prototype,"_pressedColor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.WHITE.clone()}}),Bve=ue(Pve.prototype,"_disabledColor",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(124,124,124,255)}}),Fve=ue(Pve.prototype,"_normalSprite",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zve=ue(Pve.prototype,"_hoverSprite",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uve=ue(Pve.prototype,"_pressedSprite",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gve=ue(Pve.prototype,"_disabledSprite",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kve=ue(Pve.prototype,"_duration",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Hve=ue(Pve.prototype,"_zoomScale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Vve=ue(Pve.prototype,"_target",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ive=Pve))||Ive)||Ive)||Ive)||Ive)||Ive)||Ive));h.Button=nge;var ige,rge,oge,age=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();age._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(ige||(ige={})),ct(ige),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(rge||(rge={})),ct(rge),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(oge||(oge={})),ct(oge);var sge,cge,lge,uge,hge,_ge,fge,dge,pge,mge,vge,gge,yge,Sge,xge,Ege,Tge,Cge,Age,bge,wge,Ige,Pge,Rge,Oge,Dge,Nge,Mge,Lge,Bge,Fge,zge,Uge,Gge,kge,Hge,Vge,Wge,jge,Xge,qge,Yge,Kge,Qge,Zge,Jge,$ge,eye,tye,nye,iye,rye,oye,aye,sye,cye,lye,uye,hye,_ye,fye,dye=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),pye=new Yn,mye=new Yn,vye=new Nn,gye=null,yye=0,Sye=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++yye,t}ee(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===rge.ANY?this._createTextArea():this._createInput(),age.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),age.remove(this),gye===this&&(gye=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,age.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){gye&&gye!==this&&gye.setFocus(!1),this._editing=!0,gye=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){h.GAME_VIEW&&this._edTxt?(h.gameView.container.appendChild(this._edTxt),h.gameView.head.appendChild(this._placeholderStyleSheet)):sN.container&&this._edTxt&&(sN.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(h.GAME_VIEW?xt(h.gameView.container,this._edTxt):xt(sN.container,this._edTxt))&&this._edTxt&&(h.GAME_VIEW?h.gameView.container.removeChild(this._edTxt):sN.container.removeChild(this._edTxt)),(h.GAME_VIEW?xt(h.gameView.head,this._placeholderStyleSheet):xt(document.head,this._placeholderStyleSheet))&&(h.GAME_VIEW?h.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),hh.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),hh.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){hh.os!==lu.ANDROID&&hh.os!==lu.OHOS||(ch.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){hh.os!==lu.ANDROID&&hh.os!==lu.OHOS||(ch.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){hh.browserType!==au.WECHAT||hh.os!==lu.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=yN.getScaleX(),n=yN.getScaleY(),i=1,r=1;h.GAME_VIEW&&(i=h.gameView.canvas.width/h.game.canvas.width,r=h.gameView.canvas.height/h.game.canvas.height),t*=i,n*=r;var o=yN.getViewportRect(),a=ch.devicePixelRatio;e.getWorldMatrix(pye);var s=e._uiProps.uiTransformComp;if(s&&Nn.set(vye,-s.anchorX*s.width,-s.anchorY*s.height,vye.z),Yn.transform(pye,pye,vye),e._uiProps.uiTransformComp){var c=lN.root.batcher2D.getFirstRenderCamera(e);if(c){c.node.getWorldRT(mye);var l=mye.m12,u=mye.m13,_=_N.center;mye.m12=_.x-(mye.m00*l+mye.m04*u),mye.m13=_.y-(mye.m01*l+mye.m05*u),Yn.multiply(mye,mye,pye),t/=a,n/=a;var f=h.GAME_VIEW?h.gameView.container:sN.container,d=mye.m00*t,p=pye.m01,m=pye.m04,v=mye.m05*n,g=parseInt(f&&f.style.paddingLeft||"0");g+=o.x*i/a;var y=parseInt(f&&f.style.paddingBottom||"0");y+=o.y/a;var S="matrix("+d+","+-p+","+-m+","+v+","+(mye.m12*t+g)+","+-(mye.m13*n+y)+")";this._edTxt.style.transform=S,this._edTxt.style["-webkit-transform"]=S,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===oge.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===oge.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===oge.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===rge.EMAIL_ADDR?a="email":t===rge.NUMERIC||t===rge.DECIMAL?a="number":t===rge.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===rge.URL?a="url":(a="text",i===ige.SEARCH&&(a="search")),r.type=a;var s="none";n===oge.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===oge.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,this._updateTextLabel(e.textLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof hF?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case cG.HorizontalAlign.LEFT:i.style.textAlign="left";break;case cG.HorizontalAlign.CENTER:i.style.textAlign="center";break;case cG.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof hF?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case cG.HorizontalAlign.LEFT:a="left";break;case cG.HorizontalAlign.CENTER:a="center";break;case cG.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",hh.browserType===au.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&hh.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===dR.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===dR.TAB&&(n.propagationStopped=!0,n.preventDefault(),age.next(e))},i.onBlur=function(){hh.isMobile&&n&&i.compositionEnd(),e._editing=!1,gye=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}(dye);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(fye||(fye={}));var xye,Eye,Tye,Cye,Aye,bye,wye,Iye,Pye,Rye,Oye,Dye,Nye,Mye,Lye,Bye,Fye,zye,Uye,Gye,kye,Hye,Vye,Wye,jye,Xye,qye,Yye,Kye,Qye,Zye,Jye,$ye,eSe,tSe,nSe,iSe,rSe,oSe,aSe,sSe,cSe,lSe,uSe,hSe,_Se,fSe,dSe,pSe,mSe,vSe,gSe,ySe,SSe,xSe,ESe,TSe,CSe,ASe,bSe,wSe,ISe=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((sge=Ic("cc.EditBox"),cge=Xc(),lge=Rc(110),uge=Hc(),hge=Pc(Sz),_ge=il(),fge=Zc(),dge=il(),pge=Zc(),mge=hl(cG),vge=il(),gge=Zc(),yge=hl(cG),Sge=il(),xge=Zc(),Ege=hl(WB),Tge=il(),Cge=Zc(),Age=hl(oge),bge=il(),wge=Zc(),Ige=hl(rge),Pge=il(),Rge=Zc(),Oge=hl(ige),Dge=il(),Nge=Zc(),Mge=il(),Lge=Zc(),Bge=il(),Fge=Zc(),zge=hl([sB]),Uge=il(),Gge=Zc(),kge=hl([sB]),Hge=il(),Vge=Zc(),Wge=hl([sB]),jge=il(),Xge=Zc(),qge=hl([sB]),Yge=il(),Kge=Zc(),sge(Qge=cge(Qge=lge(Qge=uge(Qge=hge(Qge=kc((_ye=hye=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",Jge,ae(t)),le(t,"textChanged",$ge,ae(t)),le(t,"editingDidEnded",eye,ae(t)),le(t,"editingReturn",tye,ae(t)),t._impl=null,t._background=null,le(t,"_textLabel",nye,ae(t)),le(t,"_placeholderLabel",iye,ae(t)),le(t,"_returnType",rye,ae(t)),le(t,"_string",oye,ae(t)),le(t,"_tabIndex",aye,ae(t)),le(t,"_backgroundImage",sye,ae(t)),le(t,"_inputFlag",cye,ae(t)),le(t,"_inputMode",lye,ae(t)),le(t,"_maxLength",uye,ae(t)),t._isLabelVisible=!1,t}ee(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){sB.emitEvents(this.editingDidBegan,this),this.node.emit(fye.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){sB.emitEvents(this.editingDidEnded,this),this.node.emit(fye.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,sB.emitEvents(this.textChanged,e,this),this.node.emit(fye.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){sB.emitEvents(this.editingReturn,this),this.node.emit(fye.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(cC.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(zH);e||(e=this.node.addComponent(zH)),e!==this._background&&(e.type=zH.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||((t=new ub("TEXT_LABEL")).layer=this.node.layer),(e=t.getComponent(cG))||(e=t.addComponent(cG)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=cG.Overflow.CLAMP,this._inputMode===rge.ANY?(e.verticalAlign=tG.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||((t=new ub("PLACEHOLDER_LABEL")).layer=this.node.layer),(e=t.getComponent(cG))||(e=t.addComponent(cG)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),this._inputMode===rge.ANY?e.enableWrapText=!0:e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==oge.PASSWORD)i===oge.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===oge.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===oge.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=e.length,a=0;a<o;++a)r+="";e=r}return e},n._registerEvent=function(){this.node.on(cC.TOUCH_START,this._onTouchBegan,this),this.node.on(cC.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(cC.TOUCH_START,this._onTouchBegan,this),this.node.off(cC.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(zH.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(zH.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(n+2,i+e.height,o.node.position.z),this._inputMode===rge.ANY&&(o.verticalAlign=tG.TOP),o.enableWrapText=this._inputMode===rge.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),r.enableWrapText=this._inputMode===rge.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize),this._syncSize()},J(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string!==e&&(this._string=e,this._updateString(e))}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag!==e&&(this._inputFlag=e,this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(th),hye._EditBoxImpl=dye,hye.KeyboardReturnType=ige,hye.InputFlag=oge,hye.InputMode=rge,hye.EventType=fye,ue((Zge=_ye).prototype,"string",[_ge,fge],Object.getOwnPropertyDescriptor(Zge.prototype,"string"),Zge.prototype),ue(Zge.prototype,"placeholder",[dge,pge],Object.getOwnPropertyDescriptor(Zge.prototype,"placeholder"),Zge.prototype),ue(Zge.prototype,"textLabel",[mge,vge,gge],Object.getOwnPropertyDescriptor(Zge.prototype,"textLabel"),Zge.prototype),ue(Zge.prototype,"placeholderLabel",[yge,Sge,xge],Object.getOwnPropertyDescriptor(Zge.prototype,"placeholderLabel"),Zge.prototype),ue(Zge.prototype,"backgroundImage",[Ege,Tge,Cge],Object.getOwnPropertyDescriptor(Zge.prototype,"backgroundImage"),Zge.prototype),ue(Zge.prototype,"inputFlag",[Age,bge,wge],Object.getOwnPropertyDescriptor(Zge.prototype,"inputFlag"),Zge.prototype),ue(Zge.prototype,"inputMode",[Ige,Pge,Rge],Object.getOwnPropertyDescriptor(Zge.prototype,"inputMode"),Zge.prototype),ue(Zge.prototype,"returnType",[Oge,Dge,Nge],Object.getOwnPropertyDescriptor(Zge.prototype,"returnType"),Zge.prototype),ue(Zge.prototype,"maxLength",[Mge,Lge],Object.getOwnPropertyDescriptor(Zge.prototype,"maxLength"),Zge.prototype),ue(Zge.prototype,"tabIndex",[Bge,Fge],Object.getOwnPropertyDescriptor(Zge.prototype,"tabIndex"),Zge.prototype),Jge=ue(Zge.prototype,"editingDidBegan",[zge,Bc,Uge,Gge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$ge=ue(Zge.prototype,"textChanged",[kge,Bc,Hge,Vge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eye=ue(Zge.prototype,"editingDidEnded",[Wge,Bc,jge,Xge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tye=ue(Zge.prototype,"editingReturn",[qge,Bc,Yge,Kge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nye=ue(Zge.prototype,"_textLabel",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iye=ue(Zge.prototype,"_placeholderLabel",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rye=ue(Zge.prototype,"_returnType",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ige.DEFAULT}}),oye=ue(Zge.prototype,"_string",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aye=ue(Zge.prototype,"_tabIndex",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sye=ue(Zge.prototype,"_backgroundImage",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cye=ue(Zge.prototype,"_inputFlag",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oge.DEFAULT}}),lye=ue(Zge.prototype,"_inputMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rge.ANY}}),uye=ue(Zge.prototype,"_maxLength",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Qge=Zge))||Qge)||Qge)||Qge)||Qge)||Qge)||Qge));"object"==typeof window&&"object"==typeof document&&(ISe._EditBoxImpl=Sye),h.internal.EditBox=ISe,function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(ESe||(ESe={})),ht(ESe),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(TSe||(TSe={})),ht(TSe),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(CSe||(CSe={})),ht(CSe),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(ASe||(ASe={})),ht(ASe),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(bSe||(bSe={})),ht(bSe),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(wSe||(wSe={})),ht(wSe);var PSe,RSe,OSe,DSe,NSe,MSe,LSe,BSe,FSe,zSe,USe,GSe,kSe,HSe,VSe,WSe,jSe,XSe,qSe,YSe,KSe,QSe,ZSe,JSe=new Nn,$Se=function(t){return e({Layout:t,LayoutComponent:t}),t}((xye=Ic("cc.Layout"),Eye=Xc(),Tye=Rc(110),Cye=Hc(),Aye=Pc(Sz),bye=Yc(),wye=Zc(),Iye=Yc(),Pye=Zc(),Rye=hl(ESe),Oye=il(),Dye=Zc(),Nye=hl(TSe),Mye=Yc(),Lye=Zc(),Bye=Yc(),Fye=Zc(),zye=hl(CSe),Uye=Zc(),Gye=Zc(),kye=Zc(),Hye=Zc(),Vye=Zc(),Wye=Zc(),jye=Zc(),Xye=hl(ASe),qye=Zc(),Yye=hl(bSe),Kye=Zc(),Qye=hl(wSe),Zye=Yc(),Jye=Zc(),$ye=Yc(),eSe=Zc(),tSe=Zc(),xye(nSe=Eye(nSe=Tye(nSe=Cye(nSe=Aye(nSe=kc((xSe=SSe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",rSe,ae(t)),le(t,"_layoutType",oSe,ae(t)),le(t,"_cellSize",aSe,ae(t)),le(t,"_startAxis",sSe,ae(t)),le(t,"_paddingLeft",cSe,ae(t)),le(t,"_paddingRight",lSe,ae(t)),le(t,"_paddingTop",uSe,ae(t)),le(t,"_paddingBottom",hSe,ae(t)),le(t,"_spacingX",_Se,ae(t)),le(t,"_spacingY",fSe,ae(t)),le(t,"_verticalDirection",dSe,ae(t)),le(t,"_horizontalDirection",pSe,ae(t)),le(t,"_constraint",mSe,ae(t)),le(t,"_constraintNum",vSe,ae(t)),le(t,"_affectedByScale",gSe,ae(t)),le(t,"_isAlign",ySe,ae(t)),t._layoutSize=new oi(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}ee(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(oi.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){lN.on(cN.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(cC.SIZE_CHANGED,this._resized,this),this.node.on(cC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(cC.CHILD_ADDED,this._childAdded,this),this.node.on(cC.CHILD_REMOVED,this._childRemoved,this),this.node.on(cC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){lN.off(cN.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(cC.SIZE_CHANGED,this._resized,this),this.node.off(cC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(cC.CHILD_ADDED,this._childAdded,this),this.node.off(cC.CHILD_REMOVED,this._childRemoved,this),this.node.off(cC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(cC.SIZE_CHANGED,this._doLayoutDirty,this),n.on(cC.TRANSFORM_CHANGED,this._transformDirty,this),n.on(cC.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(cC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(cC.SIZE_CHANGED,this._doLayoutDirty,this),n.off(cC.TRANSFORM_CHANGED,this._transformDirty,this),n.off(cC.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(cC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(e){e.on(cC.SIZE_CHANGED,this._doLayoutDirty,this),e.on(cC.TRANSFORM_CHANGED,this._transformDirty,this),e.on(cC.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(cC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(cC.SIZE_CHANGED,this._doLayoutDirty,this),e.off(cC.TRANSFORM_CHANGED,this._transformDirty,this),e.off(cC.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(cC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===bSe.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==ESe.GRID&&this._resizeMode===TSe.CHILDREN&&(m=(e-v-(p-1)*this._spacingX)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],x=S.node,E=x.scale,T=this._getUsedScaleValue(E.x),C=this._getUsedScaleValue(E.y);this._resizeMode===TSe.CHILDREN&&(S.width=m/T,this._layoutType===ESe.GRID&&(S.height=this._cellSize.height/C));var A=Math.abs(this._horizontalDirection-S.anchorX),b=S.width*T,w=S.height*C;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=a*(A*b+this._spacingX);var I=a*(1-A)*b;if(t){if(o>0)(d=y/o>0&&y%o==0)&&(h=_>w?_:h);else if(b>e-v)l>c+a*A*b&&(d=!0);else{var P=(1-this._horizontalDirection-r.x)*e,R=l+I+a*(a>0?this._paddingRight:this._paddingLeft);d=Math.abs(R)>Math.abs(P)}d&&(l=c+a*A*b,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var O=n(x,S,u);i&&x.setPosition(l,O),l+=I}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===ASe.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==ESe.GRID&&this._resizeMode===TSe.CHILDREN&&(m=(e-v-(p-1)*this._spacingY)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],x=S.node,E=x.scale,T=this._getUsedScaleValue(E.x),C=this._getUsedScaleValue(E.y);this._resizeMode===TSe.CHILDREN&&(S.height=m/C,this._layoutType===ESe.GRID&&(S.width=this._cellSize.width/T));var A=Math.abs(this._verticalDirection-S.anchorY),b=S.width*T,w=S.height*C;b>u&&(h=Math.max(u,h),_=u||b,u=b),l+=a*(A*w+this._spacingY);var I=a*(1-A)*w;if(t){if(o>0)(d=y/o>0&&y%o==0)&&(_=u>w?u:_);else if(w>e-v)l>c+a*A*w&&(d=!0);else{var P=(1-this._verticalDirection-r.y)*e,R=l+I+a*(a>0?this._paddingTop:this._paddingBottom);d=Math.abs(R)>Math.abs(P)}d&&(l=c+a*A*w,b!==u&&(_=u),f+=_+this._spacingX,_=u=b)}var O=n(x,S,f);i&&(x.getPosition(JSe),x.setPosition(O,l,JSe.z)),l+=I}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,o=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===ASe.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*t.height,a=this._paddingTop);var s=function(e,t,i){return o+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+a)},c=0;this._resizeMode===TSe.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-e.y*c,this._verticalDirection===ASe.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===TSe.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,o=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===bSe.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*t.width,a=this._paddingRight);var s=function(e,t,i){return o+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+a)},c=0;this._resizeMode===TSe.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-e.x*c,this._horizontalDirection===bSe.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===TSe.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===CSe.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===CSe.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===TSe.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===TSe.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===ESe.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?Nn.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===ESe.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?Nn.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===ESe.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&Ty.SCALE&&e&Ty.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==ESe.GRID||this._constraint===wSe.NONE||this._constraintNum<=0)return 0;var e=this._constraint===wSe.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===CSe.VERTICAL&&(e=this._constraint===wSe.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},J(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===ESe.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===ESe.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==ESe.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==ESe.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==wSe.NONE&&this._constraintNum!==e&&(e<=0&&E("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(th),SSe.Type=ESe,SSe.VerticalDirection=ASe,SSe.HorizontalDirection=bSe,SSe.ResizeMode=TSe,SSe.AxisDirection=CSe,SSe.Constraint=wSe,ue((iSe=xSe).prototype,"alignHorizontal",[bye,wye],Object.getOwnPropertyDescriptor(iSe.prototype,"alignHorizontal"),iSe.prototype),ue(iSe.prototype,"alignVertical",[Iye,Pye],Object.getOwnPropertyDescriptor(iSe.prototype,"alignVertical"),iSe.prototype),ue(iSe.prototype,"type",[Rye,Oye,Dye],Object.getOwnPropertyDescriptor(iSe.prototype,"type"),iSe.prototype),ue(iSe.prototype,"resizeMode",[Nye,Mye,Lye],Object.getOwnPropertyDescriptor(iSe.prototype,"resizeMode"),iSe.prototype),ue(iSe.prototype,"cellSize",[Bye,Fye],Object.getOwnPropertyDescriptor(iSe.prototype,"cellSize"),iSe.prototype),ue(iSe.prototype,"startAxis",[zye,Uye],Object.getOwnPropertyDescriptor(iSe.prototype,"startAxis"),iSe.prototype),ue(iSe.prototype,"paddingLeft",[Gye],Object.getOwnPropertyDescriptor(iSe.prototype,"paddingLeft"),iSe.prototype),ue(iSe.prototype,"paddingRight",[kye],Object.getOwnPropertyDescriptor(iSe.prototype,"paddingRight"),iSe.prototype),ue(iSe.prototype,"paddingTop",[Hye],Object.getOwnPropertyDescriptor(iSe.prototype,"paddingTop"),iSe.prototype),ue(iSe.prototype,"paddingBottom",[Vye],Object.getOwnPropertyDescriptor(iSe.prototype,"paddingBottom"),iSe.prototype),ue(iSe.prototype,"spacingX",[Wye],Object.getOwnPropertyDescriptor(iSe.prototype,"spacingX"),iSe.prototype),ue(iSe.prototype,"spacingY",[jye],Object.getOwnPropertyDescriptor(iSe.prototype,"spacingY"),iSe.prototype),ue(iSe.prototype,"verticalDirection",[Xye,qye],Object.getOwnPropertyDescriptor(iSe.prototype,"verticalDirection"),iSe.prototype),ue(iSe.prototype,"horizontalDirection",[Yye,Kye],Object.getOwnPropertyDescriptor(iSe.prototype,"horizontalDirection"),iSe.prototype),ue(iSe.prototype,"constraint",[Qye,Zye,Jye],Object.getOwnPropertyDescriptor(iSe.prototype,"constraint"),iSe.prototype),ue(iSe.prototype,"constraintNum",[$ye,eSe],Object.getOwnPropertyDescriptor(iSe.prototype,"constraintNum"),iSe.prototype),ue(iSe.prototype,"affectedByScale",[tSe],Object.getOwnPropertyDescriptor(iSe.prototype,"affectedByScale"),iSe.prototype),rSe=ue(iSe.prototype,"_resizeMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TSe.NONE}}),oSe=ue(iSe.prototype,"_layoutType",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ESe.NONE}}),aSe=ue(iSe.prototype,"_cellSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(40,40)}}),sSe=ue(iSe.prototype,"_startAxis",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CSe.HORIZONTAL}}),cSe=ue(iSe.prototype,"_paddingLeft",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lSe=ue(iSe.prototype,"_paddingRight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uSe=ue(iSe.prototype,"_paddingTop",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hSe=ue(iSe.prototype,"_paddingBottom",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_Se=ue(iSe.prototype,"_spacingX",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fSe=ue(iSe.prototype,"_spacingY",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dSe=ue(iSe.prototype,"_verticalDirection",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ASe.TOP_TO_BOTTOM}}),pSe=ue(iSe.prototype,"_horizontalDirection",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bSe.LEFT_TO_RIGHT}}),mSe=ue(iSe.prototype,"_constraint",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wSe.NONE}}),vSe=ue(iSe.prototype,"_constraintNum",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),gSe=ue(iSe.prototype,"_affectedByScale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ySe=ue(iSe.prototype,"_isAlign",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nSe=iSe))||nSe)||nSe)||nSe)||nSe)||nSe)||nSe));h.Layout=$Se,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(ZSe||(ZSe={})),ct(ZSe);var exe,txe,nxe,ixe,rxe,oxe,axe,sxe,cxe,lxe,uxe,hxe,_xe,fxe,dxe,pxe,mxe,vxe,gxe,yxe,Sxe,xxe,Exe,Txe,Cxe=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((PSe=Ic("cc.ProgressBar"),RSe=Xc(),OSe=Rc(110),DSe=Hc(),NSe=Pc(Sz),MSe=hl(zH),LSe=Zc(),BSe=hl(ZSe),FSe=Zc(),zSe=Zc(),USe=Jc(),GSe=Zc(),kSe=Zc(),PSe(HSe=RSe(HSe=OSe(HSe=DSe(HSe=NSe((QSe=KSe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",WSe,ae(t)),le(t,"_mode",jSe,ae(t)),le(t,"_totalLength",XSe,ae(t)),le(t,"_progress",qSe,ae(t)),le(t,"_reverse",YSe,ae(t)),t}ee(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===zH.FillType.RADIAL&&(this._mode=ZSe.FILLED),this._mode===ZSe.HORIZONTAL?this.totalLength=r.width:this._mode===ZSe.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var o=-n.width*i.x;e.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),o=new Jn(0,.5),a=fn(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case ZSe.HORIZONTAL:this._reverse&&(o=new Jn(1,.5)),c=new oi(s,i.height),l=this._totalLength,u=i.height;break;case ZSe.VERTICAL:o=this._reverse?new Jn(.5,1):new Jn(.5,0),c=new oi(i.width,s),l=i.width,u=this._totalLength}if(this._mode===ZSe.FILLED)this._barSprite.type!==zH.Type.FILLED?E("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==zH.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new Nn(l*h,u*_,0);e.setPosition(r.x+f.x,r.y+f.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)}else E("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},J(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===ZSe.HORIZONTAL?this.totalLength=n.width:this._mode===ZSe.VERTICAL?this.totalLength=n.height:this._mode===ZSe.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===ZSe.FILLED&&(e=fn(e)),this._totalLength!==e&&(this._totalLength=e,this._updateBarStatus())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(th),KSe.Mode=ZSe,ue((VSe=QSe).prototype,"barSprite",[MSe,LSe],Object.getOwnPropertyDescriptor(VSe.prototype,"barSprite"),VSe.prototype),ue(VSe.prototype,"mode",[BSe,FSe],Object.getOwnPropertyDescriptor(VSe.prototype,"mode"),VSe.prototype),ue(VSe.prototype,"totalLength",[zSe],Object.getOwnPropertyDescriptor(VSe.prototype,"totalLength"),VSe.prototype),ue(VSe.prototype,"progress",[USe,nl,GSe],Object.getOwnPropertyDescriptor(VSe.prototype,"progress"),VSe.prototype),ue(VSe.prototype,"reverse",[kSe],Object.getOwnPropertyDescriptor(VSe.prototype,"reverse"),VSe.prototype),WSe=ue(VSe.prototype,"_barSprite",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jSe=ue(VSe.prototype,"_mode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZSe.HORIZONTAL}}),XSe=ue(VSe.prototype,"_totalLength",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qSe=ue(VSe.prototype,"_progress",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),YSe=ue(VSe.prototype,"_reverse",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HSe=VSe))||HSe)||HSe)||HSe)||HSe)||HSe));h.ProgressBar=Cxe;var Axe,bxe=new Nn,wxe=new Nn,Ixe=new Nn,Pxe=new Jn,Rxe=new On,Oxe=new Jn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Axe||(Axe={})),ht(Axe);var Dxe,Nxe=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((exe=Ic("cc.ScrollBar"),txe=Xc(),nxe=Rc(110),ixe=Hc(),rxe=Pc(Sz),oxe=hl(zH),axe=il(),sxe=Zc(),cxe=hl(Axe),lxe=il(),uxe=Zc(),hxe=il(),_xe=Zc(),fxe=il(),dxe=Zc(),exe(pxe=txe(pxe=nxe(pxe=ixe(pxe=rxe((Txe=Exe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",vxe,ae(t)),le(t,"_handle",gxe,ae(t)),le(t,"_direction",yxe,ae(t)),le(t,"_enableAutoHide",Sxe,ae(t)),le(t,"_autoHideTime",xxe,ae(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}ee(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=Oxe;u.set(0,0),this._direction===Axe.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===Axe.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(o,a,l,s),_=Oxe;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(zH);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){bxe.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(bxe,wxe);var r=n.convertToNodeSpaceAR(wxe);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(Jn.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(zH);t&&(Rxe.set(t.color),Rxe.a=e,t.color=Rxe),(t=this._handle.getComponent(zH))&&(Rxe.set(t.color),Rxe.a=e,t.color=Rxe)}},n._updateHandlerPosition=function(e){if(this._handle){var t=Ixe;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;Nn.set(bxe,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(bxe,wxe),s=e;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===Axe.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===Axe.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===Axe.HORIZONTAL||e.height<=t.height&&this._direction===Axe.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,o,a){var s=t-n;o&&(s+=Math.abs(o));var c=0;s&&(c=fn(c=r/s));var l=(i-a)*c;this._direction===Axe.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===Pxe.x&&i.y===Pxe.y||t.setAnchorPoint(Pxe),this._direction===Axe.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},J(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(Jn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(Jn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(th),Exe.Direction=Axe,ue((mxe=Txe).prototype,"handle",[oxe,axe,sxe],Object.getOwnPropertyDescriptor(mxe.prototype,"handle"),mxe.prototype),ue(mxe.prototype,"direction",[cxe,lxe,uxe],Object.getOwnPropertyDescriptor(mxe.prototype,"direction"),mxe.prototype),ue(mxe.prototype,"enableAutoHide",[hxe,_xe],Object.getOwnPropertyDescriptor(mxe.prototype,"enableAutoHide"),mxe.prototype),ue(mxe.prototype,"autoHideTime",[fxe,dxe],Object.getOwnPropertyDescriptor(mxe.prototype,"autoHideTime"),mxe.prototype),vxe=ue(mxe.prototype,"_scrollView",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gxe=ue(mxe.prototype,"_handle",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yxe=ue(mxe.prototype,"_direction",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Axe.HORIZONTAL}}),Sxe=ue(mxe.prototype,"_enableAutoHide",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xxe=ue(mxe.prototype,"_autoHideTime",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pxe=mxe))||pxe)||pxe)||pxe)||pxe)||pxe));h.ScrollBar=Nxe;var Mxe,Lxe,Bxe,Fxe,zxe,Uxe,Gxe,kxe,Hxe,Vxe,Wxe,jxe,Xxe,qxe,Yxe,Kxe,Qxe,Zxe,Jxe,$xe,eEe,tEe,nEe,iEe,rEe,oEe,aEe,sEe,cEe,lEe,uEe,hEe,_Ee,fEe,dEe,pEe,mEe,vEe,gEe,yEe,SEe,xEe,EEe,TEe,CEe,AEe,bEe,wEe,IEe=e("ViewGroup",Ic("cc.ViewGroup")(Dxe=Rc(110)(Dxe=function(e){function t(){return e.apply(this,arguments)||this}return ee(t,e),t}(th))||Dxe)||Dxe);h.ViewGroup=IEe;var PEe,REe=1e-4,OEe=new Nn,DEe=new Nn,NEe=new Jn,MEe=new Jn,LEe=function(){return(new Date).getMilliseconds()},BEe={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(PEe||(PEe={}));var FEe,zEe,UEe,GEe,kEe,HEe,VEe,WEe,jEe,XEe,qEe,YEe,KEe,QEe,ZEe,JEe,$Ee,eTe,tTe,nTe,iTe,rTe=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((Mxe=Ic("cc.ScrollView"),Lxe=Xc(),Bxe=Rc(110),Fxe=Hc(),zxe=Pc(Sz),Uxe=Jc(),Gxe=il(),kxe=Zc(),Hxe=Jc(),Vxe=il(),Wxe=Zc(),jxe=il(),Xxe=Zc(),qxe=il(),Yxe=Zc(),Kxe=hl(ub),Qxe=il(),Zxe=Zc(),Jxe=il(),$xe=Zc(),eEe=hl(Nxe),tEe=il(),nEe=Zc(),iEe=il(),rEe=Zc(),oEe=hl(Nxe),aEe=il(),sEe=Zc(),cEe=il(),lEe=Zc(),uEe=hl([sB]),hEe=il(),_Ee=Zc(),Mxe(fEe=Lxe(fEe=Bxe(fEe=Fxe(fEe=zxe((wEe=bEe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",pEe,ae(t)),le(t,"brake",mEe,ae(t)),le(t,"elastic",vEe,ae(t)),le(t,"inertia",gEe,ae(t)),le(t,"horizontal",yEe,ae(t)),le(t,"vertical",SEe,ae(t)),le(t,"cancelInnerEvents",xEe,ae(t)),le(t,"scrollEvents",EEe,ae(t)),t._autoScrolling=!1,t._scrolling=!1,le(t,"_content",TEe,ae(t)),le(t,"_horizontalScrollBar",CEe,ae(t)),le(t,"_verticalScrollBar",AEe,ae(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Nn,t._autoScrollTargetDelta=new Nn,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Nn,t._outOfBoundaryAmount=new Nn,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Nn,t._deltaPos=new Nn,t}ee(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Jn(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Jn(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Jn(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Jn(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Jn(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Jn(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Jn(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Jn(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Jn(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Jn(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Jn.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new Jn(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Jn(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Jn(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Jn(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<REe&&Math.abs(e.y-t.y)<REe||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Nn.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return REe},n.start=function(){this._calculateBoundary(),this._content&&lN.once(cN.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(cC.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(cC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(cC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(cC.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(cC.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(cC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(cC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(cC.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(cC.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(cC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(cC.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(cC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(cC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(cC.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(cC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(cC.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(cC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(cC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new Nn,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(NEe);if(i.subtract(n.getUIStartLocation(MEe)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new fR(e.getTouches(),e.bubbles,ow.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(PEe.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent($Se);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==cR.CAPTURING_PHASE)return!1;if(t)for(var n,i=ce(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(IEe));if(r.getComponent(IEe))return!0}return!1},n._startInertiaScroll=function(e){var t=new Nn(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,Nn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(Nn.ZERO,REe)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new Nn,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(Nn.ZERO);else{var n=new Nn;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);OEe.set(this._getContentPosition()),OEe.add(n),OEe.set(Math.round(1e4*OEe.x)*REe,Math.round(1e4*OEe.y)*REe,OEe.z),this._setContentPosition(OEe);var i=this._getHowMuchOutOfBoundary();NEe.set(i.x,i.y),this._updateScrollBar(NEe),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new Nn).equals(Nn.ZERO,REe)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Nn,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):o+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(o+e.y)),e.equals(Nn.ZERO,REe)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===PEe.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===PEe.SCROLL_TO_TOP||e===PEe.SCROLL_TO_BOTTOM||e===PEe.SCROLL_TO_LEFT||e===PEe.SCROLL_TO_RIGHT){var t=1<<BEe[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}sB.emitEvents(this.scrollEvents,this,BEe[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();OEe.set(this._getContentPosition()),OEe.add(e),this._content.setPosition(OEe),this._updateScrollBar(Jn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===cR.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(PEe.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new Nn;n&&(t.getUILocation(NEe),t.getUIPreviousLocation(MEe),OEe.set(NEe.x,NEe.y,0),DEe.set(MEe.x,MEe.y,0),n.convertToNodeSpaceAR(OEe,OEe),n.convertToNodeSpaceAR(DEe,DEe),Nn.subtract(i,OEe,DEe)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||Nn.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=PEe.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=PEe.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=PEe.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=PEe.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(PEe.SCROLL_BEGAN)),this._dispatchEvent(PEe.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(PEe.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=LEe(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=LEe();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(Nn.ZERO,REe))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(PEe.BOUNCE_TOP),e.y<0&&this._dispatchEvent(PEe.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(PEe.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(PEe.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(OEe,REe)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(Nn.ZERO,REe)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,Nn.copy(this._autoScrollBrakingStartPosition,this._getContentPosition()),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=REe;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(PEe.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(Nn.ZERO,REe)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(PEe.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(PEe.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(Nn.ZERO,REe))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(PEe.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(PEe.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(Jn.ZERO,Jn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new Nn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*t.x),i&&(s=c.height-l.height,a.y=r-s*t.y)}return a},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new Nn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(i=o.height-e.height,n.y=t-i),o.width<e.width&&(i=o.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===Ty.SCALE&&this._calculateBoundary()},J(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):R(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Jn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Jn.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(IEe),bEe.EventType=PEe,pEe=ue((dEe=wEe).prototype,"bounceDuration",[Bc,Uxe,Gxe,kxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mEe=ue(dEe.prototype,"brake",[Bc,Hxe,Vxe,Wxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),vEe=ue(dEe.prototype,"elastic",[Bc,jxe,Xxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gEe=ue(dEe.prototype,"inertia",[Bc,qxe,Yxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ue(dEe.prototype,"content",[Kxe,Qxe,Zxe],Object.getOwnPropertyDescriptor(dEe.prototype,"content"),dEe.prototype),yEe=ue(dEe.prototype,"horizontal",[Bc,Jxe,$xe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ue(dEe.prototype,"horizontalScrollBar",[eEe,tEe,nEe],Object.getOwnPropertyDescriptor(dEe.prototype,"horizontalScrollBar"),dEe.prototype),SEe=ue(dEe.prototype,"vertical",[Bc,iEe,rEe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ue(dEe.prototype,"verticalScrollBar",[oEe,aEe,sEe],Object.getOwnPropertyDescriptor(dEe.prototype,"verticalScrollBar"),dEe.prototype),xEe=ue(dEe.prototype,"cancelInnerEvents",[Bc,cEe,lEe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),EEe=ue(dEe.prototype,"scrollEvents",[uEe,Bc,hEe,_Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TEe=ue(dEe.prototype,"_content",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CEe=ue(dEe.prototype,"_horizontalScrollBar",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AEe=ue(dEe.prototype,"_verticalScrollBar",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fEe=dEe))||fEe)||fEe)||fEe)||fEe)||fEe));h.ScrollView=rTe;var oTe,aTe=new Nn;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(oTe||(oTe={})),ht(oTe);var sTe,cTe,lTe,uTe,hTe,_Te,fTe,dTe,pTe,mTe,vTe,gTe,yTe,STe,xTe,ETe,TTe,CTe,ATe,bTe,wTe=function(t){return e({Slider:t,SliderComponent:t}),t}((FEe=Ic("cc.Slider"),zEe=Xc(),UEe=Rc(110),GEe=Hc(),kEe=Pc(Sz),HEe=hl(zH),VEe=Zc(),WEe=hl(oTe),jEe=Zc(),XEe=Jc(),qEe=Zc(),YEe=hl([sB]),KEe=Zc(),FEe(QEe=zEe(QEe=UEe(QEe=GEe(QEe=kEe((iTe=nTe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",JEe,ae(t)),le(t,"_handle",$Ee,ae(t)),le(t,"_direction",eTe,ae(t)),le(t,"_progress",tTe,ae(t)),t._offset=new Nn,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new Nn,t._touchPos=new Nn,t}ee(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(cC.TOUCH_START,this._onTouchBegan,this),this.node.on(cC.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(cC.TOUCH_END,this._onTouchEnded,this),this.node.on(cC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(cC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(cC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(cC.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(cC.TOUCH_START,this._onTouchBegan,this),this.node.off(cC.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(cC.TOUCH_END,this._onTouchEnded,this),this.node.off(cC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(cC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(cC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(cC.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Nn.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Nn,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){sB.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();Nn.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,aTe);this.direction===oTe.Horizontal?this.progress=fn(.5+(i.x-this._offset.x)/n.width):this.progress=fn(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===oTe.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===oTe.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},J(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(th),nTe.Direction=oTe,ue((ZEe=iTe).prototype,"handle",[HEe,VEe],Object.getOwnPropertyDescriptor(ZEe.prototype,"handle"),ZEe.prototype),ue(ZEe.prototype,"direction",[WEe,jEe],Object.getOwnPropertyDescriptor(ZEe.prototype,"direction"),ZEe.prototype),ue(ZEe.prototype,"progress",[nl,XEe,qEe],Object.getOwnPropertyDescriptor(ZEe.prototype,"progress"),ZEe.prototype),JEe=ue(ZEe.prototype,"slideEvents",[YEe,Bc,KEe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$Ee=ue(ZEe.prototype,"_handle",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eTe=ue(ZEe.prototype,"_direction",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oTe.Horizontal}}),tTe=ue(ZEe.prototype,"_progress",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),QEe=ZEe))||QEe)||QEe)||QEe)||QEe)||QEe));function ITe(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}h.Slider=wTe,function(e){e.TOGGLE="toggle"}(bTe||(bTe={}));var PTe,RTe,OTe,DTe,NTe,MTe,LTe,BTe,FTe,zTe,UTe,GTe,kTe=function(t){return e({Toggle:t,ToggleComponent:t}),t}((sTe=Ic("cc.Toggle"),cTe=Xc(),lTe=Rc(110),uTe=Hc(),hTe=Pc(Sz),_Te=il(),fTe=Zc(),dTe=hl(zH),pTe=il(),mTe=Zc(),vTe=hl([sB]),gTe=Zc(),sTe(yTe=cTe(yTe=lTe(yTe=uTe(yTe=hTe((ATe=CTe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",xTe,ae(t)),le(t,"_isChecked",ETe,ae(t)),le(t,"_checkMark",TTe,ae(t)),t}ee(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&sB.emitEvents(this.checkEvents,this)},J(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return h.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(nge),CTe.EventType=ITe(bTe,ege),ue((STe=ATe).prototype,"isChecked",[_Te,fTe],Object.getOwnPropertyDescriptor(STe.prototype,"isChecked"),STe.prototype),ue(STe.prototype,"checkMark",[dTe,pTe,mTe],Object.getOwnPropertyDescriptor(STe.prototype,"checkMark"),STe.prototype),xTe=ue(STe.prototype,"checkEvents",[vTe,Bc,gTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ETe=ue(STe.prototype,"_isChecked",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),TTe=ue(STe.prototype,"_checkMark",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yTe=STe))||yTe)||yTe)||yTe)||yTe)||yTe));h.Toggle=kTe;var HTe,VTe,WTe,jTe,XTe,qTe,YTe,KTe,QTe,ZTe,JTe,$Te,eCe,tCe,nCe,iCe,rCe,oCe,aCe,sCe,cCe,lCe,uCe,hCe,_Ce,fCe,dCe,pCe,mCe,vCe,gCe,yCe,SCe,xCe,ECe,TCe,CCe,ACe,bCe,wCe,ICe,PCe,RCe,OCe,DCe,NCe=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((PTe=Ic("cc.ToggleContainer"),RTe=Xc(),OTe=Rc(110),DTe=Hc(),NTe=Zc(),MTe=hl([sB]),LTe=Zc(),PTe(BTe=RTe(BTe=OTe(BTe=DTe(BTe=kc((GTe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",zTe,ae(t)),le(t,"checkEvents",UTe,ae(t)),t}ee(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(cC.CHILD_ADDED,this.ensureValidState,this),this.node.on(cC.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(cC.CHILD_ADDED,this.ensureValidState,this),this.node.off(cC.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==e&&(t?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&h.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},J(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(th),zTe=ue((FTe=GTe).prototype,"_allowSwitchOff",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ue(FTe.prototype,"allowSwitchOff",[NTe],Object.getOwnPropertyDescriptor(FTe.prototype,"allowSwitchOff"),FTe.prototype),UTe=ue(FTe.prototype,"checkEvents",[MTe,Bc,LTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BTe=FTe))||BTe)||BTe)||BTe)||BTe)||BTe));h.ToggleContainer=NCe;var MCe,LCe,BCe=new Jn;function FCe(e){return e instanceof kR?_N:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:oi.ZERO}function zCe(e,t,n,i){e.parent?BCe.set(e.parent.getScale().x,e.parent.getScale().y):BCe.set(0,0);for(var r=BCe.x,o=BCe.y,a=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?BCe.set(c.getScale().x,c.getScale().y):BCe.set(0,0);var u=BCe.x,h=BCe.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(MCe||(MCe={})),ht(MCe),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(LCe||(LCe={}));var UCe,GCe,kCe,HCe,VCe,WCe,jCe,XCe,qCe,YCe,KCe,QCe,ZCe,JCe,$Ce,eAe,tAe,nAe,iAe,rAe=LCe.TOP|LCe.BOT,oAe=LCe.LEFT|LCe.RIGHT,aAe=function(t){return e({Widget:t,WidgetComponent:t}),t}((HTe=Ic("cc.Widget"),VTe=Xc(),WTe=Rc(110),jTe=Hc(),XTe=Pc(Sz),qTe=hl(ub),YTe=Zc(),KTe=Zc(),QTe=Zc(),ZTe=Zc(),JTe=Zc(),$Te=Zc(),eCe=Zc(),tCe=Yc(),nCe=Yc(),iCe=Zc(),rCe=Zc(),oCe=Zc(),aCe=Zc(),sCe=Zc(),cCe=Zc(),lCe=hl(MCe),uCe=Zc(),HTe(hCe=VTe(hCe=WTe(hCe=jTe(hCe=XTe(hCe=kc((DCe=OCe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new Nn,t._lastSize=new oi,t._dirty=!0,t._hadAlignOnce=!1,le(t,"_alignFlags",fCe,ae(t)),le(t,"_target",dCe,ae(t)),le(t,"_left",pCe,ae(t)),le(t,"_right",mCe,ae(t)),le(t,"_top",vCe,ae(t)),le(t,"_bottom",gCe,ae(t)),le(t,"_horizontalCenter",yCe,ae(t)),le(t,"_verticalCenter",SCe,ae(t)),le(t,"_isAbsLeft",xCe,ae(t)),le(t,"_isAbsRight",ECe,ae(t)),le(t,"_isAbsTop",TCe,ae(t)),le(t,"_isAbsBottom",CCe,ae(t)),le(t,"_isAbsHorizontalCenter",ACe,ae(t)),le(t,"_isAbsVerticalCenter",bCe,ae(t)),le(t,"_originalWidth",wCe,ae(t)),le(t,"_originalHeight",ICe,ae(t)),le(t,"_alignMode",PCe,ae(t)),le(t,"_lockFlags",RCe,ae(t)),t}ee(t,e);var n=t.prototype;return n.updateAlignment=function(){h._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),h._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){h._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(cC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(cC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(cC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(cC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(cC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(cC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(cC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(cC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:_N;this.isAlignLeft&&e===LCe.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===LCe.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===LCe.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===LCe.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===LCe.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===LCe.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(Sz)&&(e.on(cC.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(cC.SIZE_CHANGED,this._setDirtyByMode,this),e.on(cC.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(cC.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(cC.SIZE_CHANGED,this._setDirtyByMode,this),e.off(cC.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(cC.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(cC.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===MCe.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&oAe)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},J(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&LCe.TOP)>0},set:function(e){this._setAlign(LCe.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&LCe.BOT)>0},set:function(e){this._setAlign(LCe.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&LCe.LEFT)>0},set:function(e){this._setAlign(LCe.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&LCe.RIGHT)>0},set:function(e){this._setAlign(LCe.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&LCe.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=LCe.MID):this._alignFlags&=~LCe.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&LCe.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=LCe.CENTER):this._alignFlags&=~LCe.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&oAe)===oAe}},{key:"isStretchHeight",get:function(){return(this._alignFlags&rAe)===rAe}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(LCe.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(LCe.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(LCe.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(LCe.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(LCe.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(LCe.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(th),OCe.AlignMode=MCe,ue((_Ce=DCe).prototype,"target",[qTe,YTe],Object.getOwnPropertyDescriptor(_Ce.prototype,"target"),_Ce.prototype),ue(_Ce.prototype,"isAlignTop",[KTe],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAlignTop"),_Ce.prototype),ue(_Ce.prototype,"isAlignBottom",[QTe],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAlignBottom"),_Ce.prototype),ue(_Ce.prototype,"isAlignLeft",[ZTe],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAlignLeft"),_Ce.prototype),ue(_Ce.prototype,"isAlignRight",[JTe],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAlignRight"),_Ce.prototype),ue(_Ce.prototype,"isAlignVerticalCenter",[$Te],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAlignVerticalCenter"),_Ce.prototype),ue(_Ce.prototype,"isAlignHorizontalCenter",[eCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAlignHorizontalCenter"),_Ce.prototype),ue(_Ce.prototype,"isStretchWidth",[tCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"isStretchWidth"),_Ce.prototype),ue(_Ce.prototype,"isStretchHeight",[nCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"isStretchHeight"),_Ce.prototype),ue(_Ce.prototype,"top",[iCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"top"),_Ce.prototype),ue(_Ce.prototype,"editorTop",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"editorTop"),_Ce.prototype),ue(_Ce.prototype,"bottom",[rCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"bottom"),_Ce.prototype),ue(_Ce.prototype,"editorBottom",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"editorBottom"),_Ce.prototype),ue(_Ce.prototype,"left",[oCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"left"),_Ce.prototype),ue(_Ce.prototype,"editorLeft",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"editorLeft"),_Ce.prototype),ue(_Ce.prototype,"right",[aCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"right"),_Ce.prototype),ue(_Ce.prototype,"editorRight",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"editorRight"),_Ce.prototype),ue(_Ce.prototype,"horizontalCenter",[sCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"horizontalCenter"),_Ce.prototype),ue(_Ce.prototype,"editorHorizontalCenter",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"editorHorizontalCenter"),_Ce.prototype),ue(_Ce.prototype,"verticalCenter",[cCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"verticalCenter"),_Ce.prototype),ue(_Ce.prototype,"editorVerticalCenter",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"editorVerticalCenter"),_Ce.prototype),ue(_Ce.prototype,"isAbsoluteTop",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAbsoluteTop"),_Ce.prototype),ue(_Ce.prototype,"isAbsoluteBottom",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAbsoluteBottom"),_Ce.prototype),ue(_Ce.prototype,"isAbsoluteLeft",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAbsoluteLeft"),_Ce.prototype),ue(_Ce.prototype,"isAbsoluteRight",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAbsoluteRight"),_Ce.prototype),ue(_Ce.prototype,"isAbsoluteHorizontalCenter",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAbsoluteHorizontalCenter"),_Ce.prototype),ue(_Ce.prototype,"isAbsoluteVerticalCenter",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"isAbsoluteVerticalCenter"),_Ce.prototype),ue(_Ce.prototype,"alignMode",[lCe,uCe],Object.getOwnPropertyDescriptor(_Ce.prototype,"alignMode"),_Ce.prototype),ue(_Ce.prototype,"alignFlags",[qc],Object.getOwnPropertyDescriptor(_Ce.prototype,"alignFlags"),_Ce.prototype),fCe=ue(_Ce.prototype,"_alignFlags",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dCe=ue(_Ce.prototype,"_target",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pCe=ue(_Ce.prototype,"_left",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mCe=ue(_Ce.prototype,"_right",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vCe=ue(_Ce.prototype,"_top",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gCe=ue(_Ce.prototype,"_bottom",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yCe=ue(_Ce.prototype,"_horizontalCenter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SCe=ue(_Ce.prototype,"_verticalCenter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xCe=ue(_Ce.prototype,"_isAbsLeft",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ECe=ue(_Ce.prototype,"_isAbsRight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),TCe=ue(_Ce.prototype,"_isAbsTop",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),CCe=ue(_Ce.prototype,"_isAbsBottom",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ACe=ue(_Ce.prototype,"_isAbsHorizontalCenter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bCe=ue(_Ce.prototype,"_isAbsVerticalCenter",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wCe=ue(_Ce.prototype,"_originalWidth",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ICe=ue(_Ce.prototype,"_originalHeight",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PCe=ue(_Ce.prototype,"_alignMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MCe.ON_WINDOW_RESIZE}}),RCe=ue(_Ce.prototype,"_lockFlags",[Bc,zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hCe=_Ce))||hCe)||hCe)||hCe)||hCe)||hCe)||hCe));h.internal.computeInverseTransForTarget=zCe,h.internal.getReadonlyNodeSize=FCe,h.Widget=aAe;var sAe,cAe=new On;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(sAe||(sAe={})),ht(sAe);var lAe,uAe,hAe,_Ae,fAe,dAe,pAe,mAe,vAe,gAe,yAe,SAe,xAe,EAe,TAe,CAe,AAe,bAe,wAe,IAe,PAe,RAe,OAe,DAe,NAe,MAe,LAe,BAe,FAe,zAe,UAe,GAe,kAe,HAe,VAe,WAe,jAe,XAe,qAe,YAe,KAe,QAe,ZAe,JAe=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((UCe=Ic("cc.PageViewIndicator"),GCe=Xc(),kCe=Rc(110),HCe=Hc(),VCe=hl(WB),WCe=Zc(),jCe=hl(sAe),XCe=Zc(),qCe=hl(oi),YCe=Zc(),KCe=Zc(),UCe(QCe=GCe(QCe=kCe(QCe=HCe((iAe=nAe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"spacing",JCe,ae(t)),le(t,"_spriteFrame",$Ce,ae(t)),le(t,"_direction",eAe,ae(t)),le(t,"_cellSize",tAe,ae(t)),t._layout=null,t._pageView=null,t._indicators=[],t}ee(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent($Se),this._layout||(this._layout=this.addComponent($Se));var e=this._layout;this.direction===sAe.HORIZONTAL?(e.type=$Se.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===sAe.VERTICAL&&(e.type=$Se.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=$Se.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new ub;e.layer=this.node.layer;var t=e.addComponent(zH);return t.spriteFrame=this.spriteFrame,t.sizeMode=zH.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;cAe.set(r.color),cAe.a=127.5,r.color=cAe}}if(e[t]._uiProps.uiComp){var o=e[t]._uiProps.uiComp;cAe.set(o.color),cAe.a=255,o.color=cAe}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},J(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(th),nAe.Direction=sAe,ue((ZCe=iAe).prototype,"spriteFrame",[VCe,WCe],Object.getOwnPropertyDescriptor(ZCe.prototype,"spriteFrame"),ZCe.prototype),ue(ZCe.prototype,"direction",[jCe,XCe],Object.getOwnPropertyDescriptor(ZCe.prototype,"direction"),ZCe.prototype),ue(ZCe.prototype,"cellSize",[qCe,YCe],Object.getOwnPropertyDescriptor(ZCe.prototype,"cellSize"),ZCe.prototype),JCe=ue(ZCe.prototype,"spacing",[Bc,KCe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$Ce=ue(ZCe.prototype,"_spriteFrame",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eAe=ue(ZCe.prototype,"_direction",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sAe.HORIZONTAL}}),tAe=ue(ZCe.prototype,"_cellSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(20,20)}}),QCe=ZCe))||QCe)||QCe)||QCe)||QCe));h.PageViewIndicator=JAe;var $Ae,ebe,tbe,nbe=new Jn;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}($Ae||($Ae={})),ht($Ae),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(ebe||(ebe={})),ht(ebe),function(e){e.PAGE_TURNING="page-turning"}(tbe||(tbe={}));var ibe=function(t){return e({PageView:t,PageViewComponent:t}),t}((lAe=Ic("cc.PageView"),uAe=Xc(),hAe=Rc(110),_Ae=Hc(),fAe=hl($Ae),dAe=Zc(),pAe=hl(ebe),mAe=Zc(),vAe=Jc(),gAe=Zc(),yAe=Jc(),SAe=Zc(),xAe=hl(JAe),EAe=Zc(),TAe=Zc(),CAe=hl(Nxe),AAe=Yc(),bAe=hl(Nxe),wAe=Yc(),IAe=Yc(),PAe=Yc(),RAe=Yc(),OAe=hl([sB]),DAe=Yc(),NAe=Zc(),MAe=hl([sB]),LAe=Zc(),lAe(BAe=uAe(BAe=hAe(BAe=_Ae((ZAe=QAe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",zAe,ae(t)),le(t,"horizontal",UAe,ae(t)),le(t,"vertical",GAe,ae(t)),le(t,"cancelInnerEvents",kAe,ae(t)),le(t,"scrollEvents",HAe,ae(t)),le(t,"pageTurningSpeed",VAe,ae(t)),le(t,"pageEvents",WAe,ae(t)),le(t,"_sizeMode",jAe,ae(t)),le(t,"_direction",XAe,ae(t)),le(t,"_scrollThreshold",qAe,ae(t)),le(t,"_pageTurningEventTiming",YAe,ae(t)),le(t,"_indicator",KAe,ae(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Nn,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Jn,t._touchEndPosition=new Jn,t}ee(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(cC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(cC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):R(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void R(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):D(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent($Se);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===ebe.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===$Ae.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(nbe),Jn.set(this._touchBeganPosition,nbe.x,nbe.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(nbe),Jn.set(this._touchEndPosition,nbe.x,nbe.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(nbe),Jn.set(this._touchEndPosition,nbe.x,nbe.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===ebe.Horizontal,this.vertical=this.direction===ebe.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent($Se);if(t){if(this._sizeMode===$Ae.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===ebe.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===ebe.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,sB.emitEvents(this.pageEvents,this,tbe.PAGE_TURNING),this.node.emit(tbe.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===ebe.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===ebe.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new Jn;if(this._sizeMode===$Ae.Free)this.direction===ebe.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===ebe.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===ebe.Horizontal?t.x=e*n.width:this.direction===ebe.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===ebe.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===$Ae.Free){var i=0,r=0;if(this.direction===ebe.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===ebe.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===ebe.Horizontal)return Math.abs(e.x)>=o.width*this.scrollThreshold;if(this.direction===ebe.Vertical)return Math.abs(e.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new Jn;Jn.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},J(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(rTe),QAe.SizeMode=$Ae,QAe.Direction=ebe,QAe.EventType=ITe(tbe,PEe),ue((FAe=ZAe).prototype,"sizeMode",[fAe,dAe],Object.getOwnPropertyDescriptor(FAe.prototype,"sizeMode"),FAe.prototype),ue(FAe.prototype,"direction",[pAe,mAe],Object.getOwnPropertyDescriptor(FAe.prototype,"direction"),FAe.prototype),ue(FAe.prototype,"scrollThreshold",[nl,vAe,gAe],Object.getOwnPropertyDescriptor(FAe.prototype,"scrollThreshold"),FAe.prototype),ue(FAe.prototype,"pageTurningEventTiming",[nl,yAe,SAe],Object.getOwnPropertyDescriptor(FAe.prototype,"pageTurningEventTiming"),FAe.prototype),ue(FAe.prototype,"indicator",[xAe,EAe],Object.getOwnPropertyDescriptor(FAe.prototype,"indicator"),FAe.prototype),zAe=ue(FAe.prototype,"autoPageTurningThreshold",[Bc,TAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),ue(FAe.prototype,"verticalScrollBar",[CAe,fl,AAe],Object.getOwnPropertyDescriptor(FAe.prototype,"verticalScrollBar"),FAe.prototype),ue(FAe.prototype,"horizontalScrollBar",[bAe,fl,wAe],Object.getOwnPropertyDescriptor(FAe.prototype,"horizontalScrollBar"),FAe.prototype),UAe=ue(FAe.prototype,"horizontal",[fl,Bc,IAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GAe=ue(FAe.prototype,"vertical",[fl,Bc,PAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kAe=ue(FAe.prototype,"cancelInnerEvents",[fl,Bc,RAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HAe=ue(FAe.prototype,"scrollEvents",[OAe,Bc,fl,DAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VAe=ue(FAe.prototype,"pageTurningSpeed",[Bc,qc,NAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),WAe=ue(FAe.prototype,"pageEvents",[MAe,Bc,LAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jAe=ue(FAe.prototype,"_sizeMode",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $Ae.Unified}}),XAe=ue(FAe.prototype,"_direction",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ebe.Horizontal}}),qAe=ue(FAe.prototype,"_scrollThreshold",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),YAe=ue(FAe.prototype,"_pageTurningEventTiming",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),KAe=ue(FAe.prototype,"_indicator",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BAe=FAe))||BAe)||BAe)||BAe)||BAe));h.PageView=ibe;var rbe=new Nn,obe=new Jn,abe=new Jn,sbe=new Jn(1,1),cbe=new Jn,lbe=new Jn;function ube(e,t){if(!t._hadAlignOnce){t.alignMode===MCe.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=abe,o=sbe;i?zCe(e,n=i,r,o):n=e.parent;var a=FCe(n),s=n instanceof kR||!n.getComponent(Sz),c=s?obe:n.getComponent(Sz).anchorPoint,l=s;e.getPosition(rbe);var u=e._uiProps.uiTransformComp,h=rbe.x,_=rbe.y,f=u.anchorPoint,d=e.getScale();if(t.alignFlags&LCe.HORIZONTAL){var p=0,m=0,v=a.width;l?(p=_N.left.x,m=_N.right.x):m=(p=-c.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(p+=r.x,p*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,S=d.x;if(S<0&&(y=1-y,S=-S),t.isStretchWidth)g=m-p,0!==S&&(u.width=g/S),h=p+y*g;else if(g=u.width*S,t.isAlignHorizontalCenter){var x=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,E=(.5-c.x)*a.width;i&&(x*=o.x,E+=r.x,E*=o.x),h=E+(y-.5)*g+x}else h=t.isAlignLeft?p+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&LCe.VERTICAL){var T=0,C=0,A=a.height;l?(C=_N.bottom.y,T=_N.top.y):T=(C=-c.y*A)+A,C+=t.isAbsoluteBottom?t.bottom:t.bottom*A,T-=t.isAbsoluteTop?t.top:t.top*A,i&&(C+=r.y,C*=o.y,T+=r.y,T*=o.y);var b=0,w=f.y,I=d.y;if(I<0&&(w=1-w,I=-I),t.isStretchHeight)b=T-C,0!==I&&(u.height=b/I),_=C+w*b;else if(b=u.height*I,t.isAlignVerticalCenter){var P=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*A,R=(.5-c.y)*a.height;i&&(P*=o.y,R+=r.y,R*=o.y),_=R+(w-.5)*b+P}else _=t.isAlignBottom?C+w*b:T+(w-1)*b;t._lastSize.height=b}e.setPosition(h,_,rbe.z),Nn.set(t._lastPos,h,_,rbe.z)}}function hbe(e){var t=e.getComponent(aAe);if(t&&t.enabled){if(!h.isValid(e,!0))return;dbe.push(t)}for(var n,i=ce(e.children);!(n=i()).done;){var r=n.value;r.active&&hbe(r)}}function _be(){var e=lN.getScene();if(e){pbe.isAligning=!0,pbe._nodesOrderDirty&&(dbe.length=0,hbe(e),pbe._nodesOrderDirty=!1);var t=null,n=pbe._activeWidgetsIterator;for(n.i=0;n.i<dbe.length;++n.i)(t=dbe[n.i])._dirty&&(ube(t.node,t),t._dirty=!1);pbe.isAligning=!1}}var fbe,dbe=[],pbe=e("widgetManager",h._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new rt.MutableForwardIterator(dbe),animationState:null,init:function(){lN.on(cN.EVENT_AFTER_SCENE_LAUNCH,_be),lN.on(cN.EVENT_AFTER_UPDATE,_be),pN.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);pN.instance.on("canvas-resize",e),ch.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=lN.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=ub.isNode(e)&&e.getComponent(aAe);t&&t.enabled&&(t.alignMode===MCe.ON_WINDOW_RESIZE||t.alignMode===MCe.ALWAYS)&&t.setDirty();for(var n,i=ce(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var o=cbe;o.set(0,0);var a=lbe;if(a.set(1,1),e.target&&zCe(i,r=e.target,o,a),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:obe,l=i._uiProps.uiTransformComp,u=FCe(r),h=l.anchorPoint,_=i.getPosition(),f=LCe,d=i.getScale(),p=0;if(t&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,p=_.x-h.x*l.width*Math.abs(d.x)-m,e.isAbsoluteLeft||(p/=u.width),p/=a.x,e.left=n(e.left,p)}if(t&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,p=(v*=a.x)-(_.x+(1-h.x)*l.width*Math.abs(d.x)),e.isAbsoluteRight||(p/=u.width),p/=a.x,e.right=n(e.right,p)}if(t&f.TOP){var g=(1-c.y)*u.height;g+=o.y,p=(g*=a.y)-(_.y+(1-h.y)*l.height*Math.abs(d.y)),e.isAbsoluteTop||(p/=u.height),p/=a.y,e.top=n(e.top,p)}if(t&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,p=_.y-h.y*l.height*Math.abs(d.y)-y,e.isAbsoluteBottom||(p/=u.height),p/=a.y,e.bottom=n(e.bottom,p)}}},updateAlignment:function e(t){var n=t.parent;n&&ub.isNode(n)&&e(n);var i=t.getComponent(aAe);i&&n&&ube(t,i)},AlignMode:MCe,AlignFlags:LCe});lN.on(cN.EVENT_INIT,(function(){pbe.init()}));var mbe,vbe,gbe,ybe,Sbe,xbe,Ebe,Tbe,Cbe,Abe,bbe,wbe,Ibe,Pbe,Rbe,Obe,Dbe,Nbe,Mbe,Lbe=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(Ic("cc.SafeArea")(fbe=Xc()(fbe=Rc(110)(fbe=kc(fbe=Hc()(fbe=Pc(aAe)(fbe=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),ch.on("window-resize",this.updateArea,this),ch.on("orientation-change",this.updateArea,this)},n.onDisable=function(){ch.off("window-resize",this.updateArea,this),ch.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(aAe),t=this.node.getComponent(Sz);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=yN.getVisibleSize(),o=r.width,a=r.height,s=hh.getSafeAreaRect();e.top=a-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=o-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),pbe.add(e)}},t}(th))||fbe)||fbe)||fbe)||fbe)||fbe)||fbe);h.SafeArea=Lbe;var Bbe,Fbe=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((mbe=Ic("cc.UICoordinateTracker"),vbe=Xc(),gbe=Hc(),ybe=Rc(110),Sbe=hl(ub),xbe=Zc(),Ebe=hl(AB),Tbe=Zc(),Cbe=Zc(),Abe=Zc(),bbe=hl([sB]),wbe=Zc(),mbe(Ibe=vbe(Ibe=gbe(Ibe=ybe((ue((Pbe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return le(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",Rbe,ae(t)),le(t,"_target",Obe,ae(t)),le(t,"_camera",Dbe,ae(t)),le(t,"_useScale",Nbe,ae(t)),le(t,"_distance",Mbe,ae(t)),t._transformPos=new Nn,t._viewPos=new Nn,t._canMove=!0,t._lastWPos=new Nn,t._lastCameraPos=new Nn,t}ee(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&Nn.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);sB.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},J(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(th)).prototype,"target",[Sbe,xbe],Object.getOwnPropertyDescriptor(Pbe.prototype,"target"),Pbe.prototype),ue(Pbe.prototype,"camera",[Ebe,Tbe],Object.getOwnPropertyDescriptor(Pbe.prototype,"camera"),Pbe.prototype),ue(Pbe.prototype,"useScale",[Cbe],Object.getOwnPropertyDescriptor(Pbe.prototype,"useScale"),Pbe.prototype),ue(Pbe.prototype,"distance",[Abe],Object.getOwnPropertyDescriptor(Pbe.prototype,"distance"),Pbe.prototype),Rbe=ue(Pbe.prototype,"syncEvents",[bbe,Bc,wbe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Obe=ue(Pbe.prototype,"_target",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dbe=ue(Pbe.prototype,"_camera",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nbe=ue(Pbe.prototype,"_useScale",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Mbe=ue(Pbe.prototype,"_distance",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ibe=Pbe))||Ibe)||Ibe)||Ibe)||Ibe)),zbe=[cC.TOUCH_START,cC.TOUCH_END,cC.TOUCH_MOVE,cC.MOUSE_DOWN,cC.MOUSE_MOVE,cC.MOUSE_UP,cC.MOUSE_ENTER,cC.MOUSE_LEAVE,cC.MOUSE_WHEEL];function Ube(e){e.propagationStopped=!0}var Gbe,kbe,Hbe,Vbe,Wbe,jbe,Xbe,qbe,Ybe,Kbe,Qbe,Zbe,Jbe=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(Ic("cc.BlockInputEvents")(Bbe=Xc()(Bbe=Hc()(Bbe=function(e){function t(){return e.apply(this,arguments)||this}ee(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<zbe.length;e++)this.node.on(zbe[e],Ube,this)},n.onDisable=function(){for(var e=0;e<zbe.length;e++)this.node.off(zbe[e],Ube,this)},t}(th))||Bbe)||Bbe)||Bbe),$be=e("SubContextView",(Gbe=Ic("cc.SubContextView"),kbe=Xc(),Hbe=Rc(110),Vbe=Pc(Sz),Wbe=Hc(),jbe=Zc(),Xbe=Zc(),Gbe(qbe=kbe(qbe=Hbe(qbe=Vbe(qbe=Wbe((ue((Ybe=function(e){function t(){var t;return le(t=e.call(this)||this,"_fps",Kbe,ae(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,le(t,"_designResolutionSize",Qbe,ae(t)),t._content=new ub("content"),t._content.hideFlags|=yl.Flags.DontSave|yl.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new Km,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new gv,t}ee(t,e);var n=t.prototype;return n.onLoad=function(){OB.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=OB.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._designResolutionSize.width,n=this._designResolutionSize.height;e.width=t,e.height=n}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(zH),this._sprite||(this._sprite=this._content.addComponent(zH)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new WB;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(Sz),t=this._content.getComponent(Sz),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var o=yN.getViewportRect(),a=t.getBoundingBoxToWorld(),s=yN.getVisibleSize(),c=ch.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(cC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(cC.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(cC.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(cC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(cC.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(cC.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},J(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(th)).prototype,"designResolutionSize",[jbe],Object.getOwnPropertyDescriptor(Ybe.prototype,"designResolutionSize"),Ybe.prototype),ue(Ybe.prototype,"fps",[Xbe],Object.getOwnPropertyDescriptor(Ybe.prototype,"fps"),Ybe.prototype),Kbe=ue(Ybe.prototype,"_fps",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Qbe=ue(Ybe.prototype,"_designResolutionSize",[Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(640,960)}}),qbe=Ybe))||qbe)||qbe)||qbe)||qbe)||qbe));h.SubContextView=$be;var ewe=e("UIReorderComponent",Ic("cc.UIReorderComponent")(Zbe=function(){D(1408,"UIReorderComponent")})||Zbe);h.UIReorderComponent=ewe,h.ButtonComponent=nge,ot.setClassAlias(nge,"cc.ButtonComponent"),h.EditBoxComponent=ISe,ot.setClassAlias(ISe,"cc.EditBoxComponent"),h.LayoutComponent=$Se,ot.setClassAlias($Se,"cc.LayoutComponent"),h.ProgressBarComponent=Cxe,ot.setClassAlias(Cxe,"cc.ProgressBarComponent"),h.ScrollViewComponent=rTe,ot.setClassAlias(rTe,"cc.ScrollViewComponent"),h.ScrollBarComponent=Nxe,ot.setClassAlias(Nxe,"cc.ScrollBarComponent"),h.SliderComponent=wTe,ot.setClassAlias(wTe,"cc.SliderComponent"),h.ToggleComponent=kTe,ot.setClassAlias(kTe,"cc.ToggleComponent"),h.ToggleContainerComponent=NCe,ot.setClassAlias(NCe,"cc.ToggleContainerComponent"),h.WidgetComponent=aAe,ot.setClassAlias(aAe,"cc.WidgetComponent"),h.PageViewComponent=ibe,ot.setClassAlias(ibe,"cc.PageViewComponent"),h.PageViewIndicatorComponent=JAe,ot.setClassAlias(JAe,"cc.PageViewIndicatorComponent"),h.SafeAreaComponent=Lbe,ot.setClassAlias(Lbe,"cc.SafeAreaComponent"),ot.setClassAlias(Fbe,"cc.UICoordinateTrackerComponent"),h.BlockInputEventsComponent=Jbe,ot.setClassAlias(Jbe,"cc.BlockInputEventsComponent")}}}));
